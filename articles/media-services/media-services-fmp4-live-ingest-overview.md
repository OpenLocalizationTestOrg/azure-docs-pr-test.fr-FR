---
title: "Spécification d’ingestion en direct au format MP4 fragmenté Azure Media Services | Microsoft Docs"
description: "Cette spécification décrit le protocole et le format requis pour l’ingestion de streaming en direct basée sur le format MP4 fragmenté pour Microsoft Azure Media Services. Vous pouvez utiliser Azure Media Services pour diffuser en continu des événements en direct et diffuser du contenu en temps réel en utilisant Azure en tant que plateforme de cloud. Ce document explique également les pratiques recommandées pour créer des mécanismes d’ingestion en direct extrêmement redondants et robustes."
services: media-services
documentationcenter: 
author: cenkdin
manager: cfowler
editor: 
ms.assetid: 43fac263-a5ea-44af-8dd5-cc88e423b4de
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/29/2017
ms.author: cenkd;juliako
ms.openlocfilehash: 6250b73504bec765b8299060a29e84e771791cc9
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/29/2017
---
# <a name="azure-media-services-fragmented-mp4-live-ingest-specification"></a><span data-ttu-id="c4dfe-105">Spécification d’ingestion en direct au format MP4 fragmenté Azure Media Services</span><span class="sxs-lookup"><span data-stu-id="c4dfe-105">Azure Media Services fragmented MP4 live ingest specification</span></span>
<span data-ttu-id="c4dfe-106">Cette spécification décrit le protocole et le format requis pour l’ingestion de streaming en direct basée sur le format MP4 fragmenté pour Microsoft Azure Media Services.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-106">This specification describes the protocol and format for fragmented MP4-based live streaming ingestion for Azure Media Services.</span></span> <span data-ttu-id="c4dfe-107">Media Services fournit le service de streaming en direct que les clients peuvent utiliser pour diffuser en continu des événements en direct et diffuser du contenu en temps réel en utilisant Azure en tant que plateforme cloud.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-107">Media Services provides a live streaming service that customers can use to stream live events and broadcast content in real time by using Azure as the cloud platform.</span></span> <span data-ttu-id="c4dfe-108">Ce document explique également les pratiques recommandées pour créer des mécanismes d’ingestion en direct extrêmement redondants et robustes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-108">This document also discusses best practices for building highly redundant and robust live ingest mechanisms.</span></span>

## <a name="1-conformance-notation"></a><span data-ttu-id="c4dfe-109">1. Notation de conformité</span><span class="sxs-lookup"><span data-stu-id="c4dfe-109">1. Conformance notation</span></span>
<span data-ttu-id="c4dfe-110">Les mots clés « MUST », « MUST NOT », « REQUIRED », « SHALL », « SHALL NOT », « SHOULD », « SHOULD NOT », « RECOMMENDED », « MAY » et « OPTIONAL » figurant dans ce document doivent être interprétés tels qu’ils sont décrits dans le document RFC 2119.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-110">The key words "MUST," "MUST NOT," "REQUIRED," "SHALL," "SHALL NOT," "SHOULD," "SHOULD NOT," "RECOMMENDED," "MAY," and "OPTIONAL" in this document are to be interpreted as they are described in RFC 2119.</span></span>

## <a name="2-service-diagram"></a><span data-ttu-id="c4dfe-111">2. Diagramme du service</span><span class="sxs-lookup"><span data-stu-id="c4dfe-111">2. Service diagram</span></span>
<span data-ttu-id="c4dfe-112">Le diagramme suivant illustre l’architecture générale du service de streaming en direct dans Media Services :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-112">The following diagram shows the high-level architecture of the live streaming service in Media Services:</span></span>

1. <span data-ttu-id="c4dfe-113">Un encodeur en direct transmet les flux en direct à des canaux créés et approvisionnés via le SDK Azure Media Services.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-113">A live encoder pushes live feeds to channels that are created and provisioned via the Azure Media Services SDK.</span></span>
2. <span data-ttu-id="c4dfe-114">Les canaux, les programmes et les points de terminaison de streaming dans Media Services gèrent toutes les fonctionnalités de streaming en direct, notamment l’ingestion, le formatage, le DVR cloud, la sécurité, la scalabilité et la redondance.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-114">Channels, programs, and streaming endpoints in Media Services handle all the live streaming functionalities, including ingest, formatting, cloud DVR, security, scalability, and redundancy.</span></span>
3. <span data-ttu-id="c4dfe-115">Les clients peuvent éventuellement choisir de déployer une couche Azure Content Delivery Network entre le point de terminaison de streaming et les points de terminaison client.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-115">Optionally, customers can choose to deploy an Azure Content Delivery Network layer between the streaming endpoint and the client endpoints.</span></span>
4. <span data-ttu-id="c4dfe-116">Les points de terminaison client diffusent à partir du point de terminaison de streaming à l’aide des protocoles de diffusion en continu adaptative HTTP.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-116">Client endpoints stream from the streaming endpoint by using HTTP Adaptive Streaming protocols.</span></span> <span data-ttu-id="c4dfe-117">Parmi les exemples citons Microsoft Smooth Streaming, Dynamic Adaptive Streaming sur HTTP (DASH ou MPEG-DASH) et Apple HTTP Live Streaming (HLS).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-117">Examples include Microsoft Smooth Streaming, Dynamic Adaptive Streaming over HTTP (DASH, or MPEG-DASH), and Apple HTTP Live Streaming (HLS).</span></span>

![Flux d’ingestion][image1]

## <a name="3-bitstream-format--iso-14496-12-fragmented-mp4"></a><span data-ttu-id="c4dfe-119">3. Format de flux binaire – MP4 fragmenté ISO 14496-12</span><span class="sxs-lookup"><span data-stu-id="c4dfe-119">3. Bitstream format – ISO 14496-12 fragmented MP4</span></span>
<span data-ttu-id="c4dfe-120">Le format câble utilisé pour l’ingestion du streaming en direct décrite dans ce document repose sur la norme [ISO 14496-12].</span><span class="sxs-lookup"><span data-stu-id="c4dfe-120">The wire format for live streaming ingest discussed in this document is based on [ISO-14496-12].</span></span> <span data-ttu-id="c4dfe-121">Pour obtenir une explication détaillée du format MP4 fragmenté et des extensions de fichiers vidéo à la demande et d’ingestion de streaming en direct, consultez [[MS-SSTR]](http://msdn.microsoft.com/library/ff469518.aspx).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-121">For a detailed explanation of fragmented MP4 format and extensions both for video-on-demand files and live streaming ingestion, see [[MS-SSTR]](http://msdn.microsoft.com/library/ff469518.aspx).</span></span>

### <a name="live-ingest-format-definitions"></a><span data-ttu-id="c4dfe-122">Définitions de format de réception en temps réel</span><span class="sxs-lookup"><span data-stu-id="c4dfe-122">Live ingest format definitions</span></span>
<span data-ttu-id="c4dfe-123">La liste suivante décrit des définitions de formats spéciaux qui s’appliquent à l’ingestion en direct dans Azure Media Services :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-123">The following list describes special format definitions that apply to live ingest into Azure Media Services:</span></span>

1. <span data-ttu-id="c4dfe-124">Les zones **ftyp**, **Live Server Manifest Box** et **moov** DOIVENT être envoyées avec chaque requête (HTTP POST).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-124">The **ftyp**, **Live Server Manifest Box**, and **moov** boxes MUST be sent with each request (HTTP POST).</span></span> <span data-ttu-id="c4dfe-125">Ces zones DOIVENT être envoyées au début du flux et chaque fois que l’encodeur doit se reconnecter pour reprendre l’ingestion du flux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-125">These boxes MUST be sent at the beginning of the stream and any time the encoder must reconnect to resume stream ingest.</span></span> <span data-ttu-id="c4dfe-126">Pour plus d’informations, consultez la section 6 dans [1].</span><span class="sxs-lookup"><span data-stu-id="c4dfe-126">For more information, see Section 6 in [1].</span></span>
2. <span data-ttu-id="c4dfe-127">La section 3.3.2 dans [1] définit une zone facultative appelée **StreamManifestBox** pour l’ingestion en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-127">Section 3.3.2 in [1] defines an optional box called **StreamManifestBox** for live ingest.</span></span> <span data-ttu-id="c4dfe-128">En raison de la logique de routage de l’équilibreur de charge Azure, l’utilisation de cette zone est dépréciée.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-128">Due to the routing logic of the Azure load balancer, using this box is deprecated.</span></span> <span data-ttu-id="c4dfe-129">La zone NE DOIT PAS être présente au moment de l’ingestion dans Media Services.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-129">The box SHOULD NOT be present when ingesting into Media Services.</span></span> <span data-ttu-id="c4dfe-130">Si cette zone est présente, Media Services l’ignore en mode silencieux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-130">If this box is present, Media Services silently ignores it.</span></span>
3. <span data-ttu-id="c4dfe-131">La zone **TrackFragmentExtendedHeaderBox** définie à la section 3.2.3.2 dans [1] doit être présente pour chaque fragment.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-131">The **TrackFragmentExtendedHeaderBox** box defined in 3.2.3.2 in [1] MUST be present for each fragment.</span></span>
4. <span data-ttu-id="c4dfe-132">La version 2 de la zone **TrackFragmentExtendedHeaderBox** DOIT être utilisée pour générer des segments de médias ayant des URL identiques dans plusieurs centres de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-132">Version 2 of the **TrackFragmentExtendedHeaderBox** box SHOULD be used to generate media segments that have identical URLs in multiple datacenters.</span></span> <span data-ttu-id="c4dfe-133">Le champ d’index de fragment est OBLIGATOIRE pour le basculement entre centres de données des formats de streaming basé sur les index comme Apple HLS et MPEG-DASH basée sur les index.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-133">The fragment index field is REQUIRED for cross-datacenter failover of index-based streaming formats such as Apple HLS and index-based MPEG-DASH.</span></span> <span data-ttu-id="c4dfe-134">Pour permettre un basculement entre centres de données, l’index de fragment DOIT être synchronisé entre plusieurs encodeurs et être augmenté de 1 pour chaque fragment multimédia successif, même entre les redémarrages ou échecs de l’encodeur.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-134">To enable cross-datacenter failover, the fragment index MUST be synced across multiple encoders and be increased by 1 for each successive media fragment, even across encoder restarts or failures.</span></span>
5. <span data-ttu-id="c4dfe-135">La section 3.3.6 dans [1] définit la zone appelée **MovieFragmentRandomAccessBox** (**mfra**) qui PEUT être envoyée à la fin de la réception en direct pour indiquer la fin du flux (EOS, End-of-Stream) au canal.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-135">Section 3.3.6 in [1] defines a box called **MovieFragmentRandomAccessBox** (**mfra**) that MAY be sent at the end of live ingestion to indicate end-of-stream (EOS) to the channel.</span></span> <span data-ttu-id="c4dfe-136">En raison de la logique d’ingestion d’Azure Media Services, l’utilisation d’EOS est dépréciée et la zone **mfra** pour l’ingestion en direct ne DOIT PAS être envoyée.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-136">Due to the ingest logic of Media Services, using EOS is deprecated, and the **mfra** box for live ingestion SHOULD NOT be sent.</span></span> <span data-ttu-id="c4dfe-137">Si elle l’est, Media Services l’ignore en mode silencieux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-137">If sent, Media Services silently ignores it.</span></span> <span data-ttu-id="c4dfe-138">Pour réinitialiser l’état du point d’ingestion, nous vous recommandons d’utiliser la [réinitialisation de canal](https://docs.microsoft.com/rest/api/media/operations/channel#reset_channels).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-138">To reset the state of the ingest point, we recommend that you use [Channel Reset](https://docs.microsoft.com/rest/api/media/operations/channel#reset_channels).</span></span> <span data-ttu-id="c4dfe-139">Nous vous recommandons également d’utiliser [l’arrêt de programme](https://msdn.microsoft.com/library/azure/dn783463.aspx#stop_programs) pour terminer une présentation et un flux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-139">We also recommend that you use [Program Stop](https://msdn.microsoft.com/library/azure/dn783463.aspx#stop_programs) to end a presentation and stream.</span></span>
6. <span data-ttu-id="c4dfe-140">La durée du fragment MP4 DOIT être une constante, pour réduire la taille des manifestes de client.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-140">The MP4 fragment duration SHOULD be constant, to reduce the size of the client manifests.</span></span> <span data-ttu-id="c4dfe-141">En outre, une durée de fragment MP4 constante améliore la méthode heuristique de téléchargement client par le biais de l’utilisation de balises de répétition.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-141">A constant MP4 fragment duration also improves client download heuristics through the use of repeat tags.</span></span> <span data-ttu-id="c4dfe-142">La durée PEUT varier pour compenser les fréquences d’images non entières.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-142">The duration MAY fluctuate to compensate for non-integer frame rates.</span></span>
7. <span data-ttu-id="c4dfe-143">La durée du fragment MP4 DOIT être comprise entre environ 2 et 6 secondes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-143">The MP4 fragment duration SHOULD be between approximately 2 and 6 seconds.</span></span>
8. <span data-ttu-id="c4dfe-144">Les horodatages et index du fragment MP4 (**TrackFragmentExtendedHeaderBox** `fragment_ absolute_ time` et `fragment_index`) DOIVENT normalement arriver dans l’ordre croissant.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-144">MP4 fragment timestamps and indexes (**TrackFragmentExtendedHeaderBox** `fragment_ absolute_ time` and `fragment_index`) SHOULD arrive in increasing order.</span></span> <span data-ttu-id="c4dfe-145">Bien que Media Services ne duplique pas les fragments, il est capable, de façon limitée, de réorganiser les fragments en fonction de la chronologie du média.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-145">Although Media Services is resilient to duplicate fragments, it has limited ability to reorder fragments according to the media timeline.</span></span>

## <a name="4-protocol-format--http"></a><span data-ttu-id="c4dfe-146">4. Format de protocole – HTTP</span><span class="sxs-lookup"><span data-stu-id="c4dfe-146">4. Protocol format – HTTP</span></span>
<span data-ttu-id="c4dfe-147">L’ingestion en direct basée sur le format MP4 fragmenté ISO pour Media Services utilise une longue requête HTTP POST standard pour transmettre au service des données multimédias encodées qui sont empaquetées au format MP4 fragmenté.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-147">ISO fragmented MP4-based live ingest for Media Services uses a standard long-running HTTP POST request to transmit encoded media data that is packaged in fragmented MP4 format to the service.</span></span> <span data-ttu-id="c4dfe-148">Chaque requête HTTP POST envoie un flux binaire (« stream ») MP4 fragmenté en commençant par les zones d’en-tête (zones **ftyp**, **Live Server Manifest Box** et **moov**) et en continuant avec une séquence de fragments (zones **moof** et **mdat**).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-148">Each HTTP POST sends a complete fragmented MP4 bitstream ("stream"), starting from the beginning with header boxes (**ftyp**, **Live Server Manifest Box**, and **moov** boxes), and continuing with a sequence of fragments (**moof** and **mdat** boxes).</span></span> <span data-ttu-id="c4dfe-149">Pour connaître la syntaxe URL de la requête HTTP POST, consultez la section 9.2 dans [1].</span><span class="sxs-lookup"><span data-stu-id="c4dfe-149">For URL syntax for the HTTP POST request, see section 9.2 in [1].</span></span> <span data-ttu-id="c4dfe-150">Voici un exemple d'URL POST :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-150">An example of the POST URL is:</span></span> 

    http://customer.channel.mediaservices.windows.net/ingest.isml/streams(720p)

### <a name="requirements"></a><span data-ttu-id="c4dfe-151">Configuration requise</span><span class="sxs-lookup"><span data-stu-id="c4dfe-151">Requirements</span></span>
<span data-ttu-id="c4dfe-152">Voici les spécifications détaillées :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-152">Here are the detailed requirements:</span></span>

1. <span data-ttu-id="c4dfe-153">L’encodeur DOIT démarrer la diffusion en envoyant une requête HTTP POST avec un « corps » vide (longueur de contenu nulle) à l’aide de la même URL d’ingestion.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-153">The encoder SHOULD start the broadcast by sending an HTTP POST request with an empty “body” (zero content length) by using the same ingestion URL.</span></span> <span data-ttu-id="c4dfe-154">Cela peut aider l’encodeur à détecter rapidement si le point de terminaison d’ingestion en direct est valide et s’il existe une authentification ou d’autres conditions requises.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-154">This can help the encoder quickly detect whether the live ingestion endpoint is valid, and if there are any authentication or other conditions required.</span></span> <span data-ttu-id="c4dfe-155">Conformément au protocole HTTP, le serveur ne peut pas renvoyer une réponse HTTP tant que la requête entière, y compris le corps POST, n’est pas reçue.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-155">Per HTTP protocol, the server can't send back an HTTP response until the entire request, including the POST body, is received.</span></span> <span data-ttu-id="c4dfe-156">Étant donné la longue durée d’un événement en direct, sans cette étape, l’encodeur risque de ne pas pouvoir détecter d’éventuelles erreurs tant qu’il n’a pas terminé d’envoyer toutes les données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-156">Given the long-running nature of a live event, without this step, the encoder might not be able to detect any error until it finishes sending all the data.</span></span>
2. <span data-ttu-id="c4dfe-157">L’encodeur DOIT gérer toutes les erreurs ou demandes d’authentification liées à (1).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-157">The encoder MUST handle any errors or authentication challenges because of (1).</span></span> <span data-ttu-id="c4dfe-158">Si (1) réussit avec une réponse 200, continuez.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-158">If (1) succeeds with a 200 response, continue.</span></span>
3. <span data-ttu-id="c4dfe-159">L’encodeur DOIT démarrer une nouvelle requête HTTP POST avec le flux MP4 fragmenté.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-159">The encoder MUST start a new HTTP POST request with the fragmented MP4 stream.</span></span> <span data-ttu-id="c4dfe-160">La charge utile DOIT commencer par les zones d’en-tête, suivies des fragments.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-160">The payload MUST start with the header boxes, followed by fragments.</span></span> <span data-ttu-id="c4dfe-161">Notez que les zones **ftyp**, **Live Server Manifest Box** et **moov** (dans cet ordre) DOIVENT être envoyées avec chaque requête, même si l’encodeur doit se reconnecter, car la requête précédente a été interrompue avant la fin du flux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-161">Note that the **ftyp**, **Live Server Manifest Box**, and **moov** boxes (in this order) MUST be sent with each request, even if the encoder must reconnect because the previous request was terminated prior to the end of the stream.</span></span> 
4. <span data-ttu-id="c4dfe-162">L’encodeur DOIT utiliser l’encodage de transfert en bloc pour le chargement, car il est impossible de prédire la longueur totale du contenu de l’événement en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-162">The encoder MUST use chunked transfer encoding for uploading, because it’s impossible to predict the entire content length of the live event.</span></span>
5. <span data-ttu-id="c4dfe-163">Quand l’événement est terminé, après l’envoi du dernier fragment, l’encodeur DOIT gracieusement mettre fin à la séquence de message de l’encodage de transfert en bloc (la plupart des piles de client HTTP gère cela automatiquement).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-163">When the event is over, after sending the last fragment, the encoder MUST gracefully end the chunked transfer encoding message sequence (most HTTP client stacks handle it automatically).</span></span> <span data-ttu-id="c4dfe-164">L’encodeur DOIT attendre que le service retourne le code de réponse finale, puis mettre fin à la connexion.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-164">The encoder MUST wait for the service to return the final response code, and then terminate the connection.</span></span> 
6. <span data-ttu-id="c4dfe-165">L’encodeur NE DOIT PAS utiliser le nom `Events()` comme décrit à la section 9.2 dans [1] pour l’ingestion en direct dans Media Services.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-165">The encoder MUST NOT use the `Events()` noun as described in 9.2 in [1] for live ingestion into Media Services.</span></span>
7. <span data-ttu-id="c4dfe-166">Si la requête HTTP POST s’arrête ou expire avec une erreur TCP avant la fin du flux, l’encodeur DOIT émettre une nouvelle requête POST à l’aide d’une nouvelle connexion et suivre les exigences précédentes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-166">If the HTTP POST request terminates or times out with a TCP error prior to the end of the stream, the encoder MUST issue a new POST request by using a new connection, and follow the preceding requirements.</span></span> <span data-ttu-id="c4dfe-167">En outre, l’encodeur DOIT renvoyer les deux fragments MP4 précédents pour chaque piste dans le flux et reprendre sans introduire de discontinuité dans la chronologie du média.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-167">Additionally, the encoder MUST resend the previous two MP4 fragments for each track in the stream, and resume without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="c4dfe-168">Le renvoi des deux derniers fragments MP4 pour chaque piste garantit l'absence de perte de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-168">Resending the last two MP4 fragments for each track ensures that there is no data loss.</span></span> <span data-ttu-id="c4dfe-169">En d’autres termes, si un flux contient à la fois une piste audio et vidéo, et si la requête POST en cours échoue, l’encodeur doit se reconnecter et renvoyer les deux derniers fragments de la piste audio, lesquels ont déjà été envoyés correctement, ainsi que les deux derniers fragments de la piste vidéo, lesquels ont déjà été envoyés correctement, pour garantir l’absence de perte de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-169">In other words, if a stream contains both an audio and a video track, and the current POST request fails, the encoder must reconnect and resend the last two fragments for the audio track, which were previously successfully sent, and the last two fragments for the video track, which were previously successfully sent, to ensure that there is no data loss.</span></span> <span data-ttu-id="c4dfe-170">L’encodeur DOIT conserver un tampon « de transfert » des fragments multimédias, qu’il renvoie quand il se reconnecte.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-170">The encoder MUST maintain a “forward” buffer of media fragments, which it resends when it reconnects.</span></span>

## <a name="5-timescale"></a><span data-ttu-id="c4dfe-171">5. Échelle de temps</span><span class="sxs-lookup"><span data-stu-id="c4dfe-171">5. Timescale</span></span>
<span data-ttu-id="c4dfe-172">[MS-SSTR](https://msdn.microsoft.com/library/ff469518.aspx) décrit l’utilisation de l’échelle de temps pour **SmoothStreamingMedia** (section 2.2.2.1), **StreamElement** (section 2.2.2.3), **StreamFragmentElement** (section 2.2.2.6) et **LiveSMIL** (section 2.2.7.3.1).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-172">[[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx) describes the usage of timescale for **SmoothStreamingMedia** (Section 2.2.2.1), **StreamElement** (Section 2.2.2.3), **StreamFragmentElement** (Section 2.2.2.6), and **LiveSMIL** (Section 2.2.7.3.1).</span></span> <span data-ttu-id="c4dfe-173">Si la valeur de l’échelle de temps n’est pas présente, la valeur par défaut utilisée est 10 000 000 (10 MHz).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-173">If the timescale value is not present, the default value used is 10,000,000 (10 MHz).</span></span> <span data-ttu-id="c4dfe-174">Bien que la spécification du format Smooth Streaming ne bloque pas l’utilisation d’autres valeurs d’échelle de temps, la plupart des implémentations de l’encodeur utilisent cette valeur par défaut (10 MHz) pour générer les données d’ingestion Smooth Streaming.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-174">Although the Smooth Streaming format specification doesn’t block usage of other timescale values, most encoder implementations use this default value (10 MHz) to generate Smooth Streaming ingest data.</span></span> <span data-ttu-id="c4dfe-175">En raison de la fonctionnalité [Azure Media Dynamic Packaging](media-services-dynamic-packaging-overview.md), nous vous recommandons d’utiliser une échelle de temps de 90 kHz pour les flux vidéos et de 44,1 kHz ou de 48,1 kHz pour les flux audio.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-175">Due to the [Azure Media Dynamic Packaging](media-services-dynamic-packaging-overview.md) feature, we recommend that you use a 90-KHz timescale for video streams and 44.1 KHz or 48.1 KHz for audio streams.</span></span> <span data-ttu-id="c4dfe-176">Si des valeurs d’échelle de temps différentes sont utilisées pour des flux différents, l’échelle de temps au niveau du flux DOIT être envoyée.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-176">If different timescale values are used for different streams, the stream-level timescale MUST be sent.</span></span> <span data-ttu-id="c4dfe-177">Pour plus d’informations, consultez [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-177">For more information, see [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx).</span></span>     

## <a name="6-definition-of-stream"></a><span data-ttu-id="c4dfe-178">6. Définition de « stream »</span><span class="sxs-lookup"><span data-stu-id="c4dfe-178">6. Definition of “stream”</span></span>
<span data-ttu-id="c4dfe-179">Stream est l’unité de base de l’opération dans l’ingestion en direct pour rédiger les présentations en direct, gérer le basculement du streaming et les scénarios de redondance.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-179">Stream is the basic unit of operation in live ingestion for composing live presentations, handling streaming failover, and redundancy scenarios.</span></span> <span data-ttu-id="c4dfe-180">Stream se définit comme un seul flux binaire MP4 fragmenté pouvant contenir une piste unique ou plusieurs pistes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-180">Stream is defined as one unique, fragmented MP4 bitstream that might contain a single track or multiple tracks.</span></span> <span data-ttu-id="c4dfe-181">Une présentation en direct complète peut contenir un ou plusieurs flux, selon la configuration des encodeurs en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-181">A full live presentation might contain one or more streams, depending on the configuration of the live encoders.</span></span> <span data-ttu-id="c4dfe-182">Les exemples suivants illustrent les différentes options d’utilisation des flux pour rédiger une présentation en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-182">The following examples illustrate various options of using streams to compose a full live presentation.</span></span>

<span data-ttu-id="c4dfe-183">**Exemple :**</span><span class="sxs-lookup"><span data-stu-id="c4dfe-183">**Example:**</span></span> 

<span data-ttu-id="c4dfe-184">Un client veut créer une présentation de streaming en direct qui inclut les débits binaires audio/vidéo suivants :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-184">A customer wants to create a live streaming presentation that includes the following audio/video bitrates:</span></span>

<span data-ttu-id="c4dfe-185">Vidéo : 3000 Kbits/s, 1500 Kbits/s, 750 Kbits/s</span><span class="sxs-lookup"><span data-stu-id="c4dfe-185">Video – 3000 kbps, 1500 kbps, 750 kbps</span></span>

<span data-ttu-id="c4dfe-186">Audio : 128 Kbits/s</span><span class="sxs-lookup"><span data-stu-id="c4dfe-186">Audio – 128 kbps</span></span>

### <a name="option-1-all-tracks-in-one-stream"></a><span data-ttu-id="c4dfe-187">Option 1 : toutes les pistes dans un seul flux</span><span class="sxs-lookup"><span data-stu-id="c4dfe-187">Option 1: All tracks in one stream</span></span>
<span data-ttu-id="c4dfe-188">Dans cette option, un encodeur unique génère toutes les pistes audio/vidéo et les regroupe dans un flux binaire MP4 fragmenté.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-188">In this option, a single encoder generates all audio/video tracks, and then bundles them into one fragmented MP4 bitstream.</span></span> <span data-ttu-id="c4dfe-189">Le flux binaire MP4 fragmenté est ensuite envoyé via une connexion HTTP POST.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-189">The fragmented MP4 bitstream is then sent via a single HTTP POST connection.</span></span> <span data-ttu-id="c4dfe-190">Dans cet exemple, il existe un seul flux pour cette présentation en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-190">In this example, there is only one stream for this live presentation.</span></span>

![Flux : une piste][image2]

### <a name="option-2-each-track-in-a-separate-stream"></a><span data-ttu-id="c4dfe-192">Option 2 : chaque piste dans un flux distinct</span><span class="sxs-lookup"><span data-stu-id="c4dfe-192">Option 2: Each track in a separate stream</span></span>
<span data-ttu-id="c4dfe-193">Dans cette option, l’encodeur met une piste dans chaque flux binaire MP4 fragmenté, puis publie tous les flux sur des connexions HTTP distinctes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-193">In this option, the encoder puts one track into each fragment MP4 bitstream, and then posts all of the streams over separate HTTP connections.</span></span> <span data-ttu-id="c4dfe-194">Cette option est réalisable avec un seul encodeur ou plusieurs.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-194">This can be done with one encoder or with multiple encoders.</span></span> <span data-ttu-id="c4dfe-195">Du point de vue de l’ingestion en direct, cette présentation en direct se compose de quatre flux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-195">The live ingestion sees this live presentation as composed of four streams.</span></span>

![Flux : pistes distinctes][image3]

### <a name="option-3-bundle-audio-track-with-the-lowest-bitrate-video-track-into-one-stream"></a><span data-ttu-id="c4dfe-197">Option 3 : regrouper la piste audio et la piste vidéo au débit binaire le plus bas dans un seul flux</span><span class="sxs-lookup"><span data-stu-id="c4dfe-197">Option 3: Bundle audio track with the lowest bitrate video track into one stream</span></span>
<span data-ttu-id="c4dfe-198">Dans cette option, le client choisit de regrouper la piste audio avec la piste vidéo au débit binaire le plus bas dans un seul flux binaire MP4 fragmenté et de laisser les deux autres pistes vidéo en tant que flux distincts.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-198">In this option, the customer chooses to bundle the audio track with the lowest-bitrate video track in one fragment MP4 bitstream, and leave the other two video tracks as separate streams.</span></span> 

![Flux : pistes audio et vidéo][image4]

### <a name="summary"></a><span data-ttu-id="c4dfe-200">Résumé</span><span class="sxs-lookup"><span data-stu-id="c4dfe-200">Summary</span></span>
<span data-ttu-id="c4dfe-201">Cela ne constitue pas la liste exhaustive de toutes les options d’ingestion possibles pour cet exemple.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-201">This is not an exhaustive list of all possible ingestion options for this example.</span></span> <span data-ttu-id="c4dfe-202">En fait, tous les regroupements de pistes dans des flux sont pris en charge par l’ingestion en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-202">As a matter of fact, any grouping of tracks into streams is supported by live ingestion.</span></span> <span data-ttu-id="c4dfe-203">Les clients et fournisseurs d'encodeurs peuvent choisir leurs propres implémentations selon la complexité d'ingénierie, la capacité de l'encodeur et les questions de redondance et de basculement.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-203">Customers and encoder vendors can choose their own implementations based on engineering complexity, encoder capacity, and redundancy and failover considerations.</span></span> <span data-ttu-id="c4dfe-204">Toutefois, dans la plupart des cas, il n’y a qu’une piste audio pour l’ensemble de la présentation en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-204">However, in most cases, there is only one audio track for the entire live presentation.</span></span> <span data-ttu-id="c4dfe-205">Il est donc important de s’assurer de l’intégrité du flux d’ingestion qui contient la piste audio. Cette remarque entraîne souvent le placement de la piste audio dans son propre flux (comme dans l’option 2) ou son regroupement avec la piste vidéo au débit binaire le plus bas (comme dans l’option 3).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-205">So, it’s important to ensure the healthiness of the ingest stream that contains the audio track. This consideration often results in putting the audio track in its own stream (as in Option 2) or bundling it with the lowest-bitrate video track (as in Option 3).</span></span> <span data-ttu-id="c4dfe-206">De plus, pour une meilleure redondance et une meilleure tolérance de panne, l’envoi de la même piste audio dans deux flux différents (option 2 avec pistes audio redondantes) ou le regroupement de la piste audio avec au moins deux des pistes vidéo au débit binaire le plus faible (option 3 avec audio regroupé avec au moins deux flux vidéo) sont fortement recommandés pour l’ingestion en direct dans Media Services.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-206">Also, for better redundancy and fault tolerance, sending the same audio track in two different streams (Option 2 with redundant audio tracks) or bundling the audio track with at least two of the lowest-bitrate video tracks (Option 3 with audio bundled in at least two video streams) is highly recommended for live ingest into Media Services.</span></span>

## <a name="7-service-failover"></a><span data-ttu-id="c4dfe-207">7. Basculement du service</span><span class="sxs-lookup"><span data-stu-id="c4dfe-207">7. Service failover</span></span>
<span data-ttu-id="c4dfe-208">Étant donné la nature de la diffusion en continu en direct, une bonne prise en charge du basculement s'avère essentielle pour garantir la disponibilité du service.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-208">Given the nature of live streaming, good failover support is critical for ensuring the availability of the service.</span></span> <span data-ttu-id="c4dfe-209">Media Services est conçu pour gérer divers types de défaillances, notamment les erreurs de réseau, les erreurs de serveur et les problèmes de stockage.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-209">Media Services is designed to handle various types of failures, including network errors, server errors, and storage issues.</span></span> <span data-ttu-id="c4dfe-210">Utilisé conjointement avec la logique de basculement appropriée du côté de l’encodeur en direct, les clients peuvent obtenir un service de streaming en direct très fiable à partir du cloud.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-210">When used in conjunction with proper failover logic from the live encoder side, customers can achieve a highly reliable live streaming service from the cloud.</span></span>

<span data-ttu-id="c4dfe-211">Dans cette section, nous abordons les scénarios de basculement du service.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-211">In this section, we discuss service failover scenarios.</span></span> <span data-ttu-id="c4dfe-212">Le cas échéant, la défaillance se produit quelque part au sein du service et elle se traduit par une erreur de réseau.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-212">In this case, the failure happens somewhere within the service, and it manifests itself as a network error.</span></span> <span data-ttu-id="c4dfe-213">Voici quelques recommandations sur l'implémentation de l'encodeur pour gérer le basculement du service :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-213">Here are some recommendations for the encoder implementation for handling service failover:</span></span>

1. <span data-ttu-id="c4dfe-214">Utilisez un délai d’expiration de 10 secondes pour établir la connexion TCP.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-214">Use a 10-second timeout for establishing the TCP connection.</span></span> <span data-ttu-id="c4dfe-215">Si une tentative d'établissement de la connexion prend plus de 10 secondes, abandonnez l'opération et réessayez.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-215">If an attempt to establish the connection takes longer than 10 seconds, abort the operation and try again.</span></span> 
2. <span data-ttu-id="c4dfe-216">Utilisez un court délai d'expiration pour l'envoi des fragments de message de la requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-216">Use a short timeout for sending the HTTP request message chunks.</span></span> <span data-ttu-id="c4dfe-217">Si la durée du fragment MP4 cible s’élève à N secondes, utilisez un délai d’expiration d’envoi compris entre N et 2 N secondes. Par exemple, si la durée du fragment MP4 est de 6 secondes, utilisez un délai d’expiration compris entre 6 et 12 secondes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-217">If the target MP4 fragment duration is N seconds, use a send timeout between N and 2 N seconds; for example, if the MP4 fragment duration is 6 seconds, use a timeout of 6 to 12 seconds.</span></span> <span data-ttu-id="c4dfe-218">En cas d'expiration, réinitialisez la connexion, ouvrez une nouvelle connexion et reprenez l'ingestion du flux sur la nouvelle connexion.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-218">If a timeout occurs, reset the connection, open a new connection, and resume stream ingest on the new connection.</span></span> 
3. <span data-ttu-id="c4dfe-219">Conservez un tampon de substitution qui a les deux derniers fragments pour chaque piste qui ont été correctement et complètement envoyés au service.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-219">Maintain a rolling buffer that has the last two fragments for each track that were successfully and completely sent to the service.</span></span>  <span data-ttu-id="c4dfe-220">Si la requête HTTP POST d'un flux est arrêtée ou arrive à expiration avant la fin du flux, ouvrez une nouvelle connexion et commencez une autre requête HTTP POST, renvoyez les en-têtes du flux, renvoyez les deux derniers fragments de chaque piste et reprenez le flux sans introduire de discontinuités dans la chronologie du média.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-220">If the HTTP POST request for a stream is terminated or times out prior to the end of the stream, open a new connection and begin another HTTP POST request, resend the stream headers, resend the last two fragments for each track, and resume the stream without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="c4dfe-221">Les risques de perte de données sont ainsi réduits.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-221">This reduces the chance of data loss.</span></span>
4. <span data-ttu-id="c4dfe-222">Nous recommandons que l’encodeur ne limite PAS le nombre de nouvelles tentatives de connexion ou de reprise du streaming suite à une erreur TCP.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-222">We recommend that the encoder does NOT limit the number of retries to establish a connection or resume streaming after a TCP error occurs.</span></span>
5. <span data-ttu-id="c4dfe-223">Après une erreur TCP :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-223">After a TCP error:</span></span>
  
    <span data-ttu-id="c4dfe-224">a.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-224">a.</span></span> <span data-ttu-id="c4dfe-225">La connexion en cours DOIT être fermée et une nouvelle connexion DOIT être créée pour une nouvelle requête HTTP POST.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-225">The current connection MUST be closed, and a new connection MUST be created for a new HTTP POST request.</span></span>

    <span data-ttu-id="c4dfe-226">b.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-226">b.</span></span> <span data-ttu-id="c4dfe-227">La nouvelle URL HTTP POST DOIT être identique à l'URL POST initiale.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-227">The new HTTP POST URL MUST be the same as the initial POST URL.</span></span>
  
    <span data-ttu-id="c4dfe-228">c.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-228">c.</span></span> <span data-ttu-id="c4dfe-229">La nouvelle requête HTTP POST DOIT inclure des en-têtes de flux (zone **ftyp**, **Live Server Manifest Box** et **moov**) qui sont identiques aux en-têtes de flux de la requête POST initiale.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-229">The new HTTP POST MUST include stream headers (**ftyp**, **Live Server Manifest Box**, and **moov** boxes) that are identical to the stream headers in the initial POST.</span></span>
  
    <span data-ttu-id="c4dfe-230">d.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-230">d.</span></span> <span data-ttu-id="c4dfe-231">Les deux derniers fragments envoyés pour chaque piste doivent être renvoyés, et le streaming doit reprendre sans introduire de discontinuités dans la chronologie du média.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-231">The last two fragments sent for each track must be resent, and streaming must resume without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="c4dfe-232">Les horodatages des fragments MP4 doivent s'incrémenter en permanence, même dans les requêtes HTTP POST.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-232">The MP4 fragment timestamps must increase continuously, even across HTTP POST requests.</span></span>
6. <span data-ttu-id="c4dfe-233">L'encodeur DOIT mettre fin à la requête HTTP POST si les données ne sont pas envoyées à un débit proportionné par rapport à la durée du fragment MP4.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-233">The encoder SHOULD terminate the HTTP POST request if data is not being sent at a rate commensurate with the MP4 fragment duration.</span></span>  <span data-ttu-id="c4dfe-234">Une requête HTTP POST qui n’envoie pas de données peut empêcher Media Services de se déconnecter rapidement de l’encodeur en cas de mise à jour du service.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-234">An HTTP POST request that does not send data can prevent Media Services from quickly disconnecting from the encoder in the event of a service update.</span></span> <span data-ttu-id="c4dfe-235">C’est pourquoi la requête HTTP POST des pistes partiellement allouées (signal d’annonce) DOIT avoir une durée de vie courte et se terminer dès que le fragment partiellement alloué est envoyé.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-235">For this reason, the HTTP POST for sparse (ad signal) tracks SHOULD be short-lived, terminating as soon as the sparse fragment is sent.</span></span>

## <a name="8-encoder-failover"></a><span data-ttu-id="c4dfe-236">8. Basculement de l’encodeur</span><span class="sxs-lookup"><span data-stu-id="c4dfe-236">8. Encoder failover</span></span>
<span data-ttu-id="c4dfe-237">Le basculement de l'encodeur est le deuxième type de scénario de basculement qui doit être traité pour la diffusion en continu en direct de bout en bout.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-237">Encoder failover is the second type of failover scenario that needs to be addressed for end-to-end live streaming delivery.</span></span> <span data-ttu-id="c4dfe-238">Dans ce scénario, la condition d’erreur se produit côté encodeur.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-238">In this scenario, the error condition occurs on the encoder side.</span></span> 

![Basculement de l’encodeur][image5]

<span data-ttu-id="c4dfe-240">Les attentes suivantes s’appliquent à partir du point de terminaison d’ingestion en direct en cas de basculement de l’encodeur :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-240">The following expectations apply from the live ingestion endpoint when encoder failover happens:</span></span>

1. <span data-ttu-id="c4dfe-241">Une instance de l’encodeur DOIT être créée pour continuer le streaming, comme illustré dans le diagramme (flux pour une vidéo de 3 000 k, avec une ligne en pointillés).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-241">A new encoder instance SHOULD be created to continue streaming, as illustrated in the diagram (Stream for 3000k video, with dashed line).</span></span>
2. <span data-ttu-id="c4dfe-242">Le nouvel encodeur DOIT utiliser la même URL pour les requêtes HTTP POST que l'instance défaillante.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-242">The new encoder MUST use the same URL for HTTP POST requests as the failed instance.</span></span>
3. <span data-ttu-id="c4dfe-243">La requête POST du nouvel encodeur DOIT inclure les mêmes zones d'en-tête MP4 fragmenté que l'instance défaillante.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-243">The new encoder’s POST request MUST include the same fragmented MP4 header boxes as the failed instance.</span></span>
4. <span data-ttu-id="c4dfe-244">Le nouvel encodeur DOIT être correctement synchronisé avec tous les autres encodeurs en cours d’exécution pour la même présentation en direct afin de générer des échantillons audio/vidéo synchronisés avec des limites de fragments alignées.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-244">The new encoder MUST be properly synced with all other running encoders for the same live presentation to generate synced audio/video samples with aligned fragment boundaries.</span></span>
5. <span data-ttu-id="c4dfe-245">Le nouveau flux DOIT être sémantiquement équivalent au flux précédent, et interchangeable aux niveaux de l’en-tête et du fragment.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-245">The new stream MUST be semantically equivalent with the previous stream, and interchangeable at the header and fragment levels.</span></span>
6. <span data-ttu-id="c4dfe-246">Le nouvel encodeur DOIT tenter de minimiser les pertes de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-246">The new encoder SHOULD try to minimize data loss.</span></span> <span data-ttu-id="c4dfe-247">Les valeurs `fragment_absolute_time` et `fragment_index` des fragments multimédias DOIVENT augmenter à partir du point où l’encodeur s’est arrêté la dernière fois.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-247">The `fragment_absolute_time` and `fragment_index` of media fragments SHOULD increase from the point where the encoder last stopped.</span></span> <span data-ttu-id="c4dfe-248">Les valeurs `fragment_absolute_time` et `fragment_index` DOIVENT augmenter de manière continue, mais il est possible d’introduire une discontinuité, si besoin.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-248">The `fragment_absolute_time` and `fragment_index` SHOULD increase in a continuous manner, but it is permissible to introduce a discontinuity, if necessary.</span></span> <span data-ttu-id="c4dfe-249">Media Services ignore les fragments déjà reçus et traités. Une erreur du côté du renvoi des fragments est donc préférable à l’introduction de discontinuités dans la chronologie du média.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-249">Media Services ignores fragments that it has already received and processed, so it's better to err on the side of resending fragments than to introduce discontinuities in the media timeline.</span></span> 

## <a name="9-encoder-redundancy"></a><span data-ttu-id="c4dfe-250">9. Redondance de l’encodeur</span><span class="sxs-lookup"><span data-stu-id="c4dfe-250">9. Encoder redundancy</span></span>
<span data-ttu-id="c4dfe-251">Pour certains événements en direct critiques qui exigent une disponibilité et une qualité d’expérience encore plus élevées, nous vous recommandons d’utiliser des encodeurs redondants en mode actif-actif pour obtenir un basculement transparent sans perte de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-251">For certain critical live events that demand even higher availability and quality of experience, we recommended that you use active-active redundant encoders to achieve seamless failover with no data loss.</span></span>

![Redondance de l’encodeur][image6]

<span data-ttu-id="c4dfe-253">Comme illustré dans ce diagramme, deux groupes d’encodeurs transmettent simultanément deux copies de chaque flux au service en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-253">As illustrated in this diagram, two groups of encoders push two copies of each stream simultaneously into the live service.</span></span> <span data-ttu-id="c4dfe-254">Cette configuration est prise en charge, car Media Services peut filtrer les fragments en double en fonction de l’ID du flux et de l’horodatage des fragments.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-254">This setup is supported because Media Services can filter out duplicate fragments based on stream ID and fragment timestamp.</span></span> <span data-ttu-id="c4dfe-255">Le flux en direct et l’archive obtenus consistent en une seule copie de tous les flux constituant l’agrégation la meilleure possible des deux sources.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-255">The resulting live stream and archive is a single copy of all the streams that is the best possible aggregation from the two sources.</span></span> <span data-ttu-id="c4dfe-256">Par exemple, dans un cas extrême hypothétique, tant qu’il existe un encodeur (éventuellement différent) en cours d’exécution à un moment donné pour chaque flux, le flux en direct obtenu à partir du service est continu sans perte de données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-256">For example, in a hypothetical extreme case, as long as there is one encoder (it doesn’t have to be the same one) running at any given point in time for each stream, the resulting live stream from the service is continuous without data loss.</span></span> 

<span data-ttu-id="c4dfe-257">La configuration requise pour ce scénario est presque identique à celle requise pour le cas « Basculement de l’encodeur », à l’exception près que le second ensemble d’encodeurs s’exécute en même temps que les encodeurs principaux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-257">The requirements for this scenario are almost the same as the requirements in the "Encoder failover" case, with the exception that the second set of encoders are running at the same time as the primary encoders.</span></span>

## <a name="10-service-redundancy"></a><span data-ttu-id="c4dfe-258">10. Redondance du service</span><span class="sxs-lookup"><span data-stu-id="c4dfe-258">10. Service redundancy</span></span>
<span data-ttu-id="c4dfe-259">Pour une distribution globale hautement redondante, vous devez parfois disposer d’une sauvegarde inter-régions pour traiter les urgences régionales.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-259">For highly redundant global distribution, sometimes you must have cross-region backup to handle regional disasters.</span></span> <span data-ttu-id="c4dfe-260">En développant la topologie « Redondance de l’encodeur », les clients peuvent choisir d’avoir un déploiement de services redondant dans une région différente qui est connectée au second ensemble d’encodeurs.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-260">Expanding on the “Encoder redundancy” topology, customers can choose to have a redundant service deployment in a different region that's connected with the second set of encoders.</span></span> <span data-ttu-id="c4dfe-261">Les clients peuvent également avoir recours à un fournisseur CDN pour déployer un gestionnaire de trafic global (GTM, Global Traffic Manager) devant les deux déploiements de services afin d’acheminer le trafic du client en toute transparence.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-261">Customers also can work with a Content Delivery Network provider to deploy a Global Traffic Manager in front of the two service deployments to seamlessly route client traffic.</span></span> <span data-ttu-id="c4dfe-262">La configuration requise pour les encodeurs est la même que pour le cas « Redondance de l’encodeur ».</span><span class="sxs-lookup"><span data-stu-id="c4dfe-262">The requirements for the encoders are the same as the “Encoder redundancy” case.</span></span> <span data-ttu-id="c4dfe-263">La seule exception est que le second ensemble d’encodeurs doit pointer vers un autre point de terminaison d’ingestion en direct.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-263">The only exception is that the second set of encoders needs to be pointed to a different live ingest endpoint.</span></span> <span data-ttu-id="c4dfe-264">Le diagramme qui suit présente cette configuration :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-264">The following diagram shows this setup:</span></span>

![Redondance du service][image7]

## <a name="11-special-types-of-ingestion-formats"></a><span data-ttu-id="c4dfe-266">11. Types spéciaux de formats d’ingestion</span><span class="sxs-lookup"><span data-stu-id="c4dfe-266">11. Special types of ingestion formats</span></span>
<span data-ttu-id="c4dfe-267">Cette section présente des types spéciaux de formats d’ingestion en direct, conçus pour gérer des scénarios spécifiques.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-267">This section discusses special types of live ingestion formats that are designed to handle specific scenarios.</span></span>

### <a name="sparse-track"></a><span data-ttu-id="c4dfe-268">Piste partiellement allouée</span><span class="sxs-lookup"><span data-stu-id="c4dfe-268">Sparse track</span></span>
<span data-ttu-id="c4dfe-269">Pendant une présentation de streaming en direct avec une expérience client riche, il est souvent nécessaire de transmettre des événements synchronisés ou des signaux intrabande avec les principales données multimédias.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-269">When delivering a live streaming presentation with a rich client experience, often it's necessary to transmit time-synced events or signals in-band with the main media data.</span></span> <span data-ttu-id="c4dfe-270">L’insertion de publicités dynamiques en direct en est un exemple.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-270">An example of this is dynamic live ad insertion.</span></span> <span data-ttu-id="c4dfe-271">Ce type de signalisation d'événement diffère de la diffusion audio/vidéo en continu standard en raison de sa nature partiellement allouée.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-271">This type of event signaling is different from regular audio/video streaming because of its sparse nature.</span></span> <span data-ttu-id="c4dfe-272">Autrement dit, les données de signalisation ne se produisent généralement pas de manière continue, et l’intervalle peut être difficile à prédire.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-272">In other words, the signaling data usually does not happen continuously, and the interval can be hard to predict.</span></span> <span data-ttu-id="c4dfe-273">Le concept de piste partiellement allouée a été conçu pour ingérer et diffuser des données de signalisation intrabande.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-273">The concept of sparse track was designed to ingest and broadcast in-band signaling data.</span></span>

<span data-ttu-id="c4dfe-274">Les étapes suivantes constituent une implémentation recommandée pour l’ingestion d’une piste partiellement allouée :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-274">The following steps are a recommended implementation for ingesting sparse track:</span></span>

1. <span data-ttu-id="c4dfe-275">Créez un flux binaire MP4 fragmenté distinct qui contient uniquement des pistes partiellement allouées, sans pistes audio/vidéo.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-275">Create a separate fragmented MP4 bitstream that contains only sparse tracks, without audio/video tracks.</span></span>
2. <span data-ttu-id="c4dfe-276">Dans la zone **Live Server Manifest Box** définie à la section 6 dans [1], utilisez le paramètre *parentTrackName* pour spécifier le nom de la piste parent. Pour plus d’informations, consultez la section 4.2.1.2.1.2 dans [1].</span><span class="sxs-lookup"><span data-stu-id="c4dfe-276">In the **Live Server Manifest Box** as defined in Section 6 in [1], use the *parentTrackName* parameter to specify the name of the parent track. For more information, see section 4.2.1.2.1.2 in [1].</span></span>
3. <span data-ttu-id="c4dfe-277">Dans la zone **Live Server Manifest Box**, **manifestOutput** DOIT avoir la valeur **true**.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-277">In the **Live Server Manifest Box**, **manifestOutput** MUST be set to **true**.</span></span>
4. <span data-ttu-id="c4dfe-278">Étant donné la nature partiellement allouée de l’événement de signalisation, voici ce que nous recommandons :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-278">Given the sparse nature of the signaling event, we recommended the following:</span></span>
   
    <span data-ttu-id="c4dfe-279">a.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-279">a.</span></span> <span data-ttu-id="c4dfe-280">Au début de l’événement en direct, l’encodeur envoie les zones d’en-tête initiales au service, ce qui permet au service d’enregistrer la piste partiellement allouée dans le manifeste du client.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-280">At the beginning of the live event, the encoder sends the initial header boxes to the service, which allows the service to register the sparse track in the client manifest.</span></span>
   
    <span data-ttu-id="c4dfe-281">b.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-281">b.</span></span> <span data-ttu-id="c4dfe-282">L'encodeur DOIT mettre fin à la requête HTTP POST quand les données ne sont pas envoyées.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-282">The encoder SHOULD terminate the HTTP POST request when data is not being sent.</span></span> <span data-ttu-id="c4dfe-283">Une longue requête HTTP POST qui n’envoie pas de données peut empêcher Media Services de se déconnecter rapidement de l’encodeur en cas de mise à jour du service ou de redémarrage du serveur.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-283">A long-running HTTP POST that does not send data can prevent Media Services from quickly disconnecting from the encoder in the event of a service update or server reboot.</span></span> <span data-ttu-id="c4dfe-284">Dans ces cas, le serveur multimédia est temporairement bloqué dans une opération de réception sur le socket.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-284">In these cases, the media server is temporarily blocked in a receive operation on the socket.</span></span>
   
    <span data-ttu-id="c4dfe-285">c.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-285">c.</span></span> <span data-ttu-id="c4dfe-286">Pendant que les données de signalisation ne sont pas disponibles, l'encodeur DOIT fermer la requête HTTP POST.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-286">During the time when signaling data is not available, the encoder SHOULD close the HTTP POST request.</span></span> <span data-ttu-id="c4dfe-287">Pendant que la requête POST est active, l’encodeur DOIT envoyer des données.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-287">While the POST request is active, the encoder SHOULD send data.</span></span>

    <span data-ttu-id="c4dfe-288">d.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-288">d.</span></span> <span data-ttu-id="c4dfe-289">Pendant l’envoi de fragments partiellement alloués, l’encodeur peut définir un en-tête content-length explicite, s’il est disponible.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-289">When sending sparse fragments, the encoder can set an explicit content-length header, if it’s available.</span></span>

    <span data-ttu-id="c4dfe-290">e.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-290">e.</span></span> <span data-ttu-id="c4dfe-291">Pendant l’envoi d’un fragment partiellement alloué avec une nouvelle connexion, l’encodeur DOIT commencer par envoyer les zones d’en-tête, puis les nouveaux fragments.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-291">When sending sparse fragments with a new connection, the encoder SHOULD start sending from the header boxes, followed by the new fragments.</span></span> <span data-ttu-id="c4dfe-292">Cette recommandation concerne les cas dans lesquels le basculement a eu lieu entre temps et où la nouvelle connexion est établie avec un nouveau serveur qui n’a pas vu la piste partiellement allouée auparavant.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-292">This is for cases in which failover happens in-between, and the new sparse connection is being established to a new server that has not seen the sparse track before.</span></span>

    <span data-ttu-id="c4dfe-293">f.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-293">f.</span></span> <span data-ttu-id="c4dfe-294">Le fragment de piste partiellement allouée devient disponible pour le client quand le fragment de piste parent correspondant dont la valeur d’horodatage est égale ou supérieure est mis à la disposition du client.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-294">The sparse track fragment becomes available to the client when the corresponding parent track fragment that has an equal or larger timestamp value is made available to the client.</span></span> <span data-ttu-id="c4dfe-295">Par exemple, si le fragment partiellement alloué a un horodatage de t=1000, après avoir visualisé l’horodatage de fragment " vidéo " 1000 ou au-delà (en supposant que le nom de la piste parent est " vidéo "), le client peut normalement télécharger le fragment partiellement alloué t=1000.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-295">For example, if the sparse fragment has a timestamp of t=1000, it is expected that after the client sees "video" (assuming the parent track name is "video") fragment timestamp 1000 or beyond, it can download the sparse fragment t=1000.</span></span> <span data-ttu-id="c4dfe-296">Notez que le signal réel peut servir à un autre emplacement dans la chronologie de la présentation pour sa fonction désignée.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-296">Note that the actual signal could be used for a different position in the presentation timeline for its designated purpose.</span></span> <span data-ttu-id="c4dfe-297">Dans cet exemple, le fragment partiellement alloué de t=1000 peut avoir une charge utile XML, pour insérer une publicité à un emplacement situé quelques secondes plus tard.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-297">In this example, it’s possible that the sparse fragment of t=1000 has an XML payload, which is for inserting an ad in a position that’s a few seconds later.</span></span>

    <span data-ttu-id="c4dfe-298">g.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-298">g.</span></span> <span data-ttu-id="c4dfe-299">La charge utile des fragments de piste partiellement allouée peut se présenter sous différents formats (par exemple, XML, texte ou binaire), selon le scénario.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-299">The payload of sparse track fragments can be in different formats (such as XML, text, or binary), depending on the scenario.</span></span>

### <a name="redundant-audio-track"></a><span data-ttu-id="c4dfe-300">Piste audio redondante</span><span class="sxs-lookup"><span data-stu-id="c4dfe-300">Redundant audio track</span></span>
<span data-ttu-id="c4dfe-301">Dans un scénario de diffusion en continu adaptative HTTP classique (par exemple, Smooth Streaming ou DASH), la présentation dans son ensemble ne contient souvent qu’une seule piste audio.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-301">In a typical HTTP adaptive streaming scenario (for example, Smooth Streaming or DASH), often, there's only one audio track in the entire presentation.</span></span> <span data-ttu-id="c4dfe-302">Contrairement aux pistes vidéo, qui ont plusieurs niveaux de qualité parmi lesquels le client peut choisir dans des conditions d’erreur, la piste audio peut correspondre à un seul point de défaillance si l’ingestion du flux qui contient la piste audio est rompue.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-302">Unlike video tracks, which have multiple quality levels for the client to choose from in error conditions, the audio track can be a single point of failure if the ingestion of the stream that contains the audio track is broken.</span></span> 

<span data-ttu-id="c4dfe-303">Pour résoudre ce problème, Media Services prend en charge l’ingestion en direct des pistes audio redondantes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-303">To solve this problem, Media Services supports live ingestion of redundant audio tracks.</span></span> <span data-ttu-id="c4dfe-304">L'idée est que la même piste audio peut être envoyée plusieurs fois dans différents flux.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-304">The idea is that the same audio track can be sent multiple times in different streams.</span></span> <span data-ttu-id="c4dfe-305">Bien que le service enregistre une seule fois la piste audio dans le manifeste du client, il peut utiliser des pistes audio redondantes en tant que sauvegardes pour la récupération de fragments audio si la piste audio principale a des problèmes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-305">Although the service only registers the audio track once in the client manifest, it can use redundant audio tracks as backups for retrieving audio fragments if the primary audio track has issues.</span></span> <span data-ttu-id="c4dfe-306">Pour ingérer des pistes audio redondantes, l’encodeur doit :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-306">To ingest redundant audio tracks, the encoder needs to:</span></span>

1. <span data-ttu-id="c4dfe-307">Créer la même piste audio dans plusieurs flux binaires MP4 fragmentés.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-307">Create the same audio track in multiple fragment MP4 bitstreams.</span></span> <span data-ttu-id="c4dfe-308">Les pistes audio redondantes DOIVENT être sémantiquement équivalentes, avec les mêmes horodatages de fragments, et être interchangeables aux niveaux de l’en-tête et du fragment.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-308">The redundant audio tracks MUST be semantically equivalent, with the same fragment timestamps, and be interchangeable at the header and fragment levels.</span></span>
2. <span data-ttu-id="c4dfe-309">Vérifier que l’entrée « audio » dans la zone Live Server Manifest (section 6 dans [1]) est la même pour toutes les pistes audio redondantes.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-309">Ensure that the “audio” entry in the Live Server Manifest (Section 6 in [1]) is the same for all redundant audio tracks.</span></span>

<span data-ttu-id="c4dfe-310">L’implémentation suivante est recommandée pour les pistes audio redondantes :</span><span class="sxs-lookup"><span data-stu-id="c4dfe-310">The following implementation is recommended for redundant audio tracks:</span></span>

1. <span data-ttu-id="c4dfe-311">Envoyez chaque piste audio unique dans un flux toute seule.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-311">Send each unique audio track in a stream by itself.</span></span> <span data-ttu-id="c4dfe-312">Envoyez également un flux redondant pour chacun de ces flux de piste audio, où le second flux diffère du premier uniquement par l’identificateur inclus dans l’URL HTTP POST : {protocole}://{adresse du serveur}/{chemin du point de publication}/Streams({identificateur}).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-312">Also, send a redundant stream for each of these audio track streams, where the second stream differs from the first only by the identifier in the HTTP POST URL: {protocol}://{server address}/{publishing point path}/Streams({identifier}).</span></span>
2. <span data-ttu-id="c4dfe-313">Utilisez des flux distincts pour envoyer les deux débits binaires vidéo les plus bas.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-313">Use separate streams to send the two lowest video bitrates.</span></span> <span data-ttu-id="c4dfe-314">Chacun de ces flux DOIT également contenir une copie de chaque piste audio unique. Par exemple, quand plusieurs langues sont prises en charge, ces flux DOIVENT contenir des pistes audio pour chaque langue.</span><span class="sxs-lookup"><span data-stu-id="c4dfe-314">Each of these streams SHOULD also contain a copy of each unique audio track. For example, when multiple languages are supported, these streams SHOULD contain audio tracks for each language.</span></span>
3. <span data-ttu-id="c4dfe-315">Utilisez des instances de serveur (encodeur) distinctes pour encoder et envoyer les flux redondants mentionnés dans (1) et (2).</span><span class="sxs-lookup"><span data-stu-id="c4dfe-315">Use separate server (encoder) instances to encode and send the redundant streams mentioned in (1) and (2).</span></span> 

## <a name="media-services-learning-paths"></a><span data-ttu-id="c4dfe-316">Parcours d’apprentissage de Media Services</span><span class="sxs-lookup"><span data-stu-id="c4dfe-316">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="c4dfe-317">Fournir des commentaires</span><span class="sxs-lookup"><span data-stu-id="c4dfe-317">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

[image1]: ./media/media-services-fmp4-live-ingest-overview/media-services-image1.png
[image2]: ./media/media-services-fmp4-live-ingest-overview/media-services-image2.png
[image3]: ./media/media-services-fmp4-live-ingest-overview/media-services-image3.png
[image4]: ./media/media-services-fmp4-live-ingest-overview/media-services-image4.png
[image5]: ./media/media-services-fmp4-live-ingest-overview/media-services-image5.png
[image6]: ./media/media-services-fmp4-live-ingest-overview/media-services-image6.png
[image7]: ./media/media-services-fmp4-live-ingest-overview/media-services-image7.png
