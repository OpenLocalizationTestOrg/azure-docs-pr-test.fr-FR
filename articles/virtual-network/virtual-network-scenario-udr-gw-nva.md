---
title: "Connexion hybride avec une application à 2 niveaux | Microsoft Docs"
description: "Découvrez comment déployer des appliances virtuelles et un UDR pour créer un environnement d’application multiniveau dans Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="0aafc-103">Scénario d’appliance virtuelle</span><span class="sxs-lookup"><span data-stu-id="0aafc-103">Virtual appliance scenario</span></span>
<span data-ttu-id="0aafc-104">Pour les clients Azure volumineux, il faut souvent fournir une application à deux niveaux exposée à Internet, tout en autorisant l’accès au niveau d’arrière-plan à partir d’un centre de données local.</span><span class="sxs-lookup"><span data-stu-id="0aafc-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="0aafc-105">Ce document vous guide dans un scénario utilisant des itinéraires définis par l’utilisateur (UDR), une passerelle VPN et des appliances virtuelles de réseau pour déployer un environnement à deux niveaux conforme aux exigences suivantes :</span><span class="sxs-lookup"><span data-stu-id="0aafc-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="0aafc-106">L’application web ne doit être accessible qu’à partir de l’Internet public.</span><span class="sxs-lookup"><span data-stu-id="0aafc-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="0aafc-107">Le serveur web hébergeant l’application doit pouvoir accéder à un serveur d’application principal.</span><span class="sxs-lookup"><span data-stu-id="0aafc-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="0aafc-108">Tout le trafic transitant entre Internet et l’application web doit passer par une appliance virtuelle de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="0aafc-109">Cette appliance virtuelle ne sera utilisée que pour le trafic Internet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="0aafc-110">Tout le trafic envoyé au serveur d’applications doit transiter par une appliance virtuelle de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="0aafc-111">Cette appliance virtuelle sera utilisée pour accéder au serveur principal depuis le réseau local via une passerelle VPN.</span><span class="sxs-lookup"><span data-stu-id="0aafc-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="0aafc-112">Les administrateurs doivent pouvoir gérer les appliances virtuelles de pare-feu à partir de leurs ordinateurs locaux, en utilisant une troisième appliance virtuelle de pare-feu exclusivement à des fins de gestion.</span><span class="sxs-lookup"><span data-stu-id="0aafc-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="0aafc-113">Il s’agit d’un scénario avec une zone DMZ et un réseau protégé.</span><span class="sxs-lookup"><span data-stu-id="0aafc-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="0aafc-114">Ce scénario peut être mis en œuvre dans Azure à l’aide de groupes de sécurité réseau, d’appliances virtuelles de pare-feu ou d’une combinaison des deux.</span><span class="sxs-lookup"><span data-stu-id="0aafc-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="0aafc-115">Le tableau ci-dessous présente certains avantages et inconvénients des groupes de sécurité réseau et appliances virtuelles de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="0aafc-116">Avantages</span><span class="sxs-lookup"><span data-stu-id="0aafc-116">Pros</span></span> | <span data-ttu-id="0aafc-117">Inconvénients</span><span class="sxs-lookup"><span data-stu-id="0aafc-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-118">Groupe de sécurité réseau</span><span class="sxs-lookup"><span data-stu-id="0aafc-118">NSG</span></span> |<span data-ttu-id="0aafc-119">Aucun coût.</span><span class="sxs-lookup"><span data-stu-id="0aafc-119">No cost.</span></span> <br/><span data-ttu-id="0aafc-120">Intégré dans Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="0aafc-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="0aafc-121">Possibilité de créer des règles dans les modèles ARM.</span><span class="sxs-lookup"><span data-stu-id="0aafc-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="0aafc-122">Complexité variable dans les environnements de grande taille.</span><span class="sxs-lookup"><span data-stu-id="0aafc-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="0aafc-123">Pare-feu</span><span class="sxs-lookup"><span data-stu-id="0aafc-123">Firewall</span></span> |<span data-ttu-id="0aafc-124">Contrôle total sur le plan des données.</span><span class="sxs-lookup"><span data-stu-id="0aafc-124">Full control over data plane.</span></span> <br/><span data-ttu-id="0aafc-125">Gestion centralisée via la console du pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-125">Central management through firewall console.</span></span> |<span data-ttu-id="0aafc-126">Coût de l’appliance de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="0aafc-127">Non intégré dans Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="0aafc-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="0aafc-128">La solution ci-dessous utilise des appliances virtuelles de pare-feu pour implémenter un scénario de zone DMZ/réseau protégé.</span><span class="sxs-lookup"><span data-stu-id="0aafc-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="0aafc-129">Considérations</span><span class="sxs-lookup"><span data-stu-id="0aafc-129">Considerations</span></span>
<span data-ttu-id="0aafc-130">Vous pouvez déployer l’environnement décrit ci-dessus dans Azure à l’aide de différentes fonctionnalités disponibles aujourd’hui, comme suit.</span><span class="sxs-lookup"><span data-stu-id="0aafc-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="0aafc-131">**Réseau virtuel**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="0aafc-132">Un réseau virtuel Azure se comporte de manière similaire à un réseau local et peut se décomposer en un ou plusieurs sous-réseaux pour isoler le trafic et les problèmes.</span><span class="sxs-lookup"><span data-stu-id="0aafc-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="0aafc-133">**Appliance virtuelle**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-133">**Virtual appliance**.</span></span> <span data-ttu-id="0aafc-134">Plusieurs partenaires fournissent des appliances virtuelles dans Azure Marketplace, utilisables pour les trois pare-feu décrits ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="0aafc-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="0aafc-135">**Itinéraires définis par l’utilisateur**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="0aafc-136">Les tables peuvent contenir des itinéraires définis par l’utilisateur, utilisés par la mise en réseau Azure pour contrôler le flux de paquets dans un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="0aafc-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="0aafc-137">Ces tables d’itinéraires peuvent être appliquées à des sous-réseaux.</span><span class="sxs-lookup"><span data-stu-id="0aafc-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="0aafc-138">L’une des fonctionnalités les plus récentes d’Azure consiste à appliquer une table d’itinéraires au sous-réseau GatewaySubnet, pour transférer tout le trafic entrant dans le réseau virtuel Azure entre la connexion hybride et une appliance virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0aafc-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="0aafc-139">**Transfert IP**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-139">**IP Forwarding**.</span></span> <span data-ttu-id="0aafc-140">Par défaut, le moteur de mise en réseau Azure ne transfère les paquets aux cartes réseau que si l’adresse IP de destination des paquets correspond à l’adresse IP de la carte réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="0aafc-141">Par conséquent, si un itinéraire défini par l’utilisateur détermine qu’un paquet doit être envoyé à une appliance virtuelle donnée, le moteur de mise en réseau Azure supprime ce paquet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="0aafc-142">Pour vérifier que le paquet est envoyé à une machine virtuelle (dans ce cas, une appliance virtuelle) qui n’est pas la destination réelle du paquet, vous devez activer le transfert IP pour l’appliance virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0aafc-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="0aafc-143">**Groupes de sécurité réseau (NSG)**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="0aafc-144">L’exemple ci-dessous ne fait pas l’utilisation de groupes de sécurité réseau, mais vous pouvez utiliser des NSG appliqués aux sous-réseaux ou des cartes réseau dans cette solution pour filtrer le trafic vers et depuis ces sous-réseaux et cartes réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![Connectivité IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="0aafc-146">Dans cet exemple, il existe un abonnement qui contient les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="0aafc-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="0aafc-147">2 groupes de ressources, non représentés sur le diagramme.</span><span class="sxs-lookup"><span data-stu-id="0aafc-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="0aafc-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-148">**ONPREMRG**.</span></span> <span data-ttu-id="0aafc-149">Contient toutes les ressources nécessaires pour simuler un réseau local.</span><span class="sxs-lookup"><span data-stu-id="0aafc-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="0aafc-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-150">**AZURERG**.</span></span> <span data-ttu-id="0aafc-151">Contient toutes les ressources nécessaires pour l’environnement du réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="0aafc-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="0aafc-152">Un réseau virtuel nommé **onpremvnet** utilisé pour imiter un centre de données local segmenté comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="0aafc-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="0aafc-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-153">**onpremsn1**.</span></span> <span data-ttu-id="0aafc-154">Sous-réseau contenant une machine virtuelle exécutant Ubuntu pour imiter un serveur local.</span><span class="sxs-lookup"><span data-stu-id="0aafc-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="0aafc-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-155">**onpremsn2**.</span></span> <span data-ttu-id="0aafc-156">Sous-réseau contenant une machine virtuelle exécutant Ubuntu pour simuler un ordinateur local utilisé par un administrateur.</span><span class="sxs-lookup"><span data-stu-id="0aafc-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="0aafc-157">Une appliance virtuelle de pare-feu nommée **OPFW** sur **onpremvnet** utilisée pour conserver un tunnel vers **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="0aafc-158">Un réseau virtuel nommé **azurevnet** segmenté comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="0aafc-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="0aafc-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-159">**azsn1**.</span></span> <span data-ttu-id="0aafc-160">Sous-réseau utilisé exclusivement pour le pare-feu externe.</span><span class="sxs-lookup"><span data-stu-id="0aafc-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="0aafc-161">Tout le trafic Internet entrera par ce sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="0aafc-162">Ce sous-réseau ne contient qu’une carte réseau liée au pare-feu externe.</span><span class="sxs-lookup"><span data-stu-id="0aafc-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="0aafc-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-163">**azsn2**.</span></span> <span data-ttu-id="0aafc-164">Sous-réseau frontal hébergeant une machine virtuelle exécutée en tant que serveur web accessible à partir d’Internet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="0aafc-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-165">**azsn3**.</span></span> <span data-ttu-id="0aafc-166">Sous-réseau principal hébergeant une machine virtuelle exécutant un serveur d’applications principal sollicité par le serveur web frontal.</span><span class="sxs-lookup"><span data-stu-id="0aafc-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="0aafc-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-167">**azsn4**.</span></span> <span data-ttu-id="0aafc-168">Sous-réseau utilisé exclusivement pour fournir un accès de gestion à toutes les appliances virtuelles de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="0aafc-169">Ce sous-réseau ne contient qu’une carte réseau pour chaque appliance virtuelle de pare-feu utilisée dans la solution.</span><span class="sxs-lookup"><span data-stu-id="0aafc-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="0aafc-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-170">**GatewaySubnet**.</span></span> <span data-ttu-id="0aafc-171">Sous-réseau de connexion hybride Azure requis pour une route ExpressRoute et une passerelle VPN assurant la connectivité entre des réseaux virtuels Azure et d’autres réseaux.</span><span class="sxs-lookup"><span data-stu-id="0aafc-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="0aafc-172">Le réseau **azurevnet** contient 3 appliances virtuelle de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="0aafc-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-173">**AZF1**.</span></span> <span data-ttu-id="0aafc-174">Pare-feu externe exposé à l’Internet public par l’utilisation d’une ressource ayant une adresse IP publique dans Azure.</span><span class="sxs-lookup"><span data-stu-id="0aafc-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="0aafc-175">Vous devez vous procurer un modèle auprès de Marketplace ou directement auprès de votre fournisseur d’appliances, qui approvisionne une appliance virtuelle à 3 cartes réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="0aafc-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-176">**AZF2**.</span></span> <span data-ttu-id="0aafc-177">Pare-feu interne utilisé pour contrôler le trafic entre **azsn2** et **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="0aafc-178">C’est également une appliance virtuelle à 3 cartes réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="0aafc-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-179">**AZF3**.</span></span> <span data-ttu-id="0aafc-180">Pare-feu de gestion accessible aux administrateurs à partir du centre de données local, et connecté à un sous-réseau servant à gérer toutes les appliances de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="0aafc-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="0aafc-181">Vous pouvez trouver des modèles d’appliance virtuelle à 2 cartes réseau dans Marketplace ou en demander un à votre fournisseur d’appliances.</span><span class="sxs-lookup"><span data-stu-id="0aafc-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="0aafc-182">Itinéraire défini par l’utilisateur (UDR)</span><span class="sxs-lookup"><span data-stu-id="0aafc-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="0aafc-183">Chaque sous-réseau dans Azure peut être lié à une table d’UDR utilisée pour définir le mode d’acheminement du trafic dans ce sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="0aafc-184">Si aucun UDR n’est défini, Azure utilise les itinéraires par défaut pour autoriser le trafic d’un sous-réseau à un autre.</span><span class="sxs-lookup"><span data-stu-id="0aafc-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="0aafc-185">Pour mieux comprendre les itinéraires définis par l’utilisateur, consultez [Présentation des itinéraires définis par l’utilisateur et du transfert IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="0aafc-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="0aafc-186">Pour assurer la communication transite par l’appliance de pare-feu appropriée, conformément à la dernière exigence ci-dessus, vous devez créer la table suivante contenant les UDR de **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="0aafc-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="0aafc-187">azgwudr</span></span>
<span data-ttu-id="0aafc-188">Dans ce scénario, seul le trafic local dirigé vers Azure servira à gérer le pare-feu en se connectant à **AZF3**. De plus, le trafic doit transiter par le pare-feu interne **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="0aafc-189">Par conséquent, un seul itinéraire est nécessaire dans **GatewaySubnet** comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="0aafc-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="0aafc-190">Destination</span><span class="sxs-lookup"><span data-stu-id="0aafc-190">Destination</span></span> | <span data-ttu-id="0aafc-191">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="0aafc-191">Next hop</span></span> | <span data-ttu-id="0aafc-192">Explication</span><span class="sxs-lookup"><span data-stu-id="0aafc-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-193">10.0.4.0/24</span></span> |<span data-ttu-id="0aafc-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="0aafc-194">10.0.3.11</span></span> |<span data-ttu-id="0aafc-195">Autorise le trafic local à atteindre le pare-feu de gestion **AZF3**</span><span class="sxs-lookup"><span data-stu-id="0aafc-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="0aafc-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="0aafc-196">azsn2udr</span></span>
| <span data-ttu-id="0aafc-197">Destination</span><span class="sxs-lookup"><span data-stu-id="0aafc-197">Destination</span></span> | <span data-ttu-id="0aafc-198">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="0aafc-198">Next hop</span></span> | <span data-ttu-id="0aafc-199">Explication</span><span class="sxs-lookup"><span data-stu-id="0aafc-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-200">10.0.3.0/24</span></span> |<span data-ttu-id="0aafc-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="0aafc-201">10.0.2.11</span></span> |<span data-ttu-id="0aafc-202">Autorise le trafic vers le sous-réseau principal qui héberge le serveur d’applications, à transiter par **AZF2**</span><span class="sxs-lookup"><span data-stu-id="0aafc-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="0aafc-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="0aafc-203">0.0.0.0/0</span></span> |<span data-ttu-id="0aafc-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="0aafc-204">10.0.2.10</span></span> |<span data-ttu-id="0aafc-205">Autorise tout autre trafic à transiter par **AZF1**</span><span class="sxs-lookup"><span data-stu-id="0aafc-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="0aafc-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="0aafc-206">azsn3udr</span></span>
| <span data-ttu-id="0aafc-207">Destination</span><span class="sxs-lookup"><span data-stu-id="0aafc-207">Destination</span></span> | <span data-ttu-id="0aafc-208">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="0aafc-208">Next hop</span></span> | <span data-ttu-id="0aafc-209">Explication</span><span class="sxs-lookup"><span data-stu-id="0aafc-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-210">10.0.2.0/24</span></span> |<span data-ttu-id="0aafc-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="0aafc-211">10.0.3.10</span></span> |<span data-ttu-id="0aafc-212">Autorise le trafic destiné à **azsn2** à circuler du serveur d’applications vers le serveur web via **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="0aafc-213">Vous devez également créer des tables d’itinéraires pour les sous-réseaux dans **onpremvnet** afin d’imiter le centre de données local.</span><span class="sxs-lookup"><span data-stu-id="0aafc-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="0aafc-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="0aafc-214">onpremsn1udr</span></span>
| <span data-ttu-id="0aafc-215">Destination</span><span class="sxs-lookup"><span data-stu-id="0aafc-215">Destination</span></span> | <span data-ttu-id="0aafc-216">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="0aafc-216">Next hop</span></span> | <span data-ttu-id="0aafc-217">Explication</span><span class="sxs-lookup"><span data-stu-id="0aafc-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-218">192.168.2.0/24</span></span> |<span data-ttu-id="0aafc-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="0aafc-219">192.168.1.4</span></span> |<span data-ttu-id="0aafc-220">Autorise le trafic destiné à **onpremsn2** à transiter par **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="0aafc-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="0aafc-221">onpremsn2udr</span></span>
| <span data-ttu-id="0aafc-222">Destination</span><span class="sxs-lookup"><span data-stu-id="0aafc-222">Destination</span></span> | <span data-ttu-id="0aafc-223">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="0aafc-223">Next hop</span></span> | <span data-ttu-id="0aafc-224">Explication</span><span class="sxs-lookup"><span data-stu-id="0aafc-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0aafc-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-225">10.0.3.0/24</span></span> |<span data-ttu-id="0aafc-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="0aafc-226">192.168.2.4</span></span> |<span data-ttu-id="0aafc-227">Autorise le trafic vers le sous-réseau sauvegardé dans Azure à transiter par **OPFW**</span><span class="sxs-lookup"><span data-stu-id="0aafc-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="0aafc-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="0aafc-228">192.168.1.0/24</span></span> |<span data-ttu-id="0aafc-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="0aafc-229">192.168.2.4</span></span> |<span data-ttu-id="0aafc-230">Autorise le trafic destiné à  **onpremsn1** à transiter par **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="0aafc-231">transfert IP</span><span class="sxs-lookup"><span data-stu-id="0aafc-231">IP Forwarding</span></span>
<span data-ttu-id="0aafc-232">L’UDR et le transfert IP sont des fonctionnalités que vous pouvez combiner pour permettre à des appliances virtuelles de contrôler le trafic dans un réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="0aafc-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="0aafc-233">Une appliance virtuelle n’est rien de plus qu’une machine virtuelle qui exécute une application permettant de gérer le trafic réseau d’une certaine façon, comme un pare-feu ou un périphérique NAT.</span><span class="sxs-lookup"><span data-stu-id="0aafc-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="0aafc-234">La machine virtuelle d’appliance virtuelle doit être capable de recevoir le trafic entrant qui ne lui est pas adressé.</span><span class="sxs-lookup"><span data-stu-id="0aafc-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="0aafc-235">Pour permettre à une machine virtuelle de recevoir le trafic adressé à d’autres destinations, vous devez activer le transfert IP pour la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0aafc-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="0aafc-236">Il s’agit d’un paramètre Azure, pas d’un paramètre du système d’exploitation invité.</span><span class="sxs-lookup"><span data-stu-id="0aafc-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="0aafc-237">Votre appliance virtuelle doit toujours exécuter un type d’application pour gérer le trafic entrant et l’acheminer correctement.</span><span class="sxs-lookup"><span data-stu-id="0aafc-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="0aafc-238">Pour plus d’informations sur le transfert IP, consultez la [Présentation des itinéraires définis par l’utilisateur et du transfert IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="0aafc-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="0aafc-239">Par exemple, imaginez un réseau virtuel Azure avec la configuration suivante :</span><span class="sxs-lookup"><span data-stu-id="0aafc-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="0aafc-240">Le sous-réseau **onpremsn1** contient une machine virtuelle nommée **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="0aafc-241">Le sous-réseau **onpremsn2** contient une machine virtuelle nommée **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="0aafc-242">Une appliance virtuelle nommée **OPFW** est connectée à **onpremsn1** et à **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="0aafc-243">Un itinéraire défini par l’utilisateur et lié à **onpremsn1** spécifie que tout le trafic destiné à **onpremsn2** doit être envoyé à **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="0aafc-244">À ce point, si **onpremvm1** tente d’établir une connexion à **onpremvm2**, l’UDR sera utilisé et le trafic sera envoyé à **OPFW** en tant tronçon suivant.</span><span class="sxs-lookup"><span data-stu-id="0aafc-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="0aafc-245">N’oubliez pas que la destination réelle du paquet n’est pas modifiée ( **onpremvm2** ).</span><span class="sxs-lookup"><span data-stu-id="0aafc-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="0aafc-246">Si le transfert IP n’est pas activé pour **OPFW**, la logique du réseau virtuel Azure supprimera les paquets, car elle n’autorise l’envoi des paquets qu’à une machine virtuelle dont l’adresse IP correspond à la destination du paquet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="0aafc-247">Avec le transfert IP, la logique du réseau virtuel Azure transmet les paquets à OPFW, sans modifier leur adresse de destination d’origine.</span><span class="sxs-lookup"><span data-stu-id="0aafc-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="0aafc-248">**OPFW** doit gérer les paquets et déterminer ce qu’il faut en faire.</span><span class="sxs-lookup"><span data-stu-id="0aafc-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="0aafc-249">Pour que ce scénario fonctionne, vous devez activer le transfert IP sur les cartes réseau d’**OPFW**, **AZF1**, **AZF2** et **AZF3** qui sont utilisées pour le routage (toutes les cartes réseau sauf celles liées au sous-réseau de gestion).</span><span class="sxs-lookup"><span data-stu-id="0aafc-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="0aafc-250">Règles de pare-feu</span><span class="sxs-lookup"><span data-stu-id="0aafc-250">Firewall Rules</span></span>
<span data-ttu-id="0aafc-251">Comme décrit ci-dessus, le transfert IP ne garantit que l’envoi des paquets à des appliances virtuelles.</span><span class="sxs-lookup"><span data-stu-id="0aafc-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="0aafc-252">Votre appliance doit encore décider quoi faire avec les paquets.</span><span class="sxs-lookup"><span data-stu-id="0aafc-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="0aafc-253">Dans le scénario ci-dessus, vous devez créer les règles suivantes dans vos appliances :</span><span class="sxs-lookup"><span data-stu-id="0aafc-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="0aafc-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="0aafc-254">OPFW</span></span>
<span data-ttu-id="0aafc-255">OPFW représente un appareil local contenant les règles suivantes :</span><span class="sxs-lookup"><span data-stu-id="0aafc-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="0aafc-256">**Itinéraire** : tout le trafic vers 10.0.0.0/16 (**azurevnet**) doit être envoyé via le tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="0aafc-257">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port2** et **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="0aafc-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="0aafc-258">AZF1</span></span>
<span data-ttu-id="0aafc-259">AZF1 représente une appliance virtuelle Azure contenant les règles suivantes :</span><span class="sxs-lookup"><span data-stu-id="0aafc-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="0aafc-260">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port1** et **port2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="0aafc-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="0aafc-261">AZF2</span></span>
<span data-ttu-id="0aafc-262">AZF2 représente une appliance virtuelle Azure contenant les règles suivantes :</span><span class="sxs-lookup"><span data-stu-id="0aafc-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="0aafc-263">**Itinéraire** : tout le trafic vers 10.0.0.0/16 (**onpremvnet**) doit être envoyé à l’adresse IP de la passerelle Azure (par exemple, 10.0.0.1) via **port1**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="0aafc-264">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port1** et **port2**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="0aafc-265">Groupes de sécurité réseau (NSG)</span><span class="sxs-lookup"><span data-stu-id="0aafc-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="0aafc-266">Dans ce scénario, les groupes de sécurité réseau ne sont pas utilisés.</span><span class="sxs-lookup"><span data-stu-id="0aafc-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="0aafc-267">Toutefois, vous pouvez appliquer des groupes de sécurité réseau à chaque sous-réseau pour limiter les trafics entrant et sortant.</span><span class="sxs-lookup"><span data-stu-id="0aafc-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="0aafc-268">Par exemple, vous pouvez appliquer les règles de groupe de sécurité réseau suivantes au sous-réseau FW externe.</span><span class="sxs-lookup"><span data-stu-id="0aafc-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="0aafc-269">**Entrant**</span><span class="sxs-lookup"><span data-stu-id="0aafc-269">**Incoming**</span></span>

* <span data-ttu-id="0aafc-270">Autoriser tout le trafic TCP provenant d’Internet vers le port 80 sur toutes les machines virtuelles du sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="0aafc-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="0aafc-271">Refuser tout autre trafic provenant d’Internet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="0aafc-272">**Sortant**</span><span class="sxs-lookup"><span data-stu-id="0aafc-272">**Outgoing**</span></span>

* <span data-ttu-id="0aafc-273">Refuser tout le trafic provenant d’Internet.</span><span class="sxs-lookup"><span data-stu-id="0aafc-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="0aafc-274">Étapes de haut niveau</span><span class="sxs-lookup"><span data-stu-id="0aafc-274">High level steps</span></span>
<span data-ttu-id="0aafc-275">Pour déployer ce scénario, suivez la procédure générale suivante.</span><span class="sxs-lookup"><span data-stu-id="0aafc-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="0aafc-276">Connectez-vous à votre abonnement Azure.</span><span class="sxs-lookup"><span data-stu-id="0aafc-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="0aafc-277">Si vous souhaitez déployer un réseau virtuel pour imiter le réseau local, approvisionnez les ressources qui font partie de **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="0aafc-278">Approvisionnez les ressources qui font partie de **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="0aafc-279">Approvisionnez le tunnel reliant **onpremvnet** à **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="0aafc-280">Une fois toutes les ressources approvisionnées, ouvrez une session sur **onpremvm2** et envoyez la commande ping 10.0.3.101 pour tester la connectivité entre **onpremsn2** et **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="0aafc-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

