---
title: connexion aaaHybrid avec application de couche 2 | Documents Microsoft
description: "Découvrez comment toodeploy équipements virtuels et UDR toocreate un environnement d’application à plusieurs niveaux dans Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="839c2-103">Scénario d’appliance virtuelle</span><span class="sxs-lookup"><span data-stu-id="839c2-103">Virtual appliance scenario</span></span>
<span data-ttu-id="839c2-104">Un scénario courant entre le client Azure supérieure est hello besoin tooprovide un toohello d’application à deux niveaux exposé Internet, tout en autorisant le niveau précédent toohello d’accès à partir d’un centre de données local.</span><span class="sxs-lookup"><span data-stu-id="839c2-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="839c2-105">Ce document vous guidera dans un scénario à l’aide d’utilisateur défini itinéraires (UDR), une passerelle VPN et le réseau équipements virtuels toodeploy un environnement à deux niveaux qui répond aux hello suivant les exigences :</span><span class="sxs-lookup"><span data-stu-id="839c2-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="839c2-106">Application Web doit être accessible à partir de hello Internet public uniquement.</span><span class="sxs-lookup"><span data-stu-id="839c2-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="839c2-107">Application hello hébergement du serveur Web doit être en mesure de tooaccess un serveur d’applications principal.</span><span class="sxs-lookup"><span data-stu-id="839c2-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="839c2-108">Tout le trafic à partir de hello application web de toohello Internet doit traverser un équipement virtuel pare-feu.</span><span class="sxs-lookup"><span data-stu-id="839c2-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="839c2-109">Cette appliance virtuelle ne sera utilisée que pour le trafic Internet.</span><span class="sxs-lookup"><span data-stu-id="839c2-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="839c2-110">Tout le trafic entrant du serveur d’applications toohello doit traverser un équipement virtuel pare-feu.</span><span class="sxs-lookup"><span data-stu-id="839c2-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="839c2-111">Cet appareil virtuel sera utilisé pour le serveur d’accès toohello principal fin et l’accès à venir de hello sur un réseau local via une passerelle VPN.</span><span class="sxs-lookup"><span data-stu-id="839c2-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="839c2-112">Les administrateurs doivent être des équipements virtuels pare-feu hello toomanage en mesure de leur ordinateur local, en utilisant un troisième pare-feu appliance virtuelle utilisé exclusivement à des fins de gestion.</span><span class="sxs-lookup"><span data-stu-id="839c2-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="839c2-113">Il s’agit d’un scénario avec une zone DMZ et un réseau protégé.</span><span class="sxs-lookup"><span data-stu-id="839c2-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="839c2-114">Ce scénario peut être mis en œuvre dans Azure à l’aide de groupes de sécurité réseau, d’appliances virtuelles de pare-feu ou d’une combinaison des deux.</span><span class="sxs-lookup"><span data-stu-id="839c2-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="839c2-115">tableau de Hello ci-dessous présente certains des avantages et inconvénients entre les groupes de sécurité réseau et les équipements virtuels pare-feu hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="839c2-116">Avantages</span><span class="sxs-lookup"><span data-stu-id="839c2-116">Pros</span></span> | <span data-ttu-id="839c2-117">Inconvénients</span><span class="sxs-lookup"><span data-stu-id="839c2-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-118">Groupe de sécurité réseau</span><span class="sxs-lookup"><span data-stu-id="839c2-118">NSG</span></span> |<span data-ttu-id="839c2-119">Aucun coût.</span><span class="sxs-lookup"><span data-stu-id="839c2-119">No cost.</span></span> <br/><span data-ttu-id="839c2-120">Intégré dans Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="839c2-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="839c2-121">Possibilité de créer des règles dans les modèles ARM.</span><span class="sxs-lookup"><span data-stu-id="839c2-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="839c2-122">Complexité variable dans les environnements de grande taille.</span><span class="sxs-lookup"><span data-stu-id="839c2-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="839c2-123">Pare-feu</span><span class="sxs-lookup"><span data-stu-id="839c2-123">Firewall</span></span> |<span data-ttu-id="839c2-124">Contrôle total sur le plan des données.</span><span class="sxs-lookup"><span data-stu-id="839c2-124">Full control over data plane.</span></span> <br/><span data-ttu-id="839c2-125">Gestion centralisée via la console du pare-feu.</span><span class="sxs-lookup"><span data-stu-id="839c2-125">Central management through firewall console.</span></span> |<span data-ttu-id="839c2-126">Coût de l’appliance de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="839c2-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="839c2-127">Non intégré dans Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="839c2-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="839c2-128">solution Hello ci-dessous utilise un pare-feu équipements virtuels tooimplement un scénario de réseau protégé/un réseau de périmètre.</span><span class="sxs-lookup"><span data-stu-id="839c2-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="839c2-129">Considérations</span><span class="sxs-lookup"><span data-stu-id="839c2-129">Considerations</span></span>
<span data-ttu-id="839c2-130">Vous pouvez déployer l’environnement hello expliqué ci-dessus dans Azure à l’aide de différentes fonctionnalités disponibles aujourd'hui, comme suit.</span><span class="sxs-lookup"><span data-stu-id="839c2-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="839c2-131">**Réseau virtuel**.</span><span class="sxs-lookup"><span data-stu-id="839c2-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="839c2-132">Un réseau virtuel Azure agit dans le réseau local de tooan similaire de manière et peuvent être placé dans un ou plusieurs isolation du trafic tooprovide sous-réseaux et la séparation des préoccupations.</span><span class="sxs-lookup"><span data-stu-id="839c2-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="839c2-133">**Appliance virtuelle**.</span><span class="sxs-lookup"><span data-stu-id="839c2-133">**Virtual appliance**.</span></span> <span data-ttu-id="839c2-134">Plusieurs partenaires fournissent des équipements virtuels Bonjour Azure Marketplace qui peut être utilisé pour les trois pare-feu hello décrites ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="839c2-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="839c2-135">**Itinéraires définis par l’utilisateur**.</span><span class="sxs-lookup"><span data-stu-id="839c2-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="839c2-136">Tables d’itinéraires peuvent contenir UDRs utilisées par Azure flux de hello toocontrol mise en réseau de paquets au sein d’un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="839c2-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="839c2-137">Ces tables d’itinéraires peuvent être appliqué toosubnets.</span><span class="sxs-lookup"><span data-stu-id="839c2-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="839c2-138">Une des fonctionnalités les plus récents de hello dans Azure est hello capacité tooapply un toohello de table itinéraire GatewaySubnet, fournissant hello capacité tooforward tout le trafic entrant dans hello réseau virtuel Azure à partir d’une appliance virtuelle à tooa connexion hybride.</span><span class="sxs-lookup"><span data-stu-id="839c2-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="839c2-139">**Transfert IP**.</span><span class="sxs-lookup"><span data-stu-id="839c2-139">**IP Forwarding**.</span></span> <span data-ttu-id="839c2-140">Par défaut, hello du moteur de mise en réseau Azure transférer les paquets toovirtual cartes d’interface réseau (NIC) uniquement si hello adresse NIC IP correspond à l’adresse IP de destination de paquets hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="839c2-141">Par conséquent, si un UDR définit que tooa donné appliance virtuelle doit être envoyé à un paquet, hello du moteur de mise en réseau Azure diminuerait, ce paquet.</span><span class="sxs-lookup"><span data-stu-id="839c2-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="839c2-142">paquet de hello tooensure est remis tooa machine virtuelle (dans ce cas, une appliance virtuelle) qui n’est pas destination réelle de hello pour les paquets hello, vous devez tooenable le transfert IP pour l’appliance virtuelle hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="839c2-143">**Groupes de sécurité réseau (NSG)**.</span><span class="sxs-lookup"><span data-stu-id="839c2-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="839c2-144">exemple Hello ci-dessous ne fait pas l’utilisation de groupes de sécurité réseau, mais vous pouvez utiliser des sous-réseaux toohello de groupes de sécurité réseau appliquées et/ou des cartes réseau dans cet solution toofurther filtre hello le trafic vers et depuis ces sous-réseaux et les cartes réseau.</span><span class="sxs-lookup"><span data-stu-id="839c2-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![Connectivité IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="839c2-146">Dans cet exemple, il existe un abonnement qui contient les éléments suivants de hello :</span><span class="sxs-lookup"><span data-stu-id="839c2-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="839c2-147">2 groupes de ressources, ne pas illustrés hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="839c2-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="839c2-148">**ONPREMRG**.</span></span> <span data-ttu-id="839c2-149">Contient toutes les ressources toosimulate nécessaire un réseau local.</span><span class="sxs-lookup"><span data-stu-id="839c2-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="839c2-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="839c2-150">**AZURERG**.</span></span> <span data-ttu-id="839c2-151">Contient toutes les ressources nécessaires pour l’environnement de réseau virtuel Azure hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="839c2-152">Un réseau virtuel nommé **onpremvnet** utilisé toomimic local d’un centre de données segmentée comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="839c2-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="839c2-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="839c2-153">**onpremsn1**.</span></span> <span data-ttu-id="839c2-154">Sous-réseau contenant un ordinateur virtuel (VM) en cours d’exécution Ubuntu toomimic un serveur local.</span><span class="sxs-lookup"><span data-stu-id="839c2-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="839c2-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-155">**onpremsn2**.</span></span> <span data-ttu-id="839c2-156">Sous-réseau contenant une machine virtuelle exécutant Ubuntu toomimic un ordinateur local utilisé par un administrateur.</span><span class="sxs-lookup"><span data-stu-id="839c2-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="839c2-157">Il existe une appliance virtuelle pare-feu nommée **OPFW** sur **onpremvnet** utilisé toomaintain un tunnel trop**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="839c2-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="839c2-158">Un réseau virtuel nommé **azurevnet** segmenté comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="839c2-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="839c2-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="839c2-159">**azsn1**.</span></span> <span data-ttu-id="839c2-160">Sous-réseau de pare-feu externe utilisé exclusivement pour les pare-feu externe hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="839c2-161">Tout le trafic Internet entrera par ce sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="839c2-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="839c2-162">Ce sous-réseau ne contient qu’un pare-feu externe toohello de carte réseau liée.</span><span class="sxs-lookup"><span data-stu-id="839c2-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="839c2-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-163">**azsn2**.</span></span> <span data-ttu-id="839c2-164">Sous-réseau frontal qui héberge une machine virtuelle en cours d’exécution en tant qu’un serveur web qui est accessible à partir de hello Internet.</span><span class="sxs-lookup"><span data-stu-id="839c2-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="839c2-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="839c2-165">**azsn3**.</span></span> <span data-ttu-id="839c2-166">Sous-réseau principal qui héberge une machine virtuelle exécutant un serveur d’applications principal qui sera accessible par le serveur de web frontal hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="839c2-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="839c2-167">**azsn4**.</span></span> <span data-ttu-id="839c2-168">Sous-réseau de gestion utilisé exclusivement tooprovide gestion accès tooall pare-feu équipements virtuels.</span><span class="sxs-lookup"><span data-stu-id="839c2-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="839c2-169">Ce sous-réseau contient uniquement une carte réseau pour chaque appliance virtuelle pare-feu utilisé dans les solutions hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="839c2-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="839c2-170">**GatewaySubnet**.</span></span> <span data-ttu-id="839c2-171">Sous-réseau de connexion hybride Azure requis pour la connectivité de tooprovide ExpressRoute et passerelle VPN entre réseaux virtuels Azure et d’autres réseaux.</span><span class="sxs-lookup"><span data-stu-id="839c2-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="839c2-172">Il existe 3 équipements virtuels pare-feu Bonjour **azurevnet** réseau.</span><span class="sxs-lookup"><span data-stu-id="839c2-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="839c2-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="839c2-173">**AZF1**.</span></span> <span data-ttu-id="839c2-174">Pare-feu externe exposé toohello Internet public à l’aide d’une ressource d’adresse IP publique dans Azure.</span><span class="sxs-lookup"><span data-stu-id="839c2-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="839c2-175">Vous devez tooensure vous disposez d’un modèle à partir de hello Marketplace, ou directement à partir de votre fournisseur de matériel, qui configure une appliance virtuelle 3-NIC.</span><span class="sxs-lookup"><span data-stu-id="839c2-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="839c2-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-176">**AZF2**.</span></span> <span data-ttu-id="839c2-177">Le pare-feu interne utilisé le trafic de toocontrol entre **azsn2** et **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="839c2-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="839c2-178">C’est également une appliance virtuelle à 3 cartes réseau.</span><span class="sxs-lookup"><span data-stu-id="839c2-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="839c2-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="839c2-179">**AZF3**.</span></span> <span data-ttu-id="839c2-180">Tooadministrators accessible de pare-feu administration à partir de hello centre de données sur site et sous-réseau de gestion tooa connecté utilisé toomanage tous les appareils de pare-feu.</span><span class="sxs-lookup"><span data-stu-id="839c2-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="839c2-181">Vous pouvez trouver des modèles d’appliance virtuelle 2-NIC Bonjour Marketplace, ou la demande directement à partir de votre fournisseur de matériel.</span><span class="sxs-lookup"><span data-stu-id="839c2-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="839c2-182">Itinéraire défini par l’utilisateur (UDR)</span><span class="sxs-lookup"><span data-stu-id="839c2-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="839c2-183">Chaque sous-réseau dans Azure peut être lié tooa UDR table utilisée toodefine comment le trafic initié dans ce sous-réseau est routé.</span><span class="sxs-lookup"><span data-stu-id="839c2-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="839c2-184">Si aucune UDRs ne sont définies, Azure utilise par défaut itinéraires tooallow trafic tooflow à partir d’un seul sous-réseau tooanother.</span><span class="sxs-lookup"><span data-stu-id="839c2-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="839c2-185">toobetter comprendre UDRs, visitez le site [que sont les itinéraires définis d’utilisateur et le transfert IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="839c2-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="839c2-186">tooensure communication s’effectue via hello pare-feu approprié, en fonction de la dernière demande hello ci-dessus, vous devez suivant de hello toocreate table d’itinéraires contenant UDRs dans **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="839c2-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="839c2-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="839c2-187">azgwudr</span></span>
<span data-ttu-id="839c2-188">Dans ce scénario, hello uniquement le trafic circulant de local tooAzure sera utilisé toomanage hello pare-feu en vous connectant trop**AZF3**, et que le trafic doit traverser le pare-feu interne hello, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="839c2-189">Par conséquent, qu’une seule est nécessaire dans hello **GatewaySubnet** comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="839c2-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="839c2-190">Destination</span><span class="sxs-lookup"><span data-stu-id="839c2-190">Destination</span></span> | <span data-ttu-id="839c2-191">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="839c2-191">Next hop</span></span> | <span data-ttu-id="839c2-192">Explication</span><span class="sxs-lookup"><span data-stu-id="839c2-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-193">10.0.4.0/24</span></span> |<span data-ttu-id="839c2-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="839c2-194">10.0.3.11</span></span> |<span data-ttu-id="839c2-195">Permet de pare-feu de gestion local le trafic tooreach **AZF3**</span><span class="sxs-lookup"><span data-stu-id="839c2-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="839c2-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="839c2-196">azsn2udr</span></span>
| <span data-ttu-id="839c2-197">Destination</span><span class="sxs-lookup"><span data-stu-id="839c2-197">Destination</span></span> | <span data-ttu-id="839c2-198">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="839c2-198">Next hop</span></span> | <span data-ttu-id="839c2-199">Explication</span><span class="sxs-lookup"><span data-stu-id="839c2-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-200">10.0.3.0/24</span></span> |<span data-ttu-id="839c2-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="839c2-201">10.0.2.11</span></span> |<span data-ttu-id="839c2-202">Permet de sous-réseau de trafic toohello principal réseau hébergeant le serveur d’applications hello via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="839c2-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="839c2-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="839c2-203">0.0.0.0/0</span></span> |<span data-ttu-id="839c2-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="839c2-204">10.0.2.10</span></span> |<span data-ttu-id="839c2-205">Permet à tous les autres toobe du trafic routé via **AZF1**</span><span class="sxs-lookup"><span data-stu-id="839c2-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="839c2-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="839c2-206">azsn3udr</span></span>
| <span data-ttu-id="839c2-207">Destination</span><span class="sxs-lookup"><span data-stu-id="839c2-207">Destination</span></span> | <span data-ttu-id="839c2-208">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="839c2-208">Next hop</span></span> | <span data-ttu-id="839c2-209">Explication</span><span class="sxs-lookup"><span data-stu-id="839c2-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-210">10.0.2.0/24</span></span> |<span data-ttu-id="839c2-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="839c2-211">10.0.3.10</span></span> |<span data-ttu-id="839c2-212">Autorise le trafic trop**azsn2** tooflow à partir de l’application serveur toohello webserver via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="839c2-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="839c2-213">Vous devez également les tables d’itinéraires toocreate des sous-réseaux hello **onpremvnet** toomimic hello centre de données sur site.</span><span class="sxs-lookup"><span data-stu-id="839c2-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="839c2-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="839c2-214">onpremsn1udr</span></span>
| <span data-ttu-id="839c2-215">Destination</span><span class="sxs-lookup"><span data-stu-id="839c2-215">Destination</span></span> | <span data-ttu-id="839c2-216">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="839c2-216">Next hop</span></span> | <span data-ttu-id="839c2-217">Explication</span><span class="sxs-lookup"><span data-stu-id="839c2-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-218">192.168.2.0/24</span></span> |<span data-ttu-id="839c2-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="839c2-219">192.168.1.4</span></span> |<span data-ttu-id="839c2-220">Autorise le trafic trop**onpremsn2** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="839c2-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="839c2-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="839c2-221">onpremsn2udr</span></span>
| <span data-ttu-id="839c2-222">Destination</span><span class="sxs-lookup"><span data-stu-id="839c2-222">Destination</span></span> | <span data-ttu-id="839c2-223">Tronçon suivant</span><span class="sxs-lookup"><span data-stu-id="839c2-223">Next hop</span></span> | <span data-ttu-id="839c2-224">Explication</span><span class="sxs-lookup"><span data-stu-id="839c2-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="839c2-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-225">10.0.3.0/24</span></span> |<span data-ttu-id="839c2-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="839c2-226">192.168.2.4</span></span> |<span data-ttu-id="839c2-227">Permet de sous-réseau de trafic toohello sauvegardée dans Azure via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="839c2-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="839c2-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="839c2-228">192.168.1.0/24</span></span> |<span data-ttu-id="839c2-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="839c2-229">192.168.2.4</span></span> |<span data-ttu-id="839c2-230">Autorise le trafic trop**onpremsn1** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="839c2-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="839c2-231">transfert IP</span><span class="sxs-lookup"><span data-stu-id="839c2-231">IP Forwarding</span></span>
<span data-ttu-id="839c2-232">UDR et le routage IP sont des fonctionnalités que vous pouvez utiliser dans la combinaison tooallow équipements virtuels toobe utilisé toocontrol le flux de trafic dans un réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="839c2-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="839c2-233">Une appliance virtuelle n’est rien de plus qu’une machine virtuelle qui exécute un application utilisée toohandle le trafic d’une certaine façon, tel qu’un pare-feu ou un périphérique NAT.</span><span class="sxs-lookup"><span data-stu-id="839c2-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="839c2-234">Cet appareil virtuel que machine virtuelle doit être en mesure de tooreceive trafic entrant qui est ne traité pas tooitself.</span><span class="sxs-lookup"><span data-stu-id="839c2-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="839c2-235">tooallow de trafic de machine virtuelle tooreceive adressé tooother destinations, vous devez activer le transfert IP pour hello machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="839c2-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="839c2-236">Il s’agit de configuration, n’est pas un paramètre dans le système d’exploitation de hello invité Azure.</span><span class="sxs-lookup"><span data-stu-id="839c2-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="839c2-237">Votre appliance virtuelle toujours besoins toorun certain type d’application toohandle hello le trafic entrant et acheminer de manière appropriée.</span><span class="sxs-lookup"><span data-stu-id="839c2-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="839c2-238">toolearn en savoir plus sur le transfert IP, visitez [que sont les itinéraires définis d’utilisateur et le transfert IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="839c2-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="839c2-239">Par exemple, imaginez que vous avez hello après l’installation dans un réseau virtuel Azure :</span><span class="sxs-lookup"><span data-stu-id="839c2-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="839c2-240">Le sous-réseau **onpremsn1** contient une machine virtuelle nommée **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="839c2-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="839c2-241">Le sous-réseau **onpremsn2** contient une machine virtuelle nommée **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="839c2-242">Une appliance virtuelle nommée **OPFW** est connecté trop**onpremsn1** et **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="839c2-243">Un itinéraire défini par l’utilisateur lié trop**onpremsn1** Spécifie que tout le trafic trop**onpremsn2** doivent être envoyées trop**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="839c2-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="839c2-244">AT que ce point, si **onpremvm1** tente d’une connexion avec tooestablish **onpremvm2**, hello UDR sera utilisé et que le trafic sera envoyé trop**OPFW** en tant que tronçon suivant de hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="839c2-245">N’oubliez pas que hello destination du paquet n’est pas modifié, il indique toujours **onpremvm2** hello destination.</span><span class="sxs-lookup"><span data-stu-id="839c2-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="839c2-246">Sans activé pour le transfert IP **OPFW**, hello logique de réseau virtuelle Azure supprimera les paquets hello, car elle permet uniquement les paquets envoyé de toobe tooa machine virtuelle si hello adresse IP de la machine virtuelle est la destination hello pour les paquets hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="839c2-247">Avec le transfert IP, hello logique de réseau virtuel Azure transfèrera tooOPFW de paquets hello, sans modifier son adresse de destination d’origine.</span><span class="sxs-lookup"><span data-stu-id="839c2-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="839c2-248">**OPFW** doit gérer les paquets hello et pour déterminer quelles toodo avec eux.</span><span class="sxs-lookup"><span data-stu-id="839c2-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="839c2-249">Pour le scénario hello ci-dessus toowork, vous devez activer le transfert IP sur les cartes réseau de hello pour **OPFW**, **AZF1**, **AZF2**, et **AZF3** qui sont utilisés pour (toutes les cartes réseau à l’exception de hello ceux liés toohello gestion sous-réseau) de routage.</span><span class="sxs-lookup"><span data-stu-id="839c2-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="839c2-250">Règles de pare-feu</span><span class="sxs-lookup"><span data-stu-id="839c2-250">Firewall Rules</span></span>
<span data-ttu-id="839c2-251">Comme décrit ci-dessus, le transfert IP seulement garantit les équipements virtuels toohello les paquets sont envoyés.</span><span class="sxs-lookup"><span data-stu-id="839c2-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="839c2-252">Votre application doit tout de même toodecide le toodo avec les paquets.</span><span class="sxs-lookup"><span data-stu-id="839c2-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="839c2-253">Dans le scénario hello ci-dessus, vous devrez hello toocreate suivant les règles dans vos applications :</span><span class="sxs-lookup"><span data-stu-id="839c2-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="839c2-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="839c2-254">OPFW</span></span>
<span data-ttu-id="839c2-255">OPFW représente un périphérique local contenant hello suivant les règles :</span><span class="sxs-lookup"><span data-stu-id="839c2-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="839c2-256">**Itinéraire**: tout le trafic too10.0.0.0/16 (**azurevnet**) doivent être envoyés via le tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="839c2-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="839c2-257">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port2** et **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="839c2-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="839c2-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="839c2-258">AZF1</span></span>
<span data-ttu-id="839c2-259">AZF1 représente une appliance virtuelle Azure contenant hello suivant les règles :</span><span class="sxs-lookup"><span data-stu-id="839c2-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="839c2-260">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port1** et **port2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="839c2-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="839c2-261">AZF2</span></span>
<span data-ttu-id="839c2-262">AZF2 représente une appliance virtuelle Azure contenant hello suivant les règles :</span><span class="sxs-lookup"><span data-stu-id="839c2-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="839c2-263">**Itinéraire**: tout le trafic too10.0.0.0/16 (**onpremvnet**) doivent être envoyés une adresse IP de passerelle Azure toohello (par exemple, 10.0.0.1) via **port1**.</span><span class="sxs-lookup"><span data-stu-id="839c2-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="839c2-264">**Stratégie** : autoriser tout le trafic bidirectionnel entre **port1** et **port2**.</span><span class="sxs-lookup"><span data-stu-id="839c2-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="839c2-265">Groupes de sécurité réseau (NSG)</span><span class="sxs-lookup"><span data-stu-id="839c2-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="839c2-266">Dans ce scénario, les groupes de sécurité réseau ne sont pas utilisés.</span><span class="sxs-lookup"><span data-stu-id="839c2-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="839c2-267">Toutefois, vous pouvez appliquer des groupes de sécurité réseau tooeach toorestrict entrant et sortant du trafic de sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="839c2-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="839c2-268">Par exemple, vous pouvez appliquer hello suivant le sous-réseau FW externe NSG règles toohello.</span><span class="sxs-lookup"><span data-stu-id="839c2-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="839c2-269">**Entrant**</span><span class="sxs-lookup"><span data-stu-id="839c2-269">**Incoming**</span></span>

* <span data-ttu-id="839c2-270">Autoriser tout le trafic TCP de hello Internet tooport 80 sur n’importe quel ordinateur virtuel dans un sous-réseau de hello.</span><span class="sxs-lookup"><span data-stu-id="839c2-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="839c2-271">Refuser tout le trafic à partir de hello Internet.</span><span class="sxs-lookup"><span data-stu-id="839c2-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="839c2-272">**Sortant**</span><span class="sxs-lookup"><span data-stu-id="839c2-272">**Outgoing**</span></span>

* <span data-ttu-id="839c2-273">Refuser tout trafic toohello Internet.</span><span class="sxs-lookup"><span data-stu-id="839c2-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="839c2-274">Étapes de haut niveau</span><span class="sxs-lookup"><span data-stu-id="839c2-274">High level steps</span></span>
<span data-ttu-id="839c2-275">toodeploy ce scénario, suivez hello procédure générale ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="839c2-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="839c2-276">Connexion tooyour abonnement Azure.</span><span class="sxs-lookup"><span data-stu-id="839c2-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="839c2-277">Si vous voulez toodeploy un Bonjour toomimic de réseau virtuel local réseau, configurer les ressources de hello qui font partie de **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="839c2-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="839c2-278">Prévoir les ressources hello qui font partie de **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="839c2-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="839c2-279">Tunnel hello de fourniture de **onpremvnet** trop**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="839c2-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="839c2-280">Une fois que toutes les ressources sont configurés, ouvrez une session trop**onpremvm2** et la connectivité de tootest ping 10.0.3.101 entre **onpremsn2** et **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="839c2-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

