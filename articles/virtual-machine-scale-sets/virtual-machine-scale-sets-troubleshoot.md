---
title: "Dépannage de la mise à l’échelle automatique à l’aide des groupes identiques de machines virtuelles | Microsoft Docs"
description: "Dépanner la mise à l’échelle automatique avec des jeux de mise à l’échelle de machine virtuelle Découvrez les problèmes couramment rencontrés et apprenez à les résoudre."
services: virtual-machine-scale-sets
documentationcenter: 
author: gbowerman
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: c7d87b72-ee24-4e52-9377-a42f337f76fa
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: windows
ms.devlang: na
ms.topic: article
ms.date: 10/28/2016
ms.author: guybo
ms.openlocfilehash: bd45a0fb99a77851aa7b91d23bd4b830b6f5cc7b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="troubleshooting-autoscale-with-virtual-machine-scale-sets"></a><span data-ttu-id="b6d14-104">Dépannage de la mise à l’échelle automatique avec des jeux de mise à l’échelle de machine virtuelle</span><span class="sxs-lookup"><span data-stu-id="b6d14-104">Troubleshooting autoscale with Virtual Machine Scale Sets</span></span>
<span data-ttu-id="b6d14-105">**Problème** : vous avez créé une infrastructure de mise à l’échelle automatique dans Azure Resource Manager à l’aide de VM Scale Sets (par exemple en déployant un modèle comme https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale), vos règles de mise à l’échelle sont définies et fonctionnent très bien, sauf que, quelle que soit la charge placée sur les machines virtuelles, elle n’est pas mise à l’échelle automatiquement.</span><span class="sxs-lookup"><span data-stu-id="b6d14-105">**Problem** – you’ve created an autoscaling infrastructure in Azure Resource Manager using VM Scale Sets –  for example by deploying a template like this: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale  – you have your scale rules defined and it works great, except that no matter how much load you put on the VMs, it won’t autoscale.</span></span>

## <a name="troubleshooting-steps"></a><span data-ttu-id="b6d14-106">Étapes de dépannage</span><span class="sxs-lookup"><span data-stu-id="b6d14-106">Troubleshooting steps</span></span>
<span data-ttu-id="b6d14-107">Parmi les éléments à prendre en considération :</span><span class="sxs-lookup"><span data-stu-id="b6d14-107">Some things to consider include:</span></span>

* <span data-ttu-id="b6d14-108">De combien de cœurs chaque machine virtuelle dispose-t-elle et chargez-vous chaque cœur ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-108">How many cores does each VM have, and are you loading each core?</span></span>
  <span data-ttu-id="b6d14-109">L’exemple de modèle Azure QuickStart ci-dessus a un script do_work.php, qui charge un seul cœur.</span><span class="sxs-lookup"><span data-stu-id="b6d14-109">The example Azure Quickstart template above has a do_work.php script, which loads a single core.</span></span> <span data-ttu-id="b6d14-110">Si vous utilisez une machine virtuelle plus volumineuse qu’une machine virtuelle à un seul cœur telle qu’une machine Standard_A1 ou D1, vous devez exécuter cette charge plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="b6d14-110">If you’re using a VM bigger than a single core VM size like Standard_A1 or D1 then you’d need to run this load multiple times.</span></span> <span data-ttu-id="b6d14-111">Vérifiez le nombre de cœurs de vos machines virtuelles en consultant [Tailles des machines virtuelles Windows dans Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span><span class="sxs-lookup"><span data-stu-id="b6d14-111">Check how many cores your VMs by reviewing [Sizes for Windows virtual machines in Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span></span>
* <span data-ttu-id="b6d14-112">Combien de machines virtuelles le jeu de mise à l’échelle de machines virtuelles inclut-il, travaillez-vous sur chacun d’eux ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-112">How many VMs in the VM Scale Set, are you doing work on each one?</span></span>
  
    <span data-ttu-id="b6d14-113">La taille des instances augmentera uniquement lorsque l’utilisation moyenne du processeur sur **toutes** les machines virtuelles d’un jeu de mise à l’échelle dépassera la valeur seuil, sur la période définie dans les règles de mise à l’échelle automatique.</span><span class="sxs-lookup"><span data-stu-id="b6d14-113">A scale out event will only take place when the average CPU across **all** the VMs in a scale set exceeds the threshold value, over the time internal defined in the autoscale rules.</span></span>
* <span data-ttu-id="b6d14-114">Vous avez manqué un événement de mise à l’échelle ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-114">Did you miss any scale events?</span></span>
  
    <span data-ttu-id="b6d14-115">Consultez les journaux d’audit dans le portail Azure pour les événements de mise à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-115">Check the audit logs in the Azure portal for scale events.</span></span> <span data-ttu-id="b6d14-116">Peut-être qu’une mise à l’échelle vers le haut ou vers le bas a été ignorée.</span><span class="sxs-lookup"><span data-stu-id="b6d14-116">Maybe there was a scale up and a scale down which was missed.</span></span> <span data-ttu-id="b6d14-117">Vous pouvez filtrer sur « Mise à l’échelle ».</span><span class="sxs-lookup"><span data-stu-id="b6d14-117">You can filter by “Scale”..</span></span>
  
    ![Journaux d’audit][audit]
* <span data-ttu-id="b6d14-119">Les seuils d’augmentation et de diminution de la taille des instances sont-ils suffisamment différents ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-119">Are your scale-in and scale-out thresholds sufficiently different?</span></span>
  
    <span data-ttu-id="b6d14-120">Supposons que vous définissez une règle d’augmentation de la taille des instances lorsque l’utilisation moyenne du processeur est supérieure à 50 % pendant 5 minutes et une règle de diminution de la taille des instances lorsque l’utilisation moyenne du processeur est inférieure à 50 %.</span><span class="sxs-lookup"><span data-stu-id="b6d14-120">Suppose you set a rule to scale out when average CPU is greater than 50% over 5 minutes, and to scale in when average CPU is less than 50%.</span></span> <span data-ttu-id="b6d14-121">Cela entraînera un problème d’oscillation lorsque l’utilisation du processeur est proche de ce seuil, avec des actions de mise à l’échelle entraînant constamment l’augmentation et la diminution de la taille du jeu.</span><span class="sxs-lookup"><span data-stu-id="b6d14-121">This would cause a “flapping” problem when CPU usage is close to this threshold, with scale actions constantly increasing and decreasing the size of the set.</span></span> <span data-ttu-id="b6d14-122">De ce fait, le service de mise à l’échelle automatique tente d’empêcher l’oscillation, ce qui peut se manifester par une absence de mise à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-122">Because of this, the autoscale service tries to prevent “flapping”, which can manifest as not scaling.</span></span> <span data-ttu-id="b6d14-123">Par conséquent, assurez-vous que les seuils d’augmentation et de diminution de la taille des instances sont suffisamment différents pour laisser une marge lors de la mise à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-123">Therefore make sure your scale-out and scale-in thresholds are sufficiently different to allow some space in between scaling.</span></span>
* <span data-ttu-id="b6d14-124">Avez-vous écrit votre propre modèle JSON ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-124">Did you write your own JSON template?</span></span>
  
    <span data-ttu-id="b6d14-125">Il est facile de commettre des erreurs. Commencez avec un modèle comme celui ci-dessus, dont l’efficacité a été prouvée, et apportez de petites modifications incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="b6d14-125">It is easy to make mistakes, so start with a template like the one above which is proven to work, and make small incremental changes.</span></span> 
* <span data-ttu-id="b6d14-126">Pouvez vous procéder manuellement à une augmentation ou à une diminution de la taille des instances ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-126">Can you manually scale in or out?</span></span>
  
    <span data-ttu-id="b6d14-127">Essayez de redéployer la ressource de jeu de mise à l’échelle de machine virtuelle avec un paramètre de capacité différent pour modifier le nombre de machines virtuelles manuellement.</span><span class="sxs-lookup"><span data-stu-id="b6d14-127">Try redeploying the VM Scale Set resource with a different “capacity” setting to change the number of VMs manually.</span></span> <span data-ttu-id="b6d14-128">Vous trouverez un exemple de modèle ici : https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing (vous devrez peut-être modifier le modèle pour vous assurer que la taille de machine est identique à celle de votre jeu de mise à l’échelle).</span><span class="sxs-lookup"><span data-stu-id="b6d14-128">An example template to do this is here: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing – you may need to edit the template to make sure it has the same machine size as your Scale Set is using.</span></span> <span data-ttu-id="b6d14-129">Si vous pouvez modifier le nombre de machines virtuelles manuellement, vous savez que le problème est lié à la mise à l’échelle automatique.</span><span class="sxs-lookup"><span data-stu-id="b6d14-129">If you can successfully change the number of VMs manually, then you know the problem is isolated to autoscale.</span></span>
* <span data-ttu-id="b6d14-130">Consultez vos ressources Microsoft.Compute/virtualMachineScaleSet et Microsoft.Insights dans [l’explorateur de ressources Azure](https://resources.azure.com/)</span><span class="sxs-lookup"><span data-stu-id="b6d14-130">Check your Microsoft.Compute/virtualMachineScaleSet, and Microsoft.Insights resources in the [Azure Resource Explorer](https://resources.azure.com/)</span></span>
  
    <span data-ttu-id="b6d14-131">Il s’agit d’un outil de dépannage indispensable qui vous indique l’état de vos ressources Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="b6d14-131">This is an indispensable troubleshooting tool which shows you the state of your Azure Resource Manager resources.</span></span> <span data-ttu-id="b6d14-132">Cliquez sur votre abonnement et examinez le groupe de ressources sur lequel vous effectuez un dépannage.</span><span class="sxs-lookup"><span data-stu-id="b6d14-132">Click on your subscription and look at the Resource Group you are troubleshooting.</span></span> <span data-ttu-id="b6d14-133">Sous le fournisseur de ressources de calcul, consultez le jeu de mise à l’échelle de machine virtuelle que vous avez créé et consultez la vue d’instance, qui vous indique l’état d’un déploiement.</span><span class="sxs-lookup"><span data-stu-id="b6d14-133">Under the Compute resource provider look at the VM Scale Set you created and check the Instance View, which shows you the state of a deployment.</span></span> <span data-ttu-id="b6d14-134">Vérifiez également la vue d’instance des machines virtuelles dans le jeu de mise à l’échelle de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-134">Also check the instance view of VMs in the VM Scale Set.</span></span> <span data-ttu-id="b6d14-135">Ensuite, accédez au fournisseur de ressources Microsoft.Insights et vérifiez que les règles de mise à l’échelle automatique sont correctes.</span><span class="sxs-lookup"><span data-stu-id="b6d14-135">Then go into the Microsoft.Insights resource provider and check the autoscale rules look good.</span></span>
* <span data-ttu-id="b6d14-136">L’extension de diagnostic fonctionne-t-elle et génère-t-elle des données de performance ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-136">Is the Diagnostic extension working and emitting performance data?</span></span>
  
    <span data-ttu-id="b6d14-137">**Mise à jour :** la mise à l’échelle automatique Azure a été améliorée pour utiliser un pipeline de mesures basé sur l’hôte qui ne nécessite plus l’installation d’une extension de diagnostic.</span><span class="sxs-lookup"><span data-stu-id="b6d14-137">**Update:** Azure autoscale has been enhanced to use a host based metrics pipeline which no longer requires a diagnostics extension to be installed.</span></span> <span data-ttu-id="b6d14-138">Cela signifie que les paragraphes suivants ne s’appliquent plus si vous créez une application de mise à l’échelle automatique en utilisant le nouveau pipeline.</span><span class="sxs-lookup"><span data-stu-id="b6d14-138">This means the next few paragraphs no longer apply if you create an autoscaling application using the new pipeline.</span></span> <span data-ttu-id="b6d14-139">Exemple de modèles Azure convertis pour utiliser le pipeline de l’hôte : https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale.</span><span class="sxs-lookup"><span data-stu-id="b6d14-139">An example of Azure templates which have been converted to use the host pipeline is: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale.</span></span> 
  
    <span data-ttu-id="b6d14-140">Le recours aux mesures basées sur l’hôte pour la mise à l’échelle automatique est préférable pour les raisons suivantes :</span><span class="sxs-lookup"><span data-stu-id="b6d14-140">Using host based metrics for autoscale is better for the following reasons:</span></span>
  
  * <span data-ttu-id="b6d14-141">Moins de composants mobiles (en l’absence d’une extension de diagnostics) doivent être installés.</span><span class="sxs-lookup"><span data-stu-id="b6d14-141">Fewer moving parts as no diagnostics extensions need to be installed.</span></span>
  * <span data-ttu-id="b6d14-142">Les modèles sont plus simples.</span><span class="sxs-lookup"><span data-stu-id="b6d14-142">Simpler templates.</span></span> <span data-ttu-id="b6d14-143">Ajoutez simplement des règles de mise à l’échelle automatique Insights à un modèle de groupe identique existant.</span><span class="sxs-lookup"><span data-stu-id="b6d14-143">Just add insights autoscale rules to an existing scale set template.</span></span>
  * <span data-ttu-id="b6d14-144">Reporting plus fiable et lancement plus rapide de nouvelles machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="b6d14-144">More reliable reporting and faster launching of new VMs.</span></span>
    
    <span data-ttu-id="b6d14-145">Les seules raisons qui justifieraient de continuer à utiliser une extension de diagnostic seraient la nécessité d’une mise à l’échelle/d’un reporting de diagnostic de mémoire.</span><span class="sxs-lookup"><span data-stu-id="b6d14-145">The only reasons you might want to keep using a diagnostic extension would be if you need memory diagnostics reporting/scaling.</span></span> <span data-ttu-id="b6d14-146">Les mesures basées sur l’hôte ne génèrent aucun rapport sur la mémoire.</span><span class="sxs-lookup"><span data-stu-id="b6d14-146">Host based metrics doesn't report memory.</span></span>
    
    <span data-ttu-id="b6d14-147">En sachant cela, poursuivez uniquement la lecture de cet article si vous utilisez encore des extensions de diagnostic pour votre mise à l’échelle automatique.</span><span class="sxs-lookup"><span data-stu-id="b6d14-147">With that in mind, only follow the rest of this article if you are still using diagnostic extensions for your autoscaling.</span></span>
    
    <span data-ttu-id="b6d14-148">La mise à l’échelle dans Azure Resource Manager peut fonctionner (mais n’est plus obligatoire) au moyen d’une extension de machine virtuelle appelée « Extension de diagnostics ».</span><span class="sxs-lookup"><span data-stu-id="b6d14-148">Autoscale in Azure Resource Manager can work (but no longer has to) by means of a VM extension called the Diagnostics Extension.</span></span> <span data-ttu-id="b6d14-149">Elle envoie des données de performance à un compte de stockage que vous définissez dans le modèle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-149">It emits performance data to a storage account you define in the template.</span></span> <span data-ttu-id="b6d14-150">Ces données sont ensuite regroupées par le service Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="b6d14-150">This data is then aggregated by the Azure Monitor service.</span></span>
    
    <span data-ttu-id="b6d14-151">Si le service Insights ne peut pas lire les données fournies par les machines virtuelles, il doit vous envoyer un courrier électronique. Par exemple, si les machines virtuelles étaient en panne, consultez votre messagerie (celle indiquée lors de la création du compte Azure).</span><span class="sxs-lookup"><span data-stu-id="b6d14-151">If the Insights service can’t read data from the VMs, it is supposed to send you an email – for example if the VMs were down, so check your email (the one you specified when creating the Azure account).</span></span>
    
    <span data-ttu-id="b6d14-152">Vous pouvez également rechercher vous-même les données.</span><span class="sxs-lookup"><span data-stu-id="b6d14-152">You can also go and look at the data yourself.</span></span> <span data-ttu-id="b6d14-153">Examinez le compte de stockage Azure à l’aide d’un explorateur de cloud.</span><span class="sxs-lookup"><span data-stu-id="b6d14-153">Look at the Azure storage account using a cloud explorer.</span></span> <span data-ttu-id="b6d14-154">Par exemple avec [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), connectez-vous et choisissez l’abonnement Azure que vous utilisez et le nom de compte de stockage de diagnostics référencé dans la définition de l’extension de diagnostic de votre modèle de déploiement.</span><span class="sxs-lookup"><span data-stu-id="b6d14-154">For example using the [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), log in and pick the Azure subscription you’re using, and the Diagnostics storage account name referenced in the Diagnostics extension definition in your deployment template..</span></span>
    
    ![Cloud Explorer][explorer]
    
    <span data-ttu-id="b6d14-156">Vous y trouverez un ensemble de tables où sont stockées les données de chaque machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="b6d14-156">Here you will see a bunch of tables where the data from each VM is being stored.</span></span> <span data-ttu-id="b6d14-157">Prenons Linux et la mesure de processeur comme exemple. Examinez les lignes les plus récentes.</span><span class="sxs-lookup"><span data-stu-id="b6d14-157">Taking Linux and the CPU metric as an example, look at the most recent rows.</span></span> <span data-ttu-id="b6d14-158">L’explorateur de cloud Visual Studio prend en charge un langage de requête. Vous pouvez donc exécuter une requête telle que « Timestamp gt datetime’2016-02-02T21:20:00Z’ » pour être sûr d’obtenir les événements les plus récents (en supposant que l’heure est au format UTC).</span><span class="sxs-lookup"><span data-stu-id="b6d14-158">The Visual Studio cloud explorer supports a query language so you can run a query like “Timestamp gt datetime’2016-02-02T21:20:00Z’” to make sure you get the most recent events (assume time is in UTC).</span></span> <span data-ttu-id="b6d14-159">Les données qui figurent ici correspondent-elles aux règles de mise à l’échelle que vous avez configurées ?</span><span class="sxs-lookup"><span data-stu-id="b6d14-159">Does the data you see in there correspond to the scale rules you set up?</span></span> <span data-ttu-id="b6d14-160">Dans l’exemple ci-dessous, l’utilisation du processeur de la machine 20 a commencé à augmenter jusqu’à 100 % au cours des 5 dernières minutes.</span><span class="sxs-lookup"><span data-stu-id="b6d14-160">In the example below, the CPU for machine 20 started increasing to 100% over the last 5 minutes..</span></span>
    
    ![Tables de stockage][tables]
    
    <span data-ttu-id="b6d14-162">Si les données ne sont pas visibles, cela implique que le problème provient de l’extension de diagnostic en cours d’exécution sur les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="b6d14-162">If the data is not there, then it implies the problem is with the diagnostic extension running in the VMs.</span></span> <span data-ttu-id="b6d14-163">Si les données sont présentes, cela implique un problème lié à vos règles de mise à l’échelle ou au service Insights.</span><span class="sxs-lookup"><span data-stu-id="b6d14-163">If the data is there, it implies there is either a problem with your scale rules, or with the Insights service.</span></span> <span data-ttu-id="b6d14-164">Vérifiez le [statut Azure](https://azure.microsoft.com/status/).</span><span class="sxs-lookup"><span data-stu-id="b6d14-164">Check [Azure Status](https://azure.microsoft.com/status/).</span></span>
    
    <span data-ttu-id="b6d14-165">Une fois que vous avez suivi ces étapes et si vous rencontrez encore des problèmes de mise à l’échelle automatique, vous pouvez chercher de l’aide sur les forums [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp) ou sur [Stack Overflow](http://stackoverflow.com/questions/tagged/azure), ou contacter le support par téléphone.</span><span class="sxs-lookup"><span data-stu-id="b6d14-165">Once you’ve been through these steps, if you are still having autoscale problems you could try the forums on [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp), or [Stack overflow](http://stackoverflow.com/questions/tagged/azure), or log a support call.</span></span> <span data-ttu-id="b6d14-166">Soyez prêt à partager le modèle et une vue des données de performance.</span><span class="sxs-lookup"><span data-stu-id="b6d14-166">Be prepared to share the template and a view of the performance data.</span></span>

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png
