---
title: "Comment configurer une application de proxy d’application pour utiliser la délégation Kerberos contrainte | Documents Microsoft"
description: "Comment configurer la délégation Kerberos contrainte pour une application de proxy d’application Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="80696-103">Comment configurer une application de proxy d’application pour utiliser la délégation Kerberos contrainte</span><span class="sxs-lookup"><span data-stu-id="80696-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="80696-104">Les méthodes permettant d’utiliser l’authentification SSO avec des applications publiées peuvent varier d’une application à une autre. Le proxy d’application Azure offre différentes solutions prêtes à l’emploi, notamment la délégation Kerberos contrainte (KCD, Kerberos Constrained Delegation).</span><span class="sxs-lookup"><span data-stu-id="80696-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="80696-105">Dans le cadre de cette solution, un hôte de connecteur est configuré pour effectuer une authentification Kerberos contrainte auprès des applications principales, pour le compte des utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="80696-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="80696-106">La procédure d’activation de KCD est relativement simple. Il suffit généralement d’une compréhension générale des différents composants et du flux d’authentification permettant l’authentification SSO.</span><span class="sxs-lookup"><span data-stu-id="80696-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="80696-107">Il peut être difficile de trouver de bonnes sources d’informations permettant de résoudre les scénarios où l’authentification SSO KCD ne fonctionne pas comme prévu.</span><span class="sxs-lookup"><span data-stu-id="80696-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="80696-108">Par conséquent, cet article a pour objet de fournir un point de référence unique qui peut aider à résoudre certains problèmes courants et permettre aux utilisateurs d’y remédier eux-mêmes.</span><span class="sxs-lookup"><span data-stu-id="80696-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="80696-109">Il offre également des conseils supplémentaires expliquant comment diagnostiquer les implémentations les plus complexes et les plus problématiques.</span><span class="sxs-lookup"><span data-stu-id="80696-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="80696-110">Notez que cet article repose sur les hypothèses suivantes :</span><span class="sxs-lookup"><span data-stu-id="80696-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="80696-111">Le proxy d’application Azure a été déployé conformément à notre [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable), et l’accès général aux applications non-KCD fonctionne comme prévu.</span><span class="sxs-lookup"><span data-stu-id="80696-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="80696-112">L’application cible publiée est basée sur IIS et l’implémentation de Kerberos de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="80696-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="80696-113">Les hôtes de serveur et d’application se trouvent dans un même domaine Active Directory.</span><span class="sxs-lookup"><span data-stu-id="80696-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="80696-114">Vous trouverez des informations détaillées sur les scénarios inter-domaines et inter-forêts dans notre [livre blanc sur KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="80696-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="80696-115">L’application concernée est publiée dans un client Azure pour lequel la pré-authentification est activée. Les utilisateurs doivent s’authentifier sur Azure par le biais de l’authentification basée sur les formulaires.</span><span class="sxs-lookup"><span data-stu-id="80696-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="80696-116">Les scénarios d’authentification cliente complète ne sont pas couverts par cet article. Ils seront ajoutés ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="80696-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="80696-117">Composants requis</span><span class="sxs-lookup"><span data-stu-id="80696-117">Prerequisites</span></span>

<span data-ttu-id="80696-118">Le proxy d’application Azure peut être déployé sur quasiment n’importe quel type d’environnement ou d’infrastructure. Les architectures varient naturellement d’une organisation à l’autre.</span><span class="sxs-lookup"><span data-stu-id="80696-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="80696-119">Les causes les plus courantes de problèmes liés à KCD ne portent pas sur les environnements eux-mêmes, mais plutôt sur de simples erreurs de configuration ou des négligences d’ordre général.</span><span class="sxs-lookup"><span data-stu-id="80696-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="80696-120">Par conséquent, nous vous recommandons de vérifier systématiquement que vous respectez toutes les conditions préalables figurant dans notre [article principal sur l’utilisation de l’authentification SSO KCD avec le proxy d’application](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) avant d’essayer de résoudre les problèmes.</span><span class="sxs-lookup"><span data-stu-id="80696-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="80696-121">Consultez notamment la section sur la configuration de KCD sur 2012 R2. En effet, il convient d’adopter une approche radicalement différente pour la configuration de KCD avec les versions précédentes de Windows, et ce, tout en tenant compte de plusieurs considérations :</span><span class="sxs-lookup"><span data-stu-id="80696-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="80696-122">Il n’est pas rare qu’un serveur membre de domaine ouvre une boîte de dialogue sur un canal sécurisé avec un contrôleur de domaine spécifique,</span><span class="sxs-lookup"><span data-stu-id="80696-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="80696-123">puis passe à une autre boîte de dialogue sans prévenir. Ainsi, en règle générale, les hôtes de connecteur ne doivent pas être limités à une communication avec des contrôleurs de domaine spécifique du site local.</span><span class="sxs-lookup"><span data-stu-id="80696-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="80696-124">De même, les scénarios inter-domaines s’appuient sur des références qui dirigent un hôte de connecteur vers des contrôleurs de domaine pouvant résider en dehors du périmètre du réseau local.</span><span class="sxs-lookup"><span data-stu-id="80696-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="80696-125">Dans ce scénario, il est tout aussi important de vous assurer que vous autorisez également le trafic vers les contrôleurs de domaine qui représentent d’autres domaines respectifs. Sinon, la délégation échouera.</span><span class="sxs-lookup"><span data-stu-id="80696-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="80696-126">Dans la mesure du possible, vous devez éviter de placer des appareils IPS/IDS actifs entre les hôtes de connecteur et les contrôleurs de domaine. En effet, ceux-ci sont parfois trop intrusifs et interfèrent avec le trafic RPC de base.</span><span class="sxs-lookup"><span data-stu-id="80696-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="80696-127">Si nous aimons tous résoudre les problèmes rapidement et efficacement, cela peut parfois prendre du temps. Par conséquent, vous devez essayer, autant que possible, de tester la délégation dans les scénarios les plus simples.</span><span class="sxs-lookup"><span data-stu-id="80696-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="80696-128">Plus vous introduisez de variables, plus augmentez le nombre d’éléments à prendre en compte.</span><span class="sxs-lookup"><span data-stu-id="80696-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="80696-129">Par exemple, en limitant vos tests à un seul connecteur, vous gagnerez un temps précieux. Vous pourrez ajouter d’autres connecteurs une fois les problèmes résolus.</span><span class="sxs-lookup"><span data-stu-id="80696-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="80696-130">Certains facteurs environnementaux peuvent également contribuer à un problème. Dans la mesure du possible, essayez de réduire l’architecture au strict minimum pour les tests.</span><span class="sxs-lookup"><span data-stu-id="80696-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="80696-131">Par exemple, les listes ACL de pare-feu internes ne sont pas toujours bien configurées. Ainsi, si cela est possible, autorisez tout le trafic issu d’un connecteur à transiter directement vers les contrôleurs de domaine et l’application principale.</span><span class="sxs-lookup"><span data-stu-id="80696-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="80696-132">En fait, les connecteurs doivent être positionnés le plus près possible de leurs cibles. Il s’agit là de leur meilleur emplacement.</span><span class="sxs-lookup"><span data-stu-id="80696-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="80696-133">La mise en place d’un pare-feu en ligne lors des tests ne fait qu’ajouter une complexité inutile et peut prolonger vos recherches.</span><span class="sxs-lookup"><span data-stu-id="80696-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="80696-134">Alors quels aspects caractérisent effectivement un problème avec KCD ?</span><span class="sxs-lookup"><span data-stu-id="80696-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="80696-135">On peut observer plusieurs indications classiques d’échec de l’authentification SSO KCD. Les premiers signes d’un problème se manifestent généralement dans le navigateur.</span><span class="sxs-lookup"><span data-stu-id="80696-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Erreur de configuration incorrecte de KCD](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Échec de l’autorisation en raison d’autorisations manquantes](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="80696-138">Ces erreurs entraînent toutes le même symptôme, à savoir l’échec de l’authentification SSO et, par conséquent, le refus de l’accès de l’utilisateur à l’application.</span><span class="sxs-lookup"><span data-stu-id="80696-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="80696-139">Résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="80696-139">Troubleshooting</span></span>

<span data-ttu-id="80696-140">Le mode de résolution varie selon le problème et les symptômes observés.</span><span class="sxs-lookup"><span data-stu-id="80696-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="80696-141">Avant d’aller plus loin, nous vous suggérons de consulter les liens suivants, qui offrent des informations utiles que vous ne connaissez peut-être pas déjà :</span><span class="sxs-lookup"><span data-stu-id="80696-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="80696-142">Résoudre les problèmes de proxy d’application et les messages d’erreur</span><span class="sxs-lookup"><span data-stu-id="80696-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="80696-143">Erreurs Kerberos</span><span class="sxs-lookup"><span data-stu-id="80696-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="80696-144">Utilisation de l’authentification unique quand des identités locales et sur le cloud ne sont pas identiques</span><span class="sxs-lookup"><span data-stu-id="80696-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="80696-145">Si vous en arrivez là, vous avez certainement affaire à un problème majeur.</span><span class="sxs-lookup"><span data-stu-id="80696-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="80696-146">Vous devez approfondir la question : commencez par séparer le flux en trois étapes distinctes pour résoudre chaque aspect.</span><span class="sxs-lookup"><span data-stu-id="80696-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="80696-147">**Pré-authentification du client** : l’utilisateur externe s’authentifiant sur Azure par le biais d’un navigateur.</span><span class="sxs-lookup"><span data-stu-id="80696-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="80696-148">L’authentification SSO KDC ne peut fonctionner que si la pré-authentification sur Azure est possible.</span><span class="sxs-lookup"><span data-stu-id="80696-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="80696-149">Cette possibilité doit être testée et tout problème doit être résolu en premier lieu.</span><span class="sxs-lookup"><span data-stu-id="80696-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="80696-150">Notez que l’étape de pré-authentification n’a aucun lien avec KCD ou l’application publiée.</span><span class="sxs-lookup"><span data-stu-id="80696-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="80696-151">Il doit être relativement simple de corriger les éventuelles incohérences en effectuant un contrôle de validité pour vérifier que le compte concerné existe dans Azure et qu’il n’est pas désactivé ou bloqué.</span><span class="sxs-lookup"><span data-stu-id="80696-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="80696-152">Le message d’erreur dans le navigateur est généralement suffisamment descriptif pour permettre l’identification de la cause.</span><span class="sxs-lookup"><span data-stu-id="80696-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="80696-153">Vous pouvez également consulter nos autres documents sur la résolution des problèmes en cas de doute.</span><span class="sxs-lookup"><span data-stu-id="80696-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="80696-154">**Service de délégation** : le connecteur de proxy Azure qui obtient un ticket de service Kerberos à partir d’un centre de distribution Kerberos (KDC, Kerberos Distribution Center) pour le compte d’utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="80696-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="80696-155">Les communications externes entre le client et le serveur frontal Azure ne devraient avoir aucune incidence sur KCD. Elles doivent uniquement permettre de vérifier qu’il fonctionne.</span><span class="sxs-lookup"><span data-stu-id="80696-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="80696-156">Ainsi, un identifiant utilisateur valide, qui sera utilisé pour l’obtention d’un ticket Kerberos, peut être fourni au service Azure Proxy.</span><span class="sxs-lookup"><span data-stu-id="80696-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="80696-157">Sans cela, la délégation KCD n’est pas possible et échouera.</span><span class="sxs-lookup"><span data-stu-id="80696-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="80696-158">Comme mentionné précédemment, les messages d’erreur du navigateur fournissent généralement de bonnes indications sur les raisons d’un échec.</span><span class="sxs-lookup"><span data-stu-id="80696-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="80696-159">Veillez à noter l’ID d’activité et l’horodatage fournis dans la réponse, car ils vous permettent de mettre en corrélation le comportement et les événements réels figurant dans le journal des événements Azure Proxy.</span><span class="sxs-lookup"><span data-stu-id="80696-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Erreur de configuration incorrecte de KCD](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="80696-161">Les entrées correspondantes du journal des événements apparaîtront comme événement 13019 ou 12027.</span><span class="sxs-lookup"><span data-stu-id="80696-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="80696-162">Vous trouverez les journaux des événements des connecteurs sous **Journaux des applications et des services** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connecteur**&gt;**Admin**.</span><span class="sxs-lookup"><span data-stu-id="80696-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Événement 13019 du journal des événements du proxy d’application](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Événement 12027 du journal des événements du proxy d’application](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="80696-165">Utilisez un enregistrement A dans votre DNS interne pour l’adresse de l’application et non un enregistrement CNAME.</span><span class="sxs-lookup"><span data-stu-id="80696-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="80696-166">Vérifiez de nouveau que l’hôte de connecteur a obtenu les droits nécessaires pour déléguer au SPN du compte cible désigné et que l’option **Utiliser tout protocole d’authentification** est sélectionnée.</span><span class="sxs-lookup"><span data-stu-id="80696-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="80696-167">Cet aspect est abordé dans notre [article principal sur la configuration de l’authentification SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).</span><span class="sxs-lookup"><span data-stu-id="80696-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="80696-168">Vérifiez qu’il n’existe qu’une seule instance du SPN dans Active Directory en émettant une commande **setspn - x** à partir d’une invite de commandes sur n’importe quel hôte membre du domaine.</span><span class="sxs-lookup"><span data-stu-id="80696-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="80696-169">Vérifiez si une stratégie de domaine est appliquée pour limiter la [taille maximale des jetons Kerberos émis](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/) car cela empêche le connecteur d’obtenir un jeton si la taille est excessive.</span><span class="sxs-lookup"><span data-stu-id="80696-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="80696-170">Pour obtenir d’autres informations de base sur les problèmes rencontrés, l’étape suivante consisterait à assurer un suivi réseau capturant les échanges entre l’hôte de connecteur et un KDC du domaine.</span><span class="sxs-lookup"><span data-stu-id="80696-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="80696-171">Pour cela, reportez-vous au [document sur la résolution approfondie des problèmes](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="80696-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="80696-172">Si la création de tickets semble correcte, un événement doit figurer dans les journaux, indiquant que l’authentification a échoué en raison du renvoi d’une erreur 401 par l’application.</span><span class="sxs-lookup"><span data-stu-id="80696-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="80696-173">Cela indique généralement que l’application cible rejette votre ticket. Dans ce cas, passez à l’étape suivante.</span><span class="sxs-lookup"><span data-stu-id="80696-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="80696-174">**Application cible** : le consommateur du ticket Kerberos fourni par le connecteur</span><span class="sxs-lookup"><span data-stu-id="80696-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="80696-175">À ce stade, le connecteur doit avoir envoyé un ticket de service Kerberos au serveur principal, en tant qu’en-tête de la première demande de l’application.</span><span class="sxs-lookup"><span data-stu-id="80696-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="80696-176">À l’aide de l’URL interne de l’application défini dans le portail, vérifiez que l’application est directement accessible à partir du navigateur sur l’hôte de connecteur.</span><span class="sxs-lookup"><span data-stu-id="80696-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="80696-177">Vous pouvez alors vous connecter.</span><span class="sxs-lookup"><span data-stu-id="80696-177">Then you can login successfully.</span></span> <span data-ttu-id="80696-178">Pour plus d’informations à ce sujet, reportez-vous à la page sur la résolution des problèmes de connecteur.</span><span class="sxs-lookup"><span data-stu-id="80696-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="80696-179">Toujours sur l’hôte de connecteur, vérifiez que l’authentification entre le navigateur et l’application se fait à l’aide de Kerberos de l’une des façons suivantes :</span><span class="sxs-lookup"><span data-stu-id="80696-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="80696-180">Exécutez les outils de développement (**F12**) dans Internet Explorer, ou utilisez [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) à partir de l’hôte de connecteur.</span><span class="sxs-lookup"><span data-stu-id="80696-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="80696-181">Accédez à l’application à l’aide de l’URL interne et examinez les en-têtes d’autorisation WWW retournés dans la réponse de l’application pour vous assurer que Negotiate ou Kerberos est mentionné.</span><span class="sxs-lookup"><span data-stu-id="80696-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="80696-182">Un blob Kerberos retourné à la suite dans la réponse du navigateur à l’application commence généralement par **YII**. Il s’agit d’une bonne indication de l’intervention de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="80696-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="80696-183">En revanche, NTLM commence toujours par **TlRMTVNTUAAB**, soit NTLMSSP lors d’un décodage à partir de Base64.</span><span class="sxs-lookup"><span data-stu-id="80696-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="80696-184">Si **TlRMTVNTUAAB** figure au début du blob, cela indique que Kerberos n’est **pas** disponible.</span><span class="sxs-lookup"><span data-stu-id="80696-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="80696-185">Dans le cas contraire, Kerberos est probablement disponible.</span><span class="sxs-lookup"><span data-stu-id="80696-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="80696-186">Si vous utilisez Fiddler, notez que cette méthode nécessite de désactiver temporairement la protection étendue dans la configuration de l’application dans IIS.</span><span class="sxs-lookup"><span data-stu-id="80696-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Fenêtre de contrôle de réseau du navigateur](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="80696-188">*Illustration :* dans cet exemple, comme le blob ne commence pas par TIRMTVNTUAAB, Kerberos est disponible.</span><span class="sxs-lookup"><span data-stu-id="80696-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="80696-189">Cet exemple montre un blob Kerberos qui ne commence pas par YII.</span><span class="sxs-lookup"><span data-stu-id="80696-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="80696-190">Supprimez temporairement NTLM de la liste de fournisseurs sur le site IIS, et accédez à l’application directement à partir d’Internet Explorer sur l’hôte de connecteur.</span><span class="sxs-lookup"><span data-stu-id="80696-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="80696-191">NTLM ne figurant plus dans la liste des fournisseurs, vous devez être en mesure d’accéder à l’application uniquement à l’aide de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="80696-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="80696-192">Si l’accès échoue, cela indique un problème avec la configuration de l’application. L’authentification Kerberos ne fonctionne donc pas.</span><span class="sxs-lookup"><span data-stu-id="80696-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="80696-193">Si Kerberos n’est pas disponible, vérifiez les paramètres d’authentification de l’application dans IIS pour vous assurer que Negotiate apparaît tout en haut avec NTLM juste en dessous.</span><span class="sxs-lookup"><span data-stu-id="80696-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="80696-194">(Vous ne devez pas voir Negotiate:kerberos ou Negotiate:PKU2U).</span><span class="sxs-lookup"><span data-stu-id="80696-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="80696-195">Continuez uniquement si Kerberos est fonctionnel.</span><span class="sxs-lookup"><span data-stu-id="80696-195">Only continue if Kerberos is functional.</span></span>

   ![Fournisseurs d’authentification Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="80696-197">Kerberos et NTLM étant en place, nous allons désactiver temporairement la pré-authentification pour l’application dans le portail.</span><span class="sxs-lookup"><span data-stu-id="80696-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="80696-198">Essayez d’y accéder sur Internet à l’aide de l’URL externe.</span><span class="sxs-lookup"><span data-stu-id="80696-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="80696-199">Vous devez être invité à vous authentifier et devez être en mesure de le faire avec le même compte que celui utilisé à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="80696-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="80696-200">Si ce n’est pas le cas, cela indique un problème avec l’application principale et non avec KCD.</span><span class="sxs-lookup"><span data-stu-id="80696-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="80696-201">Maintenant, réactivez la pré-authentification dans le portail et authentifiez-vous sur Azure en essayant de vous connecter à l’application à l’aide de son URL externe.</span><span class="sxs-lookup"><span data-stu-id="80696-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="80696-202">Si l’authentification SSO a échoué, vous devez voir un message d’interdiction dans le navigateur, ainsi que l’événement 13022 dans le journal :</span><span class="sxs-lookup"><span data-stu-id="80696-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="80696-203">*Le connecteur de proxy d’application Microsoft AAD ne peut pas authentifier l’utilisateur, car le serveur principal répond aux tentatives d’authentification Kerberos avec une erreur HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="80696-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Message d’interdiction HTTP 401](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="80696-205">Vérifiez l’application IIS pour vous assurer que le pool d’applications est configuré pour utiliser le même compte que le celui configuré pour le SPN dans Active Directory, comme illustré ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="80696-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Fenêtre de configuration d’application IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="80696-207">Une fois que vous connaissez l’identité, émettez la commande suivante à partir d’une invite de commandes pour vous assurer que ce compte est bien configuré avec le SPN en question.</span><span class="sxs-lookup"><span data-stu-id="80696-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="80696-208">Par exemple, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="80696-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Fenêtre de commandes SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="80696-210">Vérifiez que le SPN défini par rapport aux paramètres de l’application dans le portail est le même que celui configuré pour le compte AD cible utilisé par le pool d’applications de l’application.</span><span class="sxs-lookup"><span data-stu-id="80696-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Configuration du SPN dans le Portail Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="80696-212">Accédez à IIS et sélectionnez l’option **Éditeur de configuration** pour l’application. Puis, accédez à **system.webServer/security/authentication/windowsAuthentication** pour vous assurer que **UseAppPoolCredentials** a la valeur true.</span><span class="sxs-lookup"><span data-stu-id="80696-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Option de configuration IIS - informations d’identification des pools d’applications](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="80696-214">Garder le mode noyau activé s’avère utile pour améliorer les performances des opérations Kerberos. Cependant, dans ce cas, le ticket pour le service demandé sera déchiffré à l’aide du compte d’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="80696-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="80696-215">On parle également de système local. Ainsi, en cas de définition sur true, KCD est arrêté lorsque l’application est hébergée sur plusieurs serveurs au sein d’une batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="80696-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="80696-216">Pour effectuer une vérification supplémentaire, vous pouvez également désactiver la **protection étendue**.</span><span class="sxs-lookup"><span data-stu-id="80696-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="80696-217">Dans certains scénarios où elle est activée dans des configurations très spécifiques, on a pu observer l’arrêt de KCD lorsqu’une application est publiée en tant que sous-dossier du site web par défaut.</span><span class="sxs-lookup"><span data-stu-id="80696-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="80696-218">Celui-ci est configuré pour une authentification anonyme uniquement. Ainsi, les boîtes de dialogue sont totalement grisées, suggérant que les objets enfants n’hériteront d’aucun paramètre actif.</span><span class="sxs-lookup"><span data-stu-id="80696-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="80696-219">Cependant, dans la mesure du possible, nous recommandons de l’activer systématiquement. Donc, quels que soient vos modes de test, n’oubliez pas de la réactiver.</span><span class="sxs-lookup"><span data-stu-id="80696-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="80696-220">Ces vérifications supplémentaires devraient vous mettre sur la bonne voie pour commencer à utiliser votre application publiée.</span><span class="sxs-lookup"><span data-stu-id="80696-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="80696-221">Vous pouvez continuer et ajouter d’autres connecteurs également configurés pour la délégation, mais si les choses n’avancent pas, nous vous suggérons la lecture de notre [guide complet pour résoudre les problèmes de proxy d’application Azure AD](https://aka.ms/proxytshootpaper), qui vous offrira une présentation technique plus approfondie.</span><span class="sxs-lookup"><span data-stu-id="80696-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="80696-222">Si vous ne progressez toujours pas dans la résolution de votre problème, adressez-vous au support. L’équipe sera ravie de vous assister et de vous accompagner.</span><span class="sxs-lookup"><span data-stu-id="80696-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="80696-223">Créez un ticket de support directement dans le portail. Nos ingénieurs prendront contact avec vous.</span><span class="sxs-lookup"><span data-stu-id="80696-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="80696-224">Autres scénarios</span><span class="sxs-lookup"><span data-stu-id="80696-224">Other scenarios</span></span>

-   <span data-ttu-id="80696-225">Le proxy d’application Azure demande un ticket Kerberos avant d’envoyer sa demande à une application.</span><span class="sxs-lookup"><span data-stu-id="80696-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="80696-226">Certaines applications tierces comme Tableau Server ne privilégient pas cette méthode d’authentification et attendent des négociations plus classiques.</span><span class="sxs-lookup"><span data-stu-id="80696-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="80696-227">La première demande est anonyme, permettant à l’application de répondre avec les types d’authentification qu’elle prend en charge avec une erreur 401.</span><span class="sxs-lookup"><span data-stu-id="80696-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="80696-228">Authentification à deux tronçons : couramment utilisée dans les scénarios où une application est hiérarchisée, avec un serveur principal et un serveur frontal requérant tous deux une authentification comme les services SQL Reporting.</span><span class="sxs-lookup"><span data-stu-id="80696-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="80696-229">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="80696-229">Next steps</span></span>
[<span data-ttu-id="80696-230">Configurer la délégation Kerberos contrainte (KCD) sur un domaine géré</span><span class="sxs-lookup"><span data-stu-id="80696-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
