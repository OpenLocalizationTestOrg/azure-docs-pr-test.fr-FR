---
title: "Azure AD Connect : Comment récupérer de la limite de 10 Go de base de données locale | Microsoft Docs"
description: "Cette rubrique décrit comment récupérer le service de synchronisation Azure AD Connect lorsque celui-ci rencontre un problème lié à la limite de 10 Go de base de données locale."
services: active-directory
documentationcenter: 
author: cychua
manager: femila
editor: 
ms.assetid: 41d081af-ed89-4e17-be34-14f7e80ae358
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/17/2017
ms.author: billmath
ms.openlocfilehash: 08e682c51b12d4506019d2f6b68e1eae0798b990
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="azure-ad-connect-how-to-recover-from-localdb-10-gb-limit"></a><span data-ttu-id="ede86-103">Azure AD Connect : Comment récupérer de la limite de 10 Go de base de données locale</span><span class="sxs-lookup"><span data-stu-id="ede86-103">Azure AD Connect: How to recover from LocalDB 10-GB limit</span></span>
<span data-ttu-id="ede86-104">Azure AD Connect nécessite une base de données SQL Server pour stocker les données d’identité.</span><span class="sxs-lookup"><span data-stu-id="ede86-104">Azure AD Connect requires a SQL Server database to store identity data.</span></span> <span data-ttu-id="ede86-105">Vous pouvez utiliser la base de données locale par défaut de SQL Server 2012 installée avec Azure AD Connect ou utiliser votre propre base de données SQL complète.</span><span class="sxs-lookup"><span data-stu-id="ede86-105">You can either use the default SQL Server 2012 Express LocalDB installed with Azure AD Connect or use your own full SQL.</span></span> <span data-ttu-id="ede86-106">SQL Server Express impose une limite de taille de 10 Go.</span><span class="sxs-lookup"><span data-stu-id="ede86-106">SQL Server Express imposes a 10-GB size limit.</span></span> <span data-ttu-id="ede86-107">Lorsque vous utilisez la base de données locale et que cette limite est atteinte, le service de synchronisation Azure AD Connect ne peut plus démarrer ou se synchroniser correctement.</span><span class="sxs-lookup"><span data-stu-id="ede86-107">When using LocalDB and this limit is reached, Azure AD Connect Synchronization Service can no longer start or synchronize properly.</span></span> <span data-ttu-id="ede86-108">Cet article indique les étapes de récupération.</span><span class="sxs-lookup"><span data-stu-id="ede86-108">This article provides the recovery steps.</span></span>

## <a name="symptoms"></a><span data-ttu-id="ede86-109">Symptômes</span><span class="sxs-lookup"><span data-stu-id="ede86-109">Symptoms</span></span>
<span data-ttu-id="ede86-110">Il existe deux symptômes courants :</span><span class="sxs-lookup"><span data-stu-id="ede86-110">There are two common symptoms:</span></span>

* <span data-ttu-id="ede86-111">Le service de synchronisation Azure AD Connect **est en cours d’exécution** mais ne parvient pas à se synchroniser avec l’erreur *stopped-database-disk-full*.</span><span class="sxs-lookup"><span data-stu-id="ede86-111">Azure AD Connect Synchronization Service **is running** but fails to synchronize with *“stopped-database-disk-full”* error.</span></span>

* <span data-ttu-id="ede86-112">Le service de synchronisation Azure AD Connect **ne peut pas démarrer**.</span><span class="sxs-lookup"><span data-stu-id="ede86-112">Azure AD Connect Synchronization Service **is unable to start**.</span></span> <span data-ttu-id="ede86-113">Lorsque vous tentez de démarrer le service, celui-ci échoue avec l’événement 6323 et le message d’erreur *Le serveur a rencontré une erreur en raison d’un manque d’espace disque pour SQL Server*.</span><span class="sxs-lookup"><span data-stu-id="ede86-113">When you attempt to start the service, it fails with event 6323 and error message *"The server encountered an error because SQL Server is out of disk space."*</span></span>

## <a name="short-term-recovery-steps"></a><span data-ttu-id="ede86-114">Étapes de récupération à court terme</span><span class="sxs-lookup"><span data-stu-id="ede86-114">Short-term recovery steps</span></span>
<span data-ttu-id="ede86-115">Cette section indique les étapes permettant de récupérer de l’espace de base de données requis pour que le service de synchronisation Azure AD Connect puisse reprendre l’opération.</span><span class="sxs-lookup"><span data-stu-id="ede86-115">This section provides the steps to reclaim DB space required for Azure AD Connect Synchronization Service to resume operation.</span></span> <span data-ttu-id="ede86-116">Procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="ede86-116">The steps include:</span></span>
1. [<span data-ttu-id="ede86-117">Déterminer l’état du service de synchronisation</span><span class="sxs-lookup"><span data-stu-id="ede86-117">Determine the Synchronization Service status</span></span>](#determine-the-synchronization-service-status)
2. [<span data-ttu-id="ede86-118">Réduire la base de données</span><span class="sxs-lookup"><span data-stu-id="ede86-118">Shrink the database</span></span>](#shrink-the-database)
3. [<span data-ttu-id="ede86-119">Supprimer les données d’historique d’exécution</span><span class="sxs-lookup"><span data-stu-id="ede86-119">Delete run history data</span></span>](#delete-run-history-data)
4. [<span data-ttu-id="ede86-120">Réduire la période de rétention des données d’historique d’exécution</span><span class="sxs-lookup"><span data-stu-id="ede86-120">Shorten retention period for run history data</span></span>](#shorten-retention-period-for-run-history-data)

### <a name="determine-the-synchronization-service-status"></a><span data-ttu-id="ede86-121">Déterminer l’état du service de synchronisation</span><span class="sxs-lookup"><span data-stu-id="ede86-121">Determine the Synchronization Service status</span></span>
<span data-ttu-id="ede86-122">Tout d’abord, déterminez si le service de synchronisation est en cours d’exécution ou non :</span><span class="sxs-lookup"><span data-stu-id="ede86-122">First, determine whether the Synchronization Service is still running or not:</span></span>

1. <span data-ttu-id="ede86-123">Connectez-vous à votre serveur Azure AD Connect en tant qu’administrateur.</span><span class="sxs-lookup"><span data-stu-id="ede86-123">Log in to your Azure AD Connect server as administrator.</span></span>

2. <span data-ttu-id="ede86-124">Accédez à **Gestionnaire de contrôle des services**.</span><span class="sxs-lookup"><span data-stu-id="ede86-124">Go to **Service Control Manager**.</span></span>

3. <span data-ttu-id="ede86-125">Vérifiez l’état de **Microsoft Azure AD Sync**.</span><span class="sxs-lookup"><span data-stu-id="ede86-125">Check the status of **Microsoft Azure AD Sync**.</span></span>


4. <span data-ttu-id="ede86-126">Si le service est en cours d’exécution, n’arrêtez pas ou ne redémarrez pas le service.</span><span class="sxs-lookup"><span data-stu-id="ede86-126">If it is running, do not stop or restart the service.</span></span> <span data-ttu-id="ede86-127">Ignorez l’étape [Réduire la base de données](#shrink-the-database) et passez à l’étape [Supprimer les données d’historique d’exécution](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="ede86-127">Skip [Shrink the database](#shrink-the-database) step and go to [Delete run history data](#delete-run-history-data) step.</span></span>

5. <span data-ttu-id="ede86-128">Si le service n’est pas en cours d’exécution, essayez de le démarrer.</span><span class="sxs-lookup"><span data-stu-id="ede86-128">If it is not running, try to start the service.</span></span> <span data-ttu-id="ede86-129">Si le service démarre, ignorez l’étape [Réduire la base de données](#shrink-the-database) et passez à l’étape [Supprimer les données d’historique d’exécution](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="ede86-129">If the service starts successfully, skip [Shrink the database](#shrink-the-database) step and go to [Delete run history data](#delete-run-history-data) step.</span></span> <span data-ttu-id="ede86-130">Dans le cas contraire, passez à l’étape [Réduire la base de données](#shrink-the-database).</span><span class="sxs-lookup"><span data-stu-id="ede86-130">Otherwise, continue with [Shrink the database](#shrink-the-database) step.</span></span>

### <a name="shrink-the-database"></a><span data-ttu-id="ede86-131">Réduire la base de données</span><span class="sxs-lookup"><span data-stu-id="ede86-131">Shrink the database</span></span>
<span data-ttu-id="ede86-132">Utilisez l’opération de réduction pour libérer suffisamment d’espace dans la base de données pour démarrer le service de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="ede86-132">Use the Shrink operation to free up enough DB space to start the Synchronization Service.</span></span> <span data-ttu-id="ede86-133">Cette opération libère de l’espace dans la base de données en supprimant les espaces blancs.</span><span class="sxs-lookup"><span data-stu-id="ede86-133">It frees up DB space by removing whitespaces in the database.</span></span> <span data-ttu-id="ede86-134">Il s’agit de l’étape recommandée, mais elle ne constitue pas la garantie que vous pouvez toujours récupérer de l’espace.</span><span class="sxs-lookup"><span data-stu-id="ede86-134">This step is best-effort as it is not guaranteed that you can always recover space.</span></span> <span data-ttu-id="ede86-135">Pour en savoir plus sur l’opération de réduction, lisez l’article [Réduire une base de données](https://msdn.microsoft.com/library/ms189035.aspx).</span><span class="sxs-lookup"><span data-stu-id="ede86-135">To learn more about Shrink operation, read this article [Shrink a database](https://msdn.microsoft.com/library/ms189035.aspx).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ede86-136">Ignorez cette étape si vous pouvez faire en sorte que le service de synchronisation s’exécute.</span><span class="sxs-lookup"><span data-stu-id="ede86-136">Skip this step if you can get the Synchronization Service to run.</span></span> <span data-ttu-id="ede86-137">Il est déconseillé de réduire la base de données SQL, car cela peut entraîner une baisse des performances en raison d’une fragmentation accrue.</span><span class="sxs-lookup"><span data-stu-id="ede86-137">It is not recommended to shrink the SQL DB as it can lead to poor performance due to increased fragmentation.</span></span>

<span data-ttu-id="ede86-138">Le nom de la base de données créée pour Azure AD Connect est **ADSync**.</span><span class="sxs-lookup"><span data-stu-id="ede86-138">The name of the database created for Azure AD Connect is **ADSync**.</span></span> <span data-ttu-id="ede86-139">Pour effectuer une opération de réduction, vous devez vous connecter en tant que sysadmin ou propriétaire de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ede86-139">To perform a Shrink operation, you must log in either as the sysadmin or DBO of the database.</span></span> <span data-ttu-id="ede86-140">Lors de l’installation d’Azure AD Connect, les comptes suivants disposent de droits d’administrateur système :</span><span class="sxs-lookup"><span data-stu-id="ede86-140">During Azure AD Connect installation, the following accounts are granted sysadmin rights:</span></span>
* <span data-ttu-id="ede86-141">Administrateurs locaux</span><span class="sxs-lookup"><span data-stu-id="ede86-141">Local Administrators</span></span>
* <span data-ttu-id="ede86-142">Compte d’utilisateur qui a été utilisé pour exécuter l’installation d’Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="ede86-142">The user account that was used to run Azure AD Connect installation.</span></span>
* <span data-ttu-id="ede86-143">Compte de service de synchronisation qui est utilisé comme contexte d’opération du service de synchronisation Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="ede86-143">The Sync Service account that is used as the operating context of Azure AD Connect Synchronization Service.</span></span>
* <span data-ttu-id="ede86-144">Groupe local ADSyncAdmins créé pendant l’installation.</span><span class="sxs-lookup"><span data-stu-id="ede86-144">The local group ADSyncAdmins that was created during installation.</span></span>

1. <span data-ttu-id="ede86-145">Sauvegardez la base de données en copiant les fichiers **ADSync.mdf** et **ADSync_log.ldf** situés sous `%ProgramFiles%\program files\Microsoft Azure AD Sync\Data` dans un emplacement sûr.</span><span class="sxs-lookup"><span data-stu-id="ede86-145">Back up the database by copying **ADSync.mdf** and **ADSync_log.ldf** files located under `%ProgramFiles%\program files\Microsoft Azure AD Sync\Data` to a safe location.</span></span>

2. <span data-ttu-id="ede86-146">Démarrez une nouvelle session PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ede86-146">Start a new PowerShell session.</span></span>

3. <span data-ttu-id="ede86-147">Accédez au dossier `%ProgramFiles%\Program Files\Microsoft SQL Server\110\Tools\Binn`.</span><span class="sxs-lookup"><span data-stu-id="ede86-147">Navigate to folder `%ProgramFiles%\Program Files\Microsoft SQL Server\110\Tools\Binn`.</span></span>

4. <span data-ttu-id="ede86-148">Démarrez l’utilitaire **sqlcmd** en exécutant la commande `./SQLCMD.EXE -S “(localdb)\.\ADSync” -U <Username> -P <Password>`, à l’aide des informations d’identification de l’administrateur système ou du propriétaire de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ede86-148">Start **sqlcmd** utility by running the command `./SQLCMD.EXE -S “(localdb)\.\ADSync” -U <Username> -P <Password>`, using the credential of a sysadmin or the database DBO.</span></span>

5. <span data-ttu-id="ede86-149">Pour réduire la base de données, à l’invite sqlcmd (1>), entrez `DBCC Shrinkdatabase(ADSync,1);` suivi par `GO` dans la ligne suivante.</span><span class="sxs-lookup"><span data-stu-id="ede86-149">To shrink the database, at the sqlcmd prompt (1>), enter `DBCC Shrinkdatabase(ADSync,1);`, followed by `GO` in the next line.</span></span>

6. <span data-ttu-id="ede86-150">Si l’opération réussit, essayez de redémarrer le service de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="ede86-150">If the operation is successful, try to start the Synchronization Service again.</span></span> <span data-ttu-id="ede86-151">Si vous pouvez démarrer le service de synchronisation, passez à l’étape [Supprimer les données d’historique d’exécution](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="ede86-151">If you can start the Synchronization Service, go to [Delete run history data](#delete-run-history-data) step.</span></span> <span data-ttu-id="ede86-152">Sinon, contactez le support.</span><span class="sxs-lookup"><span data-stu-id="ede86-152">If not, contact Support.</span></span>

### <a name="delete-run-history-data"></a><span data-ttu-id="ede86-153">Supprimer les données d’historique d’exécution</span><span class="sxs-lookup"><span data-stu-id="ede86-153">Delete run history data</span></span>
<span data-ttu-id="ede86-154">Par défaut, Azure AD Connect conserve jusqu’à sept jours les données d’historique d’exécution.</span><span class="sxs-lookup"><span data-stu-id="ede86-154">By default, Azure AD Connect retains up to seven days’ worth of run history data.</span></span> <span data-ttu-id="ede86-155">Dans cette étape, vous allez supprimer les données d’historique d’exécution pour récupérer de l’espace dans la base de données afin que le service de synchronisation Azure AD Connect puisse recommencer la synchronisation.</span><span class="sxs-lookup"><span data-stu-id="ede86-155">In this step, we delete the run history data to reclaim DB space so that Azure AD Connect Synchronization Service can start syncing again.</span></span>

1.  <span data-ttu-id="ede86-156">Démarrez **Synchronization Service Manager** en accédant au menu DÉMARRER → Service de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="ede86-156">Start **Synchronization Service Manager** by going to START → Synchronization Service.</span></span>

2.  <span data-ttu-id="ede86-157">Accédez à l’onglet **Opérations**.</span><span class="sxs-lookup"><span data-stu-id="ede86-157">Go to the **Operations** tab.</span></span>

3.  <span data-ttu-id="ede86-158">Sous **Actions**, sélectionnez **Clear Runs... (Effacer les exécutions)**.</span><span class="sxs-lookup"><span data-stu-id="ede86-158">Under **Actions**, select **Clear Runs**…</span></span>

4.  <span data-ttu-id="ede86-159">Vous pouvez choisir l’option **Clear all runs (Effacer toutes les exécutions)** ou **Clear runs before… (Effacer les exécutions avant)<date>**.</span><span class="sxs-lookup"><span data-stu-id="ede86-159">You can either choose **Clear all runs** or **Clear runs before… <date>** option.</span></span> <span data-ttu-id="ede86-160">Il est recommandé de commencer par désactiver les données d’historique d’exécution présentes depuis plus de deux jours.</span><span class="sxs-lookup"><span data-stu-id="ede86-160">It is recommended that you start by clearing run history data that are older than two days.</span></span> <span data-ttu-id="ede86-161">Si vous continuez à rencontrer le problème de taille de base de données, choisissez l’option **Clear all runs (Effacer toutes les exécutions)**.</span><span class="sxs-lookup"><span data-stu-id="ede86-161">If you continue to run into DB size issue, then choose the **Clear all runs** option.</span></span>

### <a name="shorten-retention-period-for-run-history-data"></a><span data-ttu-id="ede86-162">Réduire la période de rétention des données d’historique d’exécution</span><span class="sxs-lookup"><span data-stu-id="ede86-162">Shorten retention period for run history data</span></span>
<span data-ttu-id="ede86-163">Cette étape consiste à réduire la probabilité de rencontrer le problème de limite de 10 Go après plusieurs cycles de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="ede86-163">This step is to reduce the likelihood of running into the 10-GB limit issue after multiple sync cycles.</span></span>

1. <span data-ttu-id="ede86-164">Ouvrez une nouvelle session PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ede86-164">Open a new PowerShell session.</span></span>

2. <span data-ttu-id="ede86-165">Exécutez `Get-ADSyncScheduler` et prenez note de la propriété PurgeRunHistoryInterval, qui indique la période de rétention actuelle.</span><span class="sxs-lookup"><span data-stu-id="ede86-165">Run `Get-ADSyncScheduler` and take note of the PurgeRunHistoryInterval property, which specifies the current retention period.</span></span>

3. <span data-ttu-id="ede86-166">Exécutez `Set-ADSyncScheduler -PurgeRunHistoryInterval 2.00:00:00` pour définir une période de rétention de deux jours.</span><span class="sxs-lookup"><span data-stu-id="ede86-166">Run `Set-ADSyncScheduler -PurgeRunHistoryInterval 2.00:00:00` to set the retention period to two days.</span></span> <span data-ttu-id="ede86-167">Ajustez la période de rétention selon le cas.</span><span class="sxs-lookup"><span data-stu-id="ede86-167">Adjust the retention period as appropriate.</span></span>

## <a name="long-term-solution--migrate-to-full-sql"></a><span data-ttu-id="ede86-168">Solution à long terme : migrer vers une base de données SQL complète</span><span class="sxs-lookup"><span data-stu-id="ede86-168">Long-term solution – Migrate to full SQL</span></span>
<span data-ttu-id="ede86-169">En général, ce problème indique que la taille de base de données de 10 Go n’est plus suffisante pour qu’Azure AD Connect synchronise votre annuaire Active Directory local sur Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ede86-169">In general, the issue is indicative that 10-GB database size is no longer sufficient for Azure AD Connect to synchronize your on-premises Active Directory to Azure AD.</span></span> <span data-ttu-id="ede86-170">Nous vous recommandons de passer à la version complète de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ede86-170">It is recommended that you switch to using the full version of SQL server.</span></span> <span data-ttu-id="ede86-171">Vous ne pouvez pas remplacer directement la base de données locale d’un déploiement Azure AD Connect existant par la base de données de la version complète de SQL.</span><span class="sxs-lookup"><span data-stu-id="ede86-171">You cannot directly replace the LocalDB of an existing Azure AD Connect deployment with the database of the full version of SQL.</span></span> <span data-ttu-id="ede86-172">Au lieu de cela, vous devez déployer un nouveau serveur Azure AD Connect avec la version complète de SQL.</span><span class="sxs-lookup"><span data-stu-id="ede86-172">Instead, you must deploy a new Azure AD Connect server with the full version of SQL.</span></span> <span data-ttu-id="ede86-173">Nous vous recommandons d’effectuer une migration de basculement dans laquelle le nouveau serveur Azure AD Connect (avec la base de données SQL) est déployé comme serveur intermédiaire à côté du serveur Azure AD Connect existant (avec la base de données locale).</span><span class="sxs-lookup"><span data-stu-id="ede86-173">It is recommended that you do a swing migration where the new Azure AD Connect server (with SQL DB) is deployed as a staging server, next to the existing Azure AD Connect server (with LocalDB).</span></span> 
* <span data-ttu-id="ede86-174">Pour obtenir des instructions sur la configuration à distance de SQL avec Azure AD Connect, consultez l’article [Installation personnalisée d’Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-get-started-custom).</span><span class="sxs-lookup"><span data-stu-id="ede86-174">For instruction on how to configure remote SQL with Azure AD Connect, refer to article [Custom installation of Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-get-started-custom).</span></span>
* <span data-ttu-id="ede86-175">Pour obtenir des instructions sur la migration de basculement pour la mise à niveau d’Azure AD Connect, consultez l’article [Azure AD Connect : effectuer une mise à niveau vers la dernière version](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version#swing-migration).</span><span class="sxs-lookup"><span data-stu-id="ede86-175">For instructions on swing migration for Azure AD Connect upgrade, refer to article [Azure AD Connect: Upgrade from a previous version to the latest](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version#swing-migration).</span></span>

## <a name="next-steps"></a><span data-ttu-id="ede86-176">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="ede86-176">Next steps</span></span>
<span data-ttu-id="ede86-177">En savoir plus sur l’ [intégration de vos identités locales avec Azure Active Directory](active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="ede86-177">Learn more about [Integrating your on-premises identities with Azure Active Directory](active-directory-aadconnect.md).</span></span>
