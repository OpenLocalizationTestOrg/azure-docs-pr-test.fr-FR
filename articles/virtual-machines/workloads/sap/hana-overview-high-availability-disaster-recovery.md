---
title: "Haute disponibilité et récupération d’urgence de SAP HANA sur Azure (grandes instances) | Microsoft Docs"
description: "Établissez la haute disponibilité et planifiez la récupération d’urgence de SAP HANA sur Azure (grandes instances)."
services: virtual-machines-linux
documentationcenter: 
author: RicksterCDN
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/01/2016
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f95e944fc3ec3a831d97386443eb644420ae54dc
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="sap-hana-large-instances-high-availability-and-disaster-recovery-on-azure"></a><span data-ttu-id="89625-103">Haute disponibilité et récupération d’urgence de SAP HANA (grandes instances) sur Azure</span><span class="sxs-lookup"><span data-stu-id="89625-103">SAP HANA (large instances) high availability and disaster recovery on Azure</span></span> 

<span data-ttu-id="89625-104">La haute disponibilité et la récupération d’urgence constituent des aspects fondamentaux de l’exécution de vos serveurs SAP HANA sur Azure (grandes instances) stratégiques.</span><span class="sxs-lookup"><span data-stu-id="89625-104">High availability and disaster recovery are important aspects of running your mission-critical SAP HANA on Azure (large instances) servers.</span></span> <span data-ttu-id="89625-105">Il est important que vous collaboriez avec SAP, votre intégrateur de systèmes ou Microsoft pour concevoir et implémenter efficacement la stratégie de haute disponibilité/récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-105">It's important to work with SAP, your system integrator, or Microsoft to properly architect and implement the right high-availability/disaster-recovery strategy.</span></span> <span data-ttu-id="89625-106">Il est également important de tenir compte de l’objectif de point de récupération et de l’objectif de délai de récupération, qui sont spécifiques à votre environnement.</span><span class="sxs-lookup"><span data-stu-id="89625-106">It is also important to consider the recovery point objective and recovery time objective, which are specific to your environment.</span></span>

## <a name="high-availability"></a><span data-ttu-id="89625-107">Haute disponibilité</span><span class="sxs-lookup"><span data-stu-id="89625-107">High availability</span></span>

<span data-ttu-id="89625-108">Microsoft prend en charge les méthodes de haute disponibilité prêtes à l’emploi de SAP HANA, qui sont décrites ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="89625-108">Microsoft supports SAP HANA high-availability methods "out of the box," which include:</span></span>

- <span data-ttu-id="89625-109">**Réplication du stockage :** capacité du système de stockage à répliquer lui-même toutes les données à un autre emplacement (dans le même centre de données ou séparément de ce dernier).</span><span class="sxs-lookup"><span data-stu-id="89625-109">**Storage replication:** The storage system's ability to replicate all data to another location (within, or separate from, the same datacenter).</span></span> <span data-ttu-id="89625-110">SAP HANA opère indépendamment de cette méthode.</span><span class="sxs-lookup"><span data-stu-id="89625-110">SAP HANA operates independently of this method.</span></span>
- <span data-ttu-id="89625-111">**Réplication du système HANA :** réplication de toutes les données de SAP HANA sur un autre système SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-111">**HANA system replication:** The replication of all data in SAP HANA to a separate SAP HANA system.</span></span> <span data-ttu-id="89625-112">L’objectif de délai de récupération est réduit grâce à une réplication des données à intervalles réguliers.</span><span class="sxs-lookup"><span data-stu-id="89625-112">The recovery time objective is minimized through data replication at regular intervals.</span></span> <span data-ttu-id="89625-113">SAP HANA prend en charge les modes asynchrone, synchrone en mémoire et synchrone (uniquement recommandé pour les systèmes SAP HANA situés dans le même centre de données ou à moins de 100 km de distance).</span><span class="sxs-lookup"><span data-stu-id="89625-113">SAP HANA supports asynchronous, synchronous in-memory, and synchronous modes (recommended only for SAP HANA systems that are within the same datacenter or less than 100 KM apart).</span></span> <span data-ttu-id="89625-114">Dans la conception actuelle des horodatages de grande instance HANA, la réplication de système HANA peut être utilisée uniquement pour garantir la haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="89625-114">In the current design of HANA large-instance stamps, HANA system replication can be used for high availability only.</span></span>
- <span data-ttu-id="89625-115">**Basculement automatique de l’hôte :** solution de récupération après incident locale à utiliser comme alternative à la réplication du système.</span><span class="sxs-lookup"><span data-stu-id="89625-115">**Host auto-failover:** A local fault-recovery solution to use as an alternative to system replication.</span></span> <span data-ttu-id="89625-116">Lorsque le nœud principal n’est plus disponible, un ou plusieurs nœuds SAP HANA de secours sont configurés en mode montée en puissance parallèle, et SAP HANA bascule automatiquement vers un autre nœud.</span><span class="sxs-lookup"><span data-stu-id="89625-116">When the master node becomes unavailable, one or more standby SAP HANA nodes are configured in scale-out mode and SAP HANA automatically fails over to another node.</span></span>

<span data-ttu-id="89625-117">Pour plus d’informations sur la haute disponibilité de la plateforme SAP HANA, consultez les informations SAP suivantes :</span><span class="sxs-lookup"><span data-stu-id="89625-117">For more information on SAP HANA high availability, see the following SAP information:</span></span>

- [<span data-ttu-id="89625-118">SAP HANA High-Availability Whitepaper (Livre blanc sur la haute disponibilité de SAP HANA)</span><span class="sxs-lookup"><span data-stu-id="89625-118">SAP HANA High-Availability Whitepaper</span></span>](http://go.sap.com/documents/2016/05/f8e5eeba-737c-0010-82c7-eda71af511fa.html)
- [<span data-ttu-id="89625-119">SAP HANA Administration Guide (Guide d’administration de SAP HANA)</span><span class="sxs-lookup"><span data-stu-id="89625-119">SAP HANA Administration Guide</span></span>](http://help.sap.com/hana/SAP_HANA_Administration_Guide_en.pdf)
- [<span data-ttu-id="89625-120">SAP Academy Video on SAP HANA System Replication (Vidéo SAP Academy sur la réplication du système SAP HANA) </span><span class="sxs-lookup"><span data-stu-id="89625-120">SAP Academy Video on SAP HANA System Replication</span></span>](http://scn.sap.com/community/hana-in-memory/blog/2015/05/19/sap-hana-system-replication)
- [<span data-ttu-id="89625-121">SAP Support Note #1999880 – FAQ on SAP HANA System Replication (Note de support SAP n°1999880 – FAQ sur la réplication du système SAP HANA)</span><span class="sxs-lookup"><span data-stu-id="89625-121">SAP Support Note #1999880 – FAQ on SAP HANA System Replication</span></span>](https://bcs.wdf.sap.corp/sap/support/notes/1999880)
- <span data-ttu-id="89625-122">[SAP Support Note #2165547 – SAP HANA Backup and Restore within SAP HANA System Replication Environment (Note de support SAP n°2165547 – Sauvegarde et restauration SAP HANA dans l’environnement de réplication du système SAP HANA)](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)</span><span class="sxs-lookup"><span data-stu-id="89625-122">[SAP Support Note #2165547 – SAP HANA Backup and Restore within SAP HANA System Replication Environment](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)</span></span>
- <span data-ttu-id="89625-123">[SAP Support Note #1984882 – Using SAP HANA System Replication for Hardware Exchange with Minimum/Zero Downtime (Note de support SAP n°1984882 – Utilisation de la réplication du système SAP HANA pour l’échange de matériel avec un temps d’arrêt minime ou nul)](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)</span><span class="sxs-lookup"><span data-stu-id="89625-123">[SAP Support Note #1984882 – Using SAP HANA System Replication for Hardware Exchange with Minimum/Zero Downtime](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)</span></span>

## <a name="disaster-recovery"></a><span data-ttu-id="89625-124">Récupération d'urgence</span><span class="sxs-lookup"><span data-stu-id="89625-124">Disaster recovery</span></span>

<span data-ttu-id="89625-125">SAP HANA sur Azure (grandes instances) est offert dans deux régions Azure d’une région géopolitique.</span><span class="sxs-lookup"><span data-stu-id="89625-125">SAP HANA on Azure (large instances) is offered in two Azure regions in a geopolitical region.</span></span> <span data-ttu-id="89625-126">Une connectivité réseau directe a été mise en place entre les deux tampons de grande instance de ces deux régions pour la réplication des données dans le cadre d’une récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-126">Between the two large-instance stamps of two different regions is a direct network connectivity for replicating data during disaster recovery.</span></span> <span data-ttu-id="89625-127">La réplication des données repose sur l’infrastructure de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-127">The replication of the data is storage-infrastructure based.</span></span> <span data-ttu-id="89625-128">La réplication n’est pas effectuée par défaut.</span><span class="sxs-lookup"><span data-stu-id="89625-128">The replication is not done by default.</span></span> <span data-ttu-id="89625-129">Il s’applique aux configurations client qui ont demandé la récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-129">It is done for the customer configurations that ordered the disaster recovery.</span></span> <span data-ttu-id="89625-130">Dans la conception actuelle, la réplication du système HANA ne peut pas être utilisée pour la récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-130">In the current design, HANA system replication can't be used for disaster recovery.</span></span>

<span data-ttu-id="89625-131">Toutefois, pour tirer parti de la récupération d’urgence, vous devez commencer par concevoir la connectivité réseau des deux régions Azure.</span><span class="sxs-lookup"><span data-stu-id="89625-131">However, to take advantage of the disaster recovery, you need to start to design the network connectivity to the two different Azure regions.</span></span> <span data-ttu-id="89625-132">Pour cela, vous avez besoin d’un circuit Azure ExpressRoute assurant la connexion entre l’emplacement local dans votre région Azure principale, et d’un autre circuit pour la connexion entre l’emplacement local et votre région de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-132">To do so, you need an Azure ExpressRoute circuit connection from on-premises in your main Azure region and another circuit connection from on-premises to your disaster-recovery region.</span></span> <span data-ttu-id="89625-133">Cette mesure s’applique à une situation dans laquelle une région Azure complète, incluant l’emplacement d’un routeur Microsoft Enterprise Edge (MSEE), rencontre un problème.</span><span class="sxs-lookup"><span data-stu-id="89625-133">This measure would cover a situation in which a complete Azure region, including a Microsoft enterprise edge router (MSEE) location, has an issue.</span></span>

<span data-ttu-id="89625-134">Votre seconde mesure consiste à connecter à ces deux circuits ExpressRoute tous les réseaux virtuels Azure qui sont connectés au serveur SAP HANA sur Azure (grandes instances) dans l’une des régions.</span><span class="sxs-lookup"><span data-stu-id="89625-134">As a second measure, you can connect all Azure virtual networks that connect to SAP HANA on Azure (large instances) in one of the regions to both of those ExpressRoute circuits.</span></span> <span data-ttu-id="89625-135">Cette mesure remédie à la situation dans laquelle un seul des emplacements MSEE qui connecte votre emplacement local à Azure devient hors service.</span><span class="sxs-lookup"><span data-stu-id="89625-135">This measure addresses a case where only one of the MSEE locations that connects your on-premises location with Azure goes off duty.</span></span>

<span data-ttu-id="89625-136">La figure ci-après montre la configuration optimale pour la récupération d’urgence :</span><span class="sxs-lookup"><span data-stu-id="89625-136">The following figure shows the optimal configuration for disaster recovery:</span></span>

![Configuration optimale pour la récupération d’urgence](./media/hana-overview-high-availability-disaster-recovery/image1-optimal-configuration.png)

<span data-ttu-id="89625-138">Une configuration de récupération d’urgence optimale du réseau consiste à utiliser deux circuits ExpressRoute entre l’emplacement local et les deux régions Azure.</span><span class="sxs-lookup"><span data-stu-id="89625-138">The optimal case for a disaster-recovery configuration of the network is to have two ExpressRoute circuits from on-premises to the two different Azure regions.</span></span> <span data-ttu-id="89625-139">L’un des circuits aboutit à la région n°1, exécutant une instance de production.</span><span class="sxs-lookup"><span data-stu-id="89625-139">One circuit goes to region #1, running a production instance.</span></span> <span data-ttu-id="89625-140">Le second circuit ExpressRoute aboutit à la région n°2, exécutant certaines instances HANA hors production.</span><span class="sxs-lookup"><span data-stu-id="89625-140">The second ExpressRoute circuit goes to region #2, running some non-production HANA instances.</span></span> <span data-ttu-id="89625-141">(Ceci est important dans le cas où la totalité d’une région Azure, comprenant le MSEE et le tampon de grande instance, est déconnectée).</span><span class="sxs-lookup"><span data-stu-id="89625-141">(This is important if an entire Azure region, including the MSEE and large-instance stamp, goes off the grid.)</span></span>

<span data-ttu-id="89625-142">Comme deuxième mesure, les différents réseaux virtuels sont connectés à divers circuits ExpressRoute connectés à SAP HANA sur Azure (grandes instances).</span><span class="sxs-lookup"><span data-stu-id="89625-142">As a second measure, the various virtual networks are connected to the various ExpressRoute circuits that are connected to SAP HANA on Azure (large instances).</span></span> <span data-ttu-id="89625-143">Vous pouvez contourner l’emplacement d’un MSEE défaillant, ou bien réduire l’objectif de point de récupération pour récupération d’urgence, comme nous le verrons par la suite.</span><span class="sxs-lookup"><span data-stu-id="89625-143">You can bypass the location where an MSEE is failing, or you can lower the recovery point objective for disaster recovery, as we discuss later.</span></span>

<span data-ttu-id="89625-144">Une configuration de récupération d’urgence présente les exigences suivantes :</span><span class="sxs-lookup"><span data-stu-id="89625-144">The next requirements for a disaster-recovery setup are:</span></span>

- <span data-ttu-id="89625-145">Vous devez commander des références (SKU) SAP HANA sur Azure (grandes instances) de la même taille que vos SKU de production et les déployer dans la région de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-145">You must order SAP HANA on Azure (large instances) SKUs of the same size as your production SKUs and deploy them in the disaster-recovery region.</span></span> <span data-ttu-id="89625-146">Ces instances peuvent servir à exécuter des instances HANA de test, bac à sable (sandbox) ou d’assurance qualité.</span><span class="sxs-lookup"><span data-stu-id="89625-146">These instances can be used to run test, sandbox, or QA HANA instances.</span></span>
- <span data-ttu-id="89625-147">Vous devez commander un profil de récupération d’urgence pour chacune des SKU SAP HANA sur Azure (grandes instances) que vous souhaitez récupérer sur le site de récupération d’urgence, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="89625-147">You must order a disaster-recovery profile for each of your SAP HANA on Azure (large instances) SKUs that you want to recover in the disaster-recovery site, if necessary.</span></span> <span data-ttu-id="89625-148">Cette action entraîne l’allocation de volumes de stockage, qui constituent la cible de la réplication de stockage entre votre région de production et la région de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-148">This action leads to the allocation of storage volumes, which are the target of the storage replication from your production region into the disaster-recovery region.</span></span>

<span data-ttu-id="89625-149">Après avoir rempli les conditions requises ci-dessus, il vous incombe de lancer la réplication de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-149">After you meet the preceding requirements, it is your responsibility to start the storage replication.</span></span> <span data-ttu-id="89625-150">Dans l’infrastructure de stockage utilisée pour SAP HANA sur Azure (grandes instances), la réplication du stockage repose sur les captures instantanées de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-150">In the storage infrastructure used for SAP HANA on Azure (large instances), the basis of storage replication is storage snapshots.</span></span> <span data-ttu-id="89625-151">Pour démarrer la réplication de récupération d’urgence, vous devez exécuter :</span><span class="sxs-lookup"><span data-stu-id="89625-151">To start the disaster-recovery replication, you need to perform:</span></span>

- <span data-ttu-id="89625-152">Une capture instantanée de votre numéro d’unité logique de démarrage, comme décrit précédemment.</span><span class="sxs-lookup"><span data-stu-id="89625-152">A snapshot of your boot LUN, as described earlier.</span></span>
- <span data-ttu-id="89625-153">Une capture instantanée de vos volumes associés à HANA, comme décrit précédemment.</span><span class="sxs-lookup"><span data-stu-id="89625-153">A snapshot of your HANA-related volumes, as described earlier.</span></span>

<span data-ttu-id="89625-154">Une fois que vous exécutez ces captures instantanées, un réplica initial des volumes est amorcé sur les volumes associés à votre profil de récupération d’urgence dans la région de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-154">After you execute these snapshots, an initial replica of the volumes is seeded on the volumes that are associated with your disaster-recovery profile in the disaster-recovery region.</span></span>

<span data-ttu-id="89625-155">Par la suite, la dernière capture instantanée de stockage est utilisée toutes les heures pour répliquer les deltas qui se développent sur les volumes de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-155">Subsequently, the most recent storage snapshot is used every hour to replicate the deltas that develop on the storage volumes.</span></span>

<span data-ttu-id="89625-156">L’objectif de point de récupération obtenu avec cette configuration est compris entre 60 et 90 minutes.</span><span class="sxs-lookup"><span data-stu-id="89625-156">The recovery point objective that's achieved with this configuration is from 60 to 90 minutes.</span></span> <span data-ttu-id="89625-157">Pour améliorer l’objectif de point de récupération dans le cadre d’une récupération d’urgence, copiez les sauvegardes des journaux de transactions HANA de SAP HANA sur Azure (grandes instances) vers l’autre région Azure.</span><span class="sxs-lookup"><span data-stu-id="89625-157">To achieve a better recovery point objective in the disaster-recovery case, copy the HANA transaction log backups from SAP HANA on Azure (large instances) to the other Azure region.</span></span> <span data-ttu-id="89625-158">Pour atteindre cet objectif de point de récupération, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="89625-158">To achieve this recovery point objective, do the following:</span></span>

1. <span data-ttu-id="89625-159">Sauvegardez le journal des transactions HANA aussi souvent que possible dans /hana/log/backup.</span><span class="sxs-lookup"><span data-stu-id="89625-159">Back up the HANA transaction log as frequently as possible to /hana/log/backup.</span></span>
2. <span data-ttu-id="89625-160">Copiez les sauvegardes des journaux de transactions terminées sur une machine virtuelle Azure, qui se trouve dans un réseau virtuel connecté au serveur SAP HANA sur Azure (grandes instances).</span><span class="sxs-lookup"><span data-stu-id="89625-160">Copy the transaction log backups when they are finished to an Azure virtual machine (VM), which is in a virtual network that's connected to the SAP HANA on Azure (large instances) server.</span></span>
3. <span data-ttu-id="89625-161">À partir de cette machine virtuelle, copiez la sauvegarde sur une machine virtuelle qui se trouve dans un réseau virtuel de la région de récupération après sinistre.</span><span class="sxs-lookup"><span data-stu-id="89625-161">From that VM, copy the backup to a VM that's in a virtual network in the disaster-recovery region.</span></span>
4. <span data-ttu-id="89625-162">Conservez les sauvegardes des journaux de transactions dans cette région sur la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="89625-162">Keep the transaction log backups in that region in the VM.</span></span>

<span data-ttu-id="89625-163">En cas de sinistre, une fois que le profil de récupération d’urgence a été déployé sur un serveur réel, copiez les sauvegardes des journaux de transactions à partir de la machine virtuelle vers le serveur SAP HANA sur Azure (grandes instances), qui constitue désormais le serveur principal dans la région de récupération d’urgence, puis restaurez ces sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="89625-163">In case of disaster, after the disaster-recovery profile has been deployed on an actual server, copy the transaction log backups from the VM to the SAP HANA on Azure (large instances) that is now the primary server in the disaster-recovery region, and restore those backups.</span></span> <span data-ttu-id="89625-164">Cette récupération est possible car l’état de HANA sur les disques de récupération d’urgence est celui d’une capture instantanée HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-164">This recovery is possible because the state of HANA on the disaster-recovery disks is that of a HANA snapshot.</span></span> <span data-ttu-id="89625-165">Il s’agit du point de décalage pour les restaurations ultérieures des sauvegardes des journaux de transactions.</span><span class="sxs-lookup"><span data-stu-id="89625-165">This is the offset point for further restorations of transaction log backups.</span></span>

## <a name="backup-and-restore"></a><span data-ttu-id="89625-166">Sauvegarde et restauration</span><span class="sxs-lookup"><span data-stu-id="89625-166">Backup and restore</span></span>

<span data-ttu-id="89625-167">L’un des aspects les plus importants de l’utilisation de bases de données consiste à s’assurer que ces bases peuvent être protégées de différents événements graves.</span><span class="sxs-lookup"><span data-stu-id="89625-167">One of the most important aspects to operating databases is making sure the database can be protected from various catastrophic events.</span></span> <span data-ttu-id="89625-168">Ces événements peuvent avoir une multitude de causes, depuis les catastrophes naturelles jusqu’aux simples erreurs des utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="89625-168">These events can be caused by anything from natural disasters to simple user errors.</span></span>

<span data-ttu-id="89625-169">La sauvegarde d’une base de données, combinée à une possibilité de restauration à un moment donné quelconque (par exemple avant la suppression de données critiques), permet de récupérer la base de données dans un état aussi proche que possible de celui qu’elle présentait au moment de l’interruption.</span><span class="sxs-lookup"><span data-stu-id="89625-169">Backing up a database, with the ability to restore it to any point in time (such as before somebody deleted critical data), allows restoration to a state that is as close as possible to the way it was before the disruption occurred.</span></span>

<span data-ttu-id="89625-170">Pour optimiser les résultats, vous devez effectuer deux types de sauvegardes :</span><span class="sxs-lookup"><span data-stu-id="89625-170">Two types of backups must be performed for best results:</span></span>

- <span data-ttu-id="89625-171">Sauvegardes de base de données</span><span class="sxs-lookup"><span data-stu-id="89625-171">Database backups</span></span>
- <span data-ttu-id="89625-172">Sauvegardes des journaux de transactions</span><span class="sxs-lookup"><span data-stu-id="89625-172">Transaction log backups</span></span>

<span data-ttu-id="89625-173">Pour plus de sûreté, vous pouvez compléter les sauvegardes de base de données complètes exécutées au niveau application par des sauvegardes effectuées à l’aide des captures instantanées de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-173">In addition to full database backups performed at an application-level, you can be even more thorough by performing backups with storage snapshots.</span></span> <span data-ttu-id="89625-174">L’exécution de sauvegardes des journaux se révèle également importante pour la restauration de la base de données (et pour la suppression des transactions déjà validées dans les journaux).</span><span class="sxs-lookup"><span data-stu-id="89625-174">Performing log backups is also important for restoring the database (and to empty the logs from already committed transactions).</span></span>

<span data-ttu-id="89625-175">SAP HANA sur Azure (grandes instances) offre deux options de sauvegarde et de restauration :</span><span class="sxs-lookup"><span data-stu-id="89625-175">SAP HANA on Azure (large instances) offers two backup and restore options:</span></span>

- <span data-ttu-id="89625-176">Utilisation de vos propres méthodes de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="89625-176">Do it yourself (DIY).</span></span> <span data-ttu-id="89625-177">Après avoir calculé et vérifié l’espace disque requis, effectuez des sauvegardes complètes de la base de données et des journaux à l’aide des méthodes de sauvegarde de disque (sur ces disques).</span><span class="sxs-lookup"><span data-stu-id="89625-177">After you calculate to ensure enough disk space, perform full database and log backups by using disk backup methods (to those disks).</span></span> <span data-ttu-id="89625-178">Au fil du temps, les sauvegardes sont copiées vers un compte de stockage Azure (une fois que vous avez configuré un serveur de fichiers reposant sur Azure avec un stockage quasiment illimité), ou utilisent Azure Backup Vault ou Azure Cold Storage.</span><span class="sxs-lookup"><span data-stu-id="89625-178">Over time, the backups are copied to an Azure storage account (after you set up an Azure-based file server with virtually unlimited storage), or use an Azure Backup vault or Azure cold storage.</span></span> <span data-ttu-id="89625-179">Une autre possibilité consiste à recourir à un outil de protection des données tiers, tel que Commvault, pour stocker les sauvegardes une fois ces dernières copiées dans le compte de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-179">Another option is to use a third-party data protection tool, such as Commvault, to store the backups after they are copied to a storage account.</span></span> <span data-ttu-id="89625-180">L’utilisation de vos propres méthodes de sauvegarde peut également se révéler nécessaire pour les données qui doivent être stockées sur de plus longues périodes à des fins de conformité et d’audit.</span><span class="sxs-lookup"><span data-stu-id="89625-180">The DIY backup option might also be necessary for data that needs to be stored for longer periods for compliancy and auditing purposes.</span></span>
- <span data-ttu-id="89625-181">Utilisation des fonctionnalités de sauvegarde et de restauration fournies par l’infrastructure sous-jacente de SAP HANA sur Azure (grandes instances).</span><span class="sxs-lookup"><span data-stu-id="89625-181">Use the backup and restore functionality that the underlying infrastructure of SAP HANA on Azure (large instances) provides.</span></span> <span data-ttu-id="89625-182">Cette option répond à la nécessité d’effectuer des sauvegardes, et rend les sauvegardes manuelles quasiment obsolètes (sauf dans les cas où des sauvegardes de données sont requises pour des besoins de conformité).</span><span class="sxs-lookup"><span data-stu-id="89625-182">This option fulfills the need for backups, and it makes manual backups nearly obsolete (except where data backups are required for compliance purposes).</span></span> <span data-ttu-id="89625-183">Le reste de cette section traite des fonctionnalités de sauvegarde et de restauration offertes avec HANA grandes instances.</span><span class="sxs-lookup"><span data-stu-id="89625-183">The rest of this section addresses the backup and restore functionality that's offered with HANA (large instances).</span></span>

> [!NOTE]
> <span data-ttu-id="89625-184">La technologie de capture instantanée utilisée par l’infrastructure sous-jacente de HANA (grandes instances) a une dépendance sur les captures instantanées SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-184">The snapshot technology that is used by the underlying infrastructure of HANA (large instances) has a dependency on SAP HANA snapshots.</span></span> <span data-ttu-id="89625-185">Les captures instantanées SAP HANA ne fonctionnent pas conjointement avec les conteneurs de bases de données SAP HANA mutualisées.</span><span class="sxs-lookup"><span data-stu-id="89625-185">SAP HANA snapshots do not work in conjunction with SAP HANA Multitenant Database Containers.</span></span> <span data-ttu-id="89625-186">Par conséquent, cette méthode de sauvegarde ne peut pas être utilisée pour déployer des conteneurs de bases de données SAP HANA mutualisées.</span><span class="sxs-lookup"><span data-stu-id="89625-186">As a result, this method of backup cannot be used to deploy SAP HANA Multitenant Database Containers.</span></span>

### <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a><span data-ttu-id="89625-187">Utilisation des captures instantanées de stockage de SAP HANA sur Azure (grandes instances)</span><span class="sxs-lookup"><span data-stu-id="89625-187">Using storage snapshots of SAP HANA on Azure (large instances)</span></span>

<span data-ttu-id="89625-188">L’infrastructure de stockage qui sous-tend SAP HANA sur Azure (grandes instances) met en œuvre la notion de capture instantanée des volumes de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-188">The storage infrastructure underlying SAP HANA on Azure (large instances) supports the notion of a storage snapshot of volumes.</span></span> <span data-ttu-id="89625-189">La prise en charge de la sauvegarde et de la restauration d’un volume spécifique est régie par les règles suivantes :</span><span class="sxs-lookup"><span data-stu-id="89625-189">Both backup and restoration of a particular volume are supported, with the following considerations:</span></span>

- <span data-ttu-id="89625-190">Au lieu d’exécuter des sauvegardes de base de données, le système procède à de fréquentes captures instantanées des volumes de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-190">Instead of database backups, storage volume snapshots are taken on a frequent basis.</span></span>
- <span data-ttu-id="89625-191">La capture instantanée de stockage initie une capture instantanée SAP HANA avant d’exécuter la capture instantanée de stockage proprement dite.</span><span class="sxs-lookup"><span data-stu-id="89625-191">The storage snapshot initiates an SAP HANA snapshot before it executes the storage snapshot.</span></span> <span data-ttu-id="89625-192">Cette capture instantanée SAP HANA est le point d’installation d’éventuelles restaurations de journaux après récupération de la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-192">This SAP HANA snapshot is the setup point for eventual log restorations after recovery of the storage snapshot.</span></span>
- <span data-ttu-id="89625-193">Une fois la capture instantanée de stockage exécutée avec succès, la capture instantanée SAP HANA est supprimée.</span><span class="sxs-lookup"><span data-stu-id="89625-193">At the point where the storage snapshot is executed successfully, the SAP HANA snapshot is deleted.</span></span>
- <span data-ttu-id="89625-194">Les sauvegardes de journaux sont effectuées fréquemment et stockées dans le volume de sauvegarde des journaux ou dans Azure.</span><span class="sxs-lookup"><span data-stu-id="89625-194">Log backups are taken frequently and stored in the log backup volume or in Azure.</span></span>
- <span data-ttu-id="89625-195">Si la base de données doit être restaurée à un point dans le temps spécifique, une demande est envoyée au support technique de Microsoft Azure (interruption de production) ou à l’équipe de gestion des services SAP HANA sur Azure afin de solliciter une restauration à partir d’une capture instantanée de stockage donnée (par exemple, une restauration planifiée d’un système bac à sable à son état d’origine).</span><span class="sxs-lookup"><span data-stu-id="89625-195">If the database must be restored to a certain point in time, a request is made to Microsoft Azure Support (production outage) or SAP HANA on Azure Service Management to restore to a certain storage snapshot (for example, a planned restoration of a sandbox system to its original state).</span></span>
- <span data-ttu-id="89625-196">La capture instantanée SAP HANA incluse dans la capture instantanée de stockage constitue un point de décalage pour l’application des sauvegardes de journaux qui ont été exécutées et stockées après la création de la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-196">The SAP HANA snapshot that's included in the storage snapshot is an offset point for applying log backups that have been executed and stored after the storage snapshot was taken.</span></span>
- <span data-ttu-id="89625-197">Ces sauvegardes de journaux sont effectuées pour restaurer la base de données à un point dans le temps spécifique.</span><span class="sxs-lookup"><span data-stu-id="89625-197">These log backups are taken to restore the database back to a certain point in time.</span></span>

<span data-ttu-id="89625-198">La spécification du nom de la sauvegarde\_ entraînera la capture instantanée des volumes suivants :</span><span class="sxs-lookup"><span data-stu-id="89625-198">Specifying the backup\_name creates a snapshot of the following volumes:</span></span>

- <span data-ttu-id="89625-199">hana/data</span><span class="sxs-lookup"><span data-stu-id="89625-199">hana/data</span></span>
- <span data-ttu-id="89625-200">hana/log</span><span class="sxs-lookup"><span data-stu-id="89625-200">hana/log</span></span>
- <span data-ttu-id="89625-201">hana/log\_backup (monté en tant que sauvegarde dans hana/log)</span><span class="sxs-lookup"><span data-stu-id="89625-201">hana/log\_backup (mounted as backup into hana/log)</span></span>
- <span data-ttu-id="89625-202">hana/shared</span><span class="sxs-lookup"><span data-stu-id="89625-202">hana/shared</span></span>

### <a name="storage-snapshot-considerations"></a><span data-ttu-id="89625-203">Considérations relatives aux captures instantanées de stockage</span><span class="sxs-lookup"><span data-stu-id="89625-203">Storage snapshot considerations</span></span>

>[!NOTE]
><span data-ttu-id="89625-204">Les captures instantanées de stockage ne sont _pas_ fournies gratuitement car elles nécessitent l’allocation d’un espace de stockage supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="89625-204">Storage snapshots are _not_ provided free of charge, because additional storage space must be allocated.</span></span>

<span data-ttu-id="89625-205">Les mécanismes spécifiques des captures instantanées de stockage de SAP HANA sur Azure (grandes instances) incluent :</span><span class="sxs-lookup"><span data-stu-id="89625-205">The specific mechanics of storage snapshots for SAP HANA on Azure (large instances) include:</span></span>

- <span data-ttu-id="89625-206">Une capture instantanée de stockage spécifique (au moment précis de sa création) consomme très peu de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-206">A specific storage snapshot (at the point in time when it is taken) consumes very little storage.</span></span>
- <span data-ttu-id="89625-207">Étant donné que les données changent et que le contenu des fichiers de données SAP HANA évolue sur le volume de stockage, la capture instantanée doit stocker le contenu des blocs d’origine.</span><span class="sxs-lookup"><span data-stu-id="89625-207">As data content changes and the content in SAP HANA data files change on the storage volume, the snapshot needs to store the original block content.</span></span>
- <span data-ttu-id="89625-208">La taille de la capture instantanée de stockage augmente.</span><span class="sxs-lookup"><span data-stu-id="89625-208">The storage snapshot increases in size.</span></span> <span data-ttu-id="89625-209">Plus la durée d’existence de la capture instantanée est longue, plus la capture instantanée de stockage devient volumineuse.</span><span class="sxs-lookup"><span data-stu-id="89625-209">The longer the snapshot exists, the larger the storage snapshot becomes.</span></span>
- <span data-ttu-id="89625-210">Plus le volume de base de données SAP HANA fait l’objet de modifications pendant la durée de vie d’une capture instantanée de stockage, plus la capture instantanée de stockage consomme d’espace.</span><span class="sxs-lookup"><span data-stu-id="89625-210">The more changes made to the SAP HANA database volume over the lifetime of a storage snapshot, the larger the space consumption of the storage snapshot becomes.</span></span>

<span data-ttu-id="89625-211">SAP HANA sur Azure (grandes instances) est fourni avec des tailles de volume fixes pour le volume de données et de journaux SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-211">SAP HANA on Azure (large instances) comes with fixed volume sizes for the SAP HANA data and log volume.</span></span> <span data-ttu-id="89625-212">L’exécution de captures instantanées de ces volumes consomme une partie de l’espace des volumes. Il vous incombe donc de planifier les captures instantanées de stockage (au sein du processus SAP HANA sur Azure (grandes instances)).</span><span class="sxs-lookup"><span data-stu-id="89625-212">Performing snapshots of those volumes eats into your volume space, so it is your responsibility to schedule storage snapshots (within the SAP HANA on Azure [large instances] process).</span></span>

<span data-ttu-id="89625-213">Les sections ci-après fournissent diverses informations concernant l’exécution de ces captures instantanées, y compris des recommandations générales :</span><span class="sxs-lookup"><span data-stu-id="89625-213">The following sections provide information for performing these snapshots, including general recommendations:</span></span>

- <span data-ttu-id="89625-214">Bien que le matériel puisse prendre en charge 255 captures instantanées par volume, il est vivement recommandé de rester bien en deçà de ce nombre.</span><span class="sxs-lookup"><span data-stu-id="89625-214">Though the hardware can sustain 255 snapshots per volume, we highly recommend that you stay well below this number.</span></span>
- <span data-ttu-id="89625-215">Avant d’effectuer des captures instantanées du stockage, surveillez l’espace libre.</span><span class="sxs-lookup"><span data-stu-id="89625-215">Before you perform storage snapshots, monitor and keep track of free space.</span></span>
- <span data-ttu-id="89625-216">Réduisez le nombre de captures instantanées de stockage en fonction de l’espace libre.</span><span class="sxs-lookup"><span data-stu-id="89625-216">Lower the number of storage snapshots based on free space.</span></span> <span data-ttu-id="89625-217">Vous devrez peut-être réduire le nombre de captures instantanées à conserver, ou être étendre les volumes.</span><span class="sxs-lookup"><span data-stu-id="89625-217">You might need to lower the number of snapshots that you keep, or you might need to extend the volumes.</span></span> <span data-ttu-id="89625-218">(Vous pouvez commander du stockage supplémentaire par unités de 1 To).</span><span class="sxs-lookup"><span data-stu-id="89625-218">(You can order additional storage in 1-TB units.)</span></span>
- <span data-ttu-id="89625-219">Lorsque vous exécutez des tâches telles que le déplacement de données dans SAP HANA avec des outils de migration système (en utilisant R3load ou en restaurant des bases de données SAP HANA à partir de sauvegardes), il est fortement déconseillé d’effectuer la moindre capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-219">During activities such as moving data into SAP HANA with system migration tools (with R3load, or by restoring SAP HANA databases from backups), we highly recommended that you not perform any storage snapshots.</span></span> <span data-ttu-id="89625-220">(Si une migration système est exécutée sur un nouveau système SAP HANA, aucune capture instantanée n’est nécessaire.)</span><span class="sxs-lookup"><span data-stu-id="89625-220">(If a system migration is being done on a new SAP HANA system, storage snapshots would not need to be performed.)</span></span>
- <span data-ttu-id="89625-221">Dans le cadre de réorganisations plus vastes des tables SAP HANA, les captures instantanées de stockage doivent être évitées dans la mesure du possible.</span><span class="sxs-lookup"><span data-stu-id="89625-221">During larger reorganizations of SAP HANA tables, storage snapshots should be avoided if possible.</span></span>
- <span data-ttu-id="89625-222">Les captures instantanées de stockage constituent une condition préalable à l’utilisation des fonctionnalités de récupération d’urgence de SAP HANA sur Azure (grandes instances).</span><span class="sxs-lookup"><span data-stu-id="89625-222">Storage snapshots are a prerequisite to engaging the disaster-recovery capabilities of SAP HANA on Azure (large instances).</span></span>

### <a name="setting-up-storage-snapshots"></a><span data-ttu-id="89625-223">Configuration des captures instantanées de stockage</span><span class="sxs-lookup"><span data-stu-id="89625-223">Setting up storage snapshots</span></span>

1. <span data-ttu-id="89625-224">Assurez-vous que Perl est installé dans le système d’exploitation Linux sur le serveur HANA grandes instances.</span><span class="sxs-lookup"><span data-stu-id="89625-224">Make sure that Perl is installed in the Linux operating system on the HANA (large instances) server.</span></span>
2. <span data-ttu-id="89625-225">Modifiez /etc/ssh/ssh\_config en ajoutant la ligne _MACs hmac-sha1_.</span><span class="sxs-lookup"><span data-stu-id="89625-225">Modify /etc/ssh/ssh\_config to add the line _MACs hmac-sha1_.</span></span>
3. <span data-ttu-id="89625-226">Créez un compte d’utilisateur de sauvegarde SAP HANA sur le nœud principal de chaque instance SAP HANA que vous exécutez (le cas échéant).</span><span class="sxs-lookup"><span data-stu-id="89625-226">Create an SAP HANA backup user account on the master node for each SAP HANA instance you are running (if applicable).</span></span>
4. <span data-ttu-id="89625-227">Le client SAP HANA HDB doit être installé sur tous les serveurs SAP HANA (grandes instances).</span><span class="sxs-lookup"><span data-stu-id="89625-227">The SAP HANA HDB client must be installed on all SAP HANA (large instances) servers.</span></span>
5. <span data-ttu-id="89625-228">Sur le premier serveur SAP HANA grandes instances de chaque région, vous devez créer une clé publique pour accéder à l’infrastructure de stockage sous-jacente qui contrôle la création de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-228">On the first SAP HANA (large instances) server of each region, a public key must be created to access the underlying storage infrastructure that controls snapshot creation.</span></span>
6. <span data-ttu-id="89625-229">Copiez le script azure\_hana\_backup.pl à partir du dossier /scripts à l’emplacement de l’outil **hdbsql** de l’installation SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-229">Copy the script azure\_hana\_backup.pl from /scripts to the location of **hdbsql** of the SAP HANA installation.</span></span>
7. <span data-ttu-id="89625-230">Copiez le fichier HANABackupDetails.txt à partir du dossier /scripts au même emplacement que le script Perl.</span><span class="sxs-lookup"><span data-stu-id="89625-230">Copy the HANABackupDetails.txt file from /scripts to the same location as the Perl script.</span></span>
8. <span data-ttu-id="89625-231">Modifiez le fichier HANABackupDetails.txt selon vos besoins pour les spécifications client appropriées.</span><span class="sxs-lookup"><span data-stu-id="89625-231">Modify the HANABackupDetails.txt file as necessary for the appropriate customer specifications.</span></span>

### <a name="step-1-install-sap-hana-hdbclient"></a><span data-ttu-id="89625-232">Étape 1 : Installer SAP HANA HDBClient</span><span class="sxs-lookup"><span data-stu-id="89625-232">Step 1: Install SAP HANA HDBClient</span></span>

<span data-ttu-id="89625-233">Le système d’exploitation Linux installé dans SAP HANA sur Azure (grandes instances) inclut les dossiers et scripts nécessaires pour l’exécution de captures instantanées de stockage SAP HANA à des fins de sauvegarde et de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-233">The Linux installed on SAP HANA on Azure (large instances) includes the folders and scripts necessary to execute SAP HANA storage snapshots for backup and disaster-recovery purposes.</span></span> <span data-ttu-id="89625-234">Toutefois, il vous incombe d’installer SAP HANA HDBclient lorsque vous installez SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-234">However, it is your responsibility to install SAP HANA HDBclient while you are installing SAP HANA.</span></span> <span data-ttu-id="89625-235">(Microsoft n’installe ni HDBclient, ni SAP HANA.)</span><span class="sxs-lookup"><span data-stu-id="89625-235">(Microsoft installs neither the HDBclient nor SAP HANA.)</span></span>

### <a name="step-2-change-etcsshsshconfig"></a><span data-ttu-id="89625-236">Étape 2 : Modifier /etc/ssh/ssh\_config</span><span class="sxs-lookup"><span data-stu-id="89625-236">Step 2: Change /etc/ssh/ssh\_config</span></span>

<span data-ttu-id="89625-237">Modifiez /etc/ssh/ssh\_config en ajoutant la ligne _MACs hmac-sha1_ comme indiqué ici :</span><span class="sxs-lookup"><span data-stu-id="89625-237">Change /etc/ssh/ssh\_config by adding _MACs hmac-sha1_ line as shown here:</span></span>
```
#   RhostsRSAAuthentication no
#   RSAAuthentication yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/identity
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
Protocol 2
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
MACs hmac-sha1
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
```

### <a name="step-3-create-a-public-key"></a><span data-ttu-id="89625-238">Étape 3 : Créer une clé publique</span><span class="sxs-lookup"><span data-stu-id="89625-238">Step 3: Create a public key</span></span>

<span data-ttu-id="89625-239">Sur le premier serveur SAP HANA sur Azure (grandes instances) de chaque région Azure, créez une clé publique servant à accéder à l’infrastructure de stockage pour vous permettre de créer des captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-239">On the first SAP HANA on Azure (large instances) server in each Azure region, create a public key to be used to access the storage infrastructure so that you can create snapshots.</span></span> <span data-ttu-id="89625-240">Cette clé publique garantit qu’aucun mot de passe n’est requis pour la connexion au stockage et que le système ne conserve aucune information d’identification de mot de passe.</span><span class="sxs-lookup"><span data-stu-id="89625-240">The public key ensures that a password is not required to sign in to the storage and that password credentials are not maintained.</span></span> <span data-ttu-id="89625-241">Dans le système d’exploitation Linux du serveur SAP HANA grandes instances, exécutez la commande ci-après pour générer la clé publique :</span><span class="sxs-lookup"><span data-stu-id="89625-241">In Linux on the SAP HANA (large instances) server, execute the following command to generate the public key:</span></span>
```
  ssh-keygen –t dsa –b 1024
```
<span data-ttu-id="89625-242">Le nouvel emplacement est _/root/.ssh/id\_dsa.pub.</span><span class="sxs-lookup"><span data-stu-id="89625-242">The new location is _/root/.ssh/id\_dsa.pub.</span></span> <span data-ttu-id="89625-243">N’entrez pas une phrase secrète réelle, sans quoi vous devrez l’entrer chaque fois que vous vous connectez.</span><span class="sxs-lookup"><span data-stu-id="89625-243">Do not enter an actual passphrase, or else you will be required to enter the passphrase each time you sign in.</span></span> <span data-ttu-id="89625-244">À la place, appuyez deux fois sur **Entrée** pour supprimer l’exigence de saisie d’une phrase secrète au moment de la connexion.</span><span class="sxs-lookup"><span data-stu-id="89625-244">Instead, press **Enter** twice to remove the enter passphrase requirement for signing in.</span></span>

<span data-ttu-id="89625-245">Assurez-vous que la clé publique a été corrigée comme attendu en remplaçant les dossiers par /root/.ssh/, puis en exécutant la commande **ls**.</span><span class="sxs-lookup"><span data-stu-id="89625-245">Check to make sure that the public key was corrected as expected by changing folders to /root/.ssh/ and then executing the **ls** command.</span></span> <span data-ttu-id="89625-246">Si la clé est présente, vous pouvez la copier en exécutant la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="89625-246">If the key is present, you can copy it by running the following command:</span></span>

![Clé publique copiée par l’exécution de cette commande](./media/hana-overview-high-availability-disaster-recovery/image2-public-key.png)

<span data-ttu-id="89625-248">À ce stade, contactez l’équipe de gestion des services SAP HANA sur Azure et fournissez-lui la clé.</span><span class="sxs-lookup"><span data-stu-id="89625-248">At this point, contact SAP HANA on Azure Service Management and provide the key.</span></span> <span data-ttu-id="89625-249">Le représentant du service utilisera la clé publique pour l’inscrire dans l’infrastructure de stockage sous-jacente.</span><span class="sxs-lookup"><span data-stu-id="89625-249">The service representative uses the public key to register it in the underlying storage infrastructure.</span></span>

### <a name="step-4-create-an-sap-hana-user-account"></a><span data-ttu-id="89625-250">Étape 4 : Créer un compte d’utilisateur SAP HANA</span><span class="sxs-lookup"><span data-stu-id="89625-250">Step 4: Create an SAP HANA user account</span></span>

<span data-ttu-id="89625-251">Créez un compte d’utilisateur SAP HANA dans SAP HANA Studio à des fins de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="89625-251">Create an SAP HANA user account within SAP HANA Studio for backup purposes.</span></span> <span data-ttu-id="89625-252">Ce compte doit disposer des privilèges _Backup Admin_ (administration des sauvegardes) et _Catalog Read_ (lecture du catalogue).</span><span class="sxs-lookup"><span data-stu-id="89625-252">This account must have the following privileges: _Backup Admin_ and _Catalog Read_.</span></span> <span data-ttu-id="89625-253">Dans cet exemple, le nom d’utilisateur SCADMIN est créé.</span><span class="sxs-lookup"><span data-stu-id="89625-253">In this example, the username SCADMIN is created.</span></span>

![Création d’un utilisateur dans HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image3-creating-user.png)

### <a name="step-5-authorize-the-sap-hana-user-account"></a><span data-ttu-id="89625-255">Étape 5 : Autoriser le compte d’utilisateur SAP HANA</span><span class="sxs-lookup"><span data-stu-id="89625-255">Step 5: Authorize the SAP HANA user account</span></span>

<span data-ttu-id="89625-256">Autorisez le compte d’utilisateur SAP HANA (à être utilisé par les scripts sans nécessiter d’autorisation chaque fois que le script est exécuté).</span><span class="sxs-lookup"><span data-stu-id="89625-256">Authorize the SAP HANA user account (to be used by the scripts without requiring authorization every time the script is run).</span></span> <span data-ttu-id="89625-257">La commande SAP HANA `hdbuserstore` permet la création d’une clé utilisateur SAP HANA, stockée sur un ou plusieurs nœuds SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-257">The SAP HANA command `hdbuserstore` allows the creation of an SAP HANA user key, which is stored on one or more SAP HANA nodes.</span></span> <span data-ttu-id="89625-258">Cette clé utilisateur autorise également l’utilisateur à accéder à SAP HANA sans avoir à gérer les mots de passe à partir du processus d’utilisation de scripts décrit ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="89625-258">The user key also allows the user to access SAP HANA without having to manage passwords from within the scripting process that's discussed later.</span></span>

>[!IMPORTANT]
><span data-ttu-id="89625-259">Exécutez la commande suivante en tant que `_root_`.</span><span class="sxs-lookup"><span data-stu-id="89625-259">Run the following command as `_root_`.</span></span> <span data-ttu-id="89625-260">Dans le cas contraire, le script ne fonctionne pas correctement.</span><span class="sxs-lookup"><span data-stu-id="89625-260">Otherwise, the script cannot work properly.</span></span>

<span data-ttu-id="89625-261">Entrez La commande `hdbuserstore` comme suit :</span><span class="sxs-lookup"><span data-stu-id="89625-261">Enter the `hdbuserstore` command as follows:</span></span>

![Saisie de la commande hdbuserstore](./media/hana-overview-high-availability-disaster-recovery/image4-hdbuserstore-command.png)

<span data-ttu-id="89625-263">Dans l’exemple ci-après, impliquant l’utilisateur SCADMIN01 et le nom d’hôte lhanad01, la commande est la suivante :</span><span class="sxs-lookup"><span data-stu-id="89625-263">In the following example, where the user is SCADMIN01 and the hostname is lhanad01, the command is:</span></span>
```
hdbuserstore set SCADMIN01 lhanad01:30115 <backup username> <password>
```
<span data-ttu-id="89625-264">Gérez la totalité des scripts à partir d’un seul serveur pour les instances HANA de montée en puissance parallèle.</span><span class="sxs-lookup"><span data-stu-id="89625-264">Manage all scripting from a single server for scale-out HANA instances.</span></span> <span data-ttu-id="89625-265">Dans cet exemple, la clé SAP HANA SCADMIN01 doit être modifiée pour chaque hôte de façon à refléter l’hôte qui est associé à la clé.</span><span class="sxs-lookup"><span data-stu-id="89625-265">In this example, the SAP HANA key SCADMIN01 must be altered for each host in a way that reflects the host that is related to the key.</span></span> <span data-ttu-id="89625-266">Autrement dit, le compte de sauvegarde SAP HANA est modifié avec le nombre d’instances de la base de données HANA, **lhanad**.</span><span class="sxs-lookup"><span data-stu-id="89625-266">That is, the SAP HANA backup account is amended with the instance number of the HANA DB, **lhanad**.</span></span> <span data-ttu-id="89625-267">La clé doit disposer de privilèges administratifs sur l’hôte auquel elle est affectée, et l’utilisateur de sauvegarde pour la montée en puissance parallèle doit disposer de droits d’accès à toutes les instances SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-267">The key must have administrative privileges on the host it is assigned to, and the backup user for scale-out must have access rights to all SAP HANA instances.</span></span>
```
hdbuserstore set SCADMIN01 lhanad:30015 SCADMIN <password>
hdbuserstore set SCADMIN02 lhanad:30115 SCADMIN <password>
hdbuserstore set SCADMIN03 lhanad:30215 SCADMIN <password>
```

### <a name="step-6-copy-items-from-the-scripts-folder"></a><span data-ttu-id="89625-268">Étape 6 : Copier des éléments à partir du dossier /scripts</span><span class="sxs-lookup"><span data-stu-id="89625-268">Step 6: Copy items from the /scripts folder</span></span>

<span data-ttu-id="89625-269">Copiez les éléments ci-après à partir du dossier /scripts, (figurant sur l’image Gold de l’installation), dans le répertoire de travail de **hdbsql**.</span><span class="sxs-lookup"><span data-stu-id="89625-269">Copy the following items from the /scripts folder (included on the gold image of the installation) to the working directory for **hdbsql**.</span></span> <span data-ttu-id="89625-270">Pour les installations HANA actuelles, il s’agit du répertoire /hana/shared/D01/exe/linuxx86\_64/hdb.</span><span class="sxs-lookup"><span data-stu-id="89625-270">For current HANA installations, this directory is /hana/shared/D01/exe/linuxx86\_64/hdb.</span></span>
```
azure\_hana\_backup.pl
testHANAConnection.pl
testStorageSnapshotConnection.pl
removeTestStorageSnapshot.pl
HANABackupCustomerDetails.txt
```
<span data-ttu-id="89625-271">Copiez les éléments ci-après s’ils exécutent une montée en puissance parallèle ou un traitement analytique en ligne (OLAP) :</span><span class="sxs-lookup"><span data-stu-id="89625-271">Copy the following items if they are running scale-out or OLAP:</span></span>
```
azure\_hana\_backup\_bw.pl
testHANAConnectionBW.pl
testStorageSnapshotConnectionBW.pl
removeTestStorageSnapshotBW.pl
HANABackupCustomerDetailsBW.txt
```
<span data-ttu-id="89625-272">Le fichier HANABackupCustomerDetails.txt est modifiable comme suit pour un déploiement avec montée en puissance.</span><span class="sxs-lookup"><span data-stu-id="89625-272">The HANABackupCustomerDetails.txt file is modifiable as follows for a scale-up deployment.</span></span> <span data-ttu-id="89625-273">Il s’agit du fichier de contrôle et de configuration pour le script qui exécute les captures instantanées de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-273">It is the control and configuration file for the script that runs the storage snapshots.</span></span> <span data-ttu-id="89625-274">Vous devez avoir reçu les informations _Storage Backup Name (Nom de sauvegarde du stockage)_ et _Storage IP Address (Adresse IP de stockage)_ de la part de l’équipe de gestion des services SAP HANA sur Azure au moment où vos instances ont été déployées.</span><span class="sxs-lookup"><span data-stu-id="89625-274">You should have received the _Storage Backup Name_ and _Storage IP Address_ from SAP HANA on Azure Service Management when your instances were deployed.</span></span> <span data-ttu-id="89625-275">Vous ne pouvez pas modifier la séquence, l’ordre ou l’espacement des variables ; dans le cas contraire, le script ne s’exécute pas correctement.</span><span class="sxs-lookup"><span data-stu-id="89625-275">You cannot modify the sequence, ordering, or spacing of any of the variables, or the script does not run properly.</span></span>

<span data-ttu-id="89625-276">Dans le cas d’un déploiement avec montée en puissance, le fichier de configuration ressemblerait à ceci :</span><span class="sxs-lookup"><span data-stu-id="89625-276">For a scale-up deployment, the configuration file would look like:</span></span>
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Created by customer using hdbuserstore
HANA Backup Name: SCADMIND01
```
<span data-ttu-id="89625-277">Pour une configuration de montée en puissance parallèle, le fichier HANABackupCustomerDetailsBW.txt ressemblerait à ceci :</span><span class="sxs-lookup"><span data-stu-id="89625-277">For a scale-out configuration, the HANABackupCustomerDetailsBW.txt file would look like:</span></span>
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Node IP addresses, instance numbers, and HANA backup name
#provided by customer.  HANA backup name created using
#hdbuserstore utility.
Node 1 IP Address: 10.254.15.21
Node 1 HANA instance number: 01
Node 1 HANA Backup Name: SCADMIN01
Node 2 IP Address: 10.254.15.22
Node 2 HANA instance number: 02
Node 2 HANA Backup Name: SCADMIN02
Node 3 IP Address: 10.254.15.23
Node 3 HANA instance number: 03
Node 3 HANA Backup Name: SCADMIN03
Node 4 IP Address: 10.254.15.24
Node 4 HANA instance number: 04
Node 4 HANA Backup Name: SCADMIN04
Node 5 IP Address: 10.254.15.25
Node 5 HANA instance number: 05
Node 5 HANA Backup Name: SCADMIN05
Node 6 IP Address: 10.254.15.26
Node 6 HANA instance number: 06
Node 6 HANA Backup Name: SCADMIN06
Node 7 IP Address: 10.254.15.27
Node 7 HANA instance number: 07
Node 7 HANA Backup Name: SCADMIN07
Node 8 IP Address: 10.254.15.28
Node 8 HANA instance number: 08
Node 8 HANA Backup Name: SCADMIN08
```
>[!NOTE]
><span data-ttu-id="89625-278">Actuellement, seules les informations de nœud 1 sont utilisées dans le script réel de capture instantanée de stockage HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-278">Currently, only Node 1 details are used in the actual HANA storage snapshot script.</span></span> <span data-ttu-id="89625-279">Nous vous recommandons de tester l’accès à tous les nœuds HANA ou à partir de ces derniers. De cette façon, si le nœud de sauvegarde principal doit changer, vous êtes déjà assuré qu’un autre nœud pourra prendre sa place en modifiant les détails du nœud 1.</span><span class="sxs-lookup"><span data-stu-id="89625-279">We recommend that you test access to or from all HANA nodes so that, if the master backup node ever changes, you have already ensured that any other node can take its place by modifying the details in Node 1.</span></span>

<span data-ttu-id="89625-280">Pour vérifier l’exactitude des configurations dans le fichier de configuration ou l’adéquation de la connectivité aux instances HANA, exécutez l’un des scripts suivants :</span><span class="sxs-lookup"><span data-stu-id="89625-280">To check for the correct configurations in the configuration file or proper connectivity to the HANA instances, run either of the following scripts:</span></span>
- <span data-ttu-id="89625-281">Pour une configuration de montée en puissance (indépendamment de la charge de travail SAP) :</span><span class="sxs-lookup"><span data-stu-id="89625-281">For a scale-up configuration (independent on SAP workload):</span></span>

 ```
testHANAConnection.pl
```
- <span data-ttu-id="89625-282">Pour une configuration de montée en puissance parallèle :</span><span class="sxs-lookup"><span data-stu-id="89625-282">For a scale-out configuration:</span></span>

 ```
testHANAConnectionBW.pl
```

<span data-ttu-id="89625-283">Assurez-vous que l’instance HANA principale a accès à tous les serveurs HANA requis.</span><span class="sxs-lookup"><span data-stu-id="89625-283">Ensure that the master HANA instance has access to all required HANA servers.</span></span> <span data-ttu-id="89625-284">Il n’existe aucun paramètre pour le script, mais vous devez compléter le fichier HANABackupCustomerDetails/HANABackupCustomerDetailsBW approprié pour que le script s’exécute correctement.</span><span class="sxs-lookup"><span data-stu-id="89625-284">There are no parameters to the script, but you must complete the appropriate HANABackupCustomerDetails/ HANABackupCustomerDetailsBW file for the script to run properly.</span></span> <span data-ttu-id="89625-285">Puisque seuls les codes d’erreur de commande d’environnement sont renvoyés, le script n’est pas en mesure de vérifier l’absence d’erreurs pour chaque instance.</span><span class="sxs-lookup"><span data-stu-id="89625-285">Because only the shell command error codes are returned, it is not possible for the script to error-check every instance.</span></span> <span data-ttu-id="89625-286">Même dans ce cas, le script fournit des commentaires utiles vous permettant de revérifier.</span><span class="sxs-lookup"><span data-stu-id="89625-286">Even so, the script does provide some helpful comments for you to double-check.</span></span>

<span data-ttu-id="89625-287">Pour exécuter le script :</span><span class="sxs-lookup"><span data-stu-id="89625-287">To run the script:</span></span>
```
 ./testHANAConnection.pl
```
 <span data-ttu-id="89625-288">Si le script parvient à obtenir le statut de l’instance HANA, il renvoie un message indiquant que la connexion HANA a réussi.</span><span class="sxs-lookup"><span data-stu-id="89625-288">If the script successfully obtains the status of the HANA instance, it displays a message that the HANA connection was successful.</span></span>

<span data-ttu-id="89625-289">En outre, il existe un second type de script qui vous permet de vérifier la capacité du serveur de l’instance HANA principale à se connecter au stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-289">Additionally, there is a second type of script you can use to check the master HANA instance server's ability to sign in to the storage.</span></span> <span data-ttu-id="89625-290">Avant d’exécuter le script azure\_hana\_backup(\_bw).pl, vous devez exécuter le script suivant.</span><span class="sxs-lookup"><span data-stu-id="89625-290">Before you execute the azure\_hana\_backup(\_bw).pl script, you must execute the next script.</span></span> <span data-ttu-id="89625-291">Si un volume ne comporte aucune capture instantanée, il est impossible de faire la différence entre un volume simplement vide et un échec d’obtention des détails de capture instantanée par le protocole ssh.</span><span class="sxs-lookup"><span data-stu-id="89625-291">If a volume contains no snapshots, it is impossible to determine whether the volume is simply empty or there is an ssh failure to obtain the snapshot details.</span></span> <span data-ttu-id="89625-292">C’est la raison pour laquelle le script exécute deux étapes :</span><span class="sxs-lookup"><span data-stu-id="89625-292">For this reason, the script executes two steps:</span></span>

- <span data-ttu-id="89625-293">Il vérifie que la console de stockage est accessible.</span><span class="sxs-lookup"><span data-stu-id="89625-293">It verifies that the storage console is accessible.</span></span>
- <span data-ttu-id="89625-294">Il crée une capture instantanée de test, ou fictive, pour chaque volume par instance HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-294">It creates a test, or dummy, snapshot for each volume by HANA instance.</span></span>

<span data-ttu-id="89625-295">L’instance HANA est donc incluse en tant qu’argument.</span><span class="sxs-lookup"><span data-stu-id="89625-295">For this reason, the HANA instance is included as an argument.</span></span> <span data-ttu-id="89625-296">Là encore, vous ne pouvez pas vérifier l’absence d’erreurs au niveau de la connexion du stockage, mais le script vous fournit quelques indications utiles si son exécution échoue.</span><span class="sxs-lookup"><span data-stu-id="89625-296">Again, it is not possible to provide error checking for the storage connection, but the script provides helpful hints if the execution fails.</span></span>

<span data-ttu-id="89625-297">Le script est exécuté sous la forme :</span><span class="sxs-lookup"><span data-stu-id="89625-297">The script is run as:</span></span>
```
 ./testStorageSnapshotConnection.pl <hana instance>
```
<span data-ttu-id="89625-298">Ou sous la forme :</span><span class="sxs-lookup"><span data-stu-id="89625-298">Or it is run as:</span></span>
```
./testStorageSnapshotConnectionBW.pl <hana instance>
```
<span data-ttu-id="89625-299">Le script affiche également un message indiquant que vous pouvez vous connecter correctement à votre client de stockage déployé, qui est organisé autour des numéros d’unité logique (LUN) utilisés par les instances de serveur dont vous êtes propriétaire.</span><span class="sxs-lookup"><span data-stu-id="89625-299">The script also displays a message that you are able to sign in appropriately to your deployed storage tenant, which is organized around the logical unit numbers (LUNs) that are used by the server instances you own.</span></span>

<span data-ttu-id="89625-300">Avant d’exécuter les premières sauvegardes basées sur les captures instantanées de stockage, exécutez les scripts suivants pour vous assurer que la configuration est correcte.</span><span class="sxs-lookup"><span data-stu-id="89625-300">Before you execute the first storage snapshot-based backups, run the next scripts to make sure that the configuration is correct.</span></span>

<span data-ttu-id="89625-301">Après avoir exécuté ces scripts, vous pouvez supprimer les captures instantanées en exécutant la commande ci-après :</span><span class="sxs-lookup"><span data-stu-id="89625-301">After running these scripts, you can delete the snapshots by executing:</span></span>
```
./removeTestStorageSnapshot.pl <hana instance>
```
<span data-ttu-id="89625-302">Ou</span><span class="sxs-lookup"><span data-stu-id="89625-302">Or</span></span>
```
./removeTestStorageSnapshot.pl <hana instance>
```

### <a name="step-7-perform-on-demand-snapshots"></a><span data-ttu-id="89625-303">Étape 7 : Effectuer des captures instantanées à la demande</span><span class="sxs-lookup"><span data-stu-id="89625-303">Step 7: Perform on-demand snapshots</span></span>

<span data-ttu-id="89625-304">Effectuez des captures instantanées à la demande (et planifiez des captures instantanées régulières à l’aide de cron) comme décrit ici.</span><span class="sxs-lookup"><span data-stu-id="89625-304">Perform on-demand snapshots (as well as schedule regular snapshots by using cron) as described here.</span></span>

<span data-ttu-id="89625-305">Pour les configurations de montée en puissance, exécutez le script suivant :</span><span class="sxs-lookup"><span data-stu-id="89625-305">For scale-up configurations, execute the following script:</span></span>
```
./azure_hana_backup.pl lhanad01 customer 20
```
<span data-ttu-id="89625-306">Pour les configurations de montée en puissance parallèle, exécutez le script suivant :</span><span class="sxs-lookup"><span data-stu-id="89625-306">For scale-out configurations, execute the following script:</span></span>
```
./azure_hana_backup_bw.pl lhanad01 customer 20
```
<span data-ttu-id="89625-307">Le script de montée en puissance parallèle effectue certaines vérifications supplémentaires pour contrôler que tous les serveurs HANA sont accessibles, et que toutes les instances HANA renvoient le statut d’instance approprié, avant de procéder à la création de captures instantanées SAP HANA ou de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-307">The scale-out script does some additional checking to make sure that all HANA servers can be accessed, and all HANA instances return appropriate status of the instance before proceeding with creating SAP HANA or storage snapshots.</span></span>

<span data-ttu-id="89625-308">Les arguments requis sont les suivants :</span><span class="sxs-lookup"><span data-stu-id="89625-308">The following arguments are required:</span></span>

- <span data-ttu-id="89625-309">Instance HANA nécessitant une sauvegarde</span><span class="sxs-lookup"><span data-stu-id="89625-309">The HANA instance requiring backup.</span></span>
- <span data-ttu-id="89625-310">Préfixe de capture instantanée pour la capture instantanée de stockage</span><span class="sxs-lookup"><span data-stu-id="89625-310">The snapshot prefix for the storage snapshot.</span></span>
- <span data-ttu-id="89625-311">Nombre de captures instantanées à conserver pour le préfixe spécifique</span><span class="sxs-lookup"><span data-stu-id="89625-311">The number of snapshots to be kept for the specific prefix.</span></span>

```
./azure_hana_backup.pl lhanad01 customer 20
```

<span data-ttu-id="89625-312">L’exécution du script crée la capture instantanée de stockage à l’aide de trois phases distinctes :</span><span class="sxs-lookup"><span data-stu-id="89625-312">The execution of the script creates the storage snapshot in these three distinct phases:</span></span>

- <span data-ttu-id="89625-313">Exécution d’une capture instantanée HANA</span><span class="sxs-lookup"><span data-stu-id="89625-313">Execute a HANA snapshot.</span></span>
- <span data-ttu-id="89625-314">Exécution d’une capture instantanée de stockage</span><span class="sxs-lookup"><span data-stu-id="89625-314">Execute a storage snapshot.</span></span>
- <span data-ttu-id="89625-315">Suppression de la capture instantanée HANA</span><span class="sxs-lookup"><span data-stu-id="89625-315">Remove the HANA snapshot.</span></span>

<span data-ttu-id="89625-316">Exécutez le script en l’appelant à partir du dossier exécutable HDB dans lequel il a été copié.</span><span class="sxs-lookup"><span data-stu-id="89625-316">Execute the script by calling it from the HDB executable folder that it was copied to.</span></span> <span data-ttu-id="89625-317">Il sauvegarde au moins les volumes ci-après, mais également tous les volumes dont le nom comporte le nom de l’instance SAP HANA explicite.</span><span class="sxs-lookup"><span data-stu-id="89625-317">It backs up at least the following volumes, but it also backs up any volume that has the explicit SAP HANA instance name in the volume name.</span></span>
```
hana_data_<hana instance>_prod_t020_vol
hana_log_<hana instance>_prod_t020_vol
hana_log_backup_<hana instance>_prod_t020_vol
hana_shared_<hana instance>_prod_t020_vol
```
<span data-ttu-id="89625-318">La période de rétention est strictement administrée avec le nombre de captures instantanées soumis sous la forme d’un paramètre lorsque vous exécutez le script (par exemple 20, comme indiqué précédemment).</span><span class="sxs-lookup"><span data-stu-id="89625-318">The retention period is strictly administered, with the number of snapshots submitted as a parameter when you execute the script (such as 20, shown previously).</span></span> <span data-ttu-id="89625-319">Par conséquent, la durée est tributaire de la période d’exécution et du nombre de captures instantanées dans l’appel du script.</span><span class="sxs-lookup"><span data-stu-id="89625-319">So the amount of time is a function of the period of execution and the number of snapshots in the call of the script.</span></span> <span data-ttu-id="89625-320">Si le nombre de captures instantanées conservées dépasse le nombre spécifié en tant que paramètre dans l’appel du script, la plus ancienne capture instantanée de stockage portant cette étiquette (dans notre cas précédent, _custom_) est supprimée avant l’exécution d’une nouvelle capture instantanée.</span><span class="sxs-lookup"><span data-stu-id="89625-320">If the number of snapshots that are kept exceeds the number that are named as a parameter in the call of the script, the oldest storage snapshot of this label (in our previous case, _custom_) is deleted before a new snapshot is executed.</span></span> <span data-ttu-id="89625-321">Cela signifie que le nombre que vous indiquez comme dernier paramètre de l’appel correspond au nombre que vous pouvez utiliser pour contrôler le nombre de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-321">This means the number you give as the last parameter of the call is the number you can use to control the number of snapshots.</span></span>

>[!NOTE]
><span data-ttu-id="89625-322">Dès que vous modifiez l’étiquette, le comptage redémarre.</span><span class="sxs-lookup"><span data-stu-id="89625-322">As soon as you change the label, the counting starts again.</span></span>

<span data-ttu-id="89625-323">Vous devez inclure le nom d’instance HANA fourni en tant qu’argument par l’équipe de gestion des services SAP HANA sur Azure, si cette équipe crée des captures instantanées d’environnements à plusieurs nœuds.</span><span class="sxs-lookup"><span data-stu-id="89625-323">You need to include the HANA instance name that's provided by SAP HANA on Azure Service Management as an argument if they are creating snapshots in multi-node environments.</span></span> <span data-ttu-id="89625-324">Dans les environnements à nœud unique, l’indication du nom de l’unité SAP HANA sur Azure (grandes instances) suffit, mais la spécification du nom de l’instance HANA reste recommandée.</span><span class="sxs-lookup"><span data-stu-id="89625-324">In single-node environments, the name of the SAP HANA on Azure (large instances) unit is sufficient, but the HANA instance name is still recommended.</span></span>

<span data-ttu-id="89625-325">En outre, vous pouvez sauvegarder des volumes\numéros d’unité logique de démarrage à l’aide du même script.</span><span class="sxs-lookup"><span data-stu-id="89625-325">Additionally, you can back up boot volumes\LUNs by using the same script.</span></span> <span data-ttu-id="89625-326">Vous devez sauvegarder votre volume de démarrage au moins une fois lorsque vous exécutez HANA pour la première fois, bien que nous recommandions une planification de sauvegarde hebdomadaire ou nocturne pour le démarrage dans cron.</span><span class="sxs-lookup"><span data-stu-id="89625-326">You must back up your boot volume at least once when you first run HANA, although we recommend a weekly or nightly backup schedule for booting in cron.</span></span> <span data-ttu-id="89625-327">Au lieu d’ajouter un nom d’instance SAP HANA, insérez _boot_ en tant qu’argument dans le script, comme ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="89625-327">Rather than add an SAP HANA instance name, insert _boot_ as the argument into the script as follows:</span></span>
```
./azure_hana_backup boot customer 20
```
<span data-ttu-id="89625-328">La même stratégie de rétention est également associée au volume de démarrage.</span><span class="sxs-lookup"><span data-stu-id="89625-328">The same retention policy is afforded to the boot volume as well.</span></span> <span data-ttu-id="89625-329">Comme indiqué ci-dessus, les captures instantanées à la demande ne doivent être utilisées que pour des cas spéciaux, par exemple, au cours d’une mise à niveau par le biais d’un package d’extension (EHP) SAP ou lorsque vous devez créer une capture instantanée de stockage distincte.</span><span class="sxs-lookup"><span data-stu-id="89625-329">Use on-demand snapshots, as described previously, for special cases only, such as during an SAP enhancement package (EHP) upgrade, or when you need to create a distinct storage snapshot.</span></span>

<span data-ttu-id="89625-330">Nous vous encourageons à effectuer des captures instantanées de stockage planifiées à l’aide de cron, et d’utiliser le même script pour la totalité des sauvegardes et des besoins en matière de récupération d’urgence (en modifiant les entrées du script en fonction des différentes heures de sauvegarde demandées).</span><span class="sxs-lookup"><span data-stu-id="89625-330">We encourage you to perform scheduled storage snapshots using cron, and we recommend that you use the same script for all backups and disaster-recovery needs (modifying the script inputs to match the various requested backup times).</span></span> <span data-ttu-id="89625-331">Ces captures sont toutes planifiées différemment dans cron selon leur durée d’exécution : toutes les heures, toutes les 12 heures, une fois par jour ou une fois par semaine.</span><span class="sxs-lookup"><span data-stu-id="89625-331">These are all scheduled differently in cron depending on their execution time: hourly, 12-hour, daily, or weekly.</span></span> <span data-ttu-id="89625-332">La planification cron est destinée à créer des captures instantanées de stockage qui correspondent à l’étiquetage de rétention précédemment décrit pour la sauvegarde hors site à long terme.</span><span class="sxs-lookup"><span data-stu-id="89625-332">The cron schedule is designed to create storage snapshots that match the previously discussed retention labeling for long-term off-site backup.</span></span> <span data-ttu-id="89625-333">Le script inclut des commandes demandant la sauvegarde de tous les volumes de production en fonction de la fréquence requise (les données et les fichiers journaux sont sauvegardés toutes les heures, tandis que le volume de démarrage est sauvegardé une fois par jour).</span><span class="sxs-lookup"><span data-stu-id="89625-333">The script includes commands to back up all production volumes, depending on their requested frequency (data and log files are backed up hourly, whereas the boot volume is backed up daily).</span></span>

<span data-ttu-id="89625-334">Les entrées du script cron ci-après s’exécutent toutes les heures à la dixième minute, toutes les 12 heures à la dixième minute et une fois par jour à la dixième minute.</span><span class="sxs-lookup"><span data-stu-id="89625-334">The entries in the following cron script run every hour at the tenth minute, every 12 hours at the tenth minute, and daily at the tenth minute.</span></span> <span data-ttu-id="89625-335">Les travaux cron sont créés de façon à n’effectuer qu’une seule capture instantanée de stockage SAP HANA au cours d’une heure donnée, afin que les sauvegardes effectuées une fois par heure et une fois par jour ne se produisent pas à la même heure (12h10).</span><span class="sxs-lookup"><span data-stu-id="89625-335">The cron jobs are created in such a way that only one SAP HANA storage snapshot takes place during any particular hour, so that the hourly and daily backups do not occur at the same time (12:10 AM).</span></span> <span data-ttu-id="89625-336">Pour optimiser votre processus de création et de réplication de captures instantanées, l’équipe de gestion des services SAP HANA sur Azure vous indique l’heure d’exécution recommandée pour vos sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="89625-336">To help optimize your snapshot creation and replication, SAP HANA on Azure Service Management provides the recommended time for you to run your backups.</span></span>

<span data-ttu-id="89625-337">La planification cron par défaut dans /etc/crontab est la suivante :</span><span class="sxs-lookup"><span data-stu-id="89625-337">The default cron scheduling in /etc/crontab is as follows:</span></span>
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 14
```
<span data-ttu-id="89625-338">Dans les instructions cron précédentes, les volumes HANA (sans le volume de démarrage) font l’objet d’une capture instantanée toutes les heures avec l’étiquette « hourly ».</span><span class="sxs-lookup"><span data-stu-id="89625-338">In the previous cron instructions, the HANA volumes (without boot volume) get an hourly snapshot with the label.</span></span> <span data-ttu-id="89625-339">66 de ces captures instantanées sont conservées.</span><span class="sxs-lookup"><span data-stu-id="89625-339">Of these snapshots, 66 are retained.</span></span> <span data-ttu-id="89625-340">En outre, 14 captures instantanées portant l’étiquette 12 heures sont conservées.</span><span class="sxs-lookup"><span data-stu-id="89625-340">Additionally, 14 snapshots with the 12-hour label are retained.</span></span> <span data-ttu-id="89625-341">Vous obtenez potentiellement des captures instantanées toutes les heures pendant trois jours, plus des captures instantanées toutes les 12 heures pendant quatre autres jours, soit une semaine complète de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-341">You potentially get hourly snapshots for three days, plus 12-hour snapshots for another four days, which gives you an entire week of snapshots.</span></span>

<span data-ttu-id="89625-342">La planification dans cron peut se révéler complexe car un seul script doit être exécuté à une heure donnée, à moins que le script ne soit décalé de plusieurs minutes.</span><span class="sxs-lookup"><span data-stu-id="89625-342">Scheduling within cron can be tricky, because only one script should be executed at any particular time, unless the scripts are staggered by several minutes.</span></span> <span data-ttu-id="89625-343">Si vous souhaitez effectuer des sauvegardes quotidiennes pour une rétention à long terme, soit une capture instantanée quotidienne est conservée avec une capture instantanée effectuée toutes les 12 heures (avec une valeur de rétention de sept pour chacune d’elles), soit la capture instantanée effectuée une fois par heure est décalée pour survenir 10 minutes plus tard.</span><span class="sxs-lookup"><span data-stu-id="89625-343">If you want daily backups for long-term retention, either a daily snapshot is kept along with a 12-hour snapshot (with a retention count of seven each), or the hourly snapshot is staggered to take place 10 minutes later.</span></span> <span data-ttu-id="89625-344">Une seule capture instantanée quotidienne est conservée dans le volume de production.</span><span class="sxs-lookup"><span data-stu-id="89625-344">Only one daily snapshot is kept in the production volume.</span></span>
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 7
10 0 * * * ./azure_hana_backup.pl lhanad01 daily 7
```
<span data-ttu-id="89625-345">Ici, les fréquences sont fournies uniquement à titre d’exemple.</span><span class="sxs-lookup"><span data-stu-id="89625-345">The frequencies listed here are only examples.</span></span> <span data-ttu-id="89625-346">Pour déterminer votre nombre optimal de captures instantanées, utilisez les critères suivants :</span><span class="sxs-lookup"><span data-stu-id="89625-346">To derive your optimum number of snapshots, use the following criteria:</span></span>

- <span data-ttu-id="89625-347">Exigences en matière d’objectif de délai de récupération pour une récupération dans le temps.</span><span class="sxs-lookup"><span data-stu-id="89625-347">Requirements in recovery time objective for point-in-time recovery.</span></span>
- <span data-ttu-id="89625-348">Utilisation de l’espace</span><span class="sxs-lookup"><span data-stu-id="89625-348">Space usage.</span></span>
- <span data-ttu-id="89625-349">Exigences en matière d’objectif de point de récupération et d’objectif de délai de récupération pour une récupération d’urgence potentielle.</span><span class="sxs-lookup"><span data-stu-id="89625-349">Requirements in recovery point objective and recovery time objective for potential disaster recovery.</span></span>
- <span data-ttu-id="89625-350">Exécution de sauvegardes de base de données complètes HANA pour les disques.</span><span class="sxs-lookup"><span data-stu-id="89625-350">Eventual execution of HANA full database backups against disks.</span></span> <span data-ttu-id="89625-351">Chaque fois qu’une sauvegarde de base de données complète sera effectuée pour les disques, ou pour l’interface _backint_, l’exécution de captures instantanées de stockage échoue.</span><span class="sxs-lookup"><span data-stu-id="89625-351">Whenever a full database backup against disks, or _backint_ interface, is performed, the execution of storage snapshots fails.</span></span> <span data-ttu-id="89625-352">Si vous prévoyez d’exécuter des sauvegardes de base de données complètes reposant sur des captures instantanées de stockage, assurez-vous que l’exécution des captures instantanées de stockage est désactivée pendant cette période.</span><span class="sxs-lookup"><span data-stu-id="89625-352">If you plan to execute full database backups on top of storage snapshots, make sure that the execution of storage snapshots is disabled during this time.</span></span>

>[!IMPORTANT]
> <span data-ttu-id="89625-353">L’utilisation de captures instantanées de stockage pour les sauvegardes SAP HANA est uniquement valide lorsque ces captures sont effectuées conjointement avec des sauvegardes de journaux SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-353">The use of storage snapshots for SAP HANA backups is valid only when the snapshots are performed in conjunction with SAP HANA log backups.</span></span> <span data-ttu-id="89625-354">Ces sauvegardes de journaux doivent pouvoir couvrir les périodes qui s’écoulent entre les captures instantanées de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-354">These log backups need to be able to cover the time periods between the storage snapshots.</span></span> <span data-ttu-id="89625-355">Si vous vous êtes engagé envers les utilisateurs à assurer une récupération jusqu’à une date et heure remontant à 30 jours, vous devez disposer des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="89625-355">If you've set a commitment to users of a point-in-time recovery of 30 days, you need the following:</span></span>

- <span data-ttu-id="89625-356">Possibilité d’accès à une capture instantanée de stockage datant de 30 jours.</span><span class="sxs-lookup"><span data-stu-id="89625-356">Ability to access a storage snapshot that is 30 days old.</span></span>
- <span data-ttu-id="89625-357">Sauvegardes de journaux contiguës sur les 30 derniers jours</span><span class="sxs-lookup"><span data-stu-id="89625-357">Contiguous log backups over the last 30 days.</span></span>

<span data-ttu-id="89625-358">Dans la plage des sauvegardes de journaux, créez également une capture instantanée du volume de sauvegarde des journaux.</span><span class="sxs-lookup"><span data-stu-id="89625-358">In the range of log backups, create a snapshot of the backup log volume as well.</span></span> <span data-ttu-id="89625-359">Toutefois, veillez à sauvegarder régulièrement les journaux afin de pouvoir :</span><span class="sxs-lookup"><span data-stu-id="89625-359">However, be sure to perform regular log backups so that you can:</span></span>

- <span data-ttu-id="89625-360">Disposer des sauvegardes de journaux contiguës nécessaires pour l’exécution de récupérations jusqu’à une date et heure</span><span class="sxs-lookup"><span data-stu-id="89625-360">Have the contiguous log backups needed to perform point-in-time recoveries.</span></span>
- <span data-ttu-id="89625-361">Éviter que le volume de journaux SAP HANA manque d’espace.</span><span class="sxs-lookup"><span data-stu-id="89625-361">Prevent the SAP HANA log volume from running out of space.</span></span>

<span data-ttu-id="89625-362">L’une des dernières étapes consiste à planifier les sauvegardes de journaux SAP HANA dans SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="89625-362">One of the last steps is to schedule SAP HANA backup logs in SAP HANA Studio.</span></span> <span data-ttu-id="89625-363">La destination cible des sauvegardes de journaux SAP HANA est le volume hana/log\_backups spécialement créé avec le point de montage de /hana/log/backups.</span><span class="sxs-lookup"><span data-stu-id="89625-363">The SAP HANA backup log target destination is the specially created hana/log\_backups volume with the mount point of /hana/log/backups.</span></span>

![Planifier les sauvegardes de journaux SAP HANA dans SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

<span data-ttu-id="89625-365">Vous pouvez choisir d’effectuer des sauvegardes plus fréquemment que toutes les 15 minutes.</span><span class="sxs-lookup"><span data-stu-id="89625-365">You can choose backups that are more frequent than every 15 minutes.</span></span> <span data-ttu-id="89625-366">Certains utilisateurs effectuent même des sauvegardes de journaux toutes les minutes, mais un intervalle _supérieur_ à 15 minutes est déconseillé.</span><span class="sxs-lookup"><span data-stu-id="89625-366">Some users even perform log backups every minute, although we do not recommend going _over_ 15 minutes.</span></span>

<span data-ttu-id="89625-367">La dernière étape consiste à effectuer une sauvegarde basée sur un fichier (après l’installation initiale de SAP HANA) afin de créer une entrée de sauvegarde unique devant figurer dans le catalogue de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="89625-367">The final step is to perform a file-based backup (after the initial installation of SAP HANA) to create a single backup entry that must exist within the backup catalog.</span></span> <span data-ttu-id="89625-368">Dans le cas contraire, SAP HANA ne peut pas lancer vos sauvegardes de journaux spécifiées.</span><span class="sxs-lookup"><span data-stu-id="89625-368">Otherwise SAP HANA cannot initiate your specified log backups.</span></span>

![Créer une sauvegarde basée sur un fichier pour créer une entrée de sauvegarde unique](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)

### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a><span data-ttu-id="89625-370">Surveillance du nombre et de la taille des captures instantanées sur le volume de disque</span><span class="sxs-lookup"><span data-stu-id="89625-370">Monitoring the number and size of snapshots on the disk volume</span></span>

<span data-ttu-id="89625-371">Sur un volume de stockage spécifique, vous pouvez surveiller le nombre de captures instantanées et l’espace de stockage consommé par ces captures.</span><span class="sxs-lookup"><span data-stu-id="89625-371">On a particular storage volume, you can monitor the number of snapshots and the storage consumption of snapshots.</span></span> <span data-ttu-id="89625-372">La commande `ls` n’affiche pas le répertoire des captures instantanées ni les fichiers.</span><span class="sxs-lookup"><span data-stu-id="89625-372">The `ls` command doesn't show the snapshot directory or files.</span></span> <span data-ttu-id="89625-373">En revanche, la commande `du` du système d’exploitation Linux affiche ces informations à l’aide des commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="89625-373">However, the Linux OS command `du` does, with the following commands:</span></span>

- <span data-ttu-id="89625-374">`du –sh .snapshot` fournit le total des captures instantanées au sein du répertoire de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-374">`du –sh .snapshot` provides a total of all snapshots within the snapshot directory.</span></span>
- <span data-ttu-id="89625-375">`du –sh --max-depth=1` répertorie toutes les captures instantanées enregistrées dans le dossier .snapshot et la taille de chaque capture instantanée.</span><span class="sxs-lookup"><span data-stu-id="89625-375">`du –sh --max-depth=1` lists all snapshots that are saved in the .snapshot folder and the size of each snapshot.</span></span>
- <span data-ttu-id="89625-376">`du –hc` fournit la taille totale utilisée par toutes les captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-376">`du –hc` provides the total size used by all snapshots.</span></span>

<span data-ttu-id="89625-377">Utilisez ces commandes pour vous assurer que les captures instantanées créées et stockées ne consomment pas la totalité du stockage sur les volumes.</span><span class="sxs-lookup"><span data-stu-id="89625-377">Use these commands to make sure that the snapshots that are taken and stored are not consuming all the storage on the volumes.</span></span>

### <a name="reducing-the-number-of-snapshots-on-a-server"></a><span data-ttu-id="89625-378">Réduction du nombre de captures instantanées sur un serveur</span><span class="sxs-lookup"><span data-stu-id="89625-378">Reducing the number of snapshots on a server</span></span>

<span data-ttu-id="89625-379">Comme expliqué précédemment, vous pouvez réduire le nombre de captures instantanées stockées portant une certaine étiquette.</span><span class="sxs-lookup"><span data-stu-id="89625-379">As explained earlier, you can reduce the number of certain labels of snapshots that you store.</span></span> <span data-ttu-id="89625-380">Les deux derniers paramètres de la commande permettant de lancer une capture instantanée correspondent à une étiquette et au nombre de captures instantanées à conserver.</span><span class="sxs-lookup"><span data-stu-id="89625-380">The last two parameters of the command to initiate a snapshot are a label and the number of snapshots you want to retain.</span></span>
```
./azure_hana_backup.pl lhanad01 customer 20
```
<span data-ttu-id="89625-381">Dans l’exemple précédent, la capture instantanée présente l’étiquette _customer_, et le nombre de captures instantanées dotées de cette étiquette qui doivent être conservées est de _20_.</span><span class="sxs-lookup"><span data-stu-id="89625-381">In the previous example, the snapshot label is _customer_ and the number of snapshots with this label to be retained is _20_.</span></span> <span data-ttu-id="89625-382">Afin de faire face au problème de la consommation d’espace disque, vous pouvez vouloir réduire le nombre de captures instantanées stockées.</span><span class="sxs-lookup"><span data-stu-id="89625-382">As you respond to disk space consumption, you might want to reduce the number of stored snapshots.</span></span> <span data-ttu-id="89625-383">Un moyen simple de réduire le nombre de captures instantanées consiste à exécuter le script en définissant le dernier paramètre sur la valeur 5 :</span><span class="sxs-lookup"><span data-stu-id="89625-383">The easy way to reduce the number of snapshots is to run the script with the last parameter set to 5:</span></span>
```
./azure_hana_backup.pl lhanad01 customer 5
```
<span data-ttu-id="89625-384">L’exécution du script défini à l’aide de ce paramètre abaisse le nombre total de captures instantanées à _5_, y compris la nouvelle capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-384">As a result of running the script with this setting, the number of snapshots, including the new storage snapshot, is _5_.</span></span>

 >[!NOTE]
 > <span data-ttu-id="89625-385">Ce script réduit le nombre de captures instantanées uniquement si la capture instantanée la plus récente date de plus d’une heure.</span><span class="sxs-lookup"><span data-stu-id="89625-385">This script reduces the number of snapshots only if the most recent previous snapshot is more than one hour old.</span></span> <span data-ttu-id="89625-386">Le script ne supprime pas les captures instantanées datant de moins d’une heure.</span><span class="sxs-lookup"><span data-stu-id="89625-386">The script does not delete snapshots that are less than one hour old.</span></span>

<span data-ttu-id="89625-387">Ces restrictions sont associées à la fonctionnalité de récupération d’urgence facultative offerte.</span><span class="sxs-lookup"><span data-stu-id="89625-387">These restrictions are related to the optional disaster-recovery functionality offered.</span></span>

<span data-ttu-id="89625-388">Si vous ne souhaitez plus conserver un ensemble de captures instantanées portant ce préfixe, vous pouvez exécuter le script en définissant _0_ comme valeur de rétention afin de supprimer toutes les captures instantanées correspondant à ce préfixe.</span><span class="sxs-lookup"><span data-stu-id="89625-388">If you no longer want to maintain a set of snapshots with that prefix, you can execute the script with _0_ as the retention number to remove all snapshots matching that prefix.</span></span> <span data-ttu-id="89625-389">Toutefois, la suppression de toutes les captures instantanées aura une incidence sur les possibilités de récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="89625-389">However, removing all snapshots can affect the capabilities of disaster recovery.</span></span>

### <a name="recovering-to-the-most-recent-hana-snapshot"></a><span data-ttu-id="89625-390">Récupération jusqu’à la capture instantanée HANA la plus récente</span><span class="sxs-lookup"><span data-stu-id="89625-390">Recovering to the most recent HANA snapshot</span></span>

<span data-ttu-id="89625-391">Si vous devez faire face à une interruption de la production, le processus de récupération à partir d’une capture instantanée de stockage peut être lancé sous la forme d’un incident client auprès de l’équipe de gestion des services SAP HANA sur Azure.</span><span class="sxs-lookup"><span data-stu-id="89625-391">In the event that you experience a production-down scenario, the process of recovering from a storage snapshot can be initiated as a customer incident with SAP HANA on Azure Service Management.</span></span> <span data-ttu-id="89625-392">Un tel scénario inattendu peut constituer un problème de la plus haute urgence si des données sont supprimées d’un système de production et que le seul moyen de les récupérer consiste à restaurer la base de données de production.</span><span class="sxs-lookup"><span data-stu-id="89625-392">Such an unexpected scenario might be a high-urgency matter if data was deleted in a production system and the only way to retrieve the data is to restore the production database.</span></span>

<span data-ttu-id="89625-393">En revanche, une récupération jusqu’à une date et heure peut ne pas avoir de caractère d’urgence et être planifiée plusieurs jours à l’avance.</span><span class="sxs-lookup"><span data-stu-id="89625-393">On the other hand, a point-in-time recovery could be low urgency and planned for days in advance.</span></span> <span data-ttu-id="89625-394">Vous pouvez planifier cette récupération avec l’équipe de gestion des services SAP HANA sur Azure au lieu de signaler un problème hautement prioritaire.</span><span class="sxs-lookup"><span data-stu-id="89625-394">You can plan this recovery with SAP HANA on Azure Service Management instead of raising a high-priority issue.</span></span> <span data-ttu-id="89625-395">Par exemple, vous pourriez envisager de tester une mise à niveau du logiciel SAP en appliquant un nouveau package d’extension, puis vouloir ensuite revenir à une capture instantanée correspondant à l’état du système avant sa mise à niveau par le package d’extension.</span><span class="sxs-lookup"><span data-stu-id="89625-395">For example, you might be planning to try an upgrade of the SAP software by applying a new enhancement package, and you then need to revert back to a snapshot that represents the state before the EHP upgrade.</span></span>

<span data-ttu-id="89625-396">Avant d’émettre la requête, vous devez effectuer certaines tâches de préparation.</span><span class="sxs-lookup"><span data-stu-id="89625-396">Before you issue the request, you need to do some preparation.</span></span> <span data-ttu-id="89625-397">L’équipe de gestion des services SAP HANA sur Azure peut alors traiter la demande et fournir les volumes restaurés.</span><span class="sxs-lookup"><span data-stu-id="89625-397">SAP HANA on Azure Service Management team can then handle the request and provide the restored volumes.</span></span> <span data-ttu-id="89625-398">Il vous incombera ensuite de restaurer la base de données HANA à l’aide des captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="89625-398">Afterward, it is up to you to restore the HANA database based on the snapshots.</span></span> <span data-ttu-id="89625-399">Voici comment se préparer pour émettre la requête :</span><span class="sxs-lookup"><span data-stu-id="89625-399">Here is how to prepare for the request:</span></span>

>[!NOTE]
><span data-ttu-id="89625-400">Votre interface utilisateur peut être différente des captures d’écran suivantes, selon la version de SAP HANA que vous utilisez.</span><span class="sxs-lookup"><span data-stu-id="89625-400">Your user interface might vary from the following screenshots, depending on the SAP HANA release you are using.</span></span>

1. <span data-ttu-id="89625-401">Déterminez la capture instantanée à restaurer.</span><span class="sxs-lookup"><span data-stu-id="89625-401">Decide which snapshot to restore.</span></span> <span data-ttu-id="89625-402">Sauf indication contraire, seul le volume hana/data est restauré.</span><span class="sxs-lookup"><span data-stu-id="89625-402">Only the hana/data volume would be restored unless you are instructed otherwise.</span></span>

2. <span data-ttu-id="89625-403">Arrêtez l’instance HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-403">Shut down the HANA instance.</span></span>

 ![Arrêter l’instance HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

3. <span data-ttu-id="89625-405">Démontez les volumes de données sur chaque nœud de base de données HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-405">Unmount the data volumes on each HANA database node.</span></span> <span data-ttu-id="89625-406">La restauration de la capture instantanée échoue si les volumes de données ne sont pas démontés.</span><span class="sxs-lookup"><span data-stu-id="89625-406">The restoration of the snapshot fails if the data volumes are not unmounted.</span></span>

 ![Démonter les volumes de données sur chaque nœud de base de données HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

4. <span data-ttu-id="89625-408">Ouvrez une demande de support Azure pour demander la restauration d’une capture instantanée spécifique.</span><span class="sxs-lookup"><span data-stu-id="89625-408">Open an Azure support request to instruct the restoration of a specific snapshot.</span></span>

 - <span data-ttu-id="89625-409">Lors de la restauration : l’équipe de gestion des services SAP HANA sur Azure peut vous demander de participer à une téléconférence pour s’assurer qu’aucune donnée n’est perdue.</span><span class="sxs-lookup"><span data-stu-id="89625-409">During the restoration: SAP HANA on Azure Service Management might ask you to attend a conference call to ensure that no data is getting lost.</span></span>

 - <span data-ttu-id="89625-410">Après la restauration : l’équipe de gestion des services SAP HANA sur Azure vous informe lorsque la capture instantanée de stockage a été restaurée.</span><span class="sxs-lookup"><span data-stu-id="89625-410">After the restoration: SAP HANA on Azure Service Management notifies you when the storage snapshot has been restored.</span></span>

5. <span data-ttu-id="89625-411">Une fois le processus de restauration terminé, remontez tous les volumes de données.</span><span class="sxs-lookup"><span data-stu-id="89625-411">After the restoration process is complete, remount all data volumes.</span></span>

 ![Remonter tous les volumes de données](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)

6. <span data-ttu-id="89625-413">Sélectionnez les options de récupération dans SAP HANA Studio, si ces options ne s’affichent pas automatiquement lorsque vous vous reconnectez à la base de données HANA par le biais de SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="89625-413">Select recovery options within SAP HANA Studio, if they do not automatically come up when you reconnect to HANA DB through SAP HANA Studio.</span></span> <span data-ttu-id="89625-414">L’exemple ci-après illustre une restauration à partir de la dernière capture instantanée HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-414">The following example shows a restoration to the last HANA snapshot.</span></span> <span data-ttu-id="89625-415">Une capture instantanée de stockage incorpore une capture instantanée HANA. Si vous effectuez la restauration à partir de la capture instantanée de stockage la plus récente, il doit s’agir de la capture instantanée HANA la plus récente.</span><span class="sxs-lookup"><span data-stu-id="89625-415">A storage snapshot embeds one HANA snapshot, and if you are restoring to the most recent storage snapshot, it should be the most recent HANA snapshot.</span></span> <span data-ttu-id="89625-416">(Si vous effectuez une restauration à partir de captures instantanées de stockage antérieures, vous devez localiser la capture instantanée HANA correspondante en vous basant sur l’heure de création de la capture instantanée de stockage.)</span><span class="sxs-lookup"><span data-stu-id="89625-416">(If you are restoring to older storage snapshots, you need to locate the HANA snapshot based on the time the storage snapshot was taken.)</span></span>

 ![Sélectionner les options de récupération dans SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image10-recover-options-a.png)

7. <span data-ttu-id="89625-418">Sélectionnez l’option **Recover the database to a specific data backup or storage snapshot (Récupérer la base de données jusqu’à une sauvegarde de données ou une capture instantanée de stockage spécifiques)**.</span><span class="sxs-lookup"><span data-stu-id="89625-418">Select **Recover the database to a specific data backup or storage snapshot**.</span></span>

 ![Fenêtre de sélection du type de récupération](./media/hana-overview-high-availability-disaster-recovery/image11-recover-options-b.png)

8. <span data-ttu-id="89625-420">Sélectionnez l’option de **spécification d’une sauvegarde sans catalogue**.</span><span class="sxs-lookup"><span data-stu-id="89625-420">Select **Specify backup without catalog**.</span></span>

 ![Fenêtre de spécification de l’emplacement de sauvegarde](./media/hana-overview-high-availability-disaster-recovery/image12-recover-options-c.png)

9. <span data-ttu-id="89625-422">Dans la liste **Type de destination**, sélectionnez **Instantané**.</span><span class="sxs-lookup"><span data-stu-id="89625-422">In the **Destination Type** list, select **Snapshot**.</span></span>

 ![Fenêtre de spécification de la sauvegarde à récupérer](./media/hana-overview-high-availability-disaster-recovery/image13-recover-options-d.png)

10. <span data-ttu-id="89625-424">Cliquez sur **Finish (Terminer)** pour démarrer le processus de récupération.</span><span class="sxs-lookup"><span data-stu-id="89625-424">Click **Finish** to start the recovery process.</span></span>

 ![Cliquer sur Finish (Terminer) pour démarrer le processus de récupération](./media/hana-overview-high-availability-disaster-recovery/image14-recover-options-e.png)

11. <span data-ttu-id="89625-426">La base de données HANA est restaurée et récupérée à partir de la capture instantanée HANA incluse dans la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-426">The HANA database is restored and recovered to the HANA snapshot that's included in the storage snapshot.</span></span>

 ![Base de données HANA restaurée et récupérée dans la capture instantanée de stockage](./media/hana-overview-high-availability-disaster-recovery/image15-recover-options-f.png)

### <a name="recovering-to-the-most-recent-state"></a><span data-ttu-id="89625-428">Récupération jusqu’à l’état le plus récent</span><span class="sxs-lookup"><span data-stu-id="89625-428">Recovering to the most recent state</span></span>

<span data-ttu-id="89625-429">Le processus suivant restaure la capture instantanée HANA incluse dans la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-429">The following process restores the HANA snapshot that is included in the storage snapshot.</span></span> <span data-ttu-id="89625-430">Il restaure ensuite les sauvegardes des journaux de transactions à l’état le plus récent de la base de données avant de restaurer la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-430">It then restores the transaction log backups to the most recent state of the database before restoring the storage snapshot.</span></span>

>[!IMPORTANT]
><span data-ttu-id="89625-431">Avant de poursuivre, assurez-vous que vous disposez d’une chaîne complète et contiguë de sauvegardes de journaux des transactions.</span><span class="sxs-lookup"><span data-stu-id="89625-431">Before you proceed, make sure that you have a complete and contiguous chain of transaction log backups.</span></span> <span data-ttu-id="89625-432">Sans ces sauvegardes, vous ne pouvez pas restaurer l’état actuel de la base de données.</span><span class="sxs-lookup"><span data-stu-id="89625-432">Without these backups, you cannot restore the current state of the database.</span></span>

1. <span data-ttu-id="89625-433">Effectuez les étapes 1 à 6 de la procédure précédente « Récupération jusqu’à la capture instantanée HANA la plus récente ».</span><span class="sxs-lookup"><span data-stu-id="89625-433">Complete steps 1-6 of the preceding procedure in "Recovering to the most recent HANA snapshot."</span></span>

2. <span data-ttu-id="89625-434">Sélectionnez l’option de **récupération de la base de données jusqu’à son état le plus récent**.</span><span class="sxs-lookup"><span data-stu-id="89625-434">Select **Recover the database to its most recent state**.</span></span>

 ![Sélectionner l’option de « récupération de la base de données jusqu’à son état le plus récent »](./media/hana-overview-high-availability-disaster-recovery/image16-recover-database-a.png)

3. <span data-ttu-id="89625-436">Spécifiez l’emplacement des dernières sauvegardes de journaux HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-436">Specify the location of the most recent HANA log backups.</span></span> <span data-ttu-id="89625-437">L’emplacement doit contenir toutes les sauvegardes des journaux de transactions HANA entre la capture instantanée HANA et l’état le plus récent.</span><span class="sxs-lookup"><span data-stu-id="89625-437">The location needs to contain all HANA transaction log backups from the HANA snapshot to the most recent state.</span></span>

 ![Spécifier l’emplacement des dernières sauvegardes de journaux HANA](./media/hana-overview-high-availability-disaster-recovery/image17-recover-database-b.png)

4. <span data-ttu-id="89625-439">Sélectionnez une sauvegarde comme base pour la récupération de la base de données.</span><span class="sxs-lookup"><span data-stu-id="89625-439">Select a backup as a base from which to recover the database.</span></span> <span data-ttu-id="89625-440">Dans notre exemple, il s’agit de la capture instantanée HANA qui était incluse dans la capture instantanée de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-440">In our example, this is the HANA snapshot that was included in the storage snapshot.</span></span> <span data-ttu-id="89625-441">(Une seule capture instantanée est répertoriée dans la capture d’écran suivante).</span><span class="sxs-lookup"><span data-stu-id="89625-441">(Only one snapshot is listed in the following screenshot.)</span></span>

 ![Sélectionner une sauvegarde comme base pour la récupération de la base de données](./media/hana-overview-high-availability-disaster-recovery/image18-recover-database-c.png)

5. <span data-ttu-id="89625-443">Désélectionnez l’option **Use Delta Backups (Utiliser les sauvegardes différentielles)** si ces sauvegardes n’existent pas entre le moment de la capture instantanée HANA et l’état le plus récent.</span><span class="sxs-lookup"><span data-stu-id="89625-443">Clear the **Use Delta Backups** check box if deltas do not exist between the time of the HANA snapshot and the most recent state.</span></span>

 ![Désélectionner l’option Use Delta Backups (Utiliser les sauvegardes différentielles) si ces sauvegardes n’existent pas](./media/hana-overview-high-availability-disaster-recovery/image19-recover-database-d.png)

6. <span data-ttu-id="89625-445">Sur l’écran récapitulatif, cliquez sur **Finish (Terminer)** pour lancer la procédure de restauration.</span><span class="sxs-lookup"><span data-stu-id="89625-445">On the summary screen, click **Finish** to start the restoration procedure.</span></span>

 ![Cliquer sur "Finish" (Terminer) sur l’écran récapitulatif](./media/hana-overview-high-availability-disaster-recovery/image20-recover-database-e.png)

### <a name="recovering-to-another-point-in-time"></a><span data-ttu-id="89625-447">Récupération à un autre point dans le temps</span><span class="sxs-lookup"><span data-stu-id="89625-447">Recovering to another point in time</span></span>
<span data-ttu-id="89625-448">Pour effectuer une récupération jusqu’à une date et heure situées entre la capture instantanée HANA (incluse dans la capture instantanée de stockage) et une autre date et heures postérieures à cette capture instantanée, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="89625-448">To recover to a point in time between the HANA snapshot (included in the storage snapshot) and one that is later than the HANA snapshot point-in-time recovery, do the following:</span></span>

1. <span data-ttu-id="89625-449">Vérifiez que vous disposez de toutes les sauvegardes des journaux de transactions entre la capture instantanée HANA et l’heure souhaitée pour la récupération.</span><span class="sxs-lookup"><span data-stu-id="89625-449">Make sure that you have all transaction log backups from the HANA snapshot to the time you want to recover.</span></span>
2. <span data-ttu-id="89625-450">Commencez la procédure « Récupération jusqu’à l’état le plus récent ».</span><span class="sxs-lookup"><span data-stu-id="89625-450">Begin the procedure under "Recovering to the most recent state."</span></span>
3. <span data-ttu-id="89625-451">À l’étape 2 de la procédure, dans la fenêtre de **spécification du type de récupération**, sélectionnez l’option **Recover the database to the following point in time (Récupérer la base de données jusqu’au point dans le temps suivant)**, spécifiez le point dans le temps, puis effectuez les étapes 3 à 6.</span><span class="sxs-lookup"><span data-stu-id="89625-451">In step 2 of the procedure, in the **Specify Recovery Type** window, select **Recover the database to the following point in time**, specify the point in time, and then complete steps 3-6.</span></span>

## <a name="monitoring-the-execution-of-snapshots"></a><span data-ttu-id="89625-452">Surveillance de l’exécution de captures instantanées</span><span class="sxs-lookup"><span data-stu-id="89625-452">Monitoring the execution of snapshots</span></span>

<span data-ttu-id="89625-453">Vous devez surveiller l’exécution des captures instantanées de stockage.</span><span class="sxs-lookup"><span data-stu-id="89625-453">You need to monitor the execution of storage snapshots.</span></span> <span data-ttu-id="89625-454">Le script qui exécute une capture instantanée de stockage écrit la sortie dans un fichier, puis enregistre ce dernier au même emplacement que les scripts Perl.</span><span class="sxs-lookup"><span data-stu-id="89625-454">The script that executes a storage snapshot writes output to a file and then saves it to the same location as the Perl scripts.</span></span> <span data-ttu-id="89625-455">Un fichier distinct est créé pour chaque capture instantanée.</span><span class="sxs-lookup"><span data-stu-id="89625-455">A separate file is written for each snapshot.</span></span> <span data-ttu-id="89625-456">Le résultat de chaque fichier montre clairement les différentes phases que le script de capture instantanée exécute :</span><span class="sxs-lookup"><span data-stu-id="89625-456">The output of each file clearly shows the various phases that the snapshot script executes:</span></span>

- <span data-ttu-id="89625-457">Recherche des volumes qui doivent créer une capture instantanée</span><span class="sxs-lookup"><span data-stu-id="89625-457">Finding the volumes that need to create a snapshot</span></span>
- <span data-ttu-id="89625-458">Recherche des captures instantanées créées à partir de ces volumes</span><span class="sxs-lookup"><span data-stu-id="89625-458">Finding the snapshots taken from these volumes</span></span>
- <span data-ttu-id="89625-459">Suppression des captures instantanées existantes en fonction du nombre de captures instantanées que vous avez spécifié</span><span class="sxs-lookup"><span data-stu-id="89625-459">Deleting eventual existing snapshots to match the number of snapshots you specified</span></span>
- <span data-ttu-id="89625-460">Création d’une capture instantanée HANA</span><span class="sxs-lookup"><span data-stu-id="89625-460">Creating a HANA snapshot</span></span>
- <span data-ttu-id="89625-461">Création de la capture instantanée de stockage sur les volumes</span><span class="sxs-lookup"><span data-stu-id="89625-461">Creating the storage snapshot over the volumes</span></span>
- <span data-ttu-id="89625-462">Suppression de la capture instantanée HANA</span><span class="sxs-lookup"><span data-stu-id="89625-462">Deleting the HANA snapshot</span></span>
- <span data-ttu-id="89625-463">Changement du nom de la capture instantanée la plus récente par l’attribution de la valeur **.0**</span><span class="sxs-lookup"><span data-stu-id="89625-463">Renaming the most recent snapshot to **.0**</span></span>

<span data-ttu-id="89625-464">La partie la plus importante du script est la suivante :</span><span class="sxs-lookup"><span data-stu-id="89625-464">The most important part of the script is this:</span></span>
```
**********************Creating HANA snapshot**********************
Creating the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data create snapshot"" ...
HANA snapshot created successfully.
**********************Creating Storage snapshot**********************
Taking snapshot hourly.recent for hana_data_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_backup_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_shared_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for sapmnt_lhanad01_t020_vol ...
Snapshot created successfully.
**********************Deleting HANA snapshot**********************
Deleting the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data drop snapshot"" ...
HANA snapshot deletion successfully.
```
<span data-ttu-id="89625-465">Dans cet exemple, vous pouvez voir la façon dont le script enregistre la création de la capture instantanée HANA.</span><span class="sxs-lookup"><span data-stu-id="89625-465">You can see from this sample how the script records the creation of the HANA snapshot.</span></span> <span data-ttu-id="89625-466">Dans le cas d’une montée en puissance parallèle, ce processus est initialisé sur le nœud principal.</span><span class="sxs-lookup"><span data-stu-id="89625-466">In the scale-out case, this process is initiated on the master node.</span></span> <span data-ttu-id="89625-467">Le nœud principal initie la création synchrone des captures instantanées sur chacun des nœuds de travail.</span><span class="sxs-lookup"><span data-stu-id="89625-467">The master node initiates the synchronous creation of the snapshots on each of the worker nodes.</span></span> <span data-ttu-id="89625-468">Puis la capture instantanée de stockage est effectuée.</span><span class="sxs-lookup"><span data-stu-id="89625-468">Then the storage snapshot is taken.</span></span> <span data-ttu-id="89625-469">Une fois que l’exécution des captures instantanées de stockage a réussi, la capture instantanée HANA est supprimée.</span><span class="sxs-lookup"><span data-stu-id="89625-469">After the successful execution of the storage snapshots, the HANA snapshot is deleted.</span></span>
