---
title: "Intégrer Key Vault à SQL Server sur des machines virtuelles Windows dans Azure (Classic) | Microsoft Docs"
description: "Apprenez à automatiser la configuration du chiffrement de SQL Server pour une utilisation avec Azure Key Vault. Cette rubrique explique comment utiliser l’intégration Azure Key Vault avec des machines virtuelles SQL Server créées avec un modèle de déploiement classique."
services: virtual-machines-windows
documentationcenter: 
author: rothja
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: ab8d41a7-1971-4032-ab71-eb435c455dc1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 02/17/2017
ms.author: jroth
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 2a9ac5763bb934bd0646e47c3936f7bdd0d603b1
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="configure-azure-key-vault-integration-for-sql-server-on-azure-virtual-machines-classic"></a><span data-ttu-id="52505-104">Configurer Azure Key Vault Integration pour SQL Server sur des machines virtuelles Azure (Classic)</span><span class="sxs-lookup"><span data-stu-id="52505-104">Configure Azure Key Vault Integration for SQL Server on Azure Virtual Machines (Classic)</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="52505-105">Gestionnaire de ressources</span><span class="sxs-lookup"><span data-stu-id="52505-105">Resource Manager</span></span>](../sql/virtual-machines-windows-ps-sql-keyvault.md)
> * [<span data-ttu-id="52505-106">Classique</span><span class="sxs-lookup"><span data-stu-id="52505-106">Classic</span></span>](../classic/ps-sql-keyvault.md)
> 
> 

## <a name="overview"></a><span data-ttu-id="52505-107">Vue d’ensemble</span><span class="sxs-lookup"><span data-stu-id="52505-107">Overview</span></span>
<span data-ttu-id="52505-108">Il existe plusieurs fonctionnalités de chiffrement SQL Server, telles que le [chiffrement transparent des données (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), le [chiffrement au niveau des colonnes (CLE)](https://msdn.microsoft.com/library/ms173744.aspx) et le [chiffrement de sauvegarde](https://msdn.microsoft.com/library/dn449489.aspx).</span><span class="sxs-lookup"><span data-stu-id="52505-108">There are multiple SQL Server encryption features, such as [transparent data encryption (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), [column level encryption (CLE)](https://msdn.microsoft.com/library/ms173744.aspx), and [backup encryption](https://msdn.microsoft.com/library/dn449489.aspx).</span></span> <span data-ttu-id="52505-109">Ces types de chiffrement nécessitent que vous gériez et stockiez les clés de chiffrement que vous utilisez pour le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="52505-109">These forms of encryption require you to manage and store the cryptographic keys you use for encryption.</span></span> <span data-ttu-id="52505-110">Le service Azure Key Vault (coffre de clés Azure, AKV) est conçu pour optimiser la sécurité et la gestion de ces clés dans un emplacement sécurisé et hautement disponible.</span><span class="sxs-lookup"><span data-stu-id="52505-110">The Azure Key Vault (AKV) service is designed to improve the security and management of these keys in a secure and highly available location.</span></span> <span data-ttu-id="52505-111">Le [connecteur SQL Server](http://www.microsoft.com/download/details.aspx?id=45344) permet à SQL Server d’utiliser ces clés depuis le coffre de clés Azure.</span><span class="sxs-lookup"><span data-stu-id="52505-111">The [SQL Server Connector](http://www.microsoft.com/download/details.aspx?id=45344) enables SQL Server to use these keys from Azure Key Vault.</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="52505-112">Azure dispose de deux modèles de déploiement différents pour créer et utiliser des ressources : [le déploiement Resource Manager et le déploiement classique](../../../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="52505-112">Azure has two different deployment models for creating and working with resources: [Resource Manager and Classic](../../../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="52505-113">Cet article traite du modèle de déploiement classique.</span><span class="sxs-lookup"><span data-stu-id="52505-113">This article covers using the Classic deployment model.</span></span> <span data-ttu-id="52505-114">Pour la plupart des nouveaux déploiements, Microsoft recommande d’utiliser le modèle Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="52505-114">Microsoft recommends that most new deployments use the Resource Manager model.</span></span>

<span data-ttu-id="52505-115">Si vous exécutez SQL Server sur des ordinateurs locaux, vous devez [suivre la procédure d'accès à Azure Key Vault à partir de votre ordinateur SQL Server local](https://msdn.microsoft.com/library/dn198405.aspx).</span><span class="sxs-lookup"><span data-stu-id="52505-115">If you are running SQL Server with on-premises machines, there are [steps you can follow to access Azure Key Vault from your on-premises SQL Server machine](https://msdn.microsoft.com/library/dn198405.aspx).</span></span> <span data-ttu-id="52505-116">Mais, pour SQL Server dans des machines virtuelles Azure, vous pouvez gagner du temps à l'aide de la fonctionnalité *Azure Key Vault Integration* .</span><span class="sxs-lookup"><span data-stu-id="52505-116">But for SQL Server in Azure VMs, you can save time by using the *Azure Key Vault Integration* feature.</span></span> <span data-ttu-id="52505-117">Avec quelques applets de commande Azure PowerShell pour activer cette fonctionnalité, vous pouvez automatiser la configuration nécessaire pour qu'une machine virtuelle SQL puisse accéder à votre coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="52505-117">With a few Azure PowerShell cmdlets to enable this feature, you can automate the configuration necessary for a SQL VM to access your key vault.</span></span>

<span data-ttu-id="52505-118">Lorsque cette fonctionnalité est activée, elle installe automatiquement le connecteur SQL Server, configure le fournisseur EKM pour accéder à Azure Key Vault et crée les informations d'identification vous permettant d'accéder à votre coffre.</span><span class="sxs-lookup"><span data-stu-id="52505-118">When this feature is enabled, it automatically installs the SQL Server Connector, configures the EKM provider to access Azure Key Vault, and creates the credential to allow you to access your vault.</span></span> <span data-ttu-id="52505-119">Si vous avez examiné les étapes décrites dans la documentation locale mentionnée précédemment, vous pouvez voir que cette fonctionnalité automatise les étapes 2 et 3.</span><span class="sxs-lookup"><span data-stu-id="52505-119">If you looked at the steps in the previously mentioned on-premises documentation, you can see that this feature automates steps 2 and 3.</span></span> <span data-ttu-id="52505-120">La seule étape que vous devez encore exécuter manuellement consiste à créer le coffre de clé et des clés.</span><span class="sxs-lookup"><span data-stu-id="52505-120">The only thing you would still need to do manually is to create the key vault and keys.</span></span> <span data-ttu-id="52505-121">À partir de là, la configuration complète de votre machine virtuelle SQL est automatisée.</span><span class="sxs-lookup"><span data-stu-id="52505-121">From there, the entire setup of your SQL VM is automated.</span></span> <span data-ttu-id="52505-122">Une fois que cette fonctionnalité a terminé cette configuration, vous pouvez exécuter des instructions T-SQL pour crypter vos bases de données et vos sauvegardes comme vous y êtes habitué.</span><span class="sxs-lookup"><span data-stu-id="52505-122">Once this feature has completed this setup, you can execute T-SQL statements to begin encrypting your databases or backups as you normally would.</span></span>

[!INCLUDE [AKV Integration Prepare](../../../../includes/virtual-machines-sql-server-akv-prepare.md)]

## <a name="configure-akv-integration"></a><span data-ttu-id="52505-123">Configuration d'AKV Integration</span><span class="sxs-lookup"><span data-stu-id="52505-123">Configure AKV Integration</span></span>
<span data-ttu-id="52505-124">Utilisez PowerShell pour configurer Azure Key Vault Integration.</span><span class="sxs-lookup"><span data-stu-id="52505-124">Use PowerShell to configure Azure Key Vault Integration.</span></span> <span data-ttu-id="52505-125">Les sections suivantes fournissent une vue d'ensemble des paramètres requis, puis un exemple de script PowerShell.</span><span class="sxs-lookup"><span data-stu-id="52505-125">The following sections provide an overview of the required parameters and then a sample PowerShell script.</span></span>

### <a name="install-the-sql-server-iaas-extension"></a><span data-ttu-id="52505-126">Installer l’extension IaaS SQL Server</span><span class="sxs-lookup"><span data-stu-id="52505-126">Install the SQL Server IaaS Extension</span></span>
<span data-ttu-id="52505-127">[Tout d’abord, installez l’extension IaaS SQL Server](../classic/sql-server-agent-extension.md).</span><span class="sxs-lookup"><span data-stu-id="52505-127">First, [install the SQL Server IaaS Extension](../classic/sql-server-agent-extension.md).</span></span>

### <a name="understand-the-input-parameters"></a><span data-ttu-id="52505-128">Comprendre les paramètres d’entrée</span><span class="sxs-lookup"><span data-stu-id="52505-128">Understand the input parameters</span></span>
<span data-ttu-id="52505-129">Le tableau suivant répertorie les paramètres requis pour exécuter le script PowerShell dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="52505-129">The following table lists the parameters required to run the PowerShell script in the next section.</span></span>

| <span data-ttu-id="52505-130">Paramètre</span><span class="sxs-lookup"><span data-stu-id="52505-130">Parameter</span></span> | <span data-ttu-id="52505-131">Description</span><span class="sxs-lookup"><span data-stu-id="52505-131">Description</span></span> | <span data-ttu-id="52505-132">Exemple</span><span class="sxs-lookup"><span data-stu-id="52505-132">Example</span></span> |
| --- | --- | --- |
| <span data-ttu-id="52505-133">**$akvURL**</span><span class="sxs-lookup"><span data-stu-id="52505-133">**$akvURL**</span></span> |<span data-ttu-id="52505-134">**L'URL du coffre de clés**</span><span class="sxs-lookup"><span data-stu-id="52505-134">**The key vault URL**</span></span> |<span data-ttu-id="52505-135">« https://contosokeyvault.vault.azure.net/ »</span><span class="sxs-lookup"><span data-stu-id="52505-135">"https://contosokeyvault.vault.azure.net/"</span></span> |
| <span data-ttu-id="52505-136">**$spName**</span><span class="sxs-lookup"><span data-stu-id="52505-136">**$spName**</span></span> |<span data-ttu-id="52505-137">**Nom du principal du service**</span><span class="sxs-lookup"><span data-stu-id="52505-137">**Service Principal name**</span></span> |<span data-ttu-id="52505-138">« fde2b411-33d5-4e11-af04eb07b669ccf2 »</span><span class="sxs-lookup"><span data-stu-id="52505-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span></span> |
| <span data-ttu-id="52505-139">**$spSecret**</span><span class="sxs-lookup"><span data-stu-id="52505-139">**$spSecret**</span></span> |<span data-ttu-id="52505-140">**Secret du principal du service**</span><span class="sxs-lookup"><span data-stu-id="52505-140">**Service Principal secret**</span></span> |<span data-ttu-id="52505-141">« 9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM= »</span><span class="sxs-lookup"><span data-stu-id="52505-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span></span> |
| <span data-ttu-id="52505-142">**$credName**</span><span class="sxs-lookup"><span data-stu-id="52505-142">**$credName**</span></span> |<span data-ttu-id="52505-143">**Nom d’identification**: le module d’intégration du coffre de clés Azure crée des informations d’identification dans SQL Server, permettant ainsi à la machine virtuelle d’accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="52505-143">**Credential name**: AKV Integration creates a credential within SQL Server, allowing the VM to have access to the key vault.</span></span> <span data-ttu-id="52505-144">Choisissez un nom pour cette identification.</span><span class="sxs-lookup"><span data-stu-id="52505-144">Choose a name for this credential.</span></span> |<span data-ttu-id="52505-145">« mycred1 »</span><span class="sxs-lookup"><span data-stu-id="52505-145">"mycred1"</span></span> |
| <span data-ttu-id="52505-146">**$vmName**</span><span class="sxs-lookup"><span data-stu-id="52505-146">**$vmName**</span></span> |<span data-ttu-id="52505-147">**Nom de machine virtuelle**: le nom d’une machine virtuelle SQL créée précédemment.</span><span class="sxs-lookup"><span data-stu-id="52505-147">**Virtual machine name**: The name of a previously created SQL VM.</span></span> |<span data-ttu-id="52505-148">« myvmname »</span><span class="sxs-lookup"><span data-stu-id="52505-148">"myvmname"</span></span> |
| <span data-ttu-id="52505-149">**$serviceName**</span><span class="sxs-lookup"><span data-stu-id="52505-149">**$serviceName**</span></span> |<span data-ttu-id="52505-150">**Nom du service**: le nom du service Cloud associé à la machine virtuelle SQL.</span><span class="sxs-lookup"><span data-stu-id="52505-150">**Service name**: The Cloud Service name that is associated with the SQL VM.</span></span> |<span data-ttu-id="52505-151">« mycloudservicename »</span><span class="sxs-lookup"><span data-stu-id="52505-151">"mycloudservicename"</span></span> |

### <a name="enable-akv-integration-with-powershell"></a><span data-ttu-id="52505-152">Activation d'AKV Integration avec PowerShell</span><span class="sxs-lookup"><span data-stu-id="52505-152">Enable AKV Integration with PowerShell</span></span>
<span data-ttu-id="52505-153">L'applet de commande **New-AzureVMSqlServerKeyVaultCredentialConfig** crée un objet de configuration pour la fonctionnalité Azure Key Vault Integration.</span><span class="sxs-lookup"><span data-stu-id="52505-153">The **New-AzureVMSqlServerKeyVaultCredentialConfig** cmdlet creates a configuration object for the Azure Key Vault Integration feature.</span></span> <span data-ttu-id="52505-154">**Set-AzureVMSqlServerExtension** configure cette intégration avec le paramètre **KeyVaultCredentialSettings**.</span><span class="sxs-lookup"><span data-stu-id="52505-154">The **Set-AzureVMSqlServerExtension** configures this integration with the **KeyVaultCredentialSettings** parameter.</span></span> <span data-ttu-id="52505-155">Les étapes suivantes indiquent comment utiliser ces commandes.</span><span class="sxs-lookup"><span data-stu-id="52505-155">The following steps show how to use these commands.</span></span>

1. <span data-ttu-id="52505-156">Dans Azure PowerShell, configurez tout d’abord les paramètres d’entrée avec des valeurs spécifiques comme décrit dans les sections précédentes de cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="52505-156">In Azure PowerShell, first configure the input parameters with your specific values as described in the previous sections of this topic.</span></span> <span data-ttu-id="52505-157">Vous trouverez ci-dessous un exemple de script.</span><span class="sxs-lookup"><span data-stu-id="52505-157">The following script is an example.</span></span>
   
        $akvURL = "https://contosokeyvault.vault.azure.net/"
        $spName = "fde2b411-33d5-4e11-af04eb07b669ccf2"
        $spSecret = "9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="
        $credName = "mycred1"
        $vmName = "myvmname"
        $serviceName = "mycloudservicename"
2. <span data-ttu-id="52505-158">Utilisez ensuite le script suivant pour configurer et activer AKV Integration.</span><span class="sxs-lookup"><span data-stu-id="52505-158">Then use the following script to configure and enable AKV Integration.</span></span>
   
        $secureakv =  $spSecret | ConvertTo-SecureString -AsPlainText -Force
        $akvs = New-AzureVMSqlServerKeyVaultCredentialConfig -Enable -CredentialName $credname -AzureKeyVaultUrl $akvURL -ServicePrincipalName $spName -ServicePrincipalSecret $secureakv
        Get-AzureVM -ServiceName $serviceName -Name $vmName | Set-AzureVMSqlServerExtension -KeyVaultCredentialSettings $akvs | Update-AzureVM

<span data-ttu-id="52505-159">L'extension de l'Agent SQL IaaS met à jour la machine virtuelle SQL avec cette nouvelle configuration.</span><span class="sxs-lookup"><span data-stu-id="52505-159">The SQL IaaS Agent Extension will update the SQL VM with this new configuration.</span></span>

[!INCLUDE [AKV Integration Next Steps](../../../../includes/virtual-machines-sql-server-akv-next-steps.md)]

