---
title: "aaaIntegrate le coffre de clés avec SQL Server sur des machines virtuelles Windows Azure (classique) | Documents Microsoft"
description: "Découvrez comment tooautomate hello configuration du chiffrement de SQL Server pour une utilisation avec le coffre de clés Azure. Cette rubrique explique comment créer, toouse Azure Key Vault Integration avec les machines virtuelles SQL Server dans le modèle de déploiement classique hello."
services: virtual-machines-windows
documentationcenter: 
author: rothja
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: ab8d41a7-1971-4032-ab71-eb435c455dc1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 02/17/2017
ms.author: jroth
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 54664875b76dac7271d5a9f00b3f41fdc9c08491
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="configure-azure-key-vault-integration-for-sql-server-on-azure-virtual-machines-classic"></a><span data-ttu-id="5f850-104">Configurer Azure Key Vault Integration pour SQL Server sur des machines virtuelles Azure (Classic)</span><span class="sxs-lookup"><span data-stu-id="5f850-104">Configure Azure Key Vault Integration for SQL Server on Azure Virtual Machines (Classic)</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="5f850-105">Gestionnaire de ressources</span><span class="sxs-lookup"><span data-stu-id="5f850-105">Resource Manager</span></span>](../sql/virtual-machines-windows-ps-sql-keyvault.md)
> * [<span data-ttu-id="5f850-106">Classique</span><span class="sxs-lookup"><span data-stu-id="5f850-106">Classic</span></span>](../classic/ps-sql-keyvault.md)
> 
> 

## <a name="overview"></a><span data-ttu-id="5f850-107">Vue d’ensemble</span><span class="sxs-lookup"><span data-stu-id="5f850-107">Overview</span></span>
<span data-ttu-id="5f850-108">Il existe plusieurs fonctionnalités de chiffrement SQL Server, telles que le [chiffrement transparent des données (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), le [chiffrement au niveau des colonnes (CLE)](https://msdn.microsoft.com/library/ms173744.aspx) et le [chiffrement de sauvegarde](https://msdn.microsoft.com/library/dn449489.aspx).</span><span class="sxs-lookup"><span data-stu-id="5f850-108">There are multiple SQL Server encryption features, such as [transparent data encryption (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), [column level encryption (CLE)](https://msdn.microsoft.com/library/ms173744.aspx), and [backup encryption](https://msdn.microsoft.com/library/dn449489.aspx).</span></span> <span data-ttu-id="5f850-109">Ces formes de chiffrement nécessitent toomanage et stockent des clés de chiffrement de hello utilisé pour le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="5f850-109">These forms of encryption require you toomanage and store hello cryptographic keys you use for encryption.</span></span> <span data-ttu-id="5f850-110">Hello service d’Azure Key Vault (AKV) est conçue tooimprove hello sécurité et gestion de ces clés dans un emplacement sécurisé et hautement disponible.</span><span class="sxs-lookup"><span data-stu-id="5f850-110">hello Azure Key Vault (AKV) service is designed tooimprove hello security and management of these keys in a secure and highly available location.</span></span> <span data-ttu-id="5f850-111">Hello [connecteur SQL Server](http://www.microsoft.com/download/details.aspx?id=45344) permet à SQL Server toouse ces clés à partir d’Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="5f850-111">hello [SQL Server Connector](http://www.microsoft.com/download/details.aspx?id=45344) enables SQL Server toouse these keys from Azure Key Vault.</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="5f850-112">Azure dispose de deux modèles de déploiement différents pour créer et utiliser des ressources : [le déploiement Resource Manager et le déploiement classique](../../../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="5f850-112">Azure has two different deployment models for creating and working with resources: [Resource Manager and Classic](../../../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="5f850-113">Cet article décrit à l’aide du modèle de déploiement classique hello.</span><span class="sxs-lookup"><span data-stu-id="5f850-113">This article covers using hello Classic deployment model.</span></span> <span data-ttu-id="5f850-114">Microsoft recommande que la plupart des nouveaux déploiements de modèle du Gestionnaire de ressources hello.</span><span class="sxs-lookup"><span data-stu-id="5f850-114">Microsoft recommends that most new deployments use hello Resource Manager model.</span></span>

<span data-ttu-id="5f850-115">Si vous exécutez SQL Server avec les ordinateurs locaux, des [étapes que vous pouvez suivre tooaccess coffre de clés Azure à partir de votre ordinateur local, SQL Server](https://msdn.microsoft.com/library/dn198405.aspx).</span><span class="sxs-lookup"><span data-stu-id="5f850-115">If you are running SQL Server with on-premises machines, there are [steps you can follow tooaccess Azure Key Vault from your on-premises SQL Server machine](https://msdn.microsoft.com/library/dn198405.aspx).</span></span> <span data-ttu-id="5f850-116">Mais pour SQL Server dans des machines virtuelles Azure, vous pouvez gagner du temps à l’aide de hello *Azure Key Vault Integration* fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="5f850-116">But for SQL Server in Azure VMs, you can save time by using hello *Azure Key Vault Integration* feature.</span></span> <span data-ttu-id="5f850-117">Avec quelques tooenable d’applets de commande Azure PowerShell cette fonctionnalité, vous pouvez automatiser hello configuration nécessaire pour un tooaccess SQL VM votre coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="5f850-117">With a few Azure PowerShell cmdlets tooenable this feature, you can automate hello configuration necessary for a SQL VM tooaccess your key vault.</span></span>

<span data-ttu-id="5f850-118">Lorsque cette fonctionnalité est activée, elle installe hello connecteur SQL Server, configure automatiquement tooaccess de fournisseur EKM hello coffre de clés Azure et crée hello d’informations d’identification tooallow vous tooaccess votre archivage.</span><span class="sxs-lookup"><span data-stu-id="5f850-118">When this feature is enabled, it automatically installs hello SQL Server Connector, configures hello EKM provider tooaccess Azure Key Vault, and creates hello credential tooallow you tooaccess your vault.</span></span> <span data-ttu-id="5f850-119">Si vous avez examiné étapes hello Bonjour mentionné précédemment documentation locale, vous pouvez voir que cette fonctionnalité automatise les étapes 2 et 3.</span><span class="sxs-lookup"><span data-stu-id="5f850-119">If you looked at hello steps in hello previously mentioned on-premises documentation, you can see that this feature automates steps 2 and 3.</span></span> <span data-ttu-id="5f850-120">Vous devez toujours toodo manuellement seul Hello est clés et coffre de clés toocreate hello.</span><span class="sxs-lookup"><span data-stu-id="5f850-120">hello only thing you would still need toodo manually is toocreate hello key vault and keys.</span></span> <span data-ttu-id="5f850-121">À partir de là, hello ensemble le programme d’installation de votre VM SQL est automatisée.</span><span class="sxs-lookup"><span data-stu-id="5f850-121">From there, hello entire setup of your SQL VM is automated.</span></span> <span data-ttu-id="5f850-122">Une fois que cette fonctionnalité a terminé cette installation, vous pouvez exécuter toobegin d’instructions T-SQL chiffrement des sauvegardes des bases de données comme vous le feriez normalement.</span><span class="sxs-lookup"><span data-stu-id="5f850-122">Once this feature has completed this setup, you can execute T-SQL statements toobegin encrypting your databases or backups as you normally would.</span></span>

[!INCLUDE [AKV Integration Prepare](../../../../includes/virtual-machines-sql-server-akv-prepare.md)]

## <a name="configure-akv-integration"></a><span data-ttu-id="5f850-123">Configuration d'AKV Integration</span><span class="sxs-lookup"><span data-stu-id="5f850-123">Configure AKV Integration</span></span>
<span data-ttu-id="5f850-124">Utilisez PowerShell tooconfigure Azure Key Vault Integration.</span><span class="sxs-lookup"><span data-stu-id="5f850-124">Use PowerShell tooconfigure Azure Key Vault Integration.</span></span> <span data-ttu-id="5f850-125">Hello les sections suivantes fournit une vue d’ensemble de paramètres de hello requis, puis un exemple de script PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5f850-125">hello following sections provide an overview of hello required parameters and then a sample PowerShell script.</span></span>

### <a name="install-hello-sql-server-iaas-extension"></a><span data-ttu-id="5f850-126">Installer hello IaaS Extension de SQL Server</span><span class="sxs-lookup"><span data-stu-id="5f850-126">Install hello SQL Server IaaS Extension</span></span>
<span data-ttu-id="5f850-127">Tout d’abord, [installer hello IaaS Extension de SQL Server](../classic/sql-server-agent-extension.md).</span><span class="sxs-lookup"><span data-stu-id="5f850-127">First, [install hello SQL Server IaaS Extension](../classic/sql-server-agent-extension.md).</span></span>

### <a name="understand-hello-input-parameters"></a><span data-ttu-id="5f850-128">Comprendre les paramètres d’entrée hello</span><span class="sxs-lookup"><span data-stu-id="5f850-128">Understand hello input parameters</span></span>
<span data-ttu-id="5f850-129">Hello paramètres hello de listes de table suivants requis toorun de script PowerShell hello dans la section suivante de hello.</span><span class="sxs-lookup"><span data-stu-id="5f850-129">hello following table lists hello parameters required toorun hello PowerShell script in hello next section.</span></span>

| <span data-ttu-id="5f850-130">Paramètre</span><span class="sxs-lookup"><span data-stu-id="5f850-130">Parameter</span></span> | <span data-ttu-id="5f850-131">Description</span><span class="sxs-lookup"><span data-stu-id="5f850-131">Description</span></span> | <span data-ttu-id="5f850-132">Exemple</span><span class="sxs-lookup"><span data-stu-id="5f850-132">Example</span></span> |
| --- | --- | --- |
| <span data-ttu-id="5f850-133">**$akvURL**</span><span class="sxs-lookup"><span data-stu-id="5f850-133">**$akvURL**</span></span> |<span data-ttu-id="5f850-134">**URL de coffre de clés Hello**</span><span class="sxs-lookup"><span data-stu-id="5f850-134">**hello key vault URL**</span></span> |<span data-ttu-id="5f850-135">« https://contosokeyvault.vault.azure.net/ »</span><span class="sxs-lookup"><span data-stu-id="5f850-135">"https://contosokeyvault.vault.azure.net/"</span></span> |
| <span data-ttu-id="5f850-136">**$spName**</span><span class="sxs-lookup"><span data-stu-id="5f850-136">**$spName**</span></span> |<span data-ttu-id="5f850-137">**Nom du principal du service**</span><span class="sxs-lookup"><span data-stu-id="5f850-137">**Service Principal name**</span></span> |<span data-ttu-id="5f850-138">« fde2b411-33d5-4e11-af04eb07b669ccf2 »</span><span class="sxs-lookup"><span data-stu-id="5f850-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span></span> |
| <span data-ttu-id="5f850-139">**$spSecret**</span><span class="sxs-lookup"><span data-stu-id="5f850-139">**$spSecret**</span></span> |<span data-ttu-id="5f850-140">**Secret du principal du service**</span><span class="sxs-lookup"><span data-stu-id="5f850-140">**Service Principal secret**</span></span> |<span data-ttu-id="5f850-141">« 9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM= »</span><span class="sxs-lookup"><span data-stu-id="5f850-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span></span> |
| <span data-ttu-id="5f850-142">**$credName**</span><span class="sxs-lookup"><span data-stu-id="5f850-142">**$credName**</span></span> |<span data-ttu-id="5f850-143">**Nom d’identification**: AKV Integration crée des informations d’identification dans SQL Server, ce qui permet de hello VM toohave accès toohello coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="5f850-143">**Credential name**: AKV Integration creates a credential within SQL Server, allowing hello VM toohave access toohello key vault.</span></span> <span data-ttu-id="5f850-144">Choisissez un nom pour cette identification.</span><span class="sxs-lookup"><span data-stu-id="5f850-144">Choose a name for this credential.</span></span> |<span data-ttu-id="5f850-145">« mycred1 »</span><span class="sxs-lookup"><span data-stu-id="5f850-145">"mycred1"</span></span> |
| <span data-ttu-id="5f850-146">**$vmName**</span><span class="sxs-lookup"><span data-stu-id="5f850-146">**$vmName**</span></span> |<span data-ttu-id="5f850-147">**Nom de machine virtuelle**: nom hello d’un VM SQL créé précédemment.</span><span class="sxs-lookup"><span data-stu-id="5f850-147">**Virtual machine name**: hello name of a previously created SQL VM.</span></span> |<span data-ttu-id="5f850-148">« myvmname »</span><span class="sxs-lookup"><span data-stu-id="5f850-148">"myvmname"</span></span> |
| <span data-ttu-id="5f850-149">**$serviceName**</span><span class="sxs-lookup"><span data-stu-id="5f850-149">**$serviceName**</span></span> |<span data-ttu-id="5f850-150">**Nom du service**: nom du Service Cloud hello associé hello SQL VM.</span><span class="sxs-lookup"><span data-stu-id="5f850-150">**Service name**: hello Cloud Service name that is associated with hello SQL VM.</span></span> |<span data-ttu-id="5f850-151">« mycloudservicename »</span><span class="sxs-lookup"><span data-stu-id="5f850-151">"mycloudservicename"</span></span> |

### <a name="enable-akv-integration-with-powershell"></a><span data-ttu-id="5f850-152">Activation d'AKV Integration avec PowerShell</span><span class="sxs-lookup"><span data-stu-id="5f850-152">Enable AKV Integration with PowerShell</span></span>
<span data-ttu-id="5f850-153">Hello **New-AzureVMSqlServerKeyVaultCredentialConfig** applet de commande crée un objet de configuration pour la fonctionnalité d’Azure Key Vault Integration hello.</span><span class="sxs-lookup"><span data-stu-id="5f850-153">hello **New-AzureVMSqlServerKeyVaultCredentialConfig** cmdlet creates a configuration object for hello Azure Key Vault Integration feature.</span></span> <span data-ttu-id="5f850-154">Hello **Set-AzureVMSqlServerExtension** configure cette intégration avec hello **KeyVaultCredentialSettings** paramètre.</span><span class="sxs-lookup"><span data-stu-id="5f850-154">hello **Set-AzureVMSqlServerExtension** configures this integration with hello **KeyVaultCredentialSettings** parameter.</span></span> <span data-ttu-id="5f850-155">Hello suivant les étapes indiquent comment toouse ces commandes.</span><span class="sxs-lookup"><span data-stu-id="5f850-155">hello following steps show how toouse these commands.</span></span>

1. <span data-ttu-id="5f850-156">Dans Azure PowerShell, d’abord configurer les paramètres d’entrée hello avec les valeurs spécifiques comme décrit dans les sections précédentes hello de cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="5f850-156">In Azure PowerShell, first configure hello input parameters with your specific values as described in hello previous sections of this topic.</span></span> <span data-ttu-id="5f850-157">Hello script suivant est un exemple.</span><span class="sxs-lookup"><span data-stu-id="5f850-157">hello following script is an example.</span></span>
   
        $akvURL = "https://contosokeyvault.vault.azure.net/"
        $spName = "fde2b411-33d5-4e11-af04eb07b669ccf2"
        $spSecret = "9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="
        $credName = "mycred1"
        $vmName = "myvmname"
        $serviceName = "mycloudservicename"
2. <span data-ttu-id="5f850-158">Suivant de hello utilisation tooconfigure de script, puis activer l’intégration de AKV.</span><span class="sxs-lookup"><span data-stu-id="5f850-158">Then use hello following script tooconfigure and enable AKV Integration.</span></span>
   
        $secureakv =  $spSecret | ConvertTo-SecureString -AsPlainText -Force
        $akvs = New-AzureVMSqlServerKeyVaultCredentialConfig -Enable -CredentialName $credname -AzureKeyVaultUrl $akvURL -ServicePrincipalName $spName -ServicePrincipalSecret $secureakv
        Get-AzureVM -ServiceName $serviceName -Name $vmName | Set-AzureVMSqlServerExtension -KeyVaultCredentialSettings $akvs | Update-AzureVM

<span data-ttu-id="5f850-159">Hello, Extension de l’Agent IaaS SQL met à jour hello SQL VM avec cette nouvelle configuration.</span><span class="sxs-lookup"><span data-stu-id="5f850-159">hello SQL IaaS Agent Extension will update hello SQL VM with this new configuration.</span></span>

[!INCLUDE [AKV Integration Next Steps](../../../../includes/virtual-machines-sql-server-akv-next-steps.md)]

