---
title: "Dépannage détaillé du Bureau à distance | Microsoft Docs"
description: "Revoir les étapes de dépannage détaillées pour les erreurs liées au Bureau à distance, quand vous ne pouvez pas vous connecter aux machines virtuelles Windows dans Azure"
services: virtual-machines-windows
documentationcenter: 
author: genlin
manager: timlt
editor: 
tags: top-support-issue,azure-service-management,azure-resource-manager
keywords: "impossible de se connecter au bureau à distance, dépanner le bureau à distance, le bureau à distance ne peut pas se connecter, erreurs du bureau à distance, dépannage du bureau à distance, problèmes du bureau à distance"
ms.assetid: 9da36f3d-30dd-44af-824b-8ce5ef07e5e0
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: support-article
ms.date: 07/25/2017
ms.author: genli
ms.openlocfilehash: 22080b9402b13fd8162024db10aef5475880e4a7
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="detailed-troubleshooting-steps-for-remote-desktop-connection-issues-to-windows-vms-in-azure"></a><span data-ttu-id="800ca-104">Étapes de dépannage détaillées pour les problèmes de connexion du Bureau à distance aux machines virtuelles Windows dans Azure</span><span class="sxs-lookup"><span data-stu-id="800ca-104">Detailed troubleshooting steps for remote desktop connection issues to Windows VMs in Azure</span></span>
<span data-ttu-id="800ca-105">Cet article décrit les étapes de dépannage détaillées pour diagnostiquer et résoudre les erreurs complexes du Bureau à distance pour les machines virtuelles basées Azure sur Windows.</span><span class="sxs-lookup"><span data-stu-id="800ca-105">This article provides detailed troubleshooting steps to diagnose and fix complex Remote Desktop errors for Windows-based Azure virtual machines.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="800ca-106">Pour éliminer les erreurs du Bureau à distance les plus courantes, veillez à lire [l’article sur la résolution des problèmes de base du Bureau à distance](troubleshoot-rdp-connection.md) avant de continuer.</span><span class="sxs-lookup"><span data-stu-id="800ca-106">To eliminate the more common Remote Desktop errors, make sure to read [the basic troubleshooting article for Remote Desktop](troubleshoot-rdp-connection.md) before proceeding.</span></span>

<span data-ttu-id="800ca-107">Vous pouvez rencontrer un message d’erreur du Bureau à distance qui ne ressemble à aucun des messages d’erreur spécifiques couverts dans [le guide de résolution des problèmes de base du Bureau à distance](troubleshoot-rdp-connection.md).</span><span class="sxs-lookup"><span data-stu-id="800ca-107">You may encounter a Remote Desktop error message that does not resemble any of the specific error messages covered in [the basic Remote Desktop troubleshooting guide](troubleshoot-rdp-connection.md).</span></span> <span data-ttu-id="800ca-108">Suivez ces étapes pour déterminer pourquoi le client Bureau à distance ne parvient pas à se connecter au service Bureau à distance sur la machine virtuelle Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-108">Follow these steps to determine why the Remote Desktop (RDP) client is unable to connect to the RDP service on the Azure VM.</span></span>

[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

<span data-ttu-id="800ca-109">Si vous avez besoin d'aide supplémentaire concernant n'importe quel point de cet article, contactez les experts Azure sur les [forums MSDN Azure et Stack Overflow](https://azure.microsoft.com/support/forums/).</span><span class="sxs-lookup"><span data-stu-id="800ca-109">If you need more help at any point in this article, you can contact the Azure experts on [the MSDN Azure and the Stack Overflow forums](https://azure.microsoft.com/support/forums/).</span></span> <span data-ttu-id="800ca-110">Vous pouvez également signaler un incident au support Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-110">Alternatively, you can also file an Azure support incident.</span></span> <span data-ttu-id="800ca-111">Accédez au [site de support Azure](https://azure.microsoft.com/support/options/) , puis cliquez sur **Obtenir un support**.</span><span class="sxs-lookup"><span data-stu-id="800ca-111">Go to the [Azure Support site](https://azure.microsoft.com/support/options/) and click **Get Support**.</span></span> <span data-ttu-id="800ca-112">Pour plus d’informations sur l’utilisation du support Azure, lisez la [FAQ du support Microsoft Azure](https://azure.microsoft.com/support/faq/).</span><span class="sxs-lookup"><span data-stu-id="800ca-112">For information about using Azure Support, read the [Microsoft Azure Support FAQ](https://azure.microsoft.com/support/faq/).</span></span>

## <a name="components-of-a-remote-desktop-connection"></a><span data-ttu-id="800ca-113">Composants d’une connexion Bureau à distance</span><span class="sxs-lookup"><span data-stu-id="800ca-113">Components of a Remote Desktop connection</span></span>
<span data-ttu-id="800ca-114">Voici les composants impliqués dans une connexion Bureau à distance :</span><span class="sxs-lookup"><span data-stu-id="800ca-114">The following components are involved in an RDP connection:</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_0.png)

<span data-ttu-id="800ca-115">Avant de poursuivre, nous vous recommandons de réfléchir à tout ce qui a changé depuis que vous avez créé avec succès une connexion Bureau à distance à la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="800ca-115">Before proceeding, it might help to mentally review what has changed since the last successful Remote Desktop connection to the VM.</span></span> <span data-ttu-id="800ca-116">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="800ca-116">For example:</span></span>

* <span data-ttu-id="800ca-117">Si l’adresse IP publique de la machine virtuelle ou du service cloud contenant la machine virtuelle (également appelée adresse IP virtuelle [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) a changé.</span><span class="sxs-lookup"><span data-stu-id="800ca-117">The public IP address of the VM or the cloud service containing the VM (also called the virtual IP address [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) has changed.</span></span> <span data-ttu-id="800ca-118">L’erreur de Bureau à distance peut indiquer que le cache client DNS a toujours *l’ancienne adresse IP* enregistrée pour le nom DNS.</span><span class="sxs-lookup"><span data-stu-id="800ca-118">The RDP failure could be because your DNS client cache still has the *old IP address* registered for the DNS name.</span></span> <span data-ttu-id="800ca-119">Videz le cache client DNS et essayez de vous reconnecter à la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="800ca-119">Flush your DNS client cache and try connecting the VM again.</span></span> <span data-ttu-id="800ca-120">Ou essayez de vous connecter directement avec la nouvelle adresse IP virtuelle.</span><span class="sxs-lookup"><span data-stu-id="800ca-120">Or try connecting directly with the new VIP.</span></span>
* <span data-ttu-id="800ca-121">Vous utilisez une application tierce pour gérer vos connexions Bureau à distance au lieu d’utiliser la connexion générée par le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-121">You are using a third-party application to manage your Remote Desktop connections instead of using the connection generated by the Azure portal.</span></span> <span data-ttu-id="800ca-122">Vérifiez que la configuration de l’application inclut bien le port TCP approprié pour le trafic de Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-122">Verify that the application configuration includes the correct TCP port for the Remote Desktop traffic.</span></span> <span data-ttu-id="800ca-123">Vous pouvez vérifier ce port pour une machine virtuelle classique dans le [portail Azure](https://portal.azure.com), en cliquant sur Paramètres de la machine virtuelle > Points de terminaison.</span><span class="sxs-lookup"><span data-stu-id="800ca-123">You can check this port for a classic virtual machine in the [Azure portal](https://portal.azure.com), by clicking the VM's Settings > Endpoints.</span></span>

## <a name="preliminary-steps"></a><span data-ttu-id="800ca-124">Étapes préliminaires</span><span class="sxs-lookup"><span data-stu-id="800ca-124">Preliminary steps</span></span>
<span data-ttu-id="800ca-125">Avant de passer à la procédure de dépannage détaillé :</span><span class="sxs-lookup"><span data-stu-id="800ca-125">Before proceeding to the detailed troubleshooting,</span></span>

* <span data-ttu-id="800ca-126">Vérifiez l’état de la machine virtuelle sur le Portail Azure pour identifier d’éventuels problèmes flagrants.</span><span class="sxs-lookup"><span data-stu-id="800ca-126">Check the status of the virtual machine in the Azure portal for any obvious issues.</span></span>
* <span data-ttu-id="800ca-127">Suivez les [étapes du guide de résolution des problèmes de base pour corriger rapidement les erreurs de Bureau à distance courantes](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span><span class="sxs-lookup"><span data-stu-id="800ca-127">Follow the [quick fix steps for common RDP errors in the basic troubleshooting guide](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span></span>

<span data-ttu-id="800ca-128">Essayez de vous reconnecter à la machine virtuelle via le Bureau à distance après ces étapes.</span><span class="sxs-lookup"><span data-stu-id="800ca-128">Try reconnecting to the VM via Remote Desktop after these steps.</span></span>

## <a name="detailed-troubleshooting-steps"></a><span data-ttu-id="800ca-129">Étapes de dépannage détaillées</span><span class="sxs-lookup"><span data-stu-id="800ca-129">Detailed troubleshooting steps</span></span>
<span data-ttu-id="800ca-130">Le client Bureau à distance peut ne pas être en mesure d’atteindre le service Bureau à distance sur la machine virtuelle Azure en raison de problèmes au niveau des sources suivantes :</span><span class="sxs-lookup"><span data-stu-id="800ca-130">The Remote Desktop client may not be able to reach the Remote Desktop service on the Azure VM due to issues at the following sources:</span></span>

* [<span data-ttu-id="800ca-131">ordinateur client de Bureau à distance ;</span><span class="sxs-lookup"><span data-stu-id="800ca-131">Remote Desktop client computer</span></span>](#source-1-remote-desktop-client-computer)
* [<span data-ttu-id="800ca-132">périphérique de périmètre intranet de l’entreprise ;</span><span class="sxs-lookup"><span data-stu-id="800ca-132">Organization intranet edge device</span></span>](#source-2-organization-intranet-edge-device)
* [<span data-ttu-id="800ca-133">point de terminaison de service cloud et liste de contrôle d’accès (ACL) ;</span><span class="sxs-lookup"><span data-stu-id="800ca-133">Cloud service endpoint and access control list (ACL)</span></span>](#source-3-cloud-service-endpoint-and-acl)
* [<span data-ttu-id="800ca-134">Groupes de sécurité réseau</span><span class="sxs-lookup"><span data-stu-id="800ca-134">Network security groups</span></span>](#source-4-network-security-groups)
* [<span data-ttu-id="800ca-135">Machine virtuelle Windows sur Azure</span><span class="sxs-lookup"><span data-stu-id="800ca-135">Windows-based Azure VM</span></span>](#source-5-windows-based-azure-vm)

## <a name="source-1-remote-desktop-client-computer"></a><span data-ttu-id="800ca-136">Source 1 : Ordinateur client de Bureau à distance</span><span class="sxs-lookup"><span data-stu-id="800ca-136">Source 1: Remote Desktop client computer</span></span>
<span data-ttu-id="800ca-137">Vérifiez que votre ordinateur peut établir des connexions Bureau à distance avec un autre ordinateur Windows local.</span><span class="sxs-lookup"><span data-stu-id="800ca-137">Verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_1.png)

<span data-ttu-id="800ca-138">Si vous n’y parvenez pas, recherchez les paramètres suivants sur votre ordinateur :</span><span class="sxs-lookup"><span data-stu-id="800ca-138">If you cannot, check for the following settings on your computer:</span></span>

* <span data-ttu-id="800ca-139">un paramètre de pare-feu local qui bloque le trafic de Bureau à distance ;</span><span class="sxs-lookup"><span data-stu-id="800ca-139">A local firewall setting that is blocking Remote Desktop traffic.</span></span>
* <span data-ttu-id="800ca-140">un logiciel proxy client installé localement qui empêche les connexions Bureau à distance ;</span><span class="sxs-lookup"><span data-stu-id="800ca-140">Locally installed client proxy software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="800ca-141">un logiciel de surveillance réseau installé localement qui empêche les connexions Bureau à distance ;</span><span class="sxs-lookup"><span data-stu-id="800ca-141">Locally installed network monitoring software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="800ca-142">d’autres types de logiciel de sécurité qui analysent le trafic ou autorisent/interdisent des types spécifiques de trafic empêchant les connexions Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-142">Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="800ca-143">Dans tous ces cas, désactivez temporairement le logiciel concerné et essayez d’établir une connexion avec un ordinateur local via le Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-143">In all these cases, temporarily disable the software and try to connect to an on-premises computer via Remote Desktop.</span></span> <span data-ttu-id="800ca-144">Si vous ne parvenez pas à identifier l’origine du problème de cette façon, contactez votre administrateur réseau pour corriger les paramètres logiciels afin d’autoriser les connexions Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-144">If you can find out the actual cause this way, work with your network administrator to correct the software settings to allow Remote Desktop connections.</span></span>

## <a name="source-2-organization-intranet-edge-device"></a><span data-ttu-id="800ca-145">Source 2 : Périphérique de périmètre intranet de l’entreprise</span><span class="sxs-lookup"><span data-stu-id="800ca-145">Source 2: Organization intranet edge device</span></span>
<span data-ttu-id="800ca-146">Vérifiez qu’un ordinateur directement connecté à Internet peut établir des connexions Bureau à distance avec votre machine virtuelle Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-146">Verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_2.png)

<span data-ttu-id="800ca-147">Si vous n’avez pas d’ordinateur directement connecté à Internet, créez et testez une nouvelle machine virtuelle Azure dans un groupe de ressources ou service cloud.</span><span class="sxs-lookup"><span data-stu-id="800ca-147">If you do not have a computer that is directly connected to the Internet, create and test with a new Azure virtual machine in a resource group or cloud service.</span></span> <span data-ttu-id="800ca-148">Pour plus d’informations, consultez [Création d’une machine virtuelle exécutant Windows dans Azure](../virtual-machines-windows-hero-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="800ca-148">For more information, see [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md).</span></span> <span data-ttu-id="800ca-149">Une fois le test terminé, supprimez la machine virtuelle et le groupe de ressources ou le service cloud.</span><span class="sxs-lookup"><span data-stu-id="800ca-149">You can delete the virtual machine and the resource group or the cloud service, after the test.</span></span>

<span data-ttu-id="800ca-150">Si vous pouvez créer une connexion Bureau à distance avec un ordinateur directement connecté à Internet, recherchez sur votre périphérique de périmètre intranet d’entreprise :</span><span class="sxs-lookup"><span data-stu-id="800ca-150">If you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:</span></span>

* <span data-ttu-id="800ca-151">un pare-feu qui bloque les connexions HTTPS à Internet ;</span><span class="sxs-lookup"><span data-stu-id="800ca-151">An internal firewall blocking HTTPS connections to the Internet.</span></span>
* <span data-ttu-id="800ca-152">un serveur proxy qui empêche les connexions Bureau à distance ;</span><span class="sxs-lookup"><span data-stu-id="800ca-152">A proxy server preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="800ca-153">un logiciel de détection d’intrusion ou de surveillance réseau s’exécutant sur les appareils de votre réseau de périmètre et qui empêche les connexions Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-153">Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="800ca-154">Contactez votre administrateur réseau pour corriger les paramètres de votre périphérique de périmètre intranet d’entreprise afin d’autoriser les connexions Bureau à distance basées sur HTTPS à Internet.</span><span class="sxs-lookup"><span data-stu-id="800ca-154">Work with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.</span></span>

## <a name="source-3-cloud-service-endpoint-and-acl"></a><span data-ttu-id="800ca-155">Source 3 : Point de terminaison de service cloud et liste de contrôle d’accès</span><span class="sxs-lookup"><span data-stu-id="800ca-155">Source 3: Cloud service endpoint and ACL</span></span>
<span data-ttu-id="800ca-156">Pour les machines virtuelles créées à l’aide du modèle de déploiement classique, vérifiez qu’une autre machine virtuelle Azure du même service cloud ou réseau virtuel peut établir des connexions Bureau à distance avec votre machine virtuelle Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-156">For VMs created using the Classic deployment model, verify that another Azure VM that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure VM.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_3.png)

> [!NOTE]
> <span data-ttu-id="800ca-157">Pour les machines virtuelles créées dans Resource Manager, passez à [Source 4 : groupes de sécurité réseau](#source-4-network-security-groups).</span><span class="sxs-lookup"><span data-stu-id="800ca-157">For virtual machines created in Resource Manager, skip to [Source 4: Network Security Groups](#source-4-network-security-groups).</span></span>

<span data-ttu-id="800ca-158">Si vous ne disposez pas d’une autre machine virtuelle dans le même service cloud ou réseau virtuel, créez-en une.</span><span class="sxs-lookup"><span data-stu-id="800ca-158">If you do not have another virtual machine in the same cloud service or virtual network, create one.</span></span> <span data-ttu-id="800ca-159">Suivez les étapes de [création d’une machine virtuelle exécutant Windows dans Azure](../virtual-machines-windows-hero-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="800ca-159">Follow the steps in [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md).</span></span> <span data-ttu-id="800ca-160">Une fois le test terminé, supprimez la machine virtuelle de test.</span><span class="sxs-lookup"><span data-stu-id="800ca-160">Delete the test virtual machine after the test is completed.</span></span>

<span data-ttu-id="800ca-161">Si vous pouvez vous connecter à une machine virtuelle via le Bureau à distance dans le même service cloud ou réseau virtuel, vérifiez les paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="800ca-161">If you can connect via Remote Desktop to a virtual machine in the same cloud service or virtual network, check for these settings:</span></span>

* <span data-ttu-id="800ca-162">La configuration du point de terminaison pour le trafic de Bureau à distance sur la machine virtuelle cible : le port TCP privé du point de terminaison doit correspondre au port TCP sur lequel le service Bureau à distance de la machine virtuelle procède à l’écoute (le port 3389, par défaut).</span><span class="sxs-lookup"><span data-stu-id="800ca-162">The endpoint configuration for Remote Desktop traffic on the target VM: The private TCP port of the endpoint must match the TCP port on which the VM's Remote Desktop service is listening (default is 3389).</span></span>
* <span data-ttu-id="800ca-163">La liste de contrôle d’accès du point de terminaison du trafic Bureau à distance sur la machine virtuelle cible : les listes de contrôle d’accès vous permettent de spécifier le trafic Internet entrant autorisé et interdit en fonction de l’adresse IP source.</span><span class="sxs-lookup"><span data-stu-id="800ca-163">The ACL for the Remote Desktop traffic endpoint on the target VM: ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address.</span></span> <span data-ttu-id="800ca-164">Une mauvaise configuration des listes de contrôle d’accès peut empêcher le trafic du Bureau à distance d’accéder au point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="800ca-164">Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint.</span></span> <span data-ttu-id="800ca-165">Examinez vos listes de contrôle d’accès pour vous assurer que le trafic entrant provenant des adresses IP publiques de votre proxy ou d’un autre serveur Edge est autorisé.</span><span class="sxs-lookup"><span data-stu-id="800ca-165">Check your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed.</span></span> <span data-ttu-id="800ca-166">Pour plus d’informations, consultez [Qu’est-ce qu’une liste de contrôle d’accès (ACL) réseau ?](../../virtual-network/virtual-networks-acl.md)</span><span class="sxs-lookup"><span data-stu-id="800ca-166">For more information, see [What is a Network Access Control List (ACL)?](../../virtual-network/virtual-networks-acl.md)</span></span>

<span data-ttu-id="800ca-167">Pour vérifier si le point de terminaison est la source du problème, supprimez le point de terminaison actuel et créez un autre point en choisissant un port aléatoire dont le numéro externe se situe entre 49152 et 65535.</span><span class="sxs-lookup"><span data-stu-id="800ca-167">To check if the endpoint is the source of the problem, remove the current endpoint and create a new one, choosing a random port in the range 49152–65535 for the external port number.</span></span> <span data-ttu-id="800ca-168">Pour plus d’informations, consultez [Configuration des points de terminaison sur une machine virtuelle](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="800ca-168">For more information, see [How to set up endpoints to a virtual machine](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span></span>

## <a name="source-4-network-security-groups"></a><span data-ttu-id="800ca-169">Source 4 : groupes de sécurité réseau</span><span class="sxs-lookup"><span data-stu-id="800ca-169">Source 4: Network Security Groups</span></span>
<span data-ttu-id="800ca-170">Les groupes de sécurité réseau vous permettent de contrôler plus précisément le trafic entrant et sortant autorisé.</span><span class="sxs-lookup"><span data-stu-id="800ca-170">Network Security Groups allow more granular control of allowed inbound and outbound traffic.</span></span> <span data-ttu-id="800ca-171">Vous pouvez créer des règles qui s’étendent aux sous-réseaux et aux services cloud d’un réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-171">You can create rules spanning subnets and cloud services in an Azure virtual network.</span></span>

<span data-ttu-id="800ca-172">Utilisez la [vérification des flux IP](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md) pour savoir si une règle d’un groupe de sécurité réseau bloque le trafic depuis ou vers une machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="800ca-172">Use [IP flow verify](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md) to confirm if a rule in a Network Security Group is blocking traffic to or from a virtual machine.</span></span> <span data-ttu-id="800ca-173">Vous pouvez également vérifier les règles de groupe de sécurité effectives pour vous assurer que la règle « Allow » entrante du groupe de sécurité réseau existe pour le port RDP (par défaut, 3389).</span><span class="sxs-lookup"><span data-stu-id="800ca-173">You can also review effective security group rules to ensure inbound "Allow" NSG rule exists and is prioritized for RDP port(default 3389).</span></span> <span data-ttu-id="800ca-174">Pour en savoir plus, voir [Utilisation de règles de sécurité effectives pour résoudre des problèmes de flux de trafic de machine virtuelle](../../virtual-network/virtual-network-nsg-troubleshoot-portal.md#using-effective-security-rules-to-troubleshoot-vm-traffic-flow).</span><span class="sxs-lookup"><span data-stu-id="800ca-174">For more information, see [Using Effective Security Rules to troubleshoot VM traffic flow](../../virtual-network/virtual-network-nsg-troubleshoot-portal.md#using-effective-security-rules-to-troubleshoot-vm-traffic-flow).</span></span>

## <a name="source-5-windows-based-azure-vm"></a><span data-ttu-id="800ca-175">Source 5 : Machine virtuelle Azure Windows</span><span class="sxs-lookup"><span data-stu-id="800ca-175">Source 5: Windows-based Azure VM</span></span>
![](./media/detailed-troubleshoot-rdp/tshootrdp_5.png)

<span data-ttu-id="800ca-176">Suivez les instructions de [cet article](reset-rdp.md).</span><span class="sxs-lookup"><span data-stu-id="800ca-176">Follow the instructions in [this article](reset-rdp.md).</span></span> <span data-ttu-id="800ca-177">Cet article est consacré à la réinitialisation du service Bureau à distance sur la machine virtuelle :</span><span class="sxs-lookup"><span data-stu-id="800ca-177">This article resets the Remote Desktop service on the virtual machine:</span></span>

* <span data-ttu-id="800ca-178">activer la règle par défaut du pare-feu Windows Bureau à distance (port TCP 3389) ;</span><span class="sxs-lookup"><span data-stu-id="800ca-178">Enable the "Remote Desktop" Windows Firewall default rule (TCP port 3389).</span></span>
* <span data-ttu-id="800ca-179">activer les connexions Bureau à distance en définissant la valeur de registre HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections sur 0.</span><span class="sxs-lookup"><span data-stu-id="800ca-179">Enable Remote Desktop connections by setting the HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections registry value to 0.</span></span>

<span data-ttu-id="800ca-180">Essayez une nouvelle fois de vous connecter à partir de votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="800ca-180">Try the connection from your computer again.</span></span> <span data-ttu-id="800ca-181">Si vous ne réussissez toujours pas à vous connecter via Bureau à distance, cela peut être dû à l’une des raisons suivantes :</span><span class="sxs-lookup"><span data-stu-id="800ca-181">If you are still not able to connect via Remote Desktop, check for the following possible problems:</span></span>

* <span data-ttu-id="800ca-182">Le service Bureau à distance ne fonctionne pas sur la machine virtuelle cible.</span><span class="sxs-lookup"><span data-stu-id="800ca-182">The Remote Desktop service is not running on the target VM.</span></span>
* <span data-ttu-id="800ca-183">Le service Bureau à distance n’est pas compatible avec l’écoute sur le port TCP 3389.</span><span class="sxs-lookup"><span data-stu-id="800ca-183">The Remote Desktop service is not listening on TCP port 3389.</span></span>
* <span data-ttu-id="800ca-184">Le pare-feu Windows ou un autre pare-feu local comporte une règle sortante qui empêche le trafic du Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-184">Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.</span></span>
* <span data-ttu-id="800ca-185">Le logiciel de détection d’intrusion ou de surveillance réseau s’exécutant sur la machine virtuelle Azure empêche les connexions Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-185">Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="800ca-186">Pour les machines virtuelles créées à l’aide du modèle de déploiement classique, vous pouvez utiliser une session Azure PowerShell distante vers la machine virtuelle Azure.</span><span class="sxs-lookup"><span data-stu-id="800ca-186">For VMs created using the classic deployment model, you can use a remote Azure PowerShell session to the Azure virtual machine.</span></span> <span data-ttu-id="800ca-187">Tout d’abord, vous devez installer un certificat pour le service cloud d’hébergement de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="800ca-187">First, you need to install a certificate for the virtual machine's hosting cloud service.</span></span> <span data-ttu-id="800ca-188">Accédez à [Configurer l’accès à distance sécurisé de PowerShell aux machines virtuelles Azure](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) et téléchargez le fichier de script **InstallWinRMCertAzureVM.ps1** sur votre ordinateur local.</span><span class="sxs-lookup"><span data-stu-id="800ca-188">Go to [Configure Secure Remote PowerShell Access to Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) and download the **InstallWinRMCertAzureVM.ps1** script file to your local computer.</span></span>

<span data-ttu-id="800ca-189">Installez ensuite Azure PowerShell si ce n’est pas déjà fait.</span><span class="sxs-lookup"><span data-stu-id="800ca-189">Next, install Azure PowerShell if you haven't already.</span></span> <span data-ttu-id="800ca-190">Consultez [Installation et configuration d’Azure PowerShell](/powershell/azure/overview).</span><span class="sxs-lookup"><span data-stu-id="800ca-190">See [How to install and configure Azure PowerShell](/powershell/azure/overview).</span></span>

<span data-ttu-id="800ca-191">Ouvrez ensuite une invite de commandes Azure PowerShell, puis remplacez le dossier actif par l’emplacement du fichier de script **InstallWinRMCertAzureVM.ps1** .</span><span class="sxs-lookup"><span data-stu-id="800ca-191">Next, open an Azure PowerShell command prompt and change the current folder to the location of the **InstallWinRMCertAzureVM.ps1** script file.</span></span> <span data-ttu-id="800ca-192">Pour exécuter un script Azure PowerShell, vous devez définir la bonne stratégie d’exécution.</span><span class="sxs-lookup"><span data-stu-id="800ca-192">To run an Azure PowerShell script, you must set the correct execution policy.</span></span> <span data-ttu-id="800ca-193">Exécutez la commande **Get-ExecutionPolicy** afin de déterminer votre niveau de stratégie actuel.</span><span class="sxs-lookup"><span data-stu-id="800ca-193">Run the **Get-ExecutionPolicy** command to determine your current policy level.</span></span> <span data-ttu-id="800ca-194">Pour plus d’informations sur la définition du niveau approprié, consultez [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span><span class="sxs-lookup"><span data-stu-id="800ca-194">For information about setting the appropriate level, see [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span></span>

<span data-ttu-id="800ca-195">Indiquez ensuite le nom de votre abonnement Azure, le nom du service cloud et le nom de votre machine virtuelle (en supprimant les caractères < et >), puis exécutez les commandes suivantes.</span><span class="sxs-lookup"><span data-stu-id="800ca-195">Next, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the < and > characters), and then run these commands.</span></span>

```powershell
$subscr="<Name of your Azure subscription>"
$serviceName="<Name of the cloud service that contains the target virtual machine>"
$vmName="<Name of the target virtual machine>"
.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName
```

<span data-ttu-id="800ca-196">Le nom d’abonnement correct apparaît dans la propriété *SubscriptionName* de l’affichage de la commande **Get-AzureSubscription** .</span><span class="sxs-lookup"><span data-stu-id="800ca-196">You can get the correct subscription name from the *SubscriptionName* property of the display of the **Get-AzureSubscription** command.</span></span> <span data-ttu-id="800ca-197">Le nom du service cloud pour la machine virtuelle apparaît dans la colonne *ServiceName* de l’affichage de la commande **Get-AzureVM**.</span><span class="sxs-lookup"><span data-stu-id="800ca-197">You can get the cloud service name for the virtual machine from the *ServiceName* column in the display of the **Get-AzureVM** command.</span></span>

<span data-ttu-id="800ca-198">Vérifiez si vous disposez du nouveau certificat.</span><span class="sxs-lookup"><span data-stu-id="800ca-198">Check if you have the new certificate.</span></span> <span data-ttu-id="800ca-199">Ouvrez un composant logiciel enfichable Certificats pour l’utilisateur actuel, puis examinez le dossier **Autorités de certification racines de confiance\Certificats**.</span><span class="sxs-lookup"><span data-stu-id="800ca-199">Open a Certificates snap-in for the current user and look in the **Trusted Root Certification Authorities\Certificates** folder.</span></span> <span data-ttu-id="800ca-200">Vous devriez voir un certificat portant le nom DNS de votre service cloud doit apparaître dans la colonne Issued To (exemple : cloudservice4testing.cloudapp.net).</span><span class="sxs-lookup"><span data-stu-id="800ca-200">You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).</span></span>

<span data-ttu-id="800ca-201">Lancez ensuite une session Azure PowerShell distante à l’aide de ces commandes.</span><span class="sxs-lookup"><span data-stu-id="800ca-201">Next, initiate a remote Azure PowerShell session by using these commands.</span></span>

```powershell
$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
$creds = Get-Credential
Enter-PSSession -ConnectionUri $uri -Credential $creds
```

<span data-ttu-id="800ca-202">Une fois que vous avez entré les informations d’identification administrateur valides, vous devez visualiser une invite de commandes Azure PowerShell similaire à celle-ci :</span><span class="sxs-lookup"><span data-stu-id="800ca-202">After entering valid administrator credentials, you should see something similar to the following Azure PowerShell prompt:</span></span>

```powershell
[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>
```

<span data-ttu-id="800ca-203">La première partie de l’invite de commande représente le nom de votre service cloud qui contient la machine virtuelle cible, qui peut être différent de « cloudservice4testing.cloudapp.net ».</span><span class="sxs-lookup"><span data-stu-id="800ca-203">The first part of this prompt is your cloud service name that contains the target VM, which could be different from "cloudservice4testing.cloudapp.net".</span></span> <span data-ttu-id="800ca-204">Vous pouvez maintenant émettre des commandes Azure PowerShell pour ce service cloud afin d’examiner les problèmes et de corriger la configuration.</span><span class="sxs-lookup"><span data-stu-id="800ca-204">You can now issue Azure PowerShell commands for this cloud service to investigate the problems mentioned and correct the configuration.</span></span>

### <a name="to-manually-correct-the-remote-desktop-services-listening-tcp-port"></a><span data-ttu-id="800ca-205">Correction manuelle des Services Bureau à distance permettant l’écoute du port TCP</span><span class="sxs-lookup"><span data-stu-id="800ca-205">To manually correct the Remote Desktop Services listening TCP port</span></span>
<span data-ttu-id="800ca-206">À l’invite de la session Azure PowerShell à distance, exécutez cette commande.</span><span class="sxs-lookup"><span data-stu-id="800ca-206">At the remote Azure PowerShell session prompt, run this command.</span></span>

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

<span data-ttu-id="800ca-207">La propriété PortNumber indique le numéro de port actuel.</span><span class="sxs-lookup"><span data-stu-id="800ca-207">The PortNumber property shows the current port number.</span></span> <span data-ttu-id="800ca-208">Si nécessaire, utilisez cette commande pour modifier le numéro de port du Bureau à distance afin de revenir à sa valeur par défaut (3389).</span><span class="sxs-lookup"><span data-stu-id="800ca-208">If needed, change the Remote Desktop port number back to its default value (3389) by using this command.</span></span>

```powershell
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389
```

<span data-ttu-id="800ca-209">Vérifiez que le port affiche désormais la valeur 3389 à l’aide de cette commande.</span><span class="sxs-lookup"><span data-stu-id="800ca-209">Verify that the port has been changed to 3389 by using this command.</span></span>

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

<span data-ttu-id="800ca-210">Quittez la session Azure PowerShell distante à l’aide de cette commande.</span><span class="sxs-lookup"><span data-stu-id="800ca-210">Exit the remote Azure PowerShell session by using this command.</span></span>

```powershell
Exit-PSSession
```

<span data-ttu-id="800ca-211">Vérifiez que le point de terminaison du Bureau à distance de la machine virtuelle Azure utilise également le port TCP 3398 comme port interne.</span><span class="sxs-lookup"><span data-stu-id="800ca-211">Verify that the Remote Desktop endpoint for the Azure VM is also using TCP port 3398 as its internal port.</span></span> <span data-ttu-id="800ca-212">Redémarrez la machine virtuelle Azure puis testez de nouveau la connexion Bureau à distance.</span><span class="sxs-lookup"><span data-stu-id="800ca-212">Restart the Azure VM and try the Remote Desktop connection again.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="800ca-213">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="800ca-213">Additional resources</span></span>
[<span data-ttu-id="800ca-214">Réinitialisation d’un mot de passe ou du service Bureau à distance pour les machines virtuelles Windows</span><span class="sxs-lookup"><span data-stu-id="800ca-214">How to reset a password or the Remote Desktop service for Windows virtual machines</span></span>](reset-rdp.md)

[<span data-ttu-id="800ca-215">Installation et configuration d’Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="800ca-215">How to install and configure Azure PowerShell</span></span>](/powershell/azure/overview)

[<span data-ttu-id="800ca-216">Résolution des problèmes des connexions SSH avec une machine virtuelle Azure Linux</span><span class="sxs-lookup"><span data-stu-id="800ca-216">Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine</span></span>](../linux/troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

[<span data-ttu-id="800ca-217">Résolution des problèmes d’accès à une application exécutée sur une machine virtuelle Azure</span><span class="sxs-lookup"><span data-stu-id="800ca-217">Troubleshoot access to an application running on an Azure virtual machine</span></span>](../linux/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

