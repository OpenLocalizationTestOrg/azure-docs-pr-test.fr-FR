---
title: "Ajouter la surveillance et les diagnostics à une machine virtuelle Azure | Microsoft Docs"
description: "Utilisez un modèle Azure Resource Manager pour créer une machine virtuelle Windows avec l’extension Diagnostics Azure."
services: virtual-machines-windows
documentationcenter: 
author: sbtron
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 8cde8fe7-977b-43d2-be74-ad46dc946058
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 05/31/2017
ms.author: saurabh
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6955e3d8c7b032ee898be11e611080905b5069ba
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="use-monitoring-and-diagnostics-with-a-windows-vm-and-azure-resource-manager-templates"></a><span data-ttu-id="7e11b-103">Utiliser la surveillance et les diagnostics avec une machine virtuelle Windows et des modèles Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="7e11b-103">Use monitoring and diagnostics with a Windows VM and Azure Resource Manager templates</span></span>
<span data-ttu-id="7e11b-104">L’extension Diagnostics Azure fournit des fonctionnalités d’analyse et de diagnostics sur une machine virtuelle Azure basée sur Windows.</span><span class="sxs-lookup"><span data-stu-id="7e11b-104">The Azure Diagnostics Extension provides the monitoring and diagnostics capabilities on a Windows based Azure virtual machine.</span></span> <span data-ttu-id="7e11b-105">Vous pouvez activer ces fonctionnalités sur la machine virtuelle en incluant l’extension dans le modèle Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="7e11b-105">You can enable these capabilities on the virtual machine by including the extension as part of the azure resource manager template.</span></span> <span data-ttu-id="7e11b-106">Pour plus d’informations sur l’ajout d’une extension dans un modèle de machine virtuelle, consultez [Création de modèles Azure Resource Manager avec des extensions de machine virtuelle](template-description.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#extensions) .</span><span class="sxs-lookup"><span data-stu-id="7e11b-106">See [Authoring Azure Resource Manager Templates with VM Extensions](template-description.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#extensions) for more information on including any extension as part of a virtual machine template.</span></span> <span data-ttu-id="7e11b-107">Cet article décrit comment ajouter l’extension Diagnostics Azure à un modèle de machine virtuelle Windows.</span><span class="sxs-lookup"><span data-stu-id="7e11b-107">This article describes how you can add the Azure Diagnostics extension to a windows virtual machine template.</span></span>  

## <a name="add-the-azure-diagnostics-extension-to-the-vm-resource-definition"></a><span data-ttu-id="7e11b-108">Ajouter l’extension Diagnostics Azure à la définition de ressource de machine virtuelle</span><span class="sxs-lookup"><span data-stu-id="7e11b-108">Add the Azure Diagnostics extension to the VM resource definition</span></span>
<span data-ttu-id="7e11b-109">Pour activer l’extension Diagnostics sur une machine virtuelle Windows, vous devez ajouter l’extension comme ressource de machine virtuelle dans le modèle Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="7e11b-109">To enable the diagnostics extension on a Windows Virtual Machine you need to add the extension as a VM resource in the Resource manager template.</span></span>

<span data-ttu-id="7e11b-110">Pour une simple machine virtuelle basée sur Resource Manager, ajoutez la configuration de l’extension au tableau *Ressources* de la machine virtuelle :</span><span class="sxs-lookup"><span data-stu-id="7e11b-110">For a simple Resource Manager based Virtual Machine add the extension configuration to the *resources* array for the Virtual Machine:</span></span> 

    "resources": [
                {
                    "name": "Microsoft.Insights.VMDiagnosticsSettings",
                    "type": "extensions",
                    "location": "[resourceGroup().location]",
                    "apiVersion": "2015-06-15",
                    "dependsOn": [
                        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
                    ],
                    "tags": {
                        "displayName": "AzureDiagnostics"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), variables('vmName'), variables('wadcfgxend')))]",
                            "storageAccount": "[parameters('existingdiagnosticsStorageAccountName')]"
                        },
                        "protectedSettings": {
                            "storageAccountName": "[parameters('existingdiagnosticsStorageAccountName')]",
                            "storageAccountKey": "[listkeys(variables('accountid'), '2015-05-01-preview').key1]",
                            "storageAccountEndPoint": "https://core.windows.net"
                        }
                    }
                }
            ]


<span data-ttu-id="7e11b-111">Une autre convention commune est d’ajouter la configuration de l’extension au nœud racine des ressources du modèle au lieu de la définir sous le nœud des ressources de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-111">Another common convention is add the extension configuration at the root resources node of the template instead of defining it under the virtual machine's resources node.</span></span> <span data-ttu-id="7e11b-112">Avec cette approche, vous devez spécifier explicitement une relation hiérarchique entre l’extension et la machine virtuelle avec les valeurs de *nom* et de *type*.</span><span class="sxs-lookup"><span data-stu-id="7e11b-112">With this approach you have to explicitly specify a hierarchical relation between the extension and the virtual machine with the *name* and *type* values.</span></span> <span data-ttu-id="7e11b-113">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="7e11b-113">For example:</span></span> 

    "name": "[concat(variables('vmName'),'Microsoft.Insights.VMDiagnosticsSettings')]",
    "type": "Microsoft.Compute/virtualMachines/extensions",

<span data-ttu-id="7e11b-114">L’extension est toujours associée à la machine virtuelle. Vous pouvez la définir soit directement sous le nœud de ressource de la machine virtuelle, soit au niveau de base et utiliser la convention d’affectation de noms hiérarchique pour l’associer à la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-114">The extension is always associated with the virtual machine, you can either directly define it under the virtual machine's resource node directly or define it at the base level and use the hierarchical naming convention to associate it with the virtual machine.</span></span>

<span data-ttu-id="7e11b-115">Pour les jeux de mise à l’échelle de machine virtuelle, la configuration des extensions est spécifiée dans la propriété *extensionProfile* de l’élément *VirtualMachineProfile*.</span><span class="sxs-lookup"><span data-stu-id="7e11b-115">For Virtual Machine Scale Sets the extensions configuration is specified in the *extensionProfile* property of the *VirtualMachineProfile*.</span></span>

<span data-ttu-id="7e11b-116">La propriété *publisher* avec la valeur **Microsoft.Azure.Diagnostics** et la propriété *type* avec la valeur **IaaSDiagnostics** identifient de façon unique l’extension Diagnostics Azure.</span><span class="sxs-lookup"><span data-stu-id="7e11b-116">The *publisher* property with the value of **Microsoft.Azure.Diagnostics** and the *type* property with the value of **IaaSDiagnostics** uniquely identify the Azure Diagnostics extension.</span></span>

<span data-ttu-id="7e11b-117">La valeur de la propriété *name* peut être utilisée pour faire référence à l’extension dans le groupe de ressources.</span><span class="sxs-lookup"><span data-stu-id="7e11b-117">The value of the *name* property can be used to refer to the extension in the resource group.</span></span> <span data-ttu-id="7e11b-118">Le fait de la définir sur **Microsoft.Insights.VMDiagnosticsSettings** lui permet d’être facilement identifiée par le portail Azure et garantit que les graphiques de surveillance s’affichent correctement dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="7e11b-118">Setting it specifically to **Microsoft.Insights.VMDiagnosticsSettings** will enable it to be easily identified by the Azure portal ensuring that the monitoring charts show up correctly in the Azure portal.</span></span>

<span data-ttu-id="7e11b-119">L’élément *typeHandlerVersion* spécifie la version de l’extension que vous souhaitez utiliser.</span><span class="sxs-lookup"><span data-stu-id="7e11b-119">The *typeHandlerVersion* specifies the version of the extension you would like to use.</span></span> <span data-ttu-id="7e11b-120">Le fait de définir la version mineure *autoUpgradeMinorVersion* sur **true** garantit que vous obtenez la dernière version mineure de l’extension qui est disponible.</span><span class="sxs-lookup"><span data-stu-id="7e11b-120">Setting *autoUpgradeMinorVersion* minor version to **true** ensures that you will get the latest Minor version of the extension that is available.</span></span> <span data-ttu-id="7e11b-121">Il est fortement recommandé de toujours définir *autoUpgradeMinorVersion* sur **true** afin de toujours utiliser l’extension Diagnostics la plus récente avec l’ensemble des nouvelles fonctionnalités et des correctifs de bogues.</span><span class="sxs-lookup"><span data-stu-id="7e11b-121">It is highly recommended that you always set *autoUpgradeMinorVersion* to always be **true** so that you always get to use the latest available diagnostics extension with all the new features and bug fixes.</span></span> 

<span data-ttu-id="7e11b-122">L’élément *settings* contient des propriétés de configuration pour l’extension pouvant être définies et lues à partir de l’extension (on parle alors parfois de configuration publique).</span><span class="sxs-lookup"><span data-stu-id="7e11b-122">The *settings* element contains configurations properties for the extension that can be set and read back from the extension (sometimes referred to as public configuration).</span></span> <span data-ttu-id="7e11b-123">La propriété *xmlcfg* comporte la configuration XML des journaux de diagnostic, compteurs de performance, etc. qui seront collectés par l’agent de diagnostics.</span><span class="sxs-lookup"><span data-stu-id="7e11b-123">The *xmlcfg* property contains xml based configuration for the diagnostics logs, performance counters etc that will be collected by the diagnostics agent.</span></span> <span data-ttu-id="7e11b-124">Pour plus d’informations sur le schéma XML, consultez la page [Schéma de configuration des diagnostics](https://msdn.microsoft.com/library/azure/dn782207.aspx).</span><span class="sxs-lookup"><span data-stu-id="7e11b-124">See [Diagnostics Configuration Schema](https://msdn.microsoft.com/library/azure/dn782207.aspx) for more information about the xml schema itself.</span></span> <span data-ttu-id="7e11b-125">Une pratique courante consiste à stocker la configuration XML réelle en tant que variable dans le modèle Azure Resource Manager, puis à la concaténer et la coder en base64 pour définir la valeur de *xmlcfg*.</span><span class="sxs-lookup"><span data-stu-id="7e11b-125">A common practice is to store the actual xml configuration as a variable in the Azure Resource Manager template and then concatenate and base64 encode them to set the value for *xmlcfg*.</span></span> <span data-ttu-id="7e11b-126">Consultez la section [Variables de configuration des diagnostics](#diagnostics-configuration-variables) pour en savoir plus sur la façon de stocker le code XML dans des variables.</span><span class="sxs-lookup"><span data-stu-id="7e11b-126">See the section on [diagnostics configuration variables](#diagnostics-configuration-variables) to understand more about how to store the xml in variables.</span></span> <span data-ttu-id="7e11b-127">La propriété *storageAccount* spécifie le nom du compte de stockage vers lequel les données de diagnostics seront transférées.</span><span class="sxs-lookup"><span data-stu-id="7e11b-127">The *storageAccount* property specifies the name of the storage account to which diagnostics data will be transferred.</span></span> 

<span data-ttu-id="7e11b-128">Les propriétés dans *protectedSettings* (parfois désignées par le terme « configuration privée ») peuvent être définies, mais ne peuvent pas être lues ensuite.</span><span class="sxs-lookup"><span data-stu-id="7e11b-128">The properties in *protectedSettings* (sometimes referred to as private configuration) can be set but cannot be read back after being set.</span></span> <span data-ttu-id="7e11b-129">La nature en écriture seule de *protectedSettings* est utile pour stocker des secrets tels que la clé de compte de stockage où les données de diagnostics seront écrites.</span><span class="sxs-lookup"><span data-stu-id="7e11b-129">The write-only nature of *protectedSettings* makes it useful for storing secrets like the storage account key where the diagnostics data will be written.</span></span>    

## <a name="specifying-diagnostics-storage-account-as-parameters"></a><span data-ttu-id="7e11b-130">Spécification du compte de stockage de diagnostics en tant que paramètres</span><span class="sxs-lookup"><span data-stu-id="7e11b-130">Specifying diagnostics storage account as parameters</span></span>
<span data-ttu-id="7e11b-131">L’extrait de code JSON de l’extension Diagnostics ci-dessus suppose deux paramètres *existingdiagnosticsStorageAccountName* et *existingdiagnosticsStorageResourceGroup* pour spécifier le compte de stockage des données de diagnostics.</span><span class="sxs-lookup"><span data-stu-id="7e11b-131">The diagnostics extension json snippet above assumes two parameters *existingdiagnosticsStorageAccountName* and *existingdiagnosticsStorageResourceGroup* to specify the diagnostics storage account where diagnostics data will be stored.</span></span> <span data-ttu-id="7e11b-132">La spécification du compte de stockage des diagnostics comme paramètre permet de changer facilement le compte de stockage des diagnostics dans différents environnements. Par exemple, vous pouvez utiliser un compte de stockage des diagnostics pour les tests et un autre pour le déploiement en production.</span><span class="sxs-lookup"><span data-stu-id="7e11b-132">Specifying the diagnostics storage account as a parameter makes it easy to change the diagnostics storage account across different environments e.g. you may want to use a different diagnostics storage account for testing and a different one for your production deployment.</span></span>  

        "existingdiagnosticsStorageAccountName": {
            "type": "string",
            "metadata": {
        "description": "The name of an existing storage account to which diagnostics data will be transfered."
            }        
        },
        "existingdiagnosticsStorageResourceGroup": {
            "type": "string",
            "metadata": {
        "description": "The resource group for the storage account specified in existingdiagnosticsStorageAccountName"
              }
        }

<span data-ttu-id="7e11b-133">Il est recommandé de spécifier un compte de stockage des diagnostics dans un groupe de ressources différent du groupe de ressources de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-133">It is best practice to specify a diagnostics storage account in a different resource group than the resource group for the virtual machine.</span></span> <span data-ttu-id="7e11b-134">Un groupe de ressources peut être considéré comme une unité de déploiement avec sa propre durée de vie. Une machine virtuelle peut être déployée et redéployée à mesure que de nouvelles mises à jour de configurations sont appliquées, mais vous pouvez continuer à stocker les données de diagnostic dans le même compte de stockage lors des différents déploiements de machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="7e11b-134">A resource group can be considered to be a deployment unit with its own lifetime, a virtual machine can be deployed and redeployed as new configurations updates are made it to it but you may want to continue storing the diagnostics data in the same storage account across those virtual machine deployments.</span></span> <span data-ttu-id="7e11b-135">Le fait que le compte de stockage soit dans une autre ressource lui permet d’accepter les données à partir de différents déploiements de machines virtuelles, facilitant ainsi la résolution des problèmes sur les différentes versions.</span><span class="sxs-lookup"><span data-stu-id="7e11b-135">Having the storage account in a different resource enables the storage account to accept data from various virtual machine deployments making it easy to troubleshoot issues across the various versions.</span></span>

> [!NOTE]
> <span data-ttu-id="7e11b-136">Si vous créez un modèle de machine virtuelle Windows à partir de Visual Studio, le compte de stockage par défaut peut être défini de manière à utiliser le même compte de stockage que celui sur lequel le disque dur virtuel de machine virtuelle est téléchargé.</span><span class="sxs-lookup"><span data-stu-id="7e11b-136">If you create a windows virtual machine template from Visual Studio the default storage account might be set to use the same storage account where the virtual machine VHD is uploaded.</span></span> <span data-ttu-id="7e11b-137">Cela permet de simplifier la configuration initiale de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-137">This is to simplify initial setup of the VM.</span></span> <span data-ttu-id="7e11b-138">Vous devez refactoriser le modèle pour qu’il utilise un autre compte de stockage qui peut être transmis en tant que paramètre.</span><span class="sxs-lookup"><span data-stu-id="7e11b-138">You should re-factor the template to use a different storage account that can be passed in as a parameter.</span></span> 
> 
> 

## <a name="diagnostics-configuration-variables"></a><span data-ttu-id="7e11b-139">Variables de configuration des diagnostics</span><span class="sxs-lookup"><span data-stu-id="7e11b-139">Diagnostics configuration variables</span></span>
<span data-ttu-id="7e11b-140">L’extrait de code JSON de l’extension Diagnostics ci-dessus définit une variable *accountid* pour simplifier l’obtention de la clé de compte de stockage pour le stockage des diagnostics :</span><span class="sxs-lookup"><span data-stu-id="7e11b-140">The diagnostics extension json snippet above defines an *accountid* variable to simplify getting the storage account key for the diagnostics storage:</span></span>   

    "accountid": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/',parameters('existingdiagnosticsStorageResourceGroup'), '/providers/','Microsoft.Storage/storageAccounts/', parameters('existingdiagnosticsStorageAccountName'))]"


<span data-ttu-id="7e11b-141">La propriété *xmlcfg* de l’extension Diagnostics est définie à l’aide de plusieurs variables concaténées.</span><span class="sxs-lookup"><span data-stu-id="7e11b-141">The *xmlcfg* property for the diagnostics extension is defined using multiple variables that are concatenated together.</span></span> <span data-ttu-id="7e11b-142">Les valeurs de ces variables étant au format XML, elles doivent être correctement placées dans une séquence d’échappement lorsque vous définissez les variables JSON.</span><span class="sxs-lookup"><span data-stu-id="7e11b-142">The values of these variables are in xml so they need to be escaped correctly when setting the json variables.</span></span>

<span data-ttu-id="7e11b-143">Le code suivant décrit le XML de configuration des diagnostics qui collecte les compteurs de performances au niveau du système standard, ainsi que certains journaux des événements Windows et journaux d’infrastructure de diagnostics.</span><span class="sxs-lookup"><span data-stu-id="7e11b-143">The following describes the diagnostics configuration xml that collects standard system level performance counters along with some windows event logs and diagnostics infrastructure logs.</span></span> <span data-ttu-id="7e11b-144">Il a été correctement placé dans une séquence d’échappement et mis en forme afin que la configuration puisse être collée directement dans la section des variables de votre modèle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-144">It has been escaped and formatted correctly so that the configuration can directly be pasted into the variables section of your template.</span></span> <span data-ttu-id="7e11b-145">Consultez le [schéma de configuration des diagnostics](https://msdn.microsoft.com/library/azure/dn782207.aspx) pour obtenir un exemple plus lisible du XML de configuration.</span><span class="sxs-lookup"><span data-stu-id="7e11b-145">See the [Diagnostics Configuration Schema](https://msdn.microsoft.com/library/azure/dn782207.aspx) for a more human readable example of the configuration xml.</span></span>

        "wadlogs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
        "wadperfcounters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
        "wadperfcounters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
        "wadcfgxstart": "[concat(variables('wadlogs'), variables('wadperfcounters1'), variables('wadperfcounters2'), '<Metrics resourceId=\"')]",
        "wadmetricsresourceid": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name , '/providers/', 'Microsoft.Compute/virtualMachines/')]",
        "wadcfgxend": "\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>"

<span data-ttu-id="7e11b-146">Le nœud XML de définition de mesures de la configuration ci-dessus est un élément de configuration important, car il indique la manière dont les compteurs de performances définis précédemment dans le fichier XML du nœud *PerformanceCounter* sont regroupés et stockés.</span><span class="sxs-lookup"><span data-stu-id="7e11b-146">The Metrics definition xml node in the above configuration is an important configuration element as it defines how the performance counters defined earlier in the xml in *PerformanceCounter* node will be aggregated and stored.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="7e11b-147">Ces mesures déterminent les graphiques et alertes de surveillance dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="7e11b-147">These metrics drive the monitoring charts and alerts in the Azure portal.</span></span>  <span data-ttu-id="7e11b-148">Le nœud **Mesures** avec les paramètres *resourceID* et **MetricAggregation** doit être inclus dans la configuration de diagnostic pour votre machine virtuelle si vous voulez que les données de surveillance de la machine virtuelle apparaissent dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="7e11b-148">The **Metrics** node with the *resourceID* and **MetricAggregation** must be included in the diagnostics configuration for your VM if you want to see the VM monitoring data in the Azure portal.</span></span> 
> 
> 

<span data-ttu-id="7e11b-149">Voici un exemple de code XML pour les définitions de mesures :</span><span class="sxs-lookup"><span data-stu-id="7e11b-149">The following is an example of the xml for metrics definitions:</span></span> 

        <Metrics resourceId="/subscriptions/subscription().subscriptionId/resourceGroups/resourceGroup().name/providers/Microsoft.Compute/virtualMachines/vmName">
            <MetricAggregation scheduledTransferPeriod="PT1H"/>
            <MetricAggregation scheduledTransferPeriod="PT1M"/>
        </Metrics>

<span data-ttu-id="7e11b-150">L’attribut *resourceID* identifie de façon unique la machine virtuelle dans votre abonnement.</span><span class="sxs-lookup"><span data-stu-id="7e11b-150">The *resourceID* attribute uniquely identifies the virtual machine in your subscription.</span></span> <span data-ttu-id="7e11b-151">Veillez à utiliser les fonctions subscription() et resourceGroup() afin que le modèle mette automatiquement à jour ces valeurs en fonction de l’abonnement et du groupe de ressources concernés par le déploiement.</span><span class="sxs-lookup"><span data-stu-id="7e11b-151">Make sure to use the subscription() and resourceGroup() functions so that the template automatically updates those values based on the subscription and resource group you are deploying to.</span></span>

<span data-ttu-id="7e11b-152">Si vous créez plusieurs machines virtuelles dans une boucle, vous devez remplir la valeur *resourceID* avec une fonction copyIndex() pour différencier correctement chaque machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-152">If you are creating multiple Virtual Machines in a loop then you will have to populate the *resourceID* value with an copyIndex() function to correctly differentiate each individual VM.</span></span> <span data-ttu-id="7e11b-153">La valeur *xmlCfg* peut être mise à jour pour prendre en charge ce paramètre, comme indiqué ici :</span><span class="sxs-lookup"><span data-stu-id="7e11b-153">The *xmlCfg* value can be updated to support this as follows:</span></span>  

    "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), concat(parameters('vmNamePrefix'), copyindex()), variables('wadcfgxend')))]", 

<span data-ttu-id="7e11b-154">La valeur MetricAggregation de *PT1H* et *PT1M* fait référence à une agrégation sur une minute et à une agrégation sur une heure.</span><span class="sxs-lookup"><span data-stu-id="7e11b-154">The MetricAggregation value of *PT1H* and *PT1M* signify an aggregation over a minute and an aggregation over an hour.</span></span>

## <a name="wadmetrics-tables-in-storage"></a><span data-ttu-id="7e11b-155">Tables WADMetrics dans le stockage</span><span class="sxs-lookup"><span data-stu-id="7e11b-155">WADMetrics tables in storage</span></span>
<span data-ttu-id="7e11b-156">La configuration des mesures ci-dessus génère les tables de votre compte de stockage de diagnostics avec les conventions d’affectation de noms suivantes :</span><span class="sxs-lookup"><span data-stu-id="7e11b-156">The Metrics configuration above will generate tables in your diagnostics storage account with the following naming conventions:</span></span>

* <span data-ttu-id="7e11b-157">**WADMetrics** : préfixe standard pour toutes les tables WADMetrics</span><span class="sxs-lookup"><span data-stu-id="7e11b-157">**WADMetrics** : Standard prefix for all WADMetrics tables</span></span>
* <span data-ttu-id="7e11b-158">**PT1H** ou **PT1M** : indique que la table contient des données agrégées sur 1 heure ou 1 minute</span><span class="sxs-lookup"><span data-stu-id="7e11b-158">**PT1H** or **PT1M** : Signifies that the table contains aggregate data over 1 hour or 1 minute</span></span>
* <span data-ttu-id="7e11b-159">**P10D** : indique que la table contiendra les données pour une période de 10 jours à partir du moment où la table a commencé à collecter les données</span><span class="sxs-lookup"><span data-stu-id="7e11b-159">**P10D** : Signifies the table will contain data for 10 days from when the table started collecting data</span></span>
* <span data-ttu-id="7e11b-160">**V2S** : constante de chaîne</span><span class="sxs-lookup"><span data-stu-id="7e11b-160">**V2S** : String constant</span></span>
* <span data-ttu-id="7e11b-161">**aaaammjj** : date à laquelle la table a démarré la collecte de données</span><span class="sxs-lookup"><span data-stu-id="7e11b-161">**yyyymmdd** : The date at which the table started collecting data</span></span>

<span data-ttu-id="7e11b-162">Exemple : *WADMetricsPT1HP10DV2S20151108* contient les données de mesures agrégées pendant une heure et pour une période de 10 jours commençant le 11 novembre 2015</span><span class="sxs-lookup"><span data-stu-id="7e11b-162">Example: *WADMetricsPT1HP10DV2S20151108* will contain metrics data aggregated over an hour for 10 days starting on 11-Nov-2015</span></span>    

<span data-ttu-id="7e11b-163">Chaque table WADMetrics contient les colonnes suivantes :</span><span class="sxs-lookup"><span data-stu-id="7e11b-163">Each WADMetrics table will contain the following columns:</span></span>

* <span data-ttu-id="7e11b-164">**PartitionKey** : se base sur la valeur *resourceID* pour identifier de manière unique la ressource de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="7e11b-164">**PartitionKey**: The partitionkey is constructed based on the *resourceID* value to uniquely identify the VM resource.</span></span> <span data-ttu-id="7e11b-165">Par exemple : 002Fsubscriptions:<subscriptionID>:002FresourceGroups:002F<ResourceGroupName>:002Fproviders:002FMicrosoft:002ECompute:002FvirtualMachines:002F<vmName></span><span class="sxs-lookup"><span data-stu-id="7e11b-165">for e.g. : 002Fsubscriptions:<subscriptionID>:002FresourceGroups:002F<ResourceGroupName>:002Fproviders:002FMicrosoft:002ECompute:002FvirtualMachines:002F<vmName></span></span>  
* <span data-ttu-id="7e11b-166">**RowKey** : suit le format <Descending time tick>:<Performance Counter Name>.</span><span class="sxs-lookup"><span data-stu-id="7e11b-166">**RowKey** : Follows the format <Descending time tick>:<Performance Counter Name>.</span></span> <span data-ttu-id="7e11b-167">Le calcul du cycle horaire décroissant correspond aux cycles horaires maximaux moins l’heure de début de la période d’agrégation.</span><span class="sxs-lookup"><span data-stu-id="7e11b-167">The descending time tick calculation is max time ticks minus the time of the beginning of the aggregation period.</span></span> <span data-ttu-id="7e11b-168">Par exemple,</span><span class="sxs-lookup"><span data-stu-id="7e11b-168">E.g.</span></span> <span data-ttu-id="7e11b-169">si la période d’échantillonnage a démarré le 10 novembre 2015 à 00 h 00 UTC, le calcul est le suivant : DateTime.MaxValue.Ticks - (new DateTime(2015,11,10,0,0,0,DateTimeKind.Utc).Ticks).</span><span class="sxs-lookup"><span data-stu-id="7e11b-169">if the sample period started on 10-Nov-2015 and 00:00Hrs UTC then the calculation would be: DateTime.MaxValue.Ticks - (new DateTime(2015,11,10,0,0,0,DateTimeKind.Utc).Ticks).</span></span> <span data-ttu-id="7e11b-170">Pour le compteur de performances d’octets disponibles en mémoire, la clé de ligne aura l’aspect suivant : 2519551871999999999__:005CMemory:005CAvailable:0020Bytes</span><span class="sxs-lookup"><span data-stu-id="7e11b-170">For the memory available bytes performance counter the row key will look like: 2519551871999999999__:005CMemory:005CAvailable:0020Bytes</span></span>
* <span data-ttu-id="7e11b-171">**CounterName** : nom du compteur de performances.</span><span class="sxs-lookup"><span data-stu-id="7e11b-171">**CounterName** : Is the name of the performance counter.</span></span> <span data-ttu-id="7e11b-172">Cela correspond à l’élément *counterSpecifier* défini dans la configuration XML.</span><span class="sxs-lookup"><span data-stu-id="7e11b-172">This matches the *counterSpecifier* defined in the xml config.</span></span>
* <span data-ttu-id="7e11b-173">**Maximum** : valeur maximale du compteur de performances sur la période d’agrégation.</span><span class="sxs-lookup"><span data-stu-id="7e11b-173">**Maximum** : The maximum value of the performance counter over the aggregation period.</span></span>
* <span data-ttu-id="7e11b-174">**Minimum** : valeur minimale du compteur de performances sur la période d’agrégation.</span><span class="sxs-lookup"><span data-stu-id="7e11b-174">**Minimum** : The minimum value of the performance counter over the aggregation period.</span></span>
* <span data-ttu-id="7e11b-175">**Total** : somme de toutes les valeurs du compteur de performances signalées sur la période d’agrégation.</span><span class="sxs-lookup"><span data-stu-id="7e11b-175">**Total** : The sum of all values of the performance counter reported over the aggregation period.</span></span>
* <span data-ttu-id="7e11b-176">**Count** : nombre total de valeurs signalées pour le compteur de performances.</span><span class="sxs-lookup"><span data-stu-id="7e11b-176">**Count** : The total number of values reported for the performance counter.</span></span>
* <span data-ttu-id="7e11b-177">**Average** : valeur moyenne (total/count) du compteur de performances sur la période d’agrégation.</span><span class="sxs-lookup"><span data-stu-id="7e11b-177">**Average** : The average (total/count) value of the performance counter over the aggregation period.</span></span>

## <a name="next-steps"></a><span data-ttu-id="7e11b-178">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="7e11b-178">Next Steps</span></span>
* <span data-ttu-id="7e11b-179">Pour un exemple de modèle complet d’une machine virtuelle Windows avec l’extension Diagnostics, consultez [201-vm-monitoring-diagnostics-extension](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-monitoring-diagnostics-extension)</span><span class="sxs-lookup"><span data-stu-id="7e11b-179">For a complete sample template of a Windows virtual machine with diagnostics extension see [201-vm-monitoring-diagnostics-extension](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-monitoring-diagnostics-extension)</span></span>   
* <span data-ttu-id="7e11b-180">Déployer le modèle Resource Manager à l’aide d’[Azure PowerShell](ps-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) ou de la [ligne de commande Azure](../linux/create-ssh-secured-vm-from-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span><span class="sxs-lookup"><span data-stu-id="7e11b-180">Deploy the resource manager template using [Azure PowerShell](ps-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) or [Azure Command Line](../linux/create-ssh-secured-vm-from-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span></span>
* <span data-ttu-id="7e11b-181">En savoir plus sur la [création de modèles Azure Resource Manager](../../resource-group-authoring-templates.md)</span><span class="sxs-lookup"><span data-stu-id="7e11b-181">Learn more about [authoring Azure Resource Manager templates](../../resource-group-authoring-templates.md)</span></span>

