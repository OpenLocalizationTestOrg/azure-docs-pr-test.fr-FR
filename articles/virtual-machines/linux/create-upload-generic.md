---
title: "Création et téléchargement d'un disque dur virtuel Linux dans Azure"
description: "Apprenez à créer et à télécharger un disque dur virtuel (VHD) Azure contenant un système d'exploitation Linux."
services: virtual-machines-linux
documentationcenter: 
author: szarkos
manager: timlt
editor: tysonn
tags: azure-resource-manager,azure-service-management
ms.assetid: d351396c-95a0-4092-b7bf-c6aae0bbd112
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 02/02/2017
ms.author: szark
ms.openlocfilehash: ccadf55c492c097ef96f25e469dbf36fc87b6102
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="information-for-non-endorsed-distributions"></a><span data-ttu-id="a87ff-103">Informations concernant les distributions non approuvées</span><span class="sxs-lookup"><span data-stu-id="a87ff-103">Information for Non-Endorsed Distributions</span></span>
[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

<span data-ttu-id="a87ff-104">Le contrat SLA de la plateforme Azure s’applique aux machines virtuelles exécutant le système d’exploitation Linux uniquement lorsqu’une des [distributions approuvées](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) est utilisée.</span><span class="sxs-lookup"><span data-stu-id="a87ff-104">The Azure platform SLA applies to virtual machines running the Linux OS only when one of the [endorsed distributions](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) is used.</span></span> <span data-ttu-id="a87ff-105">Toutes les distributions Linux fournies dans la galerie d'images Azure sont des distributions reconnues répondant à la configuration requise.</span><span class="sxs-lookup"><span data-stu-id="a87ff-105">All Linux distributions that are provided in the Azure image gallery are endorsed distributions with the required configuration.</span></span>

* [<span data-ttu-id="a87ff-106">Linux sur Azure : Distributions approuvées</span><span class="sxs-lookup"><span data-stu-id="a87ff-106">Linux on Azure - Endorsed Distributions</span></span>](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
* [<span data-ttu-id="a87ff-107">Prise en charge d’images Linux dans Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="a87ff-107">Support for Linux images in Microsoft Azure</span></span>](https://support.microsoft.com/kb/2941892)

<span data-ttu-id="a87ff-108">Toutes les distributions exécutées sur Azure doivent remplir les conditions suivantes pour fonctionner correctement sur la plateforme.</span><span class="sxs-lookup"><span data-stu-id="a87ff-108">All distributions running on Azure will need to meet a number of prerequisites to have a chance to properly run on the platform.</span></span>  <span data-ttu-id="a87ff-109">Cet article n'est pas exhaustif, car chaque distribution est différente. Il est également possible que, même en répondant à tous les critères ci-dessous, il s'avère nécessaire de modifier votre système Linux pour garantir son fonctionnement correct sur la plateforme.</span><span class="sxs-lookup"><span data-stu-id="a87ff-109">This article is by no means comprehensive as every distribution is different; and it is quite possible that even if you meet all the criteria below you will still need to significantly tweak your Linux system to ensure that it properly runs on the platform.</span></span>

<span data-ttu-id="a87ff-110">C'est pourquoi nous recommandons de commencer avec une de nos [distributions Linux approuvées sur Azure](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) dans la mesure du possible.</span><span class="sxs-lookup"><span data-stu-id="a87ff-110">It is for this reason that we recommend that you start with one of our [Linux on Azure Endorsed Distributions](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) when possible.</span></span> <span data-ttu-id="a87ff-111">Les articles suivants vous montrent comment préparer les diverses distributions Linux approuvées prises en charge dans Azure :</span><span class="sxs-lookup"><span data-stu-id="a87ff-111">The following articles will guide you through how to prepare the various endorsed Linux distributions that are supported on Azure:</span></span>

* <span data-ttu-id="a87ff-112">**[Distributions CentOS](create-upload-centos.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-112">**[CentOS-based Distributions](create-upload-centos.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="a87ff-113">**[Debian Linux](debian-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-113">**[Debian Linux](debian-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="a87ff-114">**[Oracle Linux](oracle-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-114">**[Oracle Linux](oracle-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="a87ff-115">**[Red Hat Enterprise Linux](redhat-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-115">**[Red Hat Enterprise Linux](redhat-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="a87ff-116">**[SLES et openSUSE](suse-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-116">**[SLES & openSUSE](suse-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="a87ff-117">**[Ubuntu](create-upload-ubuntu.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="a87ff-117">**[Ubuntu](create-upload-ubuntu.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>

<span data-ttu-id="a87ff-118">La suite de cet article fournit des conseils généraux pour exécuter votre distribution Linux sur Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-118">The rest of this article will focus on general guidance for running your Linux distribution on Azure.</span></span>

## <a name="general-linux-installation-notes"></a><span data-ttu-id="a87ff-119">Notes générales d'installation de Linux</span><span class="sxs-lookup"><span data-stu-id="a87ff-119">General Linux Installation Notes</span></span>
* <span data-ttu-id="a87ff-120">Azure ne prend pas en charge le format VHDX, seulement le **VHD fixe**.</span><span class="sxs-lookup"><span data-stu-id="a87ff-120">The VHDX format is not supported in Azure, only **fixed VHD**.</span></span>  <span data-ttu-id="a87ff-121">Vous pouvez convertir le disque au format VHD à l'aide de Hyper-V Manager ou de l’applet de commande convert-vhd.</span><span class="sxs-lookup"><span data-stu-id="a87ff-121">You can convert the disk to VHD format using Hyper-V Manager or the convert-vhd cmdlet.</span></span> <span data-ttu-id="a87ff-122">Si vous utilisez VirtualBox, vous devez sélectionner **Taille fixe** par opposition à la valeur par défaut allouée dynamiquement lors de la création du disque.</span><span class="sxs-lookup"><span data-stu-id="a87ff-122">If you are using VirtualBox this means selecting **Fixed size** as opposed to the default dynamically allocated when creating the disk.</span></span>
* <span data-ttu-id="a87ff-123">Azure ne prend en charge que les machines virtuelles de la génération 1.</span><span class="sxs-lookup"><span data-stu-id="a87ff-123">Azure only supports generation 1 virtual machines.</span></span> <span data-ttu-id="a87ff-124">Vous pouvez convertir une machine virtuelle de génération 1 du format VHDX au format VHD et d'une taille à expansion dynamique en taille fixe.</span><span class="sxs-lookup"><span data-stu-id="a87ff-124">You can convert a generation 1 virtual machine from VHDX to the VHD file format and from dynamically expanding to a fixed sized disk.</span></span> <span data-ttu-id="a87ff-125">Mais vous ne pouvez pas modifier la génération d’une machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="a87ff-125">But you can't change a virtual machine's generation.</span></span> <span data-ttu-id="a87ff-126">Pour plus d’informations, consultez [Dois-je créer une machine virtuelle de génération 1 ou 2 dans Hyper-V ?](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/plan/should-i-create-a-generation-1-or-2-virtual-machine-in-hyper-v)</span><span class="sxs-lookup"><span data-stu-id="a87ff-126">For more information, see [Should I create a generation 1 or 2 virtual machine in Hyper-V?](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/plan/should-i-create-a-generation-1-or-2-virtual-machine-in-hyper-v)</span></span>
* <span data-ttu-id="a87ff-127">La taille maximale autorisée pour le disque dur virtuel s’élève à 1 023 Go.</span><span class="sxs-lookup"><span data-stu-id="a87ff-127">The maximum size allowed for the VHD is 1,023 GB.</span></span>
* <span data-ttu-id="a87ff-128">Lors de l’installation du système Linux, il est *recommandé* d’utiliser les partitions standard plutôt que LVM (qui est souvent le choix par défaut pour de nombreuses installations).</span><span class="sxs-lookup"><span data-stu-id="a87ff-128">When installing the Linux system it is *recommended* that you use standard partitions rather than LVM (often the default for many installations).</span></span> <span data-ttu-id="a87ff-129">Ceci permettra d’éviter les conflits de noms avec des machines virtuelles clonées, notamment si un disque de système d’exploitation doit être relié à une autre machine virtuelle identique à des fins de dépannage.</span><span class="sxs-lookup"><span data-stu-id="a87ff-129">This will avoid LVM name conflicts with cloned VMs, particularly if an OS disk ever needs to be attached to another identical VM for troubleshooting.</span></span> <span data-ttu-id="a87ff-130">La technique [LVM](configure-lvm.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) ou [RAID](configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) peut être utilisée sur les disques de données.</span><span class="sxs-lookup"><span data-stu-id="a87ff-130">[LVM](configure-lvm.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) or [RAID](configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) may be used on data disks.</span></span>
* <span data-ttu-id="a87ff-131">La prise en charge du noyau pour le montage de systèmes de fichiers UDF est requise.</span><span class="sxs-lookup"><span data-stu-id="a87ff-131">Kernel support for mounting UDF file systems is required.</span></span> <span data-ttu-id="a87ff-132">Au premier démarrage sur Azure, la configuration d’approvisionnement est transmise à la machine virtuelle Linux via des supports au format UDF reliés à l’invité.</span><span class="sxs-lookup"><span data-stu-id="a87ff-132">At first boot on Azure the provisioning configuration is passed to the Linux VM via UDF-formatted media that is attached to the guest.</span></span> <span data-ttu-id="a87ff-133">L’agent Linux Azure doit être en mesure de monter le système de fichiers UDF pour lire sa configuration et approvisionner la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="a87ff-133">The Azure Linux agent must be able to mount the UDF file system to read its configuration and provision the VM.</span></span>
* <span data-ttu-id="a87ff-134">Les versions du noyau Linux antérieures à la version 2.6.37 ne prennent pas en charge NUMA sur Hyper-V avec des machines virtuelles de taille supérieure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-134">Linux kernel versions below 2.6.37 do not support NUMA on Hyper-V with larger VM sizes.</span></span> <span data-ttu-id="a87ff-135">Ce problème concerne principalement les distributions antérieures utilisant le noyau Red Hat 2.6.32 en amont et a été corrigé dans la version RHEL 6.6 (kernel-2.6.32-504).</span><span class="sxs-lookup"><span data-stu-id="a87ff-135">This issue primarily impacts older distributions using the upstream Red Hat 2.6.32 kernel, and was fixed in RHEL 6.6 (kernel-2.6.32-504).</span></span> <span data-ttu-id="a87ff-136">Pour les systèmes exécutant des noyaux personnalisés dont la version est antérieure à la version 2.6.37 ou des noyaux basés sur RHEL antérieurs à la version 2.6.32-504, le paramètre de démarrage `numa=off` doit être défini sur la ligne de commande du noyau dans grub.conf.</span><span class="sxs-lookup"><span data-stu-id="a87ff-136">Systems running custom kernels older than 2.6.37, or RHEL-based kernels older than 2.6.32-504 must set the boot parameter `numa=off` on the kernel command-line in grub.conf.</span></span> <span data-ttu-id="a87ff-137">Pour plus d’informations, consultez l’article [KB 436883](https://access.redhat.com/solutions/436883) sur Red Hat.</span><span class="sxs-lookup"><span data-stu-id="a87ff-137">For more information see Red Hat [KB 436883](https://access.redhat.com/solutions/436883).</span></span>
* <span data-ttu-id="a87ff-138">Ne configurez pas une partition d'échange sur le disque du système d'exploitation.</span><span class="sxs-lookup"><span data-stu-id="a87ff-138">Do not configure a swap partition on the OS disk.</span></span> <span data-ttu-id="a87ff-139">L'agent Linux est configurable pour créer un fichier d'échange sur le disque de ressources temporaire.</span><span class="sxs-lookup"><span data-stu-id="a87ff-139">The Linux agent can be configured to create a swap file on the temporary resource disk.</span></span>  <span data-ttu-id="a87ff-140">Les étapes ci-dessous fournissent plus d'informations à ce sujet.</span><span class="sxs-lookup"><span data-stu-id="a87ff-140">More information about this can be found in the steps below.</span></span>
* <span data-ttu-id="a87ff-141">La taille des disques durs virtuels doit être un multiple de 1 Mo.</span><span class="sxs-lookup"><span data-stu-id="a87ff-141">All of the VHDs must have sizes that are multiples of 1 MB.</span></span>

### <a name="installing-kernel-modules-without-hyper-v"></a><span data-ttu-id="a87ff-142">Installation de modules de noyau sans Hyper-V</span><span class="sxs-lookup"><span data-stu-id="a87ff-142">Installing kernel modules without Hyper-V</span></span>
<span data-ttu-id="a87ff-143">Azure s’exécute sur l’hyperviseur Hyper-V. Linux nécessite donc l’installation de certains modules de noyau pour pouvoir s’exécuter dans Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-143">Azure runs on the Hyper-V hypervisor, so Linux requires that certain kernel modules are installed in order to run in Azure.</span></span> <span data-ttu-id="a87ff-144">Si vous avez une machine virtuelle qui a été créée en dehors d’Hyper-V, les programmes d’installation de Linux risquent de ne pas comprendre les pilotes pour Hyper-V dans le ramdisk initial (initrd ou initramfs), sauf s’ils détectent qu’il s’exécute dans un environnement Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="a87ff-144">If you have a VM that was created outside of Hyper-V, the Linux installers may not include the drivers for Hyper-V in the initial ramdisk (initrd or initramfs) unless it detects that it is running an a Hyper-V environment.</span></span> <span data-ttu-id="a87ff-145">Lorsque vous utilisez un système de virtualisation différent (Virtualbox, KVM, etc.) pour préparer votre image Linux, vous devrez peut-être recréer le fichier initrd pour vous assurer que les modules noyaux `hv_vmbus` et `hv_storvsc` sont disponibles dans le ramdisk initial.</span><span class="sxs-lookup"><span data-stu-id="a87ff-145">When using a different virtualization system (i.e. Virtualbox, KVM, etc.) to prepare your Linux image, you may need to rebuild the initrd to ensure that at least the `hv_vmbus` and `hv_storvsc` kernel modules are available on the initial ramdisk.</span></span>  <span data-ttu-id="a87ff-146">Ceci est un problème connu, touchant au moins les systèmes basés sur la distribution Red Hat en amont.</span><span class="sxs-lookup"><span data-stu-id="a87ff-146">This is a known issue at least on systems based on the upstream Red Hat distribution.</span></span>

<span data-ttu-id="a87ff-147">Le mécanisme de reconstruction d'image initrd ou initramfs varie en fonction de la distribution.</span><span class="sxs-lookup"><span data-stu-id="a87ff-147">The mechanism for rebuilding the initrd or initramfs image may vary depending on the distribution.</span></span> <span data-ttu-id="a87ff-148">Consultez la documentation ou le support de votre distribution pour trouver la procédure appropriée.</span><span class="sxs-lookup"><span data-stu-id="a87ff-148">Please consult your distribution's documentation or support for the proper procedure.</span></span>  <span data-ttu-id="a87ff-149">L’exemple suivant permet de régénérer le fichier initrd, à l’aide de l’utilitaire `mkinitrd` :</span><span class="sxs-lookup"><span data-stu-id="a87ff-149">Here is one example for how to rebuild the initrd using the `mkinitrd` utility:</span></span>

<span data-ttu-id="a87ff-150">Tout d'abord, sauvegardez l'image initrd existante :</span><span class="sxs-lookup"><span data-stu-id="a87ff-150">First, back up the existing initrd image:</span></span>

    # cd /boot
    # sudo cp initrd-`uname -r`.img  initrd-`uname -r`.img.bak

<span data-ttu-id="a87ff-151">Puis, régénérez initrd avec les modules noyau `hv_vmbus` et `hv_storvsc` :</span><span class="sxs-lookup"><span data-stu-id="a87ff-151">Next, rebuild the initrd with the `hv_vmbus` and `hv_storvsc` kernel modules:</span></span>

    # sudo mkinitrd --preload=hv_storvsc --preload=hv_vmbus -v -f initrd-`uname -r`.img `uname -r`


### <a name="resizing-vhds"></a><span data-ttu-id="a87ff-152">Redimensionnement des disques durs virtuels</span><span class="sxs-lookup"><span data-stu-id="a87ff-152">Resizing VHDs</span></span>
<span data-ttu-id="a87ff-153">Les images de disque dur virtuel sur Azure doivent avoir une taille virtuelle alignée à 1 Mo.</span><span class="sxs-lookup"><span data-stu-id="a87ff-153">VHD images on Azure must have a virtual size aligned to 1MB.</span></span>  <span data-ttu-id="a87ff-154">En règle générale, les disques durs virtuels créés à l'aide d'Hyper-V sont déjà alignés correctement.</span><span class="sxs-lookup"><span data-stu-id="a87ff-154">Typically, VHDs created using Hyper-V should already be aligned correctly.</span></span>  <span data-ttu-id="a87ff-155">Si le disque dur virtuel n’est pas correctement aligné, un message d’erreur semblable au suivant peut s’afficher lorsque vous tentez de créer une *image* à partir de votre disque dur virtuel :</span><span class="sxs-lookup"><span data-stu-id="a87ff-155">If the VHD is not aligned correctly then you may receive an error message similar to the following when you attempt to create an *image* from your VHD:</span></span>

    "The VHD http://<mystorageaccount>.blob.core.windows.net/vhds/MyLinuxVM.vhd has an unsupported virtual size of 21475270656 bytes. The size must be a whole number (in MBs).”

<span data-ttu-id="a87ff-156">Pour résoudre ce problème, vous pouvez redimensionner la machine virtuelle à l’aide de la console Gestionnaire Hyper-V ou de l’applet de commande Powershell [Resize-VHD](http://technet.microsoft.com/library/hh848535.aspx) .</span><span class="sxs-lookup"><span data-stu-id="a87ff-156">To remedy this you can resize the VM using either the Hyper-V Manager console or the [Resize-VHD](http://technet.microsoft.com/library/hh848535.aspx) Powershell cmdlet.</span></span>  <span data-ttu-id="a87ff-157">Si vous n’utilisez pas un environnement Windows, il est recommandé d’utiliser qemu-img pour convertir (si nécessaire) et redimensionner le disque dur virtuel.</span><span class="sxs-lookup"><span data-stu-id="a87ff-157">If you are not running in a Windows environment then it is recommended to use qemu-img to convert (if needed) and resize the VHD.</span></span>

> [!NOTE]
> <span data-ttu-id="a87ff-158">Il existe un bogue connu dans la version 2.2.1 de qemu-img, qui entraîne un formatage incorrect de disque dur virtuel.</span><span class="sxs-lookup"><span data-stu-id="a87ff-158">There is a known bug in qemu-img versions >=2.2.1 that results in an improperly formatted VHD.</span></span> <span data-ttu-id="a87ff-159">Ce problème a été résolu dans QEMU 2.6.</span><span class="sxs-lookup"><span data-stu-id="a87ff-159">The issue has been fixed in QEMU 2.6.</span></span> <span data-ttu-id="a87ff-160">Il est recommandé d’utiliser qemu-img 2.2.0 ou une version antérieure, ou d’effectuer une mise à jour à la version 2.6 ou à une version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-160">It is recommended to use either qemu-img 2.2.0 or lower, or update to 2.6 or higher.</span></span> <span data-ttu-id="a87ff-161">Référence : https://bugs.launchpad.net/qemu/+bug/1490611.</span><span class="sxs-lookup"><span data-stu-id="a87ff-161">Reference: https://bugs.launchpad.net/qemu/+bug/1490611.</span></span>
> 
> 

1. <span data-ttu-id="a87ff-162">Redimensionner le disque dur virtuel directement à l’aide d’outils comme `qemu-img` ou `vbox-manage` peut rendre le disque dur virtuel non démarrable.</span><span class="sxs-lookup"><span data-stu-id="a87ff-162">Resizing the VHD directly using tools such as `qemu-img` or `vbox-manage` may result in an unbootable VHD.</span></span>  <span data-ttu-id="a87ff-163">Il est donc recommandé de convertir d'abord le disque dur virtuel en image disque RAW.</span><span class="sxs-lookup"><span data-stu-id="a87ff-163">So it is recommended to first convert the VHD to a RAW disk image.</span></span>  <span data-ttu-id="a87ff-164">Si l'image de machine virtuelle a déjà été créée comme image disque RAW (c'est la valeur par défaut pour certains hyperviseurs comme KVM), vous pouvez ignorer cette étape :</span><span class="sxs-lookup"><span data-stu-id="a87ff-164">If the VM image was already created as RAW disk image (the default for some Hypervisors such as KVM) then you may skip this step:</span></span>
   
       # qemu-img convert -f vpc -O raw MyLinuxVM.vhd MyLinuxVM.raw

2. <span data-ttu-id="a87ff-165">Calculez la taille requise pour l'image disque afin de vous assurer que la taille virtuelle est alignée à 1 Mo.</span><span class="sxs-lookup"><span data-stu-id="a87ff-165">Calculate the required size of the disk image to ensure that the virtual size is aligned to 1MB.</span></span>  <span data-ttu-id="a87ff-166">Le script shell bash suivant peut vous y aider.</span><span class="sxs-lookup"><span data-stu-id="a87ff-166">The following bash shell script can assist with this.</span></span>  <span data-ttu-id="a87ff-167">Le script utilise « `qemu-img info` » pour déterminer la taille virtuelle de l’image disque, puis calcule la taille au 1 Mo supérieur :</span><span class="sxs-lookup"><span data-stu-id="a87ff-167">The script uses "`qemu-img info`" to determine the virtual size of the disk image and then calculates the size to the next 1MB:</span></span>
   
       rawdisk="MyLinuxVM.raw"
       vhddisk="MyLinuxVM.vhd"
   
       MB=$((1024*1024))
       size=$(qemu-img info -f raw --output json "$rawdisk" | \
              gawk 'match($0, /"virtual-size": ([0-9]+),/, val) {print val[1]}')
   
       rounded_size=$((($size/$MB + 1)*$MB))
       echo "Rounded Size = $rounded_size"

3. <span data-ttu-id="a87ff-168">Redimensionnez le disque brut à l'aide de $rounded_size défini dans le script ci-dessus :</span><span class="sxs-lookup"><span data-stu-id="a87ff-168">Resize the raw disk using $rounded_size as set in the above script:</span></span>
   
       # qemu-img resize MyLinuxVM.raw $rounded_size

4. <span data-ttu-id="a87ff-169">À présent, convertissez le disque RAW en disque dur virtuel à taille fixe :</span><span class="sxs-lookup"><span data-stu-id="a87ff-169">Now, convert the RAW disk back to a fixed-size VHD:</span></span>
   
       # qemu-img convert -f raw -o subformat=fixed -O vpc MyLinuxVM.raw MyLinuxVM.vhd

   <span data-ttu-id="a87ff-170">Ou, avec la version qemu **2.6 +** inclut l’option `force_size` :</span><span class="sxs-lookup"><span data-stu-id="a87ff-170">Or, with qemu version **2.6+** include the `force_size` option:</span></span>

       # qemu-img convert -f raw -o subformat=fixed,force_size -O vpc MyLinuxVM.raw MyLinuxVM.vhd

## <a name="linux-kernel-requirements"></a><span data-ttu-id="a87ff-171">Conditions requises pour le noyau Linux</span><span class="sxs-lookup"><span data-stu-id="a87ff-171">Linux Kernel Requirements</span></span>
<span data-ttu-id="a87ff-172">Les pilotes LIS (Linux Integration Services) pour Hyper-V et Azure sont directement liés au noyau Linux en amont.</span><span class="sxs-lookup"><span data-stu-id="a87ff-172">The Linux Integration Services (LIS) drivers for Hyper-V and Azure are contributed directly to the upstream Linux kernel.</span></span> <span data-ttu-id="a87ff-173">Ces pilotes sont déjà disponibles dans de nombreuses distributions qui comprennent une version récente du noyau Linux (3.x et supérieures). Sinon, ces distributions fournissent des versions rétroportées de ces pilotes avec leurs noyaux.</span><span class="sxs-lookup"><span data-stu-id="a87ff-173">Many distributions that include a recent Linux kernel version (i.e. 3.x) will have these drivers available already, or otherwise provide backported versions of these drivers with their kernels.</span></span>  <span data-ttu-id="a87ff-174">Ces pilotes sont mis à jour en permanence dans le noyau en amont avec de nouveaux correctifs et de nouvelles fonctionnalités. Aussi, dans la mesure du possible, il est recommandé d’exécuter une [distribution approuvée](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) comportant ces correctifs et ces modifications.</span><span class="sxs-lookup"><span data-stu-id="a87ff-174">These drivers are constantly being updated in the upstream kernel with new fixes and features, so when possible it is recommended to run an [endorsed distribution](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) that will include these fixes and updates.</span></span>

<span data-ttu-id="a87ff-175">Si vous exécutez une variante des versions Red Hat Enterprise Linux **6.0-6.3**, vous devez installer les pilotes LIS les plus récents pour Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="a87ff-175">If you are running a variant of Red Hat Enterprise Linux versions **6.0-6.3**, then you will need to install the latest LIS drivers for Hyper-V.</span></span> <span data-ttu-id="a87ff-176">Les pilotes sont disponibles [ici](http://go.microsoft.com/fwlink/p/?LinkID=254263&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="a87ff-176">The drivers can be found [at this location](http://go.microsoft.com/fwlink/p/?LinkID=254263&clcid=0x409).</span></span> <span data-ttu-id="a87ff-177">Pour RHEL **6.4+** (et les distributions dérivées), les pilotes LIS sont déjà inclus dans le noyau ; aucun package d'installation supplémentaire n'est donc nécessaire pour exécuter ces systèmes sur Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-177">As of RHEL **6.4+** (and derivatives) the LIS drivers are already included with the kernel and so no additional installation packages are needed to run those systems on Azure.</span></span>

<span data-ttu-id="a87ff-178">Si un noyau personnalisé est requis, il est recommandé d’utiliser une version plus récente du noyau (c.-à-d. **3.8+**).</span><span class="sxs-lookup"><span data-stu-id="a87ff-178">If a custom kernel is required, it is recommended to use a more recent kernel version (i.e. **3.8+**).</span></span> <span data-ttu-id="a87ff-179">Pour ces distributions ou les fournisseurs qui maintiennent leur propre noyau, il est nécessaire de rétroporter régulièrement les pilotes LIS du noyau en amont vers votre noyau personnalisé.</span><span class="sxs-lookup"><span data-stu-id="a87ff-179">For those distributions or vendors who maintain their own kernel, some effort will be required to regularly backport the LIS drivers from the upstream kernel to your custom kernel.</span></span>  <span data-ttu-id="a87ff-180">Même si vous exécutez une version relativement récente du noyau, il est fortement recommandé de conserver une trace des correctifs en amont des pilotes LIS et de les rétroporter en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="a87ff-180">Even if you are already running a relatively recent kernel version, it is highly recommended to keep track of any upstream fixes in the LIS drivers and backport those as needed.</span></span> <span data-ttu-id="a87ff-181">L’emplacement des fichiers sources du pilote LIS est disponible dans le fichier [MAINTAINERS](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/MAINTAINERS) dans l’arborescence source du noyau Linux :</span><span class="sxs-lookup"><span data-stu-id="a87ff-181">The location of the LIS driver source files is available in the [MAINTAINERS](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/MAINTAINERS) file in the Linux kernel source tree:</span></span>

    F:    arch/x86/include/asm/mshyperv.h
    F:    arch/x86/include/uapi/asm/hyperv.h
    F:    arch/x86/kernel/cpu/mshyperv.c
    F:    drivers/hid/hid-hyperv.c
    F:    drivers/hv/
    F:    drivers/input/serio/hyperv-keyboard.c
    F:    drivers/net/hyperv/
    F:    drivers/scsi/storvsc_drv.c
    F:    drivers/video/fbdev/hyperv_fb.c
    F:    include/linux/hyperv.h
    F:    tools/hv/

<span data-ttu-id="a87ff-182">Au minimum, l'absence des correctifs suivants a été reconnue pour poser des problèmes sur Azure : ils doivent donc être inclus dans le noyau.</span><span class="sxs-lookup"><span data-stu-id="a87ff-182">At a very minimum, the absence of the following patches have been known to cause problems on Azure and so these must be included in the kernel.</span></span> <span data-ttu-id="a87ff-183">Cette liste n’est pas exhaustive ni complète pour toutes les distributions :</span><span class="sxs-lookup"><span data-stu-id="a87ff-183">This list is by no means exhaustive or complete for all distributions:</span></span>

* [<span data-ttu-id="a87ff-184">ata_piix : reporter des disques dans les pilotes Hyper-V par défaut</span><span class="sxs-lookup"><span data-stu-id="a87ff-184">ata_piix: defer disks to the Hyper-V drivers by default</span></span>](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/ata/ata_piix.c?id=cd006086fa5d91414d8ff9ff2b78fbb593878e3c)
* [<span data-ttu-id="a87ff-185">storvsc : compte des paquets en transit dans le chemin RESET</span><span class="sxs-lookup"><span data-stu-id="a87ff-185">storvsc: Account for in-transit packets in the RESET path</span></span>](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/scsi/storvsc_drv.c?id=5c1b10ab7f93d24f29b5630286e323d1c5802d5c)
* [<span data-ttu-id="a87ff-186">storvsc : éviter l’utilisation de WRITE_SAME</span><span class="sxs-lookup"><span data-stu-id="a87ff-186">storvsc: avoid usage of WRITE_SAME</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=3e8f4f4065901c8dfc51407e1984495e1748c090)
* [<span data-ttu-id="a87ff-187">storvsc :désactiver WRITE_SAME pour RAID et les pilotes adaptateurs de l’hôte virtuel</span><span class="sxs-lookup"><span data-stu-id="a87ff-187">storvsc: Disable WRITE SAME for RAID and virtual host adapter drivers</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=54b2b50c20a61b51199bedb6e5d2f8ec2568fb43)
* [<span data-ttu-id="a87ff-188">storvsc : correctif de déréférence du pointeur NULL</span><span class="sxs-lookup"><span data-stu-id="a87ff-188">storvsc: NULL pointer dereference fix</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=b12bb60d6c350b348a4e1460cd68f97ccae9822e)
* [<span data-ttu-id="a87ff-189">storvsc : des défaillances de la mémoire tampon de l’anneau peuvent entraîner un gel des E/S</span><span class="sxs-lookup"><span data-stu-id="a87ff-189">storvsc: ring buffer failures may result in I/O freeze</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=e86fb5e8ab95f10ec5f2e9430119d5d35020c951)
* [<span data-ttu-id="a87ff-190">scsi_sysfs : se protéger contre une double exécution de __scsi_remove_device</span><span class="sxs-lookup"><span data-stu-id="a87ff-190">scsi_sysfs: protect against double execution of __scsi_remove_device</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/scsi_sysfs.c?id=be821fd8e62765de43cc4f0e2db363d0e30a7e9b)

## <a name="the-azure-linux-agent"></a><span data-ttu-id="a87ff-191">agent Linux Azure</span><span class="sxs-lookup"><span data-stu-id="a87ff-191">The Azure Linux Agent</span></span>
<span data-ttu-id="a87ff-192">L' [Agent Linux Azure](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) (waagent) est requis pour approvisionner une machine virtuelle Linux dans Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-192">The [Azure Linux Agent](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) (waagent) is required to properly provision a Linux virtual machine in Azure.</span></span> <span data-ttu-id="a87ff-193">La dernière version, les problèmes des fichiers ou l'envoi de requêtes d'extraction sont disponibles dans le [référentiel de l'agent Linux sur GitHub](https://github.com/Azure/WALinuxAgent).</span><span class="sxs-lookup"><span data-stu-id="a87ff-193">You can get the latest version, file issues or submit pull requests at the [Linux Agent GitHub repo](https://github.com/Azure/WALinuxAgent).</span></span>

* <span data-ttu-id="a87ff-194">L'agent Linux est publié avec la licence Apache 2.0.</span><span class="sxs-lookup"><span data-stu-id="a87ff-194">The Linux agent is released under the Apache 2.0 license.</span></span> <span data-ttu-id="a87ff-195">De nombreuses distributions fournissent déjà des packages RPM ou deb pour l'agent : dans certains cas, l'installation et la mise à jour ne nécessitent aucun travail.</span><span class="sxs-lookup"><span data-stu-id="a87ff-195">Many distributions already provide RPM or deb packages for the agent, and so in some cases this can be installed and updated with little effort.</span></span>
* <span data-ttu-id="a87ff-196">L'agent Linux Azure nécessite Python v2.6+.</span><span class="sxs-lookup"><span data-stu-id="a87ff-196">The Azure Linux Agent requires Python v2.6+.</span></span>
* <span data-ttu-id="a87ff-197">L'agent nécessite également le module python-pyasn1.</span><span class="sxs-lookup"><span data-stu-id="a87ff-197">The agent also requires the python-pyasn1 module.</span></span> <span data-ttu-id="a87ff-198">La plupart des distributions le fournissent sous la forme d'un package indépendant que vous pouvez installer.</span><span class="sxs-lookup"><span data-stu-id="a87ff-198">Most distributions provide this as a separate package that can be installed.</span></span>
* <span data-ttu-id="a87ff-199">Dans certains cas, l'agent Linux Azure n'est pas compatible avec NetworkManager.</span><span class="sxs-lookup"><span data-stu-id="a87ff-199">In some cases the Azure Linux Agent may not be compatible with NetworkManager.</span></span> <span data-ttu-id="a87ff-200">Dans la plupart des cas, NetworkManager, configuré dans les packages RPM/Deb fournis avec les distributions, entre en conflit avec le package waagent, ce qui entraîne la désinstallation de NetworkManager lors de l'installation du package de l'agent Linux.</span><span class="sxs-lookup"><span data-stu-id="a87ff-200">Many of the RPM/Deb packages provided by distributions configure NetworkManager as a conflict to the waagent package, and thus will uninstall NetworkManager when you install the Linux agent package.</span></span>

## <a name="general-linux-system-requirements"></a><span data-ttu-id="a87ff-201">Configuration générale requise Linux</span><span class="sxs-lookup"><span data-stu-id="a87ff-201">General Linux System Requirements</span></span>

* <span data-ttu-id="a87ff-202">Modifiez la ligne de démarrage du noyau dans GRUB ou GRUB2 afin d'y inclure les paramètres suivants.</span><span class="sxs-lookup"><span data-stu-id="a87ff-202">Modify the kernel boot line in GRUB or GRUB2 to include the following parameters.</span></span> <span data-ttu-id="a87ff-203">Ceci permet également d'assurer que tous les messages de la console sont envoyés vers le premier port série, ce qui peut simplifier les problèmes de débogage pour la prise en charge d'Azure :</span><span class="sxs-lookup"><span data-stu-id="a87ff-203">This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues:</span></span>
  
        console=ttyS0,115200n8 earlyprintk=ttyS0,115200 rootdelay=300
  
    <span data-ttu-id="a87ff-204">Ce permet également d'assurer que tous les messages de la console sont envoyés vers le premier port série, ce qui peut simplifier les problèmes de débogage pour la prise en charge d'Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-204">This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues.</span></span>
  
    <span data-ttu-id="a87ff-205">Outre les précautions ci-dessus, il est recommandé de *supprimer* les paramètres suivants s'ils sont présents :</span><span class="sxs-lookup"><span data-stu-id="a87ff-205">In addition to the above, it is recommended to *remove* the following parameters if they exist:</span></span>
  
        rhgb quiet crashkernel=auto
  
    <span data-ttu-id="a87ff-206">Le démarrage graphique et transparent n'est pas utile dans un environnement cloud où nous voulons que tous les journaux soient envoyés au port série.</span><span class="sxs-lookup"><span data-stu-id="a87ff-206">Graphical and quiet boot are not useful in a cloud environment where we want all the logs to be sent to the serial port.</span></span> <span data-ttu-id="a87ff-207">L’option `crashkernel` peut éventuellement être conservée. Notez cependant que ce paramètre réduit la quantité de mémoire disponible dans la machine virtuelle de 128 Mo ou plus, ce qui peut être problématique sur les machines virtuelles de petite taille.</span><span class="sxs-lookup"><span data-stu-id="a87ff-207">The `crashkernel` option may be left configured if desired, but note that this parameter will reduce the amount of available memory in the VM by 128MB or more, which may be problematic on the smaller VM sizes.</span></span>

* <span data-ttu-id="a87ff-208">Installation de l'agent Linux Azure</span><span class="sxs-lookup"><span data-stu-id="a87ff-208">Installing the Azure Linux Agent</span></span>
  
    <span data-ttu-id="a87ff-209">L'agent Linux Azure est requis pour approvisionner une image Linux sur Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-209">The Azure Linux Agent is required for provisioning a Linux image on Azure.</span></span>  <span data-ttu-id="a87ff-210">De nombreuses distributions fournissent cet agent sous forme de package RPM ou Deb (ce package est généralement nommé WALinuxAgent ou walinuxagent).</span><span class="sxs-lookup"><span data-stu-id="a87ff-210">Many distributions provide the agent as an RPM or Deb package (the package is typically called 'WALinuxAgent' or 'walinuxagent').</span></span>  <span data-ttu-id="a87ff-211">Il est également possible d'installer manuellement cet agent en suivant les instructions du [Guide de l'agent Linux](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="a87ff-211">The agent can also be installed manually by following the steps in the [Linux Agent Guide](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span>

* <span data-ttu-id="a87ff-212">Vérifiez que le serveur SSH est installé et configuré pour démarrer au moment prévu.</span><span class="sxs-lookup"><span data-stu-id="a87ff-212">Ensure that the SSH server is installed and configured to start at boot time.</span></span>  <span data-ttu-id="a87ff-213">C'est généralement le cas par défaut.</span><span class="sxs-lookup"><span data-stu-id="a87ff-213">This is usually the default.</span></span>

* <span data-ttu-id="a87ff-214">Ne créez pas d'espace swap sur le disque du système d'exploitation.</span><span class="sxs-lookup"><span data-stu-id="a87ff-214">Do not create swap space on the OS disk</span></span>
  
    <span data-ttu-id="a87ff-215">L'agent Linux Azure peut configurer automatiquement un espace swap à l'aide du disque local de ressources connecté à la machine virtuelle après déploiement sur Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-215">The Azure Linux Agent can automatically configure swap space using the local resource disk that is attached to the VM after provisioning on Azure.</span></span> <span data-ttu-id="a87ff-216">Notez que le disque de ressources local est un disque *temporaire* et qu'il peut être vidé lors de l'annulation de l'approvisionnement de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="a87ff-216">Note that the local resource disk is a *temporary* disk, and might be emptied when the VM is deprovisioned.</span></span> <span data-ttu-id="a87ff-217">Après avoir installé l'agent Linux Azure (voir l'étape précédente), modifiez les paramètres suivants dans le fichier /etc/waagent.conf :</span><span class="sxs-lookup"><span data-stu-id="a87ff-217">After installing the Azure Linux Agent (see previous step), modify the following parameters in /etc/waagent.conf appropriately:</span></span>
  
        ResourceDisk.Format=y
        ResourceDisk.Filesystem=ext4
        ResourceDisk.MountPoint=/mnt/resource
        ResourceDisk.EnableSwap=y
        ResourceDisk.SwapSizeMB=2048    ## NOTE: set this to whatever you need it to be.

* <span data-ttu-id="a87ff-218">Enfin, exécutez la commande suivante pour annuler l'approvisionnement de la machine virtuelle :</span><span class="sxs-lookup"><span data-stu-id="a87ff-218">As a final step, run the following commands to deprovision the virtual machine:</span></span>
  
        # sudo waagent -force -deprovision
        # export HISTSIZE=0
        # logout
  
  > [!NOTE]
  > <span data-ttu-id="a87ff-219">Sur Virtualbox, vous pouvez voir l’erreur suivante après l’exécution de « waagent -force -deprovision » : `[Errno 5] Input/output error`.</span><span class="sxs-lookup"><span data-stu-id="a87ff-219">On Virtualbox you may see the following error after running 'waagent -force -deprovision': `[Errno 5] Input/output error`.</span></span> <span data-ttu-id="a87ff-220">Ce message d’erreur n’est pas critique et peut être ignoré.</span><span class="sxs-lookup"><span data-stu-id="a87ff-220">This error message is not critical and can be ignored.</span></span>
  > 
  > 

* <span data-ttu-id="a87ff-221">Vous devez ensuite arrêter la machine virtuelle et télécharger le disque dur virtuel dans Azure.</span><span class="sxs-lookup"><span data-stu-id="a87ff-221">You will then need to shut down the virtual machine and upload the VHD to Azure.</span></span>

