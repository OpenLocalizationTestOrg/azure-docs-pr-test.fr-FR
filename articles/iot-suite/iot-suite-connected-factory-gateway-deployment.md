---
title: "Déploiement de votre passerelle d’usine connectée Azure IoT Suite | Microsoft Docs"
description: "Comment déployer une passerelle sur Windows ou Linux pour activer la connectivité à la solution préconfigurée d’usine connectée."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/24/2017
ms.author: dobett
ms.openlocfilehash: b0e6ae705911d7c18643c77b7fe08fdffffa5eb1
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="deploy-a-gateway-on-windows-or-linux-for-the-connected-factory-preconfigured-solution"></a><span data-ttu-id="45673-103">Déployer une passerelle sur Windows ou Linux pour la solution préconfigurée d’usine connectée</span><span class="sxs-lookup"><span data-stu-id="45673-103">Deploy a gateway on Windows or Linux for the connected factory preconfigured solution</span></span>

<span data-ttu-id="45673-104">Le logiciel requis afin de déployer une passerelle pour la solution préconfigurée d’usine connectée comporte deux composants :</span><span class="sxs-lookup"><span data-stu-id="45673-104">The software required to deploy a gateway for the connected factory preconfigured solution has two components:</span></span>

* <span data-ttu-id="45673-105">Le *Proxy OPC* établit une connexion à IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="45673-105">The *OPC Proxy* establishes a connection to IoT Hub.</span></span> <span data-ttu-id="45673-106">Le *Proxy OPC* établit une connexion à IoT Hub et attend les messages de contrôle et de commande du navigateur OPC intégré qui s’exécute sur le portail de la solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-106">The *OPC Proxy* then waits for command and control messages from the integrated OPC Browser that runs in the connected factory solution portal.</span></span>
* <span data-ttu-id="45673-107">*L’Éditeur d’OPC* se connecte aux serveurs OPC UA locaux existants et transfère leurs messages de télémétrie à IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="45673-107">The *OPC Publisher* connects to existing on-premises OPC UA servers and forwards telemetry messages from them to IoT Hub.</span></span>

<span data-ttu-id="45673-108">Les deux composants sont open source et disponibles en tant que sources sur GitHub et en tant que conteneurs Docker :</span><span class="sxs-lookup"><span data-stu-id="45673-108">Both components are open-source and are available as source on GitHub and as Docker containers:</span></span>

| <span data-ttu-id="45673-109">GitHub</span><span class="sxs-lookup"><span data-stu-id="45673-109">GitHub</span></span> | <span data-ttu-id="45673-110">DockerHub</span><span class="sxs-lookup"><span data-stu-id="45673-110">DockerHub</span></span> |
| ------ | --------- |
| <span data-ttu-id="45673-111">[Éditeur d’OPC][lnk-publisher-github]</span><span class="sxs-lookup"><span data-stu-id="45673-111">[OPC Publisher][lnk-publisher-github]</span></span> | <span data-ttu-id="45673-112">[Éditeur d’OPC][lnk-publisher-docker]</span><span class="sxs-lookup"><span data-stu-id="45673-112">[OPC Publisher][lnk-publisher-docker]</span></span> |
| <span data-ttu-id="45673-113">[Proxy OPC][lnk-proxy-github]</span><span class="sxs-lookup"><span data-stu-id="45673-113">[OPC Proxy][lnk-proxy-github]</span></span> | <span data-ttu-id="45673-114">[Proxy OPC][lnk-proxy-docker]</span><span class="sxs-lookup"><span data-stu-id="45673-114">[OPC Proxy][lnk-proxy-docker]</span></span> |

<span data-ttu-id="45673-115">Aucune adresse IP publique ni aucune faille dans le pare-feu de la passerelle n’est requise pour aucun des deux composants.</span><span class="sxs-lookup"><span data-stu-id="45673-115">No public-facing IP address or holes in the gateway firewall are required for either component.</span></span> <span data-ttu-id="45673-116">Le Proxy OPC et l’Éditeur d’OPC utilisent uniquement les ports sortants 443, 5671 et 8883.</span><span class="sxs-lookup"><span data-stu-id="45673-116">The OPC Proxy and OPC Publisher use only outbound ports 443, 5671, and 8883.</span></span>

<span data-ttu-id="45673-117">Les étapes décrites dans cet article montrent comment déployer une passerelle à l’aide de Docker sur [Windows](#windows-deployment) ou [Linux](#linux-deployment).</span><span class="sxs-lookup"><span data-stu-id="45673-117">The steps in this article show you how to deploy a gateway using Docker on either [Windows](#windows-deployment) or [Linux](#linux-deployment).</span></span> <span data-ttu-id="45673-118">La passerelle permet de se connecter à la solution préconfigurée d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-118">The gateway enables connectivity to the connected factory preconfigured solution.</span></span>

> [!NOTE]
> <span data-ttu-id="45673-119">Le logiciel de passerelle qui s’exécute dans le conteneur Docker est [Azure IoT Edge].</span><span class="sxs-lookup"><span data-stu-id="45673-119">The gateway software that runs in the Docker container is [Azure IoT Edge].</span></span>

## <a name="windows-deployment"></a><span data-ttu-id="45673-120">Déploiement sous Windows</span><span class="sxs-lookup"><span data-stu-id="45673-120">Windows deployment</span></span>

> [!NOTE]
> <span data-ttu-id="45673-121">Si vous ne possédez pas encore de passerelle, Microsoft vous recommande d’acheter une passerelle disponible dans le commerce auprès de l’un de nos partenaires.</span><span class="sxs-lookup"><span data-stu-id="45673-121">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="45673-122">Consultez le [catalogue d’appareils Azure IoT] pour obtenir la liste des passerelles compatibles avec la solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-122">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="45673-123">Suivez les instructions fournies avec la passerelle pour la configurer.</span><span class="sxs-lookup"><span data-stu-id="45673-123">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="45673-124">Vois pouvez aussi utiliser les instructions suivantes pour configurer manuellement une de vos passerelles existantes.</span><span class="sxs-lookup"><span data-stu-id="45673-124">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

### <a name="install-docker"></a><span data-ttu-id="45673-125">Installation de Docker</span><span class="sxs-lookup"><span data-stu-id="45673-125">Install Docker</span></span>

<span data-ttu-id="45673-126">Installez [Docker pour Windows] sur votre passerelle basée sur Windows.</span><span class="sxs-lookup"><span data-stu-id="45673-126">Install [Docker for Windows] on your Windows-based gateway device.</span></span> <span data-ttu-id="45673-127">Pendant l’installation de Windows Docker, sélectionnez sur l’ordinateur hôte un lecteur à partager avec Docker.</span><span class="sxs-lookup"><span data-stu-id="45673-127">During Windows Docker setup, select a drive on your host machine to share with Docker.</span></span> <span data-ttu-id="45673-128">La capture d’écran suivante illustre le partage du lecteur D sur votre système Windows :</span><span class="sxs-lookup"><span data-stu-id="45673-128">The following screenshot shows sharing the D drive on your Windows system:</span></span>

![Installation de Docker][img-install-docker]

<span data-ttu-id="45673-130">Créez ensuite un dossier appelé **docker** à la racine du lecteur partagé.</span><span class="sxs-lookup"><span data-stu-id="45673-130">Then create a folder called **docker** in the root of the shared drive.</span></span>
<span data-ttu-id="45673-131">Vous pouvez également effectuer cette étape après l’installation de Docker, à partir du menu **Paramètres**.</span><span class="sxs-lookup"><span data-stu-id="45673-131">You can also perform this step after installing docker from the **Settings** menu.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="45673-132">Configurer la passerelle</span><span class="sxs-lookup"><span data-stu-id="45673-132">Configure the gateway</span></span>

1. <span data-ttu-id="45673-133">Pour procéder au déploiement de passerelle, vous avez besoin de la chaîne de connexion **iothubowner** de votre déploiement d’usine connectée Azure IoT Suite.</span><span class="sxs-lookup"><span data-stu-id="45673-133">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="45673-134">Dans le [portail Azure], accédez à votre IoT Hub dans le groupe de ressources créé lors du déploiement de la solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-134">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="45673-135">Cliquez sur **Stratégies d’accès partagé** pour accéder à la chaîne de connexion **iothubowner** :</span><span class="sxs-lookup"><span data-stu-id="45673-135">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Recherche de la chaîne de connexion de l’IoT Hub][img-hub-connection]

    <span data-ttu-id="45673-137">Copiez la valeur **Clé primaire de la chaîne de connexion**.</span><span class="sxs-lookup"><span data-stu-id="45673-137">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="45673-138">Configurez la passerelle pour votre IoT Hub en exécutant **une seule fois** les deux modules de passerelle à partir d’une invite de commandes, avec :</span><span class="sxs-lookup"><span data-stu-id="45673-138">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a command prompt with:</span></span>

    `docker run -it --rm -h <ApplicationName> -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="45673-139">**&lt;ApplicationName&gt;** est le nom à donner à votre Éditeur OPC UA au format **publisher.&lt;votre nom de domaine complet&gt;**.</span><span class="sxs-lookup"><span data-stu-id="45673-139">**&lt;ApplicationName&gt;** is the name to give to your OPC UA Publisher in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="45673-140">Par exemple, si votre réseau d’usine se nomme **myfactorynetwork.com**, la valeur **ApplicationName** est **publisher.myfactorynetwork.com**.</span><span class="sxs-lookup"><span data-stu-id="45673-140">For example, if your factory network is called **myfactorynetwork.com**, the **ApplicationName** value is **publisher.myfactorynetwork.com**.</span></span>
    * <span data-ttu-id="45673-141">**&lt;IoTHubOwnerConnectionString&gt;** est la chaîne de connexion **iothubowner** que vous avez copiée à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="45673-141">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="45673-142">Cette chaîne de connexion est utilisée uniquement dans cette étape ; elle vous sera inutile dans les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="45673-142">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="45673-143">Utilisez le dossier mappé D :\\docker (l’argument `-v`) ultérieurement pour conserver les deux certificats X.509 utilisés par les modules de passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-143">You use the mapped D:\\docker folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="45673-144">Exécuter la passerelle</span><span class="sxs-lookup"><span data-stu-id="45673-144">Run the gateway</span></span>

1. <span data-ttu-id="45673-145">Redémarrez la passerelle en utilisant les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="45673-145">Restart the gateway using the following commands:</span></span>

    `docker run -it --rm -h <ApplicationName> --expose 62222 -p 62222:62222 -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/shared -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="45673-146">Pour des raisons de sécurité, les deux certificats X.509 conservés dans le dossier D:\\docker contiennent la clé privée.</span><span class="sxs-lookup"><span data-stu-id="45673-146">For security reasons, the two X.509 certificates persisted in the D:\\docker folder contain the private key.</span></span> <span data-ttu-id="45673-147">L’accès à ce dossier doit être limité aux informations d’identification (généralement **administrateurs**) utilisées pour exécuter le conteneur Docker.</span><span class="sxs-lookup"><span data-stu-id="45673-147">Limit access to this folder to the credentials (typically **Administrators**) you use to run the Docker container.</span></span> <span data-ttu-id="45673-148">Cliquez avec le bouton droit sur le dossier D:\\docker, choisissez **Propriétés**, puis **Sécurité**, puis **Modifier**.</span><span class="sxs-lookup"><span data-stu-id="45673-148">Right-click the D:\\docker folder, choose **Properties**, then **Security**, and then **Edit**.</span></span> <span data-ttu-id="45673-149">Donnez aux **Administrateurs** le contrôle total, et supprimez tous les autres utilisateurs :</span><span class="sxs-lookup"><span data-stu-id="45673-149">Give **Administrators** full control and remove everyone else:</span></span>

    ![Accorder des autorisations au partage Docker][img-docker-share]

1. <span data-ttu-id="45673-151">Vérifiez la connectivité du réseau.</span><span class="sxs-lookup"><span data-stu-id="45673-151">Verify network connectivity.</span></span> <span data-ttu-id="45673-152">Dans une invite de commandes, entrez la commande `ping publisher.<your fully qualified domain name>` pour effectuer un test ping sur votre passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-152">From a command prompt, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="45673-153">Si la destination est inaccessible, ajoutez l’adresse IP et le nom de votre passerelle aux fichiers hosts de votre passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-153">If the destination is unreachable, add the IP address and name of your gateway to the hosts file on your gateway.</span></span> <span data-ttu-id="45673-154">Le fichier hosts se trouve dans le dossier **Windows\\System32\\drivers\\etc**.</span><span class="sxs-lookup"><span data-stu-id="45673-154">The hosts file is located in the **Windows\\System32\\drivers\\etc** folder.</span></span>

1. <span data-ttu-id="45673-155">Essayez ensuite de vous connecter au serveur de publication à l’aide d’un client OPC UA local en cours d’exécution sur la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-155">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="45673-156">L’URL du point de terminaison OPC UA est `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="45673-156">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="45673-157">Si vous n’avez pas de client OPC UA, vous pouvez télécharger un [client OPC UA open source].</span><span class="sxs-lookup"><span data-stu-id="45673-157">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="45673-158">Lorsque vous avez terminé ces tests en local, accédez à la page **Connect your own OPC UA Server** (Connecter votre propre serveur OPC UA) du portail de solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-158">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="45673-159">Entrez l’URL du point de terminaison du serveur de publication (`tcp://publisher.<your fully qualified domain name>:62222`) et cliquez sur **Connecter**.</span><span class="sxs-lookup"><span data-stu-id="45673-159">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="45673-160">Vous obtenez un avertissement de certificat ; cliquez sur **Continuer.**</span><span class="sxs-lookup"><span data-stu-id="45673-160">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="45673-161">Vous recevez un message d’erreur indiquant que le serveur de publication n’approuve pas le client web UA.</span><span class="sxs-lookup"><span data-stu-id="45673-161">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="45673-162">Pour résoudre cette erreur, copiez le certificat **UA Web Client** du dossier **D:\\docker\\Rejected Certificates\\certs** dans le dossier **D:\\docker\\UA Applications\\certs** de la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-162">To resolve this error, copy the **UA Web Client** certificate from the **D:\\docker\\Rejected Certificates\\certs** folder to the **D:\\docker\\UA Applications\\certs** folder on the gateway.</span></span> <span data-ttu-id="45673-163">Il est inutile de redémarrer la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-163">You do not need to restart of the gateway.</span></span> <span data-ttu-id="45673-164">Répétez cette étape.</span><span class="sxs-lookup"><span data-stu-id="45673-164">Repeat this step.</span></span> <span data-ttu-id="45673-165">Vous pouvez désormais vous connecter à la passerelle à partir du cloud et ajouter des serveurs OPC UA à la solution.</span><span class="sxs-lookup"><span data-stu-id="45673-165">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="45673-166">Ajouter vos serveurs OPC UA</span><span class="sxs-lookup"><span data-stu-id="45673-166">Add your OPC UA servers</span></span>

1. <span data-ttu-id="45673-167">Accédez à la page **Connect your own OPC UA Server** (Connecter votre propre serveur OPC UA) du portail de solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-167">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="45673-168">Suivez les mêmes étapes que dans la section précédente pour établir une liaison approuvée entre le portail de la solution d’usine connectée et le serveur OPC UA.</span><span class="sxs-lookup"><span data-stu-id="45673-168">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="45673-169">Cette étape établit une approbation mutuelle des certificats à partir du portail de solution d’usine connectée et le serveur OPC UA ; elle crée également une connexion.</span><span class="sxs-lookup"><span data-stu-id="45673-169">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="45673-170">Naviguez dans l’arborescence de nœuds OPC UA de votre serveur OPC UA, cliquez avec le bouton droit sur les nœuds OPC et sélectionnez **Publier**.</span><span class="sxs-lookup"><span data-stu-id="45673-170">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="45673-171">Pour que la publication réussisse, le serveur OPC UA et le serveur de publication doivent se trouver sur le même réseau.</span><span class="sxs-lookup"><span data-stu-id="45673-171">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="45673-172">En d’autres termes, si le nom de domaine complet du serveur de publication est **publisher.mondomaine.com**, le nom de domaine complet du serveur OPC UA doit être, par exemple, **myopcuaserver.mondomaine.com**.</span><span class="sxs-lookup"><span data-stu-id="45673-172">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="45673-173">Si votre installation est différente, vous pouvez ajouter manuellement des nœuds au fichier publishesnodes.json contenu dans le dossier **D:\\docker**.</span><span class="sxs-lookup"><span data-stu-id="45673-173">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **D:\\docker** folder.</span></span> <span data-ttu-id="45673-174">Le fichier publishesnodes.json est généré automatiquement dès la publication du premier nœud OPC.</span><span class="sxs-lookup"><span data-stu-id="45673-174">The publishesnodes.json file is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="45673-175">Les données de télémétrie transitent maintenant à partir de la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-175">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="45673-176">Vous pouvez afficher les données de télémétrie dans la vue **Factory Locations** (Emplacements d’usine) du portail de solution d’usine connectée, sous **New Factory** (Nouvelle usine).</span><span class="sxs-lookup"><span data-stu-id="45673-176">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="linux-deployment"></a><span data-ttu-id="45673-177">Déploiement sous Linux</span><span class="sxs-lookup"><span data-stu-id="45673-177">Linux deployment</span></span>

> [!NOTE]
> <span data-ttu-id="45673-178">Si vous ne possédez pas encore de passerelle, Microsoft vous recommande d’acheter une passerelle disponible dans le commerce auprès de l’un de nos partenaires.</span><span class="sxs-lookup"><span data-stu-id="45673-178">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="45673-179">Consultez le [catalogue d’appareils Azure IoT] pour obtenir la liste des passerelles compatibles avec la solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-179">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="45673-180">Suivez les instructions fournies avec la passerelle pour la configurer.</span><span class="sxs-lookup"><span data-stu-id="45673-180">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="45673-181">Vois pouvez aussi utiliser les instructions suivantes pour configurer manuellement une de vos passerelles existantes.</span><span class="sxs-lookup"><span data-stu-id="45673-181">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

<span data-ttu-id="45673-182">[Installez Docker] sur votre passerelle Linux.</span><span class="sxs-lookup"><span data-stu-id="45673-182">[Install Docker] on your Linux gateway device.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="45673-183">Configurer la passerelle</span><span class="sxs-lookup"><span data-stu-id="45673-183">Configure the gateway</span></span>

1. <span data-ttu-id="45673-184">Pour procéder au déploiement de passerelle, vous avez besoin de la chaîne de connexion **iothubowner** de votre déploiement d’usine connectée Azure IoT Suite.</span><span class="sxs-lookup"><span data-stu-id="45673-184">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="45673-185">Dans le [portail Azure], accédez à votre IoT Hub dans le groupe de ressources créé lors du déploiement de la solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-185">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="45673-186">Cliquez sur **Stratégies d’accès partagé** pour accéder à la chaîne de connexion **iothubowner** :</span><span class="sxs-lookup"><span data-stu-id="45673-186">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Recherche de la chaîne de connexion de l’IoT Hub][img-hub-connection]

    <span data-ttu-id="45673-188">Copiez la valeur **Clé primaire de la chaîne de connexion**.</span><span class="sxs-lookup"><span data-stu-id="45673-188">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="45673-189">Configurez la passerelle pour votre IoT Hub en exécutant **une seule fois** les deux modules de passerelle à partir d’un interpréteur de commandes, avec :</span><span class="sxs-lookup"><span data-stu-id="45673-189">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a shell with:</span></span>

    `sudo docker run -it --rm -h <ApplicationName> -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/ -v /shared:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `sudo docker run --rm -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="45673-190">**&lt;ApplicationName&gt;** est le nom de l’application OPC UA créée par la passerelle au format **publisher.&lt;votre nom de domaine complet&gt;**.</span><span class="sxs-lookup"><span data-stu-id="45673-190">**&lt;ApplicationName&gt;** is the name of the OPC UA application the gateway creates in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="45673-191">Par exemple, **publisher.microsoft.com**.</span><span class="sxs-lookup"><span data-stu-id="45673-191">For example, **publisher.microsoft.com**.</span></span>
    * <span data-ttu-id="45673-192">**&lt;IoTHubOwnerConnectionString&gt;** est la chaîne de connexion **iothubowner** que vous avez copiée à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="45673-192">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="45673-193">Cette chaîne de connexion est utilisée uniquement dans cette étape ; elle vous sera inutile dans les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="45673-193">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="45673-194">Utilisez le dossier **/shared** (`-v` l’argument) ultérieurement pour conserver les deux certificats X.509 utilisés par les modules de passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-194">You use the **/shared** folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="45673-195">Exécuter la passerelle</span><span class="sxs-lookup"><span data-stu-id="45673-195">Run the gateway</span></span>

1. <span data-ttu-id="45673-196">Redémarrez la passerelle en utilisant les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="45673-196">Restart the gateway using the following commands:</span></span>

    `sudo docker run -it -h <ApplicationName> --expose 62222 -p 62222:62222 –-rm -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v /shared:/shared -v /shared:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `sudo docker run -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="45673-197">Pour des raisons de sécurité, les deux certificats X.509 conservés dans le dossier **/shared** contiennent la clé privée.</span><span class="sxs-lookup"><span data-stu-id="45673-197">For security reasons, the two X.509 certificates persisted in the **/shared** folder contain the private key.</span></span> <span data-ttu-id="45673-198">Limitez l’accès à ce dossier aux informations d’identification utilisées pour exécuter le conteneur Docker.</span><span class="sxs-lookup"><span data-stu-id="45673-198">Limit access to this folder to the credentials you use to run the Docker container.</span></span> <span data-ttu-id="45673-199">Pour définir les autorisations en tant que **root** uniquement, utilisez l’interpréteur de commandes `chmod` sur le dossier.</span><span class="sxs-lookup"><span data-stu-id="45673-199">To set the permissions for **root** only, use the `chmod` shell command on the folder.</span></span>

1. <span data-ttu-id="45673-200">Vérifiez la connectivité du réseau.</span><span class="sxs-lookup"><span data-stu-id="45673-200">Verify network connectivity.</span></span> <span data-ttu-id="45673-201">À partir d’un interrupteur de commandes, entrez la commande `ping publisher.<your fully qualified domain name>` pour effectuer un test ping sur votre passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-201">From a shell, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="45673-202">Si la destination est inaccessible, ajoutez l’adresse IP et le nom de votre passerelle au fichier hosts de votre passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-202">If the destination is unreachable, add the IP address and name of your gateway to your hosts file on your gateway.</span></span> <span data-ttu-id="45673-203">Le fichier hosts se trouve dans le dossier **/etc**.</span><span class="sxs-lookup"><span data-stu-id="45673-203">The hosts file is located in the **/etc** folder.</span></span>

1. <span data-ttu-id="45673-204">Essayez ensuite de vous connecter au serveur de publication à l’aide d’un client OPC UA local en cours d’exécution sur la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-204">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="45673-205">L’URL du point de terminaison OPC UA est `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="45673-205">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="45673-206">Si vous n’avez pas de client OPC UA, vous pouvez télécharger un [client OPC UA open source].</span><span class="sxs-lookup"><span data-stu-id="45673-206">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="45673-207">Lorsque vous avez terminé ces tests en local, accédez à la page **Connect your own OPC UA Server** (Connecter votre propre serveur OPC UA) du portail de solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-207">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="45673-208">Entrez l’URL du point de terminaison du serveur de publication (`tcp://publisher.<your fully qualified domain name>:62222`) et cliquez sur **Connecter**.</span><span class="sxs-lookup"><span data-stu-id="45673-208">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="45673-209">Vous obtenez un avertissement de certificat ; cliquez sur **Continuer.**</span><span class="sxs-lookup"><span data-stu-id="45673-209">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="45673-210">Vous recevez un message d’erreur indiquant que le serveur de publication n’approuve pas le client web UA.</span><span class="sxs-lookup"><span data-stu-id="45673-210">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="45673-211">Pour résoudre cette erreur, copiez le certificat **UA Web Client** du dossier **/shared/Rejected Certificates/certs** dans le dossier **/shared/UA Applications/certs** de la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-211">To resolve this error, copy the **UA Web Client** certificate from the **/shared/Rejected Certificates/certs** folder to the **/shared/UA Applications/certs** folder on the gateway.</span></span> <span data-ttu-id="45673-212">Il est inutile de redémarrer la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-212">You do not need to restart of the gateway.</span></span> <span data-ttu-id="45673-213">Répétez cette étape.</span><span class="sxs-lookup"><span data-stu-id="45673-213">Repeat this step.</span></span> <span data-ttu-id="45673-214">Vous pouvez désormais vous connecter à la passerelle à partir du cloud et ajouter des serveurs OPC UA à la solution.</span><span class="sxs-lookup"><span data-stu-id="45673-214">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="45673-215">Ajouter vos serveurs OPC UA</span><span class="sxs-lookup"><span data-stu-id="45673-215">Add your OPC UA servers</span></span>

1. <span data-ttu-id="45673-216">Accédez à la page **Connect your own OPC UA Server** (Connecter votre propre serveur OPC UA) du portail de solution d’usine connectée.</span><span class="sxs-lookup"><span data-stu-id="45673-216">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="45673-217">Suivez les mêmes étapes que dans la section précédente pour établir une liaison approuvée entre le portail de la solution d’usine connectée et le serveur OPC UA.</span><span class="sxs-lookup"><span data-stu-id="45673-217">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="45673-218">Cette étape établit une approbation mutuelle des certificats à partir du portail de solution d’usine connectée et le serveur OPC UA ; elle crée également une connexion.</span><span class="sxs-lookup"><span data-stu-id="45673-218">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="45673-219">Naviguez dans l’arborescence de nœuds OPC UA de votre serveur OPC UA, cliquez avec le bouton droit sur les nœuds OPC et sélectionnez **Publier**.</span><span class="sxs-lookup"><span data-stu-id="45673-219">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="45673-220">Pour que la publication réussisse, le serveur OPC UA et le serveur de publication doivent se trouver sur le même réseau.</span><span class="sxs-lookup"><span data-stu-id="45673-220">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="45673-221">En d’autres termes, si le nom de domaine complet du serveur de publication est **publisher.mondomaine.com**, le nom de domaine complet du serveur OPC UA doit être, par exemple, **myopcuaserver.mondomaine.com**.</span><span class="sxs-lookup"><span data-stu-id="45673-221">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="45673-222">Si votre installation est différente, vous pouvez ajouter manuellement des nœuds au fichier publishesnodes.json contenu dans le dossier **/shared**.</span><span class="sxs-lookup"><span data-stu-id="45673-222">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **/shared** folder.</span></span> <span data-ttu-id="45673-223">Le fichier publishesnodes.json est généré automatiquement dès la publication du premier nœud OPC.</span><span class="sxs-lookup"><span data-stu-id="45673-223">The publishesnodes.json is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="45673-224">Les données de télémétrie transitent maintenant à partir de la passerelle.</span><span class="sxs-lookup"><span data-stu-id="45673-224">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="45673-225">Vous pouvez afficher les données de télémétrie dans la vue **Factory Locations** (Emplacements d’usine) du portail de solution d’usine connectée, sous **New Factory** (Nouvelle usine).</span><span class="sxs-lookup"><span data-stu-id="45673-225">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="45673-226">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="45673-226">Next steps</span></span>

<span data-ttu-id="45673-227">Pour en savoir plus sur l’architecture de la solution préconfigurée d’usine connectée, consultez la [présentation de la solution préconfigurée d’usine connectée][lnk-walkthrough].</span><span class="sxs-lookup"><span data-stu-id="45673-227">To learn more about the architecture of the connected factory preconfigured solution, see [Connected factory preconfigured solution walkthrough][lnk-walkthrough].</span></span>

[img-install-docker]: ./media/iot-suite-connected-factory-gateway-deployment/image1.png
[img-hub-connection]: ./media/iot-suite-connected-factory-gateway-deployment/image2.png
[img-docker-share]: ./media/iot-suite-connected-factory-gateway-deployment/image3.png

<span data-ttu-id="45673-228">[Docker pour Windows]: https://www.docker.com/docker-windows</span><span class="sxs-lookup"><span data-stu-id="45673-228">[Docker for Windows]: https://www.docker.com/docker-windows</span></span>
<span data-ttu-id="45673-229">[catalogue d’appareils Azure IoT]: https://catalog.azureiotsuite.com/?q=opc</span><span class="sxs-lookup"><span data-stu-id="45673-229">[Azure IoT device catalog]: https://catalog.azureiotsuite.com/?q=opc</span></span>
<span data-ttu-id="45673-230">[portail Azure]: http://portal.azure.com/</span><span class="sxs-lookup"><span data-stu-id="45673-230">[Azure portal]: http://portal.azure.com/</span></span>
<span data-ttu-id="45673-231">[client OPC UA open source]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span><span class="sxs-lookup"><span data-stu-id="45673-231">[open-source OPC UA client]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span></span>
<span data-ttu-id="45673-232">[Installez Docker]: https://www.docker.com/community-edition#/download</span><span class="sxs-lookup"><span data-stu-id="45673-232">[Install Docker]: https://www.docker.com/community-edition#/download</span></span>
[lnk-walkthrough]: iot-suite-connected-factory-sample-walkthrough.md
<span data-ttu-id="45673-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span><span class="sxs-lookup"><span data-stu-id="45673-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span></span>

[lnk-publisher-github]: https://github.com/Azure/iot-edge-opc-publisher
[lnk-publisher-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua
[lnk-proxy-github]: https://github.com/Azure/iot-edge-opc-proxy
[lnk-proxy-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua-proxy