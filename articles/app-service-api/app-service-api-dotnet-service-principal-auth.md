---
title: Authentification de principal du service pour API Apps dans Azure App Service | Microsoft Docs
description: "Découvrez comment protéger une application API dans Azure App Service pour les scénarios de service à service."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a><span data-ttu-id="743ae-103">Authentification de principal du service pour API Apps dans Azure App Service</span><span class="sxs-lookup"><span data-stu-id="743ae-103">Service principal authentication for API Apps in Azure App Service</span></span>
## <a name="overview"></a><span data-ttu-id="743ae-104">Vue d'ensemble</span><span class="sxs-lookup"><span data-stu-id="743ae-104">Overview</span></span>
<span data-ttu-id="743ae-105">Cet article explique comment utiliser l’authentification App Service pour l’accès *interne* aux applications API.</span><span class="sxs-lookup"><span data-stu-id="743ae-105">This article explains how to use App Service authentication for *internal* access to API apps.</span></span> <span data-ttu-id="743ae-106">Un scénario interne se présente lorsque vous souhaitez qu’une application API soit uniquement utilisable par votre propre code d’application.</span><span class="sxs-lookup"><span data-stu-id="743ae-106">An internal scenario is where you have an API app that you want to be consumable only by your own application code.</span></span> <span data-ttu-id="743ae-107">Le moyen recommandé d’implémenter ce scénario dans App Service consiste à utiliser Azure AD pour protéger l’application API appelée.</span><span class="sxs-lookup"><span data-stu-id="743ae-107">The recommended way to implement this scenario in App Service is to use Azure AD to protect the called API app.</span></span> <span data-ttu-id="743ae-108">Vous appelez l’application API protégée avec un jeton de porteur que vous obtenez d’Azure AD en fournissant des informations d’identification de l’identité d’application (principal du service).</span><span class="sxs-lookup"><span data-stu-id="743ae-108">You call the protected API app with a bearer token that you get from Azure AD by providing application identity (service principal) credentials.</span></span> <span data-ttu-id="743ae-109">Pour connaître les possibilités autres qu’Azure AD, consultez la section **Authentification de service à service** de la [Vue d’ensemble de l’authentification Azure App Service](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span><span class="sxs-lookup"><span data-stu-id="743ae-109">For alternatives to using Azure AD, see the **Service-to-service authentication** section of the [Azure App Service authentication overview](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span></span>

<span data-ttu-id="743ae-110">Cet article porte sur les points suivants :</span><span class="sxs-lookup"><span data-stu-id="743ae-110">In this article, you'll learn:</span></span>

* <span data-ttu-id="743ae-111">Utiliser Azure Active Directory (Azure AD) pour protéger une application API contre tout accès non authentifié</span><span class="sxs-lookup"><span data-stu-id="743ae-111">How to use Azure Active Directory (Azure AD) to protect an API app from unauthenticated access.</span></span>
* <span data-ttu-id="743ae-112">Utiliser une application API protégée à partir d’une application API, web ou mobile à l’aide des informations d’identification du principal du service (identité de l’application) Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-112">How to consume a protected API app from an API app, web app, or mobile app by using Azure AD service principal (app identity) credentials.</span></span> <span data-ttu-id="743ae-113">Pour savoir comment utiliser une application API protégée à partir d’une application logique, consultez [Utilisation de votre API personnalisée hébergée sur App Service avec les applications logiques](../logic-apps/logic-apps-custom-hosted-api.md).</span><span class="sxs-lookup"><span data-stu-id="743ae-113">For information about how to consume from a logic app, see [Using your custom API hosted on App Service with Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span></span>
* <span data-ttu-id="743ae-114">S’assurer que les utilisateurs connectés n’ont pas la possibilité d’appeler l’application API protégée à partir d’un navigateur</span><span class="sxs-lookup"><span data-stu-id="743ae-114">How to make sure that the protected API app can't be called from a browser by logged on users.</span></span>
* <span data-ttu-id="743ae-115">S’assurer que seul un principal du service Azure AD spécifique a la possibilité d’appeler l’application API protégée</span><span class="sxs-lookup"><span data-stu-id="743ae-115">How to make sure that the protected API app can only be called by a specific Azure AD service principal.</span></span>

<span data-ttu-id="743ae-116">Cet article contient deux sections :</span><span class="sxs-lookup"><span data-stu-id="743ae-116">The article contains two sections:</span></span>

* <span data-ttu-id="743ae-117">La section intitulée [Procédure de configuration de l’authentification du principal du service dans Azure App Service](#authconfig) explique comment configurer l’authentification en général pour n’importe quelle application API et comment utiliser l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-117">The [How to configure service principal authentication in Azure App Service](#authconfig) section explains in general how to configure authentication for any API app, and how to consume the protected API app.</span></span> <span data-ttu-id="743ae-118">Cette section s’applique également à toutes les infrastructures prises en charge par App Service, y compris .NET, Node.js et Java.</span><span class="sxs-lookup"><span data-stu-id="743ae-118">This section applies equally to all frameworks supported by App Service, including .NET, Node.js, and Java.</span></span>
* <span data-ttu-id="743ae-119">Commençant par la section [Suite des didacticiels dédiés à la mise en route de .NET](#tutorialstart) , le didacticiel vous guide à travers la configuration d’un scénario « d’accès interne » pour un exemple d’application .NET exécuté dans App Service.</span><span class="sxs-lookup"><span data-stu-id="743ae-119">Starting with the [Continuing the .NET getting-started tutorials](#tutorialstart) section, the tutorial guides you through configuring an "internal access" scenario for a .NET sample application running in App Service.</span></span> 

## <span data-ttu-id="743ae-120"><a id="authconfig"></a> Procédure de configuration de l’authentification du principal du service dans Azure App Service</span><span class="sxs-lookup"><span data-stu-id="743ae-120"><a id="authconfig"></a> How to configure service principal authentication in Azure App Service</span></span>
<span data-ttu-id="743ae-121">Cette section fournit des instructions générales s’appliquant à n’importe quelle application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-121">This section provides general instructions that apply to any API app.</span></span> <span data-ttu-id="743ae-122">Pour connaître les étapes spécifiques à l’exemple d’application .NET To Do List, passez à la section [Suite de la série de didacticiels API Apps .NET](#tutorialstart).</span><span class="sxs-lookup"><span data-stu-id="743ae-122">For steps specific to the To Do List .NET sample application, go to [Continuing the .NET API Apps tutorial series](#tutorialstart).</span></span>

1. <span data-ttu-id="743ae-123">Dans le [portail Azure](https://portal.azure.com/), accédez au panneau **Paramètres** de l’application API que vous souhaitez protéger, puis recherchez la section **Fonctionnalités** et cliquez sur **Authentification/Autorisation**.</span><span class="sxs-lookup"><span data-stu-id="743ae-123">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you want to protect, and then find the **Features** section and click **Authentication/ Authorization**.</span></span>
   
    ![Authentification/Autorisation dans le portail Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. <span data-ttu-id="743ae-125">Dans le panneau **Authentification/Autorisation**, cliquez sur **Activé**.</span><span class="sxs-lookup"><span data-stu-id="743ae-125">In the **Authentication / Authorization** blade, click **On**.</span></span>
3. <span data-ttu-id="743ae-126">Dans la liste déroulante **Action à exécuter quand une demande n’est pas authentifiée**, sélectionnez **Se connecter avec Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="743ae-126">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory** .</span></span>
4. <span data-ttu-id="743ae-127">Sous **Fournisseurs d’authentification**, cliquez sur **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="743ae-127">Under **Authentication Providers**, select **Azure Active Directory**.</span></span>
   
    ![Panneau Authentification/Autorisation dans le portail Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. <span data-ttu-id="743ae-129">Configurez le panneau **Paramètres Azure Active Directory** pour créer une nouvelle application Azure AD ou utilisez une application Azure AD existante si vous en avez déjà une que vous souhaitez utiliser.</span><span class="sxs-lookup"><span data-stu-id="743ae-129">Configure the **Azure Active Directory Settings** blade to create a new Azure AD application, or use an existing Azure AD application if you already have one that you want to use.</span></span>
   
    <span data-ttu-id="743ae-130">Les scénarios internes impliquent généralement l’appel d’une application API à une autre.</span><span class="sxs-lookup"><span data-stu-id="743ae-130">Internal scenarios typically involve an API app calling an API app.</span></span> <span data-ttu-id="743ae-131">Vous pouvez utiliser soit des applications Azure AD distinctes pour chaque application API, soit une simple application Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-131">You can use separate Azure AD applications for each API app or just one Azure AD application.</span></span>
   
    <span data-ttu-id="743ae-132">Pour plus d’informations sur ce panneau, consultez l’article [Configurer votre application App Service pour utiliser la connexion Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="743ae-132">For detailed instructions on this blade, see [How to configure your App Service application to use Azure Active Directory login](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span></span>
6. <span data-ttu-id="743ae-133">Une fois que vous en avez terminé avec le panneau de configuration du fournisseur d’authentification, cliquez sur **OK**.</span><span class="sxs-lookup"><span data-stu-id="743ae-133">When you're done with the authentication provider configuration blade, click **OK**.</span></span>
7. <span data-ttu-id="743ae-134">Dans le panneau **Authentification/Autorisation**, cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-134">In the **Authentication / Authorization** blade, click **Save**.</span></span>
   
    ![Cliquez sur Enregistrer.](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

<span data-ttu-id="743ae-136">À présent, App Service autorise uniquement les demandes provenant d’appelants dans le client Azure AD configuré.</span><span class="sxs-lookup"><span data-stu-id="743ae-136">When this is done, App Service only allows requests from callers in the configured Azure AD tenant.</span></span> <span data-ttu-id="743ae-137">Aucun code d’authentification ou d’autorisation n’est requis dans l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-137">No authentication or authorization code is required in the protected API app.</span></span> <span data-ttu-id="743ae-138">Le jeton de porteur est transmis à l’application API avec les revendications couramment utilisées dans les en-têtes HTTP, et vous pouvez lire ces informations dans le code pour vérifier que les demandes proviennent d’un appelant particulier, par exemple un principal du service.</span><span class="sxs-lookup"><span data-stu-id="743ae-138">The bearer token is passed to the API app along with commonly used claims in HTTP headers, and you can read that information in code to validate that requests are from a particular caller, such as a service principal.</span></span>

<span data-ttu-id="743ae-139">Cette fonctionnalité d’authentification fonctionne de la même manière pour tous les langages pris en charge par App Service, notamment .NET, Node.js et Java.</span><span class="sxs-lookup"><span data-stu-id="743ae-139">This authentication functionality works the same way for all languages that App service supports, including .NET, Node.js, and Java.</span></span> 

#### <a name="how-to-consume-the-protected-api-app"></a><span data-ttu-id="743ae-140">Comment utiliser l’application API protégée</span><span class="sxs-lookup"><span data-stu-id="743ae-140">How to consume the protected API app</span></span>
<span data-ttu-id="743ae-141">L’appelant doit joindre aux appels API un jeton de porteur Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-141">The caller must provide an Azure AD bearer token with API calls.</span></span> <span data-ttu-id="743ae-142">Pour obtenir un jeton de porteur à l’aide des informations d’identification du principal du service, l’appelant utilise la bibliothèque d’authentification Active Directory (ADAL pour [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs) ou [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span><span class="sxs-lookup"><span data-stu-id="743ae-142">To get a bearer token using service principal credentials, the caller uses Active Directory Authentication Library (ADAL for [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), or [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span></span> <span data-ttu-id="743ae-143">Pour obtenir un jeton, le code qui appelle la bibliothèque ADAL lui fournit les informations suivantes :</span><span class="sxs-lookup"><span data-stu-id="743ae-143">To get a token, the code that calls ADAL provides to ADAL the following information:</span></span>

* <span data-ttu-id="743ae-144">le nom de votre client Azure AD ;</span><span class="sxs-lookup"><span data-stu-id="743ae-144">The name of your Azure AD tenant.</span></span>
* <span data-ttu-id="743ae-145">l’ID et la clé secrète du client (clé d’application) de l’application Azure AD associée à l’appelant ;</span><span class="sxs-lookup"><span data-stu-id="743ae-145">The client ID and client secret (app key) of the Azure AD app associated with the caller.</span></span>
* <span data-ttu-id="743ae-146">l’ID client de l’application Azure AD associée à l’application API protégée</span><span class="sxs-lookup"><span data-stu-id="743ae-146">The client ID of the Azure AD application associated with the protected API app.</span></span> <span data-ttu-id="743ae-147">(si une seule application Azure AD est utilisée, il s’agit du même ID client que celui de l’appelant).</span><span class="sxs-lookup"><span data-stu-id="743ae-147">(If just one Azure AD application is used, this is the same client ID as the one for the caller.)</span></span>

<span data-ttu-id="743ae-148">Ces valeurs sont disponibles dans les pages Azure AD du [portail Azure Classic](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="743ae-148">These values are available in the Azure AD pages of the [Azure classic portal](https://manage.windowsazure.com/).</span></span>

<span data-ttu-id="743ae-149">Une fois le jeton obtenu, l’appelant peut l’inclure avec les requêtes HTTP dans l’en-tête d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="743ae-149">Once the token has been acquired, the caller includes it with HTTP requests in the Authorization header.</span></span>  <span data-ttu-id="743ae-150">App Service valide le jeton et autorise les demandes à atteindre l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-150">App Service validates the token and allows the requests to reach the protected API app.</span></span>

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a><span data-ttu-id="743ae-151">Comment protéger l’application API contre tout accès par les utilisateurs dans le même client</span><span class="sxs-lookup"><span data-stu-id="743ae-151">How to protect the API app from access by users in the same tenant</span></span>
<span data-ttu-id="743ae-152">Les jetons de porteur des utilisateurs du même client sont considérés comme valides pour l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-152">Bearer tokens for users in the same tenant are considered valid for the protected API app.</span></span>  <span data-ttu-id="743ae-153">Si vous souhaitez faire en sorte que seul un principal du service puisse appeler l’application API protégée, ajoutez du code dans l’application API protégée pour valider les revendications suivantes dans le jeton :</span><span class="sxs-lookup"><span data-stu-id="743ae-153">If you want to ensure that only a service principal can call the protected API app, add code in the protected API app to validate the following claims from the token:</span></span>

* <span data-ttu-id="743ae-154">`appid` doit correspondre à l’ID client de l’application Azure AD associée à l’appelant.</span><span class="sxs-lookup"><span data-stu-id="743ae-154">`appid` should be the client ID of the Azure AD application that is associated with the caller.</span></span> 
* <span data-ttu-id="743ae-155">`oid` (`objectidentifier`) doit être l’ID du principal du service de l’appelant.</span><span class="sxs-lookup"><span data-stu-id="743ae-155">`oid` (`objectidentifier`) should be the service principal ID of the caller.</span></span> 

<span data-ttu-id="743ae-156">App Service fournit également la revendication `objectidentifier` dans l’en-tête X-MS-CLIENT-PRINCIPAL-ID.</span><span class="sxs-lookup"><span data-stu-id="743ae-156">App Service also provides the `objectidentifier` claim in the X-MS-CLIENT-PRINCIPAL-ID header.</span></span>

### <a name="how-to-protect-the-api-app-from-browser-access"></a><span data-ttu-id="743ae-157">Comment protéger l’application API contre tout accès navigateur</span><span class="sxs-lookup"><span data-stu-id="743ae-157">How to protect the API app from browser access</span></span>
<span data-ttu-id="743ae-158">Si vous ne validez pas les déclarations contenues dans le code de l’application API protégée, et si vous utilisez une application Azure AD distinctes pour l’application API protégée, assurez-vous que l’URL de réponse de l’application Azure AD est différente de l’URL de base de l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-158">If you don't validate claims in code in the protected API app, and if you use a separate Azure AD application for the protected API app, make sure that the Azure AD application's Reply URL is not the same as the API app's base URL.</span></span> <span data-ttu-id="743ae-159">Si l’URL de réponse pointe directement vers l’application API protégée, un utilisateur du même client Azure AD peut accéder à l’application API, se connecter et appeler l’API.</span><span class="sxs-lookup"><span data-stu-id="743ae-159">If the Reply URL points directly to the protected API app, a user in the same Azure AD tenant could browse to the API app, log on, and successfully call the API.</span></span>

## <span data-ttu-id="743ae-160"><a id="tutorialstart"></a> Suite de la série de didacticiels API Apps .NET</span><span class="sxs-lookup"><span data-stu-id="743ae-160"><a id="tutorialstart"></a> Continuing the .NET API Apps tutorial series</span></span>
<span data-ttu-id="743ae-161">Si vous suivez la série de didacticiels Node.js ou Java pour les applications API, passez à la section [Étapes suivantes](#next-steps) .</span><span class="sxs-lookup"><span data-stu-id="743ae-161">If you are following the Node.js or Java tutorial series for API apps, skip to the [Next steps](#next-steps) section.</span></span> 

<span data-ttu-id="743ae-162">Le reste de cet article poursuit la série de didacticiels API Apps .NET. Vous devez avoir terminé le [didacticiel sur l’authentification utilisateur](app-service-api-dotnet-user-principal-auth.md) et lancé l’exécution de l’exemple d’application dans Azure avec l’authentification utilisateur activée.</span><span class="sxs-lookup"><span data-stu-id="743ae-162">The remainder of this article continues the .NET API Apps tutorial series and assumes that you have completed the [user authentication tutorial](app-service-api-dotnet-user-principal-auth.md) and have the sample application running in Azure with user authentication enabled.</span></span>

## <a name="set-up-authentication-in-azure"></a><span data-ttu-id="743ae-163">Configurer l’authentification dans Azure</span><span class="sxs-lookup"><span data-stu-id="743ae-163">Set up authentication in Azure</span></span>
<span data-ttu-id="743ae-164">Dans cette section, vous allez configurer App Service afin que les seules requêtes HTTP autorisées à atteindre l’application API de la couche de données soient celles qui disposent de jetons de porteur Azure AD valides.</span><span class="sxs-lookup"><span data-stu-id="743ae-164">In this section you configure App Service so that the only HTTP requests it allows to reach the data tier API app are the ones that have valid Azure AD bearer tokens.</span></span> 

<span data-ttu-id="743ae-165">Dans la section suivante, vous allez configurer l’application API de niveau intermédiaire pour qu’elle envoie les informations d’identification de l’application à Azure AD et qu’elle reçoive en retour un jeton de porteur qu’elle transmettra à l’application API de la couche de données.</span><span class="sxs-lookup"><span data-stu-id="743ae-165">In the following section, you configure the middle tier API app to send application credentials to Azure AD, get back a bearer token, and send the bearer token to the data tier API app.</span></span> <span data-ttu-id="743ae-166">Ce processus est illustré dans le schéma suivant.</span><span class="sxs-lookup"><span data-stu-id="743ae-166">This process is illustrated in the diagram.</span></span>

![Diagramme d’authentification du service](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

<span data-ttu-id="743ae-168">Si vous rencontrez des problèmes en suivant les instructions du didacticiel, consultez la section [Résolution de problèmes](#troubleshooting) à la fin du didacticiel.</span><span class="sxs-lookup"><span data-stu-id="743ae-168">If you run into problems while following the tutorial directions, see the [Troubleshooting](#troubleshooting) section at the end of the tutorial.</span></span> 

1. <span data-ttu-id="743ae-169">Dans le [portail Azure](https://portal.azure.com/), accédez au panneau **Paramètres** de l’application API que vous avez créée pour l’application API ToDoListDataAPI (de la couche de données), puis cliquez sur **Paramètres**.</span><span class="sxs-lookup"><span data-stu-id="743ae-169">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you created for the ToDoListDataAPI (data tier) API app, and then click **Settings**.</span></span>
2. <span data-ttu-id="743ae-170">Dans le panneau **Paramètres**, recherchez la section **Fonctionnalités**, puis cliquez sur **Authentification/Autorisation**.</span><span class="sxs-lookup"><span data-stu-id="743ae-170">In the **Settings** blade, find the **Features** section, and then click **Authentication / Authorization**.</span></span>
   
    ![Authentification/Autorisation dans le portail Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. <span data-ttu-id="743ae-172">Dans le panneau **Authentification/Autorisation**, cliquez sur **Activé**.</span><span class="sxs-lookup"><span data-stu-id="743ae-172">In the **Authentication / Authorization** blade, click **On**.</span></span>
4. <span data-ttu-id="743ae-173">Dans la liste déroulante **Action à exécuter quand une demande n’est pas authentifiée**, sélectionnez **Se connecter avec Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="743ae-173">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory**.</span></span>
   
    <span data-ttu-id="743ae-174">Grâce à ce paramètre, APP Service veillera à ce que seules les demandes authentifiées atteignent l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-174">This is the setting that causes App Service to ensure that only authenticated requests reach the API app.</span></span> <span data-ttu-id="743ae-175">Pour les demandes qui comportent des jetons de porteur valides, App Service transmet les jetons à l’application API et remplit les en-têtes HTTP avec les déclarations courantes pour rendre ces informations plus facilement disponibles pour votre code.</span><span class="sxs-lookup"><span data-stu-id="743ae-175">For requests that have valid bearer tokens, App Service passes the tokens along to the API app and populates HTTP headers with commonly used claims to make that information more easily available to your code.</span></span>
5. <span data-ttu-id="743ae-176">Sous **Fournisseurs d’authentification**, cliquez sur **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="743ae-176">Under **Authentication Providers**, click **Azure Active Directory**.</span></span>
   
    ![Panneau Authentification/Autorisation dans le portail Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. <span data-ttu-id="743ae-178">Dans le panneau **Paramètres Azure Active Directory**, cliquez sur **Express**.</span><span class="sxs-lookup"><span data-stu-id="743ae-178">In the **Azure Active Directory Settings** blade, click **Express**.</span></span>
   
    <span data-ttu-id="743ae-179">L’option **Express** permet à Azure de créer automatiquement une application AAD dans le [client](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant)Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-179">With the **Express** option Azure can automatically create an AAD application in your Azure AD [tenant](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span></span> 
   
    <span data-ttu-id="743ae-180">Vous n’avez pas à créer un client, car chaque compte Azure en possède un.</span><span class="sxs-lookup"><span data-stu-id="743ae-180">You don't have to create a tenant, because every Azure account automatically has one.</span></span>
7. <span data-ttu-id="743ae-181">Sous **Mode d’administration**, cliquez sur **Créer une application AD**, si cette option n’est pas déjà sélectionnée.</span><span class="sxs-lookup"><span data-stu-id="743ae-181">Under **Management mode**, click **Create New AD App** if it isn't already selected.</span></span>
   
    <span data-ttu-id="743ae-182">La zone de saisie **Créer une application** du portail comporte automatiquement une valeur par défaut.</span><span class="sxs-lookup"><span data-stu-id="743ae-182">The portal plugs the **Create App** input box with a default value.</span></span> <span data-ttu-id="743ae-183">Par défaut, l’application Azure AD porte le même nom que celui de l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-183">By default, the Azure AD application is named the same as the API app.</span></span> <span data-ttu-id="743ae-184">Vous pouvez, si vous le souhaitez, choisir un autre nom.</span><span class="sxs-lookup"><span data-stu-id="743ae-184">If you prefer, you can enter a different name.</span></span>
   
    ![Paramètres Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    <span data-ttu-id="743ae-186">**Remarque**: vous pouvez également utiliser une seule application Azure AD pour l’application API appelante et l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-186">**Note**: As an alternative, you could use a single Azure AD application for both the calling API app and the protected API app.</span></span> <span data-ttu-id="743ae-187">Si vous choisissez cette solution, l’option **Créer une application AD** n’est pas utile car vous avez déjà créé une application Azure AD dans le didacticiel sur l’authentification utilisateur.</span><span class="sxs-lookup"><span data-stu-id="743ae-187">If you chose that alternative, you would not need the **Create New AD App** option here because you already created an Azure AD application earlier in the user authentication tutorial.</span></span> <span data-ttu-id="743ae-188">Pour ce didacticiel, vous allez utiliser des applications Azure AD distinctes pour l’application API appelante et l’application API protégée.</span><span class="sxs-lookup"><span data-stu-id="743ae-188">For this tutorial, you'll use separate Azure AD applications for the calling API app and the protected API app.</span></span>
8. <span data-ttu-id="743ae-189">Notez la valeur contenue dans la zone de saisie **Créer une application** ; vous rechercherez plus tard cette application AAD dans le portail Azure Classic.</span><span class="sxs-lookup"><span data-stu-id="743ae-189">Make a note of the value that is in the **Create App** input box; you'll look up this AAD application in the Azure classic portal later.</span></span>
9. <span data-ttu-id="743ae-190">Cliquez sur **OK**.</span><span class="sxs-lookup"><span data-stu-id="743ae-190">Click **OK**.</span></span>
10. <span data-ttu-id="743ae-191">Dans le panneau **Authentification/Autorisation**, cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-191">In the **Authentication / Authorization** blade, click **Save**.</span></span>
    
    ![Cliquez sur Enregistrer.](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    <span data-ttu-id="743ae-193">App Service crée une application Azure Active Directory en paramétrant automatiquement **l’URL de connexion** et **l’URL de réponse** sur l’URL de votre application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-193">App Service creates an Azure Active Directory application with **Sign-on URL** and **Reply URL** automatically set to the URL of your API app.</span></span> <span data-ttu-id="743ae-194">Cette valeur permet aux utilisateurs de votre client AAD de se connecter et d’accéder à l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-194">The latter value enables users in your AAD tenant to log in and access the API app.</span></span>

### <a name="verify-that-the-api-app-is-protected"></a><span data-ttu-id="743ae-195">Vérifier la protection de l’application API</span><span class="sxs-lookup"><span data-stu-id="743ae-195">Verify that the API app is protected</span></span>
1. <span data-ttu-id="743ae-196">Dans un navigateur, accédez à l’URL de l’application API : dans le panneau **Application API** du portail Azure, cliquez sur le lien situé sous **URL**.</span><span class="sxs-lookup"><span data-stu-id="743ae-196">In a browser go to the URL of the API app: in the **API app** blade in the Azure portal, click the link under **URL**.</span></span> 
   
    <span data-ttu-id="743ae-197">Vous êtes redirigé vers un écran de connexion, car les demandes non authentifiées ne sont pas autorisées à atteindre l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-197">You are redirected to a login screen because unauthenticated requests are not allowed to reach the API app.</span></span> 
   
    <span data-ttu-id="743ae-198">Si votre navigateur accède à l’interface utilisateur Swagger, cela signifie qu’il est peut-être déjà connecté. Dans ce cas, ouvrez une fenêtre InPrivate ou Incognito et accédez à l’URL de l’interface utilisateur Swagger.</span><span class="sxs-lookup"><span data-stu-id="743ae-198">If your browser does go to the Swagger UI, your browser might already be logged on -- in that case, open an InPrivate or Incognito window and go to the Swagger UI URL.</span></span>
2. <span data-ttu-id="743ae-199">Connectez-vous avec les informations d’identification d’un utilisateur de votre client AAD.</span><span class="sxs-lookup"><span data-stu-id="743ae-199">Log in with credentials of a user in your AAD tenant.</span></span>
   
   <span data-ttu-id="743ae-200">Une fois connecté, la page signalant que la création a réussi s’affiche dans le navigateur.</span><span class="sxs-lookup"><span data-stu-id="743ae-200">When you're logged on, the "successfully created" page appears in the browser.</span></span>

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="743ae-201">Configurer le projet ToDoListAPI pour acquérir et envoyer le jeton Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-201">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="743ae-202">Dans cette section, vous effectuerez les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="743ae-202">In this section you do the following tasks:</span></span>

* <span data-ttu-id="743ae-203">Ajouter du code dans l’application API de niveau intermédiaire qui utilise les informations d’identification de l’application Azure AD pour acquérir un jeton et l’envoyer en même temps que les requêtes HTTP à l’application API de la couche de données.</span><span class="sxs-lookup"><span data-stu-id="743ae-203">Add code in the middle tier API app that uses Azure AD application credentials to acquire a token and send it with HTTP requests to the data tier API app.</span></span>
* <span data-ttu-id="743ae-204">Obtenir auprès d’Azure AD les informations d’identification dont vous avez besoin.</span><span class="sxs-lookup"><span data-stu-id="743ae-204">Get the credentials you need from Azure AD.</span></span>
* <span data-ttu-id="743ae-205">Saisir les informations d’identification dans les paramètres de l’environnement d’exécution Azure App Service de l’application API de niveau intermédiaire.</span><span class="sxs-lookup"><span data-stu-id="743ae-205">Enter the credentials into Azure App Service runtime environment settings in the middle tier API app.</span></span> 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="743ae-206">Configurer le projet ToDoListAPI pour acquérir et envoyer le jeton Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-206">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="743ae-207">Dans Visual Studio, apportez les modifications suivantes au projet ToDoListAPI.</span><span class="sxs-lookup"><span data-stu-id="743ae-207">Make the following changes in the ToDoListAPI project in Visual Studio.</span></span>

1. <span data-ttu-id="743ae-208">Dans le fichier *ServicePrincipal.cs* , supprimez les commentaires sur l’ensemble du code.</span><span class="sxs-lookup"><span data-stu-id="743ae-208">Uncomment all of the code in the *ServicePrincipal.cs* file.</span></span>
   
    <span data-ttu-id="743ae-209">Ce code utilise la bibliothèque ADAL pour .NET dans le but d’acquérir le jeton du porteur Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-209">This is the code that uses ADAL for .NET to acquire the Azure AD bearer token.</span></span>  <span data-ttu-id="743ae-210">Il utilise plusieurs valeurs de configuration que vous définirez ultérieurement dans l’environnement d’exécution Azure.</span><span class="sxs-lookup"><span data-stu-id="743ae-210">It uses several configuration values that you'll set in the Azure runtime environment later.</span></span> <span data-ttu-id="743ae-211">Voici le code :</span><span class="sxs-lookup"><span data-stu-id="743ae-211">Here's the code:</span></span> 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    <span data-ttu-id="743ae-212">**Remarque :** ce code nécessite la bibliothèque ADAL du package NuGet .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), lequel est préinstallé dans le projet.</span><span class="sxs-lookup"><span data-stu-id="743ae-212">**Note:** This code requires the ADAL for .NET NuGet package (Microsoft.IdentityModel.Clients.ActiveDirectory), which is already installed in the project.</span></span> <span data-ttu-id="743ae-213">Si vous avez créé entièrement ce projet, vous devrez installer ce package.</span><span class="sxs-lookup"><span data-stu-id="743ae-213">If you were creating this project from scratch, you would have to install this package.</span></span> <span data-ttu-id="743ae-214">Ce package n’est pas installé automatiquement par le modèle de nouveau projet d’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-214">This package is not automatically installed by the API app new-project template.</span></span>
2. <span data-ttu-id="743ae-215">Dans *Contrôleurs/ToDoListController*, supprimez les commentaires du code dans la méthode `NewDataAPIClient` qui ajoute un jeton aux requêtes HTTP dans l’en-tête d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="743ae-215">In *Controllers/ToDoListController*, uncomment the code in the `NewDataAPIClient` method that adds the token to HTTP requests in the authorization header.</span></span>
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. <span data-ttu-id="743ae-216">Déployez le projet ToDoListAPI</span><span class="sxs-lookup"><span data-stu-id="743ae-216">Deploy the ToDoListAPI project.</span></span> <span data-ttu-id="743ae-217">(Cliquez avec le bouton droit sur le projet, puis cliquez sur **Publier > Publier**).</span><span class="sxs-lookup"><span data-stu-id="743ae-217">(Right-click the project, then click **Publish > Publish**.)</span></span>
   
    <span data-ttu-id="743ae-218">Visual Studio déploie le projet et ouvre un navigateur vers l’URL de base d’application Web.</span><span class="sxs-lookup"><span data-stu-id="743ae-218">Visual Studio deploys the project and opens a browser to the web app's base URL.</span></span> <span data-ttu-id="743ae-219">Cette commande affiche la page d’erreur 403, ce qui est normal pour une tentative d’accès à une URL de base d’API Web depuis un navigateur.</span><span class="sxs-lookup"><span data-stu-id="743ae-219">This will show a 403 error page, which is normal for an attempt to go to a Web API base URL from a browser.</span></span>
4. <span data-ttu-id="743ae-220">Fermez le navigateur.</span><span class="sxs-lookup"><span data-stu-id="743ae-220">Close the browser.</span></span>

### <a name="get-azure-ad-configuration-values"></a><span data-ttu-id="743ae-221">Obtenir les valeurs de configuration Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-221">Get Azure AD configuration values</span></span>
1. <span data-ttu-id="743ae-222">Dans le [portail Azure Classic](https://manage.windowsazure.com/), accédez à **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="743ae-222">In the [Azure classic portal](https://manage.windowsazure.com/), go to **Azure Active Directory**.</span></span>
2. <span data-ttu-id="743ae-223">Sous l’onglet **Annuaire** , cliquez sur votre client AAD.</span><span class="sxs-lookup"><span data-stu-id="743ae-223">On the **Directory** tab, click your AAD tenant.</span></span>
3. <span data-ttu-id="743ae-224">Cliquez sur **Applications > Applications que ma société possède**, puis cliquez sur la coche.</span><span class="sxs-lookup"><span data-stu-id="743ae-224">Click **Applications > Applications my company owns**, and then click the check mark.</span></span>
4. <span data-ttu-id="743ae-225">Dans la liste des applications, cliquez sur le nom de l’application qu’Azure a créée pour vous lorsque vous avez activé l’authentification pour l’application API ToDoListDataAPI (couche de données).</span><span class="sxs-lookup"><span data-stu-id="743ae-225">In the list of applications, click the name of the one that Azure created for you when you enabled authentication for the ToDoListDataAPI (data tier) API app.</span></span>
5. <span data-ttu-id="743ae-226">Cliquez sur l’onglet **Configurer** .</span><span class="sxs-lookup"><span data-stu-id="743ae-226">Click the **Configure** tab.</span></span>
6. <span data-ttu-id="743ae-227">Copiez la valeur **ID client** et enregistrez-la à un emplacement où vous pourrez la récupérer par la suite.</span><span class="sxs-lookup"><span data-stu-id="743ae-227">Copy the **Client ID** value and save it someplace you can get it from later.</span></span> 
7. <span data-ttu-id="743ae-228">Dans le portail Azure Classic, revenez à la liste **Applications que ma société possède**, puis cliquez sur l’application AAD que vous avez créée pour l’application API ToDoListAPI (celle que vous avez créée dans le précédent didacticiel, pas celle que vous avez créée dans ce didacticiel).</span><span class="sxs-lookup"><span data-stu-id="743ae-228">In the Azure classic portal go back to the list of **Applications my company owns**, and click the AAD application that you created for the middle tier ToDoListAPI API app (the one you created in the previous tutorial, not the one you created in this tutorial).</span></span>
8. <span data-ttu-id="743ae-229">Cliquez sur l’onglet **Configurer** .</span><span class="sxs-lookup"><span data-stu-id="743ae-229">Click the **Configure** tab.</span></span>
9. <span data-ttu-id="743ae-230">Copiez la valeur **ID client** et enregistrez-la à un emplacement où vous pourrez la récupérer par la suite.</span><span class="sxs-lookup"><span data-stu-id="743ae-230">Copy the **Client ID** value and save it someplace you can get it from later.</span></span>
10. <span data-ttu-id="743ae-231">Sous **Clés**, sélectionnez **1 an** dans la liste déroulante **Sélectionner une durée**.</span><span class="sxs-lookup"><span data-stu-id="743ae-231">Under **keys**, select **1 year** from the **Select duration** drop-down list.</span></span>
11. <span data-ttu-id="743ae-232">Cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-232">Click **Save**.</span></span>
    
     ![Générer la clé d’application](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. <span data-ttu-id="743ae-234">Copiez la valeur de clé et enregistrez-la à un emplacement où vous pourrez la récupérer par la suite.</span><span class="sxs-lookup"><span data-stu-id="743ae-234">Copy the key value and save it someplace you can get it from later.</span></span>
    
     ![Copiez la nouvelle clé d’application](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a><span data-ttu-id="743ae-236">Configurer les paramètres d’Azure AD dans l’environnement d’exécution de l’application API de niveau intermédiaire</span><span class="sxs-lookup"><span data-stu-id="743ae-236">Configure Azure AD settings in the middle tier API app's runtime environment</span></span>
1. <span data-ttu-id="743ae-237">Dans le [portail Azure](https://portal.azure.com/), accédez au panneau **Application API** de l’application API qui héberge le projet ToDoListAPI (de niveau intermédiaire).</span><span class="sxs-lookup"><span data-stu-id="743ae-237">Go to the [Azure portal](https://portal.azure.com/), and then navigate to the **API App** blade for the API app that hosts the TodoListAPI (middle tier) project.</span></span>
2. <span data-ttu-id="743ae-238">Cliquez sur **Paramètres > Paramètres de l'application**.</span><span class="sxs-lookup"><span data-stu-id="743ae-238">Click **Settings > Application Settings**.</span></span>
3. <span data-ttu-id="743ae-239">Dans la section **Paramètres de l’application** , ajoutez les clés et les valeurs suivantes :</span><span class="sxs-lookup"><span data-stu-id="743ae-239">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="743ae-240">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-240">**Key**</span></span> | <span data-ttu-id="743ae-241">ida:Authority</span><span class="sxs-lookup"><span data-stu-id="743ae-241">ida:Authority</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-242">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-242">**Value**</span></span> |<span data-ttu-id="743ae-243">https://login.microsoftonline.com/{nom de votre client Azure AD}</span><span class="sxs-lookup"><span data-stu-id="743ae-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span></span> |
   | <span data-ttu-id="743ae-244">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-244">**Example**</span></span> |<span data-ttu-id="743ae-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="743ae-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span></span> |
   
   | <span data-ttu-id="743ae-246">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-246">**Key**</span></span> | <span data-ttu-id="743ae-247">ida:ClientId</span><span class="sxs-lookup"><span data-stu-id="743ae-247">ida:ClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-248">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-248">**Value**</span></span> |<span data-ttu-id="743ae-249">ID client de l’application appelante (niveau intermédiaire : ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="743ae-249">Client ID of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="743ae-250">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-250">**Example**</span></span> |<span data-ttu-id="743ae-251">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="743ae-251">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
   
   | <span data-ttu-id="743ae-252">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-252">**Key**</span></span> | <span data-ttu-id="743ae-253">ida:ClientSecret</span><span class="sxs-lookup"><span data-stu-id="743ae-253">ida:ClientSecret</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-254">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-254">**Value**</span></span> |<span data-ttu-id="743ae-255">Clé d’application de l’application appelante (niveau intermédiaire : ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="743ae-255">App key of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="743ae-256">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-256">**Example**</span></span> |<span data-ttu-id="743ae-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="743ae-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
   | <span data-ttu-id="743ae-258">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-258">**Key**</span></span> | <span data-ttu-id="743ae-259">ida:Resource</span><span class="sxs-lookup"><span data-stu-id="743ae-259">ida:Resource</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-260">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-260">**Value**</span></span> |<span data-ttu-id="743ae-261">ID client de l’application appelante (couche de données : ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="743ae-261">Client ID of the called application (data tier - ToDoListDataAPI)</span></span> |
   | <span data-ttu-id="743ae-262">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-262">**Example**</span></span> |<span data-ttu-id="743ae-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="743ae-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
    <span data-ttu-id="743ae-264">**Remarque** : pour `ida:Resource`, veillez à utiliser **l’ID client** de l’application appelée et non son **URI d’ID d’application**.</span><span class="sxs-lookup"><span data-stu-id="743ae-264">**Note**: For `ida:Resource`, make sure you use the called application's **client ID** and not its **App ID URI**.</span></span>
   
    <span data-ttu-id="743ae-265">`ida:ClientId` et `ida:Resource` représentent différentes valeurs pour ce didacticiel, car vous utilisez des applications Azure AD distinctes pour le niveau intermédiaire et la couche de données.</span><span class="sxs-lookup"><span data-stu-id="743ae-265">`ida:ClientId` and `ida:Resource` are different values for this tutorial because you're using separate Azure AD applicaations for the middle tier and data tier.</span></span> <span data-ttu-id="743ae-266">Si vous utilisez une seule application Azure AD pour l’application API appelante et l’application API protégée, vous devez utiliser la même valeur pour `ida:ClientId` et pour `ida:Resource`.</span><span class="sxs-lookup"><span data-stu-id="743ae-266">If you were using a single Azure AD application for the calling API app and the protected API app, you would use the same value in both `ida:ClientId` and `ida:Resource`.</span></span>
   
    <span data-ttu-id="743ae-267">Le code utilise ConfigurationManager pour obtenir ces valeurs, afin de pouvoir les stocker dans le fichier Web.config du projet ou dans l’environnement d’exécution Azure.</span><span class="sxs-lookup"><span data-stu-id="743ae-267">The code uses ConfigurationManager to get these values, so they could be stored in the project's Web.config file or in the Azure runtime environment.</span></span> <span data-ttu-id="743ae-268">Pendant l’exécution d’une application ASP.NET dans Azure App Service, les paramètres d’environnement remplacent automatiquement les paramètres du fichier Web.config.</span><span class="sxs-lookup"><span data-stu-id="743ae-268">While an ASP.NET application is running in Azure App Service, environment settings automatically override settings from Web.config.</span></span> <span data-ttu-id="743ae-269">Les paramètres d’environnement offrent généralement un [moyen plus sécurisé de stocker des informations sensibles qu’un fichier Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span><span class="sxs-lookup"><span data-stu-id="743ae-269">Environment settings are generally a [more secure way to store sensitive information compared to a Web.config file](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span></span>
4. <span data-ttu-id="743ae-270">Cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-270">Click **Save**.</span></span>
   
    ![Cliquez sur Enregistrer.](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a><span data-ttu-id="743ae-272">Test de l'application</span><span class="sxs-lookup"><span data-stu-id="743ae-272">Test the application</span></span>
1. <span data-ttu-id="743ae-273">Dans un navigateur, accédez à l’URL HTTPS de l’application web frontale AngularJS.</span><span class="sxs-lookup"><span data-stu-id="743ae-273">In a browser go to the HTTPS URL of the AngularJS front end web app.</span></span>
2. <span data-ttu-id="743ae-274">Cliquez sur l’onglet **To Do List** et connectez-vous avec les informations d’identification d’un utilisateur de votre client Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-274">Click the **To Do List** tab and log in with credentials for a user in your Azure AD tenant.</span></span> 
3. <span data-ttu-id="743ae-275">Ajoutez des éléments de tâche pour vérifier que l’application fonctionne.</span><span class="sxs-lookup"><span data-stu-id="743ae-275">Add to-do items to verify that the application is working.</span></span>
   
    ![Page To do List](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    <span data-ttu-id="743ae-277">Si l’application ne fonctionne pas comme prévu, vérifiez à nouveau tous les paramètres que vous avez saisis dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="743ae-277">If the application doesn't work as expected, double-check all of the settings you entered in the Azure portal.</span></span> <span data-ttu-id="743ae-278">Si tous les paramètres semblent corrects, consultez la section [Résolution de problèmes](#troubleshooting) dans la suite de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="743ae-278">If all of the settings appear to be correct, see the [Troubleshooting](#troubleshooting) section later in this tutorial.</span></span>

## <a name="protect-the-api-app-from-browser-access"></a><span data-ttu-id="743ae-279">Protéger l’application API contre tout accès navigateur</span><span class="sxs-lookup"><span data-stu-id="743ae-279">Protect the API app from browser access</span></span>
<span data-ttu-id="743ae-280">Dans ce didacticiel, vous avez créé une application Azure AD distincte pour l’application API ToDoListDataAPI (couche de données).</span><span class="sxs-lookup"><span data-stu-id="743ae-280">For this tutorial you created a separate Azure AD application for the ToDoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="743ae-281">Comme vous avez pu le voir, lorsqu’App Service crée une application AAD, il la configure de telle sorte que l’utilisateur puisse accéder à l’URL de l’application API dans un navigateur et se connecter.</span><span class="sxs-lookup"><span data-stu-id="743ae-281">As you've seen, when App Service creates an AAD application, it configures the AAD application in a way that enables a user to go to the API app's URL in a browser and log on.</span></span> <span data-ttu-id="743ae-282">Autrement dit, l’API est accessible non seulement au principal du service, mais également à n’importe quel utilisateur final de votre client Azure AD.</span><span class="sxs-lookup"><span data-stu-id="743ae-282">That means it's possible for an end user in your Azure AD tenant, not just a service principal, to access the API.</span></span> 

<span data-ttu-id="743ae-283">Si vous souhaitez interdire l’accès par le biais d’un navigateur sans avoir à écrire du code dans l’application API protégée, vous pouvez modifier l’ **URL de réponse** dans l’application AAD afin qu’elle soit différente de l’URL de base de l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-283">If you want to prevent browser access without writing any code in the protected API app, you can change the **Reply URL** in the AAD application so that it's different from the API app's base URL.</span></span> 

### <a name="disable-browser-access"></a><span data-ttu-id="743ae-284">Désactiver l’accès du navigateur</span><span class="sxs-lookup"><span data-stu-id="743ae-284">Disable browser access</span></span>
1. <span data-ttu-id="743ae-285">Dans l’onglet **Configurer** du portail Classic correspondant à l’application AAD créée pour le projet ToDoListService, modifiez la valeur du champ **URL de réponse** pour qu’elle corresponde à une URL valide, sans utiliser l’URL de l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-285">In the classic portal's **Configure** tab for the AAD application that was created for the TodoListService, change the value in the **Reply URL** field so that it is a valid URL but not the API app's URL.</span></span>
2. <span data-ttu-id="743ae-286">Cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-286">Click **Save**.</span></span>

### <a name="verify-browser-access-no-longer-works"></a><span data-ttu-id="743ae-287">Vérifier que l’accès au navigateur ne fonctionne plus</span><span class="sxs-lookup"><span data-stu-id="743ae-287">Verify browser access no longer works</span></span>
<span data-ttu-id="743ae-288">Vous avez déjà vérifié qu’il était possible de revenir à l’URL de l’application API à partir d’un navigateur en vous connectant avec les informations d’identification d’un utilisateur donné.</span><span class="sxs-lookup"><span data-stu-id="743ae-288">Earlier you verified that you can go to the API app URL from a browser by logging on with an individual user's credentials.</span></span> <span data-ttu-id="743ae-289">Dans cette section, vous allez vérifier que cet accès ne fonctionne plus.</span><span class="sxs-lookup"><span data-stu-id="743ae-289">In this section, you verify that this is no longer possible.</span></span> 

1. <span data-ttu-id="743ae-290">Dans une nouvelle fenêtre de navigateur, accédez de nouveau à l’URL de l’application API.</span><span class="sxs-lookup"><span data-stu-id="743ae-290">In a new browser window, go to the URL of the API app again.</span></span>
2. <span data-ttu-id="743ae-291">Connectez-vous lorsque vous êtes invité à le faire.</span><span class="sxs-lookup"><span data-stu-id="743ae-291">Log in when prompted to do so.</span></span>
3. <span data-ttu-id="743ae-292">La connexion aboutit, mais génère une page d’erreur.</span><span class="sxs-lookup"><span data-stu-id="743ae-292">Login succeeds but leads to an error page.</span></span>
   
    <span data-ttu-id="743ae-293">Vous avez configuré l’application AAD afin que les utilisateurs du client AAD ne puissent ni se connecter ni accéder à l’API à partir d’un navigateur.</span><span class="sxs-lookup"><span data-stu-id="743ae-293">You've configured the AAD app so that users in the AAD tenant cannot log in and access the API from a browser.</span></span> <span data-ttu-id="743ae-294">Vous pouvez toujours accéder à l’application API à l’aide d’un jeton du principal de service ; pour le vérifier, il vous suffit d’accéder à l’URL de l’application web et d’ajouter d’autres éléments de tâche.</span><span class="sxs-lookup"><span data-stu-id="743ae-294">You can still access the API app by using a service principal token, which you can verify by going to the web app's URL and adding more to-do items.</span></span>

## <a name="restrict-access-to-a-particular-service-principal"></a><span data-ttu-id="743ae-295">Restreindre l’accès à un principal de service spécifique</span><span class="sxs-lookup"><span data-stu-id="743ae-295">Restrict access to a particular service principal</span></span>
<span data-ttu-id="743ae-296">À ce stade, tout appelant capable d’obtenir un jeton pour un utilisateur ou principal du service dans votre client Azure AD est en mesure d’appeler l’application API TodoListDataAPI (couche de données).</span><span class="sxs-lookup"><span data-stu-id="743ae-296">Right now, any caller that can get a token for a user or service principal in your Azure AD tenant can call the TodoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="743ae-297">Si vous le souhaitez, vous pouvez faire en sorte que l’application API de la couche de données accepte uniquement les appels en provenance de l’application API TodoListAPI (couche intermédiaire) et uniquement à partir d’un principal de service particulier.</span><span class="sxs-lookup"><span data-stu-id="743ae-297">You might want to make sure that the data tier API app only accepts calls from the TodoListAPI (middle tier) API app, and only from a particular service principal.</span></span> 

<span data-ttu-id="743ae-298">Vous pouvez ajouter ces restrictions en ajoutant du code pour valider les revendications `appid` et `objectidentifier` sur les appels entrants.</span><span class="sxs-lookup"><span data-stu-id="743ae-298">You can add these restrictions by adding code to validate the `appid` and `objectidentifier` claims on incoming calls.</span></span>

<span data-ttu-id="743ae-299">Dans ce didacticiel, vous allez ajouter un code qui valide l’ID de l’application et l’ID du principal de service directement dans les actions du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="743ae-299">For this tutorial you put the code that validates app ID and service principal ID directly in your controller actions.</span></span>  <span data-ttu-id="743ae-300">Vous pouvez également utiliser un attribut `Authorize` personnalisé ou effectuer cette validation dans vos séquences de démarrage (par exemple, le middleware OWIN).</span><span class="sxs-lookup"><span data-stu-id="743ae-300">Alternatives are to use a custom `Authorize` attribute or to do this validation in your startup sequences (e.g. OWIN middleware).</span></span> <span data-ttu-id="743ae-301">Pour obtenir un exemple de cette dernière option, consultez [cet exemple d’application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span><span class="sxs-lookup"><span data-stu-id="743ae-301">For an example of the latter, see [this sample application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span></span> 

<span data-ttu-id="743ae-302">Apportez les modifications suivantes au projet ToDoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="743ae-302">Make the following changes to the TodoListDataAPI project.</span></span>

1. <span data-ttu-id="743ae-303">Ouvrez le fichier *Controllers\ToDoListController.cs* .</span><span class="sxs-lookup"><span data-stu-id="743ae-303">Open the *Controllers/TodoListController.cs* file.</span></span>
2. <span data-ttu-id="743ae-304">Supprimez les commentaires des lignes qui définissent `trustedCallerClientId` et `trustedCallerServicePrincipalId`.</span><span class="sxs-lookup"><span data-stu-id="743ae-304">Uncomment the lines that set `trustedCallerClientId` and `trustedCallerServicePrincipalId`.</span></span>
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. <span data-ttu-id="743ae-305">Supprimez les commentaires du code dans la méthode CheckCallerId.</span><span class="sxs-lookup"><span data-stu-id="743ae-305">Uncomment the code in the CheckCallerId method.</span></span> <span data-ttu-id="743ae-306">Cette méthode est appelée au début de chaque méthode d’action du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="743ae-306">This method is called at the start of every action method in the controller.</span></span> 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. <span data-ttu-id="743ae-307">Redéployez le projet ToDoListDataAPI dans Azure App Service.</span><span class="sxs-lookup"><span data-stu-id="743ae-307">Redeploy the ToDoListDataAPI project to Azure App Service.</span></span>
5. <span data-ttu-id="743ae-308">Dans votre navigateur, accédez à l’URL HTTPS de l’application web frontale AngularJS, puis, sur la page d’accueil, cliquez sur l’onglet **To Do List** .</span><span class="sxs-lookup"><span data-stu-id="743ae-308">In your browser, go to the AngularJS front end web app's HTTPS URL, and in the home page click the **To Do List** tab.</span></span>
   
    <span data-ttu-id="743ae-309">L’application ne fonctionne pas en raison de l’échec des appels vers le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="743ae-309">The application doesn't work because calls to the back end are failing.</span></span> <span data-ttu-id="743ae-310">Le nouveau code vérifie les attributs appid et objectidentifier, mais il ne dispose pas encore des valeurs correctes qui lui permettent de les vérifier.</span><span class="sxs-lookup"><span data-stu-id="743ae-310">The new code is checking actual appid and objectidentifier but it doesn't yet have the correct values to check them against.</span></span> <span data-ttu-id="743ae-311">La Console des outils de développement du navigateur signale que le serveur renvoie une erreur HTTP 401.</span><span class="sxs-lookup"><span data-stu-id="743ae-311">The browser Developer Tools Console reports that the server is returning an HTTP 401 error.</span></span>
   
    ![Erreur dans la console des outils de développement](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    <span data-ttu-id="743ae-313">Dans la procédure suivante, vous allez configurer les valeurs attendues.</span><span class="sxs-lookup"><span data-stu-id="743ae-313">In the following steps you configure the expected values.</span></span>
6. <span data-ttu-id="743ae-314">À l’aide d’Azure AD PowerShell, obtenez la valeur du principal du service pour l’application Azure AD que vous avez créée pour le projet TodoListWebApp.</span><span class="sxs-lookup"><span data-stu-id="743ae-314">Using Azure AD PowerShell, get the value of the service principal for the Azure AD application that you created for the TodoListWebApp project.</span></span>
   
    <span data-ttu-id="743ae-315">a.</span><span class="sxs-lookup"><span data-stu-id="743ae-315">a.</span></span> <span data-ttu-id="743ae-316">Pour savoir comment installer Azure PowerShell et le connecter à votre abonnement, consultez l’article [Utilisation d’Azure PowerShell avec Azure Resource Manager](../powershell-azure-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="743ae-316">For instructions on how to install Azure PowerShell and connect to your subscription, see [Using Azure PowerShell with Azure Resource Manager](../powershell-azure-resource-manager.md).</span></span>
   
    <span data-ttu-id="743ae-317">b.</span><span class="sxs-lookup"><span data-stu-id="743ae-317">b.</span></span> <span data-ttu-id="743ae-318">Pour obtenir la liste des principaux du service, exécutez la commande `Login-AzureRmAccount`, puis la commande `Get-AzureRmADServicePrincipal`.</span><span class="sxs-lookup"><span data-stu-id="743ae-318">To get a list of service principals, execute the `Login-AzureRmAccount` command and then the `Get-AzureRmADServicePrincipal` command.</span></span>
   
    <span data-ttu-id="743ae-319">c.</span><span class="sxs-lookup"><span data-stu-id="743ae-319">c.</span></span> <span data-ttu-id="743ae-320">Recherchez l’attribut objectid du principal du service de l’application TodoListAPI, et enregistrez-le dans un emplacement d’où vous pourrez le copier ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="743ae-320">Find the objectid for the service principal of the TodoListAPI application, and save it in a location you can copy from later.</span></span>
7. <span data-ttu-id="743ae-321">Dans le portail Azure, accédez au panneau Application API de l’application API où vous avez déployé le projet ToDoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="743ae-321">In the Azure portal, navigate to the API app blade for the API app that you deployed the ToDoListDataAPI project to.</span></span>
8. <span data-ttu-id="743ae-322">Cliquez sur **Paramètres > Paramètres de l’application**.</span><span class="sxs-lookup"><span data-stu-id="743ae-322">Click **Settings > Application settings**.</span></span>
9. <span data-ttu-id="743ae-323">Dans la section **Paramètres de l’application** , ajoutez les clés et les valeurs suivantes :</span><span class="sxs-lookup"><span data-stu-id="743ae-323">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="743ae-324">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-324">**Key**</span></span> | <span data-ttu-id="743ae-325">todo:TrustedCallerServicePrincipalId</span><span class="sxs-lookup"><span data-stu-id="743ae-325">todo:TrustedCallerServicePrincipalId</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-326">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-326">**Value**</span></span> |<span data-ttu-id="743ae-327">ID du principal de service principal de l’application appelante</span><span class="sxs-lookup"><span data-stu-id="743ae-327">Service principal id of calling application</span></span> |
   | <span data-ttu-id="743ae-328">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-328">**Example**</span></span> |<span data-ttu-id="743ae-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span><span class="sxs-lookup"><span data-stu-id="743ae-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span></span> |
   
   | <span data-ttu-id="743ae-330">**Clé**</span><span class="sxs-lookup"><span data-stu-id="743ae-330">**Key**</span></span> | <span data-ttu-id="743ae-331">todo:TrustedCallerClientId</span><span class="sxs-lookup"><span data-stu-id="743ae-331">todo:TrustedCallerClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="743ae-332">**Valeur**</span><span class="sxs-lookup"><span data-stu-id="743ae-332">**Value**</span></span> |<span data-ttu-id="743ae-333">ID client de l’application appelante (copié à partir de l’application AD Azure TodoListAPI)</span><span class="sxs-lookup"><span data-stu-id="743ae-333">Client ID of calling application - copied from the TodoListAPI Azure AD application</span></span> |
   | <span data-ttu-id="743ae-334">**Exemple**</span><span class="sxs-lookup"><span data-stu-id="743ae-334">**Example**</span></span> |<span data-ttu-id="743ae-335">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="743ae-335">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
10. <span data-ttu-id="743ae-336">Cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="743ae-336">Click **Save**.</span></span>
    
     ![Cliquez sur Enregistrer.](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. <span data-ttu-id="743ae-338">Dans votre navigateur, revenez à l’URL de l’application web, puis, sur la page d’accueil, cliquez sur l’onglet **To Do List** .</span><span class="sxs-lookup"><span data-stu-id="743ae-338">In your browser, return to the web app's URL, and in the home page click the **To Do List** tab.</span></span>
    
     <span data-ttu-id="743ae-339">Cette fois, l’application fonctionne comme prévu car l’ID de l’application appelante et l’ID du principal de service correspondent aux valeurs attendues.</span><span class="sxs-lookup"><span data-stu-id="743ae-339">This time the application works as expected because the trusted caller app ID and service principal ID are the expected values.</span></span>
    
     ![Page To do List](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a><span data-ttu-id="743ae-341">Génération de projets de toutes pièces</span><span class="sxs-lookup"><span data-stu-id="743ae-341">Building the projects from scratch</span></span>
<span data-ttu-id="743ae-342">Les deux projets d’API Web ont été créés à l’aide du modèle de projet **Application API Azure** et par remplacement du contrôleur Values par défaut par un contrôleur ToDoList.</span><span class="sxs-lookup"><span data-stu-id="743ae-342">The two Web API projects were created by using the **Azure API App** project template and replacing the default Values controller with a ToDoList controller.</span></span> <span data-ttu-id="743ae-343">Pour acquérir les jetons du principal du service Azure AD dans le projet ToDoListAPI, le package NuGet [Active Directory Authentication Library (ADAL) pour .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) a été installé.</span><span class="sxs-lookup"><span data-stu-id="743ae-343">For acquiring Azure AD service principal tokens in the ToDoListAPI project, the [Active Directory Authentication Library (ADAL) for .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) NuGet package was installed.</span></span>

<span data-ttu-id="743ae-344">Pour plus d’informations sur la création d’une application à page unique AngularJS avec un back-end d’API Web telle que ToDoListAngular, consultez la page [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs)(Exercice pratique : créer une application à page unique (SPA) avec l’API Web ASP.NET et Angular.js).</span><span class="sxs-lookup"><span data-stu-id="743ae-344">For information about how to  create an AngularJS single-page application with a Web API back end like ToDoListAngular, see  [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span></span> <span data-ttu-id="743ae-345">Pour plus d’informations sur l’ajout de code d’authentification Azure AD, consultez [Sécurisation d’une application à page unique AngularJS avec Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span><span class="sxs-lookup"><span data-stu-id="743ae-345">For information about how to add Azure AD authentication code, see [Securing AngularJS Single Page Apps with Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="743ae-346">Résolution de problèmes</span><span class="sxs-lookup"><span data-stu-id="743ae-346">Troubleshooting</span></span>
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* <span data-ttu-id="743ae-347">Assurez-vous de ne pas confondre ToDoListAPI (niveau intermédiaire) et ToDoListDataAPI (couche de données).</span><span class="sxs-lookup"><span data-stu-id="743ae-347">Make sure that you don't confuse ToDoListAPI (middle tier) and ToDoListDataAPI (data tier).</span></span> <span data-ttu-id="743ae-348">Par exemple, dans ce didacticiel vous allez ajouter l’authentification à l’application API de la couche de données, **mais la clé d’application doit provenir de l’application Azure AD que vous avez créée pour l’application de niveau intermédiaire API**.</span><span class="sxs-lookup"><span data-stu-id="743ae-348">For example, in this tutorial you add authentication to the data tier API app, **but the app key must come from the Azure AD application that you created for the middle tier API app**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="743ae-349">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="743ae-349">Next steps</span></span>
<span data-ttu-id="743ae-350">Il s’agit du dernier didacticiel de la série API Apps.</span><span class="sxs-lookup"><span data-stu-id="743ae-350">This is the last tutorial in the API Apps series.</span></span> 

<span data-ttu-id="743ae-351">Pour plus d’informations sur Azure Active Directory, consultez les ressources suivantes :</span><span class="sxs-lookup"><span data-stu-id="743ae-351">For more information about Azure Active Directory, see the following resources.</span></span>

* [<span data-ttu-id="743ae-352">Guide du développeur Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-352">Azure AD developers' guide</span></span>](http://aka.ms/aaddev)
* [<span data-ttu-id="743ae-353">Scénarios Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-353">Azure AD scenarios</span></span>](http://aka.ms/aadscenarios)
* [<span data-ttu-id="743ae-354">Exemples Azure AD</span><span class="sxs-lookup"><span data-stu-id="743ae-354">Azure AD samples</span></span>](http://aka.ms/aadsamples)
  
    <span data-ttu-id="743ae-355">L’exemple [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) est similaire à celui présenté dans ce didacticiel, à ceci près qu’il n’utilise pas l’authentification App Service.</span><span class="sxs-lookup"><span data-stu-id="743ae-355">The [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) sample is similar to what is shown in this tutorial, but without using App Service authentication.</span></span>

<span data-ttu-id="743ae-356">Pour plus d’informations sur les autres méthodes de déploiement de projets Visual Studio dans des applications API, à l’aide de Visual Studio ou en [automatisant le déploiement](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) à partir d’un [système de contrôle de code source](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), consultez [Déploiement d’une application Azure App Service](../app-service-web/web-sites-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="743ae-356">For information about other ways to deploy Visual Studio projects to API apps, by using Visual Studio or by [automating deployment](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) from a [source control system](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), see [How to deploy an Azure App Service app](../app-service-web/web-sites-deploy.md).</span></span>

