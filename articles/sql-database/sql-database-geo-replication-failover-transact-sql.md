---
title: "TSQL : Lancer un basculement pour Azure SQL Database | Microsoft Docs"
description: "Lancer un basculement planifié ou non planifié pour une base de données SQL Azure avec Transact-SQL"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: 5eb2d256-025d-4f5a-99d4-17f702b37f14
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 01/10/2017
ms.author: carlrab
ms.openlocfilehash: 459941d2c82e5d4ef62beab4ccf775ab8f5efce4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="initiate-a-planned-or-unplanned-failover-for-azure-sql-database-with-transact-sql"></a><span data-ttu-id="af3fa-103">Lancer un basculement planifié ou non planifié pour une base de données SQL Azure avec Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="af3fa-103">Initiate a planned or unplanned failover for Azure SQL Database with Transact-SQL</span></span>

<span data-ttu-id="af3fa-104">Cet article montre comment lancer le basculement vers une base de données SQL secondaire avec Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="af3fa-104">This article shows you how to initiate failover to a secondary SQL Database using Transact-SQL.</span></span> <span data-ttu-id="af3fa-105">Pour configurer la géoréplication, voir [Configurer la géoréplication pour Azure SQL Database](sql-database-geo-replication-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-105">To configure geo-replication, see [Configure geo-replication for Azure SQL Database](sql-database-geo-replication-transact-sql.md).</span></span>

<span data-ttu-id="af3fa-106">Pour lancer le basculement, vous devez disposer de ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="af3fa-106">To initiate failover, you need the following:</span></span>

* <span data-ttu-id="af3fa-107">ID de connexion DBManager sur le serveur principal</span><span class="sxs-lookup"><span data-stu-id="af3fa-107">A login that is DBManager on the primary</span></span>
* <span data-ttu-id="af3fa-108">Droits db_ownership sur la base de données locale que vous allez géorépliquer</span><span class="sxs-lookup"><span data-stu-id="af3fa-108">Have db_ownership of the local database that you will geo-replicate</span></span>
* <span data-ttu-id="af3fa-109">Rôle DBManager sur les serveurs partenaires sur lesquels vous voulez configurer la géoréplication</span><span class="sxs-lookup"><span data-stu-id="af3fa-109">Be DBManager on the partner server(s) to which you will configure geo-replication</span></span>
* <span data-ttu-id="af3fa-110">Dernière version de SQL Server Management Studio (SSMS)</span><span class="sxs-lookup"><span data-stu-id="af3fa-110">Newest version of SQL Server Management Studio (SSMS)</span></span>

> [!IMPORTANT]
> <span data-ttu-id="af3fa-111">Nous vous recommandons d’utiliser systématiquement la dernière version de Management Studio afin de rester en cohérence avec les mises à jour de Microsoft Azure et Base de données SQL.</span><span class="sxs-lookup"><span data-stu-id="af3fa-111">It is recommended that you always use the latest version of Management Studio to remain synchronized with updates to Microsoft Azure and SQL Database.</span></span> <span data-ttu-id="af3fa-112">[Mettre à jour SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span><span class="sxs-lookup"><span data-stu-id="af3fa-112">[Update SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span></span>
>  

## <a name="initiate-a-planned-failover-promoting-a-secondary-database-to-become-the-new-primary"></a><span data-ttu-id="af3fa-113">Initier un basculement planifié en assurant la promotion d’une base de données secondaire, pour qu’il devienne le nouveau réplica principal</span><span class="sxs-lookup"><span data-stu-id="af3fa-113">Initiate a planned failover promoting a secondary database to become the new primary</span></span>
<span data-ttu-id="af3fa-114">Vous pouvez utiliser l’instruction **ALTER DATABASE** pour promouvoir une base de données secondaire afin qu’elle devienne la nouvelle base de données primaire de manière planifiée, et rétrogradant l’élément primaire existant pour qu’elle devienne secondaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-114">You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in a planned fashion, demoting the existing primary to become a secondary.</span></span> <span data-ttu-id="af3fa-115">Cette instruction est exécutée sur la base de données master sur le serveur logique de base de données SQL Azure sur lequel réside la base secondaire géo-répliquée promue.</span><span class="sxs-lookup"><span data-stu-id="af3fa-115">This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides.</span></span> <span data-ttu-id="af3fa-116">Cette fonctionnalité est conçue pour le basculement planifié, comme pendant les exercices de récupération d’urgence et nécessite que la base de données primaire soit disponible.</span><span class="sxs-lookup"><span data-stu-id="af3fa-116">This functionality is designed for planned failover, such as during the DR drills, and requires that the primary database be available.</span></span>

<span data-ttu-id="af3fa-117">La commande exécute le flux de travail suivant :</span><span class="sxs-lookup"><span data-stu-id="af3fa-117">The command performs the following workflow:</span></span>

1. <span data-ttu-id="af3fa-118">Bascule provisoirement la réplication en mode synchrone, ce qui fait que toutes les transactions en attente doivent être vidées vers le serveur secondaire et toutes les nouvelles transactions bloquées ;</span><span class="sxs-lookup"><span data-stu-id="af3fa-118">Temporarily switches replication to synchronous mode, causing all outstanding transactions to be flushed to the secondary and blocking all new transactions;</span></span>
2. <span data-ttu-id="af3fa-119">Inverse les rôles des deux bases de données du partenariat de géoréplication.</span><span class="sxs-lookup"><span data-stu-id="af3fa-119">Switches the roles of the two databases in the geo-replication partnership.</span></span>  

<span data-ttu-id="af3fa-120">Cette séquence garantit que les deux bases de données sont synchronisées avant le basculement des rôles et que, par conséquent, aucune perte de données ne se produira.</span><span class="sxs-lookup"><span data-stu-id="af3fa-120">This sequence guarantees that the two databases are synchronized before the roles switch and therefore no data loss will occur.</span></span> <span data-ttu-id="af3fa-121">Il existe une courte période pendant laquelle les deux bases de données ne sont pas disponibles (de l’ordre de 0 à 25 secondes) pendant que les rôles sont activés.</span><span class="sxs-lookup"><span data-stu-id="af3fa-121">There is a short period during which both databases are unavailable (on the order of 0 to 25 seconds) while the roles are switched.</span></span> <span data-ttu-id="af3fa-122">Si la base de données primaire comporte plusieurs bases de données secondaires, la commande reconfigure automatiquement les autres bases de données secondaires pour qu’elles se connectent à la nouvelle base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-122">If the primary database has multiple secondary databases, the command will automatically reconfigure the other secondaries to connect to the new primary.</span></span>  <span data-ttu-id="af3fa-123">Toute l’opération devrait prendre moins d’une minute pour se terminer dans des circonstances normales.</span><span class="sxs-lookup"><span data-stu-id="af3fa-123">The entire operation should take less than a minute to complete under normal circumstances.</span></span> <span data-ttu-id="af3fa-124">Pour plus d’informations, consultez [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) et [Niveaux de service](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-124">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>

<span data-ttu-id="af3fa-125">Utilisez les étapes suivantes pour initier un basculement planifié.</span><span class="sxs-lookup"><span data-stu-id="af3fa-125">Use the following steps to initiate a planned failover.</span></span>

1. <span data-ttu-id="af3fa-126">Dans Management Studio, connectez-vous à un serveur logique de base de données SQL Azure dans lesquels réside une base de données secondaire répliquée.</span><span class="sxs-lookup"><span data-stu-id="af3fa-126">In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="af3fa-127">Ouvrez le dossier Bases de données, développez **Bases de données système**, cliquez avec le bouton droit sur **Master**, puis cliquez sur **Nouvelle requête**.</span><span class="sxs-lookup"><span data-stu-id="af3fa-127">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="af3fa-128">Utilisez l’instruction **ALTER DATABASE** suivante pour basculer la base de données secondaire vers le rôle primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-128">Use the following **ALTER DATABASE** statement to switch the secondary database to the primary role.</span></span>
   
        ALTER DATABASE <MyDB> FAILOVER;
4. <span data-ttu-id="af3fa-129">Cliquez sur **Exécuter** pour exécuter la requête.</span><span class="sxs-lookup"><span data-stu-id="af3fa-129">Click **Execute** to run the query.</span></span>

> [!NOTE]
> <span data-ttu-id="af3fa-130">Dans de rares cas, il est possible que l’opération ne puisse pas s’achever et semble bloquée.</span><span class="sxs-lookup"><span data-stu-id="af3fa-130">In rare cases, it is possible that the operation cannot complete and may appear stuck.</span></span> <span data-ttu-id="af3fa-131">Dans ce cas, l’utilisateur peut exécuter la commande de basculement forcé et accepter la perte de données.</span><span class="sxs-lookup"><span data-stu-id="af3fa-131">In this case, the user can execute the force failover command and accept data loss.</span></span>
> 
> 

## <a name="initiate-an-unplanned-failover-from-the-primary-database-to-the-secondary-database"></a><span data-ttu-id="af3fa-132">Toute l’opération devrait prendre moins d’une minute pour se terminer dans des circonstances normales</span><span class="sxs-lookup"><span data-stu-id="af3fa-132">Initiate an unplanned failover from the primary database to the secondary database</span></span>
<span data-ttu-id="af3fa-133">Vous pouvez utiliser l’instruction **ALTER DATABASE** pour promouvoir une base de données secondaire afin qu’elle devienne la nouvelle base de données primaire de façon non planifiée, en forçant la rétrogradation de la base de données primaire existante pour qu’elle devienne secondaire dans l’hypothèse où elle cesserait d’être disponible.</span><span class="sxs-lookup"><span data-stu-id="af3fa-133">You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in an unplanned fashion, forcing the demotion of the existing primary to become a secondary at a time when the primary database is no longer available.</span></span> <span data-ttu-id="af3fa-134">Cette instruction est exécutée sur la base de données master sur le serveur logique de base de données SQL Azure sur lequel réside la base secondaire géo-répliquée promue.</span><span class="sxs-lookup"><span data-stu-id="af3fa-134">This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides.</span></span>

<span data-ttu-id="af3fa-135">Cette fonctionnalité est conçue pour la récupération d’urgence lorsque la restauration de la disponibilité de la base de données est essentielle et une perte de données est acceptable.</span><span class="sxs-lookup"><span data-stu-id="af3fa-135">This functionality is designed for disaster recovery when restoring availability of the database is critical and some data loss is acceptable.</span></span> <span data-ttu-id="af3fa-136">Lorsque le basculement forcé est appelé, la base de données secondaire devient la base de données primaire immédiatement et commence à accepter des transactions d’écriture.</span><span class="sxs-lookup"><span data-stu-id="af3fa-136">When forced failover is invoked, the specified secondary database immediately becomes the primary database and begins accepting write transactions.</span></span> <span data-ttu-id="af3fa-137">Dès que la base de données primaire d’origine est en mesure de se reconnecter à cette base de données primaire, une sauvegarde incrémentielle s’effectue sur la base de données primaire d’origine et l’ancienne base de données primaire est transformée en base de données secondaire de la nouvelle base de données primaire ; par la suite, il s’agit d’un simple réplica de la nouvelle base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-137">As soon as the original primary database is able to reconnect with this new primary database, an incremental backup is taken on the original primary database and the old primary database is made into a secondary database for the new primary database; subsequently, it is merely a synchronizing replica of the new primary.</span></span>

<span data-ttu-id="af3fa-138">Toutefois, étant donné que la limite de restauration n’est pas prise en charge sur les bases de données secondaires, si l’utilisateur souhaite récupérer les données validées dans l’ancienne base de données primaire qui n’ont pas été répliquées dans la nouvelle base de données primaire avant le basculement forcé, l’utilisateur devra faire appel à l’assistance technique pour récupérer les données perdues.</span><span class="sxs-lookup"><span data-stu-id="af3fa-138">However, because Point In Time Restore is not supported on the secondary databases, if the user wishes to recover data committed to the old primary database that had not been replicated to the new primary database before the forced failover occurred, the user will need to engage support to recover this lost data.</span></span>

<span data-ttu-id="af3fa-139">Si la base de données primaire comporte plusieurs bases de données secondaires, la commande reconfigure automatiquement les autres bases de données secondaires pour qu’elles se connectent à la nouvelle base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-139">If the primary database has multiple secondary databases, the command will automatically reconfigure the other secondaries to connect to the new primary.</span></span>

<span data-ttu-id="af3fa-140">Utilisez les étapes suivantes pour lancer un basculement non planifié.</span><span class="sxs-lookup"><span data-stu-id="af3fa-140">Use the following steps to initiate an unplanned failover.</span></span>

1. <span data-ttu-id="af3fa-141">Dans Management Studio, connectez-vous à un serveur logique de base de données SQL Azure dans lesquels réside une base de données secondaire répliquée.</span><span class="sxs-lookup"><span data-stu-id="af3fa-141">In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="af3fa-142">Ouvrez le dossier Bases de données, développez **Bases de données système**, cliquez avec le bouton droit sur **Master**, puis cliquez sur **Nouvelle requête**.</span><span class="sxs-lookup"><span data-stu-id="af3fa-142">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="af3fa-143">Utilisez l’instruction **ALTER DATABASE** suivante pour basculer la base de données secondaire vers le rôle primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-143">Use the following **ALTER DATABASE** statement to switch the secondary database to the primary role.</span></span>
   
        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;
4. <span data-ttu-id="af3fa-144">Cliquez sur **Exécuter** pour exécuter la requête.</span><span class="sxs-lookup"><span data-stu-id="af3fa-144">Click **Execute** to run the query.</span></span>

> [!NOTE]
> <span data-ttu-id="af3fa-145">Si la commande est émise lorsque les bases de données primaire et secondaire sont en ligne, l’ancienne base de données primaire devient immédiatement la nouvelle base de données secondaire, sans synchronisation des données.</span><span class="sxs-lookup"><span data-stu-id="af3fa-145">If the command is issued when both primary and secondary are online the old primary will become the new secondary immediately without data synchronization.</span></span> <span data-ttu-id="af3fa-146">Si la base de données primaire valide des transactions lorsque la commande est émise, une perte de données peut se produire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-146">If the primary is committing transactions when the command is issued some data loss may occur.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="af3fa-147">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="af3fa-147">Next steps</span></span>
* <span data-ttu-id="af3fa-148">Après le basculement, assurez-vous que les exigences d’authentification de votre serveur et de votre base de données sont configurées sur la nouvelle base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="af3fa-148">After failover, ensure the authentication requirements for your server and database are configured on the new primary.</span></span> <span data-ttu-id="af3fa-149">Pour plus d’informations, consultez [Gestion de la sécurité de la base de données SQL Azure après la récupération d’urgence](sql-database-geo-replication-security-config.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-149">For details, see [SQL Database security after disaster recovery](sql-database-geo-replication-security-config.md).</span></span>
* <span data-ttu-id="af3fa-150">Pour en savoir plus sur la récupération après sinistre à l’aide de la géoréplication active, notamment les étapes de pré/post-récupération et l’organisation d’un exercice de récupération d’urgence, voir [Récupération d’urgence](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-150">To learn recovering after a disaster using active geo-replication, including pre-recovery and post-recovery steps and performing a disaster recovery drill, see [Disaster Recovery](sql-database-disaster-recovery.md)</span></span>
* <span data-ttu-id="af3fa-151">Consultez le billet de blog publié par Sasha Nosov concernant la géoréplication active : [Coup de projecteur sur les nouvelles fonctionnalités de géoréplication](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/).</span><span class="sxs-lookup"><span data-stu-id="af3fa-151">For a Sasha Nosov blog post about active geo-replication, see [Spotlight on new geo-replication capabilities](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)</span></span>
* <span data-ttu-id="af3fa-152">Pour plus d’informations sur la conception d’applications cloud afin d’utiliser la géoréplication active, voir [Conception d’applications cloud pour la continuité d’activité à l’aide de la géoréplication](sql-database-designing-cloud-solutions-for-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-152">For information about designing cloud applications to use active geo-replication, see [Designing cloud applications for business continuity using geo-replication](sql-database-designing-cloud-solutions-for-disaster-recovery.md)</span></span>
* <span data-ttu-id="af3fa-153">Pour plus d’informations sur la géoréplication active avec des pools élastiques, voir [Stratégies de récupération d’urgence de pool élastique](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-153">For information about using active geo-replication with elastic pools, see [Elastic Pool disaster recovery strategies](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span></span>
* <span data-ttu-id="af3fa-154">Pour une vue d’ensemble de la continuité des activités, voir [Vue d’ensemble de la continuité des activités](sql-database-business-continuity.md).</span><span class="sxs-lookup"><span data-stu-id="af3fa-154">For an overview of business continuity, see [Business Continuity Overview](sql-database-business-continuity.md)</span></span>

