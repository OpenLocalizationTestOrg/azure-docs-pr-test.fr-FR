---
title: "Approvisionner de nouveaux locataires dans une application mutualisée utilisant Azure SQL Database | Microsoft Docs"
description: "Découvrez comment approvisionner et cataloguer de nouveaux locataires dans l’application SaaS Wingtip"
keywords: "didacticiel sur les bases de données SQL"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: 8fa4c4f95386a92c8c818eef1a5b4de5a086fe07
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a><span data-ttu-id="b0131-104">Approvisionner de nouveaux locataires et les inscrire dans le catalogue</span><span class="sxs-lookup"><span data-stu-id="b0131-104">Provision new tenants and register them in the catalog</span></span>

<span data-ttu-id="b0131-105">Ce didacticiel décrit les modèles SaaS d’approvisionnement et d’inscription au catalogue et comment ils sont implémentés dans l’application SaaS Wingtip.</span><span class="sxs-lookup"><span data-stu-id="b0131-105">In this tutorial, you learn about the provision and catalog SaaS patterns, and how they are implemented in the Wingtip SaaS application.</span></span> <span data-ttu-id="b0131-106">Vous allez créer et initialiser de nouvelles bases de données de clients et les enregistrer dans le catalogue de clients de l’application.</span><span class="sxs-lookup"><span data-stu-id="b0131-106">You create and initialize new tenant databases, and register them in the application’s tenant catalog.</span></span> <span data-ttu-id="b0131-107">Le catalogue est une base de données qui gère le mappage entre les nombreux clients des applications SaaS et les données associées.</span><span class="sxs-lookup"><span data-stu-id="b0131-107">The catalog is a database that maintains the mapping between the SaaS application's many tenants and their data.</span></span> <span data-ttu-id="b0131-108">Le catalogue joue un rôle important, car il dirige les demandes de l’application vers la base de données appropriée.</span><span class="sxs-lookup"><span data-stu-id="b0131-108">The catalog plays an important role directing application requests to the correct database.</span></span>  

<span data-ttu-id="b0131-109">Ce didacticiel vous montre comment effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="b0131-109">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="b0131-110">Approvisionner un nouveau client unique et découvrir comment il est implémenté</span><span class="sxs-lookup"><span data-stu-id="b0131-110">Provision a single new tenant, including stepping through how this is implemented</span></span>
> * <span data-ttu-id="b0131-111">Approvisionner un lot de locataires supplémentaires</span><span class="sxs-lookup"><span data-stu-id="b0131-111">Provision a batch of additional tenants</span></span>


<span data-ttu-id="b0131-112">Pour suivre ce tutoriel, vérifiez que les conditions préalables suivantes sont bien satisfaites :</span><span class="sxs-lookup"><span data-stu-id="b0131-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="b0131-113">L’application SaaS Wingtip est déployée.</span><span class="sxs-lookup"><span data-stu-id="b0131-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="b0131-114">Pour procéder à un déploiement en moins de cinq minutes, consultez la page [Déployer et explorer une application SaaS Wingtip](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="b0131-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="b0131-115">Azure PowerShell est installé.</span><span class="sxs-lookup"><span data-stu-id="b0131-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="b0131-116">Pour plus d’informations, consultez [Bien démarrer avec Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).</span><span class="sxs-lookup"><span data-stu-id="b0131-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>

## <a name="introduction-to-the-saas-catalog-pattern"></a><span data-ttu-id="b0131-117">Présentation du modèle de catalogue SaaS</span><span class="sxs-lookup"><span data-stu-id="b0131-117">Introduction to the SaaS Catalog pattern</span></span>

<span data-ttu-id="b0131-118">Dans une application SaaS mutualisée appuyée par une base de données, il est important de savoir où sont stockées les informations de chaque locataire.</span><span class="sxs-lookup"><span data-stu-id="b0131-118">In a database-backed multi-tenant SaaS application, it's important to know where information for each tenant is stored.</span></span> <span data-ttu-id="b0131-119">Dans le modèle de catalogue SaaS, une base de données de catalogue permet de conserver le mappage entre les clients et l’endroit où sont stockées les données.</span><span class="sxs-lookup"><span data-stu-id="b0131-119">In the SaaS catalog pattern, a catalog database is used to hold the mapping between each tenant and where their data is stored.</span></span> <span data-ttu-id="b0131-120">L’application SaaS Wingtip utilise une architecture à locataire unique par base de données. Toutefois, le modèle de base relatif au stockage du mappage locataire/base de données dans un catalogue s’applique, que la base de données soit mutualisée ou à locataire unique.</span><span class="sxs-lookup"><span data-stu-id="b0131-120">The Wingtip SaaS app uses a single-tenant per database architecture, but the basic pattern of storing tenant-to-database mapping in a catalog applies whether a multi-tenant or single-tenant database is used.</span></span>

<span data-ttu-id="b0131-121">Une clé est attribuée à chaque client afin de l’identifier dans le catalogue. Cette est mappée sur l’emplacement de la base de données correspondante.</span><span class="sxs-lookup"><span data-stu-id="b0131-121">Each tenant is assigned a key that identifies them in the catalog and which is mapped to the location of the appropriate database.</span></span> <span data-ttu-id="b0131-122">Dans le cas de l’application SaaS Wingtip, la clé est générée à partir d’un code de hachage du nom du client.</span><span class="sxs-lookup"><span data-stu-id="b0131-122">In the Wingtip SaaS app, the key is formed from a hash of the tenant’s name.</span></span> <span data-ttu-id="b0131-123">Cela permet d’utiliser le nom du client dans l’URL de l’application pour construire la clé.</span><span class="sxs-lookup"><span data-stu-id="b0131-123">This allows the tenant name portion of the application URL to be used to construct the key.</span></span> <span data-ttu-id="b0131-124">D’autres schémas de clé de client peuvent être utilisés.</span><span class="sxs-lookup"><span data-stu-id="b0131-124">Other tenant key schemes could be used.</span></span>  

<span data-ttu-id="b0131-125">Le catalogue permet de modifier le nom ou l’emplacement de la base de données avec un impact minimal sur l’application.</span><span class="sxs-lookup"><span data-stu-id="b0131-125">The catalog allows the name or location of the database to be changed with minimal impact on the application.</span></span>  <span data-ttu-id="b0131-126">Dans un modèle de base de données multiclient, il facilite également le « déplacement » d’un client entre les différentes bases de données.</span><span class="sxs-lookup"><span data-stu-id="b0131-126">In a multi-tenant database model, this also accommodates ‘moving’ a tenant between databases.</span></span>  <span data-ttu-id="b0131-127">Le catalogue peut également être utilisé pour indiquer si un client ou une base de données est hors connexion pour maintenance ou dans le cadre d’autres opérations.</span><span class="sxs-lookup"><span data-stu-id="b0131-127">The catalog can also be used to indicate whether a tenant or database is offline for maintenance or other actions.</span></span> <span data-ttu-id="b0131-128">Ce processus est décrit dans le [didacticiel sur la restauration d’un client unique](sql-database-saas-tutorial-restore-single-tenant.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-128">This is explored in the [restore single tenant tutorial](sql-database-saas-tutorial-restore-single-tenant.md).</span></span>

<span data-ttu-id="b0131-129">En outre, le catalogue, qui est en réalité une base de données de gestion pour une application SaaS, peut stocker des métadonnées supplémentaires relatives au client ou à la base de données, telles que le niveau ou la version d’une base de données, la version du schéma, le plan de service ou les SLA proposés aux clients, ainsi que d’autres informations associées à la gestion des applications, au support technique ou aux processus devops.</span><span class="sxs-lookup"><span data-stu-id="b0131-129">In addition, the catalog, which is in effect a management database for a SaaS application, can store additional tenant or database metadata, such as the tier or edition of a database, schema version, service plan, or SLAs offered to tenants, and other info that enables application management, customer support, or devops processes.</span></span>  

<span data-ttu-id="b0131-130">Au-delà de l’application SaaS, le catalogue permet d’accéder à des outils de base de données.</span><span class="sxs-lookup"><span data-stu-id="b0131-130">Beyond the SaaS application, the catalog can enable database tools.</span></span>  <span data-ttu-id="b0131-131">Dans l’exemple de l’application SaaS Wingtip, le catalogue est utilisé pour activer des requêtes entre clients, tel que décrit dans le [didacticiel sur les analyses ad hoc](sql-database-saas-tutorial-adhoc-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-131">In the Wingtip SaaS sample, the catalog is used to enable cross-tenant query, explored in the [ad hoc analytics tutorial](sql-database-saas-tutorial-adhoc-analytics.md).</span></span> <span data-ttu-id="b0131-132">La gestion des travaux entre différentes bases de données est expliquée dans les didacticiels sur la [gestion des schémas](sql-database-saas-tutorial-schema-management.md) et les [analyses de clients](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-132">Cross-database job management is explored in the [schema management](sql-database-saas-tutorial-schema-management.md) and [tenant analytics](sql-database-saas-tutorial-tenant-analytics.md) tutorials.</span></span> 

<span data-ttu-id="b0131-133">Dans l’application SaaS Wingtip, le catalogue est implémenté à l’aide des fonctionnalités de gestion des partitions de la [bibliothèque EDCL (Elastic Database Client Library, bibliothèque cliente de bases de données élastiques)](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-133">In the Wingtip SaaS app, the catalog is implemented using the Shard Management features of the [Elastic Database Client Library (EDCL)](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="b0131-134">La bibliothèque EDCL permet à une application de créer, gérer et utiliser une carte de partitions reposant sur des bases de données.</span><span class="sxs-lookup"><span data-stu-id="b0131-134">The EDCL enables an application to create, manage, and use a database-backed shard map.</span></span> <span data-ttu-id="b0131-135">Une carte de partitions contient une liste de partitions (bases de données) et le mappage entre les clés (clients) et les bases de données.</span><span class="sxs-lookup"><span data-stu-id="b0131-135">A shard map contains a list of shards (databases) and the mapping between keys (tenants) and databases.</span></span>  <span data-ttu-id="b0131-136">Les fonctions EDCL peuvent être utilisées à partir des applications ou des scripts PowerShell au cours de l’approvisionnement des clients pour créer les entrées dans la carte de partitions, et à partir des applications pour assurer une connexion fiable à la base de données correspondante.</span><span class="sxs-lookup"><span data-stu-id="b0131-136">EDCL functions can be used from applications or PowerShell scripts during tenant provisioning to create the entries in the shard map, and from applications to efficiently connect to the correct database.</span></span> <span data-ttu-id="b0131-137">La bibliothèque EDCL met en cache les informations de connexion pour réduire le trafic vers la base de données de catalogue et booster les performances de l’application.</span><span class="sxs-lookup"><span data-stu-id="b0131-137">EDCL caches connection information to minimize the traffic to the catalog database and speed up the application.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="b0131-138">Bien que les données de mappage soient accessibles dans la base de données de catalogue, *ne les modifiez pas*.</span><span class="sxs-lookup"><span data-stu-id="b0131-138">The mapping data is accessible in the catalog database, but *don't edit it*!</span></span> <span data-ttu-id="b0131-139">Modifiez les données de mappage des API Elastic Database Client Library uniquement.</span><span class="sxs-lookup"><span data-stu-id="b0131-139">Edit mapping data using Elastic Database Client Library APIs only.</span></span> <span data-ttu-id="b0131-140">Manipuler directement les données de mappage risque d’endommager le catalogue et n’est pas pris en charge.</span><span class="sxs-lookup"><span data-stu-id="b0131-140">Directly manipulating the mapping data risks corrupting the catalog and is not supported.</span></span>


## <a name="introduction-to-the-saas-provisioning-pattern"></a><span data-ttu-id="b0131-141">Présentation du modèle d’approvisionnement SaaS</span><span class="sxs-lookup"><span data-stu-id="b0131-141">Introduction to the SaaS Provisioning pattern</span></span>

<span data-ttu-id="b0131-142">Lors de l’intégration d’un nouveau client dans une application SaaS qui utilise un modèle de base de données à client unique, une nouvelle base de données client doit être approvisionnée.</span><span class="sxs-lookup"><span data-stu-id="b0131-142">When onboarding a new tenant in a SaaS application that uses a single-tenant database model a new tenant database must be provisioned.</span></span>  <span data-ttu-id="b0131-143">Celle-ci doit être créée dans l’emplacement et le niveau de service appropriés, initialisée avec les données de référence et le schéma appropriés, puis enregistrée dans le catalogue sous la clé de client correspondante.</span><span class="sxs-lookup"><span data-stu-id="b0131-143">It must be created in the appropriate location and service tier, initialized with appropriate schema and reference data, and then registered in the catalog under the appropriate tenant key.</span></span>  

<span data-ttu-id="b0131-144">Il existe différentes approches d’approvisionnement des bases de données, notamment l’exécution de scripts SQL, le déploiement d’un fichier bacpac ou la copie d’un modèle de base de données finale.</span><span class="sxs-lookup"><span data-stu-id="b0131-144">Different approaches can be used to database provisioning, which could include executing SQL scripts, deploying a bacpac, or copying a 'golden' template database.</span></span>  

<span data-ttu-id="b0131-145">La méthode d’approvisionnement que vous utilisez doit être comprise dans votre stratégie globale de gestion des schémas, qui doit s’assurer que les nouvelles bases de données sont approvisionnées avec le schéma le plus récent.</span><span class="sxs-lookup"><span data-stu-id="b0131-145">The provisioning approach you use must be comprehended in your overall schema management strategy, which must ensure that new databases are provisioned with the latest schema.</span></span>  <span data-ttu-id="b0131-146">Cela est explique dans le [didacticiel sur la gestion des schémas](sql-database-saas-tutorial-schema-management.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-146">This is explored in the [schema management tutorial](sql-database-saas-tutorial-schema-management.md).</span></span>  

<span data-ttu-id="b0131-147">L’application SaaS Wingtip approvisionne les nouveaux clients en copiant une base de données finale nommée basetenantdb, déployée sur le serveur de catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-147">The Wingtip SaaS app provisions new tenants by copying a golden database named basetenantdb, deployed on the catalog server.</span></span>  <span data-ttu-id="b0131-148">L’approvisionnement peut être intégré au processus d’inscription de l’application et/ou pris en charge en mode hors connexion à l’aide de scripts.</span><span class="sxs-lookup"><span data-stu-id="b0131-148">Provisioning could be integrated into the application as part of a sign-up experience, and/or supported offline using scripts.</span></span> <span data-ttu-id="b0131-149">Ce didacticiel décrit le processus d’approvisionnement à l’aide des scripts PowerShell.</span><span class="sxs-lookup"><span data-stu-id="b0131-149">This tutorial will explore provisioning using PowerShell.</span></span> <span data-ttu-id="b0131-150">Les scripts d’approvisionnement copient l’instance basetenantdb pour créer une nouvelle base de données client dans un pool élastique, avant de l’initialiser avec les informations spécifiques au client et de l’inscrire dans la carte de partitions du catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-150">The provisioning scripts copy the basetenantdb to create a new tenant database in an elastic pool, then initialize it with tenant-specific info and register it in the catalog shard map.</span></span>  <span data-ttu-id="b0131-151">Dans l’exemple d’application, les bases de données sont nommées en fonction du nom du client, même s’il ne s’agit pas d’un élément essentiel du modèle. Le catalogue permet d’attribuer n’importe quel nom à la base de données.+</span><span class="sxs-lookup"><span data-stu-id="b0131-151">In the sample app, databases are given names based on the tenant name, but this is not a critical part of the pattern – the use of the catalog allows any name to be assigned to the database.+</span></span> 


## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="b0131-152">Obtenir les scripts d’application Wingtip</span><span class="sxs-lookup"><span data-stu-id="b0131-152">Get the Wingtip application scripts</span></span>

<span data-ttu-id="b0131-153">Les scripts et le code source de l’application SaaS Wingtip sont disponibles dans le référentiel GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="b0131-153">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="b0131-154">[Étapes de téléchargement des scripts SaaS Wingtip](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="b0131-154">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>


## <a name="provision-and-catalog-detailed-walkthrough"></a><span data-ttu-id="b0131-155">Procédure pas à pas détaillée sur l’approvisionnement et l’inscription dans le catalogue</span><span class="sxs-lookup"><span data-stu-id="b0131-155">Provision and catalog detailed walkthrough</span></span>

<span data-ttu-id="b0131-156">Pour comprendre comment l’application Wingtip gère l’approvisionnement du nouveau client, ajoutez un point d’arrêt et suivez les étapes du flux de travail dans le cadre de l’approvisionnement d’un client :</span><span class="sxs-lookup"><span data-stu-id="b0131-156">To understand how the Wingtip application implements new tenant provisioning, add a breakpoint and step through the workflow while provisioning a tenant:</span></span>

1. <span data-ttu-id="b0131-157">Ouvrez ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ et définissez les paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="b0131-157">Open ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ and set the following parameters:</span></span>
   * <span data-ttu-id="b0131-158">**$TenantName** = nom du nouveau lieu (par exemple *Bushwillow Blues*).</span><span class="sxs-lookup"><span data-stu-id="b0131-158">**$TenantName** = the name of the new venue (for example, *Bushwillow Blues*).</span></span>
   * <span data-ttu-id="b0131-159">**$VenueType** = un des types prédéfinis de décor : *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span><span class="sxs-lookup"><span data-stu-id="b0131-159">**$VenueType** = one of the pre-defined venue types: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span></span>
   * <span data-ttu-id="b0131-160">**$DemoScenario** = **1**. Définissez sur **1** pour *approvisionner un seul client*.</span><span class="sxs-lookup"><span data-stu-id="b0131-160">**$DemoScenario** = **1**, Set to **1** to *Provision a single tenant*.</span></span>

1. <span data-ttu-id="b0131-161">Ajoutez un point d’arrêt en plaçant votre curseur n’importe où sur la ligne 48, celle qui indique *New-Tenant \`*, puis appuyez sur **F9**.</span><span class="sxs-lookup"><span data-stu-id="b0131-161">Add a breakpoint by putting your cursor anywhere on line 48, the line that says: *New-Tenant \`*, and press **F9**.</span></span>

   ![point d’arrêt](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. <span data-ttu-id="b0131-163">Pour exécuter le script, appuyez sur la touche **F5**.</span><span class="sxs-lookup"><span data-stu-id="b0131-163">To run the script press **F5**.</span></span>

1. <span data-ttu-id="b0131-164">Une fois que l’exécution du script s’arrête au point d’arrêt, appuyez sur **F11** pour effectuer un pas à pas détaillé du code.</span><span class="sxs-lookup"><span data-stu-id="b0131-164">After the script execution stops at the breakpoint, press **F11** to step into the code.</span></span>

   ![point d’arrêt](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



<span data-ttu-id="b0131-166">Suivez l’exécution du script à l’aide des options du menu **Débogage** **F10** et **F11** pour parcourir les fonctions invoquées.</span><span class="sxs-lookup"><span data-stu-id="b0131-166">Trace the script's execution using the **Debug** menu options - **F10** and **F11** to step over or into the called functions.</span></span> <span data-ttu-id="b0131-167">Pour plus d’informations sur le débogage des scripts PowerShell, consultez [Conseils sur l’utilisation et le débogage de scripts PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span><span class="sxs-lookup"><span data-stu-id="b0131-167">For more information about debugging PowerShell scripts, see [Tips on working with and debugging PowerShell scripts](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span></span>


<span data-ttu-id="b0131-168">Les points suivants ne sont pas des étapes à suivre explicitement, mais constituent une explication du flux de travail parcouru pendant le débogage du script :</span><span class="sxs-lookup"><span data-stu-id="b0131-168">The following are not steps to explicitly follow, but an explanation of the workflow you step through while debugging the script:</span></span>

1. <span data-ttu-id="b0131-169">**Importe le module SubscriptionManagement.psm1** qui contient des fonctions pour la connexion à Azure et la sélection de l’abonnement Azure que vous utilisez.</span><span class="sxs-lookup"><span data-stu-id="b0131-169">**Import the SubscriptionManagement.psm1** module that contains functions for signing in to Azure and selecting the Azure subscription you are working with.</span></span>
1. <span data-ttu-id="b0131-170">**Importe le module CatalogAndDatabaseManagement.psm1** qui fournit un catalogue et l’abstraction au niveau du locataire sur les fonctions de [gestion des partitions](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-170">**Import the CatalogAndDatabaseManagement.psm1** module that provides a catalog and tenant-level abstraction over the [Shard Management](sql-database-elastic-scale-shard-map-management.md) functions.</span></span> <span data-ttu-id="b0131-171">Il s’agit d’un module important qui encapsule une bonne partie du modèle de catalogue et que nous vous conseillons d’explorer.</span><span class="sxs-lookup"><span data-stu-id="b0131-171">This is an important module that encapsulates much of the catalog pattern and is worth exploring.</span></span>
1. <span data-ttu-id="b0131-172">**Accédez aux détails de configuration**.</span><span class="sxs-lookup"><span data-stu-id="b0131-172">**Get configuration details**.</span></span> <span data-ttu-id="b0131-173">Accédez à Get-Configuration (avec F11) et découvrez la façon dont la configuration de l’application est spécifiée.</span><span class="sxs-lookup"><span data-stu-id="b0131-173">Step into Get-Configuration (with F11) and see how the app config is specified.</span></span> <span data-ttu-id="b0131-174">Les noms de ressources et d’autres valeurs propres à l’application sont définis ici, mais ne les modifiez pas tant que vous n’êtes pas familiarisé avec les scripts.</span><span class="sxs-lookup"><span data-stu-id="b0131-174">Resource names and other app-specific values are defined here, but do not change any of these values until you are familiar with the scripts.</span></span>
1. <span data-ttu-id="b0131-175">**Obtenez l’objet catalogue**.</span><span class="sxs-lookup"><span data-stu-id="b0131-175">**Get the catalog object**.</span></span> <span data-ttu-id="b0131-176">Accédez à la fonction Get-Catalogue qui compose et retourne un objet de catalogue utilisé dans le script de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b0131-176">Step into Get-Catalog which composes and returns a catalog object that is used in the higher-level script.</span></span>  <span data-ttu-id="b0131-177">Cette fonction utilise les fonctions de gestion de partitions qui sont importées à partir de **AzureShardManagement.psm1**.</span><span class="sxs-lookup"><span data-stu-id="b0131-177">This function uses Shard Management functions that are imported from **AzureShardManagement.psm1**.</span></span> <span data-ttu-id="b0131-178">L’objet de catalogue est composé des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="b0131-178">The catalog object is composed of the following:</span></span>
   * <span data-ttu-id="b0131-179">$catalogServerFullyQualifiedName est construit à l’aide de la ressource standard et de votre nom d’utilisateur : _catalog-\<utilisateur\>.database.windows.net_.</span><span class="sxs-lookup"><span data-stu-id="b0131-179">$catalogServerFullyQualifiedName is constructed using the standard stem plus your User name: _catalog-\<user\>.database.windows.net_.</span></span>
   * <span data-ttu-id="b0131-180">$catalogDatabaseName est extrait de la configuration : *tenantcatalog*.</span><span class="sxs-lookup"><span data-stu-id="b0131-180">$catalogDatabaseName is retrieved from the config: *tenantcatalog*.</span></span>
   * <span data-ttu-id="b0131-181">L’objet $shardMapManager est initialisé à partir de la base de données de catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-181">$shardMapManager object is initialized from the catalog database.</span></span>
   * <span data-ttu-id="b0131-182">L’objet $shardMap est initialisé à partir de la carte de partitions *tenantcatalog* dans la base de données de catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-182">$shardMap object is initialized from the *tenantcatalog* shard map in the catalog database.</span></span>
   <span data-ttu-id="b0131-183">Un objet catalogue est composé, retourné et utilisé dans le script de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b0131-183">A catalog object is composed and returned, and used in the higher-level script.</span></span>
1. <span data-ttu-id="b0131-184">**Calculez la clé du nouveau locataire**.</span><span class="sxs-lookup"><span data-stu-id="b0131-184">**Calculate the new tenant key**.</span></span> <span data-ttu-id="b0131-185">Une fonction de hachage est utilisée pour créer la clé de locataire à partir du nom du locataire.</span><span class="sxs-lookup"><span data-stu-id="b0131-185">A hash function is used to create the tenant key from the tenant name.</span></span>
1. <span data-ttu-id="b0131-186">**Vérifiez si la clé de locataire existe déjà**.</span><span class="sxs-lookup"><span data-stu-id="b0131-186">**Check if the tenant key already exists**.</span></span> <span data-ttu-id="b0131-187">Le catalogue est passé en revue pour vérifier que la clé est disponible.</span><span class="sxs-lookup"><span data-stu-id="b0131-187">The catalog is checked to ensure the key is available.</span></span>
1. <span data-ttu-id="b0131-188">**La base de données de locataire est approvisionnée avec New-TenantDatabase.**</span><span class="sxs-lookup"><span data-stu-id="b0131-188">**The tenant database is provisioned with New-TenantDatabase.**</span></span> <span data-ttu-id="b0131-189">Utilisez **F11** pour parcourir les étapes du script et voir la façon dont la base de données est approvisionnée à l’aide d’un modèle [Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-189">Use **F11** to step in and see how the database is provisioned using an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md).</span></span>

<span data-ttu-id="b0131-190">Le nom de la base de données est construit à partir du nom de locataire, ce qui permet d’indiquer clairement quelle partition appartient à tel locataire.</span><span class="sxs-lookup"><span data-stu-id="b0131-190">The database name is constructed from the tenant name to make it clear which shard belongs to which tenant.</span></span> <span data-ttu-id="b0131-191">(D’autres stratégies relatives aux noms de base de données peuvent facilement être utilisées.)+ Un modèle Resource Manager permet de créer une base de données client en copiant une base de données finale (basetenantdb) sur le serveur de catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-191">(Other strategies for database naming could easily be used.)+ A Resource Manager template is used to create a tenant database by copying a golden database (baseTenantDB) on the catalog server.</span></span> <span data-ttu-id="b0131-192">Une autre approche consiste à créer une base de données vide et à l’initialiser en important un fichier bacpac. Il est également possible d’exécuter un script d’initialisation à partir d’un emplacement connu.</span><span class="sxs-lookup"><span data-stu-id="b0131-192">An alternative approach could be to create an empty database and then initialize it by importing a bacpac, or to execute an initialization script from a well-known location.</span></span>  

<span data-ttu-id="b0131-193">Le modèle Resource Manager est situé dans le dossier ...\Learning Modules\Common\ : *tenantdatabasecopytemplate.json*</span><span class="sxs-lookup"><span data-stu-id="b0131-193">The Resource Manager template is in the …\Learning Modules\Common\ folder: *tenantdatabasecopytemplate.json*</span></span>

<span data-ttu-id="b0131-194">Une fois que la base de données client a été créée, elle continue à être **initialisée avec le nom du lieu (client) et le type de lieu**.</span><span class="sxs-lookup"><span data-stu-id="b0131-194">After the tenant database is created, it is then further **initialized with the venue (tenant) name and the venue type**.</span></span> <span data-ttu-id="b0131-195">Une autre initialisation peut également être accomplie ici.</span><span class="sxs-lookup"><span data-stu-id="b0131-195">Other initialization could also be done here.</span></span>

<span data-ttu-id="b0131-196">La **base de données client est inscrite dans le catalogue** avec *Add-TenantDatabaseToCatalog* à l’aide de la clé de client.</span><span class="sxs-lookup"><span data-stu-id="b0131-196">The **tenant database is registered in the catalog** with *Add-TenantDatabaseToCatalog* using the tenant key.</span></span> <span data-ttu-id="b0131-197">Utilisez **F11** pour parcourir le script en détail :</span><span class="sxs-lookup"><span data-stu-id="b0131-197">Use **F11** to step into the details:</span></span>

* <span data-ttu-id="b0131-198">La base de données de catalogue est ajoutée à la carte de partitions (liste des bases de données connues).</span><span class="sxs-lookup"><span data-stu-id="b0131-198">The catalog database is added to the shard map (the list of known databases).</span></span>
* <span data-ttu-id="b0131-199">Le mappage qui lie la valeur de clé à la partition est créé.</span><span class="sxs-lookup"><span data-stu-id="b0131-199">The mapping that links the key value to the shard is created.</span></span>
* <span data-ttu-id="b0131-200">Des métadonnées supplémentaires (nom du lieu) sur le client sont ajoutées dans le tableau Clients du catalogue.</span><span class="sxs-lookup"><span data-stu-id="b0131-200">Additional meta data (the venue's name) about the tenant is added to the Tenants table in the catalog.</span></span>  <span data-ttu-id="b0131-201">Le tableau Clients ne fait pas partie du schéma ShardManagement et n’est pas installé par la bibliothèque EDCL.</span><span class="sxs-lookup"><span data-stu-id="b0131-201">The Tenants table is not part of the ShardManagement schema and is not installed by the EDCL.</span></span>  <span data-ttu-id="b0131-202">Le tableau suivant illustre comment la base de données de catalogue peut être étendue pour prendre en charge des données supplémentaires spécifiques à l’application.</span><span class="sxs-lookup"><span data-stu-id="b0131-202">This table illustrates how the Catalog database can be extended to support additional application-specific data.</span></span>   


<span data-ttu-id="b0131-203">Une fois l’approvisionnement terminé, l’exécution retourne au script d’origine *Demo-ProvisionAndCatalog* qui ouvre la page **Events** (Événements) du nouveau client dans le navigateur :</span><span class="sxs-lookup"><span data-stu-id="b0131-203">After provisioning completes, execution returns to the original *Demo-ProvisionAndCatalog* script, which opens the **Events** page for the new tenant in the browser:</span></span>

   ![événements](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a><span data-ttu-id="b0131-205">Approvisionner un lot de locataires</span><span class="sxs-lookup"><span data-stu-id="b0131-205">Provision a batch of tenants</span></span>

<span data-ttu-id="b0131-206">Cet exercice permet d’approvisionner un lot de 17 clients.</span><span class="sxs-lookup"><span data-stu-id="b0131-206">This exercise provisions a batch of 17 tenants.</span></span> <span data-ttu-id="b0131-207">Il est recommandé d’approvisionner ce lot de clients avant de suivre d’autres didacticiels SaaS Wingtip afin de pouvoir utiliser plusieurs bases de données.</span><span class="sxs-lookup"><span data-stu-id="b0131-207">It’s recommended you provision this batch of tenants before starting other Wingtip SaaS tutorials, so there's more than just a few databases to work with.</span></span>

1. <span data-ttu-id="b0131-208">Ouvrez...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* dans *l’ISE PowerShell* et définissez le paramètre *$DemoScenario* sur 3 :</span><span class="sxs-lookup"><span data-stu-id="b0131-208">Open ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* in the *PowerShell ISE* and change the *$DemoScenario* parameter to 3:</span></span>
   * <span data-ttu-id="b0131-209">**$DemoScenario** = **3**. Changez sur **3** pour *Approvisionner un lot de clients*.</span><span class="sxs-lookup"><span data-stu-id="b0131-209">**$DemoScenario** = **3**, change to **3** to *Provision a batch of tenants*.</span></span>
1. <span data-ttu-id="b0131-210">Appuyez sur **F5** pour exécuter le script.</span><span class="sxs-lookup"><span data-stu-id="b0131-210">Press **F5** and run the script.</span></span>

<span data-ttu-id="b0131-211">Le script déploie un lot de locataires supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b0131-211">The script deploys a batch of additional tenants.</span></span> <span data-ttu-id="b0131-212">Il utilise un [modèle Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md) qui contrôle le lot et délègue ensuite la configuration de chaque base de données à un modèle lié.</span><span class="sxs-lookup"><span data-stu-id="b0131-212">It uses an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md) that controls the batch and then delegates provisioning of each database to a linked template.</span></span> <span data-ttu-id="b0131-213">Utiliser des modèles de cette façon permet à Azure Resource Manager de répartir le processus d’approvisionnement pour votre script.</span><span class="sxs-lookup"><span data-stu-id="b0131-213">Using templates in this way allows Azure Resource Manager to broker the provisioning process for your script.</span></span> <span data-ttu-id="b0131-214">Les modèles approvisionnent des bases de données en parallèle dans la mesure du possible, et gèrent les nouvelles tentatives au besoin, en optimisant le processus global.</span><span class="sxs-lookup"><span data-stu-id="b0131-214">Templates provision databases in parallel where it can, and handles retries if needed, optimizing the overall process.</span></span> <span data-ttu-id="b0131-215">Comme le script est idempotent, en cas d’échec ou d’arrêt pour une raison quelconque, exécutez-le à nouveau.</span><span class="sxs-lookup"><span data-stu-id="b0131-215">The script is idempotent so if it fails or stops for any reason, run it again.</span></span>

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a><span data-ttu-id="b0131-216">Vérifier que le lot de locataires a été correctement déployé</span><span class="sxs-lookup"><span data-stu-id="b0131-216">Verify the batch of tenants successfully deployed</span></span>

* <span data-ttu-id="b0131-217">Ouvrez le serveur *tenants1* en accédant à votre liste de serveurs dans le [portail Azure](https://portal.azure.com), cliquez sur **bases de données SQL**et vérifiez que le lot de 17 bases de données supplémentaires est désormais dans la liste :</span><span class="sxs-lookup"><span data-stu-id="b0131-217">Open the *tenants1* server by browsing to your list of servers in the [Azure portal](https://portal.azure.com), click **SQL databases**, and verify the batch of 17 additional databases are now in the list:</span></span>

   ![liste de base de données](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a><span data-ttu-id="b0131-219">Autres modèles d’approvisionnement</span><span class="sxs-lookup"><span data-stu-id="b0131-219">Other provisioning patterns</span></span>

<span data-ttu-id="b0131-220">Voici les autres modèles d’approvisionnement non inclus dans ce tutoriel :</span><span class="sxs-lookup"><span data-stu-id="b0131-220">Other provisioning patterns not included in this tutorial include:</span></span>

<span data-ttu-id="b0131-221">**Pré-approvisionnement des bases de données.**</span><span class="sxs-lookup"><span data-stu-id="b0131-221">**Pre-provisioning databases.**</span></span> <span data-ttu-id="b0131-222">Le modèle de pré-approvisionnement exploite le fait que les bases de données d’un pool élastique n’ajoutent pas de frais supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b0131-222">The pre-provisioning pattern exploits the fact that databases in an elastic pool do not add extra cost.</span></span> <span data-ttu-id="b0131-223">La facturation concerne le pool élastique, pas les bases de données, et les bases de données inactives ne consomment aucune ressource.</span><span class="sxs-lookup"><span data-stu-id="b0131-223">Billing is for the elastic pool, not the databases, and idle databases consume no resources.</span></span> <span data-ttu-id="b0131-224">En pré-approvisionnant les bases de données d’un pool et en les allouant en cas de besoin, le délai d’intégration du client peut être considérablement réduit.</span><span class="sxs-lookup"><span data-stu-id="b0131-224">By pre-provisioning databases in a pool and allocating them when needed, tenant onboarding time can be reduced significantly.</span></span> <span data-ttu-id="b0131-225">Le nombre de bases de données pré-approvisionnées peut être ajusté en fonction des besoins pour conserver une mémoire tampon adaptée au taux d’approvisionnement prévu.</span><span class="sxs-lookup"><span data-stu-id="b0131-225">The number of databases pre-provisioned could be adjusted as needed to keep a buffer suitable for the anticipated provisioning rate.</span></span>

<span data-ttu-id="b0131-226">**Approvisionnement automatique.**</span><span class="sxs-lookup"><span data-stu-id="b0131-226">**Auto-provisioning.**</span></span> <span data-ttu-id="b0131-227">Dans le modèle d’approvisionnement automatique, un service d’approvisionnement dédié est utilisé pour approvisionner automatiquement les serveurs, pools et bases de données en fonction des besoins, notamment en pré-approvisionnant les bases de données dans des pools élastiques si besoin.</span><span class="sxs-lookup"><span data-stu-id="b0131-227">In the auto-provisioning pattern, a dedicated provisioning service is used to provision servers, pools, and databases automatically as needed – including pre-provisioning databases in elastic pools if desired.</span></span> <span data-ttu-id="b0131-228">Si les bases de données sont mises hors service et supprimées, les écarts dans les pools élastiques peuvent être remplis par le service d’approvisionnement, en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="b0131-228">And if databases are de-commissioned and deleted, gaps in elastic pools can be filled by the provisioning service as desired.</span></span> <span data-ttu-id="b0131-229">Un tel service peut être simple ou complexe (par exemple, la gestion de l’approvisionnement sur plusieurs zones géographiques) et peut configurer la géoréplication automatiquement si cette stratégie est utilisée pour la récupération d’urgence.</span><span class="sxs-lookup"><span data-stu-id="b0131-229">Such a service could be simple or complex – for example, handling provisioning across multiple geographies, and could set up geo-replication automatically if that strategy is being used for disaster recovery.</span></span> <span data-ttu-id="b0131-230">Avec le modèle d’approvisionnement automatique, une application cliente ou un script soumet une demande d’approvisionnement à une file d’attente pour traitement par le service d’approvisionnement et interroge ensuite le service pour déterminer l’achèvement de l’opération.</span><span class="sxs-lookup"><span data-stu-id="b0131-230">With the auto-provisioning pattern, a client application or script would submit a provisioning request to a queue to be processed by the provisioning service, and would then poll the service to determine completion.</span></span> <span data-ttu-id="b0131-231">Si le pré-approvisionnement est utilisé, les demandes sont gérées rapidement grâce au service gérant l’approvisionnement d’une base de données de remplacement exécutée en arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="b0131-231">If pre-provisioning is used, requests would be handled quickly with the service managing provisioning of a replacement database running in the background.</span></span>



## <a name="next-steps"></a><span data-ttu-id="b0131-232">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="b0131-232">Next steps</span></span>

<span data-ttu-id="b0131-233">Dans ce tutoriel, vous avez appris à effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="b0131-233">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="b0131-234">Approvisionner un nouveau locataire unique</span><span class="sxs-lookup"><span data-stu-id="b0131-234">Provision a single new tenant</span></span>
> * <span data-ttu-id="b0131-235">Approvisionner un lot de locataires supplémentaires</span><span class="sxs-lookup"><span data-stu-id="b0131-235">Provision a batch of additional tenants</span></span>
> * <span data-ttu-id="b0131-236">Parcourir les étapes de l’approvisionnement des locataires et de leur inscription dans le catalogue</span><span class="sxs-lookup"><span data-stu-id="b0131-236">Step into the details of provisioning tenants, and registering them into the catalog</span></span>

<span data-ttu-id="b0131-237">Essayez le [didacticiel Surveillance des performances](sql-database-saas-tutorial-performance-monitoring.md).</span><span class="sxs-lookup"><span data-stu-id="b0131-237">Try the [Performance monitoring tutorial](sql-database-saas-tutorial-performance-monitoring.md).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="b0131-238">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="b0131-238">Additional Resources</span></span>

* <span data-ttu-id="b0131-239">Autres [didacticiels reposant sur l’application SaaS Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="b0131-239">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="b0131-240">Bibliothèque cliente de base de données élastique</span><span class="sxs-lookup"><span data-stu-id="b0131-240">Elastic database client library</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [<span data-ttu-id="b0131-241">Déboguer les scripts dans l’ISE Windows PowerShell</span><span class="sxs-lookup"><span data-stu-id="b0131-241">How to Debug Scripts in Windows PowerShell ISE</span></span>](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)
