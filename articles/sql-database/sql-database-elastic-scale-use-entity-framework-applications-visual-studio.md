---
title: "bibliothèque cliente de base de données élastique aaaUsing avec Entity Framework | Documents Microsoft"
description: "Utilisez la bibliothèque cliente de la base de données élastique et Entity Framework pour le codage de bases de données"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="00092-103">Bibliothèque cliente de la base de données élastique avec Entity Framework</span><span class="sxs-lookup"><span data-stu-id="00092-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="00092-104">Ce document montre les modifications hello dans une application Entity Framework qui sont nécessaire toointegrate avec hello [outils de base de données élastique](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="00092-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="00092-105">Hello porte sur la composition de [gestion de carte de partitions](sql-database-elastic-scale-shard-map-management.md) et [routage dépendant des données](sql-database-elastic-scale-data-dependent-routing.md) avec hello Entity Framework **Code First** approche.</span><span class="sxs-lookup"><span data-stu-id="00092-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="00092-106">Hello [Code First - nouvelle base de données](http://msdn.microsoft.com/data/jj193542.aspx) didacticiel pour EF sert de notre exemple en cours d’exécution tout au long de ce document.</span><span class="sxs-lookup"><span data-stu-id="00092-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="00092-107">exemple de code Hello accompagnant ce document fait partie d’outils de base de données élastique de jeu d’échantillons Bonjour les exemples de Code Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="00092-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="00092-108">Téléchargement et exécution hello, exemple de Code</span><span class="sxs-lookup"><span data-stu-id="00092-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="00092-109">code de hello toodownload de cet article :</span><span class="sxs-lookup"><span data-stu-id="00092-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="00092-110">Visual Studio 2012 ou une version ultérieure est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="00092-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="00092-111">Télécharger hello [élastique outils de base de données pour SQL Azure - exemple d’Entity Framework intégration](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) à partir de MSDN.</span><span class="sxs-lookup"><span data-stu-id="00092-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="00092-112">Décompressez hello exemple tooa d’emplacement de votre choix.</span><span class="sxs-lookup"><span data-stu-id="00092-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="00092-113">Démarrez Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="00092-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="00092-114">Dans Visual Studio, sélectionnez Fichier -> Ouvrir un projet/une solution.</span><span class="sxs-lookup"><span data-stu-id="00092-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="00092-115">Bonjour **ouvrir le projet** boîte de dialogue, naviguez exemple toohello vous avez téléchargé et sélectionnez **EntityFrameworkCodeFirst.sln** tooopen hello exemple.</span><span class="sxs-lookup"><span data-stu-id="00092-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="00092-116">exemple de hello toorun, vous devez toocreate trois bases de données vides dans la base de données SQL Azure :</span><span class="sxs-lookup"><span data-stu-id="00092-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="00092-117">Une base de données du gestionnaire des cartes de partitions</span><span class="sxs-lookup"><span data-stu-id="00092-117">Shard Map Manager database</span></span>
* <span data-ttu-id="00092-118">Une base de données nommée Shard 1</span><span class="sxs-lookup"><span data-stu-id="00092-118">Shard 1 database</span></span>
* <span data-ttu-id="00092-119">Une base de données nommée Shard 2</span><span class="sxs-lookup"><span data-stu-id="00092-119">Shard 2 database</span></span>

<span data-ttu-id="00092-120">Une fois que vous avez créé ces bases de données, renseignez les espaces réservés hello dans **Program.cs** avec le nom de votre serveur de base de données SQL Azure, les noms de base de données hello et vos bases de données toohello de tooconnect informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="00092-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="00092-121">Générez la solution hello dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="00092-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="00092-122">Visual Studio télécharge les packages NuGet hello requis pour la bibliothèque cliente de base de données élastique hello, Entity Framework et gestion dans le cadre du processus de génération hello d’erreurs transitoires.</span><span class="sxs-lookup"><span data-stu-id="00092-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="00092-123">Assurez-vous que la restauration des packages NuGet est activée pour votre solution.</span><span class="sxs-lookup"><span data-stu-id="00092-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="00092-124">Vous pouvez l’activer en cliquant sur le fichier de solution hello Bonjour Explorateur de solutions Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="00092-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="00092-125">Flux de travail Entity Framework</span><span class="sxs-lookup"><span data-stu-id="00092-125">Entity Framework workflows</span></span>
<span data-ttu-id="00092-126">Les développeurs de Entity Framework s’appuient sur l’un des hello suivant quatre applications toobuild de flux de travail et de persistance tooensure pour les objets de l’application :</span><span class="sxs-lookup"><span data-stu-id="00092-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="00092-127">**Code First (nouvelle base de données)**: hello développeur d’EF crée un modèle de hello dans le code de l’application hello et EF génère ensuite une base de données hello à partir de celui-ci.</span><span class="sxs-lookup"><span data-stu-id="00092-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="00092-128">**Code First (base de données existante)**: développeur de hello permet de générer le code de l’application hello pour le modèle de hello à partir d’une base de données EF.</span><span class="sxs-lookup"><span data-stu-id="00092-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="00092-129">**Modèle premier**: développeur de hello crée un modèle de hello dans le Concepteur EF hello et EF crée ensuite une base de données hello à partir du modèle de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="00092-130">**Base de données de la première**: développeur de hello utilise EF outils modèle de hello tooinfer à partir d’une base de données existante.</span><span class="sxs-lookup"><span data-stu-id="00092-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="00092-131">Toutes ces méthodes reposent sur tootransparently de classe DbContext hello gérer les connexions de base de données et le schéma de base de données pour une application.</span><span class="sxs-lookup"><span data-stu-id="00092-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="00092-132">Que nous allons aborder plus en détail plus loin dans le document de hello, différents des constructeurs de classe de base de DbContext hello autorisent pour différents niveaux de contrôle sur la création de la connexion de base de données d’amorçage et le schéma de la création.</span><span class="sxs-lookup"><span data-stu-id="00092-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="00092-133">Difficultés se présentent essentiellement à partir de faits hello gestion des connexions de base de données hello fournie par EF située à l’intersection avec les fonctionnalités de gestion des connexions hello hello données dépendant d’interfaces de routage fournies par la bibliothèque cliente de base de données élastique hello.</span><span class="sxs-lookup"><span data-stu-id="00092-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="00092-134">Hypothèses des outils de base de données élastique</span><span class="sxs-lookup"><span data-stu-id="00092-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="00092-135">Vous trouverez les définitions des termes évoqués ici sur la page [Glossaire des outils de base de données élastique](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="00092-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="00092-136">La bibliothèque cliente de base de données permet de définir des partitions pour les données de votre application. Ces partitions sont nommées shardlets.</span><span class="sxs-lookup"><span data-stu-id="00092-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="00092-137">Shardlets sont identifiées par une clé de partitionnement et de bases de données toospecific mappé.</span><span class="sxs-lookup"><span data-stu-id="00092-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="00092-138">Une application peut avoir qu’un grand nombre de bases de données en fonction des besoins et distribuer hello shardlets tooprovide suffisamment de capacité ou les performances étant donné les besoins de l’entreprise en cours.</span><span class="sxs-lookup"><span data-stu-id="00092-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="00092-139">mappage Hello des bases de données de partitionnement les valeurs de clé toohello est stockée par une carte de partitions fournie par l’API du client de base de données élastique hello.</span><span class="sxs-lookup"><span data-stu-id="00092-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="00092-140">Nous appelons cette fonctionnalité **Gestion des cartes de partitions**, ou GCP.</span><span class="sxs-lookup"><span data-stu-id="00092-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="00092-141">carte de partitions Hello sert également de broker hello de connexions de base de données pour les requêtes qui comportent une clé de partitionnement.</span><span class="sxs-lookup"><span data-stu-id="00092-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="00092-142">Nous nous référons fonctionnalité toothis comme **routage dépendant des données**.</span><span class="sxs-lookup"><span data-stu-id="00092-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="00092-143">Gestionnaire de cartes de partitions Hello protège les utilisateurs à partir des vues incohérentes dans les données de shardlet qui peuvent se produire lorsque des opérations de gestion shardlet simultanés (par exemple, le déplacement de données à partir d’une seule partition tooanother) sont produisent.</span><span class="sxs-lookup"><span data-stu-id="00092-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="00092-144">toodo hello par conséquent, les cartes de partitions gérés par des connexions de base de données hello client bibliothèque broker hello pour une application.</span><span class="sxs-lookup"><span data-stu-id="00092-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="00092-145">Ainsi, kill de hello partition carte fonctionnalité tooautomatically une connexion de base de données lorsque les opérations de gestion de partitions peut affecter les shardlets hello connexion de hello a été créée pour.</span><span class="sxs-lookup"><span data-stu-id="00092-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="00092-146">Cette approche doit toointegrate avec certaines des fonctionnalités de EF, telles que la création de nouvelles connexions à partir d’un un toocheck existant pour l’existence de base de données.</span><span class="sxs-lookup"><span data-stu-id="00092-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="00092-147">En règle générale, nous avons observé que les constructeurs DbContext standards hello uniquement fonctionnent de façon fiable pour les connexions de base de données fermée qui peuvent être clonées sans risque pour le travail EF.</span><span class="sxs-lookup"><span data-stu-id="00092-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="00092-148">le principe de conception Hello de base de données élastique est à la place de connexions de broker ouvert de tooonly.</span><span class="sxs-lookup"><span data-stu-id="00092-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="00092-149">On pourrait penser que la fermeture d’une connexion répartie par la bibliothèque cliente de hello avant de le passer sur toohello DbContext EF peut résoudre ce problème.</span><span class="sxs-lookup"><span data-stu-id="00092-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="00092-150">Toutefois, par la fermeture de la connexion de hello et s’appuyer sur EF toore-ouvrir, une foregoes des vérifications de validation et la cohérence hello effectuées par la bibliothèque de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="00092-151">fonctionnalités de migrations Hello dans EF, cependant, utilisent ces hello toomanage de connexions sous-jacent du schéma de base de données d’une manière qui est transparente toohello application.</span><span class="sxs-lookup"><span data-stu-id="00092-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="00092-152">Dans l’idéal, nous comme tooretain et associer ces fonctionnalités à partir de la bibliothèque cliente de base de données élastique hello et EF Bonjour même application.</span><span class="sxs-lookup"><span data-stu-id="00092-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="00092-153">Hello section suivante décrit ces propriétés et les exigences de plus en détail.</span><span class="sxs-lookup"><span data-stu-id="00092-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="00092-154">Configuration requise</span><span class="sxs-lookup"><span data-stu-id="00092-154">Requirements</span></span>
<span data-ttu-id="00092-155">Lorsque vous travaillez avec la bibliothèque cliente de base de données élastique hello et API Entity Framework, nous souhaitons hello tooretain propriétés suivantes :</span><span class="sxs-lookup"><span data-stu-id="00092-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="00092-156">**Montée en puissance parallèle**: tooadd ou supprimer des bases de données de la couche de données hello d’application partitionnée hello en fonction des besoins de capacité hello de l’application hello.</span><span class="sxs-lookup"><span data-stu-id="00092-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="00092-157">Cela signifie que le contrôle sur la création de hello hello et suppression de bases de données et à l’aide de hello de base de données élastique partition carte manager API toomanage bases de données et les mappages de shardlets.</span><span class="sxs-lookup"><span data-stu-id="00092-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="00092-158">**Cohérence**: application hello emploie le partitionnement et utilise hello fonctionnalités routage de données dépendant de la bibliothèque cliente de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="00092-159">tooavoid ou corruption des résultats de requête incorrect, les connexions sont réparties via le Gestionnaire de carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="00092-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="00092-160">Cela maintient également la validation et la cohérence.</span><span class="sxs-lookup"><span data-stu-id="00092-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="00092-161">**Code First**: plus de commodité tooretain hello de paradigme de première du EF code.</span><span class="sxs-lookup"><span data-stu-id="00092-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="00092-162">Dans le Code First, les classes dans l’application hello sont mappées en toute transparence toohello sous-jacente des structures de base de données.</span><span class="sxs-lookup"><span data-stu-id="00092-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="00092-163">code de l’application Hello interagit avec DbSets qui masque la plupart des aspects impliqués dans hello sous-jacent du traitement de la base de données.</span><span class="sxs-lookup"><span data-stu-id="00092-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="00092-164">**Schéma**: Entity Framework gère la création initiale de schémas de base de données et l'évolution subséquente des schémas via des migrations.</span><span class="sxs-lookup"><span data-stu-id="00092-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="00092-165">En conservant ces fonctionnalités, adapter votre application est simple comme Bonjour données évoluent.</span><span class="sxs-lookup"><span data-stu-id="00092-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="00092-166">Hello guide suivant indique comment toosatisfy ces exigences pour les applications de Code First à l’aide des outils de base de données élastique.</span><span class="sxs-lookup"><span data-stu-id="00092-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="00092-167">Routage dépendant des données à l'aide de DbContext EF</span><span class="sxs-lookup"><span data-stu-id="00092-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="00092-168">Les connexions de base de données avec Entity Framework sont généralement gérées via des classes secondaires de **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="00092-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="00092-169">Créez ces sous-classes en procédant à une dérivation à partir de **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="00092-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="00092-170">C’est ici que vous définissez votre **DbSets** qui implémentent des collections de base de données sauvegardée hello d’objets CLR pour votre application.</span><span class="sxs-lookup"><span data-stu-id="00092-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="00092-171">Dans le contexte de hello de routage dépendant des données, nous pouvons identifier plusieurs propriétés utiles qui ne contiennent pas nécessairement pour d’autres scénarios d’application première EF code :</span><span class="sxs-lookup"><span data-stu-id="00092-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="00092-172">base de données Hello existe déjà et a été inscrit dans la carte de partitions de base de données élastique hello.</span><span class="sxs-lookup"><span data-stu-id="00092-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="00092-173">schéma Hello de l’application hello a déjà été déployé toohello de base de données (voir ci-après).</span><span class="sxs-lookup"><span data-stu-id="00092-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="00092-174">Base de données du toohello de connexions routage dépendant des données sont réparties par carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="00092-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="00092-175">toointegrate **DbContexts** avec routage dépendant des données pour la montée en puissance parallèle :</span><span class="sxs-lookup"><span data-stu-id="00092-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="00092-176">Créer des connexions de base de données physique via des interfaces client hello élastique de base de données du Gestionnaire de carte de partitions hello,</span><span class="sxs-lookup"><span data-stu-id="00092-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="00092-177">Retour à la ligne connexion hello avec hello **DbContext** sous-classe</span><span class="sxs-lookup"><span data-stu-id="00092-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="00092-178">Passer de connexion de hello vers le bas dans hello **DbContext** tooensure classes tout traitement hello côté d’EF hello se produit également de base.</span><span class="sxs-lookup"><span data-stu-id="00092-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="00092-179">Hello, exemple de code suivant illustre cette approche.</span><span class="sxs-lookup"><span data-stu-id="00092-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="00092-180">(Ce code est également Bonjour accompagnant de projet Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="00092-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="00092-181">Points principaux</span><span class="sxs-lookup"><span data-stu-id="00092-181">Main points</span></span>
* <span data-ttu-id="00092-182">Un nouveau constructeur remplace le constructeur par défaut de hello dans une sous-classe de DbContext hello</span><span class="sxs-lookup"><span data-stu-id="00092-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="00092-183">Hello nouveau constructeur prend des arguments hello qui sont requis pour le routage dépendant des données via la bibliothèque cliente de base de données élastique :</span><span class="sxs-lookup"><span data-stu-id="00092-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="00092-184">tooaccess de carte de partitions Hello hello interfaces de routage dépendant des données,</span><span class="sxs-lookup"><span data-stu-id="00092-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="00092-185">Hello partitionnement tooidentify clé hello shardlet,</span><span class="sxs-lookup"><span data-stu-id="00092-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="00092-186">chaîne de connexion avec les informations d’identification de hello pour les partitions de toohello de connexion routage hello dépendant des données.</span><span class="sxs-lookup"><span data-stu-id="00092-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="00092-187">constructeur de classe de base toohello Hello appel prend un détournement dans une méthode statique qui effectue toutes les étapes de hello nécessaire pour le routage dépendant des données.</span><span class="sxs-lookup"><span data-stu-id="00092-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="00092-188">Elle utilise appel de OpenConnectionForKey hello d’interfaces de client de base de données élastique hello tooestablish de carte de partitions hello une connexion ouverte.</span><span class="sxs-lookup"><span data-stu-id="00092-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="00092-189">carte de partitions Hello crée les partitions toohello hello connexion ouverte qui contient le shardlet hello pour hello étant donné la clé de partitionnement.</span><span class="sxs-lookup"><span data-stu-id="00092-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="00092-190">Cette connexion ouverte est passée de constructeur de classe de base toohello arrière de tooindicate DbContext que cette connexion est toobe utilisé par EF au lieu de laisser EF à créer une nouvelle connexion automatiquement.</span><span class="sxs-lookup"><span data-stu-id="00092-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="00092-191">Cette connexion de hello moyen a été marquée par l’API du client de base de données élastique hello afin qu’il peut garantir la cohérence dans les opérations de gestion de carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="00092-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="00092-192">Utilisez le nouveau constructeur de hello pour votre sous-classe DbContext au lieu de constructeur par défaut de hello dans votre code.</span><span class="sxs-lookup"><span data-stu-id="00092-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="00092-193">Voici un exemple :</span><span class="sxs-lookup"><span data-stu-id="00092-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="00092-194">nouveau constructeur de Hello ouvre les partitions toohello hello connexion qui contient les données hello pour shardlet hello identifié par la valeur hello **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="00092-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="00092-195">Hello code Bonjour **à l’aide de** bloc reste inchangée tooaccess hello **DbSet** pour les blogs utilisant EF sur les partitions hello pour **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="00092-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="00092-196">Cela modifie la sémantique de code hello Bonjour à l’aide de bloc de telle sorte que toutes les opérations de base de données sont désormais étendue toohello une seule partition où **tenantid1** est conservé.</span><span class="sxs-lookup"><span data-stu-id="00092-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="00092-197">Par exemple, une requête LINQ sur les blogs hello **DbSet** retourner uniquement les blogs stockés sur la partition actuelle de hello, mais pas hello ceux stockés sur les autres partitions.</span><span class="sxs-lookup"><span data-stu-id="00092-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="00092-198">Gestion des erreurs temporaires</span><span class="sxs-lookup"><span data-stu-id="00092-198">Transient faults handling</span></span>
<span data-ttu-id="00092-199">Hello Microsoft Patterns & Practices équipe hello publiée [hello bloc applicatif de pannes gestion](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="00092-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="00092-200">bibliothèque de Hello est utilisé avec la bibliothèque cliente de mise à l’échelle élastique en combinaison avec EF.</span><span class="sxs-lookup"><span data-stu-id="00092-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="00092-201">Toutefois, assurez-vous que n’importe quelle exception temporaire retourne place tooa où nous pouvons garantir que ce nouveau constructeur de hello est utilisé après une panne temporaire afin que toute nouvelle tentative de connexion à l’aide de constructeurs hello que nous avons modifié.</span><span class="sxs-lookup"><span data-stu-id="00092-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="00092-202">Sinon, un toohello de connexion correct partition n’est pas garantie, et il ne sont a aucuns garanties connexion de hello est conservée en tant que modifications carte de partitions toohello se produisent.</span><span class="sxs-lookup"><span data-stu-id="00092-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="00092-203">Hello exemple de code suivant illustre comment une stratégie de nouvelle tentative SQL peut être utilisée autour hello nouvelle **DbContext** constructeurs de la sous-classe :</span><span class="sxs-lookup"><span data-stu-id="00092-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="00092-204">**SqlDatabaseUtils.SqlRetryPolicy** Bonjour code ci-dessus est défini comme un **SqlDatabaseTransientErrorDetectionStrategy** avec un nombre de tentatives de 10 et 5 secondes délai entre deux tentatives.</span><span class="sxs-lookup"><span data-stu-id="00092-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="00092-205">Cette approche est semblable toohello des conseils pour EF et les transactions d’initiée par l’utilisateur (voir [Limitations de nouvelle tentative de stratégies d’exécution (EF6 et versions ultérieures)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="00092-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="00092-206">Les deux situations exigent ce programme d’application hello contrôle hello étendue toowhich hello exception passagère retourne : tooeither rouvrir les transactions hello ou (comme indiqué) recréer le contexte de hello de constructeur approprié de hello qu’utilise hello élastique de base de données bibliothèque cliente.</span><span class="sxs-lookup"><span data-stu-id="00092-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="00092-207">Hello toocontrol besoin où des exceptions transitoires nous prennent à portée également exclut hello utilisation d’intégrées de hello **SqlAzureExecutionStrategy** qui est livré avec EF.</span><span class="sxs-lookup"><span data-stu-id="00092-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="00092-208">**SqlAzureExecutionStrategy** serait rouvrir une connexion, mais pas utiliser **OpenConnectionForKey** et par conséquent ignorer toute validation hello qui est effectuée dans le cadre de hello **OpenConnectionForKey** appeler.</span><span class="sxs-lookup"><span data-stu-id="00092-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="00092-209">En revanche, exemple de code hello utilise intégrées de hello **DefaultExecutionStrategy** qui est également fourni avec EF.</span><span class="sxs-lookup"><span data-stu-id="00092-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="00092-210">Par opposition trop**SqlAzureExecutionStrategy**, elle fonctionne correctement en association avec la stratégie de nouvelle tentative hello à partir de la gestion d’erreur temporaire.</span><span class="sxs-lookup"><span data-stu-id="00092-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="00092-211">stratégie d’exécution Hello est définie dans hello **ElasticScaleDbConfiguration** classe.</span><span class="sxs-lookup"><span data-stu-id="00092-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="00092-212">Notez que nous avons ne décidé pas toouse **DefaultSqlExecutionStrategy** , car il suggère de toouse **SqlAzureExecutionStrategy** en cas d’exceptions transitoires - qui entraînerait un comportement de toowrong comme indiqué.</span><span class="sxs-lookup"><span data-stu-id="00092-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="00092-213">Pour plus d’informations sur les stratégies de nouvelle tentative autre hello et EF, consultez [résilience des connexions dans EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="00092-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="00092-214">Réécritures de constructeur</span><span class="sxs-lookup"><span data-stu-id="00092-214">Constructor rewrites</span></span>
<span data-ttu-id="00092-215">exemples de code ci-dessus Hello illustrent par défaut de hello constructeur réécrit requis pour votre application de données de commandes toouse dépendantes de routage avec hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="00092-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="00092-216">Hello tableau suivant permet de généraliser les constructeurs de tooother de cette approche.</span><span class="sxs-lookup"><span data-stu-id="00092-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="00092-217">Constructeur en cours</span><span class="sxs-lookup"><span data-stu-id="00092-217">Current Constructor</span></span> | <span data-ttu-id="00092-218">Constructeur réécrit pour les données</span><span class="sxs-lookup"><span data-stu-id="00092-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="00092-219">Constructeur de base</span><span class="sxs-lookup"><span data-stu-id="00092-219">Base Constructor</span></span> | <span data-ttu-id="00092-220">Remarques</span><span class="sxs-lookup"><span data-stu-id="00092-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="00092-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="00092-221">MyContext()</span></span> |<span data-ttu-id="00092-222">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="00092-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="00092-223">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="00092-224">connexion de Hello doit toobe une fonction de la carte de partitions hello et clé de routage dépendant des données hello.</span><span class="sxs-lookup"><span data-stu-id="00092-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="00092-225">Tooby passe la création de la connexion automatique par EF et d’utiliser à la place les connexion de hello partition carte toobroker hello.</span><span class="sxs-lookup"><span data-stu-id="00092-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="00092-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="00092-226">MyContext(string)</span></span> |<span data-ttu-id="00092-227">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="00092-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="00092-228">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="00092-229">connexion de Hello est une fonction de la carte de partitions hello et clé de routage dépendant des données hello.</span><span class="sxs-lookup"><span data-stu-id="00092-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="00092-230">Une chaîne de connexion ou le nom de base de données fixe ne fonctionne pas comme ils validation de dérivation par carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="00092-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="00092-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="00092-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="00092-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="00092-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="00092-233">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="00092-234">connexion de Hello sera créée pour hello donné de clé de partitionnement et de mappage de partition avec le modèle hello fournis.</span><span class="sxs-lookup"><span data-stu-id="00092-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="00092-235">modèle compilé de Hello est passée sur c'tor de base toohello.</span><span class="sxs-lookup"><span data-stu-id="00092-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="00092-236">MyContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="00092-237">ElasticScaleContext(ShardMap, TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="00092-238">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="00092-239">connexion de Hello doit toobe déduit à partir de la carte de partitions hello et clé de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="00092-240">Il ne peut pas être fourni en tant qu’entrée (sauf si cette entrée a été déjà à l’aide de carte de partitions hello et clé de hello).</span><span class="sxs-lookup"><span data-stu-id="00092-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="00092-241">valeur booléenne de Hello est passée.</span><span class="sxs-lookup"><span data-stu-id="00092-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="00092-242">MyContext(string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="00092-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="00092-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="00092-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="00092-244">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="00092-245">connexion de Hello doit toobe déduit à partir de la carte de partitions hello et clé de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="00092-246">Il ne peut pas être fourni en tant qu’entrée (sauf si cette entrée a été à l’aide de carte de partitions hello et clé de hello).</span><span class="sxs-lookup"><span data-stu-id="00092-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="00092-247">modèle de compilé Hello est passée.</span><span class="sxs-lookup"><span data-stu-id="00092-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="00092-248">MyContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="00092-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="00092-250">DbContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="00092-251">nouveau constructeur de Hello doit tooensure toute connexion Bonjour Qu'objectcontext passée comme une entrée est tooa repositionnés gérés par élastique.</span><span class="sxs-lookup"><span data-stu-id="00092-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="00092-252">Une présentation détaillée des ObjectContexts est abordée dans ce document hello.</span><span class="sxs-lookup"><span data-stu-id="00092-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="00092-253">MyContext(DbConnection, DbCompiledModel,bool)</span><span class="sxs-lookup"><span data-stu-id="00092-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="00092-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="00092-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="00092-255">DbContext(DbConnection, DbCompiledModel, bool);</span><span class="sxs-lookup"><span data-stu-id="00092-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="00092-256">connexion de Hello doit toobe déduit à partir de la carte de partitions hello et clé de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="00092-257">connexion de Hello ne peut pas être fournie en tant qu’entrée (sauf si cette entrée a été déjà à l’aide de carte de partitions hello et clé de hello).</span><span class="sxs-lookup"><span data-stu-id="00092-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="00092-258">Modèle et booléen sont transmis sur le constructeur de classe de base toohello.</span><span class="sxs-lookup"><span data-stu-id="00092-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="00092-259">Déploiement de schéma de partition via des migrations Entity Framework</span><span class="sxs-lookup"><span data-stu-id="00092-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="00092-260">Gestion des schémas automatique est une commodité fournie par hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="00092-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="00092-261">Dans le contexte de hello d’applications à l’aide des outils de base de données élastique, nous souhaitons tooretain cette partitions toonewly créé de capacité tooautomatically disposition hello schéma lorsque des bases de données sont ajoutés les application partitionnée toohello.</span><span class="sxs-lookup"><span data-stu-id="00092-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="00092-262">Hello est principalement utilisé capacité tooincrease au niveau de données hello pour les applications partitionnées utilisant EF.</span><span class="sxs-lookup"><span data-stu-id="00092-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="00092-263">S’appuyer sur les fonctionnalités de EF pour la gestion du schéma permet de réduire l’effort d’administration de base de données hello avec une application partitionnée créée sur EF.</span><span class="sxs-lookup"><span data-stu-id="00092-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="00092-264">Le déploiement de schéma via des migrations EF fonctionne mieux sur des **connexions non ouvertes**.</span><span class="sxs-lookup"><span data-stu-id="00092-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="00092-265">Il s’agit en revanche toohello scénario de routage dépendant des données qui s’appuie sur connexion hello ouvert fournie par l’API du client de base de données élastique hello.</span><span class="sxs-lookup"><span data-stu-id="00092-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="00092-266">Une autre différence est la spécification de cohérence hello : lors de la cohérence tooensure souhaitable pour toutes les données dépendant de routage connexions tooprotect par rapport à la manipulation de carte de partitions simultanées, il n’est pas un problème avec le schéma initial déploiement tooa nouvelle base de données qui a n’a ne pas encore été enregistré dans la carte de partitions hello et n’a ne pas encore été allouée toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="00092-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="00092-267">Par conséquent, nous pouvons reposent sur les connexions de base de données normale pour cette scénarios, comme le routage dépendant des toodata exécutée.</span><span class="sxs-lookup"><span data-stu-id="00092-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="00092-268">Cela conduit tooan approche où déploiement du schéma via les migrations EF est étroitement lié à l’inscription de hello de base de données hello comme une partition dans la carte de partitions de l’application hello.</span><span class="sxs-lookup"><span data-stu-id="00092-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="00092-269">Il s’appuie sur hello suivant des conditions préalables :</span><span class="sxs-lookup"><span data-stu-id="00092-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="00092-270">base de données Hello a déjà été créé.</span><span class="sxs-lookup"><span data-stu-id="00092-270">hello database has already been created.</span></span> 
* <span data-ttu-id="00092-271">base de données Hello est vide - il conserve aucun schéma de l’utilisateur et aucune donnée de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="00092-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="00092-272">base de données Hello ne sont pas encore accessibles via les API du client de base de données élastique hello pour le routage dépendant des données.</span><span class="sxs-lookup"><span data-stu-id="00092-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="00092-273">Avec ces conditions préalables en place, nous pouvons créer une expression régulière non ouvert **SqlConnection** tookick off migrations EF pour le déploiement de schéma.</span><span class="sxs-lookup"><span data-stu-id="00092-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="00092-274">Hello suivant l’exemple de code illustre cette approche.</span><span class="sxs-lookup"><span data-stu-id="00092-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="00092-275">Cet exemple montre la méthode hello **RegisterNewShard** que les registres hello partition dans la carte de partitions hello, déploie le schéma de hello via les migrations EF et stocke un mappage d’une partition toohello clé de partitionnement.</span><span class="sxs-lookup"><span data-stu-id="00092-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="00092-276">Il s’appuie sur un constructeur de hello **DbContext** sous-classe (**ElasticScaleContext** dans l’exemple hello) qui accepte une chaîne de connexion SQL en tant qu’entrée.</span><span class="sxs-lookup"><span data-stu-id="00092-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="00092-277">code Hello de ce constructeur est simple, comme hello suivant montre l’exemple :</span><span class="sxs-lookup"><span data-stu-id="00092-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="00092-278">Un a peut-être utilisé version hello du constructeur hello héritée de la classe de base hello.</span><span class="sxs-lookup"><span data-stu-id="00092-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="00092-279">Mais tooensure de besoins de code hello qui hello initialiseur par défaut pour EF est utilisé lors de la connexion.</span><span class="sxs-lookup"><span data-stu-id="00092-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="00092-280">Par conséquent, hello détournement court dans la méthode statique hello avant l’appel du constructeur de classe de base hello avec la chaîne de connexion hello.</span><span class="sxs-lookup"><span data-stu-id="00092-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="00092-281">Notez que l’inscription de hello de partitions doit s’exécuter dans un tooensure domaine ou le processus d’application différents paramètres initialiseur hello EF pas de conflit entre.</span><span class="sxs-lookup"><span data-stu-id="00092-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="00092-282">Limites</span><span class="sxs-lookup"><span data-stu-id="00092-282">Limitations</span></span>
<span data-ttu-id="00092-283">les approches Hello décrites dans ce document entraînent quelques limitations :</span><span class="sxs-lookup"><span data-stu-id="00092-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="00092-284">Les applications qui utilisent EF **LocalDb** devez d’abord toomigrate tooa régulière de données SQL Server avant d’utiliser la bibliothèque cliente de base de données élastique.</span><span class="sxs-lookup"><span data-stu-id="00092-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="00092-285">La montée en charge d’une application via le partitionnement avec l’infrastructure élastique n’est pas possible avec **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="00092-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="00092-286">Notez que le développement peut toujours utiliser **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="00092-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="00092-287">N’importe quelle application toohello de modifications qui impliquent la modification de schéma de base de données devez toogo via des migrations EF sur toutes les partitions.</span><span class="sxs-lookup"><span data-stu-id="00092-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="00092-288">exemple de code Hello pour ce document ne montre pas comment toodo cela.</span><span class="sxs-lookup"><span data-stu-id="00092-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="00092-289">Envisagez d’utiliser la base de données de mise à jour avec un tooiterate de paramètre ConnectionString sur toutes les partitions ; ou extraction hello T-SQL script pour hello en attente de la migration à l’aide de la mise à jour à la base de données avec hello - option de Script et d’appliquer des partitions de tooyour script hello T-SQL.</span><span class="sxs-lookup"><span data-stu-id="00092-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="00092-290">Étant donné une demande, il est supposé que son traitement de base de données est contenue dans une même partition identifiée par la clé de partitionnement hello fournie par la demande de hello.</span><span class="sxs-lookup"><span data-stu-id="00092-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="00092-291">Cependant, cette hypothèse n'est pas toujours vraie.</span><span class="sxs-lookup"><span data-stu-id="00092-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="00092-292">Par exemple, quand il n’est pas possible de toomake une clé de partitionnement disponible.</span><span class="sxs-lookup"><span data-stu-id="00092-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="00092-293">tooaddress, hello bibliothèque cliente fournit hello **MultiShardQuery** classe qui implémente une abstraction de la connexion pour l’interrogation sur plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="00092-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="00092-294">Apprentissage toouse hello **MultiShardQuery** en combinaison avec EF est abordée dans ce document hello</span><span class="sxs-lookup"><span data-stu-id="00092-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="00092-295">Conclusion</span><span class="sxs-lookup"><span data-stu-id="00092-295">Conclusion</span></span>
<span data-ttu-id="00092-296">Hello les étapes décrites dans ce document, EF permet aux applications la capacité de la bibliothèque cliente hello élastique de base de données pour les données dépendantes de routage par refactorisation des constructeurs de hello **DbContext** sous-classes utilisés Bonjour EF application.</span><span class="sxs-lookup"><span data-stu-id="00092-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="00092-297">Cette limite hello les modifications requises toothose chaque endroit où **DbContext** classes existent déjà.</span><span class="sxs-lookup"><span data-stu-id="00092-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="00092-298">En outre, les applications de EF peuvent continuer toobenefit de déploiement de schéma automatique en combinant les étapes hello qui appellent hello nécessaire EF migrations avec l’inscription du hello de nouvelles partitions et des mappages dans la carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="00092-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
