---
title: "aaaUsing toofix du Gestionnaire de récupération partition mapper des problèmes | Documents Microsoft"
description: "Utilisez hello RecoveryManager toosolve des problèmes de classe avec les cartes de partitions"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="14c60-103">À l’aide des problèmes du mappage de partitions hello RecoveryManager classe toofix</span><span class="sxs-lookup"><span data-stu-id="14c60-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="14c60-104">Hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) classe fournit des applications ADO.Net hello capacité tooeasily détecter et corriger les incohérences entre la carte de partitions globales de hello (GSM) et la carte de partitions local hello (LSM) dans un environnement de base de données partitionnée.</span><span class="sxs-lookup"><span data-stu-id="14c60-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="14c60-105">Hello GSM et LSM suivi hello mappage de chaque base de données dans un environnement partitionné.</span><span class="sxs-lookup"><span data-stu-id="14c60-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="14c60-106">Parfois, un arrêt se produit entre hello GSM et hello LSM.</span><span class="sxs-lookup"><span data-stu-id="14c60-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="14c60-107">Dans ce cas, utilisez hello RecoveryManager classe toodetect et réparer le saut de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="14c60-108">Hello RecoveryManager classe fait partie de hello [bibliothèque cliente de base de données élastique](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mappage de partition][1]

<span data-ttu-id="14c60-110">Vous trouverez les définitions des termes évoqués ici dans la page [Glossaire des outils de base de données élastique](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="14c60-111">toounderstand comment hello **ShardMapManager** les données toomanage utilisé dans une solution partitionnée, consultez [gestion de carte de partitions](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="14c60-112">Pourquoi utiliser le Gestionnaire de récupération hello ?</span><span class="sxs-lookup"><span data-stu-id="14c60-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="14c60-113">Dans un environnement de base de données partitionnée, il existe un seul client par base de données et plusieurs bases de données par serveur.</span><span class="sxs-lookup"><span data-stu-id="14c60-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="14c60-114">Il peut être également de nombreux serveurs dans un environnement de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="14c60-115">Chaque base de données est mappé dans la carte de partitions hello, appels peuvent avoir une base de données et routé toohello correcte du serveur.</span><span class="sxs-lookup"><span data-stu-id="14c60-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="14c60-116">Bases de données sont traitées selon tooa **clé de partitionnement**, et chaque partition est attribuée un **plage de valeurs de clé**.</span><span class="sxs-lookup"><span data-stu-id="14c60-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="14c60-117">Par exemple, une clé de partitionnement peut-être représenter des noms de clients hello de « D » trop « f ».</span><span class="sxs-lookup"><span data-stu-id="14c60-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="14c60-118">Hello mappage de toutes les partitions (c'est-à-dire dans les bases de données) et de leurs plages de mappage sont contenues dans hello **le carte de partitions globales (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="14c60-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="14c60-119">Chaque base de données contient également un mappage de plages hello contenue dans la partition hello appelé hello **le carte de partitions local (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="14c60-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="14c60-120">Lorsqu’une application se connecte à des partitions de tooa, mappage de hello est mis en cache avec l’application hello pour la récupération rapide.</span><span class="sxs-lookup"><span data-stu-id="14c60-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="14c60-121">Hello LSM donnée utilisé toovalidate mis en cache.</span><span class="sxs-lookup"><span data-stu-id="14c60-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="14c60-122">Hello GSM et LSM peuvent devenir désynchronisés pour hello suivant raisons :</span><span class="sxs-lookup"><span data-stu-id="14c60-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="14c60-123">suppression de Hello d’une partition dont l’étendue est considérée comme toono plu être utilisé, ou changement de nom d’une partition.</span><span class="sxs-lookup"><span data-stu-id="14c60-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="14c60-124">La suppression d’une partition  se traduit par un **mappage de partition orphelin**.</span><span class="sxs-lookup"><span data-stu-id="14c60-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="14c60-125">De même, une base de données renommée peut causer un mappage de partition orphelin.</span><span class="sxs-lookup"><span data-stu-id="14c60-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="14c60-126">En fonction de la finalité de hello de modification de hello, les partitions hello peut-être toobe supprimé ou emplacement de partition hello doit toobe mis à jour.</span><span class="sxs-lookup"><span data-stu-id="14c60-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="14c60-127">toorecover une base de données supprimée, consultez [restaurer une base de données supprimée](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="14c60-128">Un événement de géo-basculement se produit.</span><span class="sxs-lookup"><span data-stu-id="14c60-128">A geo-failover event occurs.</span></span> <span data-ttu-id="14c60-129">toocontinue, un doit mettre à jour hello nom du serveur et nom de la base de données du Gestionnaire de carte de partitions dans l’application hello, puis Détails de mappage de mise à jour hello partition pour toutes les partitions dans une carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="14c60-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="14c60-130">S’il existe un basculement géographique, une telle logique de récupération doit être automatisée dans le flux de travail de basculement hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="14c60-131">L’automatisation des actions de récupération offre des possibilités de gestion sans friction pour les bases de données géolocalisées et évite les interventions manuelles.</span><span class="sxs-lookup"><span data-stu-id="14c60-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="14c60-132">toolearn sur toorecover options une base de données en cas de panne du centre de données, consultez [continuité](sql-database-business-continuity.md) et [la récupération d’urgence](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="14c60-133">Une partition ou hello ShardMapManager base de données est restaurée tooan antérieures point précis dans le temps.</span><span class="sxs-lookup"><span data-stu-id="14c60-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="14c60-134">toolearn sur le point de récupération dans le temps à l’aide de sauvegardes, consultez [à l’aide de sauvegardes de récupération](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="14c60-135">Pour plus d’informations sur les outils de la base de données élastique de base de données SQL Azure, géo-réplication et de restauration, voir hello :</span><span class="sxs-lookup"><span data-stu-id="14c60-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="14c60-136">Vue d’ensemble : continuité des activités cloud et récupération d’urgence d’une base de données avec SQL Database</span><span class="sxs-lookup"><span data-stu-id="14c60-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="14c60-137">Prise en main des outils de base de données élastiques</span><span class="sxs-lookup"><span data-stu-id="14c60-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="14c60-138">Gestion de ShardMap</span><span class="sxs-lookup"><span data-stu-id="14c60-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="14c60-139">Récupération RecoveryManager à partir d’un ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="14c60-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="14c60-140">première étape de Hello est toocreate une instance RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="14c60-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="14c60-141">Hello [GetRecoveryManager méthode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) renvoie hello Gestionnaire de récupération pour hello actuel [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span><span class="sxs-lookup"><span data-stu-id="14c60-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="14c60-142">mappent de toutes les incohérences dans les partitions hello tooaddress, vous devez d’abord récupérer hello RecoveryManager pour la carte de partitions particulier de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="14c60-143">Dans cet exemple, hello RecoveryManager hello ShardMapManager est initialisé.</span><span class="sxs-lookup"><span data-stu-id="14c60-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="14c60-144">Hello ShardMapManager contenant un ShardMap est également déjà initialisé.</span><span class="sxs-lookup"><span data-stu-id="14c60-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="14c60-145">Étant donné que ce code de l’application manipule la carte de partitions hello lui-même, hello des informations d’identification utilisées dans la méthode de fabrique hello (Bonjour précédent exemple, smmConnectionString) doivent être des informations d’identification disposant des autorisations de lecture-écriture sur base de données GSM hello référencé par hello chaîne de connexion.</span><span class="sxs-lookup"><span data-stu-id="14c60-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="14c60-146">Ces informations d’identification sont en général différentes de connexions de tooopen d’informations d’identification utilisées pour le routage dépendant des données.</span><span class="sxs-lookup"><span data-stu-id="14c60-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="14c60-147">Pour plus d’informations, consultez [à l’aide des informations d’identification de client de base de données élastique hello](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="14c60-148">Suppression d’une partition à partir de hello ShardMap après la suppression d’une partition</span><span class="sxs-lookup"><span data-stu-id="14c60-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="14c60-149">Hello [DetachShard méthode](https://msdn.microsoft.com/library/azure/dn842083.aspx) détache hello fonction de partition à partir de la carte de partitions hello et supprime les mappages associés à des partitions de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="14c60-150">paramètre d’emplacement Hello est l’emplacement des partitions hello, spécifiquement le nom du serveur et nom de la base de données de partition hello détachée.</span><span class="sxs-lookup"><span data-stu-id="14c60-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="14c60-151">paramètre de shardMapName Hello est le nom de carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="14c60-152">Cela est uniquement requis lorsque plusieurs cartes de partitions sont gérés par hello même gestionnaire de carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="14c60-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="14c60-153">facultatif.</span><span class="sxs-lookup"><span data-stu-id="14c60-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="14c60-154">Utilisez cette technique uniquement si vous êtes certain que la plage hello pour le mappage de hello mis à jour est vide.</span><span class="sxs-lookup"><span data-stu-id="14c60-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="14c60-155">méthodes Hello ci-dessus ne vérifient pas les données de la plage de hello déplacé, il est donc préférable tooinclude vérifie dans votre code.</span><span class="sxs-lookup"><span data-stu-id="14c60-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="14c60-156">Cet exemple supprime les partitions à partir de la carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="14c60-157">carte de partitions Hello reflète l’emplacement des partitions hello Bonjour GSM avant la suppression de hello de partition de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="14c60-158">Étant donné que les partitions hello a été supprimée, il est supposé cela n’est pas intentionnel, et plage de clés de partitionnement hello n’est plus en cours d’utilisation.</span><span class="sxs-lookup"><span data-stu-id="14c60-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="14c60-159">Sinon, vous pouvez exécuter une restauration à un moment donné.</span><span class="sxs-lookup"><span data-stu-id="14c60-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="14c60-160">partition de hello toorecover à partir d’un plus haut dans le temps.</span><span class="sxs-lookup"><span data-stu-id="14c60-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="14c60-161">(Dans ce cas, passez en revue hello suivant des incohérences de partitions section toodetect.) toorecover, consultez [Point de récupération dans le temps](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="14c60-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="14c60-162">Dans la mesure où il est supposé hello de leur suppression n’est pas intentionnelle, hello action de nettoyage d’administration final est partition de toohello toodelete hello entrée dans le Gestionnaire de carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="14c60-163">Cela empêche l’application hello d’écrire par inadvertance des informations tooa plage qui n’est pas attendu.</span><span class="sxs-lookup"><span data-stu-id="14c60-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="14c60-164">différences de mappage toodetect</span><span class="sxs-lookup"><span data-stu-id="14c60-164">toodetect mapping differences</span></span>
<span data-ttu-id="14c60-165">Hello [DetectMappingDifferences méthode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) sélectionne et retourne l’une des cartes de partitions hello (locales ou globales) en tant que source fiable hello et rapproche les mappages sur les deux cartes de partitions (GSM et LSM).</span><span class="sxs-lookup"><span data-stu-id="14c60-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="14c60-166">Hello *emplacement* Spécifie le nom du serveur hello et le nom de la base de données.</span><span class="sxs-lookup"><span data-stu-id="14c60-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="14c60-167">Hello *shardMapName* paramètre est le nom de mappage de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="14c60-168">Cela est uniquement requis si plusieurs cartes de partitions sont gérés par hello même gestionnaire de carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="14c60-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="14c60-169">facultatif.</span><span class="sxs-lookup"><span data-stu-id="14c60-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="14c60-170">différences de mappage tooresolve</span><span class="sxs-lookup"><span data-stu-id="14c60-170">tooresolve mapping differences</span></span>
<span data-ttu-id="14c60-171">Hello [ResolveMappingDifferences méthode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) sélectionne l’une des cartes de partitions hello (locales ou globales) en tant que source de hello de vérité puis harmonise les mappages sur les deux cartes de partitions (GSM et LSM).</span><span class="sxs-lookup"><span data-stu-id="14c60-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="14c60-172">Hello *RecoveryToken* paramètre énumère hello différences dans les mappages hello hello GSM et hello LSM pour les partitions spécifiques hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="14c60-173">Hello [MappingDifferenceResolution énumération](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) est la méthode de hello tooindicate utilisé pour la résolution de différence hello entre les mappages de partition hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="14c60-174">**MappingDifferenceResolution.KeepShardMapping** est recommandé que lorsque hello LSM qui contient les correspondances exactes hello et mappage hello dans les partitions hello doit donc être utilisé.</span><span class="sxs-lookup"><span data-stu-id="14c60-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="14c60-175">C’est généralement hello cas s’il existe un basculement : les partitions hello résident maintenant sur un nouveau serveur.</span><span class="sxs-lookup"><span data-stu-id="14c60-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="14c60-176">Étant donné que les partitions hello doivent tout d’abord être supprimée de hello GSM (à l’aide de la méthode de RecoveryManager.DetachShard hello), un mappage n’existe plus sur hello GSM.</span><span class="sxs-lookup"><span data-stu-id="14c60-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="14c60-177">Hello LSM doit donc être utilisé toore-établir le mappage de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="14c60-178">Attacher un toohello partition ShardMap après la restauration d’une partition</span><span class="sxs-lookup"><span data-stu-id="14c60-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="14c60-179">Hello [AttachShard méthode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attache hello carte de partitions toohello de partition donné.</span><span class="sxs-lookup"><span data-stu-id="14c60-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="14c60-180">Il détecte des incohérences de mappage de partition et met à jour de la partition de hello hello mappages toomatch hello au moment même de restauration de partition hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="14c60-181">Il est supposé que Hello base de données est également renommée tooreflect hello nom d’origine (avant la restauration de partition de hello), étant donné que la restauration de point à temps hello par défaut est la nouvelle base de données tooa ajouté avec un horodateur de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="14c60-182">Hello *emplacement* paramètre est le nom du serveur hello et nom de la base de données de partition hello en cours d’attachement.</span><span class="sxs-lookup"><span data-stu-id="14c60-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="14c60-183">Hello *shardMapName* paramètre est le nom de mappage de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="14c60-184">Cela est uniquement requis lorsque plusieurs cartes de partitions sont gérés par hello même gestionnaire de carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="14c60-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="14c60-185">facultatif.</span><span class="sxs-lookup"><span data-stu-id="14c60-185">Optional.</span></span> 

<span data-ttu-id="14c60-186">Cet exemple ajoute une carte de partitions toohello partition qui a été récemment restaurée à partir d’une heure antérieure de point.</span><span class="sxs-lookup"><span data-stu-id="14c60-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="14c60-187">Étant donné que les partitions de hello (à savoir hello mappage de partitions hello Bonjour LSM) a été restaurée, il est potentiellement incohérent avec une entrée de partition hello Bonjour GSM.</span><span class="sxs-lookup"><span data-stu-id="14c60-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="14c60-188">En dehors de cet exemple de code, les partitions hello a été restaurée et renommé toohello le nom d’origine de la base de données hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="14c60-189">Dans la mesure où il a été restaurée, il est supposé être mappage hello Bonjour LSM mappage de confiance hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="14c60-190">Mise à jour des emplacements de partitions après un basculement géographique (restauration) de partitions de hello</span><span class="sxs-lookup"><span data-stu-id="14c60-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="14c60-191">S’il existe un basculement géographique, base de données secondaire hello est accessibles écrire et devient hello base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="14c60-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="14c60-192">nom du serveur de hello et potentiellement hello base de données (selon votre configuration) de Hello, peut être différent du serveur principal d’origine de hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="14c60-193">Par conséquent hello des entrées de mappage de partitions hello Bonjour GSM et LSM doit être corrigée.</span><span class="sxs-lookup"><span data-stu-id="14c60-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="14c60-194">De même, si hello base de données est restaurée tooa autre nom ou emplacement ou tooan point antérieur dans le temps, cela peut provoquer des incohérences dans les cartes de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="14c60-195">Hello Gestionnaire de carte de partitions gère la distribution hello de base de données de connexions ouvertes toohello correcte.</span><span class="sxs-lookup"><span data-stu-id="14c60-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="14c60-196">Distribution est basée sur des données dans la carte de partitions hello et valeur hello de clé de partitionnement hello cible hello de demande d’applications hello hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="14c60-197">Après un basculement géographique, ces informations doivent être mis à jour avec le nom du serveur précis hello, nom de la base de données et le mappage de partition de base de données récupérée hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="14c60-198">Meilleures pratiques</span><span class="sxs-lookup"><span data-stu-id="14c60-198">Best practices</span></span>
<span data-ttu-id="14c60-199">Basculement géographique et restauration sont des opérations généralement gérées par un administrateur de cloud de l’application hello intentionnellement utilisant une des fonctionnalités de continuité d’activité de bases de données SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="14c60-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="14c60-200">Planification de la continuité des activités commerciales nécessite tooensure de mesures commerciales peuvent continuer sans interruption, des procédures et processus.</span><span class="sxs-lookup"><span data-stu-id="14c60-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="14c60-201">Hello méthodes disponibles comme partie de hello RecoveryManager classe doit être utilisé dans ce hello de tooensure de flux de travail GSM et LSM sont mis à jour en fonction de l’action de récupération hello entreprise.</span><span class="sxs-lookup"><span data-stu-id="14c60-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="14c60-202">Il existe cinq étapes de base tooproperly garantissant hello GSM et LSM reflètent des informations précises hello après un événement de basculement.</span><span class="sxs-lookup"><span data-stu-id="14c60-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="14c60-203">Bonjour tooexecute de code d’application que ces étapes peuvent être intégrées dans les flux de travail et des outils existants.</span><span class="sxs-lookup"><span data-stu-id="14c60-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="14c60-204">Extraire hello RecoveryManager hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="14c60-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="14c60-205">Détachez la partition ancienne de hello à partir de la carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="14c60-206">Attachez hello nouvelle partition toohello carte de partitions, y compris le nouvel emplacement de partition hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="14c60-207">Détecter les incohérences Bonjour le mappage entre les hello GSM et LSM.</span><span class="sxs-lookup"><span data-stu-id="14c60-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="14c60-208">Résoudre les différences entre hello GSM et hello LSM, approbation hello LSM.</span><span class="sxs-lookup"><span data-stu-id="14c60-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="14c60-209">Cet exemple exécute hello comme suit :</span><span class="sxs-lookup"><span data-stu-id="14c60-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="14c60-210">Supprime les partitions de hello carte de partitions qui reflète les emplacements des partitions avant l’événement de basculement hello.</span><span class="sxs-lookup"><span data-stu-id="14c60-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="14c60-211">Joint des partitions toohello carte de partitions réfléchissante hello nouvelle partition emplacements (le paramètre hello « Configuration.SecondaryServer » est le nom du nouveau serveur hello mais hello même nom de base de données).</span><span class="sxs-lookup"><span data-stu-id="14c60-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="14c60-212">Récupère les jetons de récupération hello en détectant les différences de mappage entre hello GSM et hello LSM pour chaque partition.</span><span class="sxs-lookup"><span data-stu-id="14c60-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="14c60-213">Résout les incohérences hello en approbation mappage hello de hello LSM de chaque partition.</span><span class="sxs-lookup"><span data-stu-id="14c60-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

