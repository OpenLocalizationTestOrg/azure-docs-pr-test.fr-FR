---
title: "bases de données SQL Azure partitionnées aaaQuery | Documents Microsoft"
description: "Exécuter des requêtes entre les partitions à l’aide de la bibliothèque cliente de base de données élastique hello."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: a4379c15-f213-4026-ab6f-a450ee9d5758
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/12/2016
ms.author: torsteng
ms.openlocfilehash: a1f0763935a6807b74aa9dec477714e8d117417d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="multi-shard-querying"></a><span data-ttu-id="1cecc-103">Requête sur plusieurs partitions</span><span class="sxs-lookup"><span data-stu-id="1cecc-103">Multi-shard querying</span></span>
## <a name="overview"></a><span data-ttu-id="1cecc-104">Vue d'ensemble</span><span class="sxs-lookup"><span data-stu-id="1cecc-104">Overview</span></span>
<span data-ttu-id="1cecc-105">Avec hello [outils de base de données élastique](sql-database-elastic-scale-introduction.md), vous pouvez créer des solutions de base de données partitionnée.</span><span class="sxs-lookup"><span data-stu-id="1cecc-105">With hello [Elastic Database tools](sql-database-elastic-scale-introduction.md), you can create sharded database solutions.</span></span> <span data-ttu-id="1cecc-106">**Requête sur plusieurs partitions** est utilisée pour des tâches telles que la collecte de données / la création de rapports qui nécessitent l'exécution d'une requête qui s'étend sur plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-106">**Multi-shard querying** is used for tasks such as data collection/reporting that require running a query that stretches across several shards.</span></span> <span data-ttu-id="1cecc-107">(Comparez ceci trop[routage dépendant des données](sql-database-elastic-scale-data-dependent-routing.md), qui effectue tout le travail sur une partition unique.)</span><span class="sxs-lookup"><span data-stu-id="1cecc-107">(Contrast this too[data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md), which performs all work on a single shard.)</span></span> 

1. <span data-ttu-id="1cecc-108">Obtenir un [ **RangeShardMap** ](https://msdn.microsoft.com/library/azure/dn807318.aspx) ou [ **ListShardMap** ](https://msdn.microsoft.com/library/azure/dn807370.aspx) à l’aide de hello [ **TryGetRangeShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [ **TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), ou hello [ **GetShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) (méthode).</span><span class="sxs-lookup"><span data-stu-id="1cecc-108">Get a [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) or [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) using hello [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), or hello [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) method.</span></span> <span data-ttu-id="1cecc-109">Consultez les rubriques [**Construction d’un objet ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) et [**Obtenir un objet RangeShardMap ou ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span><span class="sxs-lookup"><span data-stu-id="1cecc-109">See [**Constructing a ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) and [**Get a RangeShardMap or ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span></span>
2. <span data-ttu-id="1cecc-110">Créez un objet **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-110">Create a **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)** object.</span></span>
3. <span data-ttu-id="1cecc-111">Créez un objet **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-111">Create a **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span></span> 
4. <span data-ttu-id="1cecc-112">Ensemble hello  **[la propriété CommandText](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)**  tooa commande T-SQL.</span><span class="sxs-lookup"><span data-stu-id="1cecc-112">Set hello **[CommandText property](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** tooa T-SQL command.</span></span>
5. <span data-ttu-id="1cecc-113">Exécutez la commande hello en appelant hello  **[méthode ExecuteReader](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-113">Execute hello command by calling hello **[ExecuteReader method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span></span>
6. <span data-ttu-id="1cecc-114">Afficher les résultats de hello à l’aide de hello  **[MultiShardDataReader classe](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-114">View hello results using hello **[MultiShardDataReader class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span></span> 

## <a name="example"></a><span data-ttu-id="1cecc-115">Exemple</span><span class="sxs-lookup"><span data-stu-id="1cecc-115">Example</span></span>
<span data-ttu-id="1cecc-116">Hello de code suivant illustre l’utilisation de hello de recherche à l’aide de partitions multiples une donnée **ShardMap** nommé *myShardMap*.</span><span class="sxs-lookup"><span data-stu-id="1cecc-116">hello following code illustrates hello usage of multi-shard querying using a given **ShardMap** named *myShardMap*.</span></span> 

    using (MultiShardConnection conn = new MultiShardConnection( 
                                        myShardMap.GetShards(), 
                                        myShardConnectionString) 
          ) 
    { 
    using (MultiShardCommand cmd = conn.CreateCommand())
           { 
            cmd.CommandText = "SELECT c1, c2, c3 FROM ShardedTable"; 
            cmd.CommandType = CommandType.Text; 
            cmd.ExecutionOptions = MultiShardExecutionOptions.IncludeShardNameColumn; 
            cmd.ExecutionPolicy = MultiShardExecutionPolicy.PartialResults; 

            using (MultiShardDataReader sdr = cmd.ExecuteReader()) 
                { 
                    while (sdr.Read())
                        { 
                            var c1Field = sdr.GetString(0); 
                            var c2Field = sdr.GetFieldValue<int>(1); 
                            var c3Field = sdr.GetFieldValue<Int64>(2);
                        } 
                 } 
           } 
    } 


<span data-ttu-id="1cecc-117">La principale différence est construction hello de connexions de plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-117">A key difference is hello construction of multi-shard connections.</span></span> <span data-ttu-id="1cecc-118">Où **SqlConnection** opère sur une base de données, hello **MultiShardConnection** prend un ***collection de partitions*** en entrée.</span><span class="sxs-lookup"><span data-stu-id="1cecc-118">Where **SqlConnection** operates on a single database, hello **MultiShardConnection** takes a ***collection of shards*** as its input.</span></span> <span data-ttu-id="1cecc-119">Remplir la collection hello de partitions à partir d’une carte de partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-119">Populate hello collection of shards from a shard map.</span></span> <span data-ttu-id="1cecc-120">Hello requête est ensuite exécutée sur la collection hello de partitions à l’aide de **UNION ALL** sémantique tooassemble un résultat global unique.</span><span class="sxs-lookup"><span data-stu-id="1cecc-120">hello query is then executed on hello collection of shards using **UNION ALL** semantics tooassemble a single overall result.</span></span> <span data-ttu-id="1cecc-121">Éventuellement, nom de hello de partition hello où provient de ligne de hello peuvent être ajoutés toohello de sortie à l’aide de hello **ExecutionOptions** propriété sur la commande.</span><span class="sxs-lookup"><span data-stu-id="1cecc-121">Optionally, hello name of hello shard where hello row originates from can be added toohello output using hello **ExecutionOptions** property on command.</span></span> 

<span data-ttu-id="1cecc-122">Notez les appels hello trop**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-122">Note hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="1cecc-123">Cette méthode récupère toutes les partitions à partir de la carte de partitions hello et fournit un moyen simple de toorun une requête sur toutes les bases de données pertinentes.</span><span class="sxs-lookup"><span data-stu-id="1cecc-123">This method retrieves all shards from hello shard map and provides an easy way toorun a query across all relevant databases.</span></span> <span data-ttu-id="1cecc-124">Hello collection de partitions pour une requête de plusieurs partition peut être affinée davantage en effectuant une LINQ interroger collection hello retournée à partir de l’appel de hello trop**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-124">hello collection of shards for a multi-shard query can be refined further by performing a LINQ query over hello collection returned from hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="1cecc-125">En association avec la stratégie de résultats partiels hello, capacité actuelle de hello lors de l’interrogation de plusieurs partitions a été conçue toowork bien pour des dizaines de toohundreds de partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-125">In combination with hello partial results policy, hello current capability in multi-shard querying has been designed toowork well for tens up toohundreds of shards.</span></span>

<span data-ttu-id="1cecc-126">Une limitation de l’interrogation de plusieurs partitions est actuellement hello manque de validation pour les partitions et les shardlets sont interrogées.</span><span class="sxs-lookup"><span data-stu-id="1cecc-126">A limitation with multi-shard querying is currently hello lack of validation for shards and shardlets that are queried.</span></span> <span data-ttu-id="1cecc-127">Alors que le routage dépendant des données vérifie qu’une partition donnée fait partie de carte de partitions hello au moment de hello d’interrogation, les requêtes de plusieurs partitions n’effectuent pas cette vérification.</span><span class="sxs-lookup"><span data-stu-id="1cecc-127">While data-dependent routing verifies that a given shard is part of hello shard map at hello time of querying, multi-shard queries do not perform this check.</span></span> <span data-ttu-id="1cecc-128">Cela peut entraîner des requêtes toomulti-partition en cours d’exécution sur les bases de données qui ont été supprimées de la carte de partitions hello.</span><span class="sxs-lookup"><span data-stu-id="1cecc-128">This can lead toomulti-shard queries running on databases that have  been removed from hello shard map.</span></span>

## <a name="multi-shard-queries-and-split-merge-operations"></a><span data-ttu-id="1cecc-129">Requêtes sur plusieurs partitions et opérations de fractionnement et de fusion</span><span class="sxs-lookup"><span data-stu-id="1cecc-129">Multi-shard queries and split-merge operations</span></span>
<span data-ttu-id="1cecc-130">Requêtes de plusieurs partitions ne vérifient pas si les shardlets sur la base de données interrogées hello participent à des opérations de fusion et fractionnement en cours.</span><span class="sxs-lookup"><span data-stu-id="1cecc-130">Multi-shard queries do not verify whether shardlets on hello queried database are participating in ongoing split-merge operations.</span></span> <span data-ttu-id="1cecc-131">(Consultez [mise à l’échelle à l’aide d’outil de hello fractionnement de base de données élastique-fusion](sql-database-elastic-scale-overview-split-and-merge.md).) Cela peut entraîner des tooinconsistencies où les lignes à partir de hello même afficher shardlet pour plusieurs bases de données Bonjour même requête de plusieurs partition.</span><span class="sxs-lookup"><span data-stu-id="1cecc-131">(See [Scaling using hello Elastic Database split-merge tool](sql-database-elastic-scale-overview-split-and-merge.md).) This can lead tooinconsistencies where rows from hello same shardlet show for multiple databases in hello same multi-shard query.</span></span> <span data-ttu-id="1cecc-132">Prenez en compte ces limitations et prendre en compte la purge continue fusion et fractionnement opérations et des modifications toohello carte de partitions lors de l’exécution des requêtes de plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-132">Be aware of these limitations and consider draining ongoing split-merge operations and changes toohello shard map while performing multi-shard queries.</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## <a name="see-also"></a><span data-ttu-id="1cecc-133">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="1cecc-133">See also</span></span>
<span data-ttu-id="1cecc-134">Classes et méthodes **[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="1cecc-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)** classes and methods.</span></span>

<span data-ttu-id="1cecc-135">Gérer des partitions à l’aide de hello [bibliothèque cliente de base de données élastique](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="1cecc-135">Manage shards using hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="1cecc-136">Inclut un espace de noms appelé [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) qui fournit hello capacité tooquery plusieurs partitions à l’aide d’une requête unique et le résultat.</span><span class="sxs-lookup"><span data-stu-id="1cecc-136">Includes a  namespace called [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) that provides hello ability tooquery multiple shards using a single query and result.</span></span> <span data-ttu-id="1cecc-137">Elle fournit une abstraction de requête sur une collection de partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-137">It provides a querying abstraction over a collection of shards.</span></span> <span data-ttu-id="1cecc-138">Il fournit également des stratégies d’exécution alternatifs, les résultats partiels notamment, toodeal avec des erreurs lors de l’interrogation sur plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="1cecc-138">It also provides alternative execution policies, in particular partial results, toodeal with failures when querying over many shards.</span></span>  

