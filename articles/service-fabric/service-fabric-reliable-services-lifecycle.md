---
title: aaaOverview de hello du cycle de vie des Services fiables de Azure Service Fabric | Documents Microsoft
description: "En savoir plus sur les événements de cycle de vie différent hello dans les services fiables Service Fabric"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="9ca4f-103">Vue d’ensemble du cycle de vie de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="9ca4f-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="9ca4f-104">C# sur Windows</span><span class="sxs-lookup"><span data-stu-id="9ca4f-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="9ca4f-105">Java sur Linux</span><span class="sxs-lookup"><span data-stu-id="9ca4f-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="9ca4f-106">Quand vous réfléchissez à hello de cycles de vie des Services fiables, principes de base hello du cycle de vie hello sont hello plus importante.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="9ca4f-107">En général :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-107">In general:</span></span>

- <span data-ttu-id="9ca4f-108">Lors du démarrage</span><span class="sxs-lookup"><span data-stu-id="9ca4f-108">During Startup</span></span>
  - <span data-ttu-id="9ca4f-109">Les services sont construits</span><span class="sxs-lookup"><span data-stu-id="9ca4f-109">Services are constructed</span></span>
  - <span data-ttu-id="9ca4f-110">Ils ont une tooconstruct opportunité et retournent zéro ou plusieurs écouteurs</span><span class="sxs-lookup"><span data-stu-id="9ca4f-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="9ca4f-111">Tous les écouteurs retournés sont ouverte, ce qui permet la communication avec le service hello</span><span class="sxs-lookup"><span data-stu-id="9ca4f-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="9ca4f-112">RunAsync du Service Hello méthode est appelée, ce qui permet de hello toodo à long terme de service ou travail d’arrière-plan</span><span class="sxs-lookup"><span data-stu-id="9ca4f-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="9ca4f-113">Lors de l’arrêt</span><span class="sxs-lookup"><span data-stu-id="9ca4f-113">During shutdown</span></span>
  - <span data-ttu-id="9ca4f-114">tooRunAsync passé jeton d’annulation Hello est annulée et les écouteurs hello sont fermées.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="9ca4f-115">Une fois cette opération terminée, objet de service hello lui-même est détruite</span><span class="sxs-lookup"><span data-stu-id="9ca4f-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="9ca4f-116">Il n’y a plus d’informations sur hello exact de classement de ces événements.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="9ca4f-117">En particulier, commande hello d’événements peut varier légèrement selon que hello Service fiable est sans état ou avec état.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="9ca4f-118">En outre, pour les services avec état, nous avons toodeal avec le scénario principal swap hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="9ca4f-119">Au cours de cette séquence, rôle hello des principaux est transféré tooanother réplica (ou est restauré) sans arrêt du service hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="9ca4f-120">Enfin, nous avons toothink sur les conditions d’erreur ou d’échec.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="9ca4f-121">Démarrage de service sans état</span><span class="sxs-lookup"><span data-stu-id="9ca4f-121">Stateless service startup</span></span>
<span data-ttu-id="9ca4f-122">Hello de cycle de vie d’un service sans état est assez simple.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="9ca4f-123">Voici l’ordre hello des événements :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="9ca4f-124">Hello Service est construit</span><span class="sxs-lookup"><span data-stu-id="9ca4f-124">hello Service is constructed</span></span>
2. <span data-ttu-id="9ca4f-125">Ensuite, deux choses se produisent en parallèle :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="9ca4f-126">`StatelessService.CreateServiceInstanceListeners()` est appelé et les écouteurs retournés sont ouverts.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="9ca4f-127">`ICommunicationListener.OpenAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="9ca4f-128">Hello du service `StatelessService.RunAsync()` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="9ca4f-129">Le cas échéant, hello du service `StatelessService.OnOpenAsync()` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="9ca4f-130">Il s’agit d’un remplacement rare, mais possible.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="9ca4f-131">Il est important toonote qu’il n’existe aucun classement entre hello appels toocreate et les écouteurs hello ouvert et RunAsync.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="9ca4f-132">les écouteurs Hello peut s’ouvrir avant le démarrage de RunAsync.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="9ca4f-133">De même, RunAsync peut finir appelé avant que les écouteurs de communication hello sont ouverts, ou même ont été construits.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="9ca4f-134">Si aucune synchronisation n’est requise, elle est considérée comme un implémenteur de toohello exercice.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="9ca4f-135">Solutions courantes :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-135">Common solutions:</span></span>

  - <span data-ttu-id="9ca4f-136">Parfois, les écouteurs ne peuvent pas fonctionner avant que d’autres informations ne soient créées ou un travail effectué.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="9ca4f-137">Pour les services sans état qui sont actifs, cela peut se faire dans d’autres emplacements, tels que les suivants :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="9ca4f-138">dans le constructeur du service hello</span><span class="sxs-lookup"><span data-stu-id="9ca4f-138">in hello service's constructor</span></span>
    - <span data-ttu-id="9ca4f-139">au cours de hello `CreateServiceInstanceListeners()` appeler</span><span class="sxs-lookup"><span data-stu-id="9ca4f-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="9ca4f-140">dans le cadre de la construction de hello d’écouteur hello lui-même</span><span class="sxs-lookup"><span data-stu-id="9ca4f-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="9ca4f-141">Parfois hello code dans RunAsync ne veut pas toostart jusqu'à ce que les écouteurs hello sont ouverts.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="9ca4f-142">Dans ce cas, une coordination supplémentaire est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="9ca4f-143">Une solution courante consiste à certains indicateur dans les écouteurs hello indiquant quand elles sont terminées.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="9ca4f-144">Cet indicateur est alors vérifié dans RunAsync avant de poursuivre le travail de tooactual.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="9ca4f-145">Arrêt de service sans état</span><span class="sxs-lookup"><span data-stu-id="9ca4f-145">Stateless service shutdown</span></span>
<span data-ttu-id="9ca4f-146">Lorsque vous arrêtez un service sans état, hello même modèle est suivi, dans le sens inverse :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="9ca4f-147">En parallèle</span><span class="sxs-lookup"><span data-stu-id="9ca4f-147">In parallel</span></span>
    - <span data-ttu-id="9ca4f-148">Tous les écouteurs sont fermés.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-148">Any open listeners are Closed.</span></span> <span data-ttu-id="9ca4f-149">`ICommunicationListener.CloseAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="9ca4f-150">jeton d’annulation Hello passé trop`RunAsync()` est annulée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="9ca4f-151">Du jeton de vérification hello annulation `IsCancellationRequested` propriété retourne la valeur est true et si elle est appelée du jeton hello `ThrowIfCancellationRequested` méthode lève une exception une `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="9ca4f-152">Une fois `CloseAsync()` se termine sur chaque port d’écoute et `RunAsync()` termine également du service hello `StatelessService.OnCloseAsync()` méthode est appelée, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="9ca4f-153">Il est rare toooverride `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="9ca4f-154">Après avoir `StatelessService.OnCloseAsync()` terminée, objet de service hello est détruite.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="9ca4f-155">Démarrage de service avec état</span><span class="sxs-lookup"><span data-stu-id="9ca4f-155">Stateful service Startup</span></span>
<span data-ttu-id="9ca4f-156">Les services avec état ont un modèle toostateless des services similaires, avec quelques modifications.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="9ca4f-157">Lors du démarrage d’un service avec état, hello ordre des événements est comme suit :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="9ca4f-158">Hello Service est construit</span><span class="sxs-lookup"><span data-stu-id="9ca4f-158">hello Service is constructed</span></span>
2. <span data-ttu-id="9ca4f-159">`StatefulServiceBase.OnOpenAsync()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="9ca4f-160">Il est substitué uncommonly dans le service hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="9ca4f-161">Hello événements suivants se produisent en parallèle</span><span class="sxs-lookup"><span data-stu-id="9ca4f-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="9ca4f-162">`StatefulServiceBase.CreateServiceReplicaListeners()` est appelé.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="9ca4f-163">Si le service de hello est un serveur principal, tous les écouteurs retournés sont ouverts.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="9ca4f-164">`ICommunicationListener.OpenAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="9ca4f-165">Si le service de hello est une base de données secondaire, que ces écouteurs marqué comme `ListenOnSecondary = true` sont ouverts.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="9ca4f-166">Il est plus rare d’avoir des écouteurs ouverts dans les réplicas secondaires.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="9ca4f-167">Hello si hello Service est actuellement un service principal, hello `StatefulServiceBase.RunAsync()` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="9ca4f-168">Une fois que tous les hello de l’écouteur du réplica `OpenAsync()` appelle et `RunAsync()` est appelée, `StatefulServiceBase.OnChangeRoleAsync()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="9ca4f-169">Il est substitué uncommonly dans le service hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="9ca4f-170">De même toostateless services, il n’existe aucune coordination entre la commande hello dans le hello écouteurs sont créés et ouvert et lorsque RunAsync est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="9ca4f-171">Si vous avez besoin de coordination, les solutions de hello sont bien hello même.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="9ca4f-172">Il existe un cas supplémentaire : dire que les appels de hello arrivent sur les écouteurs de communication hello nécessitent informations conservées à l’intérieur de certains [fiable Collections](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="9ca4f-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="9ca4f-173">Étant donné que les écouteurs de communication hello pu ouvrir avant que les collections fiable hello sont accessibles en lecture ou en écriture, et avant RunAsync a pu démarrer, certains coordination supplémentaire est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="9ca4f-174">solution la plus simple et le plus courante de Hello concerne hello communication écouteurs tooreturn qui hello client utilise tooknow tooretry hello demande un code d’erreur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="9ca4f-175">Arrêt de service avec état</span><span class="sxs-lookup"><span data-stu-id="9ca4f-175">Stateful service Shutdown</span></span>
<span data-ttu-id="9ca4f-176">De même tooStateless services, événements de cycle de vie hello lors de l’arrêt sont hello même pendant le démarrage, mais inversée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="9ca4f-177">Lorsqu’un service avec état est en cours d’arrêt, hello événements suivants se produisent :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="9ca4f-178">En parallèle</span><span class="sxs-lookup"><span data-stu-id="9ca4f-178">In parallel</span></span>
    - <span data-ttu-id="9ca4f-179">Tous les écouteurs sont fermés.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-179">Any open listeners are Closed.</span></span> <span data-ttu-id="9ca4f-180">`ICommunicationListener.CloseAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="9ca4f-181">jeton d’annulation Hello passé trop`RunAsync()` est annulée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="9ca4f-182">Du jeton de vérification hello annulation `IsCancellationRequested` propriété retourne la valeur est true et si elle est appelée du jeton hello `ThrowIfCancellationRequested` méthode lève une exception une `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="9ca4f-183">Une fois `CloseAsync()` se termine sur chaque port d’écoute et `RunAsync()` termine également du service hello `StatefulServiceBase.OnChangeRoleAsync()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="9ca4f-184">(Cela est uncommonly substituée dans le service hello.)</span><span class="sxs-lookup"><span data-stu-id="9ca4f-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="9ca4f-185">En attente de RunAsync toocomplete est nécessaire uniquement si ce réplica de service a été principal.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="9ca4f-186">Une fois hello `StatefulServiceBase.OnChangeRoleAsync()` méthode se termine, hello `StatefulServiceBase.OnCloseAsync()` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="9ca4f-187">Il s’agit d’un remplacement rare, mais possible.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="9ca4f-188">Après avoir `StatefulServiceBase.OnCloseAsync()` terminée, objet de service hello est détruite.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="9ca4f-189">Échanges de réplica principal de service avec état</span><span class="sxs-lookup"><span data-stu-id="9ca4f-189">Stateful service primary swaps</span></span>
<span data-ttu-id="9ca4f-190">Pendant l’exécution d’un service avec état, hello réplicas principaux du que les services avec état suffit leurs écouteurs de communication ouverts et leur méthode RunAsync appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="9ca4f-191">Les réplicas secondaires sont construits mais ne reçoivent aucun autre appel.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="9ca4f-192">Pendant l’exécution toutefois un service avec état, quel réplica est actuellement hello principal peut modifier.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="9ca4f-193">Que cela signifie en termes d’événements de cycle de vie hello capable de détecter un réplica ? Hello comportement hello réplica avec état consulte dépend s’il s’agit de réplica de hello est rétrogradé ou promue au cours de l’échange de hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="9ca4f-194">Pourquoi principal qui est rétrogradé.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-194">For hello primary being demoted</span></span>
<span data-ttu-id="9ca4f-195">Service Fabric a besoin de cette toostop réplica le traitement des messages et quittez n’importe quel travail d’arrière-plan qu'il fait.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="9ca4f-196">Par conséquent, ce service de hello étape apparemment similaires toowhen est en cours d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="9ca4f-197">Une différence est que hello Service n’est pas détruite ou fermé, car il demeure sous la forme d’une base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="9ca4f-198">Hello suivant API est appelée :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="9ca4f-199">En parallèle</span><span class="sxs-lookup"><span data-stu-id="9ca4f-199">In parallel</span></span>
    - <span data-ttu-id="9ca4f-200">Tous les écouteurs sont fermés.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-200">Any open listeners are Closed.</span></span> <span data-ttu-id="9ca4f-201">`ICommunicationListener.CloseAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="9ca4f-202">jeton d’annulation Hello passé trop`RunAsync()` est annulée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="9ca4f-203">Du jeton de vérification hello annulation `IsCancellationRequested` propriété retourne la valeur est true et si elle est appelée du jeton hello `ThrowIfCancellationRequested` méthode lève une exception une `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="9ca4f-204">Une fois `CloseAsync()` se termine sur chaque port d’écoute et `RunAsync()` termine également du service hello `StatefulServiceBase.OnChangeRoleAsync()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="9ca4f-205">Il est substitué uncommonly dans le service hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="9ca4f-206">Pourquoi secondaire en cours de promotion</span><span class="sxs-lookup"><span data-stu-id="9ca4f-206">For hello secondary being promoted</span></span>
<span data-ttu-id="9ca4f-207">De même, le Service Fabric a besoin de cette toostart de réplica à l’écoute des messages sur le câble de hello et démarrer toutes les tâches en arrière-plan qu'il reconnaît les.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="9ca4f-208">Par conséquent, cette recherche de processus similaires service de hello toowhen est créé, à l’exception de ce réplica hello lui-même existe déjà.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="9ca4f-209">Hello suivant API est appelée :</span><span class="sxs-lookup"><span data-stu-id="9ca4f-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="9ca4f-210">En parallèle</span><span class="sxs-lookup"><span data-stu-id="9ca4f-210">In parallel</span></span>
    - <span data-ttu-id="9ca4f-211">`StatefulServiceBase.CreateServiceReplicaListeners()` est appelé et les écouteurs retournés sont ouverts.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="9ca4f-212">`ICommunicationListener.OpenAsync()` est appelé sur chaque écouteur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="9ca4f-213">Hello du service `StatefulServiceBase.RunAsync()` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="9ca4f-214">Une fois que tous les hello de l’écouteur du réplica `OpenAsync()` appelle et `RunAsync()` a été appelée, `StatefulServiceBase.OnChangeRoleAsync()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="9ca4f-215">Il est substitué uncommonly dans le service hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="9ca4f-216">Problèmes courants se produisant pendant l’arrêt d’un service avec état et la rétrogradation du réplica principal</span><span class="sxs-lookup"><span data-stu-id="9ca4f-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="9ca4f-217">Modifications de service Fabric hello principal d’un service avec état pour diverses raisons.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="9ca4f-218">Hello plus courantes sont [cluster rééquilibrage](service-fabric-cluster-resource-manager-balancing.md) et [mise à niveau de l’application](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="9ca4f-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="9ca4f-219">Pendant ces opérations (ainsi que lors de l’arrêt normal du service, que vous verriez si le service de hello a été supprimé), il est important que hello égard du service hello `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="9ca4f-220">Les services qui ne gèrent pas l’annulation « proprement » seront confrontés à plusieurs problèmes.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="9ca4f-221">En particulier, ces opérations sera lentes, car le Service Fabric attend hello services toostop en douceur.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="9ca4f-222">Cela peut entraîner des mises à niveau toofailed ce délai d’attente finalement et l’annulation.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="9ca4f-223">Jeton d’annulation échec toohonor hello peut également provoquer des clusters déséquilibrés, car les nœuds obtenir à chaud, mais les services hello ne peut pas être rééquilibrées, car il prend trop de temps toomove les ailleurs.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="9ca4f-224">Étant donné que les services de hello sont avec état, il est également probable qu’ils utilisent hello [fiable Collections](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="9ca4f-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="9ca4f-225">Dans l’infrastructure de Service, lorsqu’un serveur principal est rétrogradé, une des choses de première hello qui se produit est que l’état de l’accès en écriture toohello sous-jacent est révoqué.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="9ca4f-226">Cela conduit tooa deuxième ensemble de problèmes qui peuvent avoir un impact sur le cycle de vie hello service.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="9ca4f-227">collections Hello retournées Exceptions basées sur le minutage de hello et indique si les réplicas hello est déplacé ou l’arrêt.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="9ca4f-228">Ces exceptions doivent être gérées correctement.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="9ca4f-229">Les exceptions levées par Service Fabric sont soit permanentes [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet), soit passagères [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet).</span><span class="sxs-lookup"><span data-stu-id="9ca4f-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="9ca4f-230">Exceptions permanentes doivent être connectées et levées, alors que les exceptions transitoires hello peuvent être retentées selon une logique de nouvelle tentative.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="9ca4f-231">La gestion des exceptions hello provenant de l’utilisation de hello `ReliableCollections` conjointement avec les événements du cycle de vie du service est une partie importante de test et la validation d’un Service fiable.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="9ca4f-232">Hello recommandation n’est toujours toorun le service sous charge lors de l’exécution des mises à niveau et [chaos test](service-fabric-controlled-chaos.md) avant de déployer des tooproduction jamais.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="9ca4f-233">Ces étapes de base vous permettent de vérifier que votre service est correctement implémenté et qu’il gère correctement les événements de cycle de vie.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="9ca4f-234">Remarques sur le cycle de vie du service</span><span class="sxs-lookup"><span data-stu-id="9ca4f-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="9ca4f-235">Les deux hello `RunAsync()` méthode et hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` appels sont facultatifs.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="9ca4f-236">Un service peut avoir l’un des deux, les deux ou aucun.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="9ca4f-237">Par exemple, si le service de hello ne tout le travail dans les appels de toouser de réponse, il est inutile pour qu’il tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="9ca4f-238">Que les écouteurs de communication hello et son code associé sont nécessaires.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="9ca4f-239">De même, créer et de retourner des écouteurs de communication sont facultative, comme hello service devra peut-être uniquement en arrière-plan toodo de travail et seulement doit tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="9ca4f-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="9ca4f-240">Il n’est valide pour un service toocomplete `RunAsync()` avec succès et le retour à partir de celui-ci.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="9ca4f-241">Le fait qu’il se termine ne correspond pas à une condition d’échec.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-241">Completing is not a failure condition.</span></span> <span data-ttu-id="9ca4f-242">Fin de `RunAsync()` indique que le travail d’arrière-plan hello du service de hello est terminée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="9ca4f-243">Pour les services fiables avec état, `RunAsync()` est rappelée si les réplicas hello ont été rétrogradé de tooSecondary principal et ensuite promu tooPrimary précédent.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="9ca4f-244">Si un service quitte `RunAsync()` en levant une exception inattendue, il s’agit d’un échec.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="9ca4f-245">objet de service Hello est arrêté et une erreur d’intégrité est signalée.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="9ca4f-246">Il n’existe aucune limite de temps au retour de ces méthodes, vous immédiatement perdez hello capacité toowrite tooReliable Collections et par conséquent ne peut pas se terminer tout travail réel.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="9ca4f-247">Il est recommandé de retourner aussi rapidement que possible lors de la réception de demande d’annulation hello.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="9ca4f-248">Si votre service ne répond pas les appels d’API de toothese dans un délai raisonnable que service Fabric peut forcer mettre fin à votre service.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="9ca4f-249">En général, cela se produit uniquement lors de mises à niveau d’application ou lorsqu’un service est en cours de suppression.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="9ca4f-250">Par défaut, ce délai d’attente est de 15 minutes.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="9ca4f-251">Échecs Bonjour `OnCloseAsync()` résultat du chemin d’accès dans `OnAbort()` appelée qui est une opportunité de meilleur effort dernière chance pour hello service tooclean des et libérer toutes les ressources qu’ils ont demandé.</span><span class="sxs-lookup"><span data-stu-id="9ca4f-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9ca4f-252">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="9ca4f-252">Next steps</span></span>
- [<span data-ttu-id="9ca4f-253">Introduction tooReliable Services</span><span class="sxs-lookup"><span data-stu-id="9ca4f-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="9ca4f-254">Démarrage rapide de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="9ca4f-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="9ca4f-255">Utilisation avancée de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="9ca4f-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
