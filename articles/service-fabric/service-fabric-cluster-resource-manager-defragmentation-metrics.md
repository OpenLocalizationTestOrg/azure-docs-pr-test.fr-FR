---
title: "Défragmentation des métriques dans Azure Service Fabric | Microsoft Docs"
description: "Une présentation de l’utilisation de la défragmentation ou de la compression en tant que stratégie pour les métriques dans Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: e5ebfae5-c8f7-4d6c-9173-3e22a9730552
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: b253cc07066092aa82d218c9c82c8aac502245a8
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="defragmentation-of-metrics-and-load-in-service-fabric"></a><span data-ttu-id="6bc3f-103">Défragmentation des mesures et de la charge dans Service Fabric</span><span class="sxs-lookup"><span data-stu-id="6bc3f-103">Defragmentation of metrics and load in Service Fabric</span></span>
<span data-ttu-id="6bc3f-104">La stratégie par défaut de Service Fabric Cluster Resource Manager pour la gestion des mesures de charge dans le cluster consiste à répartir la charge.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-104">The Service Fabric Cluster Resource Manager's default strategy for managing load metrics in the cluster is to distribute the load.</span></span> <span data-ttu-id="6bc3f-105">S’assurer que les nœuds sont utilisés de façon uniforme évite les points chauds et les points froids qui entraînent des problèmes de contention et gaspillage des ressources.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-105">Ensuring that nodes are evenly utilized avoids hot and cold spots that lead to both contention and wasted resources.</span></span> <span data-ttu-id="6bc3f-106">La distribution des charges de travail dans le cluster est également la configuration la plus sûre afin de surmonter les défaillances, car elle permet de s’assurer qu’une défaillance n’affecte pas un trop grand pourcentage d’une charge de travail donnée.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-106">Distributing workloads in the cluster is also the safest in terms of surviving failures since it ensures that a failure doesn’t take out a large percentage of a given workload.</span></span> 

<span data-ttu-id="6bc3f-107">Service Fabric Cluster Resource Manager prend en charge une stratégie différente pour gérer la charge : la défragmentation.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-107">The Service Fabric Cluster Resource Manager does support a different strategy for managing load, which is defragmentation.</span></span> <span data-ttu-id="6bc3f-108">La défragmentation signifie qu’au lieu d’essayer de répartir l’utilisation d’une mesure dans le cluster, nous la consolidons.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-108">Defragmentation means that instead of trying to distribute the utilization of a metric across the cluster, it is consolidated.</span></span> <span data-ttu-id="6bc3f-109">La consolidation n’est qu’une inversion de la stratégie d’équilibrage par défaut. Au lieu de réduire l’écart type moyen de la charge de mesure, Cluster Resource Manager tente de l’augmenter.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-109">Consolidation is just an inversion of the default balancing strategy – instead of minimizing the average standard deviation of metric load, the Cluster Resource Manager tries to increase it.</span></span>

## <a name="when-to-use-defragmentation"></a><span data-ttu-id="6bc3f-110">Quand utiliser la défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-110">When to use defragmentation</span></span>
<span data-ttu-id="6bc3f-111">La distribution de la charge dans le cluster consomme des ressources sur chaque nœud.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-111">Distributing load in the cluster consumes some of the resources on each node.</span></span> <span data-ttu-id="6bc3f-112">Certaines charges de travail créent des services qui sont particulièrement volumineux et qui consomment la plus grande partie voire la totalité d’un nœud.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-112">Some workloads create services that are exceptionally large and consume most or all of a node.</span></span> <span data-ttu-id="6bc3f-113">Dans ces cas, lorsque des charges de travail importantes sont créées, l’espace disponible sur un nœud peut s’avérer insuffisant pour les exécuter.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-113">In these cases, it's possible that when there are large workloads getting created that there isn't enough space on any node to run them.</span></span> <span data-ttu-id="6bc3f-114">Les charges de travail volumineuses ne posent pas de problème dans Service Fabric. Dans ces cas, Cluster Resource Manager détermine ce dont il a besoin pour réorganiser le cluster afin de faire de la place pour cette charge de travail volumineuse.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-114">Large workloads aren't a problem in Service Fabric; in these cases the Cluster Resource Manager determines that it needs to reorganize the cluster to make room for this large workload.</span></span> <span data-ttu-id="6bc3f-115">Toutefois, en attendant, cette charge de travail doit attendre d’être planifiée dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-115">However, in the meantime that workload has to wait to be scheduled in the cluster.</span></span>

<span data-ttu-id="6bc3f-116">S’il y a de nombreux services et états à déplacer, le déplacement de cette charge de travail dans le cluster peut prendre beaucoup de temps.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-116">If there are many services and state to move around, then it could take a long time for the large workload to be placed in the cluster.</span></span> <span data-ttu-id="6bc3f-117">Cette situation survient davantage si d’autres charges de travail dans le cluster sont volumineuses et que leur réorganisation prend plus de temps.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-117">This is more likely if other workloads in the cluster are also large and so take longer to reorganize.</span></span> <span data-ttu-id="6bc3f-118">L’équipe Service Fabric a mesuré les temps de création dans des simulations de ce scénario.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-118">The Service Fabric team measured creation times in simulations of this scenario.</span></span> <span data-ttu-id="6bc3f-119">Nous avons constaté que la création de services volumineux prend beaucoup plus de temps dès que l’utilisation de clusters se situe entre 30 et 50 %.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-119">We found that creating large services took much longer as soon as cluster utilization got above between 30% and 50%.</span></span> <span data-ttu-id="6bc3f-120">Pour gérer ce scénario, nous avons introduit la défragmentation comme stratégie d’équilibrage.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-120">To handle this scenario, we introduced defragmentation as a balancing strategy.</span></span> <span data-ttu-id="6bc3f-121">Nous avons découvert que pour les charges de travail volumineuses, notamment celles pour lesquelles le temps de création était important, la défragmentation aide réellement à la planification de ces nouvelles charges de travail dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-121">We found that for large workloads, especially ones where creation time was important, defragmentation really helped those new workloads get scheduled in the cluster.</span></span>

<span data-ttu-id="6bc3f-122">Vous pouvez configurer des mesures de défragmentation pour que Cluster Resource Manager essaie de manière proactive de condenser la charge des services sur un nombre de nœuds plus réduit.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-122">You can configure defragmentation metrics to have the Cluster Resource Manager to proactively try to condense the load of the services into fewer nodes.</span></span> <span data-ttu-id="6bc3f-123">Cela permet de garantir qu’il y a presque toujours de la place pour les services volumineux, sans avoir à réorganiser le cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-123">This helps ensure that there is almost always room for large services without reorganizing the cluster.</span></span> <span data-ttu-id="6bc3f-124">Ne pas avoir à réorganiser le cluster permet de créer rapidement de grandes charges de travail.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-124">Not having to reorganize the cluster allows creating large workloads quickly.</span></span>

<span data-ttu-id="6bc3f-125">La plupart des utilisateurs n’ont pas besoin de la défragmentation.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-125">Most people don’t need defragmentation.</span></span> <span data-ttu-id="6bc3f-126">Les services sont en règle générale de petite taille et par conséquent, il n’est pas difficile de leur trouver de la place dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-126">Services are usually be small, so it’s not hard to find room for them in the cluster.</span></span> <span data-ttu-id="6bc3f-127">Lorsqu’une réorganisation est possible, elle se déroule rapidement car la plupart des services sont petits et peuvent être déplacés rapidement et en parallèle.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-127">When reorganization is possible, it goes quickly, again because most services are small and can be moved quickly and in parallel.</span></span> <span data-ttu-id="6bc3f-128">Mais si vos services sont volumineux et qu’ils doivent être créés rapidement, la stratégie de défragmentation est faite pour vous.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-128">However, if you have large services and need them created quickly then the defragmentation strategy is for you.</span></span> <span data-ttu-id="6bc3f-129">Examinons maintenant les compromis qu’implique l’utilisation de la défragmentation.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-129">We'll discuss the tradeoffs of using defragmentation next.</span></span> 

## <a name="defragmentation-tradeoffs"></a><span data-ttu-id="6bc3f-130">Compromis concernant la défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-130">Defragmentation tradeoffs</span></span>
<span data-ttu-id="6bc3f-131">La défragmentation peut augmenter la probabilité que les défaillances aient un impact car plus de services sont exécutés sur des nœuds défaillants.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-131">Defragmentation can increase impactfulness of failures, since more services are running on nodes that fail.</span></span> <span data-ttu-id="6bc3f-132">La défragmentation peut également augmenter les coûts, étant donné que les ressources du cluster doivent être gardées en réserve, en attendant la création de charges de travail volumineuses.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-132">Defragmentation can also increase costs, since resources in the cluster must be held in reserve, waiting for the creation of large workloads.</span></span>

<span data-ttu-id="6bc3f-133">Le diagramme suivant offre une représentation visuelle de deux clusters, l’un défragmenté et l’autre non.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-133">The following diagram gives a visual representation of two clusters, one that is defragmented and one that is not.</span></span> 

<span data-ttu-id="6bc3f-134"><center>
![Comparaison de clusters équilibré et défragmenté][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="6bc3f-134"><center>
![Comparing Balanced and Defragmented Clusters][Image1]
</center></span></span>

<span data-ttu-id="6bc3f-135">Dans le cas équilibré, tenez compte du nombre de mouvements qui seraient nécessaires pour placer un des plus grands objets de service.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-135">In the balanced case, consider the number of movements that would be necessary to place one of the largest service objects.</span></span> <span data-ttu-id="6bc3f-136">Dans le cluster défragmenté, la charge de travail volumineuse peut être placée sur les nœuds 4 ou 5 sans avoir à attendre le déplacement d’autres services.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-136">In the defragmented cluster, the large workload could be placed on nodes four or five without having to wait for any other services to move.</span></span>

## <a name="defragmentation-pros-and-cons"></a><span data-ttu-id="6bc3f-137">Avantages et inconvénients de la défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-137">Defragmentation pros and cons</span></span>
<span data-ttu-id="6bc3f-138">Quelles sont donc ces autres compromis ?</span><span class="sxs-lookup"><span data-stu-id="6bc3f-138">So what are those other conceptual tradeoffs?</span></span> <span data-ttu-id="6bc3f-139">Voici un tableau succinct des éléments à considérer :</span><span class="sxs-lookup"><span data-stu-id="6bc3f-139">Here’s a quick table of things to think about:</span></span>

| <span data-ttu-id="6bc3f-140">Avantages de la défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-140">Defragmentation Pros</span></span> | <span data-ttu-id="6bc3f-141">Inconvénients de la défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-141">Defragmentation Cons</span></span> |
| --- | --- |
| <span data-ttu-id="6bc3f-142">Permet la création plus rapide de services de grande taille</span><span class="sxs-lookup"><span data-stu-id="6bc3f-142">Allows faster creation of large services</span></span> |<span data-ttu-id="6bc3f-143">Concentre la charge dans un plus petit nombre de nœuds, ce qui augmente la contention</span><span class="sxs-lookup"><span data-stu-id="6bc3f-143">Concentrates load onto fewer nodes, increasing contention</span></span> |
| <span data-ttu-id="6bc3f-144">Permet de diminuer le déplacement des données lors de la création</span><span class="sxs-lookup"><span data-stu-id="6bc3f-144">Enables lower data movement during creation</span></span> |<span data-ttu-id="6bc3f-145">Les défaillances peuvent avoir un impact sur d’autres services et provoquer une plus grande désinscription</span><span class="sxs-lookup"><span data-stu-id="6bc3f-145">Failures can impact more services and cause more churn</span></span> |
| <span data-ttu-id="6bc3f-146">Permet de décrire en détail les exigences et la récupération d’espace</span><span class="sxs-lookup"><span data-stu-id="6bc3f-146">Allows rich description of requirements and reclamation of space</span></span> |<span data-ttu-id="6bc3f-147">Configuration générale plus complexe de la gestion des ressources</span><span class="sxs-lookup"><span data-stu-id="6bc3f-147">More complex overall Resource Management configuration</span></span> |

<span data-ttu-id="6bc3f-148">Vous pouvez combiner des mesures défragmentés et normales dans le même cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-148">You can mix defragmented and normal metrics in the same cluster.</span></span> <span data-ttu-id="6bc3f-149">Cluster Resource Manager tente de consolider autant que possible les mesures de défragmentation tout en répartissant les autres.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-149">The Cluster Resource Manager tries to consolidate the defragmentation metrics as much as possible while spreading out the others.</span></span> <span data-ttu-id="6bc3f-150">Les résultats obtenus en combinant des stratégies de défragmentation et d’équilibrage dépendent de plusieurs facteurs, notamment :</span><span class="sxs-lookup"><span data-stu-id="6bc3f-150">The results of mixing defragmentation and balancing strategies depends on several factors, including:</span></span>
  - <span data-ttu-id="6bc3f-151">le nombre de mesures d’équilibrage par rapport au nombre de mesures de défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-151">the number of balancing metrics vs. the number of defragmentation metrics</span></span>
  - <span data-ttu-id="6bc3f-152">si un service utilise ces deux types de mesures</span><span class="sxs-lookup"><span data-stu-id="6bc3f-152">Whether any service uses both types of metrics</span></span> 
  - <span data-ttu-id="6bc3f-153">les poids des mesures</span><span class="sxs-lookup"><span data-stu-id="6bc3f-153">the metric weights</span></span>
  - <span data-ttu-id="6bc3f-154">les charges actuelles des mesures</span><span class="sxs-lookup"><span data-stu-id="6bc3f-154">current metric loads</span></span>
  
<span data-ttu-id="6bc3f-155">L’expérimentation est nécessaire pour déterminer la configuration exacte nécessaire.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-155">Experimentation is required to determine the exact configuration necessary.</span></span> <span data-ttu-id="6bc3f-156">Nous vous recommandons d’effectuer une mesure minutieuse de vos charges de travail avant d’activer les mesures de défragmentation en production.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-156">We recommend thorough measurement of your workloads before you enable defragmentation metrics in production.</span></span> <span data-ttu-id="6bc3f-157">Cela est particulièrement vrai lorsque vous combinez des mesures de défragmentation et d’équilibrage dans le même service.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-157">This is especially true when mixing defragmentation and balanced metrics within the same service.</span></span> 

## <a name="configuring-defragmentation-metrics"></a><span data-ttu-id="6bc3f-158">Configuration de mesures de défragmentation</span><span class="sxs-lookup"><span data-stu-id="6bc3f-158">Configuring defragmentation metrics</span></span>
<span data-ttu-id="6bc3f-159">La configuration des mesures de défragmentation est une décision globale au niveau du cluster et des mesures individuelles peuvent être sélectionnées pour la défragmentation.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-159">Configuring defragmentation metrics is a global decision in the cluster, and individual metrics can be selected for defragmentation.</span></span> <span data-ttu-id="6bc3f-160">Les extraits de configuration suivants montrent comment configurer des mesures pour la défragmentation.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-160">The following config snippets show how to configure metrics for defragmentation.</span></span> <span data-ttu-id="6bc3f-161">Dans ce cas, « Metric1 » est configuré comme une mesure de défragmentation, tandis que « Metric2 » continuera d’être équilibrée normalement.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-161">In this case, "Metric1" is configured as a defragmentation metric, while "Metric2" will continue to be balanced normally.</span></span> 

<span data-ttu-id="6bc3f-162">ClusterManifest.xml :</span><span class="sxs-lookup"><span data-stu-id="6bc3f-162">ClusterManifest.xml:</span></span>

```xml
<Section Name="DefragmentationMetrics">
    <Parameter Name="Metric1" Value="true" />
    <Parameter Name="Metric2" Value="false" />
</Section>
```

<span data-ttu-id="6bc3f-163">via ClusterConfig.json pour les déploiements autonomes ou Template.json pour les clusters hébergés sur Azure :</span><span class="sxs-lookup"><span data-stu-id="6bc3f-163">via ClusterConfig.json for Standalone deployments or Template.json for Azure hosted clusters:</span></span>

```json
"fabricSettings": [
  {
    "name": "DefragmentationMetrics",
    "parameters": [
      {
          "name": "Metric1",
          "value": "true"
      },
      {
          "name": "Metric2",
          "value": "false"
      }
    ]
  }
]
```


## <a name="next-steps"></a><span data-ttu-id="6bc3f-164">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="6bc3f-164">Next steps</span></span>
- <span data-ttu-id="6bc3f-165">Cluster Resource Manager comporte de nombreuses options permettant de décrire le cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-165">The Cluster Resource Manager has man options for describing the cluster.</span></span> <span data-ttu-id="6bc3f-166">Pour en savoir plus sur celles-ci, consultez cet article sur la [description d’un cluster Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md)</span><span class="sxs-lookup"><span data-stu-id="6bc3f-166">To find out more about them, check out this article on [describing a Service Fabric cluster](service-fabric-cluster-resource-manager-cluster-description.md)</span></span>
- <span data-ttu-id="6bc3f-167">Les mesures représentent la façon dont Service Fabric Cluster Resource Manager gère la consommation et la capacité du cluster.</span><span class="sxs-lookup"><span data-stu-id="6bc3f-167">Metrics are how the Service Fabric Cluster Resource Manger manages consumption and capacity in the cluster.</span></span> <span data-ttu-id="6bc3f-168">Pour en savoir plus sur ces mesures et la façon de les configurer, consultez [cet article](service-fabric-cluster-resource-manager-metrics.md)</span><span class="sxs-lookup"><span data-stu-id="6bc3f-168">To learn more about metrics and how to configure them, check out [this article](service-fabric-cluster-resource-manager-metrics.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-defragmentation-metrics/balancing-defrag-compared.png
