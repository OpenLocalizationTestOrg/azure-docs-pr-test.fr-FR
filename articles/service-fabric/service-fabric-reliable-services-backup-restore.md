---
title: Sauvegarde et restauration de Service Fabric | Microsoft Docs
description: "Documentation conceptuelle relative à la sauvegarde et à la restauration de Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="2227a-103">Sauvegarder et restaurer Reliable Services et Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="2227a-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="2227a-104">Azure Service Fabric est une plateforme haute disponibilité qui réplique l’état sur plusieurs nœuds afin de conserver cette haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="2227a-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="2227a-105">Ainsi, même si un nœud du cluster échoue, les services continuent à être disponibles.</span><span class="sxs-lookup"><span data-stu-id="2227a-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="2227a-106">Bien que cette redondance intégrée fournie par la plateforme suffise pour certains, dans d’autres cas, il est souhaitable que le service sauvegarde les données (dans un magasin externe).</span><span class="sxs-lookup"><span data-stu-id="2227a-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="2227a-107">Il est essentiel de sauvegarder et restaurer vos données (et de tester qu’elles fonctionnent comme prévu) afin de pouvoir les récupérer en cas de perte.</span><span class="sxs-lookup"><span data-stu-id="2227a-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="2227a-108">Par exemple, un service peut souhaiter sauvegarder des données afin de les protéger contre les scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="2227a-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="2227a-109">Perte définitive de la totalité d’un cluster Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="2227a-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="2227a-110">Perte définitive de la majorité des réplicas d’une partition de service.</span><span class="sxs-lookup"><span data-stu-id="2227a-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="2227a-111">Erreurs d’administration dans le cadre desquelles l’état est accidentellement supprimé ou endommagé.</span><span class="sxs-lookup"><span data-stu-id="2227a-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="2227a-112">Par exemple, cela peut se produire si un administrateur disposant de privilèges suffisants supprime le service par erreur.</span><span class="sxs-lookup"><span data-stu-id="2227a-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="2227a-113">Bogues dans le service qui provoquent l’altération des données.</span><span class="sxs-lookup"><span data-stu-id="2227a-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="2227a-114">Par exemple, cela peut se produire lorsqu’une mise à niveau de code de service écrit des données erronées dans une collection fiable.</span><span class="sxs-lookup"><span data-stu-id="2227a-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="2227a-115">Dans ce cas, le code et les données devront peut-être être restaurés à un état antérieur.</span><span class="sxs-lookup"><span data-stu-id="2227a-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="2227a-116">Traitement des données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="2227a-116">Offline data processing.</span></span> <span data-ttu-id="2227a-117">Il peut être utile de disposer du traitement des données hors connexion pour le décisionnel qui a lieu séparément du service qui génère les données.</span><span class="sxs-lookup"><span data-stu-id="2227a-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="2227a-118">La fonctionnalité Sauvegarder/Restaurer permet aux services reposant sur l’API Reliable Services de créer et de restaurer des sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="2227a-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="2227a-119">Les API de sauvegarde fournies par la plateforme permettent d’effectuer une ou plusieurs sauvegardes de l’état d’une partition de service, sans bloquer les opérations de lecture et d’écriture.</span><span class="sxs-lookup"><span data-stu-id="2227a-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="2227a-120">Les API de restauration permettent la restauration de l’état d’une partition d’être à partir d’une sauvegarde choisie.</span><span class="sxs-lookup"><span data-stu-id="2227a-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="2227a-121">Types de sauvegarde</span><span class="sxs-lookup"><span data-stu-id="2227a-121">Types of Backup</span></span>
<span data-ttu-id="2227a-122">Il existe deux options de sauvegarde : complète et incrémentielle.</span><span class="sxs-lookup"><span data-stu-id="2227a-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="2227a-123">Une sauvegarde complète est une sauvegarde qui contient toutes les données nécessaires pour recréer l’état du réplica, à savoir des points de contrôle et l’ensemble des enregistrements de journal.</span><span class="sxs-lookup"><span data-stu-id="2227a-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="2227a-124">Dans la mesure où une sauvegarde complète regroupe les points de contrôle et les journaux, elle ne peut être restaurée d’elle-même.</span><span class="sxs-lookup"><span data-stu-id="2227a-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="2227a-125">Les sauvegardes complètes posent problème dès lors qu’elles impliquent des points de contrôle volumineux.</span><span class="sxs-lookup"><span data-stu-id="2227a-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="2227a-126">Par exemple, un réplica associé à un état de 16 Go verra ses points de contrôle s’accumuler jusqu’à environ 16 Go.</span><span class="sxs-lookup"><span data-stu-id="2227a-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="2227a-127">Si l’objectif de point de récupération est fixé à cinq minutes, le réplica devra être sauvegardé toutes les cinq minutes.</span><span class="sxs-lookup"><span data-stu-id="2227a-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="2227a-128">Chaque sauvegarde suppose de copier 16 Go de points de contrôle en plus des 50 Mo (configurables avec `CheckpointThresholdInMB`) de journaux.</span><span class="sxs-lookup"><span data-stu-id="2227a-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Exemple de sauvegarde complète.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="2227a-130">La solution à ce problème consiste à recourir à des sauvegardes incrémentielles, qui ne contiennent que les enregistrements modifiés depuis la dernière sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Exemple de sauvegarde incrémentielle.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="2227a-132">Puisque les sauvegardes incrémentielles ne portent que sur les modifications apportées depuis la dernière sauvegarde (sans les points de contrôle), elles sont généralement plus rapides, mais ne peuvent pas être restaurées d’elles-mêmes.</span><span class="sxs-lookup"><span data-stu-id="2227a-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="2227a-133">La restauration d’une sauvegarde incrémentielle implique l’ensemble de la chaîne de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="2227a-134">Une chaîne de sauvegarde est une chaîne de sauvegardes qui commence par une sauvegarde complète, suivie d’un nombre de sauvegardes incrémentielles contigües.</span><span class="sxs-lookup"><span data-stu-id="2227a-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="2227a-135">Sauvegarder Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-135">Backup Reliable Services</span></span>
<span data-ttu-id="2227a-136">Le créateur du service contrôle intégralement le moment auquel les sauvegardes sont effectuées et leur emplacement de stockage.</span><span class="sxs-lookup"><span data-stu-id="2227a-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="2227a-137">Pour démarrer une sauvegarde, le service doit appeler la fonction de membre hérité `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="2227a-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="2227a-138">Les sauvegardes peuvent uniquement être effectuées à partir de réplicas principaux et ont besoin de bénéficier du statut d’écriture.</span><span class="sxs-lookup"><span data-stu-id="2227a-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="2227a-139">Comme indiqué ci-dessous, `BackupAsync` prend un objet `BackupDescription`, dans lequel il est possible de spécifier une sauvegarde complète ou incrémentielle, ainsi qu’une fonction de rappel, `Func<< BackupInfo, CancellationToken, Task<bool>>>`, qui est appelée quand le dossier de sauvegarde a été créé en local et est prêt à être déplacé dans un stockage externe.</span><span class="sxs-lookup"><span data-stu-id="2227a-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="2227a-140">Une demande de sauvegarde incrémentielle peut échouer en déclenchant `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="2227a-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="2227a-141">Cette exception indique que l’on se trouve dans une des situations suivantes :</span><span class="sxs-lookup"><span data-stu-id="2227a-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="2227a-142">le réplica n’a jamais fait l’objet d’une sauvegarde complète depuis qu’il est devenu principal,</span><span class="sxs-lookup"><span data-stu-id="2227a-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="2227a-143">qu’une partie des enregistrements du journal écrits depuis la dernière sauvegarde a été tronquée ou</span><span class="sxs-lookup"><span data-stu-id="2227a-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="2227a-144">le réplica a dépassé la limite `MaxAccumulatedBackupLogSizeInMB`.</span><span class="sxs-lookup"><span data-stu-id="2227a-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="2227a-145">Configurer `MinLogSizeInMB` ou `TruncationThresholdFactor` augmente les chances de parvenir à effectuer des sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="2227a-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="2227a-146">Il est à noter qu’augmenter ces valeurs accroît l’utilisation du disque par réplica.</span><span class="sxs-lookup"><span data-stu-id="2227a-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="2227a-147">Pour plus d’informations, consultez [Configuration de Reliable Services](service-fabric-reliable-services-configuration.md).</span><span class="sxs-lookup"><span data-stu-id="2227a-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="2227a-148">`BackupInfo` fournit des informations sur la sauvegarde, notamment l’emplacement du dossier où le runtime l’a enregistrée (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="2227a-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="2227a-149">La fonction de rappel peut déplacer `BackupInfo.Directory` vers un magasin externe ou un autre emplacement.</span><span class="sxs-lookup"><span data-stu-id="2227a-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="2227a-150">Cette fonction renvoie également une valeur booléenne qui indique si elle a été en mesure de déplacer correctement le dossier de sauvegarde vers son emplacement cible.</span><span class="sxs-lookup"><span data-stu-id="2227a-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="2227a-151">Le code suivant montre comment la méthode `BackupCallbackAsync` peut permettre de charger la sauvegarde vers le Stockage Azure :</span><span class="sxs-lookup"><span data-stu-id="2227a-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="2227a-152">Dans l’exemple précédent, `ExternalBackupStore` est l’exemple de classe qui sert d’interface avec le Stockage Blob Azure, et `UploadBackupFolderAsync` est la méthode qui compresse le dossier et le place dans le magasin d’objets blob Azure.</span><span class="sxs-lookup"><span data-stu-id="2227a-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="2227a-153">Notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="2227a-153">Note that:</span></span>

  - <span data-ttu-id="2227a-154">Il ne peut y avoir qu’une seule opération de sauvegarde en cours par réplica à un moment donné.</span><span class="sxs-lookup"><span data-stu-id="2227a-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="2227a-155">Si plusieurs appels `BackupAsync` sont effectués à la fois, l’exception `FabricBackupInProgressException` est levée pour limiter les sauvegardes en cours à une seule.</span><span class="sxs-lookup"><span data-stu-id="2227a-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="2227a-156">Si un réplica bascule pendant une sauvegarde, celle-ci n’a peut-être pas été effectuée.</span><span class="sxs-lookup"><span data-stu-id="2227a-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="2227a-157">Ainsi, une fois le basculement terminé, il incombe au service de redémarrer la sauvegarde en appelant `BackupAsync` si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="2227a-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="2227a-158">Restaurer Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-158">Restore Reliable Services</span></span>
<span data-ttu-id="2227a-159">En règle générale, vous devrez peut-être effectuer une restauration dans les cas suivants :</span><span class="sxs-lookup"><span data-stu-id="2227a-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="2227a-160">La partition du service a perdu des données.</span><span class="sxs-lookup"><span data-stu-id="2227a-160">The service partition lost data.</span></span> <span data-ttu-id="2227a-161">Par exemple, le disque de deux réplicas sur trois pour une partition (y compris le réplica principal) est endommagé ou effacé.</span><span class="sxs-lookup"><span data-stu-id="2227a-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="2227a-162">Le nouveau réplica principal peut être amené à restaurer des données à partir d’une sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="2227a-163">L’ensemble du service est perdu.</span><span class="sxs-lookup"><span data-stu-id="2227a-163">The entire service is lost.</span></span> <span data-ttu-id="2227a-164">Par exemple, un administrateur supprime l’ensemble du service, et le service et les données doivent donc être restaurés.</span><span class="sxs-lookup"><span data-stu-id="2227a-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="2227a-165">Le service a répliqué des données d’application endommagées (par exemple, en raison d’un bogue dans l’application).</span><span class="sxs-lookup"><span data-stu-id="2227a-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="2227a-166">Dans ce cas, le service doit être mis à niveau ou rétabli pour supprimer la cause de l’endommagement, et les données non endommagées doivent être restaurées.</span><span class="sxs-lookup"><span data-stu-id="2227a-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="2227a-167">Bien que de nombreuses approches soient possibles, nous proposons quelques exemples de récupération à l’aide de `RestoreAsync`dans les scénarios ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="2227a-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="2227a-168">Perte de données de partition dans Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="2227a-169">Dans ce cas, le runtime détecte automatiquement la perte de données et appelle l’API `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="2227a-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="2227a-170">Le créateur du service doit effectuer les opérations suivantes pour assurer la récupération :</span><span class="sxs-lookup"><span data-stu-id="2227a-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="2227a-171">Remplacer la méthode de classe de base virtuelle `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="2227a-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="2227a-172">Rechercher la dernière sauvegarde dans l’emplacement externe qui contient les sauvegardes du service.</span><span class="sxs-lookup"><span data-stu-id="2227a-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="2227a-173">Télécharger la dernière sauvegarde (et la décompresser dans le dossier de sauvegarde le cas échéant).</span><span class="sxs-lookup"><span data-stu-id="2227a-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="2227a-174">La méthode `OnDataLossAsync` fournit un `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="2227a-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="2227a-175">Appeler l’API `RestoreAsync` sur le `RestoreContext` fourni.</span><span class="sxs-lookup"><span data-stu-id="2227a-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="2227a-176">Renvoyer l’état True en cas de succès de la restauration.</span><span class="sxs-lookup"><span data-stu-id="2227a-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="2227a-177">Voici un exemple d’implémentation de la méthode `OnDataLossAsync` :</span><span class="sxs-lookup"><span data-stu-id="2227a-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="2227a-178">La variable `RestoreDescription`, transmise à l’appel `RestoreContext.RestoreAsync`, contient un membre nommé `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="2227a-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="2227a-179">Lorsque vous restaurez une seule sauvegarde complète, ce `BackupFolderPath` doit être défini sur le chemin d’accès local du dossier qui contient votre sauvegarde complète.</span><span class="sxs-lookup"><span data-stu-id="2227a-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="2227a-180">Lorsque vous restaurez une sauvegarde complète ainsi qu’un certain nombre de sauvegardes incrémentielles, `BackupFolderPath` doit être défini sur le chemin d’accès local du dossier qui contient à la fois la sauvegarde complète et l’ensemble des sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="2227a-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="2227a-181">Un appel `RestoreAsync` peut lever `FabricMissingFullBackupException` si le `BackupFolderPath` fourni ne contient pas une sauvegarde complète.</span><span class="sxs-lookup"><span data-stu-id="2227a-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="2227a-182">Il peut également lever `ArgumentException` si `BackupFolderPath` a une chaîne interrompue de sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="2227a-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="2227a-183">Par exemple, s’il contient la sauvegarde complète, les première et troisième sauvegardes incrémentielles, mais pas la deuxième sauvegarde incrémentielle.</span><span class="sxs-lookup"><span data-stu-id="2227a-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="2227a-184">Par défaut, RestorePolicy est défini sur Sécurisé.</span><span class="sxs-lookup"><span data-stu-id="2227a-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="2227a-185">Cela signifie que l’API `RestoreAsync` va échouer avec ArgumentException si elle détecte que le dossier de sauvegarde contient un état antérieur ou égal à l’état contenu dans ce réplica.</span><span class="sxs-lookup"><span data-stu-id="2227a-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="2227a-186">`RestorePolicy.Force` permet d’ignorer cette vérification de sécurité,</span><span class="sxs-lookup"><span data-stu-id="2227a-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="2227a-187">comme le spécifie `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="2227a-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="2227a-188">Service supprimé ou perdu</span><span class="sxs-lookup"><span data-stu-id="2227a-188">Deleted or lost service</span></span>
<span data-ttu-id="2227a-189">Si un service est supprimé, vous devez d’abord le recréer pour que les données puissent être restaurées.</span><span class="sxs-lookup"><span data-stu-id="2227a-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="2227a-190">Il est important de créer le service avec la même configuration, par exemple, le schéma de partitionnement, afin que les données puissent être restaurées en toute transparence.</span><span class="sxs-lookup"><span data-stu-id="2227a-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="2227a-191">Une fois le service opérationnel, l’API permettant de restaurer les données (`OnDataLossAsync` ci-dessus) doit être appelée sur chacune de ses partitions.</span><span class="sxs-lookup"><span data-stu-id="2227a-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="2227a-192">Pour cela, vous pouvez utiliser `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` sur chaque partition.</span><span class="sxs-lookup"><span data-stu-id="2227a-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="2227a-193">À ce stade, l’implémentation est identique au scénario ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="2227a-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="2227a-194">Chaque partition doit restaurer la dernière sauvegarde pertinente à partir du magasin externe.</span><span class="sxs-lookup"><span data-stu-id="2227a-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="2227a-195">L’inconvénient est que l’ID de partition peut avoir changé, étant donné que le runtime crée des ID de partition de manière dynamique.</span><span class="sxs-lookup"><span data-stu-id="2227a-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="2227a-196">Par conséquent, le service doit stocker les informations de partition appropriées et le nom du service pour identifier la dernière sauvegarde correcte à restaurer pour chaque partition.</span><span class="sxs-lookup"><span data-stu-id="2227a-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="2227a-197">Il n’est pas recommandé d’utiliser `FabricClient.ServiceManager.InvokeDataLossAsync` sur chaque partition pour restaurer l’ensemble du service, car cela pourrait endommager l’état de votre cluster.</span><span class="sxs-lookup"><span data-stu-id="2227a-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="2227a-198">Réplication des données d’application endommagées</span><span class="sxs-lookup"><span data-stu-id="2227a-198">Replication of corrupt application data</span></span>
<span data-ttu-id="2227a-199">Si la mise à niveau de l’application récemment déployée comporte un bogue, des données risquent d’être endommagées.</span><span class="sxs-lookup"><span data-stu-id="2227a-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="2227a-200">Par exemple, une mise à niveau de l’application peut commencer à mettre à jour les enregistrements de numéro de téléphone d’un Dictionnaire fiable en utilisant un indicatif non valide.</span><span class="sxs-lookup"><span data-stu-id="2227a-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="2227a-201">Dans ce cas, les numéros de téléphone non valides seront répliqués, car Service Fabric ne connaît pas la nature des données stockées.</span><span class="sxs-lookup"><span data-stu-id="2227a-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="2227a-202">La première chose que vous devez faire après avoir détecté un bogue si flagrant qui endommage les données est de figer le service au niveau de l’application et, si possible, de procéder à une mise à niveau vers une version du code d’application qui exclut le bogue.</span><span class="sxs-lookup"><span data-stu-id="2227a-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="2227a-203">Cependant, même une fois que le code du service est résolu, les données peuvent être toujours endommagées et les données peuvent avoir besoin d’être restaurées.</span><span class="sxs-lookup"><span data-stu-id="2227a-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="2227a-204">Dans ce cas, restaurer la dernière sauvegarde peut ne pas suffire, étant donné qu’elle peut également être endommagée.</span><span class="sxs-lookup"><span data-stu-id="2227a-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="2227a-205">Il convient donc de rechercher la dernière sauvegarde effectuée avant que les données ne soient endommagées.</span><span class="sxs-lookup"><span data-stu-id="2227a-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="2227a-206">Si vous ne savez pas exactement quelles mises à jour sont endommagées, vous pouvez déployer un nouveau cluster Service Fabric et restaurer les sauvegardes des partitions affectées comme dans le scénario de « service supprimé ou perdu » ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="2227a-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="2227a-207">Pour chaque partition, lancer la restauration de sauvegardes de la plus récente à la plus ancienne.</span><span class="sxs-lookup"><span data-stu-id="2227a-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="2227a-208">Une fois que vous avez trouvé une sauvegarde ne présentant pas de corruption, déplacez/supprimez toutes les sauvegardes de partition plus récentes (que cette sauvegarde).</span><span class="sxs-lookup"><span data-stu-id="2227a-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="2227a-209">Répétez ce processus pour chaque partition.</span><span class="sxs-lookup"><span data-stu-id="2227a-209">Repeat this process for each partition.</span></span> <span data-ttu-id="2227a-210">À présent, lorsque `OnDataLossAsync` est appelé sur la partition dans le cluster de production, la dernière sauvegarde trouvée dans le magasin externe est celle choisie par le processus ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="2227a-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="2227a-211">Vous pouvez maintenant utiliser les étapes de la section « Service supprimé ou perdu » pour restaurer l’état du service tel qu’il était avant endommagement par le code bogué.</span><span class="sxs-lookup"><span data-stu-id="2227a-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="2227a-212">Notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="2227a-212">Note that:</span></span>

  - <span data-ttu-id="2227a-213">Lorsque vous effectuez une restauration, il existe un risque que la sauvegarde restaurée soit antérieure à l’état de la partition avant la perte des données.</span><span class="sxs-lookup"><span data-stu-id="2227a-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="2227a-214">Pour cette raison, vous ne devez effectuer une restauration qu’en dernier recours pour récupérer autant de données que possible.</span><span class="sxs-lookup"><span data-stu-id="2227a-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="2227a-215">La chaîne qui représente le chemin d’accès du dossier de sauvegarde et les chemins d’accès des fichiers dans le dossier de sauvegarde peut être supérieure à 255 caractères, selon le chemin d’accès FabricDataRoot et la longueur du nom du type d’application.</span><span class="sxs-lookup"><span data-stu-id="2227a-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="2227a-216">Certaines méthodes .NET, par exemple `Directory.Move`, risquent de lever l’exception `PathTooLongException`.</span><span class="sxs-lookup"><span data-stu-id="2227a-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="2227a-217">Il existe une solution de contournement, qui consiste à appeler directement les API kernel32, notamment `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="2227a-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="2227a-218">Sauvegarder et restaurer Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="2227a-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="2227a-219">L’infrastructure Reliable Actors est basée sur Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="2227a-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="2227a-220">Le service ActorService, qui héberge le ou les acteur(s), est un service fiable avec état.</span><span class="sxs-lookup"><span data-stu-id="2227a-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="2227a-221">Par conséquent, toutes les fonctionnalités de sauvegarde et de restauration disponibles dans Reliable Services sont également disponibles pour Reliable Actors (à l’exception des comportements spécifiques au fournisseur d’état).</span><span class="sxs-lookup"><span data-stu-id="2227a-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="2227a-222">Étant donné que les sauvegardes sont effectuées par partition, les états de tous les acteurs de cette partition sont sauvegardés (et la restauration se fait de façon similaire, par partition).</span><span class="sxs-lookup"><span data-stu-id="2227a-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="2227a-223">Afin d’effectuer la sauvegarde ou la restauration, le propriétaire du service doit créer une classe de service d’acteur personnalisée, qui dérive de la classe ActorService, puis effectuer une sauvegarde/restauration similaire à celle de Reliable Services, comme décrit dans les sections précédentes.</span><span class="sxs-lookup"><span data-stu-id="2227a-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="2227a-224">Lorsque vous créez une classe de service d’acteur personnalisée, vous devez l’inscrire également lors de l’inscription de l’acteur.</span><span class="sxs-lookup"><span data-stu-id="2227a-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="2227a-225">Le fournisseur d’état par défaut de Reliable Actors est `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="2227a-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="2227a-226">La sauvegarde incrémentielle n’est pas activée par défaut pour `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="2227a-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="2227a-227">Vous pouvez activer la sauvegarde incrémentielle en créant `KvsActorStateProvider` avec le paramètre approprié dans son constructeur et en le transmettant au constructeur ActorService, comme l’indique l’extrait de code suivant :</span><span class="sxs-lookup"><span data-stu-id="2227a-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="2227a-228">Une fois la sauvegarde incrémentielle activée, elle peut échouer avec l’erreur FabricMissingFullBackupException pour une des raisons suivantes et vous devrez effectuer une sauvegarde complète avant d’effectuer d’autres sauvegardes incrémentielles :</span><span class="sxs-lookup"><span data-stu-id="2227a-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="2227a-229">Le réplica n’a jamais fait l’objet d’une sauvegarde complète depuis qu’il est devenu le principal.</span><span class="sxs-lookup"><span data-stu-id="2227a-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="2227a-230">Certains enregistrements de journal ont été tronqués depuis la dernière sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="2227a-231">Lorsque la sauvegarde incrémentielle est activée, `KvsActorStateProvider` n’utilise pas de mémoire tampon circulaire pour gérer ses enregistrements et les tronque de temps en temps.</span><span class="sxs-lookup"><span data-stu-id="2227a-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="2227a-232">Si aucune sauvegarde n’est effectuée par l’utilisateur pendant une période de 45 minutes, le système tronque automatiquement les enregistrements du journal.</span><span class="sxs-lookup"><span data-stu-id="2227a-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="2227a-233">Vous pouvez configurer cet intervalle en spécifiant `logTrunctationIntervalInMinutes` dans le constructeur `KvsActorStateProvider` (comme pour activer la sauvegarde incrémentielle).</span><span class="sxs-lookup"><span data-stu-id="2227a-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="2227a-234">Les enregistrements de journal peuvent également être tronqués si le réplica principal nécessaire doit créer un autre réplica en envoyant toutes ses données.</span><span class="sxs-lookup"><span data-stu-id="2227a-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="2227a-235">Lors de la restauration à partir d’une chaîne de sauvegarde, comme pour Reliable Services, BackupFolderPath doit contenir des sous-répertoires avec un seul sous-répertoire contenant la sauvegarde complète et les autres sous-répertoires contenant les sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="2227a-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="2227a-236">Si la validation de la chaîne de sauvegarde échoue, l’API de restauration lance une exception FabricException avec le message d’erreur correspondant.</span><span class="sxs-lookup"><span data-stu-id="2227a-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="2227a-237">`KvsActorStateProvider` ignore actuellement l’option RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="2227a-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="2227a-238">La prise en charge de cette fonctionnalité est prévue dans une prochaine version.</span><span class="sxs-lookup"><span data-stu-id="2227a-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="2227a-239">Test de la sauvegarde et de la restauration</span><span class="sxs-lookup"><span data-stu-id="2227a-239">Testing Backup and Restore</span></span>
<span data-ttu-id="2227a-240">Il est important de s’assurer que les données critiques soient sauvegardées et puissent être restaurées.</span><span class="sxs-lookup"><span data-stu-id="2227a-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="2227a-241">Vous pouvez pour cela appeler la cmdlet `Start-ServiceFabricPartitionDataLoss` dans PowerShell, qui peut provoquer une perte de données dans une partition en particulier pour déterminer si les fonctionnalités de sauvegarde et de restauration de données de votre service fonctionnent comme prévu.</span><span class="sxs-lookup"><span data-stu-id="2227a-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="2227a-242">Il est également possible d’appeler par programme une perte de données et de la restaurer à partir de cet événement.</span><span class="sxs-lookup"><span data-stu-id="2227a-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="2227a-243">Vous pouvez trouver un exemple d’implémentation des fonctionnalités de sauvegarde et de restauration dans l’application de référence web sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="2227a-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="2227a-244">Pour plus de détails, voir le service `Inventory.Service`.</span><span class="sxs-lookup"><span data-stu-id="2227a-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="2227a-245">Sous le capot : détails supplémentaires sur la sauvegarde et la restauration</span><span class="sxs-lookup"><span data-stu-id="2227a-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="2227a-246">Voici des détails supplémentaires sur la sauvegarde et la restauration.</span><span class="sxs-lookup"><span data-stu-id="2227a-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="2227a-247">Sauvegarde</span><span class="sxs-lookup"><span data-stu-id="2227a-247">Backup</span></span>
<span data-ttu-id="2227a-248">Le gestionnaire d’état fiable offre la possibilité de créer des sauvegardes cohérentes sans bloquer les opérations de lecture ou d’écriture.</span><span class="sxs-lookup"><span data-stu-id="2227a-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="2227a-249">Pour ce faire, il utilise un point de contrôle et un mécanisme de persistance de journal.</span><span class="sxs-lookup"><span data-stu-id="2227a-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="2227a-250">Le gestionnaire d’état fiable prend des points de contrôle (légers) approximatifs à certains points pour soulager la pression dans le journal des transactions et améliorer les temps de récupération.</span><span class="sxs-lookup"><span data-stu-id="2227a-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="2227a-251">Lorsque `BackupAsync` est appelé, le gestionnaire d’état fiable demande à tous les objets fiables de copier leurs derniers fichiers de point de contrôle dans un dossier de sauvegarde local.</span><span class="sxs-lookup"><span data-stu-id="2227a-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="2227a-252">Ensuite, le gestionnaire d’état fiable copie tous les enregistrements de journal à partir du pointeur de démarrage vers le dernier enregistrement de journal dans le dossier de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="2227a-253">Comme tous les enregistrements, jusqu’au dernier, sont inclus dans la sauvegarde et que le gestionnaire d’état fiable conserve les journaux WAL (write-ahead log), il garantit que toutes les transactions validées (`CommitAsync` a réussi) sont incluses dans la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="2227a-254">Une transaction validée après l’appel de `BackupAsync` peut figurer ou non dans la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="2227a-255">Une fois que le dossier de sauvegarde local a été rempli par la plateforme (c’est-à-dire que la sauvegarde locale est effectuée par le runtime), le rappel de sauvegarde du service est appelé.</span><span class="sxs-lookup"><span data-stu-id="2227a-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="2227a-256">Ce rappel est chargé de déplacer le dossier de sauvegarde vers un emplacement externe comme Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="2227a-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="2227a-257">Restauration</span><span class="sxs-lookup"><span data-stu-id="2227a-257">Restore</span></span>
<span data-ttu-id="2227a-258">Le gestionnaire d’état fiable permet de restaurer une sauvegarde à l’aide de l’API `RestoreAsync`.</span><span class="sxs-lookup"><span data-stu-id="2227a-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="2227a-259">La méthode `RestoreAsync` sur `RestoreContext` ne peut être appelée qu’au sein de la méthode `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="2227a-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="2227a-260">Le booléen retourné par `OnDataLossAsync` indique si le service a été restauré à cet état à partir d’une source externe.</span><span class="sxs-lookup"><span data-stu-id="2227a-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="2227a-261">Si la méthode `OnDataLossAsync` retourne la valeur true, Service Fabric recrée tous les autres réplicas à partir de ce réplica principal.</span><span class="sxs-lookup"><span data-stu-id="2227a-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="2227a-262">Service Fabric s’assure que les réplicas qui vont recevoir l’appel `OnDataLossAsync` effectuent tout d’abord une transition vers le rôle principal, mais ne se voient pas accorder de statut de lecture ou d’écriture.</span><span class="sxs-lookup"><span data-stu-id="2227a-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="2227a-263">Pour les responsables de l’implémentation de StatefulService, cela implique que la méthode `RunAsync` n’est pas appelée tant que l’exécution de la méthode `OnDataLossAsync` ne s’est pas terminée correctement.</span><span class="sxs-lookup"><span data-stu-id="2227a-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="2227a-264">Ensuite, la méthode `OnDataLossAsync` est appelée sur le nouveau réplica principal.</span><span class="sxs-lookup"><span data-stu-id="2227a-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="2227a-265">L’API continuera d’être appelée jusqu’à ce que l’API se termine correctement (en renvoyant true ou false) et termine la reconfiguration concernée.</span><span class="sxs-lookup"><span data-stu-id="2227a-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="2227a-266">`RestoreAsync` supprime d’abord tout état existant dans le réplica principal sur lequel elle a été appelée.</span><span class="sxs-lookup"><span data-stu-id="2227a-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="2227a-267">Le gestionnaire d’état fiable crée ensuite tous les objets fiables qui existent dans le dossier de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="2227a-268">Les objets fiables sont alors invités à procéder à une restauration à partir de leurs points de contrôle dans le dossier de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="2227a-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="2227a-269">Enfin, le gestionnaire d’état fiable récupère son propre état à partir d’enregistrements de journal dans le dossier de sauvegarde, puis effectue la récupération.</span><span class="sxs-lookup"><span data-stu-id="2227a-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="2227a-270">Dans le cadre de la récupération, les opérations commençant à partir du point de départ qui ont validé des enregistrements de journal dans le dossier de sauvegarde sont relues dans les objets fiables.</span><span class="sxs-lookup"><span data-stu-id="2227a-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="2227a-271">Cette étape garantit que l’état récupéré est cohérent.</span><span class="sxs-lookup"><span data-stu-id="2227a-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="2227a-272">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="2227a-272">Next steps</span></span>
  - [<span data-ttu-id="2227a-273">Collections fiables</span><span class="sxs-lookup"><span data-stu-id="2227a-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="2227a-274">Démarrage rapide de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="2227a-275">Notifications Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="2227a-276">Configuration de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="2227a-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="2227a-277">Référence du développeur pour les Collections fiables</span><span class="sxs-lookup"><span data-stu-id="2227a-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

