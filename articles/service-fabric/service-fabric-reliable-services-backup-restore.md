---
title: "aaaService sauvegarde de l’infrastructure et de restauration | Documents Microsoft"
description: "Documentation conceptuelle relative à la sauvegarde et à la restauration de Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="0a8e9-103">Sauvegarder et restaurer Reliable Services et Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="0a8e9-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="0a8e9-104">Azure Service Fabric est une plateforme haute disponibilité qui réplique des état de hello dans plusieurs nœuds toomaintain cette haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="0a8e9-105">Par conséquent, même si un nœud de cluster de hello échoue, les services hello continuent toobe disponible.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="0a8e9-106">Cette redondance intégrée fournie par la plateforme de hello peut être suffisante pour certains, dans certains cas, il est souhaitable pour tooback de service hello des données (tooan un magasin externe).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="0a8e9-107">Il est critique toobackup et restaurer vos données (et vérifiez qu’elle fonctionne comme prévu) afin que vous pouvez récupérer à partir de la perte de données.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="0a8e9-108">Par exemple, un service souhaite que tooback les données de tooprotect de commande à partir de hello les scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="0a8e9-109">Dans l’événement hello de perte définitive de hello d’ensemble d’un cluster Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="0a8e9-110">Perte permanente d’une majorité des réplicas hello d’une partition de service</span><span class="sxs-lookup"><span data-stu-id="0a8e9-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="0a8e9-111">Erreurs d’administration : état de hello accidentellement obtient supprimée ou endommagée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="0a8e9-112">Par exemple, cela peut se produire si un administrateur doté de privilèges suffisants supprime de façon erronée le service de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="0a8e9-113">Bogues dans le service hello qui entraînent une altération des données.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="0a8e9-114">Par exemple, cela peut se produire lorsqu’une mise à niveau du code de service commence à écrire des données erronées tooa Collection fiable.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="0a8e9-115">Dans ce cas, les deux hello code et les données de salutation peut-être toobe tooan de restaurer l’état précédemment.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="0a8e9-116">Traitement des données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-116">Offline data processing.</span></span> <span data-ttu-id="0a8e9-117">Il peut être pratique toohave traitement en mode hors connexion de données business intelligence qui s’effectue séparément à partir du service hello qui génère des données hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="0a8e9-118">la fonctionnalité de sauvegarde/restauration Hello permet aux services reposant sur les sauvegardes de toocreate et de restauration de l’API des Services fiables hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="0a8e9-119">Hello sauvegarde API fournies par la plateforme de hello autoriser ou les sauvegardes de l’état d’une partition de service, sans blocage de lecture ou d’opérations d’écriture.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="0a8e9-120">Bonjour restauration Qu'api permettent de toobe d’état d’une partition de service restauré à partir d’une sauvegarde choisie.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="0a8e9-121">Types de sauvegarde</span><span class="sxs-lookup"><span data-stu-id="0a8e9-121">Types of Backup</span></span>
<span data-ttu-id="0a8e9-122">Il existe deux options de sauvegarde : complète et incrémentielle.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="0a8e9-123">Une sauvegarde complète est une sauvegarde qui contient tous les hello requis toorecreate hello état des données de réplica de hello : points de contrôle et tous les enregistrements de journal.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="0a8e9-124">Car il possède des points de contrôle hello et journal de hello, une sauvegarde complète peut être restaurée par lui-même.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="0a8e9-125">problème de Hello avec les sauvegardes complètes survient lorsque les points de contrôle hello sont grands.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="0a8e9-126">Par exemple, un réplica qui dispose de 16 Go de l’état aura des points de contrôle qui s’ajoutent environ too16 go.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="0a8e9-127">Si nous avons un objectif de Point de récupération de cinq minutes, le réplica de hello a besoin toobe sauvegardé toutes les cinq minutes.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="0a8e9-128">Chaque fois qu’il sauvegarde, il doit toocopy 16 Go de points de contrôle en outre too50 Mo (configurable à l’aide `CheckpointThresholdInMB`) équivalent de journaux.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Exemple de sauvegarde complète.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="0a8e9-130">problème de toothis solution Hello est les sauvegardes incrémentielles, où sauvegarde contient uniquement les enregistrements de journal hello changé depuis la dernière sauvegarde de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Exemple de sauvegarde incrémentielle.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="0a8e9-132">Étant donné que les sauvegardes incrémentielles sont les seules les modifications apportées depuis hello dernière sauvegarde (n’inclut pas de points de contrôle hello), ils ont tendance toobe plus rapidement, mais ils ne peuvent pas être restaurés sur leurs propres.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="0a8e9-133">toorestore une sauvegarde incrémentielle, la chaîne de sauvegarde entière hello est requise.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="0a8e9-134">Une chaîne de sauvegarde est une chaîne de sauvegardes qui commence par une sauvegarde complète, suivie d’un nombre de sauvegardes incrémentielles contigües.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="0a8e9-135">Sauvegarder Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-135">Backup Reliable Services</span></span>
<span data-ttu-id="0a8e9-136">Hello auteur du service a le contrôle total de situations dans lesquelles les sauvegardes toomake et l’emplacement de stockage des sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="0a8e9-137">toostart une sauvegarde, service de hello a besoin de fonction de membre tooinvoke hello héritée `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="0a8e9-138">Les sauvegardes peuvent être effectuées uniquement à partir des réplicas principaux et ils nécessitent toobe de statut d’écriture accordé.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="0a8e9-139">Comme indiqué ci-dessous, `BackupAsync` prend un `BackupDescription` objet, où on peut spécifier une sauvegarde complète ou incrémentielle, ainsi que d’une fonction de rappel, `Func<< BackupInfo, CancellationToken, Task<bool>>>` qui est appelé lorsque le dossier de sauvegarde hello a été créée localement et est prêt toobe déplacée de toosome stockage externe.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="0a8e9-140">Tootake demande une sauvegarde incrémentielle peut échouer avec `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="0a8e9-141">Cette exception indique qu’un des hello suivant choses se produit :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="0a8e9-142">réplica de Hello n’ait jamais une sauvegarde complète, car il est devenu principal,</span><span class="sxs-lookup"><span data-stu-id="0a8e9-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="0a8e9-143">hello certains enregistrements du journal depuis la dernière sauvegarde de hello a été tronqué ou</span><span class="sxs-lookup"><span data-stu-id="0a8e9-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="0a8e9-144">réplica passé hello `MaxAccumulatedBackupLogSizeInMB` limite.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="0a8e9-145">Les utilisateurs peuvent augmenter la probabilité de hello d’être en mesure de toodo les sauvegardes incrémentielles en configurant `MinLogSizeInMB` ou `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="0a8e9-146">Notez que ces valeurs d’augmenter hello par l’utilisation de disque de réplica.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="0a8e9-147">Pour plus d’informations, consultez [Configuration de Reliable Services](service-fabric-reliable-services-configuration.md).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="0a8e9-148">`BackupInfo`Fournit des informations concernant la sauvegarde hello, y compris l’emplacement hello du dossier hello où hello runtime enregistré la sauvegarde de hello (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="0a8e9-149">fonction de rappel Hello peut déplacer hello `BackupInfo.Directory` tooan magasin externe ou un autre emplacement.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="0a8e9-150">Cette fonction retourne également une valeur booléenne qui indique s’il s’agit d’emplacement du dossier de sauvegarde tooits cible pour toosuccessfully en mesure de déplacement hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="0a8e9-151">Hello de code suivant montre comment hello `BackupCallbackAsync` méthode peut être utilisé tooupload hello tooAzure sauvegarde stockage :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="0a8e9-152">Dans l’exemple précédent de hello, `ExternalBackupStore` est classe exemple hello toointerface utilisé avec le stockage d’objets Blob Azure, et `UploadBackupFolderAsync` est la méthode hello qui compresse le dossier de hello et le place dans le magasin d’objets Blob Azure hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="0a8e9-153">Notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-153">Note that:</span></span>

  - <span data-ttu-id="0a8e9-154">Il ne peut y avoir qu’une seule opération de sauvegarde en cours par réplica à un moment donné.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="0a8e9-155">Plusieurs `BackupAsync` appel à la fois lève `FabricBackupInProgressException` toolimit séquentiels sauvegardes tooone.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="0a8e9-156">Si un réplica bascule alors qu’une sauvegarde est en cours d’exécution, sauvegarde de hello n’est peut-être pas été terminée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="0a8e9-157">Une fois le basculement de hello se termine, il est donc hello de responsabilité toorestart hello sauvegarde en appelant `BackupAsync` selon les besoins.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="0a8e9-158">Restaurer Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-158">Restore Reliable Services</span></span>
<span data-ttu-id="0a8e9-159">En général, les cas de hello lorsque vous devrez peut-être tooperform une opération de restauration se répartissent dans ces catégories :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="0a8e9-160">service de Hello partitionner les données perdues.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-160">hello service partition lost data.</span></span> <span data-ttu-id="0a8e9-161">Par exemple, disque hello pour deux des trois des réplicas pour une partition (y compris le réplica principal de hello) Obtient endommagé ou réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="0a8e9-162">nouveau réplica principal de Hello peut-être toorestore des données à partir d’une sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="0a8e9-163">ensemble de service Hello est perdue.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-163">hello entire service is lost.</span></span> <span data-ttu-id="0a8e9-164">Par exemple, un administrateur supprime l’ensemble du service hello et service de hello et les données de salutation devez donc toobe restaurée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="0a8e9-165">service de Hello répliqué des données d’application endommagé (par exemple, en raison d’un bogue dans l’application).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="0a8e9-166">Dans ce cas, service de hello a toobe mis à niveau ou restaurée tooremove hello provoqué la corruption de hello et non endommagé des données a toobe restaurée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="0a8e9-167">Alors que de nombreuses approches sont possibles, nous proposons des exemples sur l’utilisation de `RestoreAsync` toorecover de hello au-dessus de scénarios.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="0a8e9-168">Perte de données de partition dans Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="0a8e9-169">Dans ce cas, hello runtime automatiquement détecte une perte de données hello et appeler hello `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="0a8e9-170">auteur du service Hello doit hello tooperform suivant toorecover :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="0a8e9-171">Substituez la méthode de classe de base virtuelle hello `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="0a8e9-172">Recherche hello dernière sauvegarde dans un emplacement externe hello contenant les sauvegardes du service hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="0a8e9-173">Télécharger la dernière sauvegarde de hello (et décompressez les sauvegarde hello dans le dossier de sauvegarde hello s’il était compressé).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="0a8e9-174">Hello `OnDataLossAsync` méthode fournit un `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="0a8e9-175">Appelez hello `RestoreAsync` API sur hello fourni `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="0a8e9-176">Renvoie la valeur true si la restauration de hello a réussi.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="0a8e9-177">Voici un exemple d’implémentation de hello `OnDataLossAsync` méthode :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="0a8e9-178">`RestoreDescription`passé dans toohello `RestoreContext.RestoreAsync` appel contient un membre appelé `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="0a8e9-179">Lorsque vous restaurez une sauvegarde complète unique, cela `BackupFolderPath` doit être défini toohello un chemin d’accès local du dossier hello qui contient votre sauvegarde complète.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="0a8e9-180">Lorsque vous restaurez une sauvegarde complète et un nombre de sauvegardes incrémentielles, `BackupFolderPath` doit être défini toohello un chemin d’accès local du dossier hello qui contient non seulement la sauvegarde complète de hello, mais également toutes les sauvegardes incrémentielles hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="0a8e9-181">`RestoreAsync`appel peut lever `FabricMissingFullBackupException` si hello `BackupFolderPath` fourni ne contient pas d’une sauvegarde complète.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="0a8e9-182">Il peut également lever `ArgumentException` si `BackupFolderPath` a une chaîne interrompue de sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="0a8e9-183">Par exemple, s’il contient une sauvegarde complète de hello, hello tout d’abord incrémentielle et hello troisième sauvegarde incrémentielle, mais aucune sauvegarde incrémentielle de hello deuxième.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="0a8e9-184">Hello RestorePolicy a la valeur tooSafe par défaut.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="0a8e9-185">Cela signifie que hello `RestoreAsync` API échoue avec ArgumentException s’il détecte ce dossier de sauvegarde hello contient un état qui est l’état toohello antérieure à ou égal contenue dans ce réplica.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="0a8e9-186">`RestorePolicy.Force`peut être utilisé tooskip cette vérification de sécurité.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="0a8e9-187">comme le spécifie `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="0a8e9-188">Service supprimé ou perdu</span><span class="sxs-lookup"><span data-stu-id="0a8e9-188">Deleted or lost service</span></span>
<span data-ttu-id="0a8e9-189">Si un service est supprimé, vous devez tout d’abord recréer les service hello avant la restauration de données de salutation.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="0a8e9-190">Il est service hello toocreate important hello même configuration, par exemple, le schéma, de partitionnement afin que hello données peut être restaurée en toute transparence.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="0a8e9-191">Une fois le service de hello, hello des données d’API toorestore (`OnDataLossAsync` au-dessus) a toobe appelée sur chaque partition de ce service.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="0a8e9-192">Pour cela, vous pouvez utiliser `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` sur chaque partition.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="0a8e9-193">À partir de ce point de mise en œuvre est hello identique hello au-dessus de scénario.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="0a8e9-194">Chaque partition doit toorestore hello dernière pertinentes sauvegarde à partir du magasin externe de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="0a8e9-195">L’inconvénient est que partition hello QU'ID peut-être maintenant changé, depuis hello runtime crée dynamiquement les ID de partition.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="0a8e9-196">Service de hello doit donc informations de partition approprié toostore hello et service nom tooidentify hello correct dernière sauvegarde toorestore à partir de chaque partition.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="0a8e9-197">Il n’est pas recommandé toouse `FabricClient.ServiceManager.InvokeDataLossAsync` sur chaque partition toorestore hello service entier, étant donné que qui peut altérer l’état de votre cluster.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="0a8e9-198">Réplication des données d’application endommagées</span><span class="sxs-lookup"><span data-stu-id="0a8e9-198">Replication of corrupt application data</span></span>
<span data-ttu-id="0a8e9-199">Mise à niveau des applications hello nouvellement déployé comporte un bogue, qui peut provoquer une altération des données.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="0a8e9-200">Par exemple, une mise à niveau de l’application peut démarrer tooupdate chaque enregistrement de numéro de téléphone d’un dictionnaire fiable avec un code de région non valide.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="0a8e9-201">Dans ce cas, les numéros de téléphone non valide de hello seront répliquées depuis le Service Fabric n’est pas informé de la nature hello de données hello qui sont stockées.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="0a8e9-202">Hello première toodo une fois que vous détectez cet monumentale un bogue qui entraîne une altération des données est toofreeze hello service au niveau de l’application hello et, si possible, mettez à niveau de version toohello hello de code d’application n’a pas de bogue de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="0a8e9-203">Toutefois, même après que le code de service hello est fixe, hello données peuvent toujours être endommagées et par conséquent, les données pouvant nécessiter toobe restaurée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="0a8e9-204">Dans ce cas, il peut-être pas suffisamment toorestore hello sauvegarde la plus récente, étant donné que les sauvegardes plus récentes hello peuvent également être endommagés.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="0a8e9-205">Par conséquent, vous avez toofind hello dernière sauvegarde effectuée avant les données de salutation sont endommagées.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="0a8e9-206">Si vous n’êtes pas sûr de laquelle les sauvegardes sont endommagés, vous pouvez déployer un cluster Service Fabric et restaurer les sauvegardes de hello de partitions affectées comme hello au-dessus de « Deleted ou perte de service » scénario.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="0a8e9-207">Pour chaque partition, démarrer la restauration des sauvegardes de hello de toohello plus récente de hello moins.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="0a8e9-208">Une fois que vous trouvez une sauvegarde qui n’a pas de corruption de hello, déplacer/supprimer toutes les sauvegardes qui ont été plus récents (que cette sauvegarde) de cette partition.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="0a8e9-209">Répétez ce processus pour chaque partition.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-209">Repeat this process for each partition.</span></span> <span data-ttu-id="0a8e9-210">Désormais, lorsque `OnDataLossAsync` est appelée sur une partition hello dans le cluster de production hello, dernière sauvegarde de hello trouvé dans hello externe magasin sera hello une sélectionnées par hello au-dessus de processus.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="0a8e9-211">Maintenant, hello étapes Bonjour « Deleted ou perte de service » section peut être utilisé d’état de hello toorestore des hello service toohello avant un code bogué hello endommagé l’état de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="0a8e9-212">Notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-212">Note that:</span></span>

  - <span data-ttu-id="0a8e9-213">Lorsque vous restaurez, il est en cours d’un risque que hello sauvegarde restaurée est antérieure à état hello de partition de hello avant que les données de salutation a été perdues.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="0a8e9-214">Pour cette raison, vous devez restaurer uniquement comme un toorecover recours dernière autant de données que possible.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="0a8e9-215">Hello de chaîne qui représente le chemin d’accès du dossier de sauvegarde hello et hello chemins d’accès des fichiers à l’intérieur du dossier de sauvegarde hello peuvent être supérieurs à 255 caractères, selon le chemin d’accès de hello FabricDataRoot et la longueur du nom du Type d’Application.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="0a8e9-216">Cela peut entraîner certaines méthodes .NET, tel que `Directory.Move`, toothrow hello `PathTooLongException` exception.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="0a8e9-217">Une solution de contournement est toodirectly appeler les API kernel32, comme `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="0a8e9-218">Sauvegarder et restaurer Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="0a8e9-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="0a8e9-219">L’infrastructure Reliable Actors est basée sur Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="0a8e9-220">Hello ActorService qui héberge hello actor(s) est un service fiable sans état.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="0a8e9-221">Par conséquent, tous hello sauvegarde et restauration des fonctionnalités disponibles dans les Services fiables sont également acteurs tooReliable disponibles (à l’exception des comportements qui sont le fournisseur d’état spécifique).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="0a8e9-222">Étant donné que les sauvegardes sont effectuées par partition, les états de tous les acteurs de cette partition sont sauvegardés (et la restauration se fait de façon similaire, par partition).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="0a8e9-223">tooperform sauvegarde/restauration, propriétaire du service hello doit créer une classe de service d’acteur personnalisée qui dérive de la classe de ActorService et puis de sauvegarde/restauration similaire tooReliable Services comme décrit ci-dessus dans les sections précédentes.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="0a8e9-224">Lorsque vous créez une classe de service d’acteur personnalisé, vous devez tooregister ainsi que lors de l’inscription d’acteur de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="0a8e9-225">fournisseur d’état par défaut Hello pour Reliable Actors est `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="0a8e9-226">La sauvegarde incrémentielle n’est pas activée par défaut pour `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="0a8e9-227">Vous pouvez activer la sauvegarde incrémentielle en créant `KvsActorStateProvider` avec hello approprié à la définition dans son constructeur et transmettez-lui tooActorService constructeur comme indiqué dans l’extrait de code suivant :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="0a8e9-228">Une fois la sauvegarde incrémentielle a été activée, effectuer une sauvegarde incrémentielle peut échouer avec FabricMissingFullBackupException pour l’une des raisons suivantes, et vous devez tootake une sauvegarde complète avant d’effectuer des sauvegardes incrémentielles d’objets :</span><span class="sxs-lookup"><span data-stu-id="0a8e9-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="0a8e9-229">réplica de Hello n’ait jamais une sauvegarde complète, car il est devenu principal.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="0a8e9-230">Certains des enregistrements de journal hello a été tronqués, car la dernière sauvegarde a été effectuée.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="0a8e9-231">Lorsque la sauvegarde incrémentielle est activée, `KvsActorStateProvider` n’utilise pas de mémoire tampon circulaire toomanage son journal enregistre et tronque régulièrement.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="0a8e9-232">Si aucune sauvegarde n’est effectuée par l’utilisateur pour une période de 45 minutes, le système de hello tronque automatiquement les enregistrements de journal hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="0a8e9-233">Cet intervalle peut être configuré en spécifiant `logTrunctationIntervalInMinutes` dans `KvsActorStateProvider` constructeur (toowhen similaire à l’activation de la sauvegarde incrémentielle).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="0a8e9-234">enregistrements de journal Hello peuvent également obtenir tronqués si le réplica principal doivent toobuild un autre réplica en envoyant toutes ses données.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="0a8e9-235">Lors de la restauration à partir d’une chaîne de sauvegarde, les Services tooReliable similaires, hello BackupFolderPath doit contenir des sous-répertoires avec un sous-répertoire contenant une sauvegarde complète et autres sous-répertoires contenant l’ou les sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="0a8e9-236">API de restauration Hello lèvera FabricException avec le message d’erreur approprié si la validation de chaîne de sauvegarde hello échoue.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="0a8e9-237">`KvsActorStateProvider`actuellement ignore l’option hello RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="0a8e9-238">La prise en charge de cette fonctionnalité est prévue dans une prochaine version.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="0a8e9-239">Test de la sauvegarde et de la restauration</span><span class="sxs-lookup"><span data-stu-id="0a8e9-239">Testing Backup and Restore</span></span>
<span data-ttu-id="0a8e9-240">Il est important tooensure qui sont en cours de sauvegarde des données critiques et peuvent être restaurées à partir de.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="0a8e9-241">Cela est possible en appelant hello `Start-ServiceFabricPartitionDataLoss` applet de commande PowerShell qui est susceptible d’entraîner une perte de données dans une partition particulière de tootest si les données de salutation et de restauration pour votre service fonctionne comme prévu.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="0a8e9-242">Il est également possible de tooprogrammatically appeler une perte de données et de restaurer à partir, ainsi que l’événement.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="0a8e9-243">Vous pouvez trouver un exemple d’implémentation de la sauvegarde et restaurer la fonctionnalité dans hello référence de l’application Web sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="0a8e9-244">Regardez hello `Inventory.Service` service pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="0a8e9-245">Dans les coulisses de hello : plus d’informations sur la sauvegarde et restauration</span><span class="sxs-lookup"><span data-stu-id="0a8e9-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="0a8e9-246">Voici des détails supplémentaires sur la sauvegarde et la restauration.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="0a8e9-247">Sauvegarde</span><span class="sxs-lookup"><span data-stu-id="0a8e9-247">Backup</span></span>
<span data-ttu-id="0a8e9-248">Hello fiable Gestionnaire d’état fournit hello capacité toocreate des sauvegardes cohérentes sans bloquer les lire ou écrire des opérations.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="0a8e9-249">toodo par conséquent, il utilise un mécanisme de persistance de point de contrôle et de journal.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="0a8e9-250">Hello fiable Gestionnaire d’état prend floues (légers) des points de contrôle à certaine points toorelieve la pression à partir du journal des transactions hello et améliorer les temps de récupération.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="0a8e9-251">Lorsque `BackupAsync` est appelée, hello Gestionnaire d’état fiable fait en sorte que tous les objets fiable toocopy leur dernier point de contrôle fichiers tooa dossier de sauvegarde local.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="0a8e9-252">Ensuite, hello Gestionnaire d’état fiable copie tous les enregistrements de journal à partir hello « démarrer le pointeur » toohello dernier enregistrement du journal dans le dossier de sauvegarde hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="0a8e9-253">Étant donné que tous les enregistrements de journal hello toohello dernier enregistrement de journal sont inclus dans la sauvegarde de hello et hello fiable Gestionnaire d’état conserve la journalisation WAL, hello fiable Gestionnaire d’état qui garantit que toutes les transactions qui sont validées (`CommitAsync` a retourné avec succès) sont inclus dans la sauvegarde de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="0a8e9-254">Une transaction est validée après `BackupAsync` a été appelée peut ou ne peut pas être dans la sauvegarde de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="0a8e9-255">Une fois que le dossier de sauvegarde local hello a été remplie par la plateforme de hello (par exemple, la sauvegarde locale est terminée par hello runtime), rappel de sauvegarde du service hello est appelé.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="0a8e9-256">Ce rappel est chargé de déplacer l’emplacement externe tooan dossier de sauvegarde hello tels que le stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="0a8e9-257">Restauration</span><span class="sxs-lookup"><span data-stu-id="0a8e9-257">Restore</span></span>
<span data-ttu-id="0a8e9-258">Hello fiable Gestionnaire d’état fournit hello capacité toorestore à partir d’une sauvegarde à l’aide de hello `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="0a8e9-259">Hello `RestoreAsync` méthode sur `RestoreContext` peut être appelée uniquement à l’intérieur de hello `OnDataLossAsync` (méthode).</span><span class="sxs-lookup"><span data-stu-id="0a8e9-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="0a8e9-260">Hello bool retourné par `OnDataLossAsync` indique si le service de hello restaurée son état à partir d’une source externe.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="0a8e9-261">Si hello `OnDataLossAsync` retourne la valeur true, l’infrastructure de Service permet de reconstruire tous les autres réplicas à partir de ce serveur principal.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="0a8e9-262">Service Fabric garantit que les réplicas qui recevront `OnDataLossAsync` appeler le premier rôle principal toohello de transition, mais ne sont pas accordées lus état ou écrire l’état.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="0a8e9-263">Pour les responsables de l’implémentation de StatefulService, cela implique que la méthode `RunAsync` n’est pas appelée tant que l’exécution de la méthode `OnDataLossAsync` ne s’est pas terminée correctement.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="0a8e9-264">Ensuite, `OnDataLossAsync` sera appelée sur le nouveau réplica principal de hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="0a8e9-265">Jusqu'à ce qu’un service termine cette API correctement (en retournant true ou false) et termine une reconfiguration pertinentes hello, hello API sera conserver qui est appelée à la fois.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="0a8e9-266">`RestoreAsync`tout d’abord supprime tous les États existant dans le réplica principal hello qui il a été appelé sur.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="0a8e9-267">Hello fiable Gestionnaire d’état crée ensuite tous les objets fiable hello qui existent dans le dossier de sauvegarde hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="0a8e9-268">Ensuite, les objets fiable hello sont toorestore demandé à partir de leurs points de contrôle dans le dossier de sauvegarde hello.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="0a8e9-269">Enfin, hello Gestionnaire d’état fiable récupère son propre état à partir des enregistrements de journal hello dans le dossier de sauvegarde hello et effectue la récupération.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="0a8e9-270">Dans le cadre du processus de récupération hello, les opérations à partir de hello « point de départ » qui ont des enregistrements de journal de validation dans le dossier de sauvegarde hello sont des objets de fiable toohello relue.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="0a8e9-271">Cette étape garantit que hello état récupéré est cohérent.</span><span class="sxs-lookup"><span data-stu-id="0a8e9-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0a8e9-272">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="0a8e9-272">Next steps</span></span>
  - [<span data-ttu-id="0a8e9-273">Collections fiables</span><span class="sxs-lookup"><span data-stu-id="0a8e9-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="0a8e9-274">Démarrage rapide de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="0a8e9-275">Notifications Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="0a8e9-276">Configuration de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="0a8e9-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="0a8e9-277">Référence du développeur pour les Collections fiables</span><span class="sxs-lookup"><span data-stu-id="0a8e9-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

