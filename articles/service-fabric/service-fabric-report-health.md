---
title: "Ajout de rapports d’intégrité Service Fabric personnalisés | Microsoft Docs"
description: "Explique comment envoyer des rapports d’intégrité personnalisés à des entités d’intégrité Azure Service Fabric. Fournit des recommandations pour la conception et la mise en œuvre de rapports d’intégrité de qualité."
services: service-fabric
documentationcenter: .net
author: oanapl
manager: timlt
editor: 
ms.assetid: 0a00a7d2-510e-47d0-8aa8-24c851ea847f
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/19/2017
ms.author: oanapl
ms.openlocfilehash: ed10eef347d4d93012078456b3a145589e66d30e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="add-custom-service-fabric-health-reports"></a><span data-ttu-id="66301-104">Ajout de rapports d’intégrité Service Fabric personnalisés</span><span class="sxs-lookup"><span data-stu-id="66301-104">Add custom Service Fabric health reports</span></span>
<span data-ttu-id="66301-105">Azure Service Fabric introduit un [modèle d’intégrité](service-fabric-health-introduction.md) conçu pour signaler des conditions de cluster et d’application défectueuses sur des entités spécifiques.</span><span class="sxs-lookup"><span data-stu-id="66301-105">Azure Service Fabric introduces a [health model](service-fabric-health-introduction.md) designed to flag unhealthy cluster and application conditions on specific entities.</span></span> <span data-ttu-id="66301-106">Le modèle d’intégrité utilise des **rapporteurs d’intégrité** (composants système et agents de surveillance).</span><span class="sxs-lookup"><span data-stu-id="66301-106">The health model uses **health reporters** (system components and watchdogs).</span></span> <span data-ttu-id="66301-107">L’objectif consiste en un diagnostic et une réparation simples et rapides.</span><span class="sxs-lookup"><span data-stu-id="66301-107">The goal is easy and fast diagnosis and repair.</span></span> <span data-ttu-id="66301-108">Les enregistreurs du service doivent penser en amont à l’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-108">Service writers need to think upfront about health.</span></span> <span data-ttu-id="66301-109">Toute condition pouvant avoir une incidence sur l’intégrité doit être signalée, surtout si cela peut aider à signaler des problèmes proches de la racine.</span><span class="sxs-lookup"><span data-stu-id="66301-109">Any condition that can impact health should be reported on, especially if it can help flag problems close to the root.</span></span> <span data-ttu-id="66301-110">Pour ce qui est du débogage et des investigations, les informations sur l’intégrité peuvent faire gagner du temps et économiser des efforts.</span><span class="sxs-lookup"><span data-stu-id="66301-110">The health information can save time and effort on debugging and investigation.</span></span> <span data-ttu-id="66301-111">L’utilité est particulièrement flagrante une fois que le service est en cours d’exécution, à l’échelle dans le cloud (privé ou Azure).</span><span class="sxs-lookup"><span data-stu-id="66301-111">The usefulness is especially clear once the service is up and running at scale in the cloud (private or Azure).</span></span>

<span data-ttu-id="66301-112">Les rapporteurs Service Fabric surveillent les conditions identifiées qui présentent un intérêt.</span><span class="sxs-lookup"><span data-stu-id="66301-112">The Service Fabric reporters monitor identified conditions of interest.</span></span> <span data-ttu-id="66301-113">Ils dressent un rapport sur ces conditions en fonction de leur vue locale.</span><span class="sxs-lookup"><span data-stu-id="66301-113">They report on those conditions based on their local view.</span></span> <span data-ttu-id="66301-114">Le [magasin d’intégrité](service-fabric-health-introduction.md#health-store) agrège les données d’intégrité envoyées par tous les rapporteurs pour déterminer si les entités sont globalement intègres.</span><span class="sxs-lookup"><span data-stu-id="66301-114">The [health store](service-fabric-health-introduction.md#health-store) aggregates health data sent by all reporters to determine whether entities are globally healthy.</span></span> <span data-ttu-id="66301-115">Le modèle doit être riche, flexible et facile à utiliser.</span><span class="sxs-lookup"><span data-stu-id="66301-115">The model is intended to be rich, flexible, and easy to use.</span></span> <span data-ttu-id="66301-116">La qualité des rapports d’intégrité détermine la précision de la vue d’intégrité du cluster.</span><span class="sxs-lookup"><span data-stu-id="66301-116">The quality of the health reports determines the accuracy of the health view of the cluster.</span></span> <span data-ttu-id="66301-117">Des faux positifs qui indiquent erronément des problèmes d’intégrité peuvent avoir une incidence négative sur les mises à niveau ou autres services utilisant des données d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-117">False positives that wrongly show unhealthy issues can negatively impact upgrades or other services that use health data.</span></span> <span data-ttu-id="66301-118">Les services de réparation et mécanismes d’alertes sont des exemples de services de ce type.</span><span class="sxs-lookup"><span data-stu-id="66301-118">Examples of such services are repair services and alerting mechanisms.</span></span> <span data-ttu-id="66301-119">Par conséquent, une réflexion est nécessaire pour générer des rapports qui capturent des conditions pertinentes de la meilleure façon possible.</span><span class="sxs-lookup"><span data-stu-id="66301-119">Therefore, some thought is needed to provide reports that capture conditions of interest in the best possible way.</span></span>

<span data-ttu-id="66301-120">Pour concevoir et implémenter des rapports d’intégrité, les agents de surveillance et les composants système doivent :</span><span class="sxs-lookup"><span data-stu-id="66301-120">To design and implement health reporting, watchdogs and system components must:</span></span>

* <span data-ttu-id="66301-121">Définir la condition qui les intéresse, la façon dont elle est surveillée et l’impact sur la fonctionnalité du cluster ou de l’application.</span><span class="sxs-lookup"><span data-stu-id="66301-121">Define the condition they are interested in, the way it is monitored, and the impact on the cluster or application functionality.</span></span> <span data-ttu-id="66301-122">Choisir la propriété du rapport d’intégrité et l’état d’intégrité, en fonction de ces informations.</span><span class="sxs-lookup"><span data-stu-id="66301-122">Based on this information, decide on the health report property and health state.</span></span>
* <span data-ttu-id="66301-123">Déterminer l’ [entité](service-fabric-health-introduction.md#health-entities-and-hierarchy) à laquelle le rapport s’applique.</span><span class="sxs-lookup"><span data-stu-id="66301-123">Determine the [entity](service-fabric-health-introduction.md#health-entities-and-hierarchy) that the report applies to.</span></span>
* <span data-ttu-id="66301-124">Déterminer l’emplacement où le rapport est généré, soit à partir du service, soit à partir d’un agent de surveillance interne ou externe.</span><span class="sxs-lookup"><span data-stu-id="66301-124">Determine where the reporting is done, from within the service or from an internal or external watchdog.</span></span>
* <span data-ttu-id="66301-125">Définir une source utilisée pour identifier le rapporteur.</span><span class="sxs-lookup"><span data-stu-id="66301-125">Define a source used to identify the reporter.</span></span>
* <span data-ttu-id="66301-126">Choisir une stratégie de création de rapports, périodiquement ou selon les transitions.</span><span class="sxs-lookup"><span data-stu-id="66301-126">Choose a reporting strategy, either periodically or on transitions.</span></span> <span data-ttu-id="66301-127">La méthode recommandée est la création périodique, car elle requiert un code plus simple et est moins sujette aux erreurs.</span><span class="sxs-lookup"><span data-stu-id="66301-127">The recommended way is periodically, as it requires simpler code and is less prone to errors.</span></span>
* <span data-ttu-id="66301-128">Déterminer la durée pendant laquelle le rapport sur les conditions défectueuses doit rester dans le magasin d’intégrité et comment il doit être effacé.</span><span class="sxs-lookup"><span data-stu-id="66301-128">Determine how long the report for unhealthy conditions should stay in the health store and how it should be cleared.</span></span> <span data-ttu-id="66301-129">Grâce à ces informations, vous pouvez définir la valeur TTL du rapport et le comportement de suppression à l’expiration.</span><span class="sxs-lookup"><span data-stu-id="66301-129">Using this information, decide the report's time to live and remove-on-expiration behavior.</span></span>

<span data-ttu-id="66301-130">Comme mentionné auparavant, la création de rapports peut être effectuée à partir des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="66301-130">As mentioned, reporting can be done from:</span></span>

* <span data-ttu-id="66301-131">Le réplica de service Service Fabric surveillé.</span><span class="sxs-lookup"><span data-stu-id="66301-131">The monitored Service Fabric service replica.</span></span>
* <span data-ttu-id="66301-132">Les agents de surveillance internes déployés en tant que services Service Fabric (par exemple, un service Service Fabric sans état, qui surveille des conditions et émet des rapports).</span><span class="sxs-lookup"><span data-stu-id="66301-132">Internal watchdogs deployed as a Service Fabric service (for example, a Service Fabric stateless service that monitors conditions and issues reports).</span></span> <span data-ttu-id="66301-133">Les agents de surveillance peuvent être déployés sur tous les nœuds ou ils peuvent être apparentés au service surveillé.</span><span class="sxs-lookup"><span data-stu-id="66301-133">The watchdogs can be deployed an all nodes or can be affinitized to the monitored service.</span></span>
* <span data-ttu-id="66301-134">Les agents de surveillance internes qui s’exécutent sur les nœuds Service Fabric, mais qui ne sont *pas* implémentés en tant que services de Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="66301-134">Internal watchdogs that run on the Service Fabric nodes but are *not* implemented as Service Fabric services.</span></span>
* <span data-ttu-id="66301-135">Les agents de surveillance externes qui sondent la ressource à partir de l’ *extérieur* du cluster Service Fabric (par exemple, un service de surveillance de type Gomez).</span><span class="sxs-lookup"><span data-stu-id="66301-135">External watchdogs that probe the resource from *outside* the Service Fabric cluster (for example, monitoring service like Gomez).</span></span>

> [!NOTE]
> <span data-ttu-id="66301-136">Dès le départ, le cluster comprend des rapports d’intégrité envoyés par les composants système.</span><span class="sxs-lookup"><span data-stu-id="66301-136">Out of the box, the cluster is populated with health reports sent by the system components.</span></span> <span data-ttu-id="66301-137">Pour en savoir plus, voir [Utilisation des rapports d’intégrité système pour la résolution des problèmes](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span><span class="sxs-lookup"><span data-stu-id="66301-137">Read more at [Using system health reports for troubleshooting](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span></span> <span data-ttu-id="66301-138">Les rapports utilisateur doivent être envoyés sur des [entités d’intégrité](service-fabric-health-introduction.md#health-entities-and-hierarchy) déjà créées par le système.</span><span class="sxs-lookup"><span data-stu-id="66301-138">The user reports must be sent on [health entities](service-fabric-health-introduction.md#health-entities-and-hierarchy) that have already been created by the system.</span></span>
> 
> 

<span data-ttu-id="66301-139">Lorsque la conception de la création des rapports d’intégrité est claire, l’envoi de rapports d’intégrité est simple.</span><span class="sxs-lookup"><span data-stu-id="66301-139">Once the health reporting design is clear, health reports can be sent easily.</span></span> <span data-ttu-id="66301-140">Vous pouvez utiliser [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) pour créer un rapport sur l’intégrité, si le cluster n’est pas [sécurisé](service-fabric-cluster-security.md) ou si le client d’infrastructure possède des privilèges d’administrateur.</span><span class="sxs-lookup"><span data-stu-id="66301-140">You can use [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) to report health if the cluster is not [secure](service-fabric-cluster-security.md) or if the fabric client has admin privileges.</span></span> <span data-ttu-id="66301-141">La génération de rapports peut se faire au moyen de l’API avec [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), via PowerShell ou REST.</span><span class="sxs-lookup"><span data-stu-id="66301-141">Reporting can be done through the API by using [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), through PowerShell, or through REST.</span></span> <span data-ttu-id="66301-142">Des boutons de configuration regroupent les rapports afin d’améliorer les performances.</span><span class="sxs-lookup"><span data-stu-id="66301-142">Configuration knobs batch reports for improved performance.</span></span>

> [!NOTE]
> <span data-ttu-id="66301-143">L’intégrité de rapport est synchrone, et représente uniquement le travail de validation côté client.</span><span class="sxs-lookup"><span data-stu-id="66301-143">Report health is synchronous, and it represents only the validation work on the client side.</span></span> <span data-ttu-id="66301-144">Même si le rapport est accepté par le client de contrôle d’intégrité ou les objets `Partition` ou `CodePackageActivationContext`, cela ne signifie pas qu’il est appliqué dans le magasin.</span><span class="sxs-lookup"><span data-stu-id="66301-144">The fact that the report is accepted by the health client or the `Partition` or `CodePackageActivationContext` objects doesn't mean that it is applied in the store.</span></span> <span data-ttu-id="66301-145">Il est envoyé de manière asynchrone et éventuellement regroupé avec d’autres rapports.</span><span class="sxs-lookup"><span data-stu-id="66301-145">It is sent asynchronously and possibly batched with other reports.</span></span> <span data-ttu-id="66301-146">Le traitement sur le serveur peut encore échouer, car un numéro de séquence est périmé, l’entité sur laquelle le rapport doit être appliqué a été supprimée, etc.</span><span class="sxs-lookup"><span data-stu-id="66301-146">The processing on the server may still fail: the sequence number could be stale, the entity on which the report must be applied has been deleted, etc.</span></span>
> 
> 

## <a name="health-client"></a><span data-ttu-id="66301-147">Client de contrôle d’intégrité</span><span class="sxs-lookup"><span data-stu-id="66301-147">Health client</span></span>
<span data-ttu-id="66301-148">Les rapports d’intégrité sont envoyés au magasin d’intégrité à l’aide d’un client de contrôle d’intégrité, qui réside dans le client Fabric.</span><span class="sxs-lookup"><span data-stu-id="66301-148">The health reports are sent to the health store through a health client, which lives inside the fabric client.</span></span> <span data-ttu-id="66301-149">Le client de contrôle d’intégrité peut être configuré à l’aide des paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="66301-149">The health client can be configured with the following settings:</span></span>

* <span data-ttu-id="66301-150">**HealthReportSendInterval**: délai qui s’écoule entre le moment où le rapport est ajouté au client et celui où il est envoyé au magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-150">**HealthReportSendInterval**: The delay between the time the report is added to the client and the time it is sent to the health store.</span></span> <span data-ttu-id="66301-151">Il est utilisé pour regrouper les rapports dans un seul message, au lieu d’envoyer un message pour chaque rapport.</span><span class="sxs-lookup"><span data-stu-id="66301-151">Used to batch reports into a single message, rather than sending one message for each report.</span></span> <span data-ttu-id="66301-152">Ce regroupement améliore les performances.</span><span class="sxs-lookup"><span data-stu-id="66301-152">The batching improves performance.</span></span> <span data-ttu-id="66301-153">Par défaut : 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-153">Default: 30 seconds.</span></span>
* <span data-ttu-id="66301-154">**HealthReportRetrySendInterval**: intervalle auquel le client de contrôle d’intégrité renvoie les rapports d’intégrité cumulés au magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-154">**HealthReportRetrySendInterval**: The interval at which the health client resends accumulated health reports to the health store.</span></span> <span data-ttu-id="66301-155">Par défaut : 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-155">Default: 30 seconds.</span></span>
* <span data-ttu-id="66301-156">**HealthOperationTimeout**: délai d’expiration pour un message de rapport envoyé au magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-156">**HealthOperationTimeout**: The timeout period for a report message sent to the health store.</span></span> <span data-ttu-id="66301-157">Si un message expire, le client de contrôle d’intégrité réessaie de l’envoyer jusqu’à ce que le magasin d’intégrité confirme que le rapport a été traité.</span><span class="sxs-lookup"><span data-stu-id="66301-157">If a message times out, the health client retries it until the health store confirms that the report has been processed.</span></span> <span data-ttu-id="66301-158">Par défaut : deux minutes.</span><span class="sxs-lookup"><span data-stu-id="66301-158">Default: two minutes.</span></span>

> [!NOTE]
> <span data-ttu-id="66301-159">Lorsque les rapports sont traités par lot, le client Fabric doit être maintenu actif pendant au moins l’intervalle HealthReportSendInterval pour s’assurer qu’ils sont envoyés.</span><span class="sxs-lookup"><span data-stu-id="66301-159">When the reports are batched, the fabric client must be kept alive for at least the HealthReportSendInterval to ensure that they are sent.</span></span> <span data-ttu-id="66301-160">Si le message est perdu ou si le magasin d’intégrité n’est pas en mesure de d’appliquer les rapports en raison d’erreurs transitoires, le client Fabric doit être maintenu actif plus longtemps pour lui donner une chance de réessayer.</span><span class="sxs-lookup"><span data-stu-id="66301-160">If the message is lost or the health store cannot apply them due to transient errors, the fabric client must be kept alive longer to give it a chance to retry.</span></span>
> 
> 

<span data-ttu-id="66301-161">La mise en mémoire tampon sur le client prend en compte l’unicité des rapports.</span><span class="sxs-lookup"><span data-stu-id="66301-161">The buffering on the client takes the uniqueness of the reports into consideration.</span></span> <span data-ttu-id="66301-162">Par exemple, si un rapporteur incorrect génère 100 rapports par seconde sur la même propriété de la même entité, ces rapports sont remplacés par la dernière version.</span><span class="sxs-lookup"><span data-stu-id="66301-162">For example, if a particular bad reporter is reporting 100 reports per second on the same property of the same entity, the reports are replaced with the last version.</span></span> <span data-ttu-id="66301-163">La file d’attente du client contient tout au plus un rapport de ce type.</span><span class="sxs-lookup"><span data-stu-id="66301-163">At most one such report exists in the client queue.</span></span> <span data-ttu-id="66301-164">Si le traitement par lots est configuré, les rapports envoyés au magasin d’intégrité sont au nombre de un par intervalle d’envoi.</span><span class="sxs-lookup"><span data-stu-id="66301-164">If batching is configured, the number of reports sent to the health store is just one per send interval.</span></span> <span data-ttu-id="66301-165">Il s’agit du dernier rapport ajouté, qui reflète l’état le plus récent de l’entité.</span><span class="sxs-lookup"><span data-stu-id="66301-165">This report is the last added report, which reflects the most current state of the entity.</span></span>
<span data-ttu-id="66301-166">Spécifiez les paramètres de configuration lors de la création de l’élément `FabricClient`, via la transmission de [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) avec les valeurs souhaitées pour les entrées relatives à l’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-166">Specify configuration parameters when `FabricClient` is created by passing [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) with the desired values for health-related entries.</span></span>

<span data-ttu-id="66301-167">L’exemple suivant permet de créer un client Fabric et d’indiquer que les rapports doivent être envoyés dès qu’ils sont ajoutés.</span><span class="sxs-lookup"><span data-stu-id="66301-167">The following example creates a fabric client and specifies that the reports should be sent when they are added.</span></span> <span data-ttu-id="66301-168">En cas de délais d’attente et d’erreurs pouvant donner lieu à une nouvelle tentative, les nouvelles tentatives ont lieu toutes les 40 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-168">On timeouts and errors that can be retried, retries happen every 40 seconds.</span></span>

```csharp
var clientSettings = new FabricClientSettings()
{
    HealthOperationTimeout = TimeSpan.FromSeconds(120),
    HealthReportSendInterval = TimeSpan.FromSeconds(0),
    HealthReportRetrySendInterval = TimeSpan.FromSeconds(40),
};
var fabricClient = new FabricClient(clientSettings);
```

<span data-ttu-id="66301-169">Nous recommandons de conserver le paramètre par défaut du client Fabric, qui définit `HealthReportSendInterval` sur 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-169">We recommend keeping the default fabric client settings, which set `HealthReportSendInterval` to 30 seconds.</span></span> <span data-ttu-id="66301-170">Ce paramètre garantit des performances optimales en raison du traitement par lots.</span><span class="sxs-lookup"><span data-stu-id="66301-170">This setting ensures optimal performance due to batching.</span></span> <span data-ttu-id="66301-171">Pour les rapports critiques qui doivent être envoyés dès que possible, utilisez `HealthReportSendOptions` avec Immediate `true` dans l’API [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth).</span><span class="sxs-lookup"><span data-stu-id="66301-171">For critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true` in [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API.</span></span> <span data-ttu-id="66301-172">Les rapports immédiats ignorent l’intervalle du traitement par lots.</span><span class="sxs-lookup"><span data-stu-id="66301-172">Immediate reports bypass the batching interval.</span></span> <span data-ttu-id="66301-173">Utilisez cet indicateur avec précaution ; nous souhaitons tirer parti du traitement par lots du client de contrôle d’intégrité chaque fois que cela est possible.</span><span class="sxs-lookup"><span data-stu-id="66301-173">Use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span> <span data-ttu-id="66301-174">L’envoi immédiat est également utile lors de la fermeture du client Fabric (par exemple, quand le processus a déterminé l’état non valide et doit s’arrêter afin d’éviter des effets secondaires).</span><span class="sxs-lookup"><span data-stu-id="66301-174">Immediate send is also useful when the fabric client is closing (for example, the process has determined invalid state and needs to shut down to prevent side effects).</span></span> <span data-ttu-id="66301-175">Il garantit un envoi au mieux des rapports cumulés.</span><span class="sxs-lookup"><span data-stu-id="66301-175">It ensures a best-effort send of the accumulated reports.</span></span> <span data-ttu-id="66301-176">Lorsqu’un rapport est ajouté avec l’indicateur « Immediate », le client de contrôle d’intégrité constitue un lot de tous les rapports cumulés depuis le dernier envoi.</span><span class="sxs-lookup"><span data-stu-id="66301-176">When one report is added with Immediate flag, the health client batches all the accumulated reports since last send.</span></span>

<span data-ttu-id="66301-177">Il est possible de spécifier les mêmes paramètres lors de la création d’une connexion à un cluster via Powershell.</span><span class="sxs-lookup"><span data-stu-id="66301-177">Same parameters can be specified when a connection to a cluster is created through PowerShell.</span></span> <span data-ttu-id="66301-178">L’exemple suivant démarre une connexion à un cluster local :</span><span class="sxs-lookup"><span data-stu-id="66301-178">The following example starts a connection to a local cluster:</span></span>

```powershell
PS C:\> Connect-ServiceFabricCluster -HealthOperationTimeoutInSec 120 -HealthReportSendIntervalInSec 0 -HealthReportRetrySendIntervalInSec 40
True

ConnectionEndpoint   :
FabricClientSettings : {
                       ClientFriendlyName                   : PowerShell-1944858a-4c6d-465f-89c7-9021c12ac0bb
                       PartitionLocationCacheLimit          : 100000
                       PartitionLocationCacheBucketCount    : 1024
                       ServiceChangePollInterval            : 00:02:00
                       ConnectionInitializationTimeout      : 00:00:02
                       KeepAliveInterval                    : 00:00:20
                       HealthOperationTimeout               : 00:02:00
                       HealthReportSendInterval             : 00:00:00
                       HealthReportRetrySendInterval        : 00:00:40
                       NotificationGatewayConnectionTimeout : 00:00:00
                       NotificationCacheUpdateTimeout       : 00:00:00
                       }
GatewayInformation   : {
                       NodeAddress                          : localhost:19000
                       NodeId                               : 1880ec88a3187766a6da323399721f53
                       NodeInstanceId                       : 130729063464981219
                       NodeName                             : Node.1
                       }
```

<span data-ttu-id="66301-179">Tout comme l’API, les rapports peuvent être envoyés immédiatement à l’aide du commutateur `-Immediate`, quelle que soit la valeur de `HealthReportSendInterval`.</span><span class="sxs-lookup"><span data-stu-id="66301-179">Similarly to API, reports can be sent using `-Immediate` switch to be sent immediately, regardless of the `HealthReportSendInterval` value.</span></span>

<span data-ttu-id="66301-180">Pour REST, les rapports sont envoyés à la passerelle Service Fabric qui a un client Fabric interne.</span><span class="sxs-lookup"><span data-stu-id="66301-180">For REST, the reports are sent to the Service Fabric gateway, which has an internal fabric client.</span></span> <span data-ttu-id="66301-181">Par défaut, ce client est configuré pour envoyer des rapports traités par lot toutes les 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-181">By default, this client is configured to send reports batched every 30 seconds.</span></span> <span data-ttu-id="66301-182">Vous pouvez modifier l’intervalle de traitement de lots à l’aide du paramètre de configuration de cluster `HttpGatewayHealthReportSendInterval` défini sur `HttpGateway`.</span><span class="sxs-lookup"><span data-stu-id="66301-182">You can change the batch interval with the cluster configuration setting `HttpGatewayHealthReportSendInterval` on `HttpGateway`.</span></span> <span data-ttu-id="66301-183">Comme indiqué, une meilleure solution consiste à envoyer les rapports avec `Immediate` true.</span><span class="sxs-lookup"><span data-stu-id="66301-183">As mentioned, a better option is to send the reports with `Immediate` true.</span></span> 

> [!NOTE]
> <span data-ttu-id="66301-184">Pour vous assurer que des services non autorisés ne créent pas de rapports de contrôle d’intégrité sur les entités du cluster, configurez le serveur pour qu’il accepte uniquement les demandes de clients sécurisés.</span><span class="sxs-lookup"><span data-stu-id="66301-184">To ensure that unauthorized services can't report health against the entities in the cluster, configure the server to accept requests only from secured clients.</span></span> <span data-ttu-id="66301-185">La sécurité doit être activée pour l’élément `FabricClient` afin de permettre une communication avec le cluster (par exemple, avec l’authentification de certificat ou Kerberos).</span><span class="sxs-lookup"><span data-stu-id="66301-185">The `FabricClient` used for reporting must have security enabled to be able to communicate with the cluster (for example, with Kerberos or certificate authentication).</span></span> <span data-ttu-id="66301-186">En savoir plus sur la [sécurité du cluster](service-fabric-cluster-security.md).</span><span class="sxs-lookup"><span data-stu-id="66301-186">Read more about [cluster security](service-fabric-cluster-security.md).</span></span>
> 
> 

## <a name="report-from-within-low-privilege-services"></a><span data-ttu-id="66301-187">Création de rapports depuis les services à faibles privilèges</span><span class="sxs-lookup"><span data-stu-id="66301-187">Report from within low privilege services</span></span>
<span data-ttu-id="66301-188">Si les services Service Fabric n’ont aucun accès administrateur au cluster, vous pouvez créer des rapports sur l’intégrité des entités à partir du contexte actuel via `Partition` ou `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="66301-188">If Service Fabric services do not have admin access to the cluster, you can report health on entities from the current context through `Partition` or `CodePackageActivationContext`.</span></span>

* <span data-ttu-id="66301-189">Pour les services sans état, utilisez [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) pour créer un rapport sur l’instance de service actuelle.</span><span class="sxs-lookup"><span data-stu-id="66301-189">For stateless services, use [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) to report on the current service instance.</span></span>
* <span data-ttu-id="66301-190">Pour les services avec état, utilisez [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) pour créer un rapport sur le réplica en cours.</span><span class="sxs-lookup"><span data-stu-id="66301-190">For stateful services, use [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) to report on current replica.</span></span>
* <span data-ttu-id="66301-191">Utilisez [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) pour créer un rapport sur l’entité de partition actuelle.</span><span class="sxs-lookup"><span data-stu-id="66301-191">Use [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) to report on the current partition entity.</span></span>
* <span data-ttu-id="66301-192">Utilisez [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) pour créer un rapport sur l’application en cours.</span><span class="sxs-lookup"><span data-stu-id="66301-192">Use [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) to report on current application.</span></span>
* <span data-ttu-id="66301-193">Utilisez [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) pour créer un rapport sur l’application en cours déployée sur le nœud actuel.</span><span class="sxs-lookup"><span data-stu-id="66301-193">Use [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) to report on the current application deployed on the current node.</span></span>
* <span data-ttu-id="66301-194">Utilisez [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) afin de créer un rapport sur un package de services pour l’application déployée sur le nœud actuel.</span><span class="sxs-lookup"><span data-stu-id="66301-194">Use [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) to report on a service package for the application deployed on the current node.</span></span>

> [!NOTE]
> <span data-ttu-id="66301-195">En interne, `Partition` et `CodePackageActivationContext` contiennent un client de contrôle d’intégrité configuré avec les paramètres par défaut.</span><span class="sxs-lookup"><span data-stu-id="66301-195">Internally, the `Partition` and the `CodePackageActivationContext` hold a health client configured with default settings.</span></span> <span data-ttu-id="66301-196">Comme indiqué pour le [client de contrôle d’intégrité](service-fabric-report-health.md#health-client), les rapports sont traités par lots et envoyés sur un minuteur.</span><span class="sxs-lookup"><span data-stu-id="66301-196">As explained for the [health client](service-fabric-report-health.md#health-client), reports are batched and sent on a timer.</span></span> <span data-ttu-id="66301-197">Les objets doivent être maintenus actifs pour avoir une chance d’envoyer le rapport.</span><span class="sxs-lookup"><span data-stu-id="66301-197">The objects should be kept alive to have a chance to send the report.</span></span>
> 
> 

<span data-ttu-id="66301-198">Vous pouvez spécifier `HealthReportSendOptions` lors de l’envoi de rapports par le biais des API de contrôle d’intégrité `Partition` et `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="66301-198">You can specify `HealthReportSendOptions` when sending reports through `Partition` and `CodePackageActivationContext` health APIs.</span></span> <span data-ttu-id="66301-199">Si des rapports critiques doivent être envoyés dès que possible, utilisez `HealthReportSendOptions` avec Immediate `true`.</span><span class="sxs-lookup"><span data-stu-id="66301-199">If you have critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true`.</span></span> <span data-ttu-id="66301-200">Les rapports immédiats ignorent cet intervalle de traitement par lots du client de contrôle d’intégrité interne.</span><span class="sxs-lookup"><span data-stu-id="66301-200">Immediate reports bypass the batching interval of the internal health client.</span></span> <span data-ttu-id="66301-201">Comme mentionné précédemment, utilisez cet indicateur avec précaution ; nous souhaitons tirer parti de ce traitement par lots du client de contrôle d’intégrité chaque fois que cela est possible.</span><span class="sxs-lookup"><span data-stu-id="66301-201">As mentioned before, use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span>

## <a name="design-health-reporting"></a><span data-ttu-id="66301-202">Conception de rapports d’intégrité</span><span class="sxs-lookup"><span data-stu-id="66301-202">Design health reporting</span></span>
<span data-ttu-id="66301-203">La première étape de la génération de rapports de haute qualité consiste à identifier les conditions qui peuvent avoir une incidence sur l’intégrité du service.</span><span class="sxs-lookup"><span data-stu-id="66301-203">The first step in generating high-quality reports is identifying the conditions that can impact the health of the service.</span></span> <span data-ttu-id="66301-204">Toute condition pouvant aider à signaler des problèmes dans le service ou le cluster dès le début ou, mieux encore, avant qu’ils se produisent, peut permettre d’économiser des milliards de dollars.</span><span class="sxs-lookup"><span data-stu-id="66301-204">Any condition that can help flag problems in the service or cluster when it starts--or even better, before a problem happens--can potentially save billions of dollars.</span></span> <span data-ttu-id="66301-205">Les avantages incluent moins temps d’arrêt, moins de nuits passées à investiguer et à résoudre des problèmes, et une satisfaction accrue des clients.</span><span class="sxs-lookup"><span data-stu-id="66301-205">The benefits include less down time, fewer night hours spent investigating and repairing issues, and higher customer satisfaction.</span></span>

<span data-ttu-id="66301-206">Une fois les conditions identifiées, les enregistreurs de surveillance doivent déterminer la meilleure façon de les surveiller pour obtenir le meilleur équilibre possible entre la surcharge et l’utilité.</span><span class="sxs-lookup"><span data-stu-id="66301-206">Once the conditions are identified, watchdog writers need to figure out the best way to monitor them for balance between overhead and usefulness.</span></span> <span data-ttu-id="66301-207">Prenons comme exemple un service qui effectue des calculs complexes qui utilisent des fichiers temporaires sur un partage.</span><span class="sxs-lookup"><span data-stu-id="66301-207">For example, consider a service that does complex calculations that use some temporary files on a share.</span></span> <span data-ttu-id="66301-208">Un agent de surveillance peut surveiller le partage pour s’assurer que l’espace disponible est suffisant.</span><span class="sxs-lookup"><span data-stu-id="66301-208">A watchdog could monitor the share to ensure that enough space is available.</span></span> <span data-ttu-id="66301-209">Il peut écouter les notifications relatives aux modifications de fichiers ou de répertoires.</span><span class="sxs-lookup"><span data-stu-id="66301-209">It could listen for notifications of file or directory changes.</span></span> <span data-ttu-id="66301-210">Il peut lancer un avertissement si un seuil initial est atteint, et signaler une erreur si le partage est plein.</span><span class="sxs-lookup"><span data-stu-id="66301-210">It could report a warning if an upfront threshold is reached, and report an error if the share is full.</span></span> <span data-ttu-id="66301-211">En cas d’avertissement, un système de réparation peut démarrer le nettoyage de fichiers plus anciens sur le partage.</span><span class="sxs-lookup"><span data-stu-id="66301-211">On a warning, a repair system could start cleaning up older files on the share.</span></span> <span data-ttu-id="66301-212">En cas d’erreur, un système de réparation peut déplacer le réplica de service vers un autre nœud.</span><span class="sxs-lookup"><span data-stu-id="66301-212">On an error, a repair system could move the service replica to another node.</span></span> <span data-ttu-id="66301-213">Notez la manière dont les états de condition sont décrits en termes d’intégrité, selon qu’ils peuvent être considérés comme sains (ok) ou défectueux (avertissement ou erreur).</span><span class="sxs-lookup"><span data-stu-id="66301-213">Note how the condition states are described in terms of health: the state of the condition that can be considered healthy (ok) or unhealthy (warning or error).</span></span>

<span data-ttu-id="66301-214">Une fois les détails de la surveillance définis, l’enregistreur de surveillance doit déterminer comment mettre en œuvre l’agent de surveillance.</span><span class="sxs-lookup"><span data-stu-id="66301-214">Once the monitoring details are set, a watchdog writer needs to figure out how to implement the watchdog.</span></span> <span data-ttu-id="66301-215">Si les conditions peuvent être déterminées à partir du service, l’agent de surveillance peut faire partie du service surveillé lui-même.</span><span class="sxs-lookup"><span data-stu-id="66301-215">If the conditions can be determined from within the service, the watchdog can be part of the monitored service itself.</span></span> <span data-ttu-id="66301-216">Par exemple, le code de service peut vérifier l’utilisation du partage, puis générer un rapport chaque fois qu’il tente d’écrire un fichier.</span><span class="sxs-lookup"><span data-stu-id="66301-216">For example, the service code can check the share usage, and then report every time it tries to write a file.</span></span> <span data-ttu-id="66301-217">L’avantage de cette approche est que la création de rapports est simple.</span><span class="sxs-lookup"><span data-stu-id="66301-217">The advantage of this approach is that reporting is simple.</span></span> <span data-ttu-id="66301-218">Vous devez cependant veiller à ce que des bogues de l’agent de surveillance n’affectent pas la fonctionnalité du service.</span><span class="sxs-lookup"><span data-stu-id="66301-218">Care must be taken to prevent watchdog bugs from impacting the service functionality.</span></span>

<span data-ttu-id="66301-219">La création de rapports depuis le service surveillé n’est pas toujours une option.</span><span class="sxs-lookup"><span data-stu-id="66301-219">Reporting from within the monitored service is not always an option.</span></span> <span data-ttu-id="66301-220">Il se peut qu’un agent de surveillance au sein du service ne soit pas en mesure de détecter les conditions.</span><span class="sxs-lookup"><span data-stu-id="66301-220">A watchdog within the service may not be able to detect the conditions.</span></span> <span data-ttu-id="66301-221">Il se peut qu’il ne dispose pas de la logique ou des données nécessaires pour les déterminer.</span><span class="sxs-lookup"><span data-stu-id="66301-221">It may not have the logic or data to make the determination.</span></span> <span data-ttu-id="66301-222">La surcharge résultant de la surveillance des conditions peut être élevée.</span><span class="sxs-lookup"><span data-stu-id="66301-222">The overhead of monitoring the conditions may be high.</span></span> <span data-ttu-id="66301-223">Il se peut également que les conditions ne soient pas spécifiques à un service, mais affectent des interactions entre services.</span><span class="sxs-lookup"><span data-stu-id="66301-223">The conditions also may not be specific to a service, but instead affect interactions between services.</span></span> <span data-ttu-id="66301-224">Une autre option consiste à disposer d’agents de surveillance dans le cluster en tant que processus distincts.</span><span class="sxs-lookup"><span data-stu-id="66301-224">Another option is to have watchdogs in the cluster as separate processes.</span></span> <span data-ttu-id="66301-225">Les agents de surveillance surveillent les conditions et créent des rapports, sans affecter les services principaux.</span><span class="sxs-lookup"><span data-stu-id="66301-225">The watchdogs monitor the conditions and report, without affecting the main services in any way.</span></span> <span data-ttu-id="66301-226">Par exemple, il est possible d’implémenter ces agents de surveillance en tant que services sans état dans la même application, déployés sur tous les nœuds ou sur les mêmes nœuds que le service.</span><span class="sxs-lookup"><span data-stu-id="66301-226">For example, these watchdogs could be implemented as stateless services in the same application, deployed on all nodes or on the same nodes as the service.</span></span>

<span data-ttu-id="66301-227">Parfois, un agent de surveillance s’exécutant dans le cluster n’est pas non plus une option.</span><span class="sxs-lookup"><span data-stu-id="66301-227">Sometimes, a watchdog running in the cluster is not an option either.</span></span> <span data-ttu-id="66301-228">Si la condition surveillée est la disponibilité ou la fonctionnalité du service telles que les utilisateurs les voient, il est préférable que les agents de surveillance se trouvent au même endroit que les clients de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="66301-228">If the monitored condition is the availability or functionality of the service as users see it, it's best to have the watchdogs in the same place as the user clients.</span></span> <span data-ttu-id="66301-229">Là, ils peuvent tester les opérations de la même façon que les utilisateurs les appellent.</span><span class="sxs-lookup"><span data-stu-id="66301-229">There, they can test the operations in the same way users call them.</span></span> <span data-ttu-id="66301-230">Par exemple, vous pouvez avoir un agent de surveillance situé en dehors du cluster, qui adresse des demandes au service et qui vérifie la latence et l’exactitude du résultat.</span><span class="sxs-lookup"><span data-stu-id="66301-230">For example, you can have a watchdog that lives outside the cluster, issues requests to the service, and checks the latency and correctness of the result.</span></span> <span data-ttu-id="66301-231">(Par exemple, pour un service de calculatrice, l’opération 2 + 2 retourne-t-elle 4 dans un délai raisonnable ?)</span><span class="sxs-lookup"><span data-stu-id="66301-231">(For a calculator service, for example, does 2+2 return 4 in a reasonable amount of time?)</span></span>

<span data-ttu-id="66301-232">Une fois les détails de l’agent de surveillance finalisés, vous devez choisir un ID source qui l’identifie de façon unique.</span><span class="sxs-lookup"><span data-stu-id="66301-232">Once the watchdog details have been finalized, you should decide on a source ID that uniquely identifies it.</span></span> <span data-ttu-id="66301-233">Si plusieurs agents de surveillance du même type résident dans le cluster, ils doivent générer des rapports sur des entités différentes ou, s’ils génèrent des rapports sur la même entité, ils doivent utiliser une propriété ou un ID source différent.</span><span class="sxs-lookup"><span data-stu-id="66301-233">If multiple watchdogs of the same type are living in the cluster, they must report on different entities, or, if they report on the same entity, use different source ID or property.</span></span> <span data-ttu-id="66301-234">De cette façon, leurs rapports peuvent coexister.</span><span class="sxs-lookup"><span data-stu-id="66301-234">This way, their reports can coexist.</span></span> <span data-ttu-id="66301-235">La propriété du rapport d’intégrité doit capturer la condition surveillée.</span><span class="sxs-lookup"><span data-stu-id="66301-235">The property of the health report should capture the monitored condition.</span></span> <span data-ttu-id="66301-236">(Par exemple, dans l’exemple ci-dessus, la propriété pourrait être **ShareSize**). Si plusieurs rapports s’appliquent à une même condition, la propriété doit contenir des informations dynamiques permettant la coexistence des rapports.</span><span class="sxs-lookup"><span data-stu-id="66301-236">(For the example above, the property could be **ShareSize**.) If multiple reports apply to the same condition, the property should contain some dynamic information that allows reports to coexist.</span></span> <span data-ttu-id="66301-237">Par exemple, si plusieurs partages doivent être surveillés, le nom de la propriété peut être **ShareSize-sharename**.</span><span class="sxs-lookup"><span data-stu-id="66301-237">For example, if multiple shares need to be monitored, the property name can be **ShareSize-sharename**.</span></span>

> [!NOTE]
> <span data-ttu-id="66301-238">Vous ne devez *pas* utiliser le magasin d’intégrité pour conserver les informations sur l’état.</span><span class="sxs-lookup"><span data-stu-id="66301-238">Do *not* use the health store to keep status information.</span></span> <span data-ttu-id="66301-239">Seules des informations liées à l’intégrité doivent être rapportées comme telles, car ces informations ont une incidence sur l’évaluation de l’intégrité d’une entité.</span><span class="sxs-lookup"><span data-stu-id="66301-239">Only health-related information should be reported as health, as this information impacts the health evaluation of an entity.</span></span> <span data-ttu-id="66301-240">Le magasin d’intégrité n’a pas été conçu en tant que magasin à usage général.</span><span class="sxs-lookup"><span data-stu-id="66301-240">The health store was not designed as a general-purpose store.</span></span> <span data-ttu-id="66301-241">Il utilise une logique d’évaluation de l’intégrité pour regrouper toutes les données dans l’état d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-241">It uses health evaluation logic to aggregate all data into the health state.</span></span> <span data-ttu-id="66301-242">Le fait d’envoyer des informations non liées à l’intégrité (par exemple, de signaler un statut avec l’état d’intégrité OK) n’a pas d’incidence sur l’état d’intégrité agrégé, mais peut nuire aux performances du magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-242">Sending information unrelated to health (like reporting status with a health state of OK) doesn't impact the aggregated health state, but it can negatively affect the performance of the health store.</span></span>
> 
> 

<span data-ttu-id="66301-243">La décision suivante a trait à l’entité sur laquelle générer le rapport.</span><span class="sxs-lookup"><span data-stu-id="66301-243">The next decision point is which entity to report on.</span></span> <span data-ttu-id="66301-244">La plupart du temps, la condition identifie clairement l’entité.</span><span class="sxs-lookup"><span data-stu-id="66301-244">Most of the time, the condition clearly idetifies the entity.</span></span> <span data-ttu-id="66301-245">Choisissez l’entité offrant la meilleure granularité possible.</span><span class="sxs-lookup"><span data-stu-id="66301-245">Choose the entity with best possible granularity.</span></span> <span data-ttu-id="66301-246">Si une condition a un impact sur tous les réplicas d’une partition, le rapport doit porter sur la partition, pas le service.</span><span class="sxs-lookup"><span data-stu-id="66301-246">If a condition impacts all replicas in a partition, report on the partition, not on the service.</span></span> <span data-ttu-id="66301-247">Il existe cependant des cas où une réflexion approfondie s’impose.</span><span class="sxs-lookup"><span data-stu-id="66301-247">There are corner cases where more thought is needed, though.</span></span> <span data-ttu-id="66301-248">Si la condition a une incidence sur une entité telle qu’un réplica, mais que vous souhaitez que la condition soit signalée pendant une durée supérieure à la durée de vie du réplica, elle doit être rapportée sur la partition.</span><span class="sxs-lookup"><span data-stu-id="66301-248">If the condition impacts an entity, such as a replica, but the desire is to have the condition flagged for more than the duration of replica life, then it should be reported on the partition.</span></span> <span data-ttu-id="66301-249">Dans le cas contraire, lorsque le réplica est supprimé, le magasin de contrôle d’intégrité nettoie tous ses rapports.</span><span class="sxs-lookup"><span data-stu-id="66301-249">Otherwise, when the replica is deleted, the health store cleans up all its reports.</span></span> <span data-ttu-id="66301-250">Les enregistreurs de surveillance doivent tenir compte des durées de vie de l’entité et du rapport.</span><span class="sxs-lookup"><span data-stu-id="66301-250">Watchdog writers must think about the lifetimes of the entity and the report.</span></span> <span data-ttu-id="66301-251">Le moment où un rapport doit être effacé d’un magasin doit être clair (par exemple, lorsqu’une erreur signalée sur une entité ne s’applique plus).</span><span class="sxs-lookup"><span data-stu-id="66301-251">It must be clear when a report should be cleaned up from a store (for example, when an error reported on an entity no longer applies).</span></span>

<span data-ttu-id="66301-252">Examinons un exemple qui réunit les points décrits ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="66301-252">Let's look at an example that puts together the points I described.</span></span> <span data-ttu-id="66301-253">Examinons une application Service Fabric composée d’un service maître persistant avec état et de services subordonnés sans état déployés sur tous les nœuds (un type de service secondaire par type de tâche).</span><span class="sxs-lookup"><span data-stu-id="66301-253">Consider a Service Fabric application composed of a master stateful persistent service and secondary stateless services deployed on all nodes (one secondary service type for each type of task).</span></span> <span data-ttu-id="66301-254">Le service maître dispose d’une file d’attente de traitement contenant des commandes que les services secondaires doivent exécuter.</span><span class="sxs-lookup"><span data-stu-id="66301-254">The master has a processing queue that contains commands to be executed by secondaries.</span></span> <span data-ttu-id="66301-255">Les services secondaires exécutent les demandes entrantes et renvoient des signaux d’accusé de réception.</span><span class="sxs-lookup"><span data-stu-id="66301-255">The secondaries execute the incoming requests and send back acknowledgement signals.</span></span> <span data-ttu-id="66301-256">Une condition qui peut être surveillée est la longueur de la file d’attente de traitement du service maître.</span><span class="sxs-lookup"><span data-stu-id="66301-256">One condition that could be monitored is the length of the master processing queue.</span></span> <span data-ttu-id="66301-257">Si la longueur de la file d’attente du service maître atteint un seuil, un avertissement est lancé.</span><span class="sxs-lookup"><span data-stu-id="66301-257">If the master queue length reaches a threshold, a warning is reported.</span></span> <span data-ttu-id="66301-258">Il indique que les services secondaires ne peuvent pas traiter la charge.</span><span class="sxs-lookup"><span data-stu-id="66301-258">The warning indicates that the secondaries can't handle the load.</span></span> <span data-ttu-id="66301-259">Si la file d’attente atteint la longueur maximale et que des commandes sont abandonnées, une erreur est signalée, car le service ne peut pas récupérer.</span><span class="sxs-lookup"><span data-stu-id="66301-259">If the queue reaches the maximum length and commands are dropped, an error is reported, as the service can't recover.</span></span> <span data-ttu-id="66301-260">Les rapports peuvent avoir trait à la propriété **QueueStatus**.</span><span class="sxs-lookup"><span data-stu-id="66301-260">The reports can be on the property **QueueStatus**.</span></span> <span data-ttu-id="66301-261">L’agent de surveillance opère à l’intérieur du service et il est envoyé régulièrement sur le réplica principal du service maître.</span><span class="sxs-lookup"><span data-stu-id="66301-261">The watchdog lives inside the service, and it's sent periodically on the master primary replica.</span></span> <span data-ttu-id="66301-262">La durée de vie est de deux minutes, et il est envoyé à intervalles réguliers de 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-262">The time to live is two minutes, and it's sent periodically every 30 seconds.</span></span> <span data-ttu-id="66301-263">Si le service principal tombe en panne, le rapport est effacé automatiquement du magasin.</span><span class="sxs-lookup"><span data-stu-id="66301-263">If the primary goes down, the report is cleaned up automatically from store.</span></span> <span data-ttu-id="66301-264">Si le réplica du service est actif, mais est bloqué ou rencontre d’autres problèmes, le rapport expire dans le magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-264">If the service replica is up, but it is deadlocked or having other issues, the report expires in the health store.</span></span> <span data-ttu-id="66301-265">Dans ce cas, l’entité est évaluée au moment de l’erreur.</span><span class="sxs-lookup"><span data-stu-id="66301-265">In this case, the entity is evaluated at error.</span></span>

<span data-ttu-id="66301-266">L’heure d’exécution de la tâche est une autre condition qui peut être surveillée.</span><span class="sxs-lookup"><span data-stu-id="66301-266">Another condition that can be monitored is task execution time.</span></span> <span data-ttu-id="66301-267">Le service maître distribue les tâches aux services secondaires en fonction du type de tâche.</span><span class="sxs-lookup"><span data-stu-id="66301-267">The master distributes tasks to the secondaries based on the task type.</span></span> <span data-ttu-id="66301-268">Selon la conception, le service maître peut interroger les services secondaires pour évaluer l’état de la tâche.</span><span class="sxs-lookup"><span data-stu-id="66301-268">Depending on the design, the master could poll the secondaries for task status.</span></span> <span data-ttu-id="66301-269">Il peut également attendre que les services secondaires renvoient des signaux d’accusé de réception quand ils ont terminé.</span><span class="sxs-lookup"><span data-stu-id="66301-269">It could also wait for secondaries to send back acknowledgement signals when they are done.</span></span> <span data-ttu-id="66301-270">Dans le deuxième cas, vous devez veiller à détecter les situations où des services secondaires périssent ou bien où des messages se perdent.</span><span class="sxs-lookup"><span data-stu-id="66301-270">In the second case, care must be taken to detect situations where secondaries die or messages are lost.</span></span> <span data-ttu-id="66301-271">Une option pour le service maître consiste à envoyer au même service secondaire une requête ping qui renvoie son état.</span><span class="sxs-lookup"><span data-stu-id="66301-271">One option is for the master to send a ping request to the same secondary, which sends back its status.</span></span> <span data-ttu-id="66301-272">Si le service maître ne reçoit aucun état, il considère qu’il s’agit d’un échec et replanifie la tâche.</span><span class="sxs-lookup"><span data-stu-id="66301-272">If no status is received, the master considers it a failure and reschedules the task.</span></span> <span data-ttu-id="66301-273">Ce comportement part du principe que les tâches sont idempotentes.</span><span class="sxs-lookup"><span data-stu-id="66301-273">This behavior assumes that the tasks are idempotent.</span></span>

<span data-ttu-id="66301-274">La condition surveillée peut être convertie en avertissement si la tâche n’est pas effectuée dans une période donnée (**t1**, par exemple 10 minutes).</span><span class="sxs-lookup"><span data-stu-id="66301-274">The monitored condition can be translated as a warning if the task is not done in a certain time (**t1**, for example 10 minutes).</span></span> <span data-ttu-id="66301-275">Si la tâche n’est pas terminée dans le temps (**t2**, par exemple 20 minutes), la condition surveillée peut être convertie en erreur.</span><span class="sxs-lookup"><span data-stu-id="66301-275">If the task is not completed in time (**t2**, for example 20 minutes), the monitored condition can be translated as Error.</span></span> <span data-ttu-id="66301-276">Cette création de rapport peut se faire de plusieurs façons :</span><span class="sxs-lookup"><span data-stu-id="66301-276">This reporting can be done in multiple ways:</span></span>

* <span data-ttu-id="66301-277">Le réplica principal du service maître génère régulièrement des rapports sur lui-même.</span><span class="sxs-lookup"><span data-stu-id="66301-277">The master primary replica reports on itself periodically.</span></span> <span data-ttu-id="66301-278">Il peut y avoir une propriété pour toutes les tâches en attente dans la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="66301-278">You can have one property for all pending tasks in the queue.</span></span> <span data-ttu-id="66301-279">Si au moins une tâche prend plus de temps, le statut du rapport sur la propriété **PendingTasks** est un avertissement ou une erreur, selon le cas.</span><span class="sxs-lookup"><span data-stu-id="66301-279">If at least one task takes longer, the report status on the property **PendingTasks** is a warning or error, as appropriate.</span></span> <span data-ttu-id="66301-280">Si aucune tâche n’est en attente ou si toutes les tâches ont démarré, le statut du rapport est OK.</span><span class="sxs-lookup"><span data-stu-id="66301-280">If there are no pending tasks or all tasks started execution, the report status is OK.</span></span> <span data-ttu-id="66301-281">Les tâches sont persistantes.</span><span class="sxs-lookup"><span data-stu-id="66301-281">The tasks are persistent.</span></span> <span data-ttu-id="66301-282">Ainsi, si le service principal s’arrête, le service principal qui lui succède peut continuer à générer des rapports correctement.</span><span class="sxs-lookup"><span data-stu-id="66301-282">If the primary goes down, the newly promoted primary can continue to report properly.</span></span>
* <span data-ttu-id="66301-283">Un autre processus de surveillance (dans le cloud ou externe) vérifie les tâches (de l’extérieur, en fonction du résultat souhaité de la tâche) pour voir si elles sont accomplies.</span><span class="sxs-lookup"><span data-stu-id="66301-283">Another watchdog process (in the cloud or external) checks the tasks (from outside, based on the desired task result) to see if they are completed.</span></span> <span data-ttu-id="66301-284">Si elles ne respectent pas les seuils, un rapport est envoyé sur le service maître.</span><span class="sxs-lookup"><span data-stu-id="66301-284">If they do not respect the thresholds, a report is sent on the master service.</span></span> <span data-ttu-id="66301-285">Un rapport est également envoyé sur chaque tâche. Il inclut l’identificateur de tâche (par exemple **PendingTask+Idtâche**).</span><span class="sxs-lookup"><span data-stu-id="66301-285">A report is also sent on each task that includes the task identifier, like **PendingTask+taskId**.</span></span> <span data-ttu-id="66301-286">Des rapports ne doivent être envoyés que sur des états défectueux.</span><span class="sxs-lookup"><span data-stu-id="66301-286">Reports should be sent only on unhealthy states.</span></span> <span data-ttu-id="66301-287">La valeur TTL est définie sur quelques minutes et les rapports à supprimer sont sélectionnés lorsqu’ils ont expiré, afin d’assurer le nettoyage.</span><span class="sxs-lookup"><span data-stu-id="66301-287">Set time to live to a few minutes, and mark the reports to be removed when they expire to ensure cleanup.</span></span>
* <span data-ttu-id="66301-288">Le service secondaire qui exécute une tâche génère un rapport lorsque l’exécution dure plus longtemps que prévu.</span><span class="sxs-lookup"><span data-stu-id="66301-288">The secondary that is executing a task reports when it takes longer than expected to run it.</span></span> <span data-ttu-id="66301-289">Il génère un rapport sur l’instance de service sur la propriété **PendingTasks**.</span><span class="sxs-lookup"><span data-stu-id="66301-289">It reports on the service instance on the property **PendingTasks**.</span></span> <span data-ttu-id="66301-290">Cela met en évidence l’instance de service qui présente des problèmes, mais ne capture pas la situation où l’instance meurt.</span><span class="sxs-lookup"><span data-stu-id="66301-290">The report pinpoints the service instance that has issues, but it doesn't capture the situation where the instance dies.</span></span> <span data-ttu-id="66301-291">Les rapports sont nettoyés à ce moment-là.</span><span class="sxs-lookup"><span data-stu-id="66301-291">The reports are cleaned up then.</span></span> <span data-ttu-id="66301-292">Il peut générer un rapport sur le service secondaire.</span><span class="sxs-lookup"><span data-stu-id="66301-292">It could report on the secondary service.</span></span> <span data-ttu-id="66301-293">Si le service secondaire achève la tâche, l’instance secondaire efface le rapport du magasin.</span><span class="sxs-lookup"><span data-stu-id="66301-293">If the secondary completes the task, the secondary instance clears the report from the store.</span></span> <span data-ttu-id="66301-294">Cela n’a pas pour effet de capturer la situation où le message d’accusé de réception est perdu et où la tâche n’est pas achevée du point de vue du service maître.</span><span class="sxs-lookup"><span data-stu-id="66301-294">The report doesn't capture the situation where the acknowledgement message is lost and the task is not finished from the master's point of view.</span></span>

<span data-ttu-id="66301-295">Quelle que soit la façon dont les rapports sont générés dans les cas décrits ci-dessus, ils sont capturés dans l’intégrité de l’application lors de l’évaluation de l’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-295">However the reporting is done in the cases described above, the reports are captured in application health when health is evaluated.</span></span>

## <a name="report-periodically-vs-on-transition"></a><span data-ttu-id="66301-296">Rapport régulier ou sur transition</span><span class="sxs-lookup"><span data-stu-id="66301-296">Report periodically vs. on transition</span></span>
<span data-ttu-id="66301-297">À l’aide du modèle de génération de rapports d’intégrité, les agents de surveillance peuvent envoyer des rapports régulièrement ou en cas de transition.</span><span class="sxs-lookup"><span data-stu-id="66301-297">By using the health reporting model, watchdogs can send reports periodically or on transitions.</span></span> <span data-ttu-id="66301-298">La méthode régulière est recommandée pour les rapports de surveillance, car le code est beaucoup plus simple et moins sujet aux erreurs.</span><span class="sxs-lookup"><span data-stu-id="66301-298">The recommended way for watchdog reporting is periodically, because the code is much simpler and less prone to errors.</span></span> <span data-ttu-id="66301-299">Les agents de surveillance doivent être aussi simples que possible pour éviter les bogues qui déclenchent des rapports incorrects.</span><span class="sxs-lookup"><span data-stu-id="66301-299">The watchdogs must strive to be as simple as possible to avoid bugs that trigger incorrect reports.</span></span> <span data-ttu-id="66301-300">Des rapport d’état *défectueux* incorrects ont une incidence sur les évaluations de l’intégrité et les scénarios basés sur l’intégrité, dont les mises à niveau.</span><span class="sxs-lookup"><span data-stu-id="66301-300">Incorrect *unhealthy* reports impact health evaluations and scenarios based on health, including upgrades.</span></span> <span data-ttu-id="66301-301">Des rapports d’état *sain* incorrects masquent d’éventuels problèmes dans le cluster, ce qui n’est pas souhaitable.</span><span class="sxs-lookup"><span data-stu-id="66301-301">Incorrect *healthy* reports hide issues in the cluster, which is not desired.</span></span>

<span data-ttu-id="66301-302">Pour la création de rapports réguliers, l’agent de surveillance peut être implémenté avec une minuterie.</span><span class="sxs-lookup"><span data-stu-id="66301-302">For periodic reporting, the watchdog can be implemented with a timer.</span></span> <span data-ttu-id="66301-303">Sur un rappel de la minuterie, l’agent de surveillance peut vérifier l’état et envoyer un rapport basé sur l’état actuel.</span><span class="sxs-lookup"><span data-stu-id="66301-303">On a timer callback, the watchdog can check the state and send a report based on the current state.</span></span> <span data-ttu-id="66301-304">Il est inutile de voir quel rapport a été envoyé précédemment ou d’opérer des optimisations en termes de messagerie.</span><span class="sxs-lookup"><span data-stu-id="66301-304">There is no need to see which report was sent previously or make any optimizations in terms of messaging.</span></span> <span data-ttu-id="66301-305">Le client de contrôle d’intégrité dispose de la logique de traitement par lot, qui permet d’améliorer les performances.</span><span class="sxs-lookup"><span data-stu-id="66301-305">The health client has batching logic to help with performance.</span></span> <span data-ttu-id="66301-306">Tant que le client de contrôle d’intégrité est actif, il réessaie en interne jusqu’à ce que le rapport soit reçu par le magasin d’intégrité ou que l’agent de surveillance crée un rapport plus récent avec une entité, une propriété et une source identiques.</span><span class="sxs-lookup"><span data-stu-id="66301-306">While the health client is kept alive, it retries internally until the report is acknowledged by the health store or the watchdog generates a newer report with the same entity, property, and source.</span></span>

<span data-ttu-id="66301-307">La génération de rapports sur les transitions nécessite une gestion prudente de l’état.</span><span class="sxs-lookup"><span data-stu-id="66301-307">Reporting on transitions requires careful handling of state.</span></span> <span data-ttu-id="66301-308">L’agent de surveillance surveille certaines conditions et génère un rapport uniquement quand les conditions changent.</span><span class="sxs-lookup"><span data-stu-id="66301-308">The watchdog monitors some conditions and reports only when the conditions change.</span></span> <span data-ttu-id="66301-309">Cette approche présente un avantage : un nombre moins important de rapports est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="66301-309">The upside of this approach is that fewer reports are needed.</span></span> <span data-ttu-id="66301-310">L’inconvénient est que la logique de l’agent de surveillance est complexe.</span><span class="sxs-lookup"><span data-stu-id="66301-310">The downside is that the logic of the watchdog is complex.</span></span> <span data-ttu-id="66301-311">L’agent de surveillance doit gérer mes conditions ou les rapports, afin qu’il soit possible de les inspecter pour déterminer les changements d’état.</span><span class="sxs-lookup"><span data-stu-id="66301-311">The watchdog must maintain the conditions or the reports, so that they can be inspected to determine state changes.</span></span> <span data-ttu-id="66301-312">Lors du basculement, une attention particulière doit être apportée aux rapports qui ont été ajoutés, mais n’ont pas encore été envoyés au magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-312">On failover, care must be taken with reports added, but not yet sent to the health store.</span></span> <span data-ttu-id="66301-313">Le numéro de séquence doit toujours être croissant.</span><span class="sxs-lookup"><span data-stu-id="66301-313">The sequence number must be ever-increasing.</span></span> <span data-ttu-id="66301-314">Si ce n’est pas le cas, les rapports sont rejetés comme périmés.</span><span class="sxs-lookup"><span data-stu-id="66301-314">If not, the reports are rejected as stale.</span></span> <span data-ttu-id="66301-315">Dans les rares cas où une perte de données se produit, une synchronisation peut être nécessaire entre l’état du rapporteur et l’état du magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-315">In the rare cases where data loss is incurred, synchronization may be needed between the state of the reporter and the state of the health store.</span></span>

<span data-ttu-id="66301-316">La création de rapports sur les transitions est fondée pour les services de création de rapports sur eux-mêmes, via `Partition` ou `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="66301-316">Reporting on transitions makes sense for services reporting on themselves, through `Partition` or `CodePackageActivationContext`.</span></span> <span data-ttu-id="66301-317">Lorsque l’objet local (réplica ou package de service déployé / application déployée) est supprimé, tous ses rapports sont également supprimés.</span><span class="sxs-lookup"><span data-stu-id="66301-317">When the local object (replica or deployed service package / deployed application) is removed, all its reports are also removed.</span></span> <span data-ttu-id="66301-318">Le nettoyage automatique assouplit la nécessité de synchronisation entre le rapporteur et le magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-318">This automatic cleanup relaxes the need for synchronization between reporter and health store.</span></span> <span data-ttu-id="66301-319">Si le rapport concerne la partition parente ou l’application parente, surveillez le basculement afin d’éviter les rapports obsolètes dans le magasin d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-319">If the report is for parent partition or parent application, care must be taken on failover to avoid stale reports in the health store.</span></span> <span data-ttu-id="66301-320">Une logique doit être ajoutée pour maintenir l’état correct et le rapport doit être supprimé du magasin lorsqu’il est devenu inutile.</span><span class="sxs-lookup"><span data-stu-id="66301-320">Logic must be added to maintain the correct state and clear the report from store when not needed anymore.</span></span>

## <a name="implement-health-reporting"></a><span data-ttu-id="66301-321">Mise en œuvre de la création de rapports d’intégrité</span><span class="sxs-lookup"><span data-stu-id="66301-321">Implement health reporting</span></span>
<span data-ttu-id="66301-322">Une fois que les détails de l’entité et du rapport sont clairs, l’envoi de rapports d’intégrité peut se faire via l’API, Powershell ou REST.</span><span class="sxs-lookup"><span data-stu-id="66301-322">Once the entity and report details are clear, sending health reports can be done through the API, PowerShell, or REST.</span></span>

### <a name="api"></a><span data-ttu-id="66301-323">API</span><span class="sxs-lookup"><span data-stu-id="66301-323">API</span></span>
<span data-ttu-id="66301-324">Pour générer un rapport via l’API, vous devez créer un rapport d’intégrité spécifique au type d’entité sur laquelle ils veulent générer un rapport.</span><span class="sxs-lookup"><span data-stu-id="66301-324">To report through the API, you need to create a health report specific to the entity type they want to report on.</span></span> <span data-ttu-id="66301-325">Fournissez le rapport à un client de contrôle d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-325">Give the report to a health client.</span></span> <span data-ttu-id="66301-326">Vous pouvez également créer des informations sur l’intégrité et les transmettre aux méthodes de création de rapports correctes sur `Partition` ou `CodePackageActivationContext` pour créer un rapport sur les entités en cours.</span><span class="sxs-lookup"><span data-stu-id="66301-326">Alternatively, create a health information and pass it to correct reporting methods on `Partition` or `CodePackageActivationContext` to report on current entities.</span></span>

<span data-ttu-id="66301-327">L’exemple suivant illustre une génération de rapport périodique à partir d’un agent de surveillance dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="66301-327">The following example shows periodic reporting from a watchdog within the cluster.</span></span> <span data-ttu-id="66301-328">L’agent de surveillance vérifie si une ressource externe est accessible à partir d’un nœud.</span><span class="sxs-lookup"><span data-stu-id="66301-328">The watchdog checks whether an external resource can be accessed from within a node.</span></span> <span data-ttu-id="66301-329">La ressource est requise par un manifeste de service au sein de l’application.</span><span class="sxs-lookup"><span data-stu-id="66301-329">The resource is needed by a service manifest within the application.</span></span> <span data-ttu-id="66301-330">Si la ressource n’est pas disponible, les autres services au sein de l’application peuvent encore fonctionner correctement.</span><span class="sxs-lookup"><span data-stu-id="66301-330">If the resource is unavailable, the other services within the application can still function properly.</span></span> <span data-ttu-id="66301-331">Par conséquent, le rapport est envoyé sur l’entité du package de services déployé toutes les 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="66301-331">Therefore, the report is sent on the deployed service package entity every 30 seconds.</span></span>

```csharp
private static Uri ApplicationName = new Uri("fabric:/WordCount");
private static string ServiceManifestName = "WordCount.Service";
private static string NodeName = FabricRuntime.GetNodeContext().NodeName;
private static Timer ReportTimer = new Timer(new TimerCallback(SendReport), null, 30 * 1000, 30 * 1000);
private static FabricClient Client = new FabricClient(new FabricClientSettings() { HealthReportSendInterval = TimeSpan.FromSeconds(0) });

public static void SendReport(object obj)
{
    // Test whether the resource can be accessed from the node
    HealthState healthState = this.TestConnectivityToExternalResource();

    // Send report on deployed service package, as the connectivity is needed by the specific service manifest
    // and can be different on different nodes
    var deployedServicePackageHealthReport = new DeployedServicePackageHealthReport(
        ApplicationName,
        ServiceManifestName,
        NodeName,
        new HealthInformation("ExternalSourceWatcher", "Connectivity", healthState));

    // TODO: handle exception. Code omitted for snippet brevity.
    // Possible exceptions: FabricException with error codes
    // FabricHealthStaleReport (non-retryable, the report is already queued on the health client),
    // FabricHealthMaxReportsReached (retryable; user should retry with exponential delay until the report is accepted).
    Client.HealthManager.ReportHealth(deployedServicePackageHealthReport);
}
```

### <a name="powershell"></a><span data-ttu-id="66301-332">PowerShell</span><span class="sxs-lookup"><span data-stu-id="66301-332">PowerShell</span></span>
<span data-ttu-id="66301-333">Envoyez les rapports d’intégrité avec **Send-ServiceFabric*EntityType*HealthReport**.</span><span class="sxs-lookup"><span data-stu-id="66301-333">Send health reports with **Send-ServiceFabric*EntityType*HealthReport**.</span></span>

<span data-ttu-id="66301-334">L’exemple suivant montre la création de rapports réguliers sur les valeurs du processeur sur un nœud.</span><span class="sxs-lookup"><span data-stu-id="66301-334">The following example shows periodic reporting on CPU values on a node.</span></span> <span data-ttu-id="66301-335">Les rapports doivent être envoyés toutes les 30 secondes, et ont une durée de vie de deux minutes.</span><span class="sxs-lookup"><span data-stu-id="66301-335">The reports should be sent every 30 seconds, and they have a time to live of two minutes.</span></span> <span data-ttu-id="66301-336">S’ils expirent, cela signifie que le rapporteur rencontre des problèmes, et le nœud est évalué au moment de l’erreur.</span><span class="sxs-lookup"><span data-stu-id="66301-336">If they expire, the reporter has issues, so the node is evaluated at error.</span></span> <span data-ttu-id="66301-337">Quand l’utilisation du processeur dépasse un seuil, le rapport a un état d’avertissement.</span><span class="sxs-lookup"><span data-stu-id="66301-337">When the CPU is above a threshold, the report has a health state of warning.</span></span> <span data-ttu-id="66301-338">Quand l’utilisation du processeur reste supérieure à un seuil plus longtemps que le délai configuré, une erreur est rapportée.</span><span class="sxs-lookup"><span data-stu-id="66301-338">When the CPU remains above a threshold for more than the configured time, it's reported as an error.</span></span> <span data-ttu-id="66301-339">Autrement, le rapporteur envoie un état d’intégrité OK.</span><span class="sxs-lookup"><span data-stu-id="66301-339">Otherwise, the reporter sends a health state of OK.</span></span>

```powershell
PS C:\> Send-ServiceFabricNodeHealthReport -NodeName Node.1 -HealthState Warning -SourceId PowershellWatcher -HealthProperty CPU -Description "CPU is above 80% threshold" -TimeToLiveSec 120

PS C:\> Get-ServiceFabricNodeHealth -NodeName Node.1
NodeName              : Node.1
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='CPU', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.FM
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 5
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Fabric node is up.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : CPU
                        HealthState           : Warning
                        SequenceNumber        : 130741236814913394
                        SentAt                : 4/21/2015 9:01:21 PM
                        ReceivedAt            : 4/21/2015 9:01:21 PM
                        TTL                   : 00:02:00
                        Description           : CPU is above 80% threshold
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:01:21 PM
```

<span data-ttu-id="66301-340">L’exemple suivant rapporte un avertissement temporaire sur un réplica.</span><span class="sxs-lookup"><span data-stu-id="66301-340">The following example reports a transient warning on a replica.</span></span> <span data-ttu-id="66301-341">Il obtient d’abord l’ID de partition, puis l’ID de réplica pour le service qui l’intéresse.</span><span class="sxs-lookup"><span data-stu-id="66301-341">It first gets the partition ID and then the replica ID for the service it is interested in.</span></span> <span data-ttu-id="66301-342">Il envoie ensuite un rapport à partir de **PowershellWatcher** sur la propriété **ResourceDependency**.</span><span class="sxs-lookup"><span data-stu-id="66301-342">It then sends a report from **PowershellWatcher** on the property **ResourceDependency**.</span></span> <span data-ttu-id="66301-343">Le rapport n’est utile que pendant deux minutes. Ensuite, il est automatiquement supprimé du magasin.</span><span class="sxs-lookup"><span data-stu-id="66301-343">The report is of interest for only two minutes, and it is removed from the store automatically.</span></span>

```powershell
PS C:\> $partitionId = (Get-ServiceFabricPartition -ServiceName fabric:/WordCount/WordCount.Service).PartitionId

PS C:\> $replicaId = (Get-ServiceFabricReplica -PartitionId $partitionId | where {$_.ReplicaRole -eq "Primary"}).ReplicaId

PS C:\> Send-ServiceFabricReplicaHealthReport -PartitionId $partitionId -ReplicaId $replicaId -HealthState Warning -SourceId PowershellWatcher -HealthProperty ResourceDependency -Description "The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes." -TimeToLiveSec 120 -RemoveWhenExpired

PS C:\> Get-ServiceFabricReplicaHealth  -PartitionId $partitionId -ReplicaOrInstanceId $replicaId


PartitionId           : 8f82daff-eb68-4fd9-b631-7a37629e08c0
ReplicaId             : 130740415594605869
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='ResourceDependency', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.RA
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 130740768777734943
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Replica has been created.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : ResourceDependency
                        HealthState           : Warning
                        SequenceNumber        : 130741243777723555
                        SentAt                : 4/21/2015 9:12:57 PM
                        ReceivedAt            : 4/21/2015 9:12:57 PM
                        TTL                   : 00:02:00
                        Description           : The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes.
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:12:32 PM
```

### <a name="rest"></a><span data-ttu-id="66301-344">REST</span><span class="sxs-lookup"><span data-stu-id="66301-344">REST</span></span>
<span data-ttu-id="66301-345">Envoyez des rapports d’intégrité à l’aide de REST, avec les demandes POST accédant à l’entité choisie et dont le corps présente une description du rapport d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="66301-345">Send health reports using REST with POST requests that go to the desired entity and have in the body the health report description.</span></span> <span data-ttu-id="66301-346">Par exemple, découvrez comment envoyer des [rapports REST sur l’intégrité du cluster](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) ou des [rapports REST sur l’intégrité du service](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service).</span><span class="sxs-lookup"><span data-stu-id="66301-346">For example, see how to send REST [cluster health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) or [service health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service).</span></span> <span data-ttu-id="66301-347">Toutes les entités sont prises en charge.</span><span class="sxs-lookup"><span data-stu-id="66301-347">All entities are supported.</span></span>

## <a name="next-steps"></a><span data-ttu-id="66301-348">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="66301-348">Next steps</span></span>
<span data-ttu-id="66301-349">Grâce aux données d’intégrité, les enregistreurs de service et les administrateurs de cluster/d’application peuvent réfléchir à des façons de consommer les informations.</span><span class="sxs-lookup"><span data-stu-id="66301-349">Based on the health data, service writers and cluster/application administrators can think of ways to consume the information.</span></span> <span data-ttu-id="66301-350">Par exemple, ils peuvent configurer des alertes basées sur l’état d’intégrité pour intercepter des problèmes graves avant qu’ils provoquent des pannes.</span><span class="sxs-lookup"><span data-stu-id="66301-350">For example, they can set up alerts based on health status to catch severe issues before they provoke outages.</span></span> <span data-ttu-id="66301-351">Les administrateurs peuvent également configurer des systèmes de réparation pour résoudre les problèmes automatiquement.</span><span class="sxs-lookup"><span data-stu-id="66301-351">Administrators can also set up repair systems to fix issues automatically.</span></span>

[<span data-ttu-id="66301-352">Présentation du contrôle d’intégrité de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="66301-352">Introduction to Service Fabric health Monitoring</span></span>](service-fabric-health-introduction.md)

[<span data-ttu-id="66301-353">Affichage rapports d’intégrité de Service Fabric</span><span class="sxs-lookup"><span data-stu-id="66301-353">View Service Fabric health reports</span></span>](service-fabric-view-entities-aggregated-health.md)

[<span data-ttu-id="66301-354">Comment signaler et contrôler l’intégrité du service</span><span class="sxs-lookup"><span data-stu-id="66301-354">How to report and check service health</span></span>](service-fabric-diagnostics-how-to-report-and-check-service-health.md)

[<span data-ttu-id="66301-355">Utilisation des rapports d’intégrité système pour la résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="66301-355">Use system health reports for troubleshooting</span></span>](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[<span data-ttu-id="66301-356">Surveiller et diagnostiquer les services localement</span><span class="sxs-lookup"><span data-stu-id="66301-356">Monitor and diagnose services locally</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[<span data-ttu-id="66301-357">Mise à niveau des applications Service Fabric</span><span class="sxs-lookup"><span data-stu-id="66301-357">Service Fabric application upgrade</span></span>](service-fabric-application-upgrade.md)

