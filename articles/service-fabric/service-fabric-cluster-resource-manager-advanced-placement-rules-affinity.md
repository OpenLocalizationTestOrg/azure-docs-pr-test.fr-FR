---
title: "aaaService Gestionnaire de ressources de Cluster de l’ensemble fibre optique - affinité | Documents Microsoft"
description: "Présentation de la configuration de l’affinité pour les services Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 7dc9b6d9c18d9d615d39cff7de9d7cba1c040474
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="78775-103">Configuration et utilisation de l’affinité de service dans Service Fabric</span><span class="sxs-lookup"><span data-stu-id="78775-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="78775-104">Affinité est un contrôle qui est fourni principalement toohelp facilité hello transition de grandes applications monolithiques dans le cloud et microservices Bonjour.</span><span class="sxs-lookup"><span data-stu-id="78775-104">Affinity is a control that is provided mainly toohelp ease hello transition of larger monolithic applications into hello cloud and microservices world.</span></span> <span data-ttu-id="78775-105">Il est également utilisé en guise d’optimisation pour améliorer les performances de hello de services, bien que cela peut avoir les effets secondaires.</span><span class="sxs-lookup"><span data-stu-id="78775-105">It is also used as an optimization for improving hello performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="78775-106">Supposons que vous importez une application plus volumineuse ou avec un uniquement n’a pas été conçue avec microservices dans l’esprit, tooService Fabric (ou n’importe quel environnement distribué).</span><span class="sxs-lookup"><span data-stu-id="78775-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, tooService Fabric (or any distributed environment).</span></span> <span data-ttu-id="78775-107">Ce type de transition est courant.</span><span class="sxs-lookup"><span data-stu-id="78775-107">This type of transition is common.</span></span> <span data-ttu-id="78775-108">Vous commencez par levage hello ensemble de votre application dans un environnement de hello, empaqueter et s’assurer qu’il fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="78775-108">You start by lifting hello entire app into hello environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="78775-109">Puis vous démarrez avec rupture dans différents services plus petits que tous les contacter tooeach autres.</span><span class="sxs-lookup"><span data-stu-id="78775-109">Then you start breaking it down into different smaller services that all talk tooeach other.</span></span>

<span data-ttu-id="78775-110">Par la suite, vous pouvez constater qu’application hello rencontrent des problèmes.</span><span class="sxs-lookup"><span data-stu-id="78775-110">Eventually you may find that hello application is experiencing some issues.</span></span> <span data-ttu-id="78775-111">problèmes de Hello appartiennent généralement à une de ces catégories :</span><span class="sxs-lookup"><span data-stu-id="78775-111">hello issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="78775-112">Quelques composants X, dans l’application monolithique hello avait une dépendance non documentée sur le composant Y, et vous avez activé uniquement les composants en services distincts.</span><span class="sxs-lookup"><span data-stu-id="78775-112">Some component X in hello monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="78775-113">Étant donné que ces services sont en cours d’exécution sur différents nœuds dans un cluster de hello, ils sont rompus.</span><span class="sxs-lookup"><span data-stu-id="78775-113">Since these services are now running on different nodes in hello cluster, they're broken.</span></span>
2. <span data-ttu-id="78775-114">Ces composants communiquent (canaux nommés locaux | mémoire partagée | fichiers sur le disque) et ils ont vraiment besoin toobe toowrite en mesure de la ressource locale tooa partagé pour des raisons de performances dès maintenant.</span><span class="sxs-lookup"><span data-stu-id="78775-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need toobe able toowrite tooa shared local resource for performance reasons right now.</span></span> <span data-ttu-id="78775-115">Cette dépendance ferme est éventuellement supprimée ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="78775-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="78775-116">Tout fonctionne correctement, sauf que ces deux composants sont en fait très occupés et sensibles aux performances.</span><span class="sxs-lookup"><span data-stu-id="78775-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="78775-117">Lorsqu’ils sont transférés dans des services distincts, la performance globale des applications diminue ou la latence augmente.</span><span class="sxs-lookup"><span data-stu-id="78775-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="78775-118">Par conséquent, hello globales de l’application ne répond pas aux attentes.</span><span class="sxs-lookup"><span data-stu-id="78775-118">As a result, hello overall application is not meeting expectations.</span></span>

<span data-ttu-id="78775-119">Dans ce cas, nous ne voulez toolose notre travail de refactorisation ou non toogo toohello arrière monolithique.</span><span class="sxs-lookup"><span data-stu-id="78775-119">In these cases, we don’t want toolose our refactoring work, and don’t want toogo back toohello monolith.</span></span> <span data-ttu-id="78775-120">Hello dernière condition peut même être souhaitable, dans une optimisation simple.</span><span class="sxs-lookup"><span data-stu-id="78775-120">hello last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="78775-121">Toutefois, jusqu'à ce que nous pouvons reconcevoir hello composants toowork naturellement en tant que services (ou jusqu'à ce que nous pouvons résoudre une autre façon les attentes de performance hello) nous allons tooneed un sens de la localité.</span><span class="sxs-lookup"><span data-stu-id="78775-121">However, until we can redesign hello components toowork naturally as services (or until we can solve hello performance expectations some other way) we're going tooneed some sense of locality.</span></span>

<span data-ttu-id="78775-122">Le toodo ?</span><span class="sxs-lookup"><span data-stu-id="78775-122">What toodo?</span></span> <span data-ttu-id="78775-123">Il est possible d’activer l’affinité.</span><span class="sxs-lookup"><span data-stu-id="78775-123">Well, you could try turning on affinity.</span></span>

## <a name="how-tooconfigure-affinity"></a><span data-ttu-id="78775-124">Comment les affinités tooconfigure</span><span class="sxs-lookup"><span data-stu-id="78775-124">How tooconfigure affinity</span></span>
<span data-ttu-id="78775-125">tooset une affinité, vous définissez une relation d’affinité entre deux services.</span><span class="sxs-lookup"><span data-stu-id="78775-125">tooset up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="78775-126">Cela revient à faire pointer un service sur un autre, ce qui fait qu’un service peut uniquement fonctionner quand cet autre service est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="78775-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="78775-127">Nous appelons parfois tooaffinity une relation parent/enfant (où vous pointez les enfants hello au parent de hello).</span><span class="sxs-lookup"><span data-stu-id="78775-127">Sometimes we refer tooaffinity as a parent/child relationship (where you point hello child at hello parent).</span></span> <span data-ttu-id="78775-128">Affinité garantit que les réplicas hello ou instances d’un service sont placés sur hello même nœuds en tant que ceux d’un autre service.</span><span class="sxs-lookup"><span data-stu-id="78775-128">Affinity ensures that hello replicas or instances of one service are placed on hello same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="78775-129">Un service enfant ne peut participer qu’à une seule relation d’affinité.</span><span class="sxs-lookup"><span data-stu-id="78775-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="78775-130">Si vous souhaitiez hello enfant toobe d’affinité tootwo parent services à la fois, vous avez deux options :</span><span class="sxs-lookup"><span data-stu-id="78775-130">If you wanted hello child toobe affinitized tootwo parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="78775-131">Inverser les relations hello (avoir parentService1 et parentService2 point au niveau de service d’enfants actuelle hello), ou</span><span class="sxs-lookup"><span data-stu-id="78775-131">Reverse hello relationships (have parentService1 and parentService2 point at hello current child service), or</span></span>
> - <span data-ttu-id="78775-132">Un des parents de hello désigner comme un concentrateur, par convention et avoir tous les services pointent vers ce service.</span><span class="sxs-lookup"><span data-stu-id="78775-132">Designate one of hello parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="78775-133">Hello, ce qui entraîne le comportement de placement dans un cluster de hello doit être hello même.</span><span class="sxs-lookup"><span data-stu-id="78775-133">hello resulting placement behavior in hello cluster should be hello same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="78775-134">Différentes options d’affinité</span><span class="sxs-lookup"><span data-stu-id="78775-134">Different affinity options</span></span>
<span data-ttu-id="78775-135">L’affinité est représentée par un des jeux de corrélations et comporte deux modes différents.</span><span class="sxs-lookup"><span data-stu-id="78775-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="78775-136">Hello le mode courants d’affinité est ce que nous appelons NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="78775-136">hello most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="78775-137">Dans NonAlignedAffinity, hello réplicas ou les instances de services différents de hello sont placés sur hello même nœuds.</span><span class="sxs-lookup"><span data-stu-id="78775-137">In NonAlignedAffinity, hello replicas or instances of hello different services are placed on hello same nodes.</span></span> <span data-ttu-id="78775-138">Bonjour autre mode est AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="78775-138">hello other mode is AlignedAffinity.</span></span> <span data-ttu-id="78775-139">L’affinité alignée est utilisée uniquement avec les services avec état.</span><span class="sxs-lookup"><span data-stu-id="78775-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="78775-140">Configuration dynamique de deux services toohave aligné affinité garantit qu’indistinctement hello de ces services est placés sur hello mêmes nœuds les uns des autres.</span><span class="sxs-lookup"><span data-stu-id="78775-140">Configuring two stateful services toohave aligned affinity ensures that hello primaries of those services are placed on hello same nodes as each other.</span></span> <span data-ttu-id="78775-141">Il est également générée chaque paire de bases de données secondaires pour ces toobe services placé sur hello même nœuds.</span><span class="sxs-lookup"><span data-stu-id="78775-141">It also causes each pair of secondaries for those services toobe placed on hello same nodes.</span></span> <span data-ttu-id="78775-142">Il est également possible (bien que moins fréquent) tooconfigure NonAlignedAffinity pour les services avec état.</span><span class="sxs-lookup"><span data-stu-id="78775-142">It is also possible (though less common) tooconfigure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="78775-143">Pour NonAlignedAffinity, différents réplicas de hello Hello deux services avec état s’exécuterait sur hello mêmes nœuds, mais leurs couleurs primaires peuvent se retrouver sur différents nœuds.</span><span class="sxs-lookup"><span data-stu-id="78775-143">For NonAlignedAffinity, hello different replicas of hello two stateful services would run on hello same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="78775-144"><center>
![Modes d’affinité et leurs effets][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="78775-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="78775-145">Meilleur état souhaité</span><span class="sxs-lookup"><span data-stu-id="78775-145">Best effort desired state</span></span>
<span data-ttu-id="78775-146">Une relation d’affinité est conseillée.</span><span class="sxs-lookup"><span data-stu-id="78775-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="78775-147">Il ne fournit pas hello mêmes garanties de fiabilité qui est en cours d’exécution dans hello même processus exécutable ou de colocalisation.</span><span class="sxs-lookup"><span data-stu-id="78775-147">It does not provide hello same guarantees of collocation or reliability that running in hello same executable process does.</span></span> <span data-ttu-id="78775-148">services Hello dans une relation d’affinité sont fondamentalement différentes entités peuvent échouer et être déplacées séparément.</span><span class="sxs-lookup"><span data-stu-id="78775-148">hello services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="78775-149">Une relation d’affinité peut également être interrompue, bien que ces interruptions soient temporaires.</span><span class="sxs-lookup"><span data-stu-id="78775-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="78775-150">Par exemple, les limites de capacité peuvent signifier que seules certaines hello des objets de service dans la relation d’affinité hello peuvent tenir sur un nœud donné.</span><span class="sxs-lookup"><span data-stu-id="78775-150">For example, capacity limitations may mean that only some of hello service objects in hello affinity relationship can fit on a given node.</span></span> <span data-ttu-id="78775-151">Dans ces cas même s’il existe une relation d’affinité sur place, il ne peut pas être appliquée échéance toohello autres contraintes.</span><span class="sxs-lookup"><span data-stu-id="78775-151">In these cases even though there's an affinity relationship in place, it can't be enforced due toohello other constraints.</span></span> <span data-ttu-id="78775-152">S’il est donc possible toodo, violation de hello est corrigée automatiquement plus tard.</span><span class="sxs-lookup"><span data-stu-id="78775-152">If it is possible toodo so, hello violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="78775-153">Chaînes et étoiles</span><span class="sxs-lookup"><span data-stu-id="78775-153">Chains vs. stars</span></span>
<span data-ttu-id="78775-154">Aujourd'hui, hello Gestionnaire de ressources du Cluster n’est pas toomodel en mesure des chaînes de relations d’affinité.</span><span class="sxs-lookup"><span data-stu-id="78775-154">Today hello Cluster Resource Manager isn't able toomodel chains of affinity relationships.</span></span> <span data-ttu-id="78775-155">Cela signifie qu’un service qui est un service enfant dans une relation d’affinité ne peut pas être un parent dans une autre relation d’affinité.</span><span class="sxs-lookup"><span data-stu-id="78775-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="78775-156">Si vous souhaitez toomodel ce type de relation, vous disposez effectivement toomodel comme une étoile, plutôt qu’une chaîne.</span><span class="sxs-lookup"><span data-stu-id="78775-156">If you want toomodel this type of relationship, you effectively have toomodel it as a star, rather than a chain.</span></span> <span data-ttu-id="78775-157">toomove à partir d’une étoile tooa chaîne, les enfants plus bas hello serait parent du toohello apparenté premier enfant à la place.</span><span class="sxs-lookup"><span data-stu-id="78775-157">toomove from a chain tooa star, hello bottommost child would be parented toohello first child’s parent instead.</span></span> <span data-ttu-id="78775-158">Selon la disposition de hello de vos services, vous avez peut-être toodo cette opération plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="78775-158">Depending on hello arrangement of your services, you may have toodo this multiple times.</span></span> <span data-ttu-id="78775-159">S’il n’existe aucun service parent naturel, vous avez peut-être toocreate qui sert d’espace réservé.</span><span class="sxs-lookup"><span data-stu-id="78775-159">If there's no natural parent service, you may have toocreate one that serves as a placeholder.</span></span> <span data-ttu-id="78775-160">Selon vos besoins, vous pouvez également toolook dans [groupes d’applications](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="78775-160">Depending on your requirements, you may also want toolook into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="78775-161"><center>
![Chaînes et Étoiles dans le contexte des relations d’affinité de hello][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="78775-161"><center>
![Chains vs. Stars in hello Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="78775-162">Aujourd'hui, un autre chose toonote, sur les relations d’affinité est qu’ils sont directionnelles.</span><span class="sxs-lookup"><span data-stu-id="78775-162">Another thing toonote about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="78775-163">Cela signifie que cette règle d’affinité hello applique uniquement cet enfant hello placé avec le parent de hello.</span><span class="sxs-lookup"><span data-stu-id="78775-163">This means that hello affinity rule only enforces that hello child placed with hello parent.</span></span> <span data-ttu-id="78775-164">Il ne garantit pas le que parent hello se trouve avec les enfants hello.</span><span class="sxs-lookup"><span data-stu-id="78775-164">It does not ensure that hello parent is located with hello child.</span></span> <span data-ttu-id="78775-165">Il est également important toonote qui hello relation d’affinité ne peut pas être idéal ou instantanément appliquée, car les différents services ont des différents cycles de vie et peuvent échouer et déplacer indépendamment.</span><span class="sxs-lookup"><span data-stu-id="78775-165">It is also important toonote that hello affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="78775-166">Par exemple, supposons que parent de hello subit une défaillance sur le nœud de tooanother, car il est arrêté anormalement.</span><span class="sxs-lookup"><span data-stu-id="78775-166">For example, let's say hello parent suddenly fails over tooanother node because it crashed.</span></span> <span data-ttu-id="78775-167">Hello Gestionnaire de ressources du Cluster et le handle du Gestionnaire de basculement hello tout d’abord, le basculement en conservant les services hello, cohérente et disponibles étant priorité de hello.</span><span class="sxs-lookup"><span data-stu-id="78775-167">hello Cluster Resource Manager and Failover Manager handle hello failover first, since keeping hello services up, consistent, and available is hello priority.</span></span> <span data-ttu-id="78775-168">Une fois le basculement de hello se termine, relation d’affinité hello est interrompue, mais hello Gestionnaire de ressources du Cluster pense que tout se passe bien jusqu'à ce qu’il remarque que les enfants hello n’est pas situé sur le parent de hello.</span><span class="sxs-lookup"><span data-stu-id="78775-168">Once hello failover completes, hello affinity relationship is broken, but hello Cluster Resource Manager thinks everything is fine until it notices that hello child is not located with hello parent.</span></span> <span data-ttu-id="78775-169">Ces types de vérifications sont effectuées régulièrement.</span><span class="sxs-lookup"><span data-stu-id="78775-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="78775-170">Vous trouverez plus d’informations sur comment hello Gestionnaire de ressources du Cluster évalue les contraintes dans [cet article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), et [celle-ci](service-fabric-cluster-resource-manager-balancing.md) présente plus en détail comment tooconfigure hello cadence à laquelle ces contraintes sont évaluée.</span><span class="sxs-lookup"><span data-stu-id="78775-170">More information on how hello Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how tooconfigure hello cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="78775-171">Prise en charge du partitionnement</span><span class="sxs-lookup"><span data-stu-id="78775-171">Partitioning support</span></span>
<span data-ttu-id="78775-172">toonotice de dernière chose Hello sur l’affinité est que les relations d’affinité ne sont pas pris en charge où le parent de hello est partitionnée.</span><span class="sxs-lookup"><span data-stu-id="78775-172">hello final thing toonotice about affinity is that affinity relationships aren’t supported where hello parent is partitioned.</span></span> <span data-ttu-id="78775-173">Des services parent partitionnés peuvent être pris en charge par la suite, mais cela n’est pas autorisé à l’heure actuelle.</span><span class="sxs-lookup"><span data-stu-id="78775-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="78775-174">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="78775-174">Next steps</span></span>
- <span data-ttu-id="78775-175">Pour plus d’informations sur la configuration des services, consultez la rubrique [En savoir plus sur la configuration des services](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="78775-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="78775-176">services de toolimit tooa un petit ensemble d’ordinateurs ou d’agrégation charge hello de services, utilisez [groupes d’applications](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="78775-176">toolimit services tooa small set of machines or aggregating hello load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png