---
title: "Cluster Resource Manager Service Fabric - Affinité | Microsoft Docs"
description: "Présentation de la configuration de l’affinité pour les services Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 3efda4ee4016245668e5da431d7b8868a21c790e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="2ebea-103">Configuration et utilisation de l’affinité de service dans Service Fabric</span><span class="sxs-lookup"><span data-stu-id="2ebea-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="2ebea-104">L’affinité est un contrôle qui permet principalement de faciliter la transition d’applications volumineuses monolithiques vers le cloud et les microservices.</span><span class="sxs-lookup"><span data-stu-id="2ebea-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span></span> <span data-ttu-id="2ebea-105">Elle peut également servir pour améliorer les performances des services, même si cela peut avoir des conséquences.</span><span class="sxs-lookup"><span data-stu-id="2ebea-105">It is also used as an optimization for improving the performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="2ebea-106">Prenons un exemple : vous importez une application volumineuse ou qui n’a pas été conçue pour les microservices dans Service Fabric (ou tout environnement distribué).</span><span class="sxs-lookup"><span data-stu-id="2ebea-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric (or any distributed environment).</span></span> <span data-ttu-id="2ebea-107">Ce type de transition est courant.</span><span class="sxs-lookup"><span data-stu-id="2ebea-107">This type of transition is common.</span></span> <span data-ttu-id="2ebea-108">Vous commencez par intégrer l’application complète dans l’environnement, vous la déployez et vous vous assurez qu’elle fonctionne sans problème</span><span class="sxs-lookup"><span data-stu-id="2ebea-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="2ebea-109">Puis vous la décomposez en différents services plus petits qui communiquent entre eux.</span><span class="sxs-lookup"><span data-stu-id="2ebea-109">Then you start breaking it down into different smaller services that all talk to each other.</span></span>

<span data-ttu-id="2ebea-110">Par la suite, vous pouvez constater que l’application rencontre des problèmes.</span><span class="sxs-lookup"><span data-stu-id="2ebea-110">Eventually you may find that the application is experiencing some issues.</span></span> <span data-ttu-id="2ebea-111">Ces problèmes se situent généralement dans l’une des catégories suivantes :</span><span class="sxs-lookup"><span data-stu-id="2ebea-111">The issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="2ebea-112">Certains composants X de l’application monolithique avaient une dépendance non documentée sur le composant Y et vous les avez transformés en services séparés.</span><span class="sxs-lookup"><span data-stu-id="2ebea-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="2ebea-113">Dans la mesure où ces services sont maintenant exécutés sur différents nœuds du cluster, ils sont interrompus.</span><span class="sxs-lookup"><span data-stu-id="2ebea-113">Since these services are now running on different nodes in the cluster, they're broken.</span></span>
2. <span data-ttu-id="2ebea-114">Ces composants communiquent par vecteur (canaux locaux nommés | mémoire partagée | fichiers sur disque), et ils doivent maintenant pouvoir écrire sur une ressource locale partagée pour des raisons de performances.</span><span class="sxs-lookup"><span data-stu-id="2ebea-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need to be able to write to a shared local resource for performance reasons right now.</span></span> <span data-ttu-id="2ebea-115">Cette dépendance ferme est éventuellement supprimée ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="2ebea-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="2ebea-116">Tout fonctionne correctement, sauf que ces deux composants sont en fait très occupés et sensibles aux performances.</span><span class="sxs-lookup"><span data-stu-id="2ebea-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="2ebea-117">Lorsqu’ils sont transférés dans des services distincts, la performance globale des applications diminue ou la latence augmente.</span><span class="sxs-lookup"><span data-stu-id="2ebea-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="2ebea-118">Par conséquent, l’application globale ne répond pas aux attentes.</span><span class="sxs-lookup"><span data-stu-id="2ebea-118">As a result, the overall application is not meeting expectations.</span></span>

<span data-ttu-id="2ebea-119">Dans ce cas, nous ne voulons pas perdre notre travail de refactorisation et nous ne souhaitons pas revenir au modèle monolithique.</span><span class="sxs-lookup"><span data-stu-id="2ebea-119">In these cases, we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span></span> <span data-ttu-id="2ebea-120">La dernière condition peut même être souhaitable comme optimisation brute.</span><span class="sxs-lookup"><span data-stu-id="2ebea-120">The last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="2ebea-121">Cependant, jusqu’à ce que nous puissions modifier les composants de manière à ce qu’ils fonctionnent naturellement en tant que services (ou jusqu’à ce que nous puissions répondre autrement aux attentes en matière de performances), nous devrons avoir une certaine notion de la localisation.</span><span class="sxs-lookup"><span data-stu-id="2ebea-121">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span></span>

<span data-ttu-id="2ebea-122">Que faire, alors ?</span><span class="sxs-lookup"><span data-stu-id="2ebea-122">What to do?</span></span> <span data-ttu-id="2ebea-123">Il est possible d’activer l’affinité.</span><span class="sxs-lookup"><span data-stu-id="2ebea-123">Well, you could try turning on affinity.</span></span>

## <a name="how-to-configure-affinity"></a><span data-ttu-id="2ebea-124">Configuration de l’affinité</span><span class="sxs-lookup"><span data-stu-id="2ebea-124">How to configure affinity</span></span>
<span data-ttu-id="2ebea-125">Pour configurer l’affinité, vous définissez une relation d’affinité entre deux services distincts.</span><span class="sxs-lookup"><span data-stu-id="2ebea-125">To set up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="2ebea-126">Cela revient à faire pointer un service sur un autre, ce qui fait qu’un service peut uniquement fonctionner quand cet autre service est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="2ebea-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="2ebea-127">Il s’agit parfois de relations parent-enfant (où l’enfant pointe sur le parent).</span><span class="sxs-lookup"><span data-stu-id="2ebea-127">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span></span> <span data-ttu-id="2ebea-128">L’affinité permet de s’assurer que les instances ou les réplicas d’un service sont placés sur les mêmes nœuds que les réplicas ou instances d’un autre service.</span><span class="sxs-lookup"><span data-stu-id="2ebea-128">Affinity ensures that the replicas or instances of one service are placed on the same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="2ebea-129">Un service enfant ne peut participer qu’à une seule relation d’affinité.</span><span class="sxs-lookup"><span data-stu-id="2ebea-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="2ebea-130">Si vous souhaitez créer une affinité entre un enfant et deux services parent à la fois, vous avez deux options :</span><span class="sxs-lookup"><span data-stu-id="2ebea-130">If you wanted the child to be affinitized to two parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="2ebea-131">Inverser les relations (faire pointer parentService1 et parentService2 vers le service enfant actuel), ou</span><span class="sxs-lookup"><span data-stu-id="2ebea-131">Reverse the relationships (have parentService1 and parentService2 point at the current child service), or</span></span>
> - <span data-ttu-id="2ebea-132">Désigner l’un des parents comme concentrateur par convention et faire pointer tous les services vers ce service.</span><span class="sxs-lookup"><span data-stu-id="2ebea-132">Designate one of the parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="2ebea-133">Le comportement de placement qui en résulte dans le cluster doit être le même.</span><span class="sxs-lookup"><span data-stu-id="2ebea-133">The resulting placement behavior in the cluster should be the same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="2ebea-134">Différentes options d’affinité</span><span class="sxs-lookup"><span data-stu-id="2ebea-134">Different affinity options</span></span>
<span data-ttu-id="2ebea-135">L’affinité est représentée par un des jeux de corrélations et comporte deux modes différents.</span><span class="sxs-lookup"><span data-stu-id="2ebea-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="2ebea-136">Le mode d’affinité courant est ce que nous appelons « affinité non alignée ».</span><span class="sxs-lookup"><span data-stu-id="2ebea-136">The most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="2ebea-137">Dans ce mode, les réplicas ou instances des différents services sont placés sur les mêmes nœuds.</span><span class="sxs-lookup"><span data-stu-id="2ebea-137">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span></span> <span data-ttu-id="2ebea-138">L’autre mode est appelé « affinité alignée ».</span><span class="sxs-lookup"><span data-stu-id="2ebea-138">The other mode is AlignedAffinity.</span></span> <span data-ttu-id="2ebea-139">L’affinité alignée est utilisée uniquement avec les services avec état.</span><span class="sxs-lookup"><span data-stu-id="2ebea-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="2ebea-140">La configuration de deux services avec état pour obtenir une affinité alignée garantit que les serveurs primaires de ces services sont placés sur les mêmes nœuds que d’autres.</span><span class="sxs-lookup"><span data-stu-id="2ebea-140">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span></span> <span data-ttu-id="2ebea-141">Par conséquent, chaque paire de serveurs secondaires est placée sur les mêmes nœuds.</span><span class="sxs-lookup"><span data-stu-id="2ebea-141">It also causes each pair of secondaries for those services to be placed on the same nodes.</span></span> <span data-ttu-id="2ebea-142">Il est également possible (bien que moins fréquent) de configurer l’affinité non alignée pour les services avec état.</span><span class="sxs-lookup"><span data-stu-id="2ebea-142">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="2ebea-143">Pour NonAlignedAffinity les différents réplicas des deux services avec état s’exécuteraient sur les mêmes nœuds, mais leurs serveurs primaires seraient installés sur des nœuds différents.</span><span class="sxs-lookup"><span data-stu-id="2ebea-143">For NonAlignedAffinity, the different replicas of the two stateful services would run on the same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="2ebea-144"><center>
![Modes d’affinité et leurs effets][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="2ebea-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="2ebea-145">Meilleur état souhaité</span><span class="sxs-lookup"><span data-stu-id="2ebea-145">Best effort desired state</span></span>
<span data-ttu-id="2ebea-146">Une relation d’affinité est conseillée.</span><span class="sxs-lookup"><span data-stu-id="2ebea-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="2ebea-147">Elle n’offre pas les mêmes garanties de colocation ou de fiabilité que l’exécution dans le même processus exécutable.</span><span class="sxs-lookup"><span data-stu-id="2ebea-147">It does not provide the same guarantees of collocation or reliability that running in the same executable process does.</span></span> <span data-ttu-id="2ebea-148">Les services dans une relation d’affinité sont fondamentalement différentes entités qui peuvent échouer et être déplacées séparément.</span><span class="sxs-lookup"><span data-stu-id="2ebea-148">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="2ebea-149">Une relation d’affinité peut également être interrompue, bien que ces interruptions soient temporaires.</span><span class="sxs-lookup"><span data-stu-id="2ebea-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="2ebea-150">Par exemple, des limites de capacité peuvent indiquer que seuls certains objets de services peuvent être inclus sur un nœud donné.</span><span class="sxs-lookup"><span data-stu-id="2ebea-150">For example, capacity limitations may mean that only some of the service objects in the affinity relationship can fit on a given node.</span></span> <span data-ttu-id="2ebea-151">Dans ces cas, même s’il existe une relation d’affinité, elle n’est pas appliquée en raison des autres contraintes.</span><span class="sxs-lookup"><span data-stu-id="2ebea-151">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span></span> <span data-ttu-id="2ebea-152">Si la situation le permet, la violation sera corrigée automatiquement plus tard.</span><span class="sxs-lookup"><span data-stu-id="2ebea-152">If it is possible to do so, the violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="2ebea-153">Chaînes et étoiles</span><span class="sxs-lookup"><span data-stu-id="2ebea-153">Chains vs. stars</span></span>
<span data-ttu-id="2ebea-154">Actuellement, Cluster Resource Manager ne peut pas modéliser les chaînes de relations d’affinité.</span><span class="sxs-lookup"><span data-stu-id="2ebea-154">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span></span> <span data-ttu-id="2ebea-155">Cela signifie qu’un service qui est un service enfant dans une relation d’affinité ne peut pas être un parent dans une autre relation d’affinité.</span><span class="sxs-lookup"><span data-stu-id="2ebea-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="2ebea-156">Si vous souhaitez modéliser ce type de relation, vous devez le modéliser en étoile plutôt qu’en chaîne.</span><span class="sxs-lookup"><span data-stu-id="2ebea-156">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span></span> <span data-ttu-id="2ebea-157">Pour passer d’une chaîne à une étoile, l’enfant le plus bas est apparenté au parent du premier enfant.</span><span class="sxs-lookup"><span data-stu-id="2ebea-157">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span></span> <span data-ttu-id="2ebea-158">En fonction de la disposition de vos services, il est possible que vous deviez effectuer cette opération plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="2ebea-158">Depending on the arrangement of your services, you may have to do this multiple times.</span></span> <span data-ttu-id="2ebea-159">S’il n’existe aucun service parent naturel, il est possible que vous deviez en créer un qui sert d’espace réservé.</span><span class="sxs-lookup"><span data-stu-id="2ebea-159">If there's no natural parent service, you may have to create one that serves as a placeholder.</span></span> <span data-ttu-id="2ebea-160">Selon vos besoins, vous pouvez également opter pour les [Groupes d’applications](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="2ebea-160">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="2ebea-161"><center>
![Chaînes et étoiles dans le contexte des relations d’affinité][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="2ebea-161"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="2ebea-162">Notez également que les relations d’affinité d’aujourd’hui sont directionnelles.</span><span class="sxs-lookup"><span data-stu-id="2ebea-162">Another thing to note about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="2ebea-163">Cela signifie que la règle d’affinité implique que l’enfant se trouve au même endroit que le parent.</span><span class="sxs-lookup"><span data-stu-id="2ebea-163">This means that the affinity rule only enforces that the child placed with the parent.</span></span> <span data-ttu-id="2ebea-164">Elle ne garantit pas que le parent se trouve au même endroit que l’enfant.</span><span class="sxs-lookup"><span data-stu-id="2ebea-164">It does not ensure that the parent is located with the child.</span></span> <span data-ttu-id="2ebea-165">Il est également important de noter que la relation d’affinité ne peut pas être idéale ou instantanément appliquée car différents services ont différents cycles de vie et peuvent échouer et se déplacer indépendamment.</span><span class="sxs-lookup"><span data-stu-id="2ebea-165">It is also important to note that the affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="2ebea-166">Par exemple, supposons que le parent bascule soudainement vers un autre nœud suite à un plantage.</span><span class="sxs-lookup"><span data-stu-id="2ebea-166">For example, let's say the parent suddenly fails over to another node because it crashed.</span></span> <span data-ttu-id="2ebea-167">Cluster Resource Manager et Failover Manager gèrent d’abord le basculement puisque le maintien, la cohérence et la disponible des services restent la priorité.</span><span class="sxs-lookup"><span data-stu-id="2ebea-167">The Cluster Resource Manager and Failover Manager handle the failover first, since keeping the services up, consistent, and available is the priority.</span></span> <span data-ttu-id="2ebea-168">Une fois le basculement terminé, la relation d’affinité est brisée, mais Cluster Resource Manager pense que tout fonctionne correctement, jusqu’à ce qu’il remarque que l’enfant ne se trouve pas avec le parent.</span><span class="sxs-lookup"><span data-stu-id="2ebea-168">Once the failover completes, the affinity relationship is broken, but the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with the parent.</span></span> <span data-ttu-id="2ebea-169">Ces types de vérifications sont effectuées régulièrement.</span><span class="sxs-lookup"><span data-stu-id="2ebea-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="2ebea-170">Vous trouverez plus d’informations sur la façon dont Cluster Resource Manager évalue les contraintes dans [cet article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), et [celui-ci](service-fabric-cluster-resource-manager-balancing.md) explique comment configurer la cadence à laquelle ces contraintes sont évaluées.</span><span class="sxs-lookup"><span data-stu-id="2ebea-170">More information on how the Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how to configure the cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="2ebea-171">Prise en charge du partitionnement</span><span class="sxs-lookup"><span data-stu-id="2ebea-171">Partitioning support</span></span>
<span data-ttu-id="2ebea-172">Voici une dernière remarque concernant l’affinité : les relations d’affinité ne sont pas prises en charge lorsque le parent est partitionné.</span><span class="sxs-lookup"><span data-stu-id="2ebea-172">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span></span> <span data-ttu-id="2ebea-173">Des services parent partitionnés peuvent être pris en charge par la suite, mais cela n’est pas autorisé à l’heure actuelle.</span><span class="sxs-lookup"><span data-stu-id="2ebea-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="2ebea-174">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="2ebea-174">Next steps</span></span>
- <span data-ttu-id="2ebea-175">Pour plus d’informations sur la configuration des services, consultez la rubrique [En savoir plus sur la configuration des services](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="2ebea-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="2ebea-176">Pour limiter les services à un petit nombre d’ordinateurs ou agréger la charge des services, utilisez [Groupes d’applications](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="2ebea-176">To limit services to a small set of machines or aggregating the load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png