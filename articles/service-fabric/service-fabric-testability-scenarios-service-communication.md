---
title: "Testabilité : communication de service | Microsoft Docs"
description: "La communication service à service constitue un point d’intégration critique d’une application Service Fabric. Cet article aborde les problématiques de conception et les techniques de test."
services: service-fabric
documentationcenter: .net
author: vturecek
manager: timlt
editor: 
ms.assetid: 017557df-fb59-4e4a-a65d-2732f29255b8
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 06/29/2017
ms.author: vturecek
ms.openlocfilehash: c182cc2062ada40029504de5b2b64b021c614ce6
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="service-fabric-testability-scenarios-service-communication"></a><span data-ttu-id="8bb07-104">Scénarios de testabilité de Service Fabric : communication de service</span><span class="sxs-lookup"><span data-stu-id="8bb07-104">Service Fabric testability scenarios: Service communication</span></span>
<span data-ttu-id="8bb07-105">Les microservices et les styles architecturaux orientés services émergent naturellement dans Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="8bb07-105">Microservices and service-oriented architectural styles surface naturally in Azure Service Fabric.</span></span> <span data-ttu-id="8bb07-106">Dans ces types d’architectures distribuées, les applications de microservices compartimentés sont généralement composées de plusieurs services qui interagissent entre eux.</span><span class="sxs-lookup"><span data-stu-id="8bb07-106">In these types of distributed architectures, componentized microservice applications are typically composed of multiple services that need to talk to each other.</span></span> <span data-ttu-id="8bb07-107">Même dans le cas le plus simple, vous disposez habituellement d’au moins un service web sans état et d’un service de stockage de données avec état qui communiquent.</span><span class="sxs-lookup"><span data-stu-id="8bb07-107">In even the simplest cases, you generally have at least a stateless web service and a stateful data storage service that need to communicate.</span></span>

<span data-ttu-id="8bb07-108">La communication de service à service constitue un point d’intégration critique d’une application, car chaque service expose une API distante aux autres services.</span><span class="sxs-lookup"><span data-stu-id="8bb07-108">Service-to-service communication is a critical integration point of an application, because each service exposes a remote API to other services.</span></span> <span data-ttu-id="8bb07-109">L’utilisation d’un ensemble de limites d’API impliquant un trafic d’E/S nécessite bien souvent une attention particulière, secondée par de solides méthodes de test et de validation.</span><span class="sxs-lookup"><span data-stu-id="8bb07-109">Working with a set of API boundaries that involves I/O generally requires some care, with a good amount of testing and validation.</span></span>

<span data-ttu-id="8bb07-110">Lorsque ces limites de services sont liées au sein d’un système distribué, de nombreux aspects sont à prendre en compte :</span><span class="sxs-lookup"><span data-stu-id="8bb07-110">There are numerous considerations to make when these service boundaries are wired together in a distributed system:</span></span>

* <span data-ttu-id="8bb07-111">*Protocole de transfert*.</span><span class="sxs-lookup"><span data-stu-id="8bb07-111">*Transport protocol*.</span></span> <span data-ttu-id="8bb07-112">Allez-vous utiliser le protocole HTTP, pour une interopérabilité améliorée, ou un protocole binaire personnalisé favorisant un débit optimal ?</span><span class="sxs-lookup"><span data-stu-id="8bb07-112">Will you use HTTP for increased interoperability, or a custom binary protocol for maximum throughput?</span></span>
* <span data-ttu-id="8bb07-113">*Gestion des erreurs*.</span><span class="sxs-lookup"><span data-stu-id="8bb07-113">*Error handling*.</span></span> <span data-ttu-id="8bb07-114">Comment les erreurs permanentes et temporaires sont-elles traitées ?</span><span class="sxs-lookup"><span data-stu-id="8bb07-114">How will permanent and transient errors be handled?</span></span> <span data-ttu-id="8bb07-115">Que se passe-t-il quand un service se déplace vers un autre nœud ?</span><span class="sxs-lookup"><span data-stu-id="8bb07-115">What will happen when a service moves to a different node?</span></span>
* <span data-ttu-id="8bb07-116">*Délais d’attente et latence*.</span><span class="sxs-lookup"><span data-stu-id="8bb07-116">*Timeouts and latency*.</span></span> <span data-ttu-id="8bb07-117">Dans les applications multiniveaux, comment chaque couche de service traite-t-elle la latence de bout en bout, au sein de la pile jusqu’à l’utilisateur ?</span><span class="sxs-lookup"><span data-stu-id="8bb07-117">In multitiered applications, how will each service layer handle latency through the stack and to the user?</span></span>

<span data-ttu-id="8bb07-118">Vous utilisez l’un des composants de communication de service intégrés de Service Fabric ? Vous développez le vôtre ? Pour garantir la résilience de votre application, il est primordial de tester l’interaction entre vos services.</span><span class="sxs-lookup"><span data-stu-id="8bb07-118">Whether you use one of the built-in service communication components provided by Service Fabric or you build your own, testing the interactions between your services is critical to ensuring resiliency in your application.</span></span>

## <a name="prepare-for-services-to-move"></a><span data-ttu-id="8bb07-119">Préparation des services à déplacer</span><span class="sxs-lookup"><span data-stu-id="8bb07-119">Prepare for services to move</span></span>
<span data-ttu-id="8bb07-120">Les instances de service peuvent se déplacer au fil du temps.</span><span class="sxs-lookup"><span data-stu-id="8bb07-120">Service instances may move around over time.</span></span> <span data-ttu-id="8bb07-121">Ce déplacement est particulièrement avéré quand elles sont configurées avec des mesures de charge dédiées à l’équilibrage personnalisé optimal des ressources.</span><span class="sxs-lookup"><span data-stu-id="8bb07-121">This is especially true when they are configured with load metrics for custom-tailored optimal resource balancing.</span></span> <span data-ttu-id="8bb07-122">Service Fabric déplace vos instances de service à des fins de disponibilité maximale, même pendant les mises à niveau, les basculements, les augmentations de la taille des instances et d’autres situations ponctuant le cycle de vie d’un système distribué.</span><span class="sxs-lookup"><span data-stu-id="8bb07-122">Service Fabric moves your service instances to maximize their availability even during upgrades, failovers, scale-out, and other situations that occur over the lifetime of a distributed system.</span></span>

<span data-ttu-id="8bb07-123">Quand les services se déplacent dans le cluster, vos clients et les autres services doivent envisager deux scénarios d’interaction avec ces derniers :</span><span class="sxs-lookup"><span data-stu-id="8bb07-123">As services move around in the cluster, your clients and other services should be prepared to handle two scenarios when they talk to a service:</span></span>

* <span data-ttu-id="8bb07-124">L’instance de service ou le réplica de partition ont subi un déplacement depuis votre dernière interaction.</span><span class="sxs-lookup"><span data-stu-id="8bb07-124">The service instance or partition replica has moved since the last time you talked to it.</span></span> <span data-ttu-id="8bb07-125">Cette configuration, qui fait partie du cycle de vie normal du service, se produit naturellement au cours de la vie d’une application.</span><span class="sxs-lookup"><span data-stu-id="8bb07-125">This is a normal part of a service lifecycle, and it should be expected to happen during the lifetime of your application.</span></span>
* <span data-ttu-id="8bb07-126">L’instance de service ou le réplica de partition est en cours de déplacement.</span><span class="sxs-lookup"><span data-stu-id="8bb07-126">The service instance or partition replica is in the process of moving.</span></span> <span data-ttu-id="8bb07-127">Le basculement d’un service entre deux nœuds se produit très rapidement dans Service Fabric, mais vous pouvez constater un délai de mise à disposition en cas de démarrage lent du composant de communication de votre service.</span><span class="sxs-lookup"><span data-stu-id="8bb07-127">Although failover of a service from one node to another occurs very quickly in Service Fabric, there may be a delay in availability if the communication component of your service is slow to start.</span></span>

<span data-ttu-id="8bb07-128">Pour bénéficier d’un système pleinement fonctionnel, il est nécessaire de gérer ces scénarios de manière appropriée.</span><span class="sxs-lookup"><span data-stu-id="8bb07-128">Handling these scenarios gracefully is important for a smooth-running system.</span></span> <span data-ttu-id="8bb07-129">Pour cela, n’oubliez pas que :</span><span class="sxs-lookup"><span data-stu-id="8bb07-129">To do so, keep in mind that:</span></span>

* <span data-ttu-id="8bb07-130">Chaque service pouvant faire l’objet d’une connexion présente une *adresse* d’écoute (par exemple, HTTP ou WebSockets).</span><span class="sxs-lookup"><span data-stu-id="8bb07-130">Every service that can be connected to has an *address* that it listens on (for example, HTTP or WebSockets).</span></span> <span data-ttu-id="8bb07-131">Quand une instance ou partition de service se déplace, le point de terminaison de son adresse change.</span><span class="sxs-lookup"><span data-stu-id="8bb07-131">When a service instance or partition moves, its address endpoint changes.</span></span> <span data-ttu-id="8bb07-132">(Elle se déplace vers un autre nœud dont l’adresse IP est différente.) Si vous utilisez des composants de communication intégrés, ils traitent pour vous la nouvelle résolution des adresses de service.</span><span class="sxs-lookup"><span data-stu-id="8bb07-132">(It moves to a different node with a different IP address.) If you're using the built-in communication components, they will handle re-resolving service addresses for you.</span></span>
* <span data-ttu-id="8bb07-133">Vous pourrez observer une augmentation temporaire de la latence du service étant donné que l’instance de service redémarre son écouteur.</span><span class="sxs-lookup"><span data-stu-id="8bb07-133">There may be a temporary increase in service latency as the service instance starts up its listener again.</span></span> <span data-ttu-id="8bb07-134">Cette latence dépend de la vitesse à laquelle le service ouvre l’écouteur une fois l’instance de service déplacée.</span><span class="sxs-lookup"><span data-stu-id="8bb07-134">This depends on how quickly the service opens the listener after the service instance is moved.</span></span>
* <span data-ttu-id="8bb07-135">Toutes les connexions existantes doivent être fermées, puis rouvertes une fois que le service s’ouvre sur un nouveau nœud.</span><span class="sxs-lookup"><span data-stu-id="8bb07-135">Any existing connections need to be closed and reopened after the service opens on a new node.</span></span> <span data-ttu-id="8bb07-136">Un arrêt ou redémarrage approprié du nœud laisse suffisamment de temps aux connexions existantes pour s’arrêter correctement.</span><span class="sxs-lookup"><span data-stu-id="8bb07-136">A graceful node shutdown or restart allows time for existing connections to be shut down gracefully.</span></span>

### <a name="test-it-move-service-instances"></a><span data-ttu-id="8bb07-137">Test : déplacement des instances de service</span><span class="sxs-lookup"><span data-stu-id="8bb07-137">Test it: Move service instances</span></span>
<span data-ttu-id="8bb07-138">À l’aide des outils de testabilité de Service Fabric, vous pouvez établir un scénario test afin d’évaluer ces situations dans des contextes différents :</span><span class="sxs-lookup"><span data-stu-id="8bb07-138">By using Service Fabric's testability tools, you can author a test scenario to test these situations in different ways:</span></span>

1. <span data-ttu-id="8bb07-139">Déplacez un réplica principal de service avec état.</span><span class="sxs-lookup"><span data-stu-id="8bb07-139">Move a stateful service's primary replica.</span></span>
   
    <span data-ttu-id="8bb07-140">Le réplica principal d’une partition de service avec état peut être déplacé pour diverses raisons.</span><span class="sxs-lookup"><span data-stu-id="8bb07-140">The primary replica of a stateful service partition can be moved for any number of reasons.</span></span> <span data-ttu-id="8bb07-141">Appliquez ce scénario pour cibler le réplica principal d’une partition spécifique et examiner la réaction de vos services à ce déplacement, dans un cadre très strict.</span><span class="sxs-lookup"><span data-stu-id="8bb07-141">Use this to target the primary replica of a specific partition to see how your services react to the move in a very controlled manner.</span></span>
   
    ```powershell
   
    PS > Move-ServiceFabricPrimaryReplica -PartitionId 6faa4ffa-521a-44e9-8351-dfca0f7e0466 -ServiceName fabric:/MyApplication/MyService
   
    ```
2. <span data-ttu-id="8bb07-142">Arrêtez un nœud.</span><span class="sxs-lookup"><span data-stu-id="8bb07-142">Stop a node.</span></span>
   
    <span data-ttu-id="8bb07-143">Quand un nœud est arrêté, Service Fabric déplace l’ensemble des instances ou partitions de service positionnées sur ce nœud vers l’un des autres nœuds disponibles dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="8bb07-143">When a node is stopped, Service Fabric moves all of the service instances or partitions that were on that node to one of the other available nodes in the cluster.</span></span> <span data-ttu-id="8bb07-144">Utilisez ce scénario pour tester une configuration où un nœud de votre cluster est perdu et l’ensemble de vos instances et réplicas de service sur ce nœud doivent être déplacés.</span><span class="sxs-lookup"><span data-stu-id="8bb07-144">Use this to test a situation where a node is lost from your cluster and all of the service instances and replicas on that node have to move.</span></span>
   
    <span data-ttu-id="8bb07-145">Vous pouvez arrêter un nœud à l’aide de l’applet de commande PowerShell **Stop-ServiceFabricNode** :</span><span class="sxs-lookup"><span data-stu-id="8bb07-145">You can stop a node by using the PowerShell **Stop-ServiceFabricNode** cmdlet:</span></span>
   
    ```powershell
   
    PS > Restart-ServiceFabricNode -NodeName Node_1
   
    ```

## <a name="maintain-service-availability"></a><span data-ttu-id="8bb07-146">Maintenir la disponibilité du service</span><span class="sxs-lookup"><span data-stu-id="8bb07-146">Maintain service availability</span></span>
<span data-ttu-id="8bb07-147">En tant que plateforme, Service Fabric est conçu pour assurer la haute disponibilité de vos services.</span><span class="sxs-lookup"><span data-stu-id="8bb07-147">As a platform, Service Fabric is designed to provide high availability of your services.</span></span> <span data-ttu-id="8bb07-148">Mais dans des cas extrêmes, les problèmes liés à l’infrastructure sous-jacente peuvent quand même entraîner une indisponibilité.</span><span class="sxs-lookup"><span data-stu-id="8bb07-148">But in extreme cases, underlying infrastructure problems can still cause unavailability.</span></span> <span data-ttu-id="8bb07-149">Il est important de tester ces scénarios également.</span><span class="sxs-lookup"><span data-stu-id="8bb07-149">It is important to test for these scenarios, too.</span></span>

<span data-ttu-id="8bb07-150">Les services avec état utilisent un système avec quorum pour répliquer l’état à des fins de haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="8bb07-150">Stateful services use a quorum-based system to replicate state for high availability.</span></span> <span data-ttu-id="8bb07-151">Cela signifie qu’un quorum de réplicas doit être disponible pour l’exécution des opérations d’écriture.</span><span class="sxs-lookup"><span data-stu-id="8bb07-151">This means that a quorum of replicas needs to be available to perform write operations.</span></span> <span data-ttu-id="8bb07-152">Dans de rares cas, comme celui d’une défaillance matérielle étendue, aucun quorum de réplicas ne peut être disponible.</span><span class="sxs-lookup"><span data-stu-id="8bb07-152">In rare cases, such as a widespread hardware failure, a quorum of replicas may not be available.</span></span> <span data-ttu-id="8bb07-153">Le cas échéant, vous ne pourrez pas exécuter d’opérations d’écriture, mais disposerez des opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="8bb07-153">In these cases, you will not be able to perform write operations, but you will still be able to perform read operations.</span></span>

### <a name="test-it-write-operation-unavailability"></a><span data-ttu-id="8bb07-154">Test : écriture de l’indisponibilité des opérations</span><span class="sxs-lookup"><span data-stu-id="8bb07-154">Test it: Write operation unavailability</span></span>
<span data-ttu-id="8bb07-155">En utilisant les outils de testabilité de Service Fabric, vous pouvez injecter une erreur qui entraîne une perte de quorum en guise de test.</span><span class="sxs-lookup"><span data-stu-id="8bb07-155">By using the testability tools in Service Fabric, you can inject a fault that induces quorum loss as a test.</span></span> <span data-ttu-id="8bb07-156">Même si ce scénario est rare, les clients et les entités qui dépendent d’un service avec état doivent néanmoins s’y préparer. Que faire quand les requêtes d’écriture sur le service avec état sont impossibles ?</span><span class="sxs-lookup"><span data-stu-id="8bb07-156">Although such a scenario is rare, it is important that clients and services that depend on a stateful service are prepared to handle situations where they cannot make write requests to it.</span></span> <span data-ttu-id="8bb07-157">Il est également essentiel que le service avec état ait conscience de cette possibilité, et qu’il en fasse part de manière adaptée aux appelants.</span><span class="sxs-lookup"><span data-stu-id="8bb07-157">It is also important that the stateful service itself is aware of this possibility and can gracefully communicate it to callers.</span></span>

<span data-ttu-id="8bb07-158">Vous pouvez provoquer une perte de quorum à l’aide de l’applet de commande PowerShell **Invoke-ServiceFabricPartitionQuorumLoss** :</span><span class="sxs-lookup"><span data-stu-id="8bb07-158">You can induce quorum loss by using the PowerShell **Invoke-ServiceFabricPartitionQuorumLoss** cmdlet:</span></span>

```powershell

PS > Invoke-ServiceFabricPartitionQuorumLoss -ServiceName fabric:/Myapplication/MyService -QuorumLossMode QuorumReplicas -QuorumLossDurationInSeconds 20

```

<span data-ttu-id="8bb07-159">Dans cet exemple, nous avons défini `QuorumLossMode` sur `QuorumReplicas` pour indiquer que nous voulons provoquer une perte de quorum sans retirer tous les réplicas.</span><span class="sxs-lookup"><span data-stu-id="8bb07-159">In this example, we set `QuorumLossMode` to `QuorumReplicas` to indicate that we want to induce quorum loss without taking down all replicas.</span></span> <span data-ttu-id="8bb07-160">Ainsi, les opérations de lecture sont toujours possibles.</span><span class="sxs-lookup"><span data-stu-id="8bb07-160">This way, read operations are still possible.</span></span> <span data-ttu-id="8bb07-161">Pour tester ce scénario avec l’intégralité de la partition indisponible, définissez ce commutateur sur `AllReplicas`.</span><span class="sxs-lookup"><span data-stu-id="8bb07-161">To test a scenario where an entire partition is unavailable, you can set this switch to `AllReplicas`.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8bb07-162">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="8bb07-162">Next steps</span></span>
[<span data-ttu-id="8bb07-163">En savoir plus sur les actions de testabilité</span><span class="sxs-lookup"><span data-stu-id="8bb07-163">Learn more about testability actions</span></span>](service-fabric-testability-actions.md)

[<span data-ttu-id="8bb07-164">En savoir plus sur les scénarios de testabilité</span><span class="sxs-lookup"><span data-stu-id="8bb07-164">Learn more about testability scenarios</span></span>](service-fabric-testability-scenarios.md)

