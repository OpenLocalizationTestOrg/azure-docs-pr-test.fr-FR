---
title: "Utiliser les serveurs NPS existants pour exploiter les fonctionnalités d’Azure MFA | Microsoft Docs"
description: "L’extension de serveur NPS (Network Policy Server) pour Azure Multi-Factor Authentication est une solution simple permettant d’ajouter des fonctionnalités de vérification en deux étapes basées sur le cloud à votre infrastructure d’authentification existante."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/14/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: H1Hack27Feb2017; it-pro
ms.openlocfilehash: fa125292ee85bd9b5329cffeff7f076d3002cbf3
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/29/2017
---
# <a name="integrate-your-existing-nps-infrastructure-with-azure-multi-factor-authentication"></a><span data-ttu-id="09054-103">Intégrer votre infrastructure NPS existante dans Azure Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="09054-103">Integrate your existing NPS infrastructure with Azure Multi-Factor Authentication</span></span>

<span data-ttu-id="09054-104">L’extension de serveur NPS (Network Policy Server) pour Azure MFA permet d’ajouter des fonctionnalités de MFA basées sur le cloud à votre infrastructure d’authentification à l’aide de vos serveurs existants.</span><span class="sxs-lookup"><span data-stu-id="09054-104">The Network Policy Server (NPS) extension for Azure MFA adds cloud-based MFA capabilities to your authentication infrastructure using your existing servers.</span></span> <span data-ttu-id="09054-105">Avec l’extension NPS, vous pouvez ajouter des vérifications basées sur des appels téléphoniques, des SMS ou des applications mobiles à votre flux d’authentification existant sans avoir à installer, configurer et gérer les nouveaux serveurs.</span><span class="sxs-lookup"><span data-stu-id="09054-105">With the NPS extension, you can add phone call, text message, or phone app verification to your existing authentication flow without having to install, configure, and maintain new servers.</span></span> 

<span data-ttu-id="09054-106">Cette extension a été créée pour les organisations qui souhaitent protéger des connexions VPN sans déployer le serveur Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-106">This extension was created for organizations that want to protect VPN connections without deploying the Azure MFA Server.</span></span> <span data-ttu-id="09054-107">L’extension NPS joue le rôle d’adaptateur entre RADIUS et Azure MFA sur le cloud pour fournir un second facteur d’authentification pour les utilisateurs fédérés ou synchronisés.</span><span class="sxs-lookup"><span data-stu-id="09054-107">The NPS extension acts as an adapter between RADIUS and cloud-based Azure MFA to provide a second factor of authentication for federated or synced users.</span></span>

<span data-ttu-id="09054-108">Lorsque vous utilisez l’extension NPS pour Azure MFA, le flux d’authentification inclut les composants suivants :</span><span class="sxs-lookup"><span data-stu-id="09054-108">When using the NPS extension for Azure MFA, the authentication flow includes the following components:</span></span> 

1. <span data-ttu-id="09054-109">**Le serveur NAS/VPN** reçoit les demandes des clients VPN et les convertit en demandes RADIUS à des serveurs NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-109">**NAS/VPN Server** receives requests from VPN clients and converts them into RADIUS requests to NPS servers.</span></span> 
2. <span data-ttu-id="09054-110">**Le serveur NPS** se connecte à Active Directory pour procéder à l’authentification principale pour les demandes RADIUS et, en cas de réussite, les transmet à toutes les extensions installées.</span><span class="sxs-lookup"><span data-stu-id="09054-110">**NPS Server** connects to Active Directory to perform the primary authentication for the RADIUS requests and, upon success, passes the request to any installed extensions.</span></span>  
3. <span data-ttu-id="09054-111">**L’extension NPS** déclenche une demande destinée à Azure MFA pour l’authentification secondaire.</span><span class="sxs-lookup"><span data-stu-id="09054-111">**NPS Extension** triggers a request to Azure MFA for the secondary authentication.</span></span> <span data-ttu-id="09054-112">Une fois que l’extension reçoit la réponse, et si la demande MFA réussit, elle termine la demande d’authentification en fournissant au serveur NPS des jetons de sécurité qui incluent une revendication MFA, émise par Azure STS.</span><span class="sxs-lookup"><span data-stu-id="09054-112">Once the extension receives the response, and if the MFA challenge succeeds, it completes the authentication request by providing the NPS server with security tokens that include an MFA claim, issued by Azure STS.</span></span>  
4. <span data-ttu-id="09054-113">**Azure MFA** communique avec Azure Active Directory pour récupérer les informations de l’utilisateur et procède à l’authentification secondaire à l’aide d’une méthode de vérification configurée par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="09054-113">**Azure MFA** communicates with Azure Active Directory to retrieve the user’s details and performs the secondary authentication using a verification method configured to the user.</span></span>

<span data-ttu-id="09054-114">Le diagramme suivant illustre ce flux de demande d’authentification de niveau supérieur :</span><span class="sxs-lookup"><span data-stu-id="09054-114">The following diagram illustrates this high-level authentication request flow:</span></span> 

![Diagramme du flux d’authentification](./media/multi-factor-authentication-nps-extension/auth-flow.png)

## <a name="plan-your-deployment"></a><span data-ttu-id="09054-116">Planifier votre déploiement</span><span class="sxs-lookup"><span data-stu-id="09054-116">Plan your deployment</span></span>

<span data-ttu-id="09054-117">L’extension NPS gère automatiquement la redondance, vous n’avez pas besoin d’une configuration spéciale.</span><span class="sxs-lookup"><span data-stu-id="09054-117">The NPS extension automatically handles redundancy, so you don't need a special configuration.</span></span>

<span data-ttu-id="09054-118">Vous pouvez créer autant de serveurs NPS compatibles avec Azure MFA que vous le souhaitez.</span><span class="sxs-lookup"><span data-stu-id="09054-118">You can create as many Azure MFA-enabled NPS servers as you need.</span></span> <span data-ttu-id="09054-119">Si vous installez plusieurs serveurs, vous devez utiliser un certificat client différent pour chacun d'entre eux.</span><span class="sxs-lookup"><span data-stu-id="09054-119">If you do install multiple servers, you should use a difference client certificate for each one of them.</span></span> <span data-ttu-id="09054-120">La création d’un certificat pour chaque serveur signifie que vous pouvez mettre à jour chaque certificat individuellement et que vous n’avez pas à craindre une interruption de service sur tous vos serveurs.</span><span class="sxs-lookup"><span data-stu-id="09054-120">Creating a cert for each server means that you can update each cert individually, and not worry about downtime across all your servers.</span></span>

<span data-ttu-id="09054-121">Comme les serveurs VPN acheminent les demandes d’authentification, ils doivent connaître les nouveaux serveurs NPS compatibles avec Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-121">VPN servers route authentication requests, so they need to be aware of the new Azure MFA-enabled NPS servers.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="09054-122">Composants requis</span><span class="sxs-lookup"><span data-stu-id="09054-122">Prerequisites</span></span>

<span data-ttu-id="09054-123">L’extension NPS est conçue pour fonctionner avec votre infrastructure existante.</span><span class="sxs-lookup"><span data-stu-id="09054-123">The NPS extension is meant to work with your existing infrastructure.</span></span> <span data-ttu-id="09054-124">Vérifiez que les conditions préalables suivantes sont remplies avant de commencer.</span><span class="sxs-lookup"><span data-stu-id="09054-124">Make sure you have the following prerequisites before you begin.</span></span>

### <a name="licenses"></a><span data-ttu-id="09054-125">Licences</span><span class="sxs-lookup"><span data-stu-id="09054-125">Licenses</span></span>

<span data-ttu-id="09054-126">L’extension NPS pour Azure MFA est disponible pour les clients disposant de [licences pour Azure MFA](multi-factor-authentication.md) (incluses dans Azure AD Premium, EMS ou un abonnement MFA).</span><span class="sxs-lookup"><span data-stu-id="09054-126">The NPS Extension for Azure MFA is available to customers with [licenses for Azure Multi-Factor Authentication](multi-factor-authentication.md) (included with Azure AD Premium, EMS, or an MFA subscription).</span></span>

### <a name="software"></a><span data-ttu-id="09054-127">Logiciel</span><span class="sxs-lookup"><span data-stu-id="09054-127">Software</span></span>

<span data-ttu-id="09054-128">Windows Server 2008 R2 SP1 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="09054-128">Windows Server 2008 R2 SP1 or above.</span></span>

### <a name="libraries"></a><span data-ttu-id="09054-129">Bibliothèques</span><span class="sxs-lookup"><span data-stu-id="09054-129">Libraries</span></span>

<span data-ttu-id="09054-130">Ces bibliothèques sont installées automatiquement avec l’extension.</span><span class="sxs-lookup"><span data-stu-id="09054-130">These libraries are installed automatically with the extension.</span></span>
-   [<span data-ttu-id="09054-131">Visual C++ Redistributable Packages pour Visual Studio 2013 (X64)</span><span class="sxs-lookup"><span data-stu-id="09054-131">Visual C++ Redistributable Packages for Visual Studio 2013 (X64)</span></span>](https://www.microsoft.com/download/details.aspx?id=40784)
-   [<span data-ttu-id="09054-132">Module Microsoft Azure Active Directory pour Windows PowerShell version 1.1.166.0</span><span class="sxs-lookup"><span data-stu-id="09054-132">Microsoft Azure Active Directory Module for Windows PowerShell version 1.1.166.0</span></span>](https://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185)

### <a name="azure-active-directory"></a><span data-ttu-id="09054-133">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="09054-133">Azure Active Directory</span></span>

<span data-ttu-id="09054-134">Tous les utilisateurs de l’extension NPS doivent être synchronisés avec Azure Active Directory à l’aide d’Azure AD Connect et doivent être inscrits pour l’authentification MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-134">Everyone using the NPS extension must be synced to Azure Active Directory using Azure AD Connect, and must be registered for MFA.</span></span>

<span data-ttu-id="09054-135">Lorsque vous installez l’extension, vous devez disposer de l’ID de répertoire et des informations d’identification de l’administrateur pour votre client Azure AD.</span><span class="sxs-lookup"><span data-stu-id="09054-135">When you install the extension, you need the directory ID and admin credentials for your Azure AD tenant.</span></span> <span data-ttu-id="09054-136">Vous trouverez votre ID de répertoire dans le [portail Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="09054-136">You can find your directory ID in the [Azure portal](https://portal.azure.com).</span></span> <span data-ttu-id="09054-137">Connectez-vous en tant qu’administrateur, sélectionnez l’icône **Azure Active Directory** sur la gauche, puis cliquez sur **Propriétés**.</span><span class="sxs-lookup"><span data-stu-id="09054-137">Sign in as an administrator, select the **Azure Active Directory** icon on the left, then select **Properties**.</span></span> <span data-ttu-id="09054-138">Copiez le GUID dans la zone **ID répertoire** et enregistrez.</span><span class="sxs-lookup"><span data-stu-id="09054-138">Copy the GUID in the **Directory ID** box and save it.</span></span> <span data-ttu-id="09054-139">Vous utilisez ce GUID comme ID client lors de l’installation de l’extension NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-139">You use this GUID as the tenant ID when you install the NPS extension.</span></span>

![Identification de votre ID de répertoire dans les propriétés Azure Active Directory](./media/multi-factor-authentication-nps-extension/find-directory-id.png)

## <a name="prepare-your-environment"></a><span data-ttu-id="09054-141">Préparation de votre environnement</span><span class="sxs-lookup"><span data-stu-id="09054-141">Prepare your environment</span></span>

<span data-ttu-id="09054-142">Avant d’installer l’extension NPS, vous souhaitez préparer votre environnement pour qu’il gère le trafic d’authentification.</span><span class="sxs-lookup"><span data-stu-id="09054-142">Before you install the NPS extension, you want to prepare you environment to handle the authentication traffic.</span></span>

### <a name="enable-the-nps-role-on-a-domain-joined-server"></a><span data-ttu-id="09054-143">Activer le rôle NPS sur un serveur joint à un domaine</span><span class="sxs-lookup"><span data-stu-id="09054-143">Enable the NPS role on a domain-joined server</span></span>

<span data-ttu-id="09054-144">Le serveur NPS se connecte à Azure Active Directory et authentifie les demandes MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-144">The NPS server connects to Azure Active Directory and authenticates the MFA requests.</span></span> <span data-ttu-id="09054-145">Choisissez un serveur pour ce rôle.</span><span class="sxs-lookup"><span data-stu-id="09054-145">Choose one server for this role.</span></span> <span data-ttu-id="09054-146">Nous vous recommandons de choisir un serveur qui ne gère pas les demandes provenant d’autres services, car l’extension NPS génère des erreurs pour toutes les demandes qui ne sont pas RADIUS.</span><span class="sxs-lookup"><span data-stu-id="09054-146">We recommend choosing a server that doesn't handle requests from other services, because the NPS extension throws errors for any requests that aren't RADIUS.</span></span>

1. <span data-ttu-id="09054-147">Sur votre serveur, ouvrez l’**Assistant d’ajout de rôles et fonctionnalités** à partir du menu Démarrage rapide du Gestionnaire de serveur.</span><span class="sxs-lookup"><span data-stu-id="09054-147">On your server, open the **Add Roles and Features Wizard** from the Server Manager Quickstart menu.</span></span>
2. <span data-ttu-id="09054-148">Choisissez **Installation basée sur un rôle ou une fonctionnalité** pour votre type d’installation.</span><span class="sxs-lookup"><span data-stu-id="09054-148">Choose **Role-based or feature-based installation** for your installation type.</span></span>
3. <span data-ttu-id="09054-149">Sélectionnez le rôle de serveur **Services de stratégie et d’accès réseau**.</span><span class="sxs-lookup"><span data-stu-id="09054-149">Select the **Network Policy and Access Services** server role.</span></span> <span data-ttu-id="09054-150">Une fenêtre peut s’afficher pour vous informer des fonctionnalités requises pour exécuter ce rôle.</span><span class="sxs-lookup"><span data-stu-id="09054-150">A window may pop up to inform you of required features to run this role.</span></span>
4. <span data-ttu-id="09054-151">Suivez les instructions de l’Assistant jusqu'à la page de confirmation.</span><span class="sxs-lookup"><span data-stu-id="09054-151">Continue through the wizard until the Confirmation page.</span></span> <span data-ttu-id="09054-152">Sélectionnez **Installer**.</span><span class="sxs-lookup"><span data-stu-id="09054-152">Select **Install**.</span></span>

<span data-ttu-id="09054-153">Maintenant que vous avez un serveur désigné pour NPS, vous devez également configurer ce serveur pour traiter les demandes RADIUS entrantes à partir de la solution VPN.</span><span class="sxs-lookup"><span data-stu-id="09054-153">Now that you have a server designated for NPS, you should also configure this server to handle incoming RADIUS requests from the VPN solution.</span></span>

### <a name="configure-your-vpn-solution-to-communicate-with-the-nps-server"></a><span data-ttu-id="09054-154">Configurer votre solution VPN pour communiquer avec le serveur NPS</span><span class="sxs-lookup"><span data-stu-id="09054-154">Configure your VPN solution to communicate with the NPS server</span></span>

<span data-ttu-id="09054-155">En fonction de la solution VPN utilisée, la procédure servant à configurer votre stratégie d’authentification RADIUS n’est pas la même.</span><span class="sxs-lookup"><span data-stu-id="09054-155">Depending on which VPN solution you use, the steps to configure your RADIUS authentication policy vary.</span></span> <span data-ttu-id="09054-156">Configurez cette stratégie pour qu’elle pointe vers votre serveur NPS RADIUS.</span><span class="sxs-lookup"><span data-stu-id="09054-156">Configure this policy to point to your RADIUS NPS server.</span></span>

### <a name="sync-domain-users-to-the-cloud"></a><span data-ttu-id="09054-157">Synchronisation des utilisateurs de domaine dans le cloud</span><span class="sxs-lookup"><span data-stu-id="09054-157">Sync domain users to the cloud</span></span>

<span data-ttu-id="09054-158">Même si cette étape peut déjà avoir été effectuée sur votre client, il est judicieux de vérifier qu’Azure AD Connect a récemment synchronisé vos bases de données.</span><span class="sxs-lookup"><span data-stu-id="09054-158">This step may already be complete on your tenant, but it's good to double-check that Azure AD Connect has synchronized your databases recently.</span></span>

1. <span data-ttu-id="09054-159">Connectez-vous au [portail Azure](https://portal.azure.com) en tant qu’administrateur.</span><span class="sxs-lookup"><span data-stu-id="09054-159">Sign in to the [Azure portal](https://portal.azure.com) as an administrator.</span></span>
2. <span data-ttu-id="09054-160">Sélectionnez **Azure Active Directory** > **Connexion Azure AD**</span><span class="sxs-lookup"><span data-stu-id="09054-160">Select **Azure Active Directory** > **Azure AD Connect**</span></span>
3. <span data-ttu-id="09054-161">Vérifiez que votre état de synchronisation est **Activée** et que la dernière synchronisation a eu lieu il y a moins d’une heure.</span><span class="sxs-lookup"><span data-stu-id="09054-161">Verify that your sync status is **Enabled** and that your last sync was less than an hour ago.</span></span>

<span data-ttu-id="09054-162">Si vous avez besoin de lancer un nouveau cycle de synchronisations, suivez les instructions figurant dans [Planificateur Azure AD Connect Sync](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span><span class="sxs-lookup"><span data-stu-id="09054-162">If you need to kick off a new round of synchronization, us the instructions in [Azure AD Connect sync: Scheduler](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span></span>

### <a name="determine-which-authentication-methods-your-users-can-use"></a><span data-ttu-id="09054-163">Déterminer les méthodes d’authentification que vos utilisateurs peuvent employer</span><span class="sxs-lookup"><span data-stu-id="09054-163">Determine which authentication methods your users can use</span></span>

<span data-ttu-id="09054-164">Il existe deux facteurs qui affectent les méthodes d’authentification disponibles avec un déploiement d’extension NPS :</span><span class="sxs-lookup"><span data-stu-id="09054-164">There are two factors that affect which authentication methods are available with an NPS extension deployment:</span></span>

1. <span data-ttu-id="09054-165">L’algorithme de chiffrement de mot de passe utilisé entre le client RADIUS (VPN, Netscaler server ou autre) et les serveurs NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-165">The password encryption algorithm used between the RADIUS client (VPN, Netscaler server, or other) and the NPS servers.</span></span>
   - <span data-ttu-id="09054-166">**PAP** prend en charge toutes les méthodes d’authentification de l’authentification multifacteur Azure dans le cloud : appel téléphonique, message texte à sens unique, notification de l’application mobile et code de vérification de l’application mobile.</span><span class="sxs-lookup"><span data-stu-id="09054-166">**PAP** supports all the authentication methods of Azure MFA in the cloud: phone call, one-way text message, mobile app notification, and mobile app verification code.</span></span>
   - <span data-ttu-id="09054-167">**CHAPv2** et **EAP** prennent en charge l’appel téléphonique et la notification d’application mobile.</span><span class="sxs-lookup"><span data-stu-id="09054-167">**CHAPV2** and **EAP** support phone call and mobile app notification.</span></span>
2. <span data-ttu-id="09054-168">Les méthodes d’entrée que l’application cliente (VPN, Netscaler server ou autre) peut gérer.</span><span class="sxs-lookup"><span data-stu-id="09054-168">The input methods that the client application (VPN, Netscaler server, or other) can handle.</span></span> <span data-ttu-id="09054-169">Par exemple, le client VPN dispose-t-il de moyens permettant d’autoriser l’utilisateur à taper un code de vérification à partir d’un texte ou d’une application mobile ?</span><span class="sxs-lookup"><span data-stu-id="09054-169">For example, does the VPN client have some means to allow the user to type in a verification code from a text or mobile app?</span></span>

<span data-ttu-id="09054-170">Lorsque vous déployez l’extension NPS, utilisez ces facteurs pour déterminer quelles méthodes sont disponibles pour vos utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="09054-170">When you deploy the NPS extension, use these factors to evaluate which methods are available for your users.</span></span> <span data-ttu-id="09054-171">Si votre point d’accès sans fil compatible 802.1X prend en charge PAP, mais que le client UX ne dispose pas des champs d’entrée pour un code de vérification, l’appel téléphonique et la notification d’application mobile sont les deux options prises en charge.</span><span class="sxs-lookup"><span data-stu-id="09054-171">If your RADIUS client supports PAP, but the client UX doesn't have input fields for a verification code, then phone call and mobile app notification are the two supported options.</span></span>

<span data-ttu-id="09054-172">Vous pouvez [désactiver les méthodes d’authentification non prises en charge](multi-factor-authentication-whats-next.md#selectable-verification-methods) dans Azure.</span><span class="sxs-lookup"><span data-stu-id="09054-172">You can [disable unsupported authentication methods](multi-factor-authentication-whats-next.md#selectable-verification-methods) in Azure.</span></span>

### <a name="enable-users-for-mfa"></a><span data-ttu-id="09054-173">Autoriser des utilisateurs à utiliser MFA</span><span class="sxs-lookup"><span data-stu-id="09054-173">Enable users for MFA</span></span>

<span data-ttu-id="09054-174">Avant de déployer l’extension NPS complète, vous devez activer l’authentification MFA pour les utilisateurs pour lesquels vous souhaitez effectuer la vérification en deux étapes.</span><span class="sxs-lookup"><span data-stu-id="09054-174">Before you deploy the full NPS extension, you need to enable MFA for the users that you want to perform two-step verification.</span></span> <span data-ttu-id="09054-175">De manière plus immédiate, pour tester l’extension lorsque vous la déployez, il vous faut au moins un compte de test entièrement inscrit pour Multi-Factor Authentication.</span><span class="sxs-lookup"><span data-stu-id="09054-175">More immediately, to test the extension as you deploy it, you need at least one test account that is fully registered for Multi-Factor Authentication.</span></span>

<span data-ttu-id="09054-176">Pour créer un compte de test, suivez la procédure suivante :</span><span class="sxs-lookup"><span data-stu-id="09054-176">Use these steps to get a test account started:</span></span>
1. <span data-ttu-id="09054-177">Connectez-vous à [https://aka.ms/mfasetup](https://aka.ms/mfasetup) avec un compte de test.</span><span class="sxs-lookup"><span data-stu-id="09054-177">Sign in to [https://aka.ms/mfasetup](https://aka.ms/mfasetup) with a test account.</span></span> 
2. <span data-ttu-id="09054-178">Suivez les instructions pour configurer une méthode de vérification.</span><span class="sxs-lookup"><span data-stu-id="09054-178">Follow the prompts to set up a verification method.</span></span>
3. <span data-ttu-id="09054-179">Créez une stratégie d’accès conditionnel ou [modifiez l’état utilisateur](multi-factor-authentication-get-started-user-states.md) pour exiger une vérification en deux étapes concernant le compte de test.</span><span class="sxs-lookup"><span data-stu-id="09054-179">Either create a conditional access policy or [change the user state](multi-factor-authentication-get-started-user-states.md) to require two-step verification for the test account.</span></span> 

<span data-ttu-id="09054-180">Vos utilisateurs doivent également suivre ces étapes pour s’inscrire avant de pouvoir s’authentifier avec l’extension NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-180">Your users also need to follow these steps to enroll before they can authenticate with the NPS extension.</span></span>

## <a name="install-the-nps-extension"></a><span data-ttu-id="09054-181">Installer l’extension NPS</span><span class="sxs-lookup"><span data-stu-id="09054-181">Install the NPS extension</span></span>

> [!IMPORTANT]
> <span data-ttu-id="09054-182">Installez l’extension NPS sur un serveur autre que le point d’accès VPN.</span><span class="sxs-lookup"><span data-stu-id="09054-182">Install the NPS extension on a different server than the VPN access point.</span></span>

### <a name="download-and-install-the-nps-extension-for-azure-mfa"></a><span data-ttu-id="09054-183">Télécharger et installer l’extension NPS pour Azure MFA</span><span class="sxs-lookup"><span data-stu-id="09054-183">Download and install the NPS extension for Azure MFA</span></span>

1.  <span data-ttu-id="09054-184">[Téléchargez l’extension NPS](https://aka.ms/npsmfa) à partir du Centre de téléchargement Microsoft.</span><span class="sxs-lookup"><span data-stu-id="09054-184">[Download the NPS Extension](https://aka.ms/npsmfa) from the Microsoft Download Center.</span></span>
2.  <span data-ttu-id="09054-185">Copiez le fichier binaire sur le serveur NPS (Network Policy Server) que vous souhaitez configurer.</span><span class="sxs-lookup"><span data-stu-id="09054-185">Copy the binary to the Network Policy Server you want to configure.</span></span>
3.  <span data-ttu-id="09054-186">Exécutez le fichier *setup.exe* et suivez les instructions d’installation.</span><span class="sxs-lookup"><span data-stu-id="09054-186">Run *setup.exe* and follow the installation instructions.</span></span> <span data-ttu-id="09054-187">Si vous rencontrez des erreurs, vérifiez que les deux bibliothèques de la section Configuration requise ont été installées avec succès.</span><span class="sxs-lookup"><span data-stu-id="09054-187">If you encounter errors, double-check that the two libraries from the prerequisite section were successfully installed.</span></span>

### <a name="run-the-powershell-script"></a><span data-ttu-id="09054-188">Exécution du script PowerShell</span><span class="sxs-lookup"><span data-stu-id="09054-188">Run the PowerShell script</span></span>

<span data-ttu-id="09054-189">Le programme d’installation crée un script PowerShell à cet emplacement : `C:\Program Files\Microsoft\AzureMfa\Config` (C:\ étant le lecteur d’installation).</span><span class="sxs-lookup"><span data-stu-id="09054-189">The installer creates a PowerShell script in this location: `C:\Program Files\Microsoft\AzureMfa\Config` (where C:\ is your installation drive).</span></span> <span data-ttu-id="09054-190">Ce script PowerShell effectue les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="09054-190">This PowerShell script performs the following actions:</span></span>

-   <span data-ttu-id="09054-191">Vous pouvez créer un certificat auto-signé.</span><span class="sxs-lookup"><span data-stu-id="09054-191">Create a self-signed certificate.</span></span>
-   <span data-ttu-id="09054-192">Associer la clé publique du certificat au principal du service sur Azure AD.</span><span class="sxs-lookup"><span data-stu-id="09054-192">Associate the public key of the certificate to the service principal on Azure AD.</span></span>
-   <span data-ttu-id="09054-193">Stocker le certificat dans le magasin de certificats de l’ordinateur local.</span><span class="sxs-lookup"><span data-stu-id="09054-193">Store the cert in the local machine cert store.</span></span>
-   <span data-ttu-id="09054-194">Accorder l’accès à la clé privée du certificat à l’utilisateur réseau.</span><span class="sxs-lookup"><span data-stu-id="09054-194">Grant access to the certificate’s private key to Network User.</span></span>
-   <span data-ttu-id="09054-195">Redémarrer le serveur NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-195">Restart the NPS.</span></span>

<span data-ttu-id="09054-196">À moins que vous ne souhaitiez utiliser vos propres certificats (au lieu des certificats auto-signés générés par le script PowerShell), exécutez le script PowerShell pour terminer l’installation.</span><span class="sxs-lookup"><span data-stu-id="09054-196">Unless you want to use your own certificates (instead of the self-signed certificates that the PowerShell script generates), run the PowerShell Script to complete the installation.</span></span> <span data-ttu-id="09054-197">Si vous installez l’extension sur plusieurs serveurs, chacun d’eux doit avoir son propre certificat.</span><span class="sxs-lookup"><span data-stu-id="09054-197">If you install the extension on multiple servers, each one should have its own certificate.</span></span>

1. <span data-ttu-id="09054-198">Exécutez Windows PowerShell en tant qu’administrateur.</span><span class="sxs-lookup"><span data-stu-id="09054-198">Run Windows PowerShell as an administrator.</span></span>
2. <span data-ttu-id="09054-199">Remplacez les répertoires.</span><span class="sxs-lookup"><span data-stu-id="09054-199">Change directories.</span></span>

   `cd "C:\Program Files\Microsoft\AzureMfa\Config"`

3. <span data-ttu-id="09054-200">Exécutez le script PowerShell créé par le programme d’installation.</span><span class="sxs-lookup"><span data-stu-id="09054-200">Run the PowerShell script created by the installer.</span></span>

   `.\AzureMfaNpsExtnConfigSetup.ps1`

4. <span data-ttu-id="09054-201">PowerShell vous invite à entrer votre ID client.</span><span class="sxs-lookup"><span data-stu-id="09054-201">PowerShell prompts for your tenant ID.</span></span> <span data-ttu-id="09054-202">Utilisez l’ID de répertoire GUID que vous avez copié à partir du portail Azure dans la section Configuration requise.</span><span class="sxs-lookup"><span data-stu-id="09054-202">Use the Directory ID GUID that you copied from the Azure portal in the prerequisites section.</span></span>
5. <span data-ttu-id="09054-203">Connectez-vous à Azure AD en tant qu’administrateur.</span><span class="sxs-lookup"><span data-stu-id="09054-203">Sign in to Azure AD as an administrator.</span></span>
6. <span data-ttu-id="09054-204">PowerShell affiche un message de réussite une fois le script terminé.</span><span class="sxs-lookup"><span data-stu-id="09054-204">PowerShell shows a success message when the script is finished.</span></span>  

<span data-ttu-id="09054-205">Répétez ces étapes sur les serveurs NPS supplémentaires que vous souhaitez configurer pour l’équilibrage de charge.</span><span class="sxs-lookup"><span data-stu-id="09054-205">Repeat these steps on any additional NPS servers that you want to set up for load balancing.</span></span>

>[!NOTE]
><span data-ttu-id="09054-206">Si vous utilisez vos propres certificats au lieu de générer des certificats avec le script PowerShell, vous devez veiller à ce qu’ils respectent la convention de nommage du serveur NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-206">If you use your own certificates instead of generating certificates with the PowerShell script, make sure that they align to the NPS naming convention.</span></span> <span data-ttu-id="09054-207">Le nom de l’objet doit être **CN=\<ID_locataire\>,OU= Extension NPS Microsoft**.</span><span class="sxs-lookup"><span data-stu-id="09054-207">The subject name must be **CN=\<TenantID\>,OU=Microsoft NPS Extension**.</span></span> 

## <a name="configure-your-nps-extension"></a><span data-ttu-id="09054-208">Configurer votre extension NPS</span><span class="sxs-lookup"><span data-stu-id="09054-208">Configure your NPS extension</span></span>

<span data-ttu-id="09054-209">Cette section comprend des considérations relatives à la conception ainsi que des suggestions visant à garantir la réussite des déploiements d’extension NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-209">This section includes design considerations and suggestions for successful NPS extension deployments.</span></span>

### <a name="configuration-limitations"></a><span data-ttu-id="09054-210">Limites de configuration</span><span class="sxs-lookup"><span data-stu-id="09054-210">Configuration limitations</span></span>

- <span data-ttu-id="09054-211">L’extension NPS pour Azure MFA n’inclut pas les outils permettant de migrer les utilisateurs et les paramètres du serveur MFA vers le cloud.</span><span class="sxs-lookup"><span data-stu-id="09054-211">The NPS extension for Azure MFA does not include tools to migrate users and settings from MFA Server to the cloud.</span></span> <span data-ttu-id="09054-212">De ce fait, nous vous conseillons d’utiliser l’extension pour les nouveaux déploiements, plutôt que pour les déploiements existants.</span><span class="sxs-lookup"><span data-stu-id="09054-212">For this reason, we suggest using the extension for new deployments, rather than existing deployment.</span></span> <span data-ttu-id="09054-213">Si vous utilisez l’extension sur un déploiement existant, vos utilisateurs doivent suivre de nouveau la procédure de vérification pour remplir leurs détails MFA dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="09054-213">If you use the extension on an existing deployment, your users have to perform proof-up again to populate their MFA details in the cloud.</span></span>  
- <span data-ttu-id="09054-214">L’extension NPS utilise l’UPN de l’annuaire Active Directory local pour identifier l’utilisateur sur Azure MFA afin de procéder à l’authentification secondaire. L’extension peut être configurée pour utiliser un identificateur autre que l’UPN (un ID de connexion alternatif ou un champ Active Directory personnalisé, par exemple).</span><span class="sxs-lookup"><span data-stu-id="09054-214">The NPS extension uses the UPN from the on-premises Active directory to identify the user on Azure MFA for performing the Secondary Auth. The extension can be configured to use a different identifier like alternate login ID or custom Active Directory field other than UPN.</span></span> <span data-ttu-id="09054-215">Consultez [Options de configuration avancée de l’extension de serveur NPS pour l’authentification multifacteur](multi-factor-authentication-advanced-vpn-configurations.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="09054-215">See [Advanced configuration options for the NPS extension for Multi-Factor Authentication](multi-factor-authentication-advanced-vpn-configurations.md) for more information.</span></span>
- <span data-ttu-id="09054-216">Tous les protocoles de chiffrement ne prennent pas en charge toutes les méthodes de vérification.</span><span class="sxs-lookup"><span data-stu-id="09054-216">Not all encryption protocols support all verification methods.</span></span>
   - <span data-ttu-id="09054-217">**PAP** prend en charge l’appel téléphonique, le message texte à sens unique, la notification de l’application mobile et le code de vérification de l’application mobile</span><span class="sxs-lookup"><span data-stu-id="09054-217">**PAP** supports phone call, one-way text message, mobile app notification, and mobile app verification code</span></span>
   - <span data-ttu-id="09054-218">**CHAPv2** et **EAP** prennent en charge l’appel téléphonique et la notification d’application mobile</span><span class="sxs-lookup"><span data-stu-id="09054-218">**CHAPV2** and **EAP** support phone call and mobile app notification</span></span>

### <a name="control-radius-clients-that-require-mfa"></a><span data-ttu-id="09054-219">Contrôler les clients RADIUS nécessitant l’authentification MFA</span><span class="sxs-lookup"><span data-stu-id="09054-219">Control RADIUS clients that require MFA</span></span>

<span data-ttu-id="09054-220">Une fois que vous activez l’authentification MFA pour un client RADIUS à l’aide de l’extension NPS, toutes les authentifications de ce client doivent utiliser la méthode MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-220">Once you enable MFA for a RADIUS client using the NPS Extension, all authentications for this client are required to perform MFA.</span></span> <span data-ttu-id="09054-221">Si vous souhaitez activer l’authentification MFA pour certains clients RADIUS et d’autres non, vous pouvez configurer deux serveurs NPS et installer l’extension sur un seul d’entre eux.</span><span class="sxs-lookup"><span data-stu-id="09054-221">If you want to enable MFA for some RADIUS clients but not others, you can configure two NPS servers and install the extension on only one of them.</span></span> <span data-ttu-id="09054-222">Configurez les clients RADIUS pour lesquels vous souhaitez exiger l’authentification MFA de sorte qu’ils envoient des demandes au serveur NPS configuré avec l’extension, et les autres clients RADIUS pour qu’ils les envoient au serveur NPS non configuré avec l’extension.</span><span class="sxs-lookup"><span data-stu-id="09054-222">Configure RADIUS clients that you want to require MFA to send requests to the NPS server configured with the extension, and other RADIUS clients to the NPS server not configured with the extension.</span></span>

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a><span data-ttu-id="09054-223">Anticiper la présence d’utilisateurs qui ne sont pas inscrits pour l’authentification MFA</span><span class="sxs-lookup"><span data-stu-id="09054-223">Prepare for users that aren't enrolled for MFA</span></span>

<span data-ttu-id="09054-224">Si vous avez des utilisateurs qui ne sont pas inscrits pour l’authentification MFA, vous pouvez déterminer ce qui se passe lorsqu’ils tentent de s’authentifier.</span><span class="sxs-lookup"><span data-stu-id="09054-224">If you have users that aren't enrolled for MFA, you can determine what happens when they try to authenticate.</span></span> <span data-ttu-id="09054-225">Utilisez le paramètre de Registre *REQUIRE_USER_MATCH* dans le chemin d’accès au Registre *HKLM\Software\Microsoft\AzureMFA* pour contrôler le comportement de la fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="09054-225">Use the registry setting *REQUIRE_USER_MATCH* in the registry path *HKLM\Software\Microsoft\AzureMFA* to control the feature behavior.</span></span> <span data-ttu-id="09054-226">Ce paramètre ne dispose que d’une seule option de configuration :</span><span class="sxs-lookup"><span data-stu-id="09054-226">This setting has a single configuration option:</span></span>

| <span data-ttu-id="09054-227">Clé</span><span class="sxs-lookup"><span data-stu-id="09054-227">Key</span></span> | <span data-ttu-id="09054-228">Valeur</span><span class="sxs-lookup"><span data-stu-id="09054-228">Value</span></span> | <span data-ttu-id="09054-229">Default</span><span class="sxs-lookup"><span data-stu-id="09054-229">Default</span></span> |
| --- | ----- | ------- |
| <span data-ttu-id="09054-230">REQUIRE_USER_MATCH</span><span class="sxs-lookup"><span data-stu-id="09054-230">REQUIRE_USER_MATCH</span></span> | <span data-ttu-id="09054-231">TRUE/FALSE</span><span class="sxs-lookup"><span data-stu-id="09054-231">TRUE/FALSE</span></span> | <span data-ttu-id="09054-232">Non défini (équivaut à TRUE)</span><span class="sxs-lookup"><span data-stu-id="09054-232">Not set (equivalent to TRUE)</span></span> |

<span data-ttu-id="09054-233">L’objectif de ce paramètre est de déterminer l’action à exécuter lorsqu’un utilisateur n’est pas inscrit pour l’authentification MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-233">The purpose of this setting is to determine what to do when a user is not enrolled for MFA.</span></span> <span data-ttu-id="09054-234">Lorsque la clé n’existe pas, n’est pas définie ou est définie sur TRUE, et si l’utilisateur n’est pas inscrit, l’extension échoue à la demande d’authentification MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-234">When the key does not exist, is not set, or is set to TRUE, and the user is not enrolled, then the extension fails the MFA challenge.</span></span> <span data-ttu-id="09054-235">Lorsque la clé est définie sur FALSE et que l’utilisateur n’est pas inscrit, l’authentification s’effectue sans procéder à l’authentification MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-235">When the key is set to FALSE and the user is not enrolled, authentication proceeds without performing MFA.</span></span>

<span data-ttu-id="09054-236">Vous pouvez choisir de créer cette clé et de lui affecter la valeur FALSE pour vos utilisateurs qui sont en cours d’intégration et ne sont peut-être pas encore inscrits pour l’authentification Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="09054-236">You can choose to create this key and set it to FALSE while your users are onboarding, and may not all be enrolled for Azure MFA yet.</span></span> <span data-ttu-id="09054-237">Toutefois, étant donné que la définition de la clé permet aux utilisateurs qui ne sont pas inscrits pour l’authentification MFA de se connecter, vous devez supprimer cette clé avant de passer en production.</span><span class="sxs-lookup"><span data-stu-id="09054-237">However, since setting the key permits users that aren't enrolled for MFA to sign in, you should remove this key before going to production.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="09054-238">Résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="09054-238">Troubleshooting</span></span>

### <a name="how-do-i-verify-that-the-client-cert-is-installed-as-expected"></a><span data-ttu-id="09054-239">Comment vérifier que le certificat client est installé comme prévu ?</span><span class="sxs-lookup"><span data-stu-id="09054-239">How do I verify that the client cert is installed as expected?</span></span>

<span data-ttu-id="09054-240">Recherchez le certificat auto-signé créé par le programme d’installation dans le magasin de certificats et vérifiez que la clé privée dispose d’autorisations accordées à l’utilisateur **NETWORK SERVICE**.</span><span class="sxs-lookup"><span data-stu-id="09054-240">Look for the self-signed certificate created by the installer in the cert store, and check that the private key has permissions granted to user **NETWORK SERVICE**.</span></span> <span data-ttu-id="09054-241">Le certificat porte un nom d’objet de type **CN \<tenantid\>, UO = Extension Microsoft NPS**</span><span class="sxs-lookup"><span data-stu-id="09054-241">The cert has a subject name of **CN \<tenantid\>, OU = Microsoft NPS Extension**</span></span>

-------------------------------------------------------------

### <a name="how-can-i-verify-that-my-client-cert-is-associated-to-my-tenant-in-azure-active-directory"></a><span data-ttu-id="09054-242">Comment vérifier que mon certificat client est associé à mon client dans Azure Active Directory ?</span><span class="sxs-lookup"><span data-stu-id="09054-242">How can I verify that my client cert is associated to my tenant in Azure Active Directory?</span></span>

<span data-ttu-id="09054-243">Ouvrez une invite de commandes PowerShell et exécutez les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="09054-243">Open PowerShell command prompt and run the following commands:</span></span>

```
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 
```

<span data-ttu-id="09054-244">Ces commandes impriment tous les certificats qui associent votre client à votre instance de l’extension NPS dans votre session PowerShell.</span><span class="sxs-lookup"><span data-stu-id="09054-244">These commands print all the certificates associating your tenant with your instance of the NPS extension in your PowerShell session.</span></span> <span data-ttu-id="09054-245">Recherchez votre certificat en exportant votre certificat client en tant que fichier « Codé à base 64 X.509 (.cer) » sans la clé privée et comparez-le à la liste de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="09054-245">Look for your certificate by exporting your client cert as a "Base-64 encoded X.509(.cer)" file without the private key, and compare it with the list from PowerShell.</span></span>

<span data-ttu-id="09054-246">Les horodatages Valid-From (Valide à partir de) et Valid-Until (Valide jusqu’à), qui sont dans un format explicite, peuvent être utilisés pour filtrer les certificats de toute évidence non appropriés si la commande en renvoie plusieurs.</span><span class="sxs-lookup"><span data-stu-id="09054-246">Valid-From and Valid-Until timestamps, which are in human-readable form, can be used to filter out obvious misfits if the command returns more than one cert.</span></span>

-------------------------------------------------------------

### <a name="why-are-my-requests-failing-with-adal-token-error"></a><span data-ttu-id="09054-247">Pourquoi mes demandes échouent-elles avec une erreur de jeton ADAL ?</span><span class="sxs-lookup"><span data-stu-id="09054-247">Why are my requests failing with ADAL token error?</span></span>

<span data-ttu-id="09054-248">Cette erreur peut être due à plusieurs raisons.</span><span class="sxs-lookup"><span data-stu-id="09054-248">This error could be due to one of several reasons.</span></span> <span data-ttu-id="09054-249">Suivez ces étapes pour résoudre le problème :</span><span class="sxs-lookup"><span data-stu-id="09054-249">Use these steps to help troubleshoot:</span></span>

1. <span data-ttu-id="09054-250">Redémarrez votre serveur NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-250">Restart your NPS server.</span></span>
2. <span data-ttu-id="09054-251">Vérifiez que le certificat client est installé comme prévu.</span><span class="sxs-lookup"><span data-stu-id="09054-251">Verify that that client cert is installed as expected.</span></span>
3. <span data-ttu-id="09054-252">Vérifiez que le certificat est associé à votre client sur Azure AD.</span><span class="sxs-lookup"><span data-stu-id="09054-252">Verify that the certificate is associated with your tenant on Azure AD.</span></span>
4. <span data-ttu-id="09054-253">Vérifiez que https://login.microsoftonline.com/ est accessible à partir du serveur exécutant l’extension.</span><span class="sxs-lookup"><span data-stu-id="09054-253">Verify that https://login.microsoftonline.com/ is accessible from the server running the extension.</span></span>

-------------------------------------------------------------

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-the-user-is-not-found"></a><span data-ttu-id="09054-254">Pourquoi l’authentification échoue-t-elle avec une erreur dans les journaux HTTP indiquant que l’utilisateur est introuvable ?</span><span class="sxs-lookup"><span data-stu-id="09054-254">Why does authentication fail with an error in HTTP logs stating that the user is not found?</span></span>

<span data-ttu-id="09054-255">Vérifiez qu’AD Connect est en cours d’exécution et que l’utilisateur se trouve dans Windows Active Directory et Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="09054-255">Verify that AD Connect is running, and that the user is present in both Windows Active Directory and Azure Active Directory.</span></span>

------------------------------------------------------------

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a><span data-ttu-id="09054-256">Pourquoi existe-t-il des erreurs de connexion HTTP dans les journaux pour tous mes échecs d’authentification ?</span><span class="sxs-lookup"><span data-stu-id="09054-256">Why do I see HTTP connect errors in logs with all my authentications failing?</span></span>

<span data-ttu-id="09054-257">Vérifiez que https://adnotifications.windowsazure.com est accessible à partir du serveur exécutant l’extension NPS.</span><span class="sxs-lookup"><span data-stu-id="09054-257">Verify that https://adnotifications.windowsazure.com is reachable from the server running the NPS extension.</span></span>


## <a name="next-steps"></a><span data-ttu-id="09054-258">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="09054-258">Next steps</span></span>

- <span data-ttu-id="09054-259">Configurez d’autres ID de connexion, ou créez une liste d’exceptions pour les adresses IP qui ne nécessitent pas de vérification en deux étapes dans [Options de configuration avancée de l’extension de serveur NPS pour l’authentification multifacteur](nps-extension-advanced-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="09054-259">Configure alternate IDs for login, or set up an exception list for IPs that shouldn't perform two-step verification in [Advanced configuration options for the NPS extension for Multi-Factor Authentication](nps-extension-advanced-configuration.md)</span></span>

- [<span data-ttu-id="09054-260">Résoudre les messages d’erreur liés à l’extension NPS pour Azure Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="09054-260">Resolve error messages from the NPS extension for Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-nps-errors.md)
