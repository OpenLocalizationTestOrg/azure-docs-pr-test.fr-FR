---
title: "Utilisation de la gestion des API Azure avec des réseaux virtuels"
description: "Découvrez comment configurer une connexion à un réseau virtuel dans Gestion des API Azure et accéder à des services web par son intermédiaire."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="4df4e-103">Utilisation de la gestion des API Azure avec des réseaux virtuels</span><span class="sxs-lookup"><span data-stu-id="4df4e-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="4df4e-104">Les réseaux virtuels Azure vous permettent de placer vos ressources Azure dans un réseau routable non-Internet dont vous contrôlez l’accès.</span><span class="sxs-lookup"><span data-stu-id="4df4e-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="4df4e-105">Ces réseaux peuvent ensuite être connectés à vos réseaux locaux à l’aide de différentes technologies VPN.</span><span class="sxs-lookup"><span data-stu-id="4df4e-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="4df4e-106">Pour en savoir plus sur les réseaux virtuels Azure, commencez par consulter la page [Présentation du réseau virtuel](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="4df4e-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="4df4e-107">La gestion des API Azure peut être déployée à l’intérieur du réseau virtuel (VNET), pour qu’il puisse accéder aux services principaux au sein du réseau.</span><span class="sxs-lookup"><span data-stu-id="4df4e-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="4df4e-108">Le portail des développeurs et la passerelle API peuvent être configurés pour être accessibles depuis Internet ou uniquement au sein du réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="4df4e-109">La gestion des API Azure prend en charge les réseaux virtuels classiques et Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="4df4e-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="4df4e-110"><a name="enable-vpn"> </a>Activer la connexion au réseau virtuel</span><span class="sxs-lookup"><span data-stu-id="4df4e-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="4df4e-111">La connectivité VNET est disponible dans les niveaux **Premium** et **Développeur**.</span><span class="sxs-lookup"><span data-stu-id="4df4e-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="4df4e-112">Pour basculer entre les niveaux, ouvrez votre service de gestion des API dans le portail Azure, puis ouvrez l’onglet **Scale and pricing (Échelle et tarification)**. Dans la section **Niveau tarifaire**, sélectionnez le niveau Premium et cliquez sur Enregistrer.</span><span class="sxs-lookup"><span data-stu-id="4df4e-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="4df4e-113">Pour activer la connectivité VNET, ouvrez votre service de gestion des API dans le portail Azure ainsi que la page **Réseau virtuel**.</span><span class="sxs-lookup"><span data-stu-id="4df4e-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Menu Réseau virtuel du service Gestion des API][api-management-using-vnet-menu]

<span data-ttu-id="4df4e-115">Sélectionnez le type d’accès souhaité :</span><span class="sxs-lookup"><span data-stu-id="4df4e-115">Select the desired access type:</span></span>

* <span data-ttu-id="4df4e-116">**Externe** : la passerelle Gestion des API et le portail des développeurs sont accessibles à partir de l’Internet public via un équilibreur de charge externe.</span><span class="sxs-lookup"><span data-stu-id="4df4e-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="4df4e-117">La passerelle peut accéder aux ressources au sein du réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-117">The gateway can access resources within the virtual network.</span></span>

![Homologation publique][api-management-vnet-public]

* <span data-ttu-id="4df4e-119">**Interne** : la passerelle Gestion des API et le portail des développeurs sont accessibles uniquement sur le réseau virtuel via un équilibreur de charge interne.</span><span class="sxs-lookup"><span data-stu-id="4df4e-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="4df4e-120">La passerelle peut accéder aux ressources au sein du réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-120">The gateway can access resources within the virtual network.</span></span>

![Homologation privée][api-management-vnet-private]

<span data-ttu-id="4df4e-122">Vous voyez maintenant une liste de toutes les régions où votre service Gestion des API est créé.</span><span class="sxs-lookup"><span data-stu-id="4df4e-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="4df4e-123">Sélectionnez un réseau VNET et un sous-réseau pour chaque région.</span><span class="sxs-lookup"><span data-stu-id="4df4e-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="4df4e-124">La liste contient les réseaux virtuels classiques et Resource Manager, disponibles dans vos abonnements Azure, qui sont installés dans la région que vous configurez.</span><span class="sxs-lookup"><span data-stu-id="4df4e-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="4df4e-125">Le **point de terminaison de service** du diagramme ci-dessus inclut la passerelle/proxy, le portail des éditeurs, le portail des développeurs, le Git et le point de terminaison de gestion directe.</span><span class="sxs-lookup"><span data-stu-id="4df4e-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="4df4e-126">Le **point de terminaison de gestion** du diagramme ci-dessus est le point de terminaison hébergé sur le service pour gérer la configuration via le portail Azure et Powershell.</span><span class="sxs-lookup"><span data-stu-id="4df4e-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="4df4e-127">Veuillez également noter que, bien que le diagramme contient les adresses IP de ses différents points de terminaison, le service Gestion des API répond **uniquement** à ses noms d’hôtes configurés.</span><span class="sxs-lookup"><span data-stu-id="4df4e-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4df4e-128">Lorsque vous déployez une instance de la gestion des API Azure sur un réseau virtuel Resource Manager, le service doit se trouver dans un sous-réseau dédié qui ne contient aucune autre ressource à l’exception des instances de la gestion des API Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="4df4e-129">Si vous essayez de déployer une instance de gestion des API Azure sur un sous-réseau virtuel Resource Manager qui contient d’autres ressources, le déploiement échouera.</span><span class="sxs-lookup"><span data-stu-id="4df4e-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Sélectionner le VPN][api-management-setup-vpn-select]

<span data-ttu-id="4df4e-131">Cliquez sur **Enregistrer** dans la partie supérieure de l’écran.</span><span class="sxs-lookup"><span data-stu-id="4df4e-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="4df4e-132">L’adresse IP virtuelle de l’instance de gestion des API change à chaque activation ou désactivation du réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="4df4e-133">L’adresse IP virtuelle est également modifiée si la gestion des API passe **d’externe** à **interne** ou vice versa</span><span class="sxs-lookup"><span data-stu-id="4df4e-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="4df4e-134">Si vous supprimez le service Gestion des API à partir d’un réseau virtuel (VNET) ou que vous modifiez celui sur lequel il est déployé, le réseau virtuel précédemment utilisé peut rester verrouillé jusqu’à 4 heures.</span><span class="sxs-lookup"><span data-stu-id="4df4e-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="4df4e-135">Pendant ce temps, vous ne pourrez pas supprimer le réseau virtuel ou y déployer une nouvelle ressource.</span><span class="sxs-lookup"><span data-stu-id="4df4e-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="4df4e-136"><a name="enable-vnet-powershell"> </a>Activation de la connexion au réseau virtuel à l’aide d’applets de commande PowerShell</span><span class="sxs-lookup"><span data-stu-id="4df4e-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="4df4e-137">Vous pouvez également activer la connectivité de réseau virtuel à l’aide d’applets de commande PowerShell.</span><span class="sxs-lookup"><span data-stu-id="4df4e-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="4df4e-138">**Création d’un service de gestion des API au sein d’un réseau virtuel** : utilisez l’applet de commande [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) pour créer un service de gestion des API Azure au sein d’un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="4df4e-139">**Déploiement d’un service de gestion des API existant au sein d’un réseau virtuel** : utilisez l’applet de commande [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) pour déplacer un service de gestion des API Azure existant au sein d’un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="4df4e-140"><a name="connect-vnet"> </a>Se connecter à un service web hébergé sur un réseau virtuel</span><span class="sxs-lookup"><span data-stu-id="4df4e-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="4df4e-141">Une fois que votre service Gestion des API est connecté au réseau virtuel, l’accès aux services principaux de ce réseau est similaire à l’accès aux services publics.</span><span class="sxs-lookup"><span data-stu-id="4df4e-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="4df4e-142">Tapez simplement l’adresse IP locale ou le nom d’hôte (si un serveur DNS est configuré pour le réseau virtuel) de votre service web dans le champ **URL du service web** lorsque vous créez ou modifiez une API.</span><span class="sxs-lookup"><span data-stu-id="4df4e-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Ajouter des API à partir du VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="4df4e-144"><a name="network-configuration-issues"> </a>Problèmes courants liés à la configuration du réseau</span><span class="sxs-lookup"><span data-stu-id="4df4e-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="4df4e-145">Voici une liste des problèmes courants de configuration incorrecte qui peuvent se produire lors du déploiement du service de gestion des API dans un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="4df4e-146">**Configuration du serveur DNS personnalisée** : le service de la gestion des API dépend de plusieurs services Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="4df4e-147">Si la gestion des API est hébergée dans un réseau virtuel comportant un serveur DNS personnalisé, il doit résoudre les noms d’hôte de ces services Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="4df4e-148">Veuillez suivre [ce](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guide sur la configuration de serveurs DNS personnalisée.</span><span class="sxs-lookup"><span data-stu-id="4df4e-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="4df4e-149">Consultez le tableau des ports ci-dessous et les autres exigences en matière de réseau pour référence.</span><span class="sxs-lookup"><span data-stu-id="4df4e-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4df4e-150">Si vous utilisez des serveurs DNS personnalisés pour le réseau virtuel, nous vous recommandons de le configurer **avant** d’y déployer un service Gestion des API.</span><span class="sxs-lookup"><span data-stu-id="4df4e-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="4df4e-151">Sinon, vous devez mettre à jour le service Gestion des API chaque fois que vous changez les serveurs DNS en exécutant l’[opération Appliquer une configuration réseau](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="4df4e-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="4df4e-152">**Ports requis pour la gestion des API** : le trafic entrant et sortant dans un sous-réseau dans lequel est déployée la gestion des API peut être contrôlé à l’aide du [groupe de sécurité réseau][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="4df4e-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="4df4e-153">Si ces ports ne sont pas disponibles, la gestion des API risque de ne pas fonctionner correctement et d’être inaccessible.</span><span class="sxs-lookup"><span data-stu-id="4df4e-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="4df4e-154">Le blocage d’un ou plusieurs de ces ports constitue un autre problème de configuration courant lorsque vous utilisez la gestion des API dans un réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="4df4e-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="4df4e-155">Lorsque l’instance de service Gestion des API est hébergée dans un réseau virtuel, les ports du tableau suivant sont utilisés.</span><span class="sxs-lookup"><span data-stu-id="4df4e-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="4df4e-156">Port(s) source / de destination</span><span class="sxs-lookup"><span data-stu-id="4df4e-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="4df4e-157">Direction</span><span class="sxs-lookup"><span data-stu-id="4df4e-157">Direction</span></span> | <span data-ttu-id="4df4e-158">Protocole de transfert</span><span class="sxs-lookup"><span data-stu-id="4df4e-158">Transport protocol</span></span> | <span data-ttu-id="4df4e-159">Objectif</span><span class="sxs-lookup"><span data-stu-id="4df4e-159">Purpose</span></span> | <span data-ttu-id="4df4e-160">Source / Destination</span><span class="sxs-lookup"><span data-stu-id="4df4e-160">Source / Destination</span></span> | <span data-ttu-id="4df4e-161">Type d’accès</span><span class="sxs-lookup"><span data-stu-id="4df4e-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="4df4e-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="4df4e-162">* / 80, 443</span></span> |<span data-ttu-id="4df4e-163">Trafic entrant</span><span class="sxs-lookup"><span data-stu-id="4df4e-163">Inbound</span></span> |<span data-ttu-id="4df4e-164">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-164">TCP</span></span> |<span data-ttu-id="4df4e-165">Communication client avec Gestion des API</span><span class="sxs-lookup"><span data-stu-id="4df4e-165">Client communication to API Management</span></span> |<span data-ttu-id="4df4e-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="4df4e-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="4df4e-167">Externe</span><span class="sxs-lookup"><span data-stu-id="4df4e-167">External</span></span> |
| <span data-ttu-id="4df4e-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="4df4e-168">* / 3443</span></span> |<span data-ttu-id="4df4e-169">Trafic entrant</span><span class="sxs-lookup"><span data-stu-id="4df4e-169">Inbound</span></span> |<span data-ttu-id="4df4e-170">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-170">TCP</span></span> |<span data-ttu-id="4df4e-171">Point de terminaison de gestion pour le portail Azure et Powershell</span><span class="sxs-lookup"><span data-stu-id="4df4e-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="4df4e-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="4df4e-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="4df4e-173">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-173">External & Internal</span></span> |
| <span data-ttu-id="4df4e-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="4df4e-174">* / 80, 443</span></span> |<span data-ttu-id="4df4e-175">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-175">Outbound</span></span> |<span data-ttu-id="4df4e-176">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-176">TCP</span></span> |<span data-ttu-id="4df4e-177">Dépendance sur Stockage Azure et Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="4df4e-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="4df4e-178">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-179">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-179">External & Internal</span></span> |
| <span data-ttu-id="4df4e-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="4df4e-180">* / 1433</span></span> |<span data-ttu-id="4df4e-181">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-181">Outbound</span></span> |<span data-ttu-id="4df4e-182">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-182">TCP</span></span> |<span data-ttu-id="4df4e-183">Dépendance sur SQL Azure</span><span class="sxs-lookup"><span data-stu-id="4df4e-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="4df4e-184">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-185">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-185">External & Internal</span></span> |
| <span data-ttu-id="4df4e-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="4df4e-186">* / 11000 - 11999</span></span> |<span data-ttu-id="4df4e-187">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-187">Outbound</span></span> |<span data-ttu-id="4df4e-188">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-188">TCP</span></span> |<span data-ttu-id="4df4e-189">Dépendance Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="4df4e-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="4df4e-190">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-191">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-191">External & Internal</span></span> |
| <span data-ttu-id="4df4e-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="4df4e-192">* / 14000 - 14999</span></span> |<span data-ttu-id="4df4e-193">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-193">Outbound</span></span> |<span data-ttu-id="4df4e-194">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-194">TCP</span></span> |<span data-ttu-id="4df4e-195">Dépendance Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="4df4e-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="4df4e-196">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-197">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-197">External & Internal</span></span> |
| <span data-ttu-id="4df4e-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="4df4e-198">* / 5671</span></span> |<span data-ttu-id="4df4e-199">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-199">Outbound</span></span> |<span data-ttu-id="4df4e-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="4df4e-200">AMQP</span></span> |<span data-ttu-id="4df4e-201">Dépendance du journal pour la stratégie Event Hub et l’agent de surveillance</span><span class="sxs-lookup"><span data-stu-id="4df4e-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="4df4e-202">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-203">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-203">External & Internal</span></span> |
| <span data-ttu-id="4df4e-204">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="4df4e-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="4df4e-205">Trafic entrant et sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-205">Inbound & Outbound</span></span> |<span data-ttu-id="4df4e-206">UDP</span><span class="sxs-lookup"><span data-stu-id="4df4e-206">UDP</span></span> |<span data-ttu-id="4df4e-207">Dépendance sur Cache Redis</span><span class="sxs-lookup"><span data-stu-id="4df4e-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="4df4e-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="4df4e-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="4df4e-209">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-209">External & Internal</span></span> |-
| <span data-ttu-id="4df4e-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="4df4e-210">* / 445</span></span> |<span data-ttu-id="4df4e-211">Règle de trafic sortant</span><span class="sxs-lookup"><span data-stu-id="4df4e-211">Outbound</span></span> |<span data-ttu-id="4df4e-212">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-212">TCP</span></span> |<span data-ttu-id="4df4e-213">Dépendance sur le partage de fichiers Azure pour GIT</span><span class="sxs-lookup"><span data-stu-id="4df4e-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="4df4e-214">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="4df4e-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="4df4e-215">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-215">External & Internal</span></span> |
| <span data-ttu-id="4df4e-216">* / *</span><span class="sxs-lookup"><span data-stu-id="4df4e-216">* / *</span></span> | <span data-ttu-id="4df4e-217">Trafic entrant</span><span class="sxs-lookup"><span data-stu-id="4df4e-217">Inbound</span></span> |<span data-ttu-id="4df4e-218">TCP</span><span class="sxs-lookup"><span data-stu-id="4df4e-218">TCP</span></span> |<span data-ttu-id="4df4e-219">Équilibrage de charge de l’infrastructure Azure</span><span class="sxs-lookup"><span data-stu-id="4df4e-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="4df4e-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="4df4e-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="4df4e-221">Externe et interne</span><span class="sxs-lookup"><span data-stu-id="4df4e-221">External & Internal</span></span> |

* <span data-ttu-id="4df4e-222">**Fonctionnalité SSL** : pour activer la génération et la validation de la chaîne de certification SSL, le service de gestion des API nécessite une connectivité réseau sortante vers ocsp.msocsp.com, mscrl.microsoft.com et crl.microsoft.com. Cette dépendance n’est pas requise si l’un des certificats que vous chargez sur la gestion de API contient la totalité de la chaîne permettant d’accéder à la racine de l’AC.</span><span class="sxs-lookup"><span data-stu-id="4df4e-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="4df4e-223">**Accès DNS** : l’accès sortant sur le port 53 est nécessaire pour la communication avec des serveurs DNS.</span><span class="sxs-lookup"><span data-stu-id="4df4e-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="4df4e-224">S'il existe un serveur DNS personnalisé à l'autre extrémité d'une passerelle VPN, le serveur DNS doit être accessible depuis le sous-réseau hébergeant la gestion de l’API.</span><span class="sxs-lookup"><span data-stu-id="4df4e-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="4df4e-225">**Métriques et surveillance de l’intégrité** : connectivité réseau sortante aux points de terminaison de la surveillance Azure, qui se résolvent sous les domaines suivants : global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="4df4e-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="4df4e-226">**Configuration d’Express Route** : une configuration client courante consiste à définir un itinéraire par défaut (0.0.0.0/0), ce qui force le trafic Internet sortant à circuler sur site.</span><span class="sxs-lookup"><span data-stu-id="4df4e-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="4df4e-227">Ce flux de trafic interrompt la connectivité avec la gestion des API Azure, car le trafic sortant peut être bloqué sur site, ou faire l’objet d’une opération NAT sur un jeu d’adresses non reconnaissable qui ne fonctionne plus avec différents points de terminaison Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="4df4e-228">La solution consiste à définir un (ou plusieurs) itinéraires définis par l’utilisateur ([UDR][UDRs]) sur le sous-réseau qui contient la gestion des API Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="4df4e-229">Un itinéraire défini par l'utilisateur définit des itinéraires spécifiques au sous-réseau qui seront respectés au lieu de l'itinéraire par défaut.</span><span class="sxs-lookup"><span data-stu-id="4df4e-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="4df4e-230">Si possible, il est recommandé d'utiliser la configuration suivante :</span><span class="sxs-lookup"><span data-stu-id="4df4e-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="4df4e-231">La configuration ExpressRoute annonce 0.0.0.0/0 et par défaut, tunnelise de force tout le trafic sortant sur site.</span><span class="sxs-lookup"><span data-stu-id="4df4e-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="4df4e-232">L’itinéraire défini par l'utilisateur appliqué au sous-réseau contenant la gestion des API Azure définit 0.0.0.0/0 avec un type de tronçon Internet suivant.</span><span class="sxs-lookup"><span data-stu-id="4df4e-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="4df4e-233">Le résultat est que l’itinéraire défini par l'utilisateur au niveau du sous-réseau a la priorité sur le tunneling forcé ExpressRoute, garantissant ainsi un accès Internet sortant à partir de la gestion des API Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="4df4e-234">La gestion des API Azure n’est pas prise en charge avec les configurations ExpressRoute qui **publient incorrectement de façon croisée des itinéraires à partir du chemin d’accès d’homologation publique vers le chemin d’accès d’homologation privée**.</span><span class="sxs-lookup"><span data-stu-id="4df4e-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="4df4e-235">Les configurations ExpressRoute ayant une homologation publique configurée reçoivent les annonces de routage depuis Microsoft pour un grand ensemble de plages d'adresses IP Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="4df4e-236">Si ces plages d’adresses sont incorrectement publiées de façon croisée sur le chemin d’accès d’homologation privée, il en résulte que tous les paquets réseau sortants du sous-réseau de l’instance de la gestion des API Azure sont incorrectement acheminés de force vers l’infrastructure réseau sur site d’un client.</span><span class="sxs-lookup"><span data-stu-id="4df4e-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="4df4e-237">Ce flux réseau interrompt la gestion des API Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="4df4e-238">La solution à ce problème consiste à arrêter les itinéraires croisés depuis le chemin d'accès d'homologation publique vers le chemin d'accès d'homologation privée.</span><span class="sxs-lookup"><span data-stu-id="4df4e-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="4df4e-239"><a name="troubleshooting"> </a>Résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="4df4e-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="4df4e-240">Lorsque vous modifiez votre réseau, consultez [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus) pour confirmer que le service de la gestion de l’API n’a pas perdu l’accès aux ressources critiques dont il dépend.</span><span class="sxs-lookup"><span data-stu-id="4df4e-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="4df4e-241">L’état de connectivité doit être mis à jour toutes les 15 minutes.</span><span class="sxs-lookup"><span data-stu-id="4df4e-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="4df4e-242"><a name="limitations"> </a>Limitations</span><span class="sxs-lookup"><span data-stu-id="4df4e-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="4df4e-243">Un sous-réseau contenant des instances du service Gestion des API ne peut pas contenir d’autres types de ressource Azure.</span><span class="sxs-lookup"><span data-stu-id="4df4e-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="4df4e-244">Le sous-réseau et le service Gestion des API doivent figurer dans le même abonnement.</span><span class="sxs-lookup"><span data-stu-id="4df4e-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="4df4e-245">Un sous-réseau contenant des instances du service Gestion des API ne peut pas être déplacé entre des abonnements.</span><span class="sxs-lookup"><span data-stu-id="4df4e-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="4df4e-246">Lorsque vous utilisez un réseau virtuel interne, seule une adresse IP interne est disponible dans la plage indiquée dans [RFC 1918](https://tools.ietf.org/html/rfc1918) ; une adresse IP publique ne peut pas être fournie.</span><span class="sxs-lookup"><span data-stu-id="4df4e-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="4df4e-247">Pour les déploiements du service de gestion des API dans plusieurs régions avec des réseaux virtuels internes configurés, les utilisateurs sont chargés de gérer leur propre équilibrage de charge, car ils possèdent le DNS.</span><span class="sxs-lookup"><span data-stu-id="4df4e-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="4df4e-248"><a name="related-content"> </a>Contenu connexe</span><span class="sxs-lookup"><span data-stu-id="4df4e-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="4df4e-249">Connexion d’un réseau virtuel au serveur principal à l’aide de la passerelle VPN</span><span class="sxs-lookup"><span data-stu-id="4df4e-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="4df4e-250">Connexion d’un réseau virtuel utilisant des modèles de déploiement différents</span><span class="sxs-lookup"><span data-stu-id="4df4e-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="4df4e-251">Utilisation de l’inspecteur d’API pour le suivi des appels dans Gestion des API Azure</span><span class="sxs-lookup"><span data-stu-id="4df4e-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
