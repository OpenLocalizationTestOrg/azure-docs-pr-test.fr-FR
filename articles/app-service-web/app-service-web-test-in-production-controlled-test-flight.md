---
title: "Déploiement avec distribution d’une version d’évaluation (test bêta) dans Azure App Service"
description: "Apprenez à déployer de nouvelles fonctionnalités dans votre application ou à tester vos mises à jour en mode bêta grâce à ce didacticiel de bout en bout. Il réunit les fonctionnalités App Service comme la publication continue, les emplacements, le routage du trafic et l’intégration d’Application Insights."
services: app-service\web
documentationcenter: 
author: cephalin
manager: erikre
editor: 
ms.assetid: 17953c51-38f8-442d-bb0b-f69c1542f0e9
ms.service: app-service-web
ms.workload: web
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/02/2016
ms.author: cephalin
ms.openlocfilehash: 83e3247310461ac148fff3c4ade3aa7216478537
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="flighting-deployment-beta-testing-in-azure-app-service"></a><span data-ttu-id="ab27d-104">Déploiement avec distribution d’une version d’évaluation (test bêta) dans Azure App Service</span><span class="sxs-lookup"><span data-stu-id="ab27d-104">Flighting deployment (beta testing) in Azure App Service</span></span>
<span data-ttu-id="ab27d-105">Ce didacticiel vous montre comment procéder à des *déploiements avec distribution d’une version d’évaluation* en intégrant les différentes fonctionnalités d’[Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714) et d’[Azure Application Insights](/services/application-insights/).</span><span class="sxs-lookup"><span data-stu-id="ab27d-105">This tutorial shows you how to do *flighting deployments* by integrating the various capabilities of [Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714) and [Azure Application Insights](/services/application-insights/).</span></span>

<span data-ttu-id="ab27d-106">La *distribution d’une version d’évaluation* est un processus de déploiement qui valide une nouvelle fonctionnalité ou une modification auprès d’un nombre limité de clients réels. Il s’agit d’un test majeur dans un scénario de production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-106">*Flighting* is a deployment process that validates a new feature or change with a limited number of real customers, and is a major testing in production scenario.</span></span> <span data-ttu-id="ab27d-107">Cette opération est comparable à un test bêta et est parfois appelée « version de test contrôlée ».</span><span class="sxs-lookup"><span data-stu-id="ab27d-107">It is akin to beta testing and is sometimes known as "controlled test flight".</span></span> <span data-ttu-id="ab27d-108">Beaucoup de grandes entreprises avec une présence web utilisent cette approche pour obtenir les premières validations de leurs mises à jour d’application dans leur pratique de [développement agile](https://en.wikipedia.org/wiki/Agile_software_development).</span><span class="sxs-lookup"><span data-stu-id="ab27d-108">Many large enterprises with a web presence use this approach to get early validation on their app updates in their practice of [agile development](https://en.wikipedia.org/wiki/Agile_software_development).</span></span> <span data-ttu-id="ab27d-109">Azure App Service vous permet d’intégrer le test en production à la publication continue et à Application Insights pour implémenter le même scénario d’opérations de développement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-109">Azure App Service enables you to integrate test in production with continous publishing and Application Insights to implement the same DevOps scenario.</span></span> <span data-ttu-id="ab27d-110">Avantages de cette approche :</span><span class="sxs-lookup"><span data-stu-id="ab27d-110">Benefits of this approach include:</span></span>

* <span data-ttu-id="ab27d-111">**Obtenir des commentaires réels *avant* la sortie des mises à jour en production** : qu’y a-t-il de mieux qu’obtenir des commentaires dès la sortie de votre application ? Les obtenir avant !</span><span class="sxs-lookup"><span data-stu-id="ab27d-111">**Gain real feedback *before* updates are released to production** - The only thing better than gaining feedback as soon as you release is gaining feedback before you release.</span></span> <span data-ttu-id="ab27d-112">Vous pouvez tester les mises à jour avec le trafic et les comportements des utilisateurs réels dès que vous le souhaitez dans le cycle de vie du produit.</span><span class="sxs-lookup"><span data-stu-id="ab27d-112">You can test updates with real user traffic and behaviors as early as you desire in the product life cycle.</span></span>
* <span data-ttu-id="ab27d-113">**Améliorer [ le développement continu piloté par les tests](https://en.wikipedia.org/wiki/Continuous_test-driven_development)** : en intégrant des tests en production avec une intégration et une instrumentation continues dans Application Insights, la validation utilisateur se produit automatiquement et très tôt dans le cycle de vie du produit.</span><span class="sxs-lookup"><span data-stu-id="ab27d-113">**Enhance [continuous test-driven development (CTDD)](https://en.wikipedia.org/wiki/Continuous_test-driven_development)** - By integrating test in production with continuous integration and instrumentation with Application Insights, user validation happens early and automatically in your product life cycle.</span></span> <span data-ttu-id="ab27d-114">Cela contribue à réduire les investissements en temps dans l’exécution de tests manuels.</span><span class="sxs-lookup"><span data-stu-id="ab27d-114">This helps reduce time investments in manual test execution.</span></span>
* <span data-ttu-id="ab27d-115">**Optimiser le workflow de test** : grâce à l’automatisation du test en production avec une instrumentation de surveillance continue, vous pouvez potentiellement atteindre les objectifs de différents genres de tests dans un processus unique, notamment l’[intégration](https://en.wikipedia.org/wiki/Integration_testing), la [régression](https://en.wikipedia.org/wiki/Regression_testing), la [convivialité](https://en.wikipedia.org/wiki/Usability_testing), l’accessibilité, la localisation, les [performances](https://en.wikipedia.org/wiki/Software_performance_testing), la [sécurité](https://en.wikipedia.org/wiki/Security_testing) et l’[acceptation](https://en.wikipedia.org/wiki/Acceptance_testing).</span><span class="sxs-lookup"><span data-stu-id="ab27d-115">**Optimize test workflow** - By automating test in production with continuous monitoring instrumentation, you can potentially accomplish the goals of various kinds of tests in a single process, such as [integration](https://en.wikipedia.org/wiki/Integration_testing), [regression](https://en.wikipedia.org/wiki/Regression_testing), [usability](https://en.wikipedia.org/wiki/Usability_testing), accessibility, localization, [performance](https://en.wikipedia.org/wiki/Software_performance_testing), [security](https://en.wikipedia.org/wiki/Security_testing), and [acceptance](https://en.wikipedia.org/wiki/Acceptance_testing).</span></span>

<span data-ttu-id="ab27d-116">Un déploiement avec distribution d’une version d’évaluation ne se limite pas au routage du trafic en direct.</span><span class="sxs-lookup"><span data-stu-id="ab27d-116">A flighting deployment is not just about routing live traffic.</span></span> <span data-ttu-id="ab27d-117">Dans un tel déploiement, vous souhaitez bénéficier d’une visibilité aussi rapidement que possible, en cas de bogues inattendus, de dégradation des performances ou de problèmes d’expérience utilisateur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-117">In such a deployment you want to gain insight as quickly as possible, whether it be an unexpected bug, performance degradation, user experience issues.</span></span> <span data-ttu-id="ab27d-118">N’oubliez pas : vous êtes confronté à des clients réels.</span><span class="sxs-lookup"><span data-stu-id="ab27d-118">Remember, you are dealing with real customers.</span></span> <span data-ttu-id="ab27d-119">Pour faire les choses correctement, vous devez donc vous assurer que vous avez configuré votre déploiement avec distribution d’une version d’évaluation de manière à collecter toutes les données requises afin de prendre une décision éclairée à l’étape suivante.</span><span class="sxs-lookup"><span data-stu-id="ab27d-119">So to do it right, you must make sure that you have set up your flighting deployment to gather all the data you need in order to make an informed decision for your next step.</span></span> <span data-ttu-id="ab27d-120">Ce didacticiel vous montre comment collecter des données avec Application Insights. Toutefois, vous pouvez utiliser New Relic ou d’autres technologies adaptées à votre scénario.</span><span class="sxs-lookup"><span data-stu-id="ab27d-120">This tutorial shows you how to collect data with Application Insights, but you can use New Relic or other technologies that suits your scenario.</span></span>

## <a name="what-you-will-do"></a><span data-ttu-id="ab27d-121">Procédure à suivre</span><span class="sxs-lookup"><span data-stu-id="ab27d-121">What you will do</span></span>
<span data-ttu-id="ab27d-122">Dans ce didacticiel, vous allez apprendre à rassembler les scénarios suivants pour tester votre application App Service en production :</span><span class="sxs-lookup"><span data-stu-id="ab27d-122">In this tutorial, you will learn how to bring the following scenarios together to test your App Service app in production:</span></span>

* <span data-ttu-id="ab27d-123">[Acheminer le trafic de production](app-service-web-test-in-production-get-start.md) vers votre application bêta</span><span class="sxs-lookup"><span data-stu-id="ab27d-123">[Route production traffic](app-service-web-test-in-production-get-start.md) to your beta app</span></span>
* <span data-ttu-id="ab27d-124">[Instrumenter votre application](../application-insights/app-insights-web-track-usage.md) pour obtenir des mesures utiles</span><span class="sxs-lookup"><span data-stu-id="ab27d-124">[Instrument your app](../application-insights/app-insights-web-track-usage.md) to obtain useful metrics</span></span>
* <span data-ttu-id="ab27d-125">Déployer votre application bêta et suivre les mesures de l’application en direct en continu</span><span class="sxs-lookup"><span data-stu-id="ab27d-125">Continuously deploy your beta app and track live app metrics</span></span>
* <span data-ttu-id="ab27d-126">Comparer des mesures entre l’application de production et l’application bêta pour voir comment les modifications de code se traduisent en résultats</span><span class="sxs-lookup"><span data-stu-id="ab27d-126">Compare metrics between the production app and the beta app to see how code changes translate to results</span></span>

## <a name="what-you-will-need"></a><span data-ttu-id="ab27d-127">Éléments requis</span><span class="sxs-lookup"><span data-stu-id="ab27d-127">What you will need</span></span>
* <span data-ttu-id="ab27d-128">Un compte Azure</span><span class="sxs-lookup"><span data-stu-id="ab27d-128">An Azure account</span></span>
* <span data-ttu-id="ab27d-129">Un compte [GitHub](https://github.com/)</span><span class="sxs-lookup"><span data-stu-id="ab27d-129">A [GitHub](https://github.com/) account</span></span>
* <span data-ttu-id="ab27d-130">Visual Studio 2015 : vous pouvez télécharger l’[édition Community](https://www.visualstudio.com/en-us/products/visual-studio-express-vs.aspx).</span><span class="sxs-lookup"><span data-stu-id="ab27d-130">Visual Studio 2015 - you can download the [Community edition](https://www.visualstudio.com/en-us/products/visual-studio-express-vs.aspx).</span></span>
* <span data-ttu-id="ab27d-131">Git Shell (installé avec [GitHub for Windows](https://windows.github.com/)) : cela permet d’exécuter des commandes PowerShell et Git dans la même session</span><span class="sxs-lookup"><span data-stu-id="ab27d-131">Git Shell (installed with [GitHub for Windows](https://windows.github.com/)) - this enables you to run both the Git and PowerShell commands in the same session</span></span>
* <span data-ttu-id="ab27d-132">Dernières informations [Azure PowerShell](https://github.com/Azure/azure-powershell/releases/download/v0.9.8-September2015/azure-powershell.0.9.8.msi)</span><span class="sxs-lookup"><span data-stu-id="ab27d-132">Latest [Azure PowerShell](https://github.com/Azure/azure-powershell/releases/download/v0.9.8-September2015/azure-powershell.0.9.8.msi) bits</span></span>
* <span data-ttu-id="ab27d-133">Compréhension élémentaire des concepts et outils suivants :</span><span class="sxs-lookup"><span data-stu-id="ab27d-133">Basic understanding of the following:</span></span>
  * <span data-ttu-id="ab27d-134">Déploiement de modèles [Azure Resource Manager](../azure-resource-manager/resource-group-overview.md) (voir [Déployer une application complexe de manière prévisible dans Microsoft Azure](app-service-deploy-complex-application-predictably.md))</span><span class="sxs-lookup"><span data-stu-id="ab27d-134">[Azure Resource Manager](../azure-resource-manager/resource-group-overview.md) template deployment (see [Deploy a complex application predictably in Azure](app-service-deploy-complex-application-predictably.md))</span></span>
  * [<span data-ttu-id="ab27d-135">Git</span><span class="sxs-lookup"><span data-stu-id="ab27d-135">Git</span></span>](http://git-scm.com/documentation)
  * [<span data-ttu-id="ab27d-136">PowerShell</span><span class="sxs-lookup"><span data-stu-id="ab27d-136">PowerShell</span></span>](https://technet.microsoft.com/library/bb978526.aspx)

> [!NOTE]
> <span data-ttu-id="ab27d-137">Pour suivre ce didacticiel, vous avez besoin d'un compte Azure :</span><span class="sxs-lookup"><span data-stu-id="ab27d-137">You need an Azure account to complete this tutorial:</span></span>
>
> * <span data-ttu-id="ab27d-138">Vous pouvez [ouvrir un compte Azure gratuitement](https://azure.microsoft.com/pricing/free-trial/) : vous obtenez alors des crédits dont vous pouvez vous servir pour tester les services Azure payants, et même quand ils sont épuisés, vous pouvez conserver le compte et utiliser les services Azure gratuits, notamment Web Apps.</span><span class="sxs-lookup"><span data-stu-id="ab27d-138">You can [open an Azure account for free](https://azure.microsoft.com/pricing/free-trial/) - You get credits you can use to try out paid Azure services, and even after they're used up you can keep the account and use free Azure services, such as Web Apps.</span></span>
> * <span data-ttu-id="ab27d-139">Vous pouvez [activer les avantages de votre abonnement Visual Studio](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) : votre abonnement Visual Studio vous donne droit chaque mois à des crédits dont vous pouvez vous servir pour les services Azure payants.</span><span class="sxs-lookup"><span data-stu-id="ab27d-139">You can [activate Visual Studio subscriber benefits](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) - Your Visual Studio subscription gives you credits every month that you can use for paid Azure services.</span></span>
>
> <span data-ttu-id="ab27d-140">Si vous voulez vous familiariser avec Azure App Service avant d’ouvrir un compte Azure, accédez à la page [Essayer App Service](https://azure.microsoft.com/try/app-service/), où vous pourrez créer immédiatement une application web temporaire dans App Service.</span><span class="sxs-lookup"><span data-stu-id="ab27d-140">If you want to get started with Azure App Service before signing up for an Azure account, go to [Try App Service](https://azure.microsoft.com/try/app-service/), where you can immediately create a short-lived starter web app in App Service.</span></span> <span data-ttu-id="ab27d-141">Aucune carte de crédit n’est requise ; vous ne prenez aucun engagement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-141">No credit cards required; no commitments.</span></span>
>
>

## <a name="set-up-your-production-web-app"></a><span data-ttu-id="ab27d-142">Configurer votre application web de production</span><span class="sxs-lookup"><span data-stu-id="ab27d-142">Set up your production web app</span></span>
> [!NOTE]
> <span data-ttu-id="ab27d-143">Le script utilisé dans ce didacticiel configure automatiquement la publication continue à partir de votre référentiel GitHub.</span><span class="sxs-lookup"><span data-stu-id="ab27d-143">The script used in this tutorial will automatically configure continuous publishing from your GitHub repository.</span></span> <span data-ttu-id="ab27d-144">Pour ce faire, vos informations d’identification GitHub doivent déjà être stockées dans Azure, sinon les scripts de déploiement échoueront lorsque vous tenterez de configurer les paramètres de contrôle de code source pour les applications web.</span><span class="sxs-lookup"><span data-stu-id="ab27d-144">This requires that your GitHub credentials are already stored in Azure, otherwise the scripted deployment will fail when attempting to configure source control settings for the web apps.</span></span>
>
> <span data-ttu-id="ab27d-145">Pour stocker vos informations d’identification GitHub dans Azure, créez une application web dans le [portail Azure](https://portal.azure.com/) et [configurez le déploiement GitHub](app-service-continuous-deployment.md).</span><span class="sxs-lookup"><span data-stu-id="ab27d-145">To store your GitHub credentials in Azure, create a web app in the [Azure Portal](https://portal.azure.com/) and [configure GitHub deployment](app-service-continuous-deployment.md).</span></span> <span data-ttu-id="ab27d-146">Cette opération est unique.</span><span class="sxs-lookup"><span data-stu-id="ab27d-146">You only need to do this once.</span></span>
>
>

<span data-ttu-id="ab27d-147">Dans un scénario classique d’opérations de développement, vous disposez d’une application qui s’exécute dans Azure et vous souhaitez lui apporter des modifications par le biais de la publication continue.</span><span class="sxs-lookup"><span data-stu-id="ab27d-147">In a typical DevOps scenario, you have an application that’s running live in Azure, and you want to make changes to it through continuous publishing.</span></span> <span data-ttu-id="ab27d-148">Dans ce scénario, vous allez déployer en production un modèle que vous avez développé et testé.</span><span class="sxs-lookup"><span data-stu-id="ab27d-148">In this scenario, you will deploy to production a template that you have developed and tested.</span></span>

1. <span data-ttu-id="ab27d-149">Créez votre branchement dans le référentiel [ToDoApp](https://github.com/azure-appservice-samples/ToDoApp) .</span><span class="sxs-lookup"><span data-stu-id="ab27d-149">Create your own fork of the [ToDoApp](https://github.com/azure-appservice-samples/ToDoApp) repository.</span></span> <span data-ttu-id="ab27d-150">Pour plus d’informations sur la création de votre branchement, consultez [Branchement dans un référentiel](https://help.github.com/articles/fork-a-repo/).</span><span class="sxs-lookup"><span data-stu-id="ab27d-150">For information on creating your fork, see [Fork a Repo](https://help.github.com/articles/fork-a-repo/).</span></span> <span data-ttu-id="ab27d-151">Une fois votre branchement créé, il est visible dans votre navigateur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-151">Once your fork is created, you can see it in your browser.</span></span>

   ![](./media/app-service-agile-software-development/production-1-private-repo.png)
2. <span data-ttu-id="ab27d-152">Ouvrez une session Git Shell.</span><span class="sxs-lookup"><span data-stu-id="ab27d-152">Open a Git Shell session.</span></span> <span data-ttu-id="ab27d-153">Si vous n’avez pas encore Git Shell, installez [GitHub for Windows](https://windows.github.com/) .</span><span class="sxs-lookup"><span data-stu-id="ab27d-153">If you don't have Git Shell yet, install [GitHub for Windows](https://windows.github.com/) now.</span></span>
3. <span data-ttu-id="ab27d-154">Créez un clone local de votre branchement en exécutant la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="ab27d-154">Create a local clone of your fork by executing the following command:</span></span>

     <span data-ttu-id="ab27d-155">git clone https://github.com/<your_fork>/ToDoApp.git</span><span class="sxs-lookup"><span data-stu-id="ab27d-155">git clone https://github.com/<your_fork>/ToDoApp.git</span></span>
4. <span data-ttu-id="ab27d-156">Lorsque le clone local est créé, accédez à *&lt;racine_référentiel>*\ARMTemplates, puis exécutez le script deploy.ps1 avec un suffixe unique, comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="ab27d-156">Once you have your local clone, navigate to *&lt;repository_root>*\ARMTemplates, and run the deploy.ps1 script with a unique suffix, as shown below:</span></span>

     <span data-ttu-id="ab27d-157">.\deploy.ps1 –RepoUrl https://github.com/<your_fork>/todoapp.git -ResourceGroupSuffix <your_suffix></span><span class="sxs-lookup"><span data-stu-id="ab27d-157">.\deploy.ps1 –RepoUrl https://github.com/<your_fork>/todoapp.git -ResourceGroupSuffix <your_suffix></span></span>
5. <span data-ttu-id="ab27d-158">Lorsque vous y êtes invité, tapez le nom d’utilisateur et le mot de passe souhaités pour l’accès à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ab27d-158">When prompted, type in the desired username and password for database access.</span></span> <span data-ttu-id="ab27d-159">N’oubliez pas vos informations d’identification à la base de données, car vous devrez les spécifier de nouveau lors de la mise à jour du groupe de ressources.</span><span class="sxs-lookup"><span data-stu-id="ab27d-159">Remember your database credentials because you will need to specify them again when updating the resource group.</span></span>

   <span data-ttu-id="ab27d-160">Vous devez voir l’avancement de la configuration des différentes ressources Azure.</span><span class="sxs-lookup"><span data-stu-id="ab27d-160">You should see the provisioning progress of various Azure resources.</span></span> <span data-ttu-id="ab27d-161">Lorsque le déploiement est terminé, le script lance l’application dans le navigateur et émet un signal sonore convivial.</span><span class="sxs-lookup"><span data-stu-id="ab27d-161">When deployment completes, the script will launch the application in the browser and give you a friendly beep.</span></span>
   ![](./media/app-service-web-test-in-production-controlled-test-flight/00.1-app-in-browser.png)
6. <span data-ttu-id="ab27d-162">De retour dans votre session Git Shell, exécutez :</span><span class="sxs-lookup"><span data-stu-id="ab27d-162">Back in your Git Shell session, run:</span></span>

     <span data-ttu-id="ab27d-163">.\swap –Name ToDoApp<your_suffix></span><span class="sxs-lookup"><span data-stu-id="ab27d-163">.\swap –Name ToDoApp<your_suffix></span></span>

   ![](./media/app-service-web-test-in-production-controlled-test-flight/00.2-swap-to-production.png)
7. <span data-ttu-id="ab27d-164">Lorsque le script se termine, revenez en arrière pour accéder à l’adresse du serveur frontal (http://ToDoApp*&lt;votre_suffixe>*.azurewebsites.net/) afin d’afficher l’application qui s’exécute en production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-164">When the script finishes, go back to browse to the frontend’s address (http://ToDoApp*&lt;your_suffix>*.azurewebsites.net/) to see the application running in production.</span></span>
8. <span data-ttu-id="ab27d-165">Connectez-vous au [portail Azure](https://portal.azure.com/) et observez ce qui est créé.</span><span class="sxs-lookup"><span data-stu-id="ab27d-165">Log into the [Azure Portal](https://portal.azure.com/) and take a look at what’s created.</span></span>

   <span data-ttu-id="ab27d-166">Les deux applications web doivent figurer dans le même groupe de ressources, et le nom de l’une d’elles doit comporter le suffixe `Api` .</span><span class="sxs-lookup"><span data-stu-id="ab27d-166">You should be able to see two web apps in the same resource group, one with the `Api` suffix in the name.</span></span> <span data-ttu-id="ab27d-167">Si vous examinez l’affichage de groupe de ressources, vous pouvez voir également la base de données et le serveur SQL, le plan App Service et les emplacements intermédiaires pour les applications web.</span><span class="sxs-lookup"><span data-stu-id="ab27d-167">If you look at the resource group view, you will also see the SQL Database and server, the App Service plan, and the staging slots for the web apps.</span></span> <span data-ttu-id="ab27d-168">Parcourez les différentes ressources et comparez-les à *&lt;racine_référentiel>*\ARMTemplates\ProdAndStage.json pour voir comment elles sont configurées dans le modèle.</span><span class="sxs-lookup"><span data-stu-id="ab27d-168">Browse through the different resources and compare them with *&lt;repository_root>*\ARMTemplates\ProdAndStage.json to see how they are configured in the template.</span></span>

   ![](./media/app-service-web-test-in-production-controlled-test-flight/00.3-resource-group-view.png)

<span data-ttu-id="ab27d-169">Vous avez configuré l’application de production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-169">You have set up the production app.</span></span>  <span data-ttu-id="ab27d-170">À présent, imaginons que vous receviez des commentaires indiquant que la facilité d’utilisation de l’application est médiocre.</span><span class="sxs-lookup"><span data-stu-id="ab27d-170">Now, let's imagine that you receive feedback that usability is poor for the app.</span></span> <span data-ttu-id="ab27d-171">Vous décidez alors de mener l’enquête.</span><span class="sxs-lookup"><span data-stu-id="ab27d-171">So you decide to investigate.</span></span> <span data-ttu-id="ab27d-172">Vous allez instrumenter votre application de sorte qu’elle vous fournisse des commentaires.</span><span class="sxs-lookup"><span data-stu-id="ab27d-172">You're going to instrument your app to give you feedback.</span></span>

## <a name="investigate-instrument-your-client-app-for-monitoringmetrics"></a><span data-ttu-id="ab27d-173">Enquête : Instrumenter votre application cliente aux fins de surveillance/mesures</span><span class="sxs-lookup"><span data-stu-id="ab27d-173">Investigate: Instrument your client app for monitoring/metrics</span></span>
1. <span data-ttu-id="ab27d-174">Ouvrez *&lt;racine_référentiel>*\src\MultiChannelToDo.sln dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="ab27d-174">Open *&lt;repository_root>*\src\MultiChannelToDo.sln in Visual Studio.</span></span>
2. <span data-ttu-id="ab27d-175">Restaurez tous les packages Nuget en cliquant avec le bouton droit sur la solution > **Gérer les packages NuGet pour la solution** > **Restaurer**.</span><span class="sxs-lookup"><span data-stu-id="ab27d-175">Restore all Nuget packages by right-clicking solution > **Manage NuGet Packages for Solution** > **Restore**.</span></span>
3. <span data-ttu-id="ab27d-176">Cliquez avec le bouton droit sur  **MultiChannelToDo.Web** > **Ajouter Application Insights Telemetry** > **Configurer les paramètres** > Modifier le groupe de ressources en ToDoApp*&lt;votre_suffixe>* > **Ajouter Application Insights au projet**.</span><span class="sxs-lookup"><span data-stu-id="ab27d-176">Right-click **MultiChannelToDo.Web** > **Add Application Insights Telemetry** > **Configure Settings** > Change resource group to ToDoApp*&lt;your_suffix>* > **Add Application Insights to Project**.</span></span>
4. <span data-ttu-id="ab27d-177">Dans le portail Azure, ouvrez le panneau de la ressource Application Insights **MultiChannelToDo.Web** .</span><span class="sxs-lookup"><span data-stu-id="ab27d-177">In the Azure Portal, open the blade for the **MultiChannelToDo.Web** Application Insight resource.</span></span> <span data-ttu-id="ab27d-178">Ensuite, dans la partie **Intégrité des applications**, cliquez sur **Apprendre à collecter les données de chargement de page de navigateur** > Copier le code.</span><span class="sxs-lookup"><span data-stu-id="ab27d-178">Then in the **Application health** part, click **Learn how to collect browser page load data** > copy code.</span></span>
5. <span data-ttu-id="ab27d-179">Ajoutez le code d’instrumentation JS copié à *&lt;racine_référentiel>*\src\MultiChannelToDo.Web\app\Index.cshtml, juste avant la balise de fermeture `<heading>`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-179">Add the copied JS instrumentation code to *&lt;repository_root>*\src\MultiChannelToDo.Web\app\Index.cshtml, just before the closing `<heading>` tag.</span></span> <span data-ttu-id="ab27d-180">Il doit contenir la clé d’instrumentation unique de votre ressource Application Insights.</span><span class="sxs-lookup"><span data-stu-id="ab27d-180">It should contain the unique instrumentation key of your Application Insight resource.</span></span>

        <script type="text/javascript">
        var appInsights=window.appInsights||function(config){
            function s(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},r=document,f=window,e="script",o=r.createElement(e),i,u;for(o.src=config.url||"//az416426.vo.msecnd.net/scripts/a/ai.0.js",r.getElementsByTagName(e)[0].parentNode.appendChild(o),t.cookie=r.cookie,t.queue=[],i=["Event","Exception","Metric","PageView","Trace"];i.length;)s("track"+i.pop());return config.disableExceptionTracking||(i="onerror",s("_"+i),u=f[i],f[i]=function(config,r,f,e,o){var s=u&&u(config,r,f,e,o);return s!==!0&&t["_"+i](config,r,f,e,o),s}),t
        }({
            instrumentationKey:"<your_unique_instrumentation_key>"
        });

        window.appInsights=appInsights;
        appInsights.trackPageView();
        </script>
6. <span data-ttu-id="ab27d-181">Envoyez des événements personnalisés à Application Insights pour les clics de souris en ajoutant le code suivant en bas du corps :</span><span class="sxs-lookup"><span data-stu-id="ab27d-181">Send custom events to Application Insights for mouse clicks by adding the following code to the bottom of body:</span></span>

       <script>
           $(document.body).find("*").click(function(event) {

               appInsights.trackEvent(event.target.tagName + ": " + event.target.className);
           });
       </script>

   <span data-ttu-id="ab27d-182">Cet extrait de code JavaScript envoie un événement personnalisé à Application Insights chaque fois qu’un utilisateur clique dans l’application web.</span><span class="sxs-lookup"><span data-stu-id="ab27d-182">This JavaScript snippet sends a custom event to Application Insights every time a user clicks anywhere in the web app.</span></span>
7. <span data-ttu-id="ab27d-183">Dans Git Shell, validez et envoyez vos modifications à votre branchement dans GitHub.</span><span class="sxs-lookup"><span data-stu-id="ab27d-183">In Git Shell, commit and push your changes to your fork in GitHub.</span></span> <span data-ttu-id="ab27d-184">Ensuite, attendez que les clients actualisent le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-184">Then, wait for clients to refresh browser.</span></span>

       git add -A :/
       git commit -m "add AI configuration for client app"
       git push origin master
8. <span data-ttu-id="ab27d-185">Échangez les modifications de l’application déployée en production :</span><span class="sxs-lookup"><span data-stu-id="ab27d-185">Swap the deployed app changes to production:</span></span>

     <span data-ttu-id="ab27d-186">.\swap –Name ToDoApp<your_suffix></span><span class="sxs-lookup"><span data-stu-id="ab27d-186">.\swap –Name ToDoApp<your_suffix></span></span>
9. <span data-ttu-id="ab27d-187">Accédez à la ressource Application Insights que vous avez configurée.</span><span class="sxs-lookup"><span data-stu-id="ab27d-187">Browse to the Application Insights resource that you configured.</span></span> <span data-ttu-id="ab27d-188">Cliquez sur Événements personnalisés.</span><span class="sxs-lookup"><span data-stu-id="ab27d-188">Click Custom events.</span></span>

   ![](./media/app-service-web-test-in-production-controlled-test-flight/01-custom-events.png)

   <span data-ttu-id="ab27d-189">Si vous ne voyez pas les mesures pour les événements personnalisés, attendez quelques minutes et cliquez sur **Actualiser**.</span><span class="sxs-lookup"><span data-stu-id="ab27d-189">If you don't see metrics for custom events, wait a few minutes and click **Refresh**.</span></span>

<span data-ttu-id="ab27d-190">Supposons que vous voyiez un graphique comme ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="ab27d-190">Suppose you see a chart like below:</span></span>

![](./media/app-service-web-test-in-production-controlled-test-flight/02-custom-events-chart-view.png)

<span data-ttu-id="ab27d-191">Et la grille d’événements ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="ab27d-191">And the event grid below it:</span></span>

![](./media/app-service-web-test-in-production-controlled-test-flight/03-custom-event-grid-view.png)

<span data-ttu-id="ab27d-192">En fonction de votre code d’application ToDoApp, l’événement **BUTTON** correspond au bouton d’envoi et l’événement **INPUT** à la zone de texte.</span><span class="sxs-lookup"><span data-stu-id="ab27d-192">According to your ToDoApp application code, the **BUTTON** event corresponds to the submit button, and the **INPUT** event corresponds to the textbox.</span></span> <span data-ttu-id="ab27d-193">Jusqu’à présent, tout est logique.</span><span class="sxs-lookup"><span data-stu-id="ab27d-193">So far, things make sense.</span></span> <span data-ttu-id="ab27d-194">Cependant, il semble y avoir une grande quantité de clics, mais très peu de clics sur les tâches à effectuer (événements **LI** ).</span><span class="sxs-lookup"><span data-stu-id="ab27d-194">However, it looks like there's a good amount of clicks and very few clicks on the to-do items (the **LI** events).</span></span>

<span data-ttu-id="ab27d-195">En vous appuyant sur ces informations, vous formulez votre hypothèse : certains utilisateurs ne savent pas bien quelle partie de l’interface utilisateur est interactive, et c’est parce que le curseur est stylisé pour la sélection de texte lorsqu’il survole les éléments de liste et leurs icônes.</span><span class="sxs-lookup"><span data-stu-id="ab27d-195">Based on this, you form your hypothesis that some users are confused which part of the UI is clickable and it is because the cursor is styled for text selection when it hovers on the list items and their icons.</span></span>

![](./media/app-service-web-test-in-production-controlled-test-flight/04-to-do-list-item-ui.png)

<span data-ttu-id="ab27d-196">Il peut s’agir d’un exemple fictif.</span><span class="sxs-lookup"><span data-stu-id="ab27d-196">This might be a contrived example.</span></span> <span data-ttu-id="ab27d-197">Néanmoins, vous allez apporter une amélioration à votre application, puis effectuer un déploiement avec distribution d’une version d’évaluation pour obtenir des commentaires sur la facilité d’utilisation de la part des clients en direct.</span><span class="sxs-lookup"><span data-stu-id="ab27d-197">Nevertheless, you're going to make an improvement to your app, and then perform a flighting deployment to get usability feedback from live customers.</span></span>

### <a name="instrument-your-server-app-for-monitoringmetrics"></a><span data-ttu-id="ab27d-198">Instrumenter votre application serveur aux fins de surveillance/mesures</span><span class="sxs-lookup"><span data-stu-id="ab27d-198">Instrument your server app for monitoring/metrics</span></span>
<span data-ttu-id="ab27d-199">Il s’agit d’une digression étant donné que le scénario présenté dans ce didacticiel traite uniquement de l’application cliente.</span><span class="sxs-lookup"><span data-stu-id="ab27d-199">This is a tangent since the scenario demonstrated in this tutorial only deals with the client app.</span></span> <span data-ttu-id="ab27d-200">Toutefois, par souci d’exhaustivité, vous allez configurer l’application côté serveur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-200">However, for completeness you will set up the server-side app.</span></span>

1. <span data-ttu-id="ab27d-201">Cliquez avec le bouton droit sur **MultiChannelToDo** > **Ajouter Application Insights Telemetry** > **Configurer les paramètres** > Modifier le groupe de ressources en ToDoApp*&lt;votre_suffixe>* > **Ajouter Application Insights au projet**.</span><span class="sxs-lookup"><span data-stu-id="ab27d-201">Right-click **MultiChannelToDo** > **Add Application Insights Telemetry** > **Configure Settings** > Change resource group to ToDoApp*&lt;your_suffix>* > **Add Application Insights to Project**.</span></span>
2. <span data-ttu-id="ab27d-202">Dans Git Shell, validez et envoyez vos modifications à votre branchement dans GitHub.</span><span class="sxs-lookup"><span data-stu-id="ab27d-202">In Git Shell, commit and push your changes to your fork in GitHub.</span></span> <span data-ttu-id="ab27d-203">Ensuite, attendez que les clients actualisent le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-203">Then, wait for clients to refresh browser.</span></span>

       git add -A :/
       git commit -m "add AI configuration for server app"
       git push origin master
3. <span data-ttu-id="ab27d-204">Échangez les modifications de l’application déployée en production :</span><span class="sxs-lookup"><span data-stu-id="ab27d-204">Swap the deployed app changes to production:</span></span>

     <span data-ttu-id="ab27d-205">.\swap –Name ToDoApp<your_suffix></span><span class="sxs-lookup"><span data-stu-id="ab27d-205">.\swap –Name ToDoApp<your_suffix></span></span>

<span data-ttu-id="ab27d-206">Et voilà !</span><span class="sxs-lookup"><span data-stu-id="ab27d-206">That's it!</span></span>

## <a name="investigate-add-slot-specific-tags-to-your-client-app-metrics"></a><span data-ttu-id="ab27d-207">Enquête : Ajouter des balises spécifiques aux emplacements à vos mesures d’application cliente</span><span class="sxs-lookup"><span data-stu-id="ab27d-207">Investigate: Add slot-specific tags to your client app metrics</span></span>
<span data-ttu-id="ab27d-208">Dans cette section, vous allez configurer différents emplacements de déploiement pour envoyer des données de télémétrie spécifiques aux emplacements à la même ressource Application Insights.</span><span class="sxs-lookup"><span data-stu-id="ab27d-208">In this section, you will configure the different deployment slots to send slot-specific telemetry to the same Application Insights resource.</span></span> <span data-ttu-id="ab27d-209">De cette façon, vous pouvez comparer les données de télémétrie entre le trafic à partir de différents emplacements (environnements de déploiement) pour facilement voir l’effet des modifications de votre application.</span><span class="sxs-lookup"><span data-stu-id="ab27d-209">This way, you can compare telemetry data between traffic from different slots (deployment environments) to easily see the effect of your app changes.</span></span> <span data-ttu-id="ab27d-210">En même temps, vous pouvez séparer le trafic de production du reste, de manière à pouvoir continuer à surveiller votre application de production si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="ab27d-210">At the same time, you can separate the production traffic from the rest so you can continue to monitor your production app as needed.</span></span>

<span data-ttu-id="ab27d-211">Dans la mesure où vous collectez des données sur le comportement des clients, vous allez [ajouter un initialiseur de télémétrie à votre code JavaScript](../application-insights/app-insights-api-filtering-sampling.md) dans index.cshtml.</span><span class="sxs-lookup"><span data-stu-id="ab27d-211">Since you're gathering data on client behavior, you will [add a telemetry initializer to your JavaScript code](../application-insights/app-insights-api-filtering-sampling.md) in index.cshtml.</span></span> <span data-ttu-id="ab27d-212">Si vous souhaitez tester les performances côté serveur, par exemple, vous pouvez également faire de même dans votre code serveur (voir [API Application Insights pour les événements et les mesures personnalisés](../application-insights/app-insights-api-custom-events-metrics.md).</span><span class="sxs-lookup"><span data-stu-id="ab27d-212">If you want to test server-side performance, for example, you can also do similarly in your server code (see [Application Insights API for custom events and metrics](../application-insights/app-insights-api-custom-events-metrics.md).</span></span>

1. <span data-ttu-id="ab27d-213">Tout d’abord, ajoutez le code entre les deux commentaires `//` ci-dessous, dans le bloc JavaScript que vous avez ajouté à la balise `<heading>` précédemment.</span><span class="sxs-lookup"><span data-stu-id="ab27d-213">First, add the code bewteen the two `//` comments below in the JavaScript block that you added to the `<heading>` tag earlier.</span></span>

        window.appInsights = appInsights;

        // Begin new code
        appInsights.queue.push(function () {
            appInsights.context.addTelemetryInitializer(function (envelope) {
                var telemetryItem = envelope.data.baseData;
                telemetryItem.properties = telemetryItem.properties || {};
                telemetryItem.properties["Environment"] = "@System.Configuration.ConfigurationManager.AppSettings["environment"]";
            });
        });
        // End new code

        appInsights.trackPageView();

    <span data-ttu-id="ab27d-214">Ce code d’initialiseur pousse l’objet `appInsights` à ajouter une propriété personnalisée appelée `Environment` à chaque élément de télémétrie qu’il envoie.</span><span class="sxs-lookup"><span data-stu-id="ab27d-214">This initializer code causes the `appInsights` object to add the a custom property called `Environment` to every piece of telemetry it sends.</span></span>
2. <span data-ttu-id="ab27d-215">Ensuite, ajoutez cette propriété personnalisée en tant que [paramètre d’emplacement](web-sites-staged-publishing.md#AboutConfiguration) pour votre application web dans Azure.</span><span class="sxs-lookup"><span data-stu-id="ab27d-215">Next, add this custom property as a [slot setting](web-sites-staged-publishing.md#AboutConfiguration) for your web app in Azure.</span></span> <span data-ttu-id="ab27d-216">Pour ce faire, exécutez les commandes suivantes dans votre session Git Shell :</span><span class="sxs-lookup"><span data-stu-id="ab27d-216">To do this, run the following commands in your Git Shell session.</span></span>

        $app = Get-AzureWebsite -Name todoapp<your_suffix> -Slot production
        $app.AppSettings.Add("environment", "Production")
        $app.SlotStickyAppSettingNames.Add("environment")
        $app | Set-AzureWebsite -Name todoapp<your_suffix> -Slot production

    <span data-ttu-id="ab27d-217">Le fichier Web.config dans votre projet définit déjà le paramètre d’application `environment` .</span><span class="sxs-lookup"><span data-stu-id="ab27d-217">The Web.config in your project already defines the `environment` app setting.</span></span> <span data-ttu-id="ab27d-218">Avec ce paramètre, lorsque vous testez l’application localement, vos mesures sont marquées avec `VS Debugger`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-218">With this setting, when you test the app locally, your metrics will be tagged with `VS Debugger`.</span></span> <span data-ttu-id="ab27d-219">Toutefois, lorsque vous envoyez vos modifications à Azure, Azure trouve et utilise le paramètre d’application `environment` dans la configuration de l’application web à la place, et vos mesures sont marquées avec `Production`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-219">However, when you push your changes to Azure, Azure will find and use the `environment` app setting in the web app's configuration instead, and your metrics will be tagged with `Production`.</span></span>
3. <span data-ttu-id="ab27d-220">Validez et envoyez vos modifications de code à votre branchement sur GitHub, puis attendez que vos utilisateurs utilisent la nouvelle application (nécessité d’actualiser le navigateur).</span><span class="sxs-lookup"><span data-stu-id="ab27d-220">Commit and push your code changes to your fork on GitHub, and then wait for your users to use the new app (need to refresh the browser).</span></span> <span data-ttu-id="ab27d-221">Il faut environ 15 minutes pour que la nouvelle propriété s’affiche dans votre ressource Application Insights `MultiChannelToDo.Web` .</span><span class="sxs-lookup"><span data-stu-id="ab27d-221">It takes about 15 minutes for the new property to show up in your Application Insights `MultiChannelToDo.Web` resource.</span></span>

        git add -A :/
        git commit -m "add environment property to AI events for client app"
        git push origin master
4. <span data-ttu-id="ab27d-222">À présent, accédez de nouveau au panneau **Événements personnalisés** et filtrez les mesures sur `Environment=Production`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-222">Now, go to the **Custom events** blade again and filter the metrics on `Environment=Production`.</span></span> <span data-ttu-id="ab27d-223">Vous devriez maintenant être en mesure de voir tous les nouveaux événements personnalisés dans l’emplacement de production avec ce filtre.</span><span class="sxs-lookup"><span data-stu-id="ab27d-223">You should now be able to see all the new custom events in the production slot with this filter.</span></span>

    ![](./media/app-service-web-test-in-production-controlled-test-flight/05-filter-on-production-environment.png)
5. <span data-ttu-id="ab27d-224">Cliquez sur le bouton **Favoris** pour enregistrer les paramètres Metrics Explorer actuels dans un dossier similaire à **Événements personnalisés : Production**.</span><span class="sxs-lookup"><span data-stu-id="ab27d-224">Click the **Favorites** button to save the current Metrics Explorer settings to something like **Custom events: Production**.</span></span> <span data-ttu-id="ab27d-225">Vous pourrez facilement basculer entre cette vue et une vue d’emplacement de déploiement ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-225">You can easily switch between this view and a deployment slot view later.</span></span>

   > [!TIP]
   > <span data-ttu-id="ab27d-226">Pour une analyse encore plus puissante, envisagez d’ [intégrer votre ressource Application Insights avec Power BI](../application-insights/app-insights-export-power-bi.md).</span><span class="sxs-lookup"><span data-stu-id="ab27d-226">For even more powerful analytics, consider [integrating your Application Insights resource with Power BI](../application-insights/app-insights-export-power-bi.md).</span></span>
   >
   >

### <a name="add-slot-specific-tags-to-your-server-app-metrics"></a><span data-ttu-id="ab27d-227">Ajouter des balises spécifiques aux emplacements à vos mesures d’application serveur</span><span class="sxs-lookup"><span data-stu-id="ab27d-227">Add slot-specific tags to your server app metrics</span></span>
<span data-ttu-id="ab27d-228">De nouveau, par souci d’exhaustivité, vous allez configurer l’application côté serveur.</span><span class="sxs-lookup"><span data-stu-id="ab27d-228">Again, for completeness you will set up the server-side app.</span></span> <span data-ttu-id="ab27d-229">Contrairement à l’application cliente qui est instrumentée dans JavaScript, les balises spécifiques aux emplacements pour l’application serveur sont instrumentées avec le code .NET.</span><span class="sxs-lookup"><span data-stu-id="ab27d-229">Unlike the client app which is instrumented in JavaScript, slot-specific tags for the server app is instrumented with .NET code.</span></span>

1. <span data-ttu-id="ab27d-230">Ouvrez *&lt;racine_référentiel >*\src\MultiChannelToDo\Global.asax.cs.</span><span class="sxs-lookup"><span data-stu-id="ab27d-230">Open *&lt;repository_root>*\src\MultiChannelToDo\Global.asax.cs.</span></span> <span data-ttu-id="ab27d-231">Ajoutez le bloc de code ci-dessous, juste avant l’accolade fermante d’espace de noms.</span><span class="sxs-lookup"><span data-stu-id="ab27d-231">Add the code block below, just before the closing namespace curly brace.</span></span>

        namespace MultiChannelToDo
        {
                ...

                // Begin new code
            public class ConfigInitializer
            : ITelemetryInitializer
            {
                void ITelemetryInitializer.Initialize(ITelemetry telemetry)
                {
                    telemetry.Context.Properties["Environment"] = System.Configuration.ConfigurationManager.AppSettings["environment"];
                }
            }
                // End new code
        }
2. <span data-ttu-id="ab27d-232">Corrigez les erreurs de résolution de nom en ajoutant les instructions `using` ci-dessous au début du fichier :</span><span class="sxs-lookup"><span data-stu-id="ab27d-232">Correct the name resolution errors by adding the `using` statements below to the beginning of the file:</span></span>

        using Microsoft.ApplicationInsights.Channel;
        using Microsoft.ApplicationInsights.Extensibility;
3. <span data-ttu-id="ab27d-233">Ajoutez le code ci-dessous au début de la méthode `Application_Start()` :</span><span class="sxs-lookup"><span data-stu-id="ab27d-233">Add the code below to the beginning of the `Application_Start()` method:</span></span>

        TelemetryConfiguration.Active.TelemetryInitializers.Add(new ConfigInitializer());
4. <span data-ttu-id="ab27d-234">Validez et envoyez vos modifications de code à votre branchement sur GitHub, puis attendez que vos utilisateurs utilisent la nouvelle application (nécessité d’actualiser le navigateur).</span><span class="sxs-lookup"><span data-stu-id="ab27d-234">Commit and push your code changes to your fork on GitHub, and then wait for your users to use the new app (need to refresh the browser).</span></span> <span data-ttu-id="ab27d-235">Il faut environ 15 minutes pour que la nouvelle propriété s’affiche dans votre ressource Application Insights `MultiChannelToDo` .</span><span class="sxs-lookup"><span data-stu-id="ab27d-235">It takes about 15 minutes for the new property to show up in your Application Insights `MultiChannelToDo` resource.</span></span>

        git add -A :/
        git commit -m "add environment property to AI events for server app"
        git push origin master

## <a name="update-set-up-your-beta-branch"></a><span data-ttu-id="ab27d-236">Mise à jour : Configurer votre branche bêta</span><span class="sxs-lookup"><span data-stu-id="ab27d-236">Update: Set up your beta branch</span></span>
1. <span data-ttu-id="ab27d-237">Ouvrez *&lt;racine_référentiel>*\ARMTemplates\ProdAndStagetest.json et trouvez les ressources `appsettings` (recherchez `"name": "appsettings"`).</span><span class="sxs-lookup"><span data-stu-id="ab27d-237">Open *&lt;repository_root>*\ARMTemplates\ProdAndStagetest.json and find the `appsettings` resources (search for `"name": "appsettings"`).</span></span> <span data-ttu-id="ab27d-238">Elles sont au nombre de 4, une pour chaque emplacement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-238">There are 4 of them, one for each slot.</span></span>
2. <span data-ttu-id="ab27d-239">Pour chaque ressource `appsettings`, ajoutez un paramètre d’application `"environment": "[parameters('slotName')]"` à la fin du tableau `properties`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-239">For each `appsettings` resource, add an  `"environment": "[parameters('slotName')]"` app setting to the end of the `properties` array.</span></span> <span data-ttu-id="ab27d-240">N’oubliez pas de terminer la ligne précédente par une virgule.</span><span class="sxs-lookup"><span data-stu-id="ab27d-240">Don't forget to end the previous line with a comma.</span></span>

    ![](./media/app-service-web-test-in-production-controlled-test-flight/06-arm-app-setting-with-slot-name.png)

    <span data-ttu-id="ab27d-241">Vous venez d’ajouter le paramètre d’application `environment` à tous les emplacements dans le modèle.</span><span class="sxs-lookup"><span data-stu-id="ab27d-241">You have just added the `environment` app setting to all the slots in the template.</span></span>
3. <span data-ttu-id="ab27d-242">Dans le même fichier, trouvez les ressources `slotconfignames` (recherchez `"name": "slotconfignames"`).</span><span class="sxs-lookup"><span data-stu-id="ab27d-242">In the same file, find the `slotconfignames` resources (search for `"name": "slotconfignames"`).</span></span> <span data-ttu-id="ab27d-243">Elles sont au nombre de 2, une pour chaque application.</span><span class="sxs-lookup"><span data-stu-id="ab27d-243">There are 2 of them, one for each app.</span></span>
4. <span data-ttu-id="ab27d-244">Pour chaque ressource `slotconfignames`, ajoutez `"environment"` à la fin du tableau `appSettingNames`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-244">For each `slotconfignames` resource, add `"environment"` to the end of the `appSettingNames` array.</span></span> <span data-ttu-id="ab27d-245">N’oubliez pas de terminer la ligne précédente par une virgule.</span><span class="sxs-lookup"><span data-stu-id="ab27d-245">Don't forget to end the previous line with a comma.</span></span>

    <span data-ttu-id="ab27d-246">Vous venez de faire en sorte que le paramètre d’application `environment` reste dans son emplacement de déploiement respectif pour les deux applications.</span><span class="sxs-lookup"><span data-stu-id="ab27d-246">You have just made the `environment` app setting stick to its respective deployment slot for both apps.</span></span>  
5. <span data-ttu-id="ab27d-247">Dans votre session Git Shell, exécutez les commandes suivantes avec le même suffixe de groupe de ressources que celui utilisé auparavant.</span><span class="sxs-lookup"><span data-stu-id="ab27d-247">In your Git Shell session, run the following commands with the same resource group suffix that you used before.</span></span>

        git checkout -b beta
        git push origin beta
        .\deploy.ps1 -RepoUrl https://github.com/<your_fork>/ToDoApp.git -ResourceGroupSuffix <your_suffix> -SlotName beta -Branch beta
6. <span data-ttu-id="ab27d-248">Lorsque vous y êtes invité, spécifiez les mêmes informations d’identification à la base de données SQL que précédemment.</span><span class="sxs-lookup"><span data-stu-id="ab27d-248">When prompted, specify the same SQL database credentials as before.</span></span> <span data-ttu-id="ab27d-249">Ensuite, lorsque vous êtes invité à mettre à jour le groupe de ressources, tapez `Y`, puis `ENTER`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-249">Then, when asked to update the resource group, type `Y`, then `ENTER`.</span></span>

    <span data-ttu-id="ab27d-250">Une fois que le script se termine, toutes vos ressources dans le groupe de ressources d’origine sont conservées, mais un nouvel emplacement nommé « beta » est créé dans celui-ci, avec la même configuration que l’emplacement intermédiaire créé au début.</span><span class="sxs-lookup"><span data-stu-id="ab27d-250">Once the script finishes, all your resources in the original resource group are retained, but a new slot named "beta" is created in it with the same configuration as the "Staging" slot that was created in the beginning.</span></span>

   > [!NOTE]
   > <span data-ttu-id="ab27d-251">Cette méthode de création de différents environnements de déploiement est différente de la méthode présentée dans [Développement logiciel agile avec Azure App Service](app-service-agile-software-development.md).</span><span class="sxs-lookup"><span data-stu-id="ab27d-251">This method of creating different deployment environments is different from the method in [Agile software development with Azure App Service](app-service-agile-software-development.md).</span></span> <span data-ttu-id="ab27d-252">Ici, vous créez des environnements de déploiement avec des emplacements de déploiement, alors qu’avec l’autre méthode, vous créez des environnements de déploiement avec des groupes de ressources.</span><span class="sxs-lookup"><span data-stu-id="ab27d-252">Here, you create deployment environments with deployment slots, where as there you create deployment environments with resource groups.</span></span> <span data-ttu-id="ab27d-253">La gestion des environnements de déploiement avec les groupes de ressources vous permet de maintenir l’environnement de production hors d’atteinte pour les développeurs. Toutefois, il n’est pas facile de réaliser des tests en production, ce que vous pouvez facilement faire avec les emplacements.</span><span class="sxs-lookup"><span data-stu-id="ab27d-253">Managing deployment environments with resource groups enables you to keep the production environment off-limits to developers, but it's not easy to do testing in production, which you can do easily with slots.</span></span>
   >
   >

<span data-ttu-id="ab27d-254">Si vous le souhaitez, vous pouvez également créer une application alpha en exécutant la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="ab27d-254">If you wish, you can also create an alpha app by running</span></span>

    git checkout -b alpha
    git push origin alpha
    .\deploy.ps1 -RepoUrl https://github.com/<your_fork>/ToDoApp.git -ResourceGroupSuffix <your_suffix> -SlotName beta -Branch alpha

<span data-ttu-id="ab27d-255">Pour ce didacticiel, vous continuerez simplement à utiliser votre application bêta.</span><span class="sxs-lookup"><span data-stu-id="ab27d-255">For this tutorial, you will just keep using your beta app.</span></span>

## <a name="update-push-your-updates-to-the-beta-app"></a><span data-ttu-id="ab27d-256">Mise à jour : Envoyer vos mises à jour à l’application bêta</span><span class="sxs-lookup"><span data-stu-id="ab27d-256">Update: Push your updates to the beta app</span></span>
<span data-ttu-id="ab27d-257">Revenons à votre application que vous souhaitez améliorer.</span><span class="sxs-lookup"><span data-stu-id="ab27d-257">Back to your app that you want to improve.</span></span>

1. <span data-ttu-id="ab27d-258">Vérifiez que vous êtes à présent dans votre branche bêta</span><span class="sxs-lookup"><span data-stu-id="ab27d-258">Make sure you're now in your beta branch</span></span>

        git checkout beta
2. <span data-ttu-id="ab27d-259">Dans *&lt;racine_référentiel>*\src\MultiChannelToDo.Web\app\Index.cshtml, trouvez la balise `<li>` et ajoutez l’attribut `style="cursor:pointer"`, comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="ab27d-259">In *&lt;repository_root>*\src\MultiChannelToDo.Web\app\Index.cshtml, find the `<li>` tag and add the `style="cursor:pointer"` attribute, as shown below.</span></span>

    ![](./media/app-service-web-test-in-production-controlled-test-flight/07-change-cursor-style-on-li.png)
3. <span data-ttu-id="ab27d-260">Validez et envoyez vers Azure.</span><span class="sxs-lookup"><span data-stu-id="ab27d-260">commit and push to Azure.</span></span>
4. <span data-ttu-id="ab27d-261">Vérifiez que la modification est désormais reflétée dans l’emplacement bêta en accédant à *&lt;votre_suffixe>*-beta.azurewebsites.net/.</span><span class="sxs-lookup"><span data-stu-id="ab27d-261">Verify that the change is now reflected in the beta slot by navigating to http://todoapp*&lt;your_suffix>*-beta.azurewebsites.net/.</span></span> <span data-ttu-id="ab27d-262">Si vous ne voyez pas encore la modification, actualisez votre navigateur pour obtenir le nouveau code JavaScript.</span><span class="sxs-lookup"><span data-stu-id="ab27d-262">If you don't see the change yet, refresh your browser to get the new javascript code.</span></span>

    ![](./media/app-service-web-test-in-production-controlled-test-flight/08-verify-change-in-beta-site.png)

<span data-ttu-id="ab27d-263">Maintenant que votre modification est exécutée dans l’emplacement bêta, vous êtes prêt à effectuer un déploiement avec distribution d’une version d’évaluation.</span><span class="sxs-lookup"><span data-stu-id="ab27d-263">Now that you have your change running in the beta slot, you are ready to perform a flighting deployment.</span></span>

## <a name="validate-route-traffic-to-the-beta-app"></a><span data-ttu-id="ab27d-264">Validation : Acheminer le trafic vers l’application bêta</span><span class="sxs-lookup"><span data-stu-id="ab27d-264">Validate: Route traffic to the beta app</span></span>
<span data-ttu-id="ab27d-265">Dans cette section, vous allez acheminer le trafic vers l’application bêta.</span><span class="sxs-lookup"><span data-stu-id="ab27d-265">In this section, you will route traffic to the beta app.</span></span> <span data-ttu-id="ab27d-266">Par souci de clarté de démonstration, vous allez acheminer une partie significative du trafic utilisateur vers celle-ci.</span><span class="sxs-lookup"><span data-stu-id="ab27d-266">For sake of clarity of demonstration, you're going to route a significant portion of the user traffic to it.</span></span> <span data-ttu-id="ab27d-267">En réalité, la quantité de trafic que vous souhaitez acheminer dépendra de votre situation particulière.</span><span class="sxs-lookup"><span data-stu-id="ab27d-267">In reality, the amount of traffic you want to route will depend on your specific situation.</span></span> <span data-ttu-id="ab27d-268">Par exemple, si votre site est à l’échelle de microsoft.com, vous aurez peut-être besoin de moins d’un pour cent de votre trafic total pour obtenir des données utiles.</span><span class="sxs-lookup"><span data-stu-id="ab27d-268">For example, if your site is at the scale of microsoft.com, then you may need less than one percent of your total traffic in order to gain useful data.</span></span>

1. <span data-ttu-id="ab27d-269">Dans votre session Git Shell, exécutez les commandes suivantes pour acheminer la moitié du trafic de production vers l’emplacement bêta :</span><span class="sxs-lookup"><span data-stu-id="ab27d-269">In your Git Shell session, run the following commands to route half of the production traffic to the beta slot:</span></span>

        $siteName = "ToDoApp<your suffix>"
        $rule = New-Object Microsoft.WindowsAzure.Commands.Utilities.Websites.Services.WebEntities.RampUpRule
        $rule.ActionHostName = "$siteName-beta.azurewebsites.net"
        $rule.ReroutePercentage = 50
        $rule.Name = "beta"
        Set-AzureWebsite $siteName -Slot Production -RoutingRules $rule

   <span data-ttu-id="ab27d-270">La propriété `ReroutePercentage=50` spécifie que 50 % du trafic de production sera routé vers l’URL de l’application bêta (spécifiée par la propriété `ActionHostName`).</span><span class="sxs-lookup"><span data-stu-id="ab27d-270">The `ReroutePercentage=50` property specifies that 50% of the production traffic will be routed to the beta app's URL (specified by the `ActionHostName` property).</span></span>
2. <span data-ttu-id="ab27d-271">Maintenant, accédez à http://ToDoApp*&lt;votre_suffixe>*.azurewebsites.net.</span><span class="sxs-lookup"><span data-stu-id="ab27d-271">Now navigate to http://ToDoApp*&lt;your_suffix>*.azurewebsites.net.</span></span> <span data-ttu-id="ab27d-272">50 % du trafic doit maintenant être redirigé vers l’emplacement bêta.</span><span class="sxs-lookup"><span data-stu-id="ab27d-272">50% of the traffic should now be redirected to the beta slot.</span></span>
3. <span data-ttu-id="ab27d-273">Dans votre ressource Application Insights, filtrez les mesures sur environnement="beta".</span><span class="sxs-lookup"><span data-stu-id="ab27d-273">In your Application Insights resource, filter the metrics by environment="beta".</span></span>

   > [!NOTE]
   > <span data-ttu-id="ab27d-274">Si vous enregistrez cette vue filtrée comme un autre favori, vous pouvez facilement retourner les vues Metrics Explorer entre les vues de production et bêta.</span><span class="sxs-lookup"><span data-stu-id="ab27d-274">If you save this filtered view as another favorite, then you can easily flip the metric explorer views between production and beta views.</span></span>
   >
   >

<span data-ttu-id="ab27d-275">Supposons que dans Application Insights vous voyiez quelque chose de similaire à ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="ab27d-275">Suppose in Application Insights you see something similar to the following:</span></span>

![](./media/app-service-web-test-in-production-controlled-test-flight/09-test-beta-site-in-production.png)

<span data-ttu-id="ab27d-276">Non seulement cela indique qu’il y a beaucoup plus de clics sur les balises `<li>`, mais il semble qu’il y a un nombre important de clics sur les balises `<li>`.</span><span class="sxs-lookup"><span data-stu-id="ab27d-276">Not only is this showing that there are many more clicks on the `<li>` tags, but there seems to be a surge of clicks on `<li>` tags.</span></span> <span data-ttu-id="ab27d-277">Vous pouvez en conclure que les utilisateurs ont découvert que les nouvelles balises `<li>` sont interactives et qu’ils effacent maintenant toutes leurs tâches terminées précédemment dans l’application.</span><span class="sxs-lookup"><span data-stu-id="ab27d-277">You can then conclude that people have discovered the new `<li>` tags are clickable and are now clearing all their previously-completed tasks in the app.</span></span>

<span data-ttu-id="ab27d-278">En vous appuyant sur les données de votre déploiement avec distribution d’une version d’évaluation, vous décidez que votre nouvelle interface utilisateur est prête pour la production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-278">Based on the data of your flighting deployment, you decide that your new UI is ready for production.</span></span>

## <a name="go-live-move-your-new-code-into-production"></a><span data-ttu-id="ab27d-279">Mise en ligne : Mettre votre nouveau code en production</span><span class="sxs-lookup"><span data-stu-id="ab27d-279">Go live: Move your new code into production</span></span>
<span data-ttu-id="ab27d-280">Vous êtes maintenant prêt à mettre votre mise à jour en production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-280">You're now ready to move your update to production.</span></span> <span data-ttu-id="ab27d-281">Ce qui est super, c’est que vous savez que votre mise à jour a déjà été validée *avant* d’être envoyée en production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-281">What's great is that now you know that your update has already been validated *before* it is pushed to production.</span></span> <span data-ttu-id="ab27d-282">Vous pouvez donc la déployer en toute confiance.</span><span class="sxs-lookup"><span data-stu-id="ab27d-282">So now you can confidently deploy it.</span></span> <span data-ttu-id="ab27d-283">Étant donné que vous avez effectué une mise à jour de l’application cliente AngularJS, vous avez uniquement validé le code côté client.</span><span class="sxs-lookup"><span data-stu-id="ab27d-283">Since you made an update to the AngularJS client app, you only validated the client-side code.</span></span> <span data-ttu-id="ab27d-284">Si vous deviez apporter des modifications à l’application API web principale, vous pourriez valider vos modifications de la même façon et facilement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-284">If you were to make changes to the back-end Web API app, you could validate your changes similarly and easily.</span></span>

1. <span data-ttu-id="ab27d-285">Dans Git Shell, supprimez la règle de routage du trafic en exécutant la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="ab27d-285">In Git Shell, remove the traffic routing rule by running the following command:</span></span>

        Set-AzureWebsite $siteName -Slot Production -RoutingRules @()
2. <span data-ttu-id="ab27d-286">Exécutez les commandes Git :</span><span class="sxs-lookup"><span data-stu-id="ab27d-286">Run the Git commands:</span></span>

        git checkout master
        git pull origin master
        git merge beta
        git push origin master
3. <span data-ttu-id="ab27d-287">Attendez quelques minutes que le nouveau code soit déployé dans l’emplacement intermédiaire, puis lancez http://ToDoApp*&lt;votre_suffixe>*-staging.azurewebsites.net  pour vérifier que la nouvelle mise à jour est initialisée dans l’emplacement intermédiaire.</span><span class="sxs-lookup"><span data-stu-id="ab27d-287">Wait for a few minutes for the new code to be deployed to the staging slot, then launch http://ToDoApp*&lt;your_suffix>*-staging.azurewebsites.net to verify that the new update is warmed up in the staging slot.</span></span> <span data-ttu-id="ab27d-288">N’oubliez pas que la branche principale de votre branchement est liée à l’emplacement intermédiaire de votre application.</span><span class="sxs-lookup"><span data-stu-id="ab27d-288">Remember that the your fork's master branch is linked to the staging slot of your app.</span></span>
4. <span data-ttu-id="ab27d-289">À présent, échangez l’emplacement intermédiaire en production.</span><span class="sxs-lookup"><span data-stu-id="ab27d-289">Now, swap the staging slot into production</span></span>

        cd <ROOT>\ToDoApp\ARMTemplates
        .\swap.ps1 -Name todoapp<your_suffix>

## <a name="summary"></a><span data-ttu-id="ab27d-290">Résumé</span><span class="sxs-lookup"><span data-stu-id="ab27d-290">Summary</span></span>
<span data-ttu-id="ab27d-291">Azure App Service facilite le test en production des applications destinées aux clients pour les PME, possibilité qui historiquement était réservée aux grandes entreprises.</span><span class="sxs-lookup"><span data-stu-id="ab27d-291">Azure App Service makes it easy for small- to medium-sized businesses to test their customer-facing apps in production, something that has been traditionally done in big enterprises.</span></span> <span data-ttu-id="ab27d-292">Nous espérons que ce didacticiel vous a apporté les connaissances nécessaires pour rassembler App Service et Application Insights, afin de rendre possible le déploiement avec distribution d’une version d’évaluation, voire d’autres scénarios de test en production, dans votre monde d’opérations de développement.</span><span class="sxs-lookup"><span data-stu-id="ab27d-292">Hopefully, this tutorial has given you the knowledge you need to bring together App Service and Application Insights to make possible flighting deployment, and even other test-in-production scenarios, in your DevOps world.</span></span>

## <a name="more-resources"></a><span data-ttu-id="ab27d-293">Autres ressources</span><span class="sxs-lookup"><span data-stu-id="ab27d-293">More resources</span></span>
* [<span data-ttu-id="ab27d-294">Développement logiciel agile avec Azure App Service</span><span class="sxs-lookup"><span data-stu-id="ab27d-294">Agile software development with Azure App Service</span></span>](app-service-agile-software-development.md)
* [<span data-ttu-id="ab27d-295">Configurer des environnements intermédiaires pour les applications web dans Azure App Service</span><span class="sxs-lookup"><span data-stu-id="ab27d-295">Set up staging environments for web apps in Azure App Service</span></span>](web-sites-staged-publishing.md)
* [<span data-ttu-id="ab27d-296">Déployer une application complexe de manière prévisible dans Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="ab27d-296">Deploy a complex application predictably in Azure</span></span>](app-service-deploy-complex-application-predictably.md)
* [<span data-ttu-id="ab27d-297">Création de modèles Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="ab27d-297">Authoring Azure Resource Manager Templates</span></span>](../azure-resource-manager/resource-group-authoring-templates.md)
* [<span data-ttu-id="ab27d-298">JSONLint - Validateur JSON</span><span class="sxs-lookup"><span data-stu-id="ab27d-298">JSONLint - The JSON Validator</span></span>](http://jsonlint.com/)
* [<span data-ttu-id="ab27d-299">Création de branches Git – Branchement et fusion basiques</span><span class="sxs-lookup"><span data-stu-id="ab27d-299">Git Branching – Basic Branching and Merging</span></span>](http://www.git-scm.com/book/en/v2/Git-Branching-Basic-Branching-and-Merging)
* [<span data-ttu-id="ab27d-300">Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="ab27d-300">Azure PowerShell</span></span>](/powershell/azure/overview)
* [<span data-ttu-id="ab27d-301">Projet Wiki Kudu</span><span class="sxs-lookup"><span data-stu-id="ab27d-301">Project Kudu Wiki</span></span>](https://github.com/projectkudu/kudu/wiki)
