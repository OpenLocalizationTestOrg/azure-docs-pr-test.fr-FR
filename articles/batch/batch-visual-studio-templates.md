---
title: "Création de solutions Batch avec les modèles de projet Visual Studio - Azure | Microsoft Docs"
description: "Découvrez comment des modèles de projet Visual Studio peuvent vous aider à implémenter et à exécuter vos charges de travail nécessitant beaucoup de ressources sur Azure Batch."
services: batch
documentationcenter: .net
author: fayora
manager: timlt
editor: 
ms.assetid: 5e041ae2-25af-4882-a79e-3aa63c4bfb20
ms.service: batch
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: big-compute
ms.date: 02/27/2017
ms.author: tamram
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: da77ce827c65deb18d9d84ce5cf768d89788e205
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="use-visual-studio-project-templates-to-jump-start-batch-solutions"></a><span data-ttu-id="b1412-103">Utiliser des modèles de projet Visual Studio pour lancer rapidement des solutions Batch</span><span class="sxs-lookup"><span data-stu-id="b1412-103">Use Visual Studio project templates to jump-start Batch solutions</span></span>

<span data-ttu-id="b1412-104">Les **modèles Visual Studio du gestionnaire de travaux** et du **processeur de tâches** pour Batch fournissent le code vous permettant d’implémenter et d’exécuter sans effort vos charges de travail nécessitant beaucoup de ressources sur Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-104">The **Job Manager** and **Task Processor Visual Studio templates** for Batch provide code to help you to implement and run your compute-intensive workloads on Batch with the least amount of effort.</span></span> <span data-ttu-id="b1412-105">Ce document décrit ces modèles et fournit des conseils pour leur utilisation.</span><span class="sxs-lookup"><span data-stu-id="b1412-105">This document describes these templates and provides guidance for how to use them.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="b1412-106">Cet article traite uniquement les informations relatives à ces deux modèles et suppose que vous maîtrisez le service Batch ainsi que les concepts clés qui y sont liés : pools, nœuds de calcul, travaux et tâches, tâches du gestionnaire de travaux, variables d’environnement et autres informations pertinentes.</span><span class="sxs-lookup"><span data-stu-id="b1412-106">This article discusses only information applicable to these two templates, and assumes that you are familiar with the Batch service and key concepts related to it: pools, compute nodes, jobs and tasks, job manager tasks, environment variables, and other relevant information.</span></span> <span data-ttu-id="b1412-107">Pour plus d’informations, consultez [Notions de base d’Azure Batch](batch-technical-overview.md), [Présentation des fonctionnalités du service Batch pour les développeurs](batch-api-basics.md) et [Prise en main de la bibliothèque Azure Batch pour .NET](batch-dotnet-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="b1412-107">You can find more information in [Basics of Azure Batch](batch-technical-overview.md), [Batch feature overview for developers](batch-api-basics.md), and [Get started with the Azure Batch library for .NET](batch-dotnet-get-started.md).</span></span>
> 
> 

## <a name="high-level-overview"></a><span data-ttu-id="b1412-108">Vue d’ensemble globale</span><span class="sxs-lookup"><span data-stu-id="b1412-108">High-level overview</span></span>
<span data-ttu-id="b1412-109">Les modèles du gestionnaire de travaux et du processeur de tâches peuvent être utilisés pour créer deux composants utiles :</span><span class="sxs-lookup"><span data-stu-id="b1412-109">The Job Manager and Task Processor templates can be used to create two useful components:</span></span>

* <span data-ttu-id="b1412-110">Une tâche du gestionnaire de travaux qui permet de fractionner un travail afin de le découper en plusieurs tâches pouvant être exécutées indépendamment, en parallèle.</span><span class="sxs-lookup"><span data-stu-id="b1412-110">A job manager task that implements a job splitter that can break a job down into multiple tasks that can run independently, in parallel.</span></span>
* <span data-ttu-id="b1412-111">Un processeur de tâches qui peut être utilisé pour effectuer le prétraitement et le post-traitement d’une ligne de commande d’application.</span><span class="sxs-lookup"><span data-stu-id="b1412-111">A task processor that can be used to perform pre-processing and post-processing around an application command line.</span></span>

<span data-ttu-id="b1412-112">Par exemple, dans un scénario de rendu vidéo, l’outil de fractionnement du travail diviserait le travail vidéo en plusieurs centaines voire milliers de tâches distinctes qui traiteraient chaque image séparément.</span><span class="sxs-lookup"><span data-stu-id="b1412-112">For example, in a movie rendering scenario, the job splitter would turn a single movie job into hundreds or thousands of separate tasks that would process individual frames separately.</span></span> <span data-ttu-id="b1412-113">En conséquence, le processeur de tâches appellerait l’application de rendu ainsi que tous les processus dépendants nécessaires au rendu de chaque image, et effectuerait des actions supplémentaires (par exemple, la copie de l’image rendue sur un emplacement de stockage).</span><span class="sxs-lookup"><span data-stu-id="b1412-113">Correspondingly, the task processor would invoke the rendering application and all dependent processes that are needed to render each frame, as well as perform any additional actions (for example, copying the rendered frame to a storage location).</span></span>

> [!NOTE]
> <span data-ttu-id="b1412-114">Les modèles du gestionnaire de travaux et du processeur de tâches étant indépendants l’un de l’autre, vous pouvez choisir d’utiliser les deux ou un seul, en fonction des besoins de votre travail de calcul et de vos préférences.</span><span class="sxs-lookup"><span data-stu-id="b1412-114">The Job Manager and Task Processor templates are independent of each other, so you can choose to use both, or only one of them, depending on the requirements of your compute job and on your preferences.</span></span>
> 
> 

<span data-ttu-id="b1412-115">Comme indiqué dans le diagramme ci-dessous, un travail de calcul qui utilise ces modèles passe par trois étapes :</span><span class="sxs-lookup"><span data-stu-id="b1412-115">As shown in the diagram below, a compute job that uses these templates will go through three stages:</span></span>

1. <span data-ttu-id="b1412-116">Le code client (par exemple, application, service web, etc.) soumet un travail au service Batch sur Azure, spécifiant le programme du gestionnaire de travaux en tant que tâche de son gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-116">The client code (e.g., application, web service, etc.) submits a job to the Batch service on Azure, specifying as its job manager task the job manager program.</span></span>
2. <span data-ttu-id="b1412-117">Le service Batch exécute la tâche du gestionnaire de travaux sur un nœud de calcul, et l’outil de fractionnement du travail lance le nombre spécifié de tâches du processeur de tâches sur autant de nœuds de calcul que nécessaire, en fonction des paramètres et des spécifications indiqués dans son code.</span><span class="sxs-lookup"><span data-stu-id="b1412-117">The Batch service runs the job manager task on a compute node and the job splitter launches the specified number of task processor tasks, on as many compute nodes as required, based on the parameters and specifications in the job splitter code.</span></span>
3. <span data-ttu-id="b1412-118">Les tâches du processeur de tâches sont exécutées de manière indépendante, en parallèle, pour traiter les données d’entrée et générer les données de sortie.</span><span class="sxs-lookup"><span data-stu-id="b1412-118">The task processor tasks run independently, in parallel, to process the input data and generate the output data.</span></span>

![Diagramme montrant comment le code client interagit avec le service Batch][diagram01]

## <a name="prerequisites"></a><span data-ttu-id="b1412-120">Composants requis</span><span class="sxs-lookup"><span data-stu-id="b1412-120">Prerequisites</span></span>
<span data-ttu-id="b1412-121">Voici les composants requis pour utiliser les modèles Batch :</span><span class="sxs-lookup"><span data-stu-id="b1412-121">To use the Batch templates, you will need the following:</span></span>

* <span data-ttu-id="b1412-122">Un ordinateur où Visual Studio 2015 est installé.</span><span class="sxs-lookup"><span data-stu-id="b1412-122">A computer with Visual Studio 2015 installed.</span></span> <span data-ttu-id="b1412-123">Les modèles Batch sont actuellement pris en charge seulement pour Visual Studio 2015.</span><span class="sxs-lookup"><span data-stu-id="b1412-123">Batch templates are currently only supported for Visual Studio 2015.</span></span>
* <span data-ttu-id="b1412-124">Les modèles Batch, qui sont disponibles dans la [galerie Visual Studio][vs_gallery] en tant qu’extensions Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b1412-124">The Batch templates, which are available from the [Visual Studio Gallery][vs_gallery] as Visual Studio extensions.</span></span> <span data-ttu-id="b1412-125">Il existe deux façons de se procurer les modèles :</span><span class="sxs-lookup"><span data-stu-id="b1412-125">There are two ways to get the templates:</span></span>
  
  * <span data-ttu-id="b1412-126">Les installer à l’aide de la boîte de dialogue **Extensions et mises à jour** dans Visual Studio (pour plus d’informations, consultez [Recherche et utilisation des extensions Visual Studio][vs_find_use_ext]).</span><span class="sxs-lookup"><span data-stu-id="b1412-126">Install the templates using the **Extensions and Updates** dialog box in Visual Studio (for more information, see [Finding and Using Visual Studio Extensions][vs_find_use_ext]).</span></span> <span data-ttu-id="b1412-127">Dans la boîte de dialogue **Extensions et mises à jour** , recherchez et téléchargez les deux extensions suivantes :</span><span class="sxs-lookup"><span data-stu-id="b1412-127">In the **Extensions and Updates** dialog box, search and download the following two extensions:</span></span>
    
    * <span data-ttu-id="b1412-128">Le gestionnaire de travaux Azure Batch avec l’outil de fractionnement du travail</span><span class="sxs-lookup"><span data-stu-id="b1412-128">Azure Batch Job Manager with Job Splitter</span></span>
    * <span data-ttu-id="b1412-129">Le processeur de tâches Azure Batch</span><span class="sxs-lookup"><span data-stu-id="b1412-129">Azure Batch Task Processor</span></span>
  * <span data-ttu-id="b1412-130">Les télécharger à partir de la galerie en ligne pour Visual Studio : [Modèles de projet Microsoft Azure Batch][vs_gallery_templates]</span><span class="sxs-lookup"><span data-stu-id="b1412-130">Download the templates from the online gallery for Visual Studio: [Microsoft Azure Batch Project Templates][vs_gallery_templates]</span></span>
* <span data-ttu-id="b1412-131">Si vous prévoyez d’utiliser la fonctionnalité [Packages d’applications](batch-application-packages.md) pour déployer le gestionnaire de travaux et le processeur de tâches sur les nœuds de calcul Batch, vous devez lier un compte de stockage à votre compte Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-131">If you plan to use the [Application Packages](batch-application-packages.md) feature to deploy the job manager and task processor to the Batch compute nodes, you need to link a storage account to your Batch account.</span></span>

## <a name="preparation"></a><span data-ttu-id="b1412-132">Préparation</span><span class="sxs-lookup"><span data-stu-id="b1412-132">Preparation</span></span>
<span data-ttu-id="b1412-133">Nous vous recommandons de créer une solution pouvant contenir à la fois votre gestionnaire de travaux et votre processeur de tâches, afin de faciliter le partage du code entre leurs programmes.</span><span class="sxs-lookup"><span data-stu-id="b1412-133">We recommend creating a solution that can contain your job manager as well as your task processor, because this can make it easier to share code between your job manager and task processor programs.</span></span> <span data-ttu-id="b1412-134">Pour créer cette solution, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="b1412-134">To create this solution, follow these steps:</span></span>

1. <span data-ttu-id="b1412-135">Ouvrez Visual Studio et sélectionnez **Fichier** > **Nouveau** > **Projet**.</span><span class="sxs-lookup"><span data-stu-id="b1412-135">Open Visual Studio and select **File** > **New** > **Project**.</span></span>
2. <span data-ttu-id="b1412-136">Sous **Modèles**, développez **Autres Types de projets**, cliquez sur **Solutions Visual Studio**, puis sélectionnez **Nouvelle Solution**.</span><span class="sxs-lookup"><span data-stu-id="b1412-136">Under **Templates**, expand **Other Project Types**, click **Visual Studio Solutions**, and then select **Blank Solution**.</span></span>
3. <span data-ttu-id="b1412-137">Entrez un nom décrivant votre application et l’objectif de cette solution (par exemple, « ProgrammesTâchesBatchLitware »).</span><span class="sxs-lookup"><span data-stu-id="b1412-137">Type a name that describes your application and the purpose of this solution (e.g., "LitwareBatchTaskPrograms").</span></span>
4. <span data-ttu-id="b1412-138">Cliquez sur **OK**pour créer la solution.</span><span class="sxs-lookup"><span data-stu-id="b1412-138">To create the new solution, click **OK**.</span></span>

## <a name="job-manager-template"></a><span data-ttu-id="b1412-139">Modèle du gestionnaire de travaux</span><span class="sxs-lookup"><span data-stu-id="b1412-139">Job Manager template</span></span>
<span data-ttu-id="b1412-140">Le modèle du gestionnaire de travaux vous permet d’implémenter une tâche du gestionnaire de travaux pouvant effectuer les actions suivantes :</span><span class="sxs-lookup"><span data-stu-id="b1412-140">The Job Manager template helps you to implement a job manager task that can perform the following actions:</span></span>

* <span data-ttu-id="b1412-141">Fractionner un travail en plusieurs tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-141">Split a job into multiple tasks.</span></span>
* <span data-ttu-id="b1412-142">Soumettre ces tâches pour les exécuter dans Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-142">Submit those tasks to run on Batch.</span></span>

> [!NOTE]
> <span data-ttu-id="b1412-143">Pour plus d’informations sur le gestionnaire de travaux, consultez [Présentation des fonctionnalités du service Batch pour les développeurs](batch-api-basics.md#job-manager-task).</span><span class="sxs-lookup"><span data-stu-id="b1412-143">For more information about job manager tasks, see [Batch feature overview for developers](batch-api-basics.md#job-manager-task).</span></span>
> 
> 

### <a name="create-a-job-manager-using-the-template"></a><span data-ttu-id="b1412-144">Créer un gestionnaire de travaux à l’aide du modèle</span><span class="sxs-lookup"><span data-stu-id="b1412-144">Create a Job Manager using the template</span></span>
<span data-ttu-id="b1412-145">Pour ajouter un gestionnaire de travaux à la solution que vous avez créée précédemment, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="b1412-145">To add a job manager to the solution that you created earlier, follow these steps:</span></span>

1. <span data-ttu-id="b1412-146">Ouvrez votre solution existante dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b1412-146">Open your existing solution in Visual Studio.</span></span>
2. <span data-ttu-id="b1412-147">Dans l’Explorateur de solutions, cliquez avec le bouton droit sur la solution et cliquez sur **Ajouter** > **Nouveau projet**.</span><span class="sxs-lookup"><span data-stu-id="b1412-147">In Solution Explorer, right-click the solution, click **Add** > **New Project**.</span></span>
3. <span data-ttu-id="b1412-148">Sous **Visual C#**, cliquez sur **Cloud**, puis sur **Azure Batch Job Manager with Job Splitter** (Gestionnaire de travaux Azure Batch avec outil de fractionnement du travail).</span><span class="sxs-lookup"><span data-stu-id="b1412-148">Under **Visual C#**, click **Cloud**, and then click **Azure Batch Job Manager with Job Splitter**.</span></span>
4. <span data-ttu-id="b1412-149">Entrez un nom décrivant votre application et identifiant ce projet en tant que le gestionnaire de travaux (par exemple, « GestionnaireTravauxLitware »).</span><span class="sxs-lookup"><span data-stu-id="b1412-149">Type a name that describes your application and identifies this project as the job manager (e.g. "LitwareJobManager").</span></span>
5. <span data-ttu-id="b1412-150">Cliquez sur **OK**pour créer le projet.</span><span class="sxs-lookup"><span data-stu-id="b1412-150">To create the project, click **OK**.</span></span>
6. <span data-ttu-id="b1412-151">Pour finir, générez le projet pour forcer Visual Studio à charger tous les packages NuGet référencés et vérifier que le projet est valide avant de commencer à le modifier.</span><span class="sxs-lookup"><span data-stu-id="b1412-151">Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.</span></span>

### <a name="job-manager-template-files-and-their-purpose"></a><span data-ttu-id="b1412-152">Les fichiers du modèle du gestionnaire de travaux et leur objectif</span><span class="sxs-lookup"><span data-stu-id="b1412-152">Job Manager template files and their purpose</span></span>
<span data-ttu-id="b1412-153">Lorsque vous créez un projet à l’aide du modèle du gestionnaire de travaux, il génère trois groupes de fichiers de code :</span><span class="sxs-lookup"><span data-stu-id="b1412-153">When you create a project using the Job Manager template, it generates three groups of code files:</span></span>

* <span data-ttu-id="b1412-154">Le fichier de programme principal (Program.cs).</span><span class="sxs-lookup"><span data-stu-id="b1412-154">The main program file (Program.cs).</span></span> <span data-ttu-id="b1412-155">Il contient le point d’entrée du programme et la gestion des exceptions de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b1412-155">This contains the program entry point and top-level exception handling.</span></span> <span data-ttu-id="b1412-156">Vous n’avez normalement pas besoin de modifier cette configuration.</span><span class="sxs-lookup"><span data-stu-id="b1412-156">You shouldn't normally need to modify this.</span></span>
* <span data-ttu-id="b1412-157">Le répertoire Framework.</span><span class="sxs-lookup"><span data-stu-id="b1412-157">The Framework directory.</span></span> <span data-ttu-id="b1412-158">Il contient les fichiers responsables du travail « boilerplate » (réutilisable) effectué par le programme du gestionnaire de travaux – décompression de paramètres, ajout de tâches au travail Batch, etc. Vous n’avez normalement pas besoin de modifier ces fichiers.</span><span class="sxs-lookup"><span data-stu-id="b1412-158">This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.</span></span>
* <span data-ttu-id="b1412-159">Le fichier de fractionnement du travail (JobSplitter.cs).</span><span class="sxs-lookup"><span data-stu-id="b1412-159">The job splitter file (JobSplitter.cs).</span></span> <span data-ttu-id="b1412-160">C’est là que vous allez placer la logique spécifique à votre application pour le fractionnement d’un travail en tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-160">This is where you will put your application-specific logic for splitting a job into tasks.</span></span>

<span data-ttu-id="b1412-161">Bien sûr, vous pouvez si besoin ajouter des fichiers supplémentaires pour prendre en charge le code de fractionnement de votre travail, en fonction de la complexité de la logique de fractionnement du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-161">Of course you can add additional files as required to support your job splitter code, depending on the complexity of the job splitting logic.</span></span>

<span data-ttu-id="b1412-162">Le modèle génère également des fichiers de projet .NET standard comme des fichiers .csproj, app.config, packages.config, etc.</span><span class="sxs-lookup"><span data-stu-id="b1412-162">The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.</span></span>

<span data-ttu-id="b1412-163">Le reste de cette section décrit les différents fichiers et leur structure de code, et explique ce que fait chaque classe.</span><span class="sxs-lookup"><span data-stu-id="b1412-163">The rest of this section describes the different files and their code structure, and explains what each class does.</span></span>

![Explorateur de solutions Visual Studio affichant la solution du modèle du gestionnaire de travaux][solution_explorer01]

<span data-ttu-id="b1412-165">**Fichiers Framework**</span><span class="sxs-lookup"><span data-stu-id="b1412-165">**Framework files**</span></span>

* <span data-ttu-id="b1412-166">`Configuration.cs`: Encapsule le chargement des données de configuration du travail, telles que les détails du compte Batch, les informations d’identification du compte de stockage lié, les informations relatives aux travaux et aux tâches, et les paramètres du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-166">`Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.</span></span> <span data-ttu-id="b1412-167">Il donne également accès aux variables d’environnement définies par Batch (voir les paramètres d’environnement des tâches, dans la documentation Batch) via la classe Configuration.EnvironmentVariable.</span><span class="sxs-lookup"><span data-stu-id="b1412-167">It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.</span></span>
* <span data-ttu-id="b1412-168">`IConfiguration.cs`: Résume l’implémentation de la classe de configuration, afin que vous puissiez soumettre votre outil de fractionnement du travail à un test unitaire, à l’aide d’un objet de configuration fictif ou simulé.</span><span class="sxs-lookup"><span data-stu-id="b1412-168">`IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.</span></span>
* <span data-ttu-id="b1412-169">`JobManager.cs`: Orchestre les composants du programme de gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-169">`JobManager.cs`: Orchestrates the components of the job manager program.</span></span> <span data-ttu-id="b1412-170">Il est responsable de l’initialisation et de l’appel de l’outil de fractionnement du travail, et de la distribution des tâches retournées par l’outil de fractionnement du travail à l’émetteur de la tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-170">It is responsible for the initializing the job splitter, invoking the job splitter, and dispatching the tasks returned by the job splitter to the task submitter.</span></span>
* <span data-ttu-id="b1412-171">`JobManagerException.cs`: Représente une erreur nécessitant l’arrêt du gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-171">`JobManagerException.cs`: Represents an error that requires the job manager to terminate.</span></span> <span data-ttu-id="b1412-172">L’exception JobManagerException est utilisée pour encapsuler des erreurs « attendues » lorsque des informations de diagnostic spécifiques peuvent être fournies dans le cadre de l’arrêt.</span><span class="sxs-lookup"><span data-stu-id="b1412-172">JobManagerException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.</span></span>
* <span data-ttu-id="b1412-173">`TaskSubmitter.cs`: Cette classe est chargée d’ajouter au travail Batch les tâches retournées par l’outil de fractionnement du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-173">`TaskSubmitter.cs`: This class is responsible to adding tasks returned by the job splitter to the Batch job.</span></span> <span data-ttu-id="b1412-174">La classe JobManager agrège la séquence de tâches en lots pour les ajouter au travail de manière efficace et opportune, puis appelle TaskSubmitter.SubmitTasks sur un thread d’arrière-plan pour chaque lot.</span><span class="sxs-lookup"><span data-stu-id="b1412-174">The JobManager class aggregates the sequence of tasks into batches for efficient but timely addition to the job, then calls TaskSubmitter.SubmitTasks on a background thread for each batch.</span></span>

<span data-ttu-id="b1412-175">**Outil de fractionnement du travail**</span><span class="sxs-lookup"><span data-stu-id="b1412-175">**Job Splitter**</span></span>

<span data-ttu-id="b1412-176">`JobSplitter.cs`: Cette classe contient la logique spécifique à l’application pour fractionner le travail en tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-176">`JobSplitter.cs`: This class contains application-specific logic for splitting the job into tasks.</span></span> <span data-ttu-id="b1412-177">L’infrastructure appelle la méthode JobSplitter.Split pour obtenir une séquence de tâches, qu’elle ajoute au travail à mesure que la méthode les retourne.</span><span class="sxs-lookup"><span data-stu-id="b1412-177">The framework invokes the JobSplitter.Split method to obtain a sequence of tasks, which it adds to the job as the method returns them.</span></span> <span data-ttu-id="b1412-178">C’est la classe où vous injecterez la logique de votre travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-178">This is the class where you will inject the logic of your job.</span></span> <span data-ttu-id="b1412-179">Implémentez la méthode Split pour retourner une séquence d’instances CloudTask représentant les tâches dans lesquelles vous souhaitez partitionner le travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-179">Implement the Split method to return a sequence of CloudTask instances representing the tasks into which you want to partition the job.</span></span>

<span data-ttu-id="b1412-180">**Fichiers de projet de ligne de commande .NET standard**</span><span class="sxs-lookup"><span data-stu-id="b1412-180">**Standard .NET command line project files**</span></span>

* <span data-ttu-id="b1412-181">`App.config`: Fichier de configuration d’application .NET standard.</span><span class="sxs-lookup"><span data-stu-id="b1412-181">`App.config`: Standard .NET application configuration file.</span></span>
* <span data-ttu-id="b1412-182">`Packages.config`: Fichier de dépendance de package NuGet standard.</span><span class="sxs-lookup"><span data-stu-id="b1412-182">`Packages.config`: Standard NuGet package dependency file.</span></span>
* <span data-ttu-id="b1412-183">`Program.cs`: Contient le point d’entrée du programme et la gestion des exceptions de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b1412-183">`Program.cs`: Contains the program entry point and top-level exception handling.</span></span>

### <a name="implementing-the-job-splitter"></a><span data-ttu-id="b1412-184">Implémenter l’outil de fractionnement du travail</span><span class="sxs-lookup"><span data-stu-id="b1412-184">Implementing the job splitter</span></span>
<span data-ttu-id="b1412-185">Lorsque vous ouvrez le projet de modèle du gestionnaire de travaux, il ouvre le fichier JobSplitter.cs par défaut.</span><span class="sxs-lookup"><span data-stu-id="b1412-185">When you open the Job Manager template project, the project will have the JobSplitter.cs file open by default.</span></span> <span data-ttu-id="b1412-186">Vous pouvez implémenter la logique de fractionnement pour les tâches de votre charge de travail à l’aide de la méthode Split() présentée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="b1412-186">You can implement the split logic for the tasks in your workload by using the Split() method show below:</span></span>

```csharp
/// <summary>
/// Gets the tasks into which to split the job. This is where you inject
/// your application-specific logic for decomposing the job into tasks.
///
/// The job manager framework invokes the Split method for you; you need
/// only to implement it, not to call it yourself. Typically, your
/// implementation should return tasks lazily, for example using a C#
/// iterator and the "yield return" statement; this allows tasks to be added
/// and to start running while splitting is still in progress.
/// </summary>
/// <returns>The tasks to be added to the job. Tasks are added automatically
/// by the job manager framework as they are returned by this method.</returns>
public IEnumerable<CloudTask> Split()
{
    // Your code for the split logic goes here.
    int startFrame = Convert.ToInt32(_parameters["StartFrame"]);
    int endFrame = Convert.ToInt32(_parameters["EndFrame"]);

    for (int i = startFrame; i <= endFrame; i++)
    {
        yield return new CloudTask("myTask" + i, "cmd /c dir");
    }
}
```

> [!NOTE]
> <span data-ttu-id="b1412-187">La section annotée dans la méthode `Split()` est la seule section de code du modèle du gestionnaire de travaux que vous êtes censé modifier en ajoutant la logique de fractionnement de vos travaux en différentes tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-187">The annotated section in the `Split()` method is the only section of the Job Manager template code that is intended for you to modify by adding the logic to split your jobs into different tasks.</span></span> <span data-ttu-id="b1412-188">Si vous souhaitez modifier une autre section du modèle, assurez-vous de maîtriser le fonctionnement de Batch et essayez quelques-uns des [exemples de code Batch][github_samples].</span><span class="sxs-lookup"><span data-stu-id="b1412-188">If you want to modify a different section of the template, please ensure you are familiarized with how Batch works, and try out a few of the [Batch code samples][github_samples].</span></span>
> 
> 

<span data-ttu-id="b1412-189">Votre implémentation Split() a accès :</span><span class="sxs-lookup"><span data-stu-id="b1412-189">Your Split() implementation has access to:</span></span>

* <span data-ttu-id="b1412-190">Aux paramètres du travail, via le champ `_parameters` .</span><span class="sxs-lookup"><span data-stu-id="b1412-190">The job parameters, via the `_parameters` field.</span></span>
* <span data-ttu-id="b1412-191">À l’objet CloudJob représentant le travail, via le champ `_job` .</span><span class="sxs-lookup"><span data-stu-id="b1412-191">The CloudJob object representing the job, via the `_job` field.</span></span>
* <span data-ttu-id="b1412-192">À l’objet CloudTask représentant la tâche du gestionnaire de travaux, via le champ `_jobManagerTask` .</span><span class="sxs-lookup"><span data-stu-id="b1412-192">The CloudTask object representing the job manager task, via the `_jobManagerTask` field.</span></span>

<span data-ttu-id="b1412-193">Il n’est pas nécessaire que votre implémentation `Split()` ajoute directement des tâches au travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-193">Your `Split()` implementation does not need to add tasks to the job directly.</span></span> <span data-ttu-id="b1412-194">Au lieu de cela, votre code doit retourner une séquence d’objets CloudTask, qui seront automatiquement ajoutés au travail par les classes de l’infrastructure appelant l’outil de fractionnement du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-194">Instead, your code should return a sequence of CloudTask objects, and these will be added to the job automatically by the framework classes that invoke the job splitter.</span></span> <span data-ttu-id="b1412-195">Il est courant d’utiliser la fonctionnalité de l’itérateur C# (`yield return`) pour implémenter des outils de fractionnement du travail, car elle permet de lancer les tâches dès que possible plutôt que d’attendre qu’elles soient toutes calculées.</span><span class="sxs-lookup"><span data-stu-id="b1412-195">It's common to use C#'s iterator (`yield return`) feature to implement job splitters as this allows the tasks to start running as soon as possible rather than waiting for all tasks to be calculated.</span></span>

<span data-ttu-id="b1412-196">**Échec du fractionnement du travail**</span><span class="sxs-lookup"><span data-stu-id="b1412-196">**Job splitter failure**</span></span>

<span data-ttu-id="b1412-197">Si votre outil de fractionnement du travail rencontre une erreur, il doit soit :</span><span class="sxs-lookup"><span data-stu-id="b1412-197">If your job splitter encounters an error, it should either:</span></span>

* <span data-ttu-id="b1412-198">Terminer la séquence à l’aide de l’instruction C# `yield break` , auquel cas le gestionnaire de travaux sera considéré comme ayant réussi ; ou</span><span class="sxs-lookup"><span data-stu-id="b1412-198">Terminate the sequence using the C# `yield break` statement, in which case the job manager will be treated as successful; or</span></span>
* <span data-ttu-id="b1412-199">Lever une exception, auquel cas le gestionnaire de travaux sera traité comme s’il avait échoué et pourra être relancé, selon la façon dont le client l’a configuré.</span><span class="sxs-lookup"><span data-stu-id="b1412-199">Throw an exception, in which case the job manager will be treated as failed and may be retried depending on how the client has configured it).</span></span>

<span data-ttu-id="b1412-200">Dans les deux cas, toutes les tâches déjà retournées par l’outil de fractionnement du travail et ajoutées au travail Batch seront autorisées à être exécutées.</span><span class="sxs-lookup"><span data-stu-id="b1412-200">In both cases, any tasks already returned by the job splitter and added to the Batch job will be eligible to run.</span></span> <span data-ttu-id="b1412-201">Si vous souhaitez éviter cette situation, vous pouvez :</span><span class="sxs-lookup"><span data-stu-id="b1412-201">If you don't want this to happen, then you could:</span></span>

* <span data-ttu-id="b1412-202">Arrêter le travail avant qu’il ne soit retourné par l’outil de fractionnement du travail</span><span class="sxs-lookup"><span data-stu-id="b1412-202">Terminate the job before returning from the job splitter</span></span>
* <span data-ttu-id="b1412-203">Foumuler toute la collection de tâches avant de la retourner (autrement dit, retourner `ICollection<CloudTask>` ou `IList<CloudTask>` instead of implementing your job splitter using a C# iteratou)</span><span class="sxs-lookup"><span data-stu-id="b1412-203">Formulate the entire task collection before returning it (that is, return an `ICollection<CloudTask>` or `IList<CloudTask>` instead of implementing your job splitter using a C# iterator)</span></span>
* <span data-ttu-id="b1412-204">Utiliser les dépendances entre tâches pour rendre toutes les tâches dépendantes de la réussite du gestionnaire de travaux</span><span class="sxs-lookup"><span data-stu-id="b1412-204">Use task dependencies to make all tasks depend on the successful completion of the job manager</span></span>

<span data-ttu-id="b1412-205">**Nouvelles tentatives du gestionnaire de travaux**</span><span class="sxs-lookup"><span data-stu-id="b1412-205">**Job manager retries**</span></span>

<span data-ttu-id="b1412-206">Si le gestionnaire de travaux échoue, il peut être relancé par le service Batch en fonction des paramètres de nouvelles tentatives du client.</span><span class="sxs-lookup"><span data-stu-id="b1412-206">If the job manager fails, it may be retried by the Batch service depending on the client retry settings.</span></span> <span data-ttu-id="b1412-207">En général, il n’y a aucun risque, car lorsque l’infrastructure ajoute des tâches au travail, elle ignore toutes les tâches qui existent déjà.</span><span class="sxs-lookup"><span data-stu-id="b1412-207">In general, this is safe, because when the framework adds tasks to the job, it ignores any tasks that already exist.</span></span> <span data-ttu-id="b1412-208">Toutefois, si le calcul des tâches est coûteux, vous pouvez choisir de ne pas encourir les frais de recalcul des tâches qui ont déjà été ajoutées au projet. À l’inverse, s’il n’est pas garanti que la réexécution génère les mêmes ID de tâches, le comportement « ignorer les doublons » n’intervient pas.</span><span class="sxs-lookup"><span data-stu-id="b1412-208">However, if calculating tasks is expensive, you may not wish to incur the cost of recalculating tasks that have already been added to the job; conversely, if the re-run is not guaranteed to generate the same task IDs then the 'ignore duplicates' behavior will not kick in.</span></span> <span data-ttu-id="b1412-209">Dans ce cas, vous devez concevoir votre outil de fractionnement du travail de manière à ce qu’il détecte le travail déjà effectué et ne le répète pas, par exemple en effectuant CloudJob.ListTasks avant de commencer à générer des tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-209">In these cases you should design your job splitter to detect the work that has already been done and not repeat it, for example by performing a CloudJob.ListTasks before starting to yield tasks.</span></span>

### <a name="exit-codes-and-exceptions-in-the-job-manager-template"></a><span data-ttu-id="b1412-210">Codes de sortie et exceptions dans le modèle du gestionnaire de travaux</span><span class="sxs-lookup"><span data-stu-id="b1412-210">Exit codes and exceptions in the Job Manager template</span></span>
<span data-ttu-id="b1412-211">Les codes de sortie et les exceptions fournissent un mécanisme permettant de déterminer le résultat de l’exécution d’un programme, et peuvent aider à identifier les problèmes rencontrés lors de l’exécution du programme.</span><span class="sxs-lookup"><span data-stu-id="b1412-211">Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help to identify any problems with the execution of the program.</span></span> <span data-ttu-id="b1412-212">Le modèle du gestionnaire de travaux implémente les codes de sortie et les exceptions décrites dans cette section.</span><span class="sxs-lookup"><span data-stu-id="b1412-212">The Job Manager template implements the exit codes and exceptions described in this section.</span></span>

<span data-ttu-id="b1412-213">Une tâche du gestionnaire de travaux implémentée avec le modèle du gestionnaire de travaux peut retourner trois codes de sortie possibles :</span><span class="sxs-lookup"><span data-stu-id="b1412-213">A job manager task that is implemented with the Job Manager template can return three possible exit codes:</span></span>

| <span data-ttu-id="b1412-214">Code</span><span class="sxs-lookup"><span data-stu-id="b1412-214">Code</span></span> | <span data-ttu-id="b1412-215">Description</span><span class="sxs-lookup"><span data-stu-id="b1412-215">Description</span></span> |
| --- | --- |
| <span data-ttu-id="b1412-216">0</span><span class="sxs-lookup"><span data-stu-id="b1412-216">0</span></span> |<span data-ttu-id="b1412-217">Le gestionnaire de travaux s’est terminé avec succès.</span><span class="sxs-lookup"><span data-stu-id="b1412-217">The job manager completed successfully.</span></span> <span data-ttu-id="b1412-218">Le code de votre outil de fractionnement du travail a été exécuté entièrement, et toutes les tâches ont été ajoutées au travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-218">Your job splitter code ran to completion, and all tasks were added to the job.</span></span> |
| <span data-ttu-id="b1412-219">1</span><span class="sxs-lookup"><span data-stu-id="b1412-219">1</span></span> |<span data-ttu-id="b1412-220">La tâche du gestionnaire de travaux a échoué avec une exception rencontrée dans une section « attendue » du programme.</span><span class="sxs-lookup"><span data-stu-id="b1412-220">The job manager task failed with an exception in an 'expected' part of the program.</span></span> <span data-ttu-id="b1412-221">L’exception a été convertie en une JobManagerException avec des informations de diagnostic et, si possible, des suggestions pour résoudre l’échec.</span><span class="sxs-lookup"><span data-stu-id="b1412-221">The exception was translated to a JobManagerException with diagnostic information and, where possible, suggestions for resolving the failure.</span></span> |
| <span data-ttu-id="b1412-222">2</span><span class="sxs-lookup"><span data-stu-id="b1412-222">2</span></span> |<span data-ttu-id="b1412-223">La tâche du gestionnaire de travaux a échoué avec une exception « inattendue ».</span><span class="sxs-lookup"><span data-stu-id="b1412-223">The job manager task failed with an 'unexpected' exception.</span></span> <span data-ttu-id="b1412-224">L’exception a été enregistrée dans la sortie standard, mais le gestionnaire de travaux n’a pas pu ajouter d’informations de diagnostic ou de correction supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b1412-224">The exception was logged to standard output, but the job manager was unable to add any additional diagnostic or remediation information.</span></span> |

<span data-ttu-id="b1412-225">En cas d’échec de la tâche du gestionnaire de travaux, il est possible que certaines tâches aient tout de même été ajoutées au service avant que l’erreur ne se soit produite.</span><span class="sxs-lookup"><span data-stu-id="b1412-225">In the case of job manager task failure, some tasks may still have been added to the service before the error occurred.</span></span> <span data-ttu-id="b1412-226">Ces tâches s’exécutent normalement.</span><span class="sxs-lookup"><span data-stu-id="b1412-226">These tasks will run as normal.</span></span> <span data-ttu-id="b1412-227">Pour plus d’informations sur ce chemin de code, consultez la rubrique « Échec du fractionnement du travail » ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="b1412-227">See "Job Splitter Failure" above for discussion of this code path.</span></span>

<span data-ttu-id="b1412-228">Toutes les informations retournées par des exceptions sont écrites dans des fichiers stdout.txt et stderr.txt.</span><span class="sxs-lookup"><span data-stu-id="b1412-228">All the information returned by exceptions is written into stdout.txt and stderr.txt files.</span></span> <span data-ttu-id="b1412-229">Pour plus d’informations, consultez la rubrique [Gestion des erreurs](batch-api-basics.md#error-handling).</span><span class="sxs-lookup"><span data-stu-id="b1412-229">For more information, see [Error Handling](batch-api-basics.md#error-handling).</span></span>

### <a name="client-considerations"></a><span data-ttu-id="b1412-230">Considérations du client</span><span class="sxs-lookup"><span data-stu-id="b1412-230">Client considerations</span></span>
<span data-ttu-id="b1412-231">Cette section présente certaines exigences d’implémentation du client lors de l’appel d’un gestionnaire de travaux basé sur ce modèle.</span><span class="sxs-lookup"><span data-stu-id="b1412-231">This section describes some client implementation requirements when invoking a job manager based on this template.</span></span> <span data-ttu-id="b1412-232">Pour plus d’informations, consultez la section expliquant [comment transmettre des paramètres et des paramètres d’environnement à partir du code client](#pass-environment-settings) .</span><span class="sxs-lookup"><span data-stu-id="b1412-232">See [How to pass parameters and environment variables from the client code](#pass-environment-settings) for details on passing parameters and environment settings.</span></span>

<span data-ttu-id="b1412-233">**Informations d’identification obligatoires**</span><span class="sxs-lookup"><span data-stu-id="b1412-233">**Mandatory credentials**</span></span>

<span data-ttu-id="b1412-234">Pour ajouter des tâches au travail Azure Batch, la tâche du gestionnaire de travaux requiert la clé et l’URL de votre compte Azure Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-234">In order to add tasks to the Azure Batch job, the job manager task requires your Azure Batch account URL and key.</span></span> <span data-ttu-id="b1412-235">Vous devez les transmettre en tant que variables d’environnement appelées YOUR_BATCH_URL et YOUR_BATCH_KEY.</span><span class="sxs-lookup"><span data-stu-id="b1412-235">You must pass these in environment variables named YOUR_BATCH_URL and YOUR_BATCH_KEY.</span></span> <span data-ttu-id="b1412-236">Vous pouvez les définir dans les paramètres d’environnement de tâche du gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-236">You can set these in the Job Manager task environment settings.</span></span> <span data-ttu-id="b1412-237">Par exemple, dans un client C# :</span><span class="sxs-lookup"><span data-stu-id="b1412-237">For example, in a C# client:</span></span>

```csharp
job.JobManagerTask.EnvironmentSettings = new [] {
    new EnvironmentSetting("YOUR_BATCH_URL", "https://account.region.batch.azure.com"),
    new EnvironmentSetting("YOUR_BATCH_KEY", "{your_base64_encoded_account_key}"),
};
```
<span data-ttu-id="b1412-238">**Informations d’identification de stockage**</span><span class="sxs-lookup"><span data-stu-id="b1412-238">**Storage credentials**</span></span>

<span data-ttu-id="b1412-239">En règle générale, le client n’a pas besoin de fournir les informations d’identification du compte de stockage lié à la tâche du gestionnaire de travaux, car (a) la plupart des gestionnaires de travaux n’ont pas besoin d’accéder explicitement au compte de stockage lié et (b) le compte de stockage lié est souvent fourni pour toutes les tâches en tant que paramètre d’environnement commun du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-239">Typically, the client does not need to provide the linked storage account credentials to the job manager task because (a) most job managers do not need to explicitly access the linked storage account and (b) the linked storage account is often provided to all tasks as a common environment setting for the job.</span></span> <span data-ttu-id="b1412-240">Si vous ne fournissez pas le compte de stockage lié via les paramètres d’environnement commun, et si le gestionnaire de travaux a besoin d’accéder au compte de stockage lié, vous devez fournir les informations d’identification de stockage comme suit :</span><span class="sxs-lookup"><span data-stu-id="b1412-240">If you are not providing the linked storage account via the common environment settings, and the job manager requires access to linked storage, then you should supply the linked storage credentials as follows:</span></span>

```csharp
job.JobManagerTask.EnvironmentSettings = new [] {
    /* other environment settings */
    new EnvironmentSetting("LINKED_STORAGE_ACCOUNT", "{storageAccountName}"),
    new EnvironmentSetting("LINKED_STORAGE_KEY", "{storageAccountKey}"),
};
```

<span data-ttu-id="b1412-241">**Paramètres de tâche du gestionnaire de travaux**</span><span class="sxs-lookup"><span data-stu-id="b1412-241">**Job manager task settings**</span></span>

<span data-ttu-id="b1412-242">Le client doit définir l’indicateur *killJobOnCompletion* du gestionnaire de travaux sur **false**.</span><span class="sxs-lookup"><span data-stu-id="b1412-242">The client should set the job manager *killJobOnCompletion* flag to **false**.</span></span>

<span data-ttu-id="b1412-243">Généralement, le client peut définir *runExclusive* sur **false**en toute sécurité.</span><span class="sxs-lookup"><span data-stu-id="b1412-243">It is usually safe for the client to set *runExclusive* to **false**.</span></span>

<span data-ttu-id="b1412-244">Le client doit utiliser la collection *resourceFiles* ou *applicationPackageReferences* pour que l’exécutable du gestionnaire de travaux (et ses fichiers DLL requis) soit déployé sur le nœud de calcul.</span><span class="sxs-lookup"><span data-stu-id="b1412-244">The client should use the *resourceFiles* or *applicationPackageReferences* collection to have the job manager executable (and its required DLLs) deployed to the compute node.</span></span>

<span data-ttu-id="b1412-245">Par défaut, le gestionnaire de travaux ne sera pas relancé en cas d’échec.</span><span class="sxs-lookup"><span data-stu-id="b1412-245">By default, the job manager will not be retried if it fails.</span></span> <span data-ttu-id="b1412-246">En fonction de la logique de votre gestionnaire de travaux, il est possible que le client souhaite autoriser les nouvelles tentatives par le biais de *constraints*/*maxTaskRetryCount*.</span><span class="sxs-lookup"><span data-stu-id="b1412-246">Depending on your job manager logic, the client may want to enable retries via *constraints*/*maxTaskRetryCount*.</span></span>

<span data-ttu-id="b1412-247">**Paramètres du travail**</span><span class="sxs-lookup"><span data-stu-id="b1412-247">**Job settings**</span></span>

<span data-ttu-id="b1412-248">Si l’outil de fractionnement du travail émet des tâches avec des dépendances, le client doit définir la propriété usesTaskDependencies du travail sur true.</span><span class="sxs-lookup"><span data-stu-id="b1412-248">If the job splitter emits tasks with dependencies, the client must set the job's usesTaskDependencies to true.</span></span>

<span data-ttu-id="b1412-249">Dans le modèle de fractionnement du travail, il est rare que les clients souhaitent ajouter à des travaux davantage de tâches que celles que crée l’outil de fractionnement du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-249">In the job splitter model, it is unusual for clients to wish to add tasks to jobs over and above what the job splitter creates.</span></span> <span data-ttu-id="b1412-250">Le client doit donc définir normalement la propriété *onAllTasksComplete* du travail sur **terminatejob**.</span><span class="sxs-lookup"><span data-stu-id="b1412-250">The client should therefore normally set the job's *onAllTasksComplete* to **terminatejob**.</span></span>

## <a name="task-processor-template"></a><span data-ttu-id="b1412-251">Modèle du processeur de tâches</span><span class="sxs-lookup"><span data-stu-id="b1412-251">Task Processor template</span></span>
<span data-ttu-id="b1412-252">Le modèle du processeur de tâches vous permet d’implémenter une tâche du processeur de tâches pouvant effectuer les actions suivantes :</span><span class="sxs-lookup"><span data-stu-id="b1412-252">A Task Processor template helps you to implement a task processor that can perform the following actions:</span></span>

* <span data-ttu-id="b1412-253">Définir les informations requises par chaque tâche Batch à exécuter.</span><span class="sxs-lookup"><span data-stu-id="b1412-253">Set up the information required by each Batch task to run.</span></span>
* <span data-ttu-id="b1412-254">Exécuter toutes les actions requises par chaque tâche Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-254">Run all actions required by each Batch task.</span></span>
* <span data-ttu-id="b1412-255">Enregistrer les sorties de tâche dans un emplacement de stockage permanent.</span><span class="sxs-lookup"><span data-stu-id="b1412-255">Save task outputs to persistent storage.</span></span>

<span data-ttu-id="b1412-256">Bien qu’un processeur de tâches ne soit pas nécessaire pour exécuter des tâches dans Batch, le principal avantage à utiliser un processeur de tâches est qu’il fournit un wrapper pour implémenter toutes les actions d’exécution de tâches à un seul emplacement.</span><span class="sxs-lookup"><span data-stu-id="b1412-256">Although a task processor is not required to run tasks on Batch, the key advantage of using a task processor is that it provides a wrapper to implement all task execution actions in one location.</span></span> <span data-ttu-id="b1412-257">Par exemple, si vous devez exécuter plusieurs applications dans le contexte de chaque tâche, ou si vous devez copier des données vers un emplacement de stockage permanent après la fin de chaque tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-257">For example, if you need to run several applications in the context of each task, or if you need to copy data to persistent storage after completing each task.</span></span>

<span data-ttu-id="b1412-258">Les actions effectuées par le processeur de tâches peuvent être simples ou complexes, nombreuses ou peu nombreuses, en fonction des besoins de votre charge de travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-258">The actions performed by the task processor can be as simple or complex, and as many or as few, as required by your workload.</span></span> <span data-ttu-id="b1412-259">En outre, en mettant en œuvre toutes les actions de tâches dans un processeur de tâches, vous pouvez facilement mettre à jour ou ajouter des actions en fonction des modifications apportées aux besoins des applications ou des charges de travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-259">Additionally, by implementing all task actions into one task processor, you can readily update or add actions based on changes to applications or workload requirements.</span></span> <span data-ttu-id="b1412-260">Toutefois, dans certains cas, le processeur de tâches n’est pas forcément la solution optimale pour votre implémentation puisqu’il peut engendrer une complexité inutile, par exemple si vous exécutez des travaux pouvant être démarrés rapidement à l’aide d’une simple ligne de commande.</span><span class="sxs-lookup"><span data-stu-id="b1412-260">However, in some cases a task processor might not be the optimal solution for your implementation as it can add unnecessary complexity, for example when running jobs that can be quickly started from a simple command line.</span></span>

### <a name="create-a-task-processor-using-the-template"></a><span data-ttu-id="b1412-261">Créer un processeur de tâches à l’aide du modèle</span><span class="sxs-lookup"><span data-stu-id="b1412-261">Create a Task Processor using the template</span></span>
<span data-ttu-id="b1412-262">Pour ajouter un processeur de tâches à la solution que vous avez créée précédemment, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="b1412-262">To add a task processor to the solution that you created earlier, follow these steps:</span></span>

1. <span data-ttu-id="b1412-263">Ouvrez votre solution existante dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b1412-263">Open your existing solution in Visual Studio.</span></span>
2. <span data-ttu-id="b1412-264">Dans l’Explorateur de solutions, cliquez avec le bouton droit sur la solution, cliquez sur **Ajouter**, puis sur **Nouveau projet**.</span><span class="sxs-lookup"><span data-stu-id="b1412-264">In Solution Explorer, right-click the solution, click **Add**, and then click **New Project**.</span></span>
3. <span data-ttu-id="b1412-265">Sous **Visual C#**, cliquez sur **Cloud**, puis sur **Azure Batch Task Processor** (Processeur de tâches Azure Batch).</span><span class="sxs-lookup"><span data-stu-id="b1412-265">Under **Visual C#**, click **Cloud**, and then click **Azure Batch Task Processor**.</span></span>
4. <span data-ttu-id="b1412-266">Entrez un nom décrivant votre application et identifiant ce projet en tant que le processeur de tâches (par exemple, « ProcesseurLitwareTask »).</span><span class="sxs-lookup"><span data-stu-id="b1412-266">Type a name that describes your application and identifies this project as the task processor (e.g. "LitwareTaskProcessor").</span></span>
5. <span data-ttu-id="b1412-267">Cliquez sur **OK**pour créer le projet.</span><span class="sxs-lookup"><span data-stu-id="b1412-267">To create the project, click **OK**.</span></span>
6. <span data-ttu-id="b1412-268">Pour finir, générez le projet pour forcer Visual Studio à charger tous les packages NuGet référencés et vérifier que le projet est valide avant de commencer à le modifier.</span><span class="sxs-lookup"><span data-stu-id="b1412-268">Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.</span></span>

### <a name="task-processor-template-files-and-their-purpose"></a><span data-ttu-id="b1412-269">Les fichiers du modèle du processeur de tâches et leur objectif</span><span class="sxs-lookup"><span data-stu-id="b1412-269">Task Processor template files and their purpose</span></span>
<span data-ttu-id="b1412-270">Lorsque vous créez un projet à l’aide du modèle du processeur de tâches, il génère trois groupes de fichiers de code :</span><span class="sxs-lookup"><span data-stu-id="b1412-270">When you create a project using the task processor template, it generates three groups of code files:</span></span>

* <span data-ttu-id="b1412-271">Le fichier de programme principal (Program.cs).</span><span class="sxs-lookup"><span data-stu-id="b1412-271">The main program file (Program.cs).</span></span> <span data-ttu-id="b1412-272">Il contient le point d’entrée du programme et la gestion des exceptions de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b1412-272">This contains the program entry point and top-level exception handling.</span></span> <span data-ttu-id="b1412-273">Vous n’avez normalement pas besoin de modifier cette configuration.</span><span class="sxs-lookup"><span data-stu-id="b1412-273">You shouldn't normally need to modify this.</span></span>
* <span data-ttu-id="b1412-274">Le répertoire Framework.</span><span class="sxs-lookup"><span data-stu-id="b1412-274">The Framework directory.</span></span> <span data-ttu-id="b1412-275">Il contient les fichiers responsables du travail « boilerplate » (réutilisable) effectué par le programme du gestionnaire de travaux – décompression de paramètres, ajout de tâches au travail Batch, etc. Vous n’avez normalement pas besoin de modifier ces fichiers.</span><span class="sxs-lookup"><span data-stu-id="b1412-275">This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.</span></span>
* <span data-ttu-id="b1412-276">Le fichier du processeur de tâches (TaskProcessor.cs).</span><span class="sxs-lookup"><span data-stu-id="b1412-276">The task processor file (TaskProcessor.cs).</span></span> <span data-ttu-id="b1412-277">C’est là que vous allez placer la logique spécifique à votre application pour l’exécution d’une tâche (généralement en appelant un exécutable existant).</span><span class="sxs-lookup"><span data-stu-id="b1412-277">This is where you will put your application-specific logic for executing a task (typically by calling out to an existing executable).</span></span> <span data-ttu-id="b1412-278">C’est aussi là que se trouve le code de pré et de post-traitement, tel que le téléchargement de données supplémentaires ou de fichiers de résultats.</span><span class="sxs-lookup"><span data-stu-id="b1412-278">Pre- and post-processing code, such as downloading additional data or uploading result files, also goes here.</span></span>

<span data-ttu-id="b1412-279">Bien sûr, vous pouvez si besoin ajouter des fichiers supplémentaires pour prendre en charge le code de votre processeur de tâches, en fonction de la complexité de la logique de fractionnement du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-279">Of course you can add additional files as required to support your task processor code, depending on the complexity of the job splitting logic.</span></span>

<span data-ttu-id="b1412-280">Le modèle génère également des fichiers de projet .NET standard comme des fichiers .csproj, app.config, packages.config, etc.</span><span class="sxs-lookup"><span data-stu-id="b1412-280">The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.</span></span>

<span data-ttu-id="b1412-281">Le reste de cette section décrit les différents fichiers et leur structure de code, et explique ce que fait chaque classe.</span><span class="sxs-lookup"><span data-stu-id="b1412-281">The rest of this section describes the different files and their code structure, and explains what each class does.</span></span>

![Explorateur de solutions Visual Studio affichant la solution du modèle du processeur de tâches][solution_explorer02]

<span data-ttu-id="b1412-283">**Fichiers Framework**</span><span class="sxs-lookup"><span data-stu-id="b1412-283">**Framework files**</span></span>

* <span data-ttu-id="b1412-284">`Configuration.cs`: Encapsule le chargement des données de configuration du travail, telles que les détails du compte Batch, les informations d’identification du compte de stockage lié, les informations relatives aux travaux et aux tâches, et les paramètres du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-284">`Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.</span></span> <span data-ttu-id="b1412-285">Il donne également accès aux variables d’environnement définies par Batch (voir les paramètres d’environnement des tâches, dans la documentation Batch) via la classe Configuration.EnvironmentVariable.</span><span class="sxs-lookup"><span data-stu-id="b1412-285">It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.</span></span>
* <span data-ttu-id="b1412-286">`IConfiguration.cs`: Résume l’implémentation de la classe de configuration, afin que vous puissiez soumettre votre outil de fractionnement du travail à un test unitaire, à l’aide d’un objet de configuration fictif ou simulé.</span><span class="sxs-lookup"><span data-stu-id="b1412-286">`IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.</span></span>
* <span data-ttu-id="b1412-287">`TaskProcessorException.cs`: Représente une erreur nécessitant l’arrêt du gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-287">`TaskProcessorException.cs`: Represents an error that requires the job manager to terminate.</span></span> <span data-ttu-id="b1412-288">TaskProcessorException est utilisé pour encapsuler des erreurs « attendues » lorsque des informations de diagnostic spécifiques peuvent être fournies dans le cadre de l’arrêt.</span><span class="sxs-lookup"><span data-stu-id="b1412-288">TaskProcessorException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.</span></span>

<span data-ttu-id="b1412-289">**Processeur de tâches**</span><span class="sxs-lookup"><span data-stu-id="b1412-289">**Task Processor**</span></span>

* <span data-ttu-id="b1412-290">`TaskProcessor.cs`: Exécute la tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-290">`TaskProcessor.cs`: Runs the task.</span></span> <span data-ttu-id="b1412-291">L’infrastructure appelle la méthode TaskProcessor.Run.</span><span class="sxs-lookup"><span data-stu-id="b1412-291">The framework invokes the TaskProcessor.Run method.</span></span> <span data-ttu-id="b1412-292">C’est la classe où vous injecterez la logique spécifique à l’application de votre tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-292">This is the class where you will inject the application-specific logic of your task.</span></span> <span data-ttu-id="b1412-293">Implémentez la méthode Run pour :</span><span class="sxs-lookup"><span data-stu-id="b1412-293">Implement the Run method to:</span></span>
  * <span data-ttu-id="b1412-294">Analyser et valider les paramètres de n’importe quelle tâche</span><span class="sxs-lookup"><span data-stu-id="b1412-294">Parse and validate any task parameters</span></span>
  * <span data-ttu-id="b1412-295">Composer la ligne de commande pour tout programme externe que vous souhaitez appeler</span><span class="sxs-lookup"><span data-stu-id="b1412-295">Compose the command line for any external program you want to invoke</span></span>
  * <span data-ttu-id="b1412-296">Enregistrer des informations de diagnostic qui peuvent vous être utiles pour le débogage</span><span class="sxs-lookup"><span data-stu-id="b1412-296">Log any diagnostic information you may require for debugging purposes</span></span>
  * <span data-ttu-id="b1412-297">Démarrer un processus à l’aide de cette ligne de commande</span><span class="sxs-lookup"><span data-stu-id="b1412-297">Start a process using that command line</span></span>
  * <span data-ttu-id="b1412-298">Attendre que le processus s’arrête</span><span class="sxs-lookup"><span data-stu-id="b1412-298">Wait for the process to exit</span></span>
  * <span data-ttu-id="b1412-299">Capturer le code de sortie du processus pour déterminer s’il a réussi ou échoué</span><span class="sxs-lookup"><span data-stu-id="b1412-299">Capture the exit code of the process to determine if it succeeded or failed</span></span>
  * <span data-ttu-id="b1412-300">Enregistrer tous les fichiers de sortie que vous souhaitez conserver dans un emplacement de stockage permanent</span><span class="sxs-lookup"><span data-stu-id="b1412-300">Save any output files you want to keep to persistent storage</span></span>

<span data-ttu-id="b1412-301">**Fichiers de projet de ligne de commande .NET standard**</span><span class="sxs-lookup"><span data-stu-id="b1412-301">**Standard .NET command line project files**</span></span>

* <span data-ttu-id="b1412-302">`App.config`: Fichier de configuration d’application .NET standard.</span><span class="sxs-lookup"><span data-stu-id="b1412-302">`App.config`: Standard .NET application configuration file.</span></span>
* <span data-ttu-id="b1412-303">`Packages.config`: Fichier de dépendance de package NuGet standard.</span><span class="sxs-lookup"><span data-stu-id="b1412-303">`Packages.config`: Standard NuGet package dependency file.</span></span>
* <span data-ttu-id="b1412-304">`Program.cs`: Contient le point d’entrée du programme et la gestion des exceptions de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b1412-304">`Program.cs`: Contains the program entry point and top-level exception handling.</span></span>

## <a name="implementing-the-task-processor"></a><span data-ttu-id="b1412-305">Implémenter le processeur de tâches</span><span class="sxs-lookup"><span data-stu-id="b1412-305">Implementing the task processor</span></span>
<span data-ttu-id="b1412-306">Lorsque vous ouvrez le projet de modèle du processeur de tâches, il ouvre le fichier TaskProcessor.cs par défaut.</span><span class="sxs-lookup"><span data-stu-id="b1412-306">When you open the Task Processor template project, the project will have the TaskProcessor.cs file open by default.</span></span> <span data-ttu-id="b1412-307">Vous pouvez implémenter la logique d’exécution pour les tâches de votre charge de travail à l’aide de la méthode Run() présentée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="b1412-307">You can implement the run logic for the tasks in your workload by using the Run() method shown below:</span></span>

```csharp
/// <summary>
/// Runs the task processing logic. This is where you inject
/// your application-specific logic for decomposing the job into tasks.
///
/// The task processor framework invokes the Run method for you; you need
/// only to implement it, not to call it yourself. Typically, your
/// implementation will execute an external program (from resource files or
/// an application package), check the exit code of that program and
/// save output files to persistent storage.
/// </summary>
public async Task<int> Run()

{
    try
    {
        //Your code for the task processor goes here.
        var command = $"compare {_parameters["Frame1"]} {_parameters["Frame2"]} compare.gif";
        using (var process = Process.Start($"cmd /c {command}"))
        {
            process.WaitForExit();
            var taskOutputStorage = new TaskOutputStorage(
            _configuration.StorageAccount,
            _configuration.JobId,
            _configuration.TaskId
            );
            await taskOutputStorage.SaveAsync(
            TaskOutputKind.TaskOutput,
            @"..\stdout.txt",
            @"stdout.txt"
            );
            return process.ExitCode;
        }
    }
    catch (Exception ex)
    {
        throw new TaskProcessorException(
        $"{ex.GetType().Name} exception in run task processor: {ex.Message}",
        ex
        );
    }
}
```
> [!NOTE]
> <span data-ttu-id="b1412-308">La section annotée dans la méthode Run() est la seule section de code du modèle du processeur de tâches que vous êtes censé modifier en ajoutant la logique d’exécution des tâches de votre charge de travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-308">The annotated section in the Run() method is the only section of the Task Processor template code that is intended for you to modify by adding the run logic for the tasks in your workload.</span></span> <span data-ttu-id="b1412-309">Si vous souhaitez modifier une autre section du modèle, familiarisez-vous d’abord avec le fonctionnement de Batch en consultant la documentation Batch et en essayant quelques-uns des exemples de code Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-309">If you want to modify a different section of the template, please first familiarize yourself with how Batch works by reviewing the Batch documentation and trying out a few of the Batch code samples.</span></span>
> 
> 

<span data-ttu-id="b1412-310">La méthode Run() est chargée de lancer de la ligne de commande, de démarrer un ou plusieurs processus, d’attendre que tous les processus se terminent, d’enregistrer les résultats, et de retourner un code de sortie.</span><span class="sxs-lookup"><span data-stu-id="b1412-310">The Run() method is responsible for launching the command line, starting one or more processes, waiting for all process to complete, saving the results, and finally returning with an exit code.</span></span> <span data-ttu-id="b1412-311">C’est dans la méthode Run() que vous implémentez la logique de traitement de vos tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-311">The Run() method is where you implement the processing logic for your tasks.</span></span> <span data-ttu-id="b1412-312">C’est l’infrastructure du processeur de tâches qui appelle la méthode Run() ; il est inutile de l’appeler vous-même.</span><span class="sxs-lookup"><span data-stu-id="b1412-312">The task processor framework invokes the Run() method for you; you do not need to call it yourself.</span></span>

<span data-ttu-id="b1412-313">Votre implémentation Run() a accès :</span><span class="sxs-lookup"><span data-stu-id="b1412-313">Your Run() implementation has access to:</span></span>

* <span data-ttu-id="b1412-314">Aux paramètres de la tâche, via le champ `_parameters`.</span><span class="sxs-lookup"><span data-stu-id="b1412-314">The task parameters, via the `_parameters` field.</span></span>
* <span data-ttu-id="b1412-315">Aux ID du travail et de la tâche, via les champs `_jobId` et `_taskId`.</span><span class="sxs-lookup"><span data-stu-id="b1412-315">The job and task ids, via the `_jobId` and `_taskId` fields.</span></span>
* <span data-ttu-id="b1412-316">À la configuration de la tâche, via le champ `_configuration` .</span><span class="sxs-lookup"><span data-stu-id="b1412-316">The task configuration, via the `_configuration` field.</span></span>

<span data-ttu-id="b1412-317">**Échec de la tâche**</span><span class="sxs-lookup"><span data-stu-id="b1412-317">**Task failure**</span></span>

<span data-ttu-id="b1412-318">En cas d’échec, vous pouvez quitter la méthode Run() en levant une exception, mais le contrôle du code de sortie de la tâche est alors confié au gestionnaire d’exceptions de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="b1412-318">In case of failure, you can exit the Run() method by throwing an exception, but this leaves the top level exception handler in control of the task exit code.</span></span> <span data-ttu-id="b1412-319">Si vous avez besoin de contrôler le code de sortie afin de pouvoir distinguer les différents types d’échec, par exemple à des fins de diagnostic ou parce que certains modes d’échec doivent arrêter le travail et d’autres non, vous devez quitter la méthode Run() en retournant un code de sortie différent de zéro.</span><span class="sxs-lookup"><span data-stu-id="b1412-319">If you need to control the exit code so that you can distinguish different types of failure, for example for diagnostic purposes or because some failure modes should terminate the job and others should not, then you should exit the Run() method by returning a non-zero exit code.</span></span> <span data-ttu-id="b1412-320">Ce code devient le code de sortie de la tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-320">This becomes the task exit code.</span></span>

### <a name="exit-codes-and-exceptions-in-the-task-processor-template"></a><span data-ttu-id="b1412-321">Codes de sortie et exceptions dans le modèle du processeur de tâches</span><span class="sxs-lookup"><span data-stu-id="b1412-321">Exit codes and exceptions in the Task Processor template</span></span>
<span data-ttu-id="b1412-322">Les codes de sortie et les exceptions fournissent un mécanisme permettant de déterminer le résultat de l’exécution d’un programme, et peuvent aider à identifier les problèmes rencontrés lors de l’exécution du programme.</span><span class="sxs-lookup"><span data-stu-id="b1412-322">Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help identify any problems with the execution of the program.</span></span> <span data-ttu-id="b1412-323">Le modèle du processeur de tâches implémente les codes de sortie et les exceptions décrites dans cette section.</span><span class="sxs-lookup"><span data-stu-id="b1412-323">The Task Processor template implements the exit codes and exceptions described in this section.</span></span>

<span data-ttu-id="b1412-324">Une tâche du processeur de tâches implémentée avec le modèle du processeur de tâches peut retourner trois codes de sortie possibles :</span><span class="sxs-lookup"><span data-stu-id="b1412-324">A task processor task that is implemented with the Task Processor template can return three possible exit codes:</span></span>

| <span data-ttu-id="b1412-325">Code</span><span class="sxs-lookup"><span data-stu-id="b1412-325">Code</span></span> | <span data-ttu-id="b1412-326">Description</span><span class="sxs-lookup"><span data-stu-id="b1412-326">Description</span></span> |
| --- | --- |
| <span data-ttu-id="b1412-327">[Process.ExitCode][process_exitcode]</span><span class="sxs-lookup"><span data-stu-id="b1412-327">[Process.ExitCode][process_exitcode]</span></span> |<span data-ttu-id="b1412-328">Le processeur de tâches s’est terminé.</span><span class="sxs-lookup"><span data-stu-id="b1412-328">The task processor ran to completion.</span></span> <span data-ttu-id="b1412-329">Notez que cela ne signifie pas que le programme que vous avez appelé a réussi, uniquement que le processeur de tâches l’a appelé avec succès et a exécuté le post-traitement sans exceptions.</span><span class="sxs-lookup"><span data-stu-id="b1412-329">Note that this does not imply that the program you invoked was successful – only that the task processor invoked it successfully and performed any post-processing without exceptions.</span></span> <span data-ttu-id="b1412-330">La signification du code de sortie dépend du programme appelé – le code de sortie 0 signifie généralement que le programme a réussi et tous les autres codes de sortie signifient qu’il a échoué.</span><span class="sxs-lookup"><span data-stu-id="b1412-330">The meaning of the exit code depends on the invoked program – typically exit code 0 means the program succeeded and any other exit code means the program failed.</span></span> |
| <span data-ttu-id="b1412-331">1</span><span class="sxs-lookup"><span data-stu-id="b1412-331">1</span></span> |<span data-ttu-id="b1412-332">La tâche du processeur de tâches a échoué avec une exception rencontrée dans une section « attendue » du programme.</span><span class="sxs-lookup"><span data-stu-id="b1412-332">The task processor failed with an exception in an 'expected' part of the program.</span></span> <span data-ttu-id="b1412-333">L’exception a été convertie en une `TaskProcessorException` avec des informations de diagnostic et, si possible, des suggestions pour résoudre l’échec.</span><span class="sxs-lookup"><span data-stu-id="b1412-333">The exception was translated to a `TaskProcessorException` with diagnostic information and, where possible, suggestions for resolving the failure.</span></span> |
| <span data-ttu-id="b1412-334">2</span><span class="sxs-lookup"><span data-stu-id="b1412-334">2</span></span> |<span data-ttu-id="b1412-335">Le processeur de tâches a échoué avec une exception « inattendue ».</span><span class="sxs-lookup"><span data-stu-id="b1412-335">The task processor failed with an 'unexpected' exception.</span></span> <span data-ttu-id="b1412-336">L’exception a été enregistrée dans la sortie standard, mais le processeur de tâches n’a pas pu ajouter d’informations de diagnostic ou de correction supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="b1412-336">The exception was logged to standard output, but the task processor was unable to add any additional diagnostic or remediation information.</span></span> |

> [!NOTE]
> <span data-ttu-id="b1412-337">Si le programme que vous appelez utilise des codes de sortie 1 et 2 pour désigner des modes d’échec spécifiques, il serait ambigu d’utiliser ces mêmes codes de sortie pour les erreurs du processeur de tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-337">If the program you invoke uses exit codes 1 and 2 to indicate specific failure modes, then using exit codes 1 and 2 for task processor errors is ambiguous.</span></span> <span data-ttu-id="b1412-338">Vous pouvez remplacer ces codes d’erreur du processeur de tâches par d’autres codes de sortie en modifiant les cas d’exceptions dans le fichier Program.cs.</span><span class="sxs-lookup"><span data-stu-id="b1412-338">You can change these task processor error codes to distinctive exit codes by editing the exception cases in the Program.cs file.</span></span>
> 
> 

<span data-ttu-id="b1412-339">Toutes les informations retournées par des exceptions sont écrites dans des fichiers stdout.txt et stderr.txt.</span><span class="sxs-lookup"><span data-stu-id="b1412-339">All the information returned by exceptions is written into stdout.txt and stderr.txt files.</span></span> <span data-ttu-id="b1412-340">Pour plus d’informations, consultez la rubrique Gestion des erreurs de la documentation Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-340">For more information, see Error Handling, in the Batch documentation.</span></span>

### <a name="client-considerations"></a><span data-ttu-id="b1412-341">Considérations du client</span><span class="sxs-lookup"><span data-stu-id="b1412-341">Client considerations</span></span>
<span data-ttu-id="b1412-342">**Informations d’identification de stockage**</span><span class="sxs-lookup"><span data-stu-id="b1412-342">**Storage credentials**</span></span>

<span data-ttu-id="b1412-343">Si votre processeur de tâches utilise le stockage blob Azure pour conserver les sorties, par exemple à l’aide de la bibliothèque d’assistance de conventions de fichier, il a besoin d’accéder *soit* aux informations d’identification du compte de stockage cloud, *soit* à une URL de conteneur d’objets blob incluant une signature d’accès partagé (SAP).</span><span class="sxs-lookup"><span data-stu-id="b1412-343">If your task processor uses Azure blob storage to persist outputs, for example using the file conventions helper library, then it needs access to *either* the cloud storage account credentials *or* a blob container URL that includes a shared access signature (SAS).</span></span> <span data-ttu-id="b1412-344">Le modèle inclut une prise en charge pour fournir des informations d’identification via des variables d’environnement commun.</span><span class="sxs-lookup"><span data-stu-id="b1412-344">The template includes support for providing credentials via common environment variables.</span></span> <span data-ttu-id="b1412-345">Votre client peut transmettre les informations d’identification de stockage comme suit :</span><span class="sxs-lookup"><span data-stu-id="b1412-345">Your client can pass the storage credentials as follows:</span></span>

```csharp
job.CommonEnvironmentSettings = new [] {
    new EnvironmentSetting("LINKED_STORAGE_ACCOUNT", "{storageAccountName}"),
    new EnvironmentSetting("LINKED_STORAGE_KEY", "{storageAccountKey}"),
};
```

<span data-ttu-id="b1412-346">Le compte de stockage est ensuite disponible dans la classe TaskProcessor via la propriété `_configuration.StorageAccount` .</span><span class="sxs-lookup"><span data-stu-id="b1412-346">The storage account is then available in the TaskProcessor class via the `_configuration.StorageAccount` property.</span></span>

<span data-ttu-id="b1412-347">Si vous préférez utiliser une URL de conteneur avec SAP, vous pouvez également la transmettre via un paramètre d’environnement commun de travail, mais le modèle de processeur de tâches n’inclut pas la prise en charge intégrée de cette solution pour l’instant.</span><span class="sxs-lookup"><span data-stu-id="b1412-347">If you prefer to use a container URL with SAS, you can also pass this via an job common environment setting, but the task processor template does not currently include built-in support for this.</span></span>

<span data-ttu-id="b1412-348">**Paramétrage du stockage**</span><span class="sxs-lookup"><span data-stu-id="b1412-348">**Storage setup**</span></span>

<span data-ttu-id="b1412-349">Il est recommandé que le client ou la tâche du gestionnaire de travaux crée tous les conteneurs requis par les tâches avant de les ajouter au travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-349">It is recommended that the client or job manager task create any containers required by tasks before adding the tasks to the job.</span></span> <span data-ttu-id="b1412-350">Cette étape est obligatoire si vous utilisez une URL de conteneur avec SAP, puisque ce type d’URL n’inclut pas l’autorisation de créer le conteneur.</span><span class="sxs-lookup"><span data-stu-id="b1412-350">This is mandatory if you use a container URL with SAS, as such a URL does not include permission to create the container.</span></span> <span data-ttu-id="b1412-351">Elle est recommandée même si vous transmettez des informations d’identification de compte de stockage, car elle enregistre toutes les tâches devant appeler CloudBlobContainer.CreateIfNotExistsAsync sur le conteneur.</span><span class="sxs-lookup"><span data-stu-id="b1412-351">It is recommended even if you pass storage account credentials, as it saves every task having to call CloudBlobContainer.CreateIfNotExistsAsync on the container.</span></span>

## <a name="pass-parameters-and-environment-variables"></a><span data-ttu-id="b1412-352">Transmettre des paramètres et des variables d’environnement</span><span class="sxs-lookup"><span data-stu-id="b1412-352">Pass parameters and environment variables</span></span>
### <a name="pass-environment-settings"></a><span data-ttu-id="b1412-353">Transmettre des paramètres d’environnement</span><span class="sxs-lookup"><span data-stu-id="b1412-353">Pass environment settings</span></span>
<span data-ttu-id="b1412-354">Un client peut transmettre des informations à la tâche du gestionnaire de travaux sous la forme de paramètres d’environnement.</span><span class="sxs-lookup"><span data-stu-id="b1412-354">A client can pass information to the job manager task in the form of environment settings.</span></span> <span data-ttu-id="b1412-355">Ces informations peuvent ensuite être utilisées par la tâche du gestionnaire de travaux lors de la génération des tâches du processeur de tâches qui seront exécutées dans le cadre de travail de calcul.</span><span class="sxs-lookup"><span data-stu-id="b1412-355">This information can then be used by the job manager task when generating the task processor tasks that will run as part of the compute job.</span></span> <span data-ttu-id="b1412-356">Les informations que vous pouvez transmettre en tant que paramètres d’environnement sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="b1412-356">Examples of the information that you can pass as environment settings are:</span></span>

* <span data-ttu-id="b1412-357">Clés d’accès et nom du compte de stockage</span><span class="sxs-lookup"><span data-stu-id="b1412-357">Storage account name and account keys</span></span>
* <span data-ttu-id="b1412-358">URL du compte Batch</span><span class="sxs-lookup"><span data-stu-id="b1412-358">Batch account URL</span></span>
* <span data-ttu-id="b1412-359">Clé du compte Batch</span><span class="sxs-lookup"><span data-stu-id="b1412-359">Batch account key</span></span>

<span data-ttu-id="b1412-360">Le service Batch dispose d’un mécanisme simple pour transmettre des paramètres d’environnement à un gestionnaire de travaux, à l’aide de la propriété `EnvironmentSettings` dans [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask].</span><span class="sxs-lookup"><span data-stu-id="b1412-360">The Batch service has a simple mechanism to pass environment settings to a job manager task by using the `EnvironmentSettings` property in [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask].</span></span>

<span data-ttu-id="b1412-361">Par exemple, pour obtenir l’instance `BatchClient` pour un compte Batch, vous pouvez transmettre les variables d’environnement à partir de l’URL du code client ainsi que les informations d’identification de la clé partagée du compte Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-361">For example, to get the `BatchClient` instance for a Batch account, you can pass as environment variables from the client code the URL and shared key credentials for the Batch account.</span></span> <span data-ttu-id="b1412-362">De même, pour accéder au compte de stockage lié au compte Batch, vous pouvez transmettre le nom et la clé du compte de stockage en tant que variables d’environnement.</span><span class="sxs-lookup"><span data-stu-id="b1412-362">Likewise, to access the storage account that is linked to the Batch account, you can pass the storage account name and the storage account key as environment variables.</span></span>

### <a name="pass-parameters-to-the-job-manager-template"></a><span data-ttu-id="b1412-363">Transmettre des paramètres au modèle du gestionnaire de travaux</span><span class="sxs-lookup"><span data-stu-id="b1412-363">Pass parameters to the Job Manager template</span></span>
<span data-ttu-id="b1412-364">Dans de nombreux cas, il est utile de transmettre à la tâche du gestionnaire de travaux les paramètres de chaque travail, soit pour contrôler le processus de fractionnement du travail ou pour configurer les tâches du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-364">In many cases, it's useful to pass per-job parameters to the job manager task, either to control the job splitting process or to configure the tasks for the job.</span></span> <span data-ttu-id="b1412-365">Vous pouvez le faire en téléchargeant un fichier JSON nommé parameters.json en tant fichier de ressources pour la tâche du gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-365">You can do this by uploading a JSON file named parameters.json as a resource file for the job manager task.</span></span> <span data-ttu-id="b1412-366">Les paramètres sont ensuite accessibles dans le champ `JobSplitter._parameters` du modèle du gestionnaire de travaux.</span><span class="sxs-lookup"><span data-stu-id="b1412-366">The parameters can then become available in the `JobSplitter._parameters` field in the Job Manager template.</span></span>

> [!NOTE]
> <span data-ttu-id="b1412-367">Le gestionnaire de paramètres intégré prend en charge uniquement les dictionnaires string-to-string (de chaîne en chaîne).</span><span class="sxs-lookup"><span data-stu-id="b1412-367">The built-in parameter handler supports only string-to-string dictionaries.</span></span> <span data-ttu-id="b1412-368">Si vous souhaitez transmettre des valeurs JSON complexes en tant que valeurs de paramètre, vous devez les transmettre sous forme de chaînes et les analyser dans l’outil de fractionnement du travail ou modifier la méthode `Configuration.GetJobParameters` de l’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="b1412-368">If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the job splitter, or modify the framework's `Configuration.GetJobParameters` method.</span></span>
> 
> 

### <a name="pass-parameters-to-the-task-processor-template"></a><span data-ttu-id="b1412-369">Transmettre des paramètres au modèle du processeur de tâches</span><span class="sxs-lookup"><span data-stu-id="b1412-369">Pass parameters to the Task Processor template</span></span>
<span data-ttu-id="b1412-370">Vous pouvez également transmettre des paramètres à des tâches individuelles implémentées à l’aide du modèle du processeur de tâches.</span><span class="sxs-lookup"><span data-stu-id="b1412-370">You can also pass parameters to individual tasks implemented using the Task Processor template.</span></span> <span data-ttu-id="b1412-371">Tout comme le modèle du gestionnaire de travaux, celui du processeur de tâches recherche un fichier de ressources nommé</span><span class="sxs-lookup"><span data-stu-id="b1412-371">Just as with the job manager template, the task processor template looks for a resource file named</span></span>

<span data-ttu-id="b1412-372">parameters.json et, s’il le trouve, le charge en tant que dictionnaire de paramètres.</span><span class="sxs-lookup"><span data-stu-id="b1412-372">parameters.json, and if found it loads it as the parameters dictionary.</span></span> <span data-ttu-id="b1412-373">Il existe deux options pour transmettre des paramètres aux tâches du processeur de tâches :</span><span class="sxs-lookup"><span data-stu-id="b1412-373">There are a couple of options for how to pass parameters to the task processor tasks:</span></span>

* <span data-ttu-id="b1412-374">Réutiliser le fichier JSON des paramètres du travail.</span><span class="sxs-lookup"><span data-stu-id="b1412-374">Reuse the job parameters JSON.</span></span> <span data-ttu-id="b1412-375">Cette option est efficace si les paramètres concernent l’ensemble du travail (par exemple, un rendu hauteur et largeur).</span><span class="sxs-lookup"><span data-stu-id="b1412-375">This works well if the only parameters are job-wide ones (for example, a render height and width).</span></span> <span data-ttu-id="b1412-376">Pour ce faire, lorsque vous créez un objet CloudTask dans l’outil de fractionnement du travail, ajoutez une référence à l’objet de fichier de ressources parameters.json depuis la collection ResourceFiles de la tâche du gestionnaire de travaux (`JobSplitter._jobManagerTask.ResourceFiles`) vers la collection ResourceFiles de l’objet CloudTask.</span><span class="sxs-lookup"><span data-stu-id="b1412-376">To do this, when creating a CloudTask in the job splitter, add a reference to the parameters.json resource file object from the job manager task's ResourceFiles (`JobSplitter._jobManagerTask.ResourceFiles`) to the CloudTask's ResourceFiles collection.</span></span>
* <span data-ttu-id="b1412-377">Générer et télécharger un document parameters.json spécifique à une tâche dans le cadre de l’exécution de l’outil de fractionnement du travail, et référencer cet objet blob dans la collection de fichiers de ressources de la tâche.</span><span class="sxs-lookup"><span data-stu-id="b1412-377">Generate and upload a task-specific parameters.json document as part of job splitter execution, and reference that blob in the task's resource files collection.</span></span> <span data-ttu-id="b1412-378">Cela est nécessaire si des tâches différentes ont des paramètres différents.</span><span class="sxs-lookup"><span data-stu-id="b1412-378">This is necessary if different tasks have different parameters.</span></span> <span data-ttu-id="b1412-379">Par exemple, un scénario de rendu 3D dans lequel l’index de l’image est transmis à la tâche en tant que paramètre.</span><span class="sxs-lookup"><span data-stu-id="b1412-379">An example might be a 3D rendering scenario where the frame index is passed to the task as a parameter.</span></span>

> [!NOTE]
> <span data-ttu-id="b1412-380">Le gestionnaire de paramètres intégré prend en charge uniquement les dictionnaires string-to-string (de chaîne en chaîne).</span><span class="sxs-lookup"><span data-stu-id="b1412-380">The built-in parameter handler supports only string-to-string dictionaries.</span></span> <span data-ttu-id="b1412-381">Si vous souhaitez transmettre des valeurs JSON complexes en tant que valeurs de paramètre, vous devez les transmettre sous forme de chaînes et les analyser dans le processeur de tâches ou modifier la méthode `Configuration.GetTaskParameters` de l’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="b1412-381">If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the task processor, or modify the framework's `Configuration.GetTaskParameters` method.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="b1412-382">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="b1412-382">Next steps</span></span>
### <a name="persist-job-and-task-output-to-azure-storage"></a><span data-ttu-id="b1412-383">Conserver la sortie d’un travail et d’une tâche dans le stockage Azure</span><span class="sxs-lookup"><span data-stu-id="b1412-383">Persist job and task output to Azure Storage</span></span>
<span data-ttu-id="b1412-384">Les [conventions de fichiers Azure Batch][nuget_package] sont également utiles au développement de solutions Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-384">Another helpful tool in Batch solution development is [Azure Batch File Conventions][nuget_package].</span></span> <span data-ttu-id="b1412-385">Utilisez cette bibliothèque de classes .NET (actuellement en version préliminaire) dans vos applications .NET Batch pour stocker et récupérer facilement les sorties des tâches vers et depuis le stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="b1412-385">Use this .NET class library (currently in preview) in your Batch .NET applications to easily store and retrieve task outputs to and from Azure Storage.</span></span> <span data-ttu-id="b1412-386">[Persist Azure Batch job and task output](batch-task-output.md) (Conserver une sortie de tâche et de travail Azure Batch) fait une description complète de la bibliothèque et de son utilisation.</span><span class="sxs-lookup"><span data-stu-id="b1412-386">[Persist Azure Batch job and task output](batch-task-output.md) contains a full discussion of the library and its usage.</span></span>

### <a name="batch-forum"></a><span data-ttu-id="b1412-387">Forum Azure Batch</span><span class="sxs-lookup"><span data-stu-id="b1412-387">Batch Forum</span></span>
<span data-ttu-id="b1412-388">Le [Forum Azure Batch][forum] sur MSDN est l’endroit idéal pour discuter de Batch et poser des questions sur le service.</span><span class="sxs-lookup"><span data-stu-id="b1412-388">The [Azure Batch Forum][forum] on MSDN is a great place to discuss Batch and ask questions about the service.</span></span> <span data-ttu-id="b1412-389">Consultez le forum pour obtenir des publications « permanentes » utiles et publiez les questions que vous vous posez pendant la création de vos solutions Batch.</span><span class="sxs-lookup"><span data-stu-id="b1412-389">Head on over for helpful "sticky" posts, and post your questions as they arise while you build your Batch solutions.</span></span>

[forum]: https://social.msdn.microsoft.com/forums/azure/en-US/home?forum=azurebatch
[net_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobmanagertask.aspx
[github_samples]: https://github.com/Azure/azure-batch-samples
[nuget_package]: https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files
[process_exitcode]: https://msdn.microsoft.com/library/system.diagnostics.process.exitcode.aspx
[vs_gallery]: https://visualstudiogallery.msdn.microsoft.com/
[vs_gallery_templates]: https://go.microsoft.com/fwlink/?linkid=820714
[vs_find_use_ext]: https://msdn.microsoft.com/library/dd293638.aspx

[diagram01]: ./media/batch-visual-studio-templates/diagram01.png
[solution_explorer01]: ./media/batch-visual-studio-templates/solution_explorer01.png
[solution_explorer02]: ./media/batch-visual-studio-templates/solution_explorer02.png
