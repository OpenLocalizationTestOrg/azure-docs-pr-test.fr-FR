---
title: "Conserver le résultat d’un travail et d’une tâche dans le stockage Azure avec l’API de service Azure Batch | Microsoft Docs"
description: "Découvrez comment utiliser l’API de service Batch pour conserver le résultat d’un travail et d’une tâche Batch dans le stockage Azure."
services: batch
author: tamram
manager: timlt
editor: 
ms.service: batch
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: big-compute
ms.date: 06/16/2017
ms.author: tamram
ms.openlocfilehash: 2530b7c20347b9fb58aee4dfe693847cf3911741
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/29/2017
---
# <a name="persist-task-data-to-azure-storage-with-the-batch-service-api"></a><span data-ttu-id="0975e-103">Conserver les données de tâche dans le stockage Azure avec l’API de service Batch</span><span class="sxs-lookup"><span data-stu-id="0975e-103">Persist task data to Azure Storage with the Batch service API</span></span>

[!INCLUDE [batch-task-output-include](../../includes/batch-task-output-include.md)]

<span data-ttu-id="0975e-104">À compter de la version 2017-05-01, l’API de service Batch prend en charge la persistance des données de sortie vers le stockage Azure pour les tâches et les tâches du Gestionnaire de travaux qui s’exécutent sur des pools avec la configuration de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0975e-104">Starting with version 2017-05-01, the Batch service API supports persisting output data to Azure Storage for tasks and job manager tasks that run on pools with the virtual machine configuration.</span></span> <span data-ttu-id="0975e-105">Quand vous ajoutez une tâche, vous pouvez spécifier un conteneur dans le stockage Azure comme destination pour le résultat de la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-105">When you add a task, you can specify a container in Azure Storage as the destination for the task's output.</span></span> <span data-ttu-id="0975e-106">Quand la tâche est terminée, le service Batch écrit les données de sortie dans ce conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-106">The Batch service then writes any output data to that container when the task is complete.</span></span>

<span data-ttu-id="0975e-107">L’un des avantages de l’utilisation de l’API de service Batch pour conserver le résultat de la tâche est que vous n’avez pas besoin de modifier l’application exécutée par la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-107">An advantage to using the Batch service API to persist task output is that you do not need to modify the application that the task is running.</span></span> <span data-ttu-id="0975e-108">Au lieu de cela, avec quelques modifications simples de votre application cliente, vous pouvez conserver le résultat de la tâche à partir du code qui crée la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-108">Instead, with a few simple modifications to your client application, you can persist the task's output from within the code that creates the task.</span></span>   

## <a name="when-do-i-use-the-batch-service-api-to-persist-task-output"></a><span data-ttu-id="0975e-109">Quand utiliser l’API de service Batch pour conserver le résultat de la tâche ?</span><span class="sxs-lookup"><span data-stu-id="0975e-109">When do I use the Batch service API to persist task output?</span></span>

<span data-ttu-id="0975e-110">Azure Batch offre plusieurs manières de conserver le résultat de la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-110">Azure Batch provides more than one way to persist task output.</span></span> <span data-ttu-id="0975e-111">L’utilisation de l’API de service Batch est une approche pratique qui convient particulièrement aux scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="0975e-111">Using the Batch service API is a convenient approach that's best suited to these scenarios:</span></span>

- <span data-ttu-id="0975e-112">Vous souhaitez écrire du code pour conserver le résultat de la tâche à partir de votre application cliente, sans modifier l’application exécutée par votre tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-112">You want to write code to persist task output from within your client application, without modifying the application that your task is running.</span></span>
- <span data-ttu-id="0975e-113">Vous souhaitez conserver le résultat des tâches Batch et des tâches du Gestionnaire de travaux dans des pools créés avec la configuration de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0975e-113">You want to persist output from Batch tasks and job manager tasks in pools created with the virtual machine configuration.</span></span>
- <span data-ttu-id="0975e-114">Vous souhaitez conserver le résultat vers un conteneur de stockage Azure avec un nom arbitraire.</span><span class="sxs-lookup"><span data-stu-id="0975e-114">You want to persist output to an Azure Storage container with an arbitrary name.</span></span>
- <span data-ttu-id="0975e-115">Vous souhaitez conserver le résultat vers un conteneur de stockage Azure nommé conformément à la [norme relative aux Conventions applicables aux fichiers Batch](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span><span class="sxs-lookup"><span data-stu-id="0975e-115">You want to persist output to an Azure Storage container named according to the [Batch File Conventions standard](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span></span> 

<span data-ttu-id="0975e-116">Si votre scénario diffère de ceux répertoriés ci-dessus, vous devrez peut-être envisager une approche différente.</span><span class="sxs-lookup"><span data-stu-id="0975e-116">If your scenario differs from those listed above, you may need to consider a different approach.</span></span> <span data-ttu-id="0975e-117">Par exemple, l’API de service Batch ne prend pas en charge actuellement la diffusion en continu du résultat vers le stockage Azure pendant l’exécution de la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-117">For example, the Batch service API does not currently support streaming output to Azure Storage while the task is running.</span></span> <span data-ttu-id="0975e-118">Pour diffuser le résultat en continu, utilisez la bibliothèque de Conventions applicables aux fichiers Batch, disponible pour .NET.</span><span class="sxs-lookup"><span data-stu-id="0975e-118">To stream output, consider using the Batch File Conventions library, available for .NET.</span></span> <span data-ttu-id="0975e-119">Pour d’autres langages, vous devez implémenter votre propre solution.</span><span class="sxs-lookup"><span data-stu-id="0975e-119">For other languages, you'll need to implement your own solution.</span></span> <span data-ttu-id="0975e-120">Pour plus d’informations sur les autres options de persistance le résultat de tâche, consultez [Conserver les résultats de travaux et tâches terminés dans le stockage Azure](batch-task-output.md).</span><span class="sxs-lookup"><span data-stu-id="0975e-120">For more information on other options for persisting task output, see [Persist job and task output to Azure Storage](batch-task-output.md).</span></span> 

## <a name="create-a-container-in-azure-storage"></a><span data-ttu-id="0975e-121">Créer un conteneur dans le stockage Azure</span><span class="sxs-lookup"><span data-stu-id="0975e-121">Create a container in Azure Storage</span></span>

<span data-ttu-id="0975e-122">Pour conserver le résultat de la tâche dans le stockage Azure, vous devez créer un conteneur qui sert de destination pour vos fichiers de sortie.</span><span class="sxs-lookup"><span data-stu-id="0975e-122">To persist task output to Azure Storage, you'll need to create a container that serves as the destination for your output files.</span></span> <span data-ttu-id="0975e-123">Créez le conteneur avant d’exécuter la tâche, de préférence avant d’envoyer votre travail.</span><span class="sxs-lookup"><span data-stu-id="0975e-123">Create the container before you run your task, preferably before you submit your job.</span></span> <span data-ttu-id="0975e-124">Pour créer le conteneur, utilisez la bibliothèque cliente de stockage Azure ou le SDK approprié.</span><span class="sxs-lookup"><span data-stu-id="0975e-124">To create the container, use the appropriate Azure Storage client library or SDK.</span></span> <span data-ttu-id="0975e-125">Pour plus d’informations sur les API de stockage Azure, consultez la [documentation sur le stockage Azure](https://docs.microsoft.com/azure/storage/).</span><span class="sxs-lookup"><span data-stu-id="0975e-125">For more information about Azure Storage APIs, see the [Azure Storage documentation](https://docs.microsoft.com/azure/storage/).</span></span>

<span data-ttu-id="0975e-126">Par exemple, si vous écrivez votre application en C#, utilisez la [bibliothèque cliente de stockage Azure pour .NET](https://www.nuget.org/packages/WindowsAzure.Storage/).</span><span class="sxs-lookup"><span data-stu-id="0975e-126">For example, if you are writing your application in C#, use the [Azure Storage client library for .NET](https://www.nuget.org/packages/WindowsAzure.Storage/).</span></span> <span data-ttu-id="0975e-127">L’exemple suivant montre comment créer un conteneur :</span><span class="sxs-lookup"><span data-stu-id="0975e-127">The following example shows how to create a container:</span></span>

```csharp
CloudBlobContainer container = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
await conainer.CreateIfNotExists();
```

## <a name="get-a-shared-access-signature-for-the-container"></a><span data-ttu-id="0975e-128">Obtenir une signature d’accès partagé pour le conteneur</span><span class="sxs-lookup"><span data-stu-id="0975e-128">Get a shared access signature for the container</span></span>

<span data-ttu-id="0975e-129">Après avoir créé le conteneur, obtenez une signature d’accès partagé avec un accès en écriture au conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-129">After you create the container, get a shared access signature (SAS) with write access to the container.</span></span> <span data-ttu-id="0975e-130">Une signature d’accès partagé fournit un accès délégué au conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-130">A SAS provides delegated access to the container.</span></span> <span data-ttu-id="0975e-131">La signature d’accès partagé accorde l’accès avec un jeu spécifié d’autorisations et sur un intervalle de temps spécifié.</span><span class="sxs-lookup"><span data-stu-id="0975e-131">The SAS grants access with a specified set of permissions and over a specified time interval.</span></span> <span data-ttu-id="0975e-132">Le service Batch a besoin d’une signature d’accès partagé avec des autorisations d’écriture pour pouvoir écrire le résultat de la tâche dans le conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-132">The Batch service needs a SAS with write permissions to write task output to the container.</span></span> <span data-ttu-id="0975e-133">Pour plus d’informations sur les signatures d’accès partagé, consultez [Utilisation des signatures d’accès partagé \(SAP\) dans le stockage Azure](../storage/common/storage-dotnet-shared-access-signature-part-1.md).</span><span class="sxs-lookup"><span data-stu-id="0975e-133">For more information about SAS, see [Using shared access signatures \(SAS\) in Azure Storage](../storage/common/storage-dotnet-shared-access-signature-part-1.md).</span></span>

<span data-ttu-id="0975e-134">Quand vous obtenez une signature d’accès partagé à l’aide des API de stockage Azure, l’API retourne une chaîne de jeton de signature d’accès partagé.</span><span class="sxs-lookup"><span data-stu-id="0975e-134">When you get a SAS using the Azure Storage APIs, the API returns a SAS token string.</span></span> <span data-ttu-id="0975e-135">Cette chaîne de jeton inclut tous les paramètres de la signature d’accès partagé, notamment les autorisations et l’intervalle pendant lequel la signature d’accès partagé est valide.</span><span class="sxs-lookup"><span data-stu-id="0975e-135">This token string includes all parameters of the SAS, including the permissions and the interval over which the SAS is valid.</span></span> <span data-ttu-id="0975e-136">Pour utiliser la signature d’accès partagé pour accéder à un conteneur dans le stockage Azure, vous devez ajouter la chaîne de jeton de signature d’accès partagé à l’URI de ressource.</span><span class="sxs-lookup"><span data-stu-id="0975e-136">To use the SAS to access a container in Azure Storage, you need to append the SAS token string to the resource URI.</span></span> <span data-ttu-id="0975e-137">L’URI de ressource, avec le jeton de signature d’accès partagé ajouté, fournit un accès authentifié au stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="0975e-137">The resource URI, together with the appended SAS token, provides authenticated access to Azure Storage.</span></span>

<span data-ttu-id="0975e-138">L’exemple suivant montre comment obtenir une chaîne de jeton de signature d’accès partagé en écriture seule pour le conteneur, puis ajoute la signature d’accès partagé à l’URI du conteneur :</span><span class="sxs-lookup"><span data-stu-id="0975e-138">The following example shows how to get a write-only SAS token string for the container, then appends the SAS to the container URI:</span></span>

```csharp
string containerSasToken = container.GetSharedAccessSignature(new SharedAccessBlobPolicy()
{
    SharedAccessExpiryTime = DateTimeOffset.UtcNow.AddDays(1),
    Permissions = SharedAccessBlobPermissions.Write
});

string containerSasUrl = container.Uri.AbsoluteUri + containerSasToken; 
```

## <a name="specify-output-files-for-task-output"></a><span data-ttu-id="0975e-139">Spécifier les fichiers de sortie pour le résultat de la tâche</span><span class="sxs-lookup"><span data-stu-id="0975e-139">Specify output files for task output</span></span>

<span data-ttu-id="0975e-140">Pour spécifier les fichiers de sortie pour une tâche, créez une collection d’objets [OutputFile](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile) et affectez-la à la propriété [CloudTask.OutputFiles](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudtask.outputfiles#Microsoft_Azure_Batch_CloudTask_OutputFiles) quand vous créez la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-140">To specify output files for a task, create a collection of [OutputFile](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile) objects and assign it to the [CloudTask.OutputFiles](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudtask.outputfiles#Microsoft_Azure_Batch_CloudTask_OutputFiles) property when you create the task.</span></span> 

<span data-ttu-id="0975e-141">L’exemple de code .NET suivant crée une tâche qui écrit des nombres aléatoires dans un fichier nommé `output.txt`.</span><span class="sxs-lookup"><span data-stu-id="0975e-141">The following .NET code example creates a task that writes random numbers to a file named `output.txt`.</span></span> <span data-ttu-id="0975e-142">L’exemple crée un fichier de sortie pour `output.txt` à écrire dans le conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-142">The example creates an output file for `output.txt` to be written to the container.</span></span> <span data-ttu-id="0975e-143">Il crée également des fichiers de sortie pour tout fichier journal qui correspond au modèle de fichier `std*.txt` (_par exemple_ `stdout.txt` et `stderr.txt`).</span><span class="sxs-lookup"><span data-stu-id="0975e-143">The example also creates output files for any log files that match the file pattern `std*.txt` (_e.g._, `stdout.txt` and `stderr.txt`).</span></span> <span data-ttu-id="0975e-144">L’URL du conteneur a besoin de la signature d’accès partagé créée précédemment pour le conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-144">The container URL requires the SAS that was created previously for the container.</span></span> <span data-ttu-id="0975e-145">Le service Batch utilise la signature d’accès partagé pour authentifier l’accès au conteneur :</span><span class="sxs-lookup"><span data-stu-id="0975e-145">The Batch service uses the SAS to authenticate access to the container:</span></span> 

```csharp
new CloudTask(taskId, "cmd /v:ON /c \"echo off && set && (FOR /L %i IN (1,1,100000) DO (ECHO !RANDOM!)) > output.txt\"")
{
    OutputFiles = new List<OutputFile>
    {
        new OutputFile(
            filePattern: @"..\std*.txt",
            destination: new OutputFileDestination(
         new OutputFileBlobContainerDestination(
                    containerUrl: containerSasUrl,
                    path: taskId)),
            uploadOptions: new OutputFileUploadOptions(
            uploadCondition: OutputFileUploadCondition.TaskCompletion)),
        new OutputFile(
            filePattern: @"output.txt",
            destination: 
         new OutputFileDestination(new OutputFileBlobContainerDestination(
                    containerUrl: containerSasUrl,
                    path: taskId + @"\output.txt")),
            uploadOptions: new OutputFileUploadOptions(
            uploadCondition: OutputFileUploadCondition.TaskCompletion)),
}
```

### <a name="specify-a-file-pattern-for-matching"></a><span data-ttu-id="0975e-146">Spécifier un modèle de fichier pour la correspondance</span><span class="sxs-lookup"><span data-stu-id="0975e-146">Specify a file pattern for matching</span></span>

<span data-ttu-id="0975e-147">Quand vous spécifiez un fichier de sortie, vous pouvez utiliser la propriété [OutputFile.FilePattern](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile.filepattern#Microsoft_Azure_Batch_OutputFile_FilePattern) pour spécifier un modèle de fichier pour la correspondance.</span><span class="sxs-lookup"><span data-stu-id="0975e-147">When you specify an output file, you can use the [OutputFile.FilePattern](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile.filepattern#Microsoft_Azure_Batch_OutputFile_FilePattern) property to specify a file pattern for matching.</span></span> <span data-ttu-id="0975e-148">Le modèle de fichier peut faire correspondre zéro fichier, un seul fichier ou un ensemble de fichiers créés par la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-148">The file pattern may match zero files, a single file, or a set of files that are created by the task.</span></span>

<span data-ttu-id="0975e-149">La propriété **FilePattern** prend en charge les caractères génériques de système de fichiers standard tels que `*` (pour les correspondances non récursives) et `**` (pour les correspondances récursives).</span><span class="sxs-lookup"><span data-stu-id="0975e-149">The **FilePattern** property supports standard filesystem wildcards such as `*` (for non-recursive matches) and `**` (for recursive matches).</span></span> <span data-ttu-id="0975e-150">Par exemple, l’exemple de code ci-dessus spécifie le modèle de fichier pour établir une mise en correspondance avec `std*.txt` de manière non récursive :</span><span class="sxs-lookup"><span data-stu-id="0975e-150">For example, the code sample above specifies the file pattern to match `std*.txt` non-recursively:</span></span> 

`filePattern: @"..\std*.txt"`

<span data-ttu-id="0975e-151">Pour charger un seul fichier, spécifiez un modèle de fichier sans caractère générique.</span><span class="sxs-lookup"><span data-stu-id="0975e-151">To upload a single file, specify a file pattern with no wildcards.</span></span> <span data-ttu-id="0975e-152">Par exemple, l’exemple de code ci-dessus spécifie le modèle de fichier pour établir une mise en correspondance avec `output.txt` :</span><span class="sxs-lookup"><span data-stu-id="0975e-152">For example, the code sample above specifies the file pattern to match `output.txt`:</span></span>

`filePattern: @"output.txt"`

### <a name="specify-an-upload-condition"></a><span data-ttu-id="0975e-153">Spécifier une condition de chargement</span><span class="sxs-lookup"><span data-stu-id="0975e-153">Specify an upload condition</span></span>

<span data-ttu-id="0975e-154">La propriété [OutputFileUploadOptions.UploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileuploadoptions.uploadcondition#Microsoft_Azure_Batch_OutputFileUploadOptions_UploadCondition) autorise le chargement conditionnel des fichiers de sortie.</span><span class="sxs-lookup"><span data-stu-id="0975e-154">The [OutputFileUploadOptions.UploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileuploadoptions.uploadcondition#Microsoft_Azure_Batch_OutputFileUploadOptions_UploadCondition) property permits conditional uploading of output files.</span></span> <span data-ttu-id="0975e-155">Un scénario courant consiste à charger un ensemble de fichiers si la tâche réussit, et un autre ensemble de fichiers en cas d’échec.</span><span class="sxs-lookup"><span data-stu-id="0975e-155">A common scenario is to upload one set of files if the task succeeds, and a different set of files if it fails.</span></span> <span data-ttu-id="0975e-156">Par exemple, vous pourriez souhaiter charger des fichiers journaux détaillés uniquement quand la tâche échoue et se termine avec un code de sortie différent de zéro.</span><span class="sxs-lookup"><span data-stu-id="0975e-156">For example, you may want to upload verbose log files only when the task fails and exits with a nonzero exit code.</span></span> <span data-ttu-id="0975e-157">De même, vous pourriez souhaiter charger des fichiers de résultats uniquement si la tâche réussit, car ces fichiers pourraient être manquants ou incomplets si la tâche échoue.</span><span class="sxs-lookup"><span data-stu-id="0975e-157">Similarly, you may want to upload result files only if the task succeeds, as those files may be missing or incomplete if the task fails.</span></span>

<span data-ttu-id="0975e-158">L’exemple de code ci-dessus affecte la valeur **TaskCompletion** à la propriété **UploadCondition**.</span><span class="sxs-lookup"><span data-stu-id="0975e-158">The code sample above sets the **UploadCondition** property to **TaskCompletion**.</span></span> <span data-ttu-id="0975e-159">Ce paramètre spécifie que le fichier doit être chargé une fois la tâche terminée, quelle que soit la valeur du code de sortie.</span><span class="sxs-lookup"><span data-stu-id="0975e-159">This setting specifies that the file is to be uploaded after the tasks completes, regardless of the value of the exit code.</span></span> 

`uploadCondition: OutputFileUploadCondition.TaskCompletion`

<span data-ttu-id="0975e-160">Pour plus d’informations sur les autres paramètres, consultez l’énumération [OutputFileUploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.outputfileuploadcondition).</span><span class="sxs-lookup"><span data-stu-id="0975e-160">For other settings, see the [OutputFileUploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.outputfileuploadcondition) enum.</span></span>

### <a name="disambiguate-files-with-the-same-name"></a><span data-ttu-id="0975e-161">Lever l’ambiguïté des fichiers portant le même nom</span><span class="sxs-lookup"><span data-stu-id="0975e-161">Disambiguate files with the same name</span></span>

<span data-ttu-id="0975e-162">Les tâches d’un travail peuvent générer des fichiers ayant le même nom.</span><span class="sxs-lookup"><span data-stu-id="0975e-162">The tasks in a job may produce files that have the same name.</span></span> <span data-ttu-id="0975e-163">Par exemple, `stdout.txt` et `stderr.txt` sont créés pour chaque tâche qui s’exécute dans un travail.</span><span class="sxs-lookup"><span data-stu-id="0975e-163">For example, `stdout.txt` and `stderr.txt` are created for every task that runs in a job.</span></span> <span data-ttu-id="0975e-164">Étant donné que chaque tâche s’exécute dans son propre contexte, ces fichiers ne sont pas en conflit sur le système de fichiers du nœud.</span><span class="sxs-lookup"><span data-stu-id="0975e-164">Because each task runs in its own context, these files don't conflict on the node's file system.</span></span> <span data-ttu-id="0975e-165">Toutefois, quand vous chargez des fichiers à partir de plusieurs tâches vers un conteneur partagé, vous devez lever l’ambiguïté des fichiers portant le même nom.</span><span class="sxs-lookup"><span data-stu-id="0975e-165">However, when you upload files from multiple tasks to a shared container, you'll need to disambiguate files with the same name.</span></span>

<span data-ttu-id="0975e-166">La propriété [OutputFileBlobContainerDestination.Path](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination.path#Microsoft_Azure_Batch_OutputFileBlobContainerDestination_Path) spécifie l’objet blob ou le répertoire virtuel de destination pour les fichiers de sortie.</span><span class="sxs-lookup"><span data-stu-id="0975e-166">The [OutputFileBlobContainerDestination.Path](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination.path#Microsoft_Azure_Batch_OutputFileBlobContainerDestination_Path) property specifies the destination blob or virtual directory for output files.</span></span> <span data-ttu-id="0975e-167">Vous pouvez utiliser la propriété **Path** pour nommer l’objet blob ou le répertoire virtuel de telle sorte que les fichiers de sortie portant le même nom soient nommés de manière unique dans le stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="0975e-167">You can use the **Path** property to name the blob or virtual directory in such a way that output files with the same name are uniquely named in Azure Storage.</span></span> <span data-ttu-id="0975e-168">L’utilisation de l’ID de tâche dans le chemin est un bon moyen de garantir le caractère unique des noms et de faciliter l’identification des fichiers.</span><span class="sxs-lookup"><span data-stu-id="0975e-168">Using the task ID in the path is a good way to ensure unique names and easily identify files.</span></span>

<span data-ttu-id="0975e-169">Si la propriété **FilePattern** a comme valeur une expression générique, tous les fichiers qui correspondent au modèle sont chargés vers le répertoire virtuel spécifié par la propriété **Path**.</span><span class="sxs-lookup"><span data-stu-id="0975e-169">If the **FilePattern** property is set to a wildcard expression, then all files that match the pattern are uploaded to the virtual directory specified by the **Path** property.</span></span> <span data-ttu-id="0975e-170">Par exemple, si le conteneur est `mycontainer`, l’ID de tâche est `mytask` et le modèle de fichier est `..\std*.txt`, les URI absolus des fichiers de sortie dans le stockage Azure ressembleront à ceci :</span><span class="sxs-lookup"><span data-stu-id="0975e-170">For example, if the container is `mycontainer`, the task ID is `mytask`, and the file pattern is `..\std*.txt`, then the absolute URIs to the output files in Azure Storage will be similar to:</span></span>

```
https://myaccount.blob.core.windows.net/mycontainer/mytask/stderr.txt
https://myaccount.blob.core.windows.net/mycontainer/mytask/stdout.txt
```

<span data-ttu-id="0975e-171">Si la propriété **FilePattern** est définie pour établir une correspondance avec un seul nom de fichier, autrement dit si elle ne contient pas de caractère générique, alors la valeur de la propriété **Path** spécifie le nom de l’objet blob complet.</span><span class="sxs-lookup"><span data-stu-id="0975e-171">If the **FilePattern** property is set to match a single file name, meaning it does not contain any wildcard characters, then the value of the **Path** property specifies the fully qualified blob name.</span></span> <span data-ttu-id="0975e-172">Si vous prévoyez des conflits d’affectation de noms avec un même fichier de plusieurs tâches, incluez le nom du répertoire virtuel dans le cadre du nom de fichier pour lever l’ambiguïté de ces fichiers.</span><span class="sxs-lookup"><span data-stu-id="0975e-172">If you anticipate naming conflicts with a single file from multiple tasks, then include the name of the virtual directory as part of the file name to disambiguate those files.</span></span> <span data-ttu-id="0975e-173">Par exemple, définissez la propriété **Path** pour qu’elle inclue l’ID de tâche, le caractère délimiteur (en général une barre oblique) et le nom de fichier :</span><span class="sxs-lookup"><span data-stu-id="0975e-173">For example, set the **Path** property to include the task ID, the delimiter character (typically a forward slash), and the file name:</span></span>

`path: taskId + @"/output.txt"`

<span data-ttu-id="0975e-174">Les URI absolus des fichiers de sortie pour un ensemble de tâches ressembleront à ceci :</span><span class="sxs-lookup"><span data-stu-id="0975e-174">The absolute URIs to the output files for a set of tasks will be similar to:</span></span>

```
https://myaccount.blob.core.windows.net/mycontainer/task1/output.txt
https://myaccount.blob.core.windows.net/mycontainer/task2/output.txt
```

<span data-ttu-id="0975e-175">Pour plus d’informations sur les répertoires virtuels dans le stockage Azure, consultez [Création d’une liste d’objets blob dans un conteneur](../storage/blobs/storage-dotnet-how-to-use-blobs.md#list-the-blobs-in-a-container).</span><span class="sxs-lookup"><span data-stu-id="0975e-175">For more information about virtual directories in Azure Storage, see [List the blobs in a container](../storage/blobs/storage-dotnet-how-to-use-blobs.md#list-the-blobs-in-a-container).</span></span>


## <a name="diagnose-file-upload-errors"></a><span data-ttu-id="0975e-176">Diagnostiquer les erreurs de chargement de fichier</span><span class="sxs-lookup"><span data-stu-id="0975e-176">Diagnose file upload errors</span></span>

<span data-ttu-id="0975e-177">Si le chargement des fichiers de sortie dans le stockage Azure échoue, la tâche bascule à l’état **Terminée** et la propriété [TaskExecutionInformation.FailureInformation](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskexecutioninformation.failureinformation#Microsoft_Azure_Batch_TaskExecutionInformation_FailureInformation) est définie.</span><span class="sxs-lookup"><span data-stu-id="0975e-177">If uploading output files to Azure Storage fails, then the task moves to the **Completed** state and the [TaskExecutionInformation.FailureInformation](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskexecutioninformation.failureinformation#Microsoft_Azure_Batch_TaskExecutionInformation_FailureInformation) property is set.</span></span> <span data-ttu-id="0975e-178">Examinez la propriété **FailureInformation** pour identifier l’erreur qui s’est produite.</span><span class="sxs-lookup"><span data-stu-id="0975e-178">Examine the **FailureInformation** property to determine what error occurred.</span></span> <span data-ttu-id="0975e-179">Voici par exemple une erreur qui se produit lors du chargement de fichier si le conteneur est introuvable :</span><span class="sxs-lookup"><span data-stu-id="0975e-179">For example, here is an error that occurs on file upload if the container cannot be found:</span></span> 

```
Category: UserError
Code: FileUploadContainerNotFound
Message: One of the specified Azure container(s) was not found while attempting to upload an output file
```

<span data-ttu-id="0975e-180">À chaque chargement de fichier, Batch écrit deux fichiers journaux dans le nœud de calcul, `fileuploadout.txt` et `fileuploaderr.txt`.</span><span class="sxs-lookup"><span data-stu-id="0975e-180">On every file upload, Batch writes two log files to the compute node, `fileuploadout.txt` and `fileuploaderr.txt`.</span></span> <span data-ttu-id="0975e-181">Vous pouvez examiner ces fichiers journaux pour en savoir plus sur un échec spécifique.</span><span class="sxs-lookup"><span data-stu-id="0975e-181">You can examine these log files to learn more about a specific failure.</span></span> <span data-ttu-id="0975e-182">Dans le cas où le chargement de fichier n’a jamais été tenté, par exemple car la tâche proprement dite n’a pas pu être exécutée, ces fichiers journaux n’existent pas.</span><span class="sxs-lookup"><span data-stu-id="0975e-182">In cases where the file upload was never attempted, for example because the task itself couldn’t run, then these log files will not exist.</span></span>

## <a name="diagnose-file-upload-performance"></a><span data-ttu-id="0975e-183">Diagnostiquer les performances de chargement de fichier</span><span class="sxs-lookup"><span data-stu-id="0975e-183">Diagnose file upload performance</span></span>

<span data-ttu-id="0975e-184">Le fichier `fileuploadout.txt` contient la progression du chargement.</span><span class="sxs-lookup"><span data-stu-id="0975e-184">The `fileuploadout.txt` file logs upload progress.</span></span> <span data-ttu-id="0975e-185">Vous pouvez examiner ce fichier pour en savoir plus sur la durée nécessaire au chargement de vos fichiers.</span><span class="sxs-lookup"><span data-stu-id="0975e-185">You can examine this file to learn more about how long your file uploads are taking.</span></span> <span data-ttu-id="0975e-186">N’oubliez pas que de nombreux facteurs contribuent aux performances de chargement, notamment la taille du nœud, les autres activités sur le nœud au moment du chargement, si le conteneur cible est dans la même région que le pool Batch, le nombre de nœuds qui effectuent des chargements en même temps vers le compte de stockage, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="0975e-186">Keep in mind that there are many contributing factors to upload performance, including the size of the node, other activity on the node at the time of the upload, whether the target container is in the same region as the Batch pool, how many nodes are uploading to the storage account at the same time, and so on.</span></span>

## <a name="use-the-batch-service-api-with-the-batch-file-conventions-standard"></a><span data-ttu-id="0975e-187">Utiliser l’API de service Batch avec la norme relative aux Conventions applicables aux fichiers Batch</span><span class="sxs-lookup"><span data-stu-id="0975e-187">Use the Batch service API with the Batch File Conventions standard</span></span>

<span data-ttu-id="0975e-188">Quand vous conservez le résultat de la tâche avec l’API de service Batch, vous pouvez nommer votre conteneur de destination et les objets blob comme vous le souhaitez.</span><span class="sxs-lookup"><span data-stu-id="0975e-188">When you persist task output with the Batch service API, you can name your destination container and blobs however you like.</span></span> <span data-ttu-id="0975e-189">Vous pouvez également choisir de les nommer en respectant la [norme relative aux Conventions applicables aux fichiers Batch](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span><span class="sxs-lookup"><span data-stu-id="0975e-189">You can also choose to name them according to the [Batch File Conventions standard](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span></span> <span data-ttu-id="0975e-190">Cette norme détermine les noms du conteneur de destination et de l’objet blob dans le stockage Azure pour un fichier de sortie donnée en fonction des noms du projet et de la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-190">The File Conventions standard determines the names of the destination container and blob in Azure Storage for a given output file based on the names of the job and task.</span></span> <span data-ttu-id="0975e-191">Si vous utilisez cette norme pour nommer les fichiers de sortie, vos fichiers de sortie sont visibles dans le [portail Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="0975e-191">If you do use the File Conventions standard for naming output files, then your output files are available for viewing in the [Azure portal](https://portal.azure.com).</span></span>

<span data-ttu-id="0975e-192">Si vous développez en C#, vous pouvez utiliser les méthodes intégrées à la [bibliothèque Conventions applicables aux fichiers Batch pour .NET](https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files).</span><span class="sxs-lookup"><span data-stu-id="0975e-192">If you are developing in C#, you can use the methods built into the [Batch File Conventions library for .NET](https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files).</span></span> <span data-ttu-id="0975e-193">Cette bibliothèque crée les chemins de conteneurs et d’objets blob pour vous avec des noms corrects.</span><span class="sxs-lookup"><span data-stu-id="0975e-193">This library creates the properly named containers and blob paths for you.</span></span> <span data-ttu-id="0975e-194">Par exemple, vous pouvez appeler l’API pour obtenir le nom correct pour le conteneur, en fonction du nom du travail :</span><span class="sxs-lookup"><span data-stu-id="0975e-194">For example, you can call the API to get the correct name for the container, based on the job name:</span></span>

```csharp
string containerName = job.OutputStorageContainerName();
```

<span data-ttu-id="0975e-195">Vous pouvez utiliser la méthode [CloudJobExtensions.GetOutputStorageContainerUrl](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.conventions.files.cloudjobextensions.getoutputstoragecontainerurl) pour retourner une URL de signature d’accès partagé utilisée pour écrire dans le conteneur.</span><span class="sxs-lookup"><span data-stu-id="0975e-195">You can use the [CloudJobExtensions.GetOutputStorageContainerUrl](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.conventions.files.cloudjobextensions.getoutputstoragecontainerurl) method to return a shared access signature (SAS) URL that is used to write to the container.</span></span> <span data-ttu-id="0975e-196">Vous pouvez ensuite passer cette signature d’accès partagé au constructeur [OutputFileBlobContainerDestination](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination).</span><span class="sxs-lookup"><span data-stu-id="0975e-196">You can then pass this SAS to the [OutputFileBlobContainerDestination](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination) constructor.</span></span>

<span data-ttu-id="0975e-197">Si vous développez dans un langage autre que C#, vous devez implémenter la norme relative aux Conventions de fichiers vous-même.</span><span class="sxs-lookup"><span data-stu-id="0975e-197">If you are developing in a language other than C#, you will need to implement the File Conventions standard yourself.</span></span>

## <a name="code-sample"></a><span data-ttu-id="0975e-198">Exemple de code</span><span class="sxs-lookup"><span data-stu-id="0975e-198">Code sample</span></span>

<span data-ttu-id="0975e-199">L’exemple de projet [PersistOutputs][github_persistoutputs] est l’un des [exemples de code Azure Batch][github_samples] disponibles sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="0975e-199">The [PersistOutputs][github_persistoutputs] sample project is one of the [Azure Batch code samples][github_samples] on GitHub.</span></span> <span data-ttu-id="0975e-200">Cette solution Visual Studio montre comment utiliser la bibliothèque cliente Batch pour .NET pour conserver le résultat de la tâche dans l’espace de stockage durable.</span><span class="sxs-lookup"><span data-stu-id="0975e-200">This Visual Studio solution demonstrates how to use the Batch client library for .NET to persist task output to durable storage.</span></span> <span data-ttu-id="0975e-201">Pour exécuter l’exemple, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="0975e-201">To run the sample, follow these steps:</span></span>

1. <span data-ttu-id="0975e-202">Ouvrez le projet dans **Visual Studio 2015 ou version ultérieure**.</span><span class="sxs-lookup"><span data-stu-id="0975e-202">Open the project in **Visual Studio 2015 or newer**.</span></span>
2. <span data-ttu-id="0975e-203">Ajoutez vos **informations d’identification de compte** Batch et Stockage à **AccountSettings.settings** dans le projet Microsoft.Azure.Batch.Samples.Common.</span><span class="sxs-lookup"><span data-stu-id="0975e-203">Add your Batch and Storage **account credentials** to **AccountSettings.settings** in the Microsoft.Azure.Batch.Samples.Common project.</span></span>
3. <span data-ttu-id="0975e-204">**Générez** la solution sans l’exécuter.</span><span class="sxs-lookup"><span data-stu-id="0975e-204">**Build** (but do not run) the solution.</span></span> <span data-ttu-id="0975e-205">Restaurez les packages NuGet si vous y êtes invité.</span><span class="sxs-lookup"><span data-stu-id="0975e-205">Restore any NuGet packages if prompted.</span></span>
4. <span data-ttu-id="0975e-206">Utilisez le portail Azure pour charger un [package d’application](batch-application-packages.md) pour **PersistOutputsTask**.</span><span class="sxs-lookup"><span data-stu-id="0975e-206">Use the Azure portal to upload an [application package](batch-application-packages.md) for **PersistOutputsTask**.</span></span> <span data-ttu-id="0975e-207">Insérez le fichier `PersistOutputsTask.exe` et ses assemblys dépendants dans le package .zip, puis définissez l’ID de l’application sur PersistOutputsTask et la version du package d’application sur 1.0.</span><span class="sxs-lookup"><span data-stu-id="0975e-207">Include the `PersistOutputsTask.exe` and its dependent assemblies in the .zip package, set the application ID to "PersistOutputsTask", and the application package version to "1.0".</span></span>
5. <span data-ttu-id="0975e-208">**Démarrez** (exécutez) le projet **PersistOutputs**.</span><span class="sxs-lookup"><span data-stu-id="0975e-208">**Start** (run) the **PersistOutputs** project.</span></span>
6. <span data-ttu-id="0975e-209">Quand vous êtes invité à choisir la technologie de persistance à utiliser pour l’exécution de l’exemple, entrez **2** pour exécuter l’exemple à l’aide de l’API de service Batch pour conserver le résultat de la tâche.</span><span class="sxs-lookup"><span data-stu-id="0975e-209">When prompted to choose the persistence technology to use for running the sample, enter **2** to run the sample using the Batch service API to persist task output.</span></span>
7. <span data-ttu-id="0975e-210">Si vous le souhaitez, réexécutez l’exemple, entrez **3** pour conserver la sortie avec l’API de service Batch et également nommer le chemin d’objet blob et de conteneur de destination conformément à la norme relative aux Conventions de fichiers.</span><span class="sxs-lookup"><span data-stu-id="0975e-210">If desired, run the sample again, entering **3** to persist output with the Batch service API, and also to name the destination container and blob path according to the File Conventions standard.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0975e-211">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="0975e-211">Next steps</span></span>

- <span data-ttu-id="0975e-212">Pour plus d’informations sur la persistance du résultat de la tâche avec la bibliothèque Conventions applicables aux fichiers pour .NET, consultez [Persist job and task data to Azure Storage with the Batch File Conventions library for .NET to persist (Conserver les données de travail et de tâche dans le stockage Azure avec la bibliothèque Conventions applicables aux fichiers Batch pour .NET pour la persistance)](batch-task-output-file-conventions.md).</span><span class="sxs-lookup"><span data-stu-id="0975e-212">For more information on persisting task output with the File Conventions library for .NET, see [Persist job and task data to Azure Storage with the Batch File Conventions library for .NET to persist ](batch-task-output-file-conventions.md).</span></span>
- <span data-ttu-id="0975e-213">Pour plus d’informations sur d’autres approches de persistance des données de sortie dans Azure Batch, consultez [Conserver les résultats de travaux et tâches terminés dans le stockage Azure](batch-task-output.md).</span><span class="sxs-lookup"><span data-stu-id="0975e-213">For information on other approaches for persisting output data in Azure Batch, see [Persist job and task output to Azure Storage](batch-task-output.md).</span></span>

[github_persistoutputs]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/PersistOutputs
[github_samples]: https://github.com/Azure/azure-batch-samples
