---
title: "Optimiser le routage ExpressRoute : Azure | Microsoft Docs"
description: "Cette page fournit des détails sur l’optimisation du routage lorsque vous avez le choix entre plusieurs circuits ExpressRoute de connexion entre Microsoft et votre réseau professionnel."
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: c3a85b9445d69330c3f6c7d298169efddb6ecca0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="e21da-103">Optimiser le routage ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="e21da-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="e21da-104">En présence de plusieurs circuits ExpressRoute, vous pouvez vous connecter à Microsoft par le biais de plusieurs chemins d’accès.</span><span class="sxs-lookup"><span data-stu-id="e21da-104">When you have multiple ExpressRoute circuits, you have more than one path to connect to Microsoft.</span></span> <span data-ttu-id="e21da-105">Par conséquent, le routage pourrait ne pas être optimal. Autrement dit, votre trafic peut emprunter un chemin d’accès plus long pour atteindre Microsoft ; Microsoft peut faire de même pour atteindre votre réseau.</span><span class="sxs-lookup"><span data-stu-id="e21da-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path to reach Microsoft, and Microsoft to your network.</span></span> <span data-ttu-id="e21da-106">Plus le chemin d’accès réseau est long, plus la latence est élevée.</span><span class="sxs-lookup"><span data-stu-id="e21da-106">The longer the network path, the higher the latency.</span></span> <span data-ttu-id="e21da-107">La latence a un impact direct sur les performances d’application ainsi que sur l’expérience utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e21da-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="e21da-108">Cet article aborde ce problème et explique comment optimiser le routage à l’aide des technologies de routage standard.</span><span class="sxs-lookup"><span data-stu-id="e21da-108">This article will illustrate this problem and explain how to optimize routing using the standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-to-microsoft"></a><span data-ttu-id="e21da-109">Routage non optimal entre le client et Microsoft</span><span class="sxs-lookup"><span data-stu-id="e21da-109">Suboptimal routing from customer to Microsoft</span></span>
<span data-ttu-id="e21da-110">Voici un exemple de problème de routage.</span><span class="sxs-lookup"><span data-stu-id="e21da-110">Let's take a close look at the routing problem by an example.</span></span> <span data-ttu-id="e21da-111">Imaginez que vous disposez de deux bureaux aux États-Unis, un à Los Angeles et un à New York.</span><span class="sxs-lookup"><span data-stu-id="e21da-111">Imagine you have two offices in the US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="e21da-112">Vos bureaux sont connectés sur un réseau étendu (WAN), qui peut être votre propre réseau principal ou le VPN IP de votre fournisseur de services.</span><span class="sxs-lookup"><span data-stu-id="e21da-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="e21da-113">Vous avez deux circuits ExpressRoute également connectés sur le réseau étendu, l’un dans l’Ouest des États-Unis et l’autre dans l’Est.</span><span class="sxs-lookup"><span data-stu-id="e21da-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on the WAN.</span></span> <span data-ttu-id="e21da-114">Vous avez bien évidemment deux chemins d’accès pour vous connecter au réseau Microsoft.</span><span class="sxs-lookup"><span data-stu-id="e21da-114">Obviously, you have two paths to connect to the Microsoft network.</span></span> <span data-ttu-id="e21da-115">Imaginez à présent que vous déployiez un service Azure (par exemple, Azure App Service) dans l’Ouest et dans l’Est des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="e21da-116">Vous avez pour objectif de connecter vos utilisateurs de Los Angeles à Azure dans l’Ouest des États-Unis et les utilisateurs de New York à Azure dans l’Est des États-Unis, car selon votre administrateur de service, les utilisateurs de chaque bureau doivent accéder aux services Azure les plus proches pour une expérience optimale.</span><span class="sxs-lookup"><span data-stu-id="e21da-116">Your intention is to connect your users in Los Angeles to Azure US West and your users in New York to Azure US East because your service admin advertises that users in each office access the nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="e21da-117">Malheureusement, le plan fonctionne bien pour les utilisateurs de la côte Est, mais pas pour ceux de la côte Ouest.</span><span class="sxs-lookup"><span data-stu-id="e21da-117">Unfortunately, the plan works out well for the east coast users but not for the west coast users.</span></span> <span data-ttu-id="e21da-118">La cause du problème est la suivante.</span><span class="sxs-lookup"><span data-stu-id="e21da-118">The cause of the problem is the following.</span></span> <span data-ttu-id="e21da-119">Sur chaque circuit ExpressRoute, nous publions le préfixe pour Azure dans l’Est des États-Unis (23.100.0.0/16) et dans l’Ouest des États-Unis (13.100.0.0/16).</span><span class="sxs-lookup"><span data-stu-id="e21da-119">On each ExpressRoute circuit, we advertise to you both the prefix in Azure US East (23.100.0.0/16) and the prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="e21da-120">Si vous ne savez pas à quelle région correspond chaque préfixe, vous ne pourrez pas le traiter différemment.</span><span class="sxs-lookup"><span data-stu-id="e21da-120">If you don't know which prefix is from which region, you are not able to treat it differently.</span></span> <span data-ttu-id="e21da-121">Votre réseau WAN peut penser que les deux préfixes sont plus proches de l’Est que de l’Ouest des États-Unis et donc router les utilisateurs des deux bureaux vers le circuit ExpressRoute dans l’Est des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-121">Your WAN network may think both of the prefixes are closer to US East than US West and therefore route both office users to the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="e21da-122">Au final, vous risquez d’avoir des utilisateurs mécontents dans vos bureaux de Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="e21da-122">In the end, you will have many unhappy users in the Los Angeles office.</span></span>

![Scénario ExpressRoute n° 1 : routage non optimal entre le client et Microsoft](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="e21da-124">Solution : utilisez des communautés BGP</span><span class="sxs-lookup"><span data-stu-id="e21da-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="e21da-125">Pour optimiser le routage pour les utilisateurs des deux bureaux, vous devez savoir faire la différence entre le préfixe Azure de l’Est et le préfixe Azure de l’Ouest.</span><span class="sxs-lookup"><span data-stu-id="e21da-125">To optimize routing for both office users, you need to know which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="e21da-126">Nous encodons ces informations à l’aide des [valeurs de communauté BGP](expressroute-routing.md).</span><span class="sxs-lookup"><span data-stu-id="e21da-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="e21da-127">Nous avons affecté une valeur de Communauté BGP unique à chaque région Azure, par exemple : « 12076:51004 » pour l’Est des États-Unis et « 12076:51006 » pour l’Ouest des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-127">We've assigned a unique BGP Community value to each Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="e21da-128">À présent que vous savez à quelles régions Azure correspondent les préfixes, vous pouvez configurer les préférences de circuit ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="e21da-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="e21da-129">Étant donné que nous utilisons le protocole BGP pour échanger des informations de routage, vous pouvez utiliser les préférences locales du protocole BGP pour influencer le routage.</span><span class="sxs-lookup"><span data-stu-id="e21da-129">Because we use the BGP to exchange routing info, you can use BGP's Local Preference to influence routing.</span></span> <span data-ttu-id="e21da-130">Dans notre exemple, vous pouvez affecter, dans l’Ouest des États-Unis, une valeur de préférence locale supérieure à celle de l’Est des États-Unis (13.100.0.0/16) et vice-versa dans l’Est des États-Unis (23.100.0.0/16).</span><span class="sxs-lookup"><span data-stu-id="e21da-130">In our example, you can assign a higher local preference value to 13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value to 23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="e21da-131">Cette configuration permet de garantir que, lorsque les deux chemins d’accès à Microsoft sont disponibles, vos utilisateurs de Los Angeles prendront le circuit ExpressRoute dans l’Ouest des États-Unis pour se connecter à Azure dans cette région, tandis que vos utilisateurs de New York prendront le circuit ExpressRoute de l’Est des États-Unis vers Azure dans cette région.</span><span class="sxs-lookup"><span data-stu-id="e21da-131">This configuration will make sure that, when both paths to Microsoft are available, your users in Los Angeles will take the ExpressRoute circuit in US West to connect to Azure US West whereas your users in New York take the ExpressRoute in US East to Azure US East.</span></span> <span data-ttu-id="e21da-132">Le routage est optimisé des deux côtés.</span><span class="sxs-lookup"><span data-stu-id="e21da-132">Routing is optimized on both sides.</span></span> 

![Solution ExpressRoute n° 1 : utilisez des communautés BGP](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="e21da-134">La même technique peut être appliquée pour le routage entre le client et le réseau virtuel Azure, en utilisant les préférences locales.</span><span class="sxs-lookup"><span data-stu-id="e21da-134">The same technique, using Local Preference, can be applied to routing from customer to Azure Virtual Network.</span></span> <span data-ttu-id="e21da-135">Nous ne balisons pas la valeur de communauté BGP sur les préfixes publiés à partir d’Azure sur votre réseau.</span><span class="sxs-lookup"><span data-stu-id="e21da-135">We don't tag BGP Community value to the prefixes advertised from Azure to your network.</span></span> <span data-ttu-id="e21da-136">Toutefois, étant donné que vous savez à quel déploiement de réseau virtuel correspond quel bureau, vous pouvez configurer vos routeurs en conséquence pour privilégier un circuit ExpressRoute plutôt qu’un autre.</span><span class="sxs-lookup"><span data-stu-id="e21da-136">However, since you know which of your Virtual Network deployment is close to which of your office, you can configure your routers accordingly to prefer one ExpressRoute circuit to another.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a><span data-ttu-id="e21da-137">Routage non optimal entre Microsoft et le client</span><span class="sxs-lookup"><span data-stu-id="e21da-137">Suboptimal routing from Microsoft to customer</span></span>
<span data-ttu-id="e21da-138">Voici un autre exemple dans lequel les connexions en provenance de Microsoft prennent un chemin plus long pour atteindre votre réseau.</span><span class="sxs-lookup"><span data-stu-id="e21da-138">Here is another example where connections from Microsoft take a longer path to reach your network.</span></span> <span data-ttu-id="e21da-139">Dans ce cas, vous utilisez des serveurs Exchange locaux et Exchange Online dans un [environnement hybride](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="e21da-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="e21da-140">Vos bureaux sont connectés à un réseau étendu.</span><span class="sxs-lookup"><span data-stu-id="e21da-140">Your offices are connected to a WAN.</span></span> <span data-ttu-id="e21da-141">Vous publiez vers Microsoft les préfixes des serveurs locaux de vos deux bureaux par le biais des deux circuits ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="e21da-141">You advertise the prefixes of your on-premises servers in both of your offices to Microsoft through the two ExpressRoute circuits.</span></span> <span data-ttu-id="e21da-142">Dans certains cas, tels que la migration de boîte aux lettres, Exchange Online lance les connexions aux serveurs locaux.</span><span class="sxs-lookup"><span data-stu-id="e21da-142">Exchange Online will initiate connections to the on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="e21da-143">Malheureusement, la connexion à votre bureau de Los Angeles est routée au circuit ExpressRoute de l’Est des États-Unis, puis retraverse l’ensemble du pays avant d’atteindre la côte ouest.</span><span class="sxs-lookup"><span data-stu-id="e21da-143">Unfortunately, the connection to your Los Angeles office is routed to the ExpressRoute circuit in US East before traversing the entire continent back to the west coast.</span></span> <span data-ttu-id="e21da-144">L’origine du problème est similaire au premier cas.</span><span class="sxs-lookup"><span data-stu-id="e21da-144">The cause of the problem is similar to the first one.</span></span> <span data-ttu-id="e21da-145">En l’absence d’indicateur, le réseau Microsoft ne peut pas déterminer quel préfixe est le plus proche de la côte Ouest et de la côte Est.</span><span class="sxs-lookup"><span data-stu-id="e21da-145">Without any hint, the Microsoft network can't tell which customer prefix is close to US East and which one is close to US West.</span></span> <span data-ttu-id="e21da-146">Malheureusement, il choisit le mauvais chemin vers votre bureau de Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="e21da-146">It happens to pick the wrong path to your office in Los Angeles.</span></span>

![Scénario ExpressRoute n° 2 : routage non optimal entre Microsoft et le client](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="e21da-148">Solution : ajoutez le préfixe AS PATH</span><span class="sxs-lookup"><span data-stu-id="e21da-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="e21da-149">Il existe deux solutions à ce problème.</span><span class="sxs-lookup"><span data-stu-id="e21da-149">There are two solutions to the problem.</span></span> <span data-ttu-id="e21da-150">La première consiste simplement à publier votre préfixe local pour le bureau de Los Angeles (177.2.0.0/31) sur le circuit ExpressRoute dans l’Ouest des États-Unis et celui pour le bureau de New York (177.2.0.2/31) sur le circuit ExpressRoute dans l’Est des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-150">The first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on the ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="e21da-151">Par conséquent, Microsoft ne dispose que d’un seul chemin d’accès pour se connecter à chacun de vos sites.</span><span class="sxs-lookup"><span data-stu-id="e21da-151">As a result, there is only one path for Microsoft to connect to each of your offices.</span></span> <span data-ttu-id="e21da-152">Il n’existe aucune ambiguïté et le routage est optimisé.</span><span class="sxs-lookup"><span data-stu-id="e21da-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="e21da-153">Avec cette conception, vous devez réfléchir à votre stratégie de basculement.</span><span class="sxs-lookup"><span data-stu-id="e21da-153">With this design, you need to think about your failover strategy.</span></span> <span data-ttu-id="e21da-154">Dans le cas où le chemin d’accès à Microsoft via ExpressRoute est interrompu, vous devez vous assurer qu’Exchange Online peut toujours se connecter à vos serveurs locaux.</span><span class="sxs-lookup"><span data-stu-id="e21da-154">In the event that the path to Microsoft via ExpressRoute is broken, you need to make sure that Exchange Online can still connect to your on-premises servers.</span></span> 

<span data-ttu-id="e21da-155">La deuxième solution est de continuer à publier les deux préfixes sur les deux circuits ExpressRoute, tout en nous indiquant quel préfixe correspond à chacun de vos bureaux.</span><span class="sxs-lookup"><span data-stu-id="e21da-155">The second solution is that you continue to advertise both of the prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close to which one of your offices.</span></span> <span data-ttu-id="e21da-156">Étant donné que nous prenons en charge l’ajout de préfixe AS PATH BGP, vous pouvez configurer l’AS PATH pour influencer le routage.</span><span class="sxs-lookup"><span data-stu-id="e21da-156">Because we support BGP AS Path prepending, you can configure the AS Path for your prefix to influence routing.</span></span> <span data-ttu-id="e21da-157">Dans cet exemple, vous pouvez allonger le chemin AS PATH pour 172.2.0.0/31 dans l’Est des États-Unis pour que nous privilégiions le circuit ExpressRoute dans l’Ouest pour le trafic destiné à ce préfixe ; notre réseau pensera que le chemin d’accès pour ce préfixe est plus court dans l’Ouest.</span><span class="sxs-lookup"><span data-stu-id="e21da-157">In this example, you can lengthen the AS PATH for 172.2.0.0/31 in US East so that we will prefer the ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think the path to this prefix is shorter in the west).</span></span> <span data-ttu-id="e21da-158">De même, vous pouvez allonger le chemin AS PATH pour 172.2.0.2/31 dans l’Ouest des États-Unis pour que nous privilégiions le circuit ExpressRoute dans l’Est des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-158">Similarly you can lengthen the AS PATH for 172.2.0.2/31 in US West so that we'll prefer the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="e21da-159">Le routage est optimisé pour les deux bureaux.</span><span class="sxs-lookup"><span data-stu-id="e21da-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="e21da-160">Grâce à cette conception, si un circuit ExpressRoute est défaillant, Exchange Online peut toujours vous joindre via un autre circuit ExpressRoute ainsi que par le biais de votre réseau étendu.</span><span class="sxs-lookup"><span data-stu-id="e21da-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="e21da-161">Nous supprimons les numéros AS privés dans le chemin AS PATH pour les préfixes reçus sur l’homologation Microsoft.</span><span class="sxs-lookup"><span data-stu-id="e21da-161">We remove private AS numbers in the AS PATH for the prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="e21da-162">Vous devez ajouter des numéros AS publics au chemin AS PATH pour influencer le routage pour l’homologation Microsoft.</span><span class="sxs-lookup"><span data-stu-id="e21da-162">You need to append public AS numbers in the AS PATH to influence routing for Microsoft Peering.</span></span>
> 
> 

![Solution ExpressRoute n° 2 : ajoutez le préfixe AS PATH](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="e21da-164">Bien que les exemples fournis ici s’appliquent aux homologations Microsoft et publiques, nous prenons en charge les mêmes fonctionnalités pour l’homologation privée.</span><span class="sxs-lookup"><span data-stu-id="e21da-164">While the examples given here are for Microsoft and Public peerings, we do support the same capabilities for the Private peering.</span></span> <span data-ttu-id="e21da-165">En outre, le préfixe AS Path fonctionne au sein d’un même circuit ExpressRoute pour influencer la sélection des chemins principaux et secondaires.</span><span class="sxs-lookup"><span data-stu-id="e21da-165">Also, the AS Path prepending works within one single ExpressRoute circuit, to influence the selection of the primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="e21da-166">Routage non optimal entre des réseaux virtuels</span><span class="sxs-lookup"><span data-stu-id="e21da-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="e21da-167">Avec ExpressRoute, vous pouvez établir une communication réseau virtuel-réseau virtuel (également appelée « VNet ») en les reliant à un circuit ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="e21da-167">With ExpressRoute, you can enable Virtual Network to Virtual Network (which is also known as "VNet") communication by linking them to an ExpressRoute circuit.</span></span> <span data-ttu-id="e21da-168">Lorsque vous les reliez à plusieurs circuits ExpressRoute, un routage non optimal peut se produire entre les réseaux virtuels.</span><span class="sxs-lookup"><span data-stu-id="e21da-168">When you link them to multiple ExpressRoute circuits, suboptimal routing can happen between the VNets.</span></span> <span data-ttu-id="e21da-169">Prenons un exemple.</span><span class="sxs-lookup"><span data-stu-id="e21da-169">Let's consider an example.</span></span> <span data-ttu-id="e21da-170">Vous disposez de deux circuits ExpressRoute, l’un dans l’Ouest des États-Unis et l’autre dans l’Est des États-Unis.</span><span class="sxs-lookup"><span data-stu-id="e21da-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="e21da-171">Dans chaque région, vous avez deux réseaux virtuels.</span><span class="sxs-lookup"><span data-stu-id="e21da-171">In each region, you have two VNets.</span></span> <span data-ttu-id="e21da-172">Vos serveurs web sont déployés sur un réseau virtuel et les serveurs d’applications sur l’autre.</span><span class="sxs-lookup"><span data-stu-id="e21da-172">Your web servers are deployed in one VNet and application servers in the other.</span></span> <span data-ttu-id="e21da-173">À des fins de redondance, vous reliez les deux réseaux virtuels de chaque région à la fois au circuit ExpressRoute local et au circuit ExpressRoute distant.</span><span class="sxs-lookup"><span data-stu-id="e21da-173">For redundancy, you link the two VNets in each region to both the local ExpressRoute circuit and the remote ExpressRoute circuit.</span></span> <span data-ttu-id="e21da-174">Comme illustré ci-dessous, chaque réseau virtuel est doté de deux chemins d’accès menant vers l’autre réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="e21da-174">As can be seen below, from each VNet there are two paths to the other VNet.</span></span> <span data-ttu-id="e21da-175">Les réseaux virtuels ne font pas la distinction entre le circuit ExpressRoute local et le circuit ExpressRoute distant.</span><span class="sxs-lookup"><span data-stu-id="e21da-175">The VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="e21da-176">Par conséquent, étant donné qu’ils appliquent une stratégie de routage ECMP (Equal-cost multi-path routing) pour équilibrer la charge du trafic entre les réseaux virtuels, certains flux de trafic emprunteront le chemin le plus long et seront routés au niveau du circuit ExpressRoute distant.</span><span class="sxs-lookup"><span data-stu-id="e21da-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing to load-balance inter-VNet traffic, some traffic flows will take the longer path and get routed at the remote ExpressRoute circuit.</span></span>

![Scénario ExpressRoute n° 3 : routage non optimal entre réseaux virtuels](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a><span data-ttu-id="e21da-178">Solution : attribuer plus de poids à la connexion locale</span><span class="sxs-lookup"><span data-stu-id="e21da-178">Solution: assign a high weight to local connection</span></span>
<span data-ttu-id="e21da-179">La solution est simple.</span><span class="sxs-lookup"><span data-stu-id="e21da-179">The solution is simple.</span></span> <span data-ttu-id="e21da-180">Étant donné que vous savez où se trouvent les réseaux virtuels et les circuits, vous pouvez nous indiquer le chemin à privilégier pour chaque réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="e21da-180">Since you know where the VNets and the circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="e21da-181">Spécifiquement pour cet exemple, vous attribuez plus de poids à la connexion locale qu’à la connexion à distance (consultez l’exemple de configuration [ici](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span><span class="sxs-lookup"><span data-stu-id="e21da-181">Specifically for this example, you assign a higher weight to the local connection than to the remote connection (see the configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="e21da-182">Lorsqu’un réseau virtuel reçoit le préfixe de l’autre réseau virtuel sur plusieurs connexions, il préfère la connexion avec le plus de poids pour envoyer le trafic destiné à ce préfixe.</span><span class="sxs-lookup"><span data-stu-id="e21da-182">When a VNet receives the prefix of the other VNet on multiple connections it will prefer the connection with the highest weight to send traffic destined for that prefix.</span></span>

![Solution ExpressRoute n° 3 : attribuer plus de poids à la connexion locale](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="e21da-184">Vous pouvez également modifier entre le réseau virtuel et votre réseau sur site, si vous disposez de plusieurs circuits ExpressRoute, en configurant le poids attribué à une connexion au lien d’ajouter un préfixe AS PATH, technique décrite dans le second scénario ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="e21da-184">You can also influence routing from VNet to your on-premises network, if you have multiple ExpressRoute circuits, by configuring the weight of a connection instead of applying AS PATH prepending, a technique described in the second scenario above.</span></span> <span data-ttu-id="e21da-185">Pour chaque préfixe, nous examinerons toujours le poids attribué à la connexion avant la longueur du chemin AS pour décider du mode d’envoi du trafic.</span><span class="sxs-lookup"><span data-stu-id="e21da-185">For each prefix, we will always look at the connection weight before the AS Path length when deciding how to send traffic.</span></span>
>
>
