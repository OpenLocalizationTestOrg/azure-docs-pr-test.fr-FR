---
title: "Sondes personnalisées de l’équilibreur de charge et surveillance de l’état d’intégrité | Microsoft Docs"
description: "Découvrez comment utiliser les sondes personnalisées pour l’équilibreur de charge Azure afin de surveiller les instances situées derrière un équilibreur de charge"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: cab028fed58d544a56f2f6b12b72364c7baf4d86
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="0e583-103">Comprendre les sondes de l’équilibrage de charge</span><span class="sxs-lookup"><span data-stu-id="0e583-103">Understand load balancer probes</span></span>

<span data-ttu-id="0e583-104">L’équilibreur de charge Azure permet de surveiller l’intégrité des instances de serveur à l’aide de sondes.</span><span class="sxs-lookup"><span data-stu-id="0e583-104">Azure Load Balancer offers the capability to monitor the health of server instances by using probes.</span></span> <span data-ttu-id="0e583-105">Quand une sonde ne répond pas, l’équilibreur de charge n’envoie plus de nouvelles connexions à l’instance défectueuse.</span><span class="sxs-lookup"><span data-stu-id="0e583-105">When a probe fails to respond, Load Balancer stops sending new connections to the unhealthy instance.</span></span> <span data-ttu-id="0e583-106">Les connexions existantes ne sont pas affectées et les nouvelles connexions sont envoyées aux instances saines.</span><span class="sxs-lookup"><span data-stu-id="0e583-106">The existing connections are not affected, and new connections are sent to healthy instances.</span></span>

<span data-ttu-id="0e583-107">Les rôles de service cloud (rôles de travail et rôles Web) utilisent un agent invité pour la surveillance par sonde.</span><span class="sxs-lookup"><span data-stu-id="0e583-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="0e583-108">Des sondes personnalisées TCP ou HTTP doivent être configurées quand vous utilisez des machines virtuelles derrière un équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="0e583-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="0e583-109">Présentation du nombre et du délai d’expiration des sondes</span><span class="sxs-lookup"><span data-stu-id="0e583-109">Understand probe count and timeout</span></span>

<span data-ttu-id="0e583-110">Le comportement des sondes dépend des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="0e583-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="0e583-111">Le nombre de sondes ayant réussi qui permet à une instance d’être étiquetée comme étant en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="0e583-111">The number of successful probes that allow an instance to be labeled as up.</span></span>
* <span data-ttu-id="0e583-112">Le nombre de sondes ayant échoué qui permet à une instance d’être étiquetée comme n’étant pas en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="0e583-112">The number of failed probes that cause an instance to be labeled as down.</span></span>

<span data-ttu-id="0e583-113">La valeur du délai d’expiration et de la fréquence définie dans SuccessFailCount détermine si une instance est confirmée comme étant en cours d’exécution ou pas.</span><span class="sxs-lookup"><span data-stu-id="0e583-113">The timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed to be running or not running.</span></span> <span data-ttu-id="0e583-114">Dans le portail Azure, le délai d’expiration est défini sur deux fois la valeur de la fréquence.</span><span class="sxs-lookup"><span data-stu-id="0e583-114">In the Azure portal, the timeout is set to two times the value of the frequency.</span></span>

<span data-ttu-id="0e583-115">La configuration de sonde de toutes les instances à charge équilibrée pour un point de terminaison (jeu d’équilibrage de la charge) doit être identique.</span><span class="sxs-lookup"><span data-stu-id="0e583-115">The probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be the same.</span></span> <span data-ttu-id="0e583-116">Cela signifie que vous ne pouvez pas avoir de configuration de sonde différente pour chaque instance de rôle ou machine virtuelle du même service hébergé pour une combinaison de points de terminaison donnée.</span><span class="sxs-lookup"><span data-stu-id="0e583-116">This means you cannot have a different probe configuration for each role instance or virtual machine in the same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="0e583-117">Par exemple, chaque instance doit avoir des délais d’expiration et des ports locaux identiques.</span><span class="sxs-lookup"><span data-stu-id="0e583-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="0e583-118">Une sonde d’équilibreur de charge utilise une adresse IP 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="0e583-118">A Load Balancer probe uses the IP address 168.63.129.16.</span></span> <span data-ttu-id="0e583-119">Cette adresse IP publique facilite la communication vers les ressources de plateforme internes pour le scénario « Apportez votre propre réseau virtuel IP Azure ».</span><span class="sxs-lookup"><span data-stu-id="0e583-119">This public IP address facilitates communication to internal platform resources for the bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="0e583-120">L’adresse IP publique virtuelle 168.63.129.16 est utilisée dans toutes les régions et ne change pas.</span><span class="sxs-lookup"><span data-stu-id="0e583-120">The virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="0e583-121">Nous vous conseillons d’autoriser cette adresse IP dans toutes les stratégies de pare-feu local.</span><span class="sxs-lookup"><span data-stu-id="0e583-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="0e583-122">Elle ne doit pas être considérée comme un risque de sécurité, car seule la plateforme Azure interne peut envoyer un message à partir de cette adresse.</span><span class="sxs-lookup"><span data-stu-id="0e583-122">It should not be considered a security risk because only the internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="0e583-123">Si vous ne l’autorisez pas, un comportement inattendu peut se produire dans divers scénarios comme la configuration de la même plage d’adresses IP 168.63.129.16 et l’obtention de plusieurs adresses IP identiques.</span><span class="sxs-lookup"><span data-stu-id="0e583-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring the same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-the-types-of-probes"></a><span data-ttu-id="0e583-124">En savoir plus sur les types de sondes</span><span class="sxs-lookup"><span data-stu-id="0e583-124">Learn about the types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="0e583-125">Sonde d’agent invité</span><span class="sxs-lookup"><span data-stu-id="0e583-125">Guest agent probe</span></span>

<span data-ttu-id="0e583-126">Cette sonde est disponible pour Azure Cloud Services uniquement.</span><span class="sxs-lookup"><span data-stu-id="0e583-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="0e583-127">L’équilibreur de charge utilise l’agent invité de la machine virtuelle, puis écoute et répond avec une réponse HTTP 200 OK uniquement si l’instance est prête (c.-à-d., si l’état de l’instance n’est pas Occupé, Recyclage ou Arrêté).</span><span class="sxs-lookup"><span data-stu-id="0e583-127">Load Balancer utilizes the guest agent inside the virtual machine, and then listens and responds with an HTTP 200 OK response only when the instance is in the Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="0e583-128">Pour plus d’informations, voir [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) (configuration du fichier de définition de service (csdef) pour les sondes d’intégrité) ou [Création d’un équilibreur de charge accessible sur Internet pour les services cloud](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="0e583-128">For more information, see [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="0e583-129">Dans quelles conditions une sonde d’agent invité marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="0e583-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="0e583-130">Si l’agent invité ne répond pas avec HTTP 200 OK, l’équilibreur de charge marque l’instance comme ne répondant pas et arrête d’envoyer du trafic vers celle-ci.</span><span class="sxs-lookup"><span data-stu-id="0e583-130">If the guest agent fails to respond with HTTP 200 OK, the load balancer marks the instance as unresponsive and stops sending traffic to that instance.</span></span> <span data-ttu-id="0e583-131">L’équilibreur de charge continue d’effectuer un test ping sur l’instance.</span><span class="sxs-lookup"><span data-stu-id="0e583-131">The load balancer continues to ping the instance.</span></span> <span data-ttu-id="0e583-132">Si l’agent invité répond avec HTTP 200, l’équilibreur de charge renvoie du trafic vers cette instance.</span><span class="sxs-lookup"><span data-stu-id="0e583-132">If the guest agent responds with an HTTP 200, the load balancer sends traffic to that instance again.</span></span>

<span data-ttu-id="0e583-133">Quand vous utilisez un rôle web, le code du site web s’exécute généralement dans w3wp.exe, qui n’est pas surveillé par l’agent de structure Azure ou l’agent invité.</span><span class="sxs-lookup"><span data-stu-id="0e583-133">When you use a web role, the website code typically runs in w3wp.exe, which is not monitored by the Azure fabric or guest agent.</span></span> <span data-ttu-id="0e583-134">Cela signifie que les échecs dans w3wp.exe (par exemple, les réponses HTTP 500) ne sont pas signalés à l’agent invité et que l’équilibreur de charge ne sort pas cette instance de la rotation.</span><span class="sxs-lookup"><span data-stu-id="0e583-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported to the guest agent, and the load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="0e583-135">Sonde HTTP personnalisée</span><span class="sxs-lookup"><span data-stu-id="0e583-135">HTTP custom probe</span></span>

<span data-ttu-id="0e583-136">La sonde d’équilibreur de charge HTTP personnalisée remplace la sonde de l’agent invité par défaut et vous permet de créer votre propre logique personnalisée pour déterminer l’intégrité de l’instance de rôle.</span><span class="sxs-lookup"><span data-stu-id="0e583-136">The custom HTTP Load Balancer probe overrides the default guest agent probe, which means that you can create your own custom logic to determine the health of the role instance.</span></span> <span data-ttu-id="0e583-137">L’équilibreur de charge sonde régulièrement votre point de terminaison (toutes les 15 secondes, par défaut).</span><span class="sxs-lookup"><span data-stu-id="0e583-137">The load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="0e583-138">L’instance est considérée comme faisant partie de la rotation de l’équilibreur de charge si elle répond avec HTTP 200 dans le délai imparti (31 secondes par défaut).</span><span class="sxs-lookup"><span data-stu-id="0e583-138">The instance is considered to be in the load balancer rotation if it responds with an HTTP 200 within the timeout period (31 seconds by default).</span></span>

<span data-ttu-id="0e583-139">Cela peut être utile pour implémenter votre propre logique afin de supprimer des instances de la rotation de l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="0e583-139">This can be useful if you want to implement your own logic to remove instances from load balancer rotation.</span></span> <span data-ttu-id="0e583-140">Par exemple, vous pouvez décider de supprimer une instance si elle utilise plus de 90 % du processeur et retourne un état autre que 200.</span><span class="sxs-lookup"><span data-stu-id="0e583-140">For example, you could decide to remove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="0e583-141">Si certains de vos rôles web utilisent w3wp.exe, cela signifie également que vous obtenez une analyse automatique de votre site web, dans la mesure où les défaillances dans votre code de site web renvoient un état autre que 200 à la sonde d’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="0e583-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status to the load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="0e583-142">La sonde HTTP personnalisée prend en charge les chemins relatifs et le protocole HTTP uniquement.</span><span class="sxs-lookup"><span data-stu-id="0e583-142">The HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="0e583-143">HTTPS n’est pas pris en charge.</span><span class="sxs-lookup"><span data-stu-id="0e583-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="0e583-144">Dans quelles conditions une sonde HTTP personnalisée marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="0e583-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="0e583-145">L’application HTTP retourne un code de réponse HTTP autre que 200 (par exemple, 403, 404 ou 500).</span><span class="sxs-lookup"><span data-stu-id="0e583-145">The HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="0e583-146">Il s’agit d’une reconnaissance positive selon laquelle l’instance d’application doit être mise immédiatement hors service.</span><span class="sxs-lookup"><span data-stu-id="0e583-146">This is a positive acknowledgment that the application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="0e583-147">Le serveur HTTP ne répond pas du tout après le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="0e583-147">The HTTP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="0e583-148">Selon la valeur définie pour le délai d’expiration, cela peut signifier que plusieurs demandes d’analyse ne reçoivent pas de réponse avant que celle-ci ne soit marquée comme n’étant pas en cours d’exécution (autrement dit, avant que les sondes SuccessFailCount soient envoyées).</span><span class="sxs-lookup"><span data-stu-id="0e583-148">Depending on the timeout value that is set, this might mean that multiple probe requests go unanswered before the probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="0e583-149">Le serveur ferme la connexion via une réinitialisation TCP.</span><span class="sxs-lookup"><span data-stu-id="0e583-149">The server closes the connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="0e583-150">Sonde TCP personnalisée</span><span class="sxs-lookup"><span data-stu-id="0e583-150">TCP custom probe</span></span>

<span data-ttu-id="0e583-151">Les sondes TCP établissent une connexion en effectuant une connexion en trois temps au port défini.</span><span class="sxs-lookup"><span data-stu-id="0e583-151">TCP probes initiate a connection by performing a three-way handshake with the defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="0e583-152">Dans quelles conditions une sonde TCP personnalisée marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="0e583-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="0e583-153">Le serveur TCP ne répond pas du tout à la fin du délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="0e583-153">The TCP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="0e583-154">La sonde est marquée comme n’étant pas en cours d’exécution en fonction du nombre de demandes d’analyse ayant échoué, qui ont été configurées pour rester sans réponse avant que la sonde soit marquée comme n’étant pas en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="0e583-154">When the probe is marked as not running depends on the number of failed probe requests that were configured to go unanswered before marking the probe as not running.</span></span>
* <span data-ttu-id="0e583-155">La sonde reçoit une réinitialisation TCP de l’instance de rôle.</span><span class="sxs-lookup"><span data-stu-id="0e583-155">The probe receives a TCP reset from the role instance.</span></span>

<span data-ttu-id="0e583-156">Pour plus d’informations sur la configuration d’une sonde d’intégrité HTTP ou d’une sonde TCP, consultez [Création d’un équilibreur de charge accessible sur Internet dans Resource Manager à l’aide de PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="0e583-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="0e583-157">Rajouter des instances saines à la rotation d’équilibrage de charge</span><span class="sxs-lookup"><span data-stu-id="0e583-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="0e583-158">Les sondes TCP et HTTP sont considérées comme saines et marquent l’instance de rôle comme saine dans les cas suivants :</span><span class="sxs-lookup"><span data-stu-id="0e583-158">TCP and HTTP probes are considered healthy and mark the role instance as healthy when:</span></span>

* <span data-ttu-id="0e583-159">L’équilibreur de charge reçoit une sonde positive au premier démarrage de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="0e583-159">The load balancer gets a positive probe the first time the VM boots.</span></span>
* <span data-ttu-id="0e583-160">Le nombre SuccessFailCount (décrit précédemment) définit la valeur des sondes ayant réussi nécessaires pour marquer l’instance de rôle comme étant saine.</span><span class="sxs-lookup"><span data-stu-id="0e583-160">The number SuccessFailCount (described earlier) defines the value of successful probes that are required to mark the role instance as healthy.</span></span> <span data-ttu-id="0e583-161">Si une instance de rôle a été supprimée, le nombre de sondes ayant réussi successives doit être égal ou supérieur à la valeur de SuccessFailCount pour marquer l’instance de rôle comme étant en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="0e583-161">If a role instance was removed, the number of successful, successive probes must equal or exceed the value of SuccessFailCount to mark the role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="0e583-162">Si l’intégrité d’une instance de rôle fluctue, l’équilibreur de charge attend plus longtemps avant de remettre l’instance de rôle dans un état d’intégrité normal.</span><span class="sxs-lookup"><span data-stu-id="0e583-162">If the health of a role instance is fluctuating, the load balancer waits longer before putting the role instance back in the healthy state.</span></span> <span data-ttu-id="0e583-163">Cette opération est effectuée via une stratégie pour protéger l’utilisateur et l’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="0e583-163">This is done via policy to protect the user and the infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="0e583-164">Utiliser l’analytique des journaux pour l’équilibreur de charge</span><span class="sxs-lookup"><span data-stu-id="0e583-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="0e583-165">Vous pouvez utiliser l’ [analytique des journaux pour l’équilibreur de charge](load-balancer-monitor-log.md) pour vérifier le nombre et l’état d’intégrité des sondes.</span><span class="sxs-lookup"><span data-stu-id="0e583-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) to check on the probe health status and probe count.</span></span> <span data-ttu-id="0e583-166">La journalisation peut être utilisée avec Power BI ou Operational Insights pour fournir des statistiques sur l’état d’intégrité de l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="0e583-166">Logging can be used with Power BI or Azure Operational Insights to provide statistics about Load Balancer health status.</span></span>
