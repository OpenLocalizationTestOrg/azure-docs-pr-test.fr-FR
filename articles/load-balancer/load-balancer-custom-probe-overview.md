---
title: "état d’analyse et les sondes d’équilibrage d’aaaLoad personnalisés | Documents Microsoft"
description: "Découvrez comment des sondes toouse personnalisé pour les instances de toomonitor d’équilibrage de charge Azure derrière un équilibreur de charge"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: 3dfcfcd2d5cffa58b160cb38d63acffbd997d452
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/06/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="99cd2-103">Comprendre les sondes de l’équilibrage de charge</span><span class="sxs-lookup"><span data-stu-id="99cd2-103">Understand load balancer probes</span></span>

<span data-ttu-id="99cd2-104">Équilibrage de charge Azure offre d’intégrité hello capacité toomonitor hello des instances de serveur à l’aide de sondes.</span><span class="sxs-lookup"><span data-stu-id="99cd2-104">Azure Load Balancer offers hello capability toomonitor hello health of server instances by using probes.</span></span> <span data-ttu-id="99cd2-105">Lorsqu’une sonde échoue toorespond, équilibrage de charge cesse d’envoyer des instance non intègre de nouvelles connexions toohello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-105">When a probe fails toorespond, Load Balancer stops sending new connections toohello unhealthy instance.</span></span> <span data-ttu-id="99cd2-106">les connexions existantes Hello ne sont pas affectées, et les nouvelles connexions sont envoyées toohealthy instances.</span><span class="sxs-lookup"><span data-stu-id="99cd2-106">hello existing connections are not affected, and new connections are sent toohealthy instances.</span></span>

<span data-ttu-id="99cd2-107">Les rôles de service cloud (rôles de travail et rôles Web) utilisent un agent invité pour la surveillance par sonde.</span><span class="sxs-lookup"><span data-stu-id="99cd2-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="99cd2-108">Des sondes personnalisées TCP ou HTTP doivent être configurées quand vous utilisez des machines virtuelles derrière un équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="99cd2-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="99cd2-109">Présentation du nombre et du délai d’expiration des sondes</span><span class="sxs-lookup"><span data-stu-id="99cd2-109">Understand probe count and timeout</span></span>

<span data-ttu-id="99cd2-110">Le comportement des sondes dépend des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="99cd2-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="99cd2-111">nombre de Hello de sondes réussies qui autorisent une toobe instance étiqueté comme étant en service.</span><span class="sxs-lookup"><span data-stu-id="99cd2-111">hello number of successful probes that allow an instance toobe labeled as up.</span></span>
* <span data-ttu-id="99cd2-112">nombre de Hello de sondes ayant échouées qui provoquent une toobe instance étiqueté comme étant hors service.</span><span class="sxs-lookup"><span data-stu-id="99cd2-112">hello number of failed probes that cause an instance toobe labeled as down.</span></span>

<span data-ttu-id="99cd2-113">valeur du délai d’expiration et la fréquence du Hello définie dans SuccessFailCount déterminer si une instance est confirmé toobe en cours d’exécution ou ne pas en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="99cd2-113">hello timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed toobe running or not running.</span></span> <span data-ttu-id="99cd2-114">Bonjour portail Azure, délai d’attente hello a la valeur tootwo hello valeur de fréquence de hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-114">In hello Azure portal, hello timeout is set tootwo times hello value of hello frequency.</span></span>

<span data-ttu-id="99cd2-115">configuration de sonde Hello de toutes les instances d’équilibrage de la charge pour un point de terminaison (autrement dit, un jeu d’équilibrage) doit être hello identiques.</span><span class="sxs-lookup"><span data-stu-id="99cd2-115">hello probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be hello same.</span></span> <span data-ttu-id="99cd2-116">Cela signifie que vous ne pouvez avoir une configuration de la sonde différents pour chaque instance de rôle ou de la machine virtuelle dans hello même service hébergé par une combinaison de point de terminaison particulier.</span><span class="sxs-lookup"><span data-stu-id="99cd2-116">This means you cannot have a different probe configuration for each role instance or virtual machine in hello same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="99cd2-117">Par exemple, chaque instance doit avoir des délais d’expiration et des ports locaux identiques.</span><span class="sxs-lookup"><span data-stu-id="99cd2-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="99cd2-118">Une sonde d’équilibrage de charge utilise l’adresse IP de hello 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="99cd2-118">A Load Balancer probe uses hello IP address 168.63.129.16.</span></span> <span data-ttu-id="99cd2-119">Cette adresse IP publique facilite les ressources de la plateforme communication toointernal pour hello mettre-your-propriétaire-IP scénario de réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="99cd2-119">This public IP address facilitates communication toointernal platform resources for hello bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="99cd2-120">Hello public l’adresse IP virtuelle 168.63.129.16 est utilisé dans toutes les régions et ne change pas.</span><span class="sxs-lookup"><span data-stu-id="99cd2-120">hello virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="99cd2-121">Nous vous conseillons d’autoriser cette adresse IP dans toutes les stratégies de pare-feu local.</span><span class="sxs-lookup"><span data-stu-id="99cd2-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="99cd2-122">Elle ne doit pas être considérée comme un risque de sécurité car uniquement hello interne plateforme Azure peut obtenir un message à partir de cette adresse.</span><span class="sxs-lookup"><span data-stu-id="99cd2-122">It should not be considered a security risk because only hello internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="99cd2-123">Si vous ne le faites pas, il y aura un comportement inattendu dans de nombreux scénarios, telles que la configuration de hello même plage d’adresses IP 168.63.129.16 et avoir dupliqué des adresses IP.</span><span class="sxs-lookup"><span data-stu-id="99cd2-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring hello same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-hello-types-of-probes"></a><span data-ttu-id="99cd2-124">En savoir plus sur les types d’analyses par sondage hello</span><span class="sxs-lookup"><span data-stu-id="99cd2-124">Learn about hello types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="99cd2-125">Sonde d’agent invité</span><span class="sxs-lookup"><span data-stu-id="99cd2-125">Guest agent probe</span></span>

<span data-ttu-id="99cd2-126">Cette sonde est disponible pour Azure Cloud Services uniquement.</span><span class="sxs-lookup"><span data-stu-id="99cd2-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="99cd2-127">Équilibrage de charge utilise l’agent invité de hello hello virtual machine, puis écoute et répond avec une réponse HTTP 200 OK uniquement lorsque hello instance est prête hello (autrement dit, pas dans un autre état comme occupé, le recyclage ou l’arrêt).</span><span class="sxs-lookup"><span data-stu-id="99cd2-127">Load Balancer utilizes hello guest agent inside hello virtual machine, and then listens and responds with an HTTP 200 OK response only when hello instance is in hello Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="99cd2-128">Pour plus d’informations, consultez [configuration hello définition du fichier de service (csdef) pour les sondes d’intégrité](https://msdn.microsoft.com/library/azure/ee758710.aspx) ou [prise en main la création d’un équilibrage de charge connecté à Internet pour les services de cloud computing](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="99cd2-128">For more information, see [Configuring hello service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="99cd2-129">Dans quelles conditions une sonde d’agent invité marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="99cd2-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="99cd2-130">Si l’agent invité de hello échoue toorespond avec HTTP 200 OK, les marques de programme d’équilibrage de charge hello hello instance ne répond pas et cesse d’envoyer l’instance toothat de trafic.</span><span class="sxs-lookup"><span data-stu-id="99cd2-130">If hello guest agent fails toorespond with HTTP 200 OK, hello load balancer marks hello instance as unresponsive and stops sending traffic toothat instance.</span></span> <span data-ttu-id="99cd2-131">équilibrage de charge Hello continue d’instance de hello tooping.</span><span class="sxs-lookup"><span data-stu-id="99cd2-131">hello load balancer continues tooping hello instance.</span></span> <span data-ttu-id="99cd2-132">Si l’agent invité de hello répond avec un HTTP 200, équilibrage de charge hello envoie à nouveau l’instance de toothat le trafic.</span><span class="sxs-lookup"><span data-stu-id="99cd2-132">If hello guest agent responds with an HTTP 200, hello load balancer sends traffic toothat instance again.</span></span>

<span data-ttu-id="99cd2-133">Lorsque vous utilisez un rôle web, code de site Web hello s’exécute généralement dans w3wp.exe, ce qui n’est pas analysé par hello tissu Azure ou l’agent invité.</span><span class="sxs-lookup"><span data-stu-id="99cd2-133">When you use a web role, hello website code typically runs in w3wp.exe, which is not monitored by hello Azure fabric or guest agent.</span></span> <span data-ttu-id="99cd2-134">Cela signifie que les échecs dans w3wp.exe (par exemple, les réponses HTTP 500) ne sera pas l’agent invité de toohello signalé et équilibrage de charge hello ne prendra qu’une instance hors rotation.</span><span class="sxs-lookup"><span data-stu-id="99cd2-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported toohello guest agent, and hello load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="99cd2-135">Sonde HTTP personnalisée</span><span class="sxs-lookup"><span data-stu-id="99cd2-135">HTTP custom probe</span></span>

<span data-ttu-id="99cd2-136">Sonde d’équilibrage de charge HTTP personnalisée Hello remplace hello par défaut invité sonde de l’agent, ce qui signifie que vous pouvez créer votre propre logique personnalisée toodetermine hello la santé de l’instance de rôle hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-136">hello custom HTTP Load Balancer probe overrides hello default guest agent probe, which means that you can create your own custom logic toodetermine hello health of hello role instance.</span></span> <span data-ttu-id="99cd2-137">équilibrage de charge Hello les tests de votre point de terminaison toutes les 15 secondes, par défaut.</span><span class="sxs-lookup"><span data-stu-id="99cd2-137">hello load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="99cd2-138">instance de Hello est considéré comme toobe dans rotation d’équilibrage de charge hello s’il répond avec un HTTP 200 dans hello délai imparti (31 secondes par défaut).</span><span class="sxs-lookup"><span data-stu-id="99cd2-138">hello instance is considered toobe in hello load balancer rotation if it responds with an HTTP 200 within hello timeout period (31 seconds by default).</span></span>

<span data-ttu-id="99cd2-139">Cela peut être utile si vous souhaitez tooimplement vos propres instances de tooremove logique à partir de la rotation d’équilibrage de charge.</span><span class="sxs-lookup"><span data-stu-id="99cd2-139">This can be useful if you want tooimplement your own logic tooremove instances from load balancer rotation.</span></span> <span data-ttu-id="99cd2-140">Par exemple, vous pouvez décider tooremove une instance si elle est supérieure à 90 % de l’UC et retourne un état autre que 200.</span><span class="sxs-lookup"><span data-stu-id="99cd2-140">For example, you could decide tooremove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="99cd2-141">Si vous avez des rôles web qui utilisent w3wp.exe, cela signifie également vous obtenez automatique d’analyse de votre site Web, car les défaillances dans votre code de site Web retourne une sonde d’équilibrage de charge non-200 état toohello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status toohello load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="99cd2-142">Sonde de Hello HTTP personnalisé prend en charge les chemins d’accès relatifs et le protocole HTTP uniquement.</span><span class="sxs-lookup"><span data-stu-id="99cd2-142">hello HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="99cd2-143">HTTPS n’est pas pris en charge.</span><span class="sxs-lookup"><span data-stu-id="99cd2-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="99cd2-144">Dans quelles conditions une sonde HTTP personnalisée marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="99cd2-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="99cd2-145">Hello application HTTP renvoie un code de réponse HTTP autre que 200 (par exemple, 403, 404 ou 500).</span><span class="sxs-lookup"><span data-stu-id="99cd2-145">hello HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="99cd2-146">Il s’agit d’un accusé de réception positif hello application instance doit être mises hors service immédiatement.</span><span class="sxs-lookup"><span data-stu-id="99cd2-146">This is a positive acknowledgment that hello application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="99cd2-147">serveur de Hello HTTP ne répond pas du tout après le délai d’attente hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-147">hello HTTP server does not respond at all after hello timeout period.</span></span> <span data-ttu-id="99cd2-148">Selon la valeur de délai d’attente de hello est défini, cela peut signifier que sonde plusieurs demandes go sans réponse avant de sonde de hello est marqué comme inactif (autrement dit, avant de SuccessFailCount sondes sont envoyés).</span><span class="sxs-lookup"><span data-stu-id="99cd2-148">Depending on hello timeout value that is set, this might mean that multiple probe requests go unanswered before hello probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="99cd2-149">serveur de Hello ferme la connexion hello via une réinitialisation TCP.</span><span class="sxs-lookup"><span data-stu-id="99cd2-149">hello server closes hello connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="99cd2-150">Sonde TCP personnalisée</span><span class="sxs-lookup"><span data-stu-id="99cd2-150">TCP custom probe</span></span>

<span data-ttu-id="99cd2-151">TCP sondes établir une connexion en effectuant une négociation triple avec le port de hello défini.</span><span class="sxs-lookup"><span data-stu-id="99cd2-151">TCP probes initiate a connection by performing a three-way handshake with hello defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="99cd2-152">Dans quelles conditions une sonde TCP personnalisée marque-t-elle une instance comme étant défectueuse ?</span><span class="sxs-lookup"><span data-stu-id="99cd2-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="99cd2-153">serveur TCP Hello ne répond pas du tout après le délai d’attente hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-153">hello TCP server does not respond at all after hello timeout period.</span></span> <span data-ttu-id="99cd2-154">Les demandes qui ont été configuré toogo sans réponse avant de marquer la sonde hello ne pas en cours d’exécution lorsque sonde de hello comme étant ne pas en cours d’exécution dépend de nombre hello de sonde ayant échoué.</span><span class="sxs-lookup"><span data-stu-id="99cd2-154">When hello probe is marked as not running depends on hello number of failed probe requests that were configured toogo unanswered before marking hello probe as not running.</span></span>
* <span data-ttu-id="99cd2-155">Sonde de Hello reçoit un réinitialisation à partir de l’instance de rôle hello TCP.</span><span class="sxs-lookup"><span data-stu-id="99cd2-155">hello probe receives a TCP reset from hello role instance.</span></span>

<span data-ttu-id="99cd2-156">Pour plus d’informations sur la configuration d’une sonde d’intégrité HTTP ou d’une sonde TCP, consultez [Création d’un équilibreur de charge accessible sur Internet dans Resource Manager à l’aide de PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="99cd2-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="99cd2-157">Rajouter des instances saines à la rotation d’équilibrage de charge</span><span class="sxs-lookup"><span data-stu-id="99cd2-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="99cd2-158">Les sondes HTTP et TCP sont considérés comme intègres et marquer l’instance de rôle hello comme sain lorsque :</span><span class="sxs-lookup"><span data-stu-id="99cd2-158">TCP and HTTP probes are considered healthy and mark hello role instance as healthy when:</span></span>

* <span data-ttu-id="99cd2-159">équilibrage de charge Hello Obtient une sonde positif hello première heure hello que machine virtuelle démarre.</span><span class="sxs-lookup"><span data-stu-id="99cd2-159">hello load balancer gets a positive probe hello first time hello VM boots.</span></span>
* <span data-ttu-id="99cd2-160">numéro d’Hello SuccessFailCount (décrit précédemment) définit la valeur hello de sondes réussies sont l’instance de rôle requis toomark hello intègre.</span><span class="sxs-lookup"><span data-stu-id="99cd2-160">hello number SuccessFailCount (described earlier) defines hello value of successful probes that are required toomark hello role instance as healthy.</span></span> <span data-ttu-id="99cd2-161">Si une instance de rôle a été supprimée, nombre hello de sondes de réussite, successives égale ou supérieure à valeur hello d’instance de rôle SuccessFailCount toomark hello en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="99cd2-161">If a role instance was removed, hello number of successful, successive probes must equal or exceed hello value of SuccessFailCount toomark hello role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="99cd2-162">Si la santé d’une instance de rôle hello fluctue, équilibrage de charge hello attend plus longtemps avant de mettre l’instance de rôle hello en état d’intégrité hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-162">If hello health of a role instance is fluctuating, hello load balancer waits longer before putting hello role instance back in hello healthy state.</span></span> <span data-ttu-id="99cd2-163">Cela est réalisé via Stratégie tooprotect hello infrastructure d’utilisateurs et hello.</span><span class="sxs-lookup"><span data-stu-id="99cd2-163">This is done via policy tooprotect hello user and hello infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="99cd2-164">Utiliser l’analytique des journaux pour l’équilibreur de charge</span><span class="sxs-lookup"><span data-stu-id="99cd2-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="99cd2-165">Vous pouvez utiliser [journal analytique pour l’équilibrage de charge](load-balancer-monitor-log.md) toocheck hello sonde d’intégrité état et la sonde de nombre.</span><span class="sxs-lookup"><span data-stu-id="99cd2-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) toocheck on hello probe health status and probe count.</span></span> <span data-ttu-id="99cd2-166">Journalisation sont utilisables avec les statistiques tooprovide Power BI ou Azure Operational Insights sur l’état de contrôle d’intégrité d’équilibrage de charge.</span><span class="sxs-lookup"><span data-stu-id="99cd2-166">Logging can be used with Power BI or Azure Operational Insights tooprovide statistics about Load Balancer health status.</span></span>
