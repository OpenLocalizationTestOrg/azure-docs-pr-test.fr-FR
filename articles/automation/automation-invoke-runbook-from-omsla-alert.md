---
title: "Appel d’un runbook Azure Automation à partir d’une alerte Log Analytics | Microsoft Docs"
description: "Cet article présente une vue d’ensemble de l’appel d’un runbook Automation à partir d’une alerte Microsoft OMS Log Analytics."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="adf92-103">Appel d’un runbook Azure Automation à partir d’une alerte OMS Log Analytics</span><span class="sxs-lookup"><span data-stu-id="adf92-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="adf92-104">Lorsqu’une alerte est configurée dans Log Analytics pour créer un enregistrement d’alerte si les résultats correspondent aux critères spécifiés, par exemple un pic d’utilisation processeur prolongé ou l’échec d’un processus d’application particulier essentiel au fonctionnement d’une application métier et l’écriture d’un événement correspondant dans le journal des événements Windows, cette alerte peut exécuter automatiquement un runbook Automation dans une tentative de résolution automatique du problème.</span><span class="sxs-lookup"><span data-stu-id="adf92-104">When an alert is configured in Log Analytics to create an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical to the functionality of a business application fails and writes a corresponding event in the Windows event log, that alert can automatically run an Automation runbook in an attempt to auto-remediate the issue.</span></span>  

<span data-ttu-id="adf92-105">Deux méthodes permettent d’appeler un runbook lorsque vous configurez une alerte.</span><span class="sxs-lookup"><span data-stu-id="adf92-105">There are two options to call a runbook when configuring the alert.</span></span>  <span data-ttu-id="adf92-106">Plus précisément :</span><span class="sxs-lookup"><span data-stu-id="adf92-106">Specifically,</span></span>

1. <span data-ttu-id="adf92-107">Utilisation d’un webhook.</span><span class="sxs-lookup"><span data-stu-id="adf92-107">Using a Webhook.</span></span>
   * <span data-ttu-id="adf92-108">Il s’agit de la seule option disponible si votre espace de travail OMS n’est pas lié à un compte Automation.</span><span class="sxs-lookup"><span data-stu-id="adf92-108">This is the only option available if your OMS workspace is not linked to an Automation account.</span></span>
   * <span data-ttu-id="adf92-109">Si vous possédez déjà un compte Automation lié à un espace de travail OMS, cette option est toujours disponible.</span><span class="sxs-lookup"><span data-stu-id="adf92-109">If you already have an Automation account linked to an OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="adf92-110">Sélection directe d’un runbook.</span><span class="sxs-lookup"><span data-stu-id="adf92-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="adf92-111">Cette option est disponible uniquement si l’espace de travail OMS est lié à un compte Automation.</span><span class="sxs-lookup"><span data-stu-id="adf92-111">This option is available only when the OMS workspace is linked to an Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="adf92-112">Appel d’un runbook à l’aide d’un webhook</span><span class="sxs-lookup"><span data-stu-id="adf92-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="adf92-113">Un webhook vous permet de démarrer un runbook particulier dans Azure Automation via une simple requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="adf92-113">A webhook allows you to start a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="adf92-114">Avant de configurer l’[alerte Log Analytics](../log-analytics/log-analytics-alerts.md#alert-rules) pour appeler le runbook à l’aide d’un webhook en tant qu’action d’alerte, vous devez d’abord créer un webhook pour le runbook qui sera appelé à l’aide de cette méthode.</span><span class="sxs-lookup"><span data-stu-id="adf92-114">Before configuring the [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) to call the runbook using a webhook as an alert action, you will need to first create a webhook for the runbook that will be called using this method.</span></span>  <span data-ttu-id="adf92-115">Passez en revue et suivez les étapes de l’article relatif à la [création d’un webhook](automation-webhooks.md#creating-a-webhook) et n’oubliez pas d’enregistrer l’URL du webhook afin de pouvoir la référencer lors de la configuration de la règle d’alerte.</span><span class="sxs-lookup"><span data-stu-id="adf92-115">Review and follow the steps in the [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember to record the webhook URL so that you can reference it while configuring the alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="adf92-116">Appel direct d’un runbook</span><span class="sxs-lookup"><span data-stu-id="adf92-116">Calling a runbook directly</span></span>

<span data-ttu-id="adf92-117">Si vous avez installé et configuré l’offre Automation & Control dans votre espace de travail OMS, lors de la configuration de l’option des actions de runbook pour l’alerte, vous pouvez afficher tous les runbooks de la liste déroulante **Sélectionner un runbook**, puis sélectionner celui que vous souhaitez exécuter en réponse à l’alerte.</span><span class="sxs-lookup"><span data-stu-id="adf92-117">If you have the Automation & Control offering installed and configured in your OMS workspace, when configuring the Runbook actions option for the alert, you can view all runbooks from the **Select a runbook** dropdown list and select the specific runbook you want to run in response to the alert.</span></span>  <span data-ttu-id="adf92-118">Le runbook sélectionné peut être exécuté dans un espace de travail dans le cloud Azure ou sur un Runbook Worker hybride.</span><span class="sxs-lookup"><span data-stu-id="adf92-118">The selected runbook can run in a workspace in the Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="adf92-119">Si l’alerte est créée à l’aide de la méthode du runbook, un webhook est créé pour celui-ci.</span><span class="sxs-lookup"><span data-stu-id="adf92-119">When the alert is created using the runbook option, a webhook will be created for the runbook.</span></span>  <span data-ttu-id="adf92-120">Vous pouvez voir le webhook si vous accédez au compte Automation et accédez au panneau du webhook du runbook sélectionné.</span><span class="sxs-lookup"><span data-stu-id="adf92-120">You can see the webhook if you go to the Automation account and navigate to the webhook blade of the selected runbook.</span></span>  <span data-ttu-id="adf92-121">Si vous supprimez l’alerte, le webhook n’est pas supprimé, mais l’utilisateur peut procéder manuellement à sa suppression.</span><span class="sxs-lookup"><span data-stu-id="adf92-121">If you delete the alert, the webhook is not deleted, but the user can delete the webhook manually.</span></span>  <span data-ttu-id="adf92-122">Ce n’est pas un problème si le webhook n’est pas supprimé. Il s’agit simplement d’un élément orphelin qui devra finalement être supprimé afin de conserver un compte Automation organisé.</span><span class="sxs-lookup"><span data-stu-id="adf92-122">It is not a problem if the webhook is not deleted, it is just an orphaned item that will eventually need to be deleted in order to maintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="adf92-123">Caractéristiques d’un runbook (pour les deux méthodes)</span><span class="sxs-lookup"><span data-stu-id="adf92-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="adf92-124">Les deux méthodes d’appel de runbook à partir de l’alerte Log Analytics présentent des caractéristiques de comportement différentes que vous devez comprendre avant de configurer vos règles d’alerte.</span><span class="sxs-lookup"><span data-stu-id="adf92-124">Both methods for calling the runbook from the Log Analytics alert have different behavior characteristics that need to be understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="adf92-125">Vous devez disposer d’un paramètre d’entrée de runbook appelé **WebhookData** qui est de type **objet**.</span><span class="sxs-lookup"><span data-stu-id="adf92-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="adf92-126">Il peut être obligatoire ou facultatif.</span><span class="sxs-lookup"><span data-stu-id="adf92-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="adf92-127">L’alerte transmet les résultats de recherche au runbook à l’aide de ce paramètre d’entrée.</span><span class="sxs-lookup"><span data-stu-id="adf92-127">The alert passes the search results to the runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="adf92-128">Vous devez disposer du code permettant de convertir le paramètre WebhookData en objet PowerShell.</span><span class="sxs-lookup"><span data-stu-id="adf92-128">You must have code to convert the WebhookData to a PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="adf92-129">*$SearchResults* est un tableau des objets, qui contiennent chacun les champs et les valeurs d’un résultat de recherche.</span><span class="sxs-lookup"><span data-stu-id="adf92-129">*$SearchResults* will be an array of objects; each object contains the fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a><span data-ttu-id="adf92-130">Incohérences du paramètre WebhookData entre la méthode utilisant un webhook et celle utilisant un runbook</span><span class="sxs-lookup"><span data-stu-id="adf92-130">WebhookData inconsistencies between the webhook option and runbook option</span></span>

* <span data-ttu-id="adf92-131">Lorsque vous configurez une alerte pour appeler un webhook, entrez l’URL du webhook que vous avez créé pour un runbook, puis cliquez sur le bouton **Test Webhook (Tester le webhook)**.</span><span class="sxs-lookup"><span data-stu-id="adf92-131">When configuring an alert to call a Webhook, enter a webhook URL you created for a runbook, and click the **Test Webhook** button.</span></span>  <span data-ttu-id="adf92-132">Le paramètre WebhookData obtenu envoyé au runbook ne contient ni *.SearchResult* ni *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="adf92-132">The resulting WebhookData sent to the runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="adf92-133">Si vous enregistrez cette alerte, lorsqu’elle se déclenche et appelle le webhook, le paramètre WebhookData envoyé au runbook contient *.SearchResult*.</span><span class="sxs-lookup"><span data-stu-id="adf92-133">If you save that alert, when the alert triggers and calls the webhook, the WebhookData sent to the runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="adf92-134">Si vous créez une alerte et que vous la configurez pour appeler un runbook (ce qui crée également un webhook), lorsqu’elle se déclenche, elle envoie au runbook le paramètre WebhookData qui contient *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="adf92-134">If you create an alert, and configure it to call a runbook (which also creates a webhook), when the alert triggers it sends WebhookData to the runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="adf92-135">Ainsi, dans l’exemple de code ci-dessus, vous devez obtenir *.SearchResult* si l’alerte appelle un webhook, et *SearchResults* si l’alerte appelle directement un runbook.</span><span class="sxs-lookup"><span data-stu-id="adf92-135">Thus in the code example above, you will need to get *.SearchResult* if the alert calls a webhook, and will need to get *.SearchResults* if the alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="adf92-136">Exemple de procédure pas à pas</span><span class="sxs-lookup"><span data-stu-id="adf92-136">Example walkthrough</span></span>

<span data-ttu-id="adf92-137">Nous allons illustrer ce fonctionnement à l’aide de l’exemple de runbook graphique suivant, qui démarre un service Windows.</span><span class="sxs-lookup"><span data-stu-id="adf92-137">We will demonstrate how this works by using the following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Démarrer le runbook graphique d’un service Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="adf92-139">Le runbook contient un paramètre d’entrée de type **objet** appelé **WebhookData** et inclut les données du webhook transmises à partir de l’alerte contenant *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="adf92-139">The runbook has one input parameter of type **Object** that is called **WebhookData** and includes the webhook data passed from the alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="adf92-140">![Paramètres d’entrée de runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="adf92-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="adf92-141">Pour cet exemple, dans Log Analytics, nous avons créé deux champs personnalisés, *SvcDisplayName_CF* et *SvcState_CF*, pour extraire le nom d’affichage et l’état du service (en cours d’exécution ou arrêté) à partir de l’événement écrit dans le journal des événements système.</span><span class="sxs-lookup"><span data-stu-id="adf92-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, to extract the service display name and the state of the service (i.e. running or stopped) from the event written to the System event log.</span></span>  <span data-ttu-id="adf92-142">Nous créons maintenant une règle d’alerte avec la requête de recherche suivante : `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` afin de pouvoir détecter lorsque le service Spouleur d’impression est arrêté sur le système Windows.</span><span class="sxs-lookup"><span data-stu-id="adf92-142">We then create an alert rule with the following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when the Print Spooler service is stopped on the Windows system.</span></span>  <span data-ttu-id="adf92-143">Il peut s’agir de n’importe quel service, mais pour cet exemple, nous référençons l’un des services inclus dans le système d’exploitation Windows.</span><span class="sxs-lookup"><span data-stu-id="adf92-143">It can be any service of interest, but for this example we are referencing one of the pre-existing services that are included with the Windows OS.</span></span>  <span data-ttu-id="adf92-144">L’action d’alerte est configurée pour exécuter notre runbook utilisé dans cet exemple et s’exécuter sur le Runbook Worker hybride, lesquels sont activés sur les systèmes cibles.</span><span class="sxs-lookup"><span data-stu-id="adf92-144">The alert action is configured to execute our runbook used in this example and run on the Hybrid Runbook Worker, which are enabled on the target systems.</span></span>   

<span data-ttu-id="adf92-145">L’activité de code du runbook **Obtenir le nom du service à partir de LA** convertit la chaîne au format JSON en un type d’objet et la filtre sur l’élément *SvcDisplayName_CF* pour extraire le nom d’affichage du service Windows et le transmettre à l’activité suivante, qui vérifie que le service est arrêté avant de tenter de le redémarrer.</span><span class="sxs-lookup"><span data-stu-id="adf92-145">The runbook code activity **Get Service Name from LA** will convert the JSON-formatted string into an object type and filter on the item *SvcDisplayName_CF* to extract the display name of the Windows service and pass this onto the next activity which will verify the service is stopped before attempting to restart it.</span></span>  <span data-ttu-id="adf92-146">*SvcDisplayName_CF* est un [champ personnalisé](../log-analytics/log-analytics-custom-fields.md) créé dans Log Analytics pour illustrer cet exemple.</span><span class="sxs-lookup"><span data-stu-id="adf92-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics to demonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="adf92-147">Lorsque le service s’arrête, la règle d’alerte dans Log Analytics détecte une correspondance, déclenche le runbook et envoie le contexte de l’alerte au runbook.</span><span class="sxs-lookup"><span data-stu-id="adf92-147">When the service stops, the alert rule in Log Analytics will detect a match and trigger the runbook and send the alert context to the runbook.</span></span> <span data-ttu-id="adf92-148">Le runbook vérifie si le service est arrêté, et le cas échéant, tente de le redémarrer, de vérifier qu’il a démarré correctement, puis sort les résultats.</span><span class="sxs-lookup"><span data-stu-id="adf92-148">The runbook will take action to verify the service is stopped, and if so attempt to restart the service and verify it started correctly and output the results.</span></span>     

<span data-ttu-id="adf92-149">Si vous ne possédez pas de compte Automation lié à votre espace de travail OMS, vous pouvez également configurer la règle d’alerte avec une action de webhook afin de déclencher le runbook et de le configurer pour convertir la chaîne au format JSON et la filtrer sur *.SearchResult* en suivant les instructions mentionnées plus haut.</span><span class="sxs-lookup"><span data-stu-id="adf92-149">Alternatively if you don't have your Automation account linked to your OMS workspace, you would configure the alert rule with a webhook action to trigger the runbook and configure the runbook to convert the JSON-formatted string and filter on *.SearchResult* following the guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="adf92-150">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="adf92-150">Next steps</span></span>

* <span data-ttu-id="adf92-151">Pour en savoir plus sur les alertes de Log Analytics et sur leur création, consultez [Alertes dans Log Analytics](../log-analytics/log-analytics-alerts.md).</span><span class="sxs-lookup"><span data-stu-id="adf92-151">To learn more about alerts in Log Analytics and how to create one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="adf92-152">Pour comprendre comment déclencher des runbooks à l’aide d’un webhook, consultez [Webhooks Azure Automation](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="adf92-152">To understand how to trigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>
