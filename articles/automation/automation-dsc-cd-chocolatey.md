---
title: "Déploiement continu d’Azure Automation DSC avec Chocolatey | Microsoft Docs"
description: "Déploiement continu du DevOps à l’aide d’Azure Automation DSC et du gestionnaire de packages Chocolatey  Exemple avec modèle ARM JSON complet et source PowerShell."
services: automation
documentationcenter: 
author: eslesar
manager: carmonm
editor: tysonn
ms.assetid: c0baa411-eb76-4f91-8d14-68f68b4805b6
ms.service: automation
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: na
ms.date: 10/29/2016
ms.author: golive
ms.openlocfilehash: f23d7374a8954a0a95853fa9e00b54a8d9c468c4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2017
---
# <a name="usage-example-continuous-deployment-to-virtual-machines-using-automation-dsc-and-chocolatey"></a><span data-ttu-id="8ad7f-104">Exemple d'utilisation : Déploiement continu sur des ordinateurs virtuels à l’aide d’Automation DSC et Chocolatey</span><span class="sxs-lookup"><span data-stu-id="8ad7f-104">Usage Example: Continuous deployment to Virtual Machines using Automation DSC and Chocolatey</span></span>
<span data-ttu-id="8ad7f-105">L’univers des opérations de développement offre de nombreux outils conçus pour aider les développeurs à franchir plus facilement différents stades dans le pipeline de l’intégration continue.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-105">In a DevOps world there are many tools to assist with various points in the Continuous Integration pipeline.</span></span>  <span data-ttu-id="8ad7f-106">Le nouveau service Azure Automation Desired State Configuration (DSC) vient aujourd’hui enrichir la liste des options disponibles pour les équipes DevOps.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-106">Azure Automation Desired State Configuration (DSC) is a welcome new addition to the options that DevOps teams can employ.</span></span>  <span data-ttu-id="8ad7f-107">Cet article explique comment configurer le déploiement continu (CD) pour un ordinateur Windows.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-107">This article demonstrates setting up Continuous Deployment (CD) for a Windows computer.</span></span>  <span data-ttu-id="8ad7f-108">Vous pouvez facilement étendre la technique afin d’inclure autant d’ordinateurs Windows que vous le souhaitez dans le rôle (par exemple, un site Web), puis dans des rôles supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-108">You can easily extend the technique to include as many Windows computers as necessary in the role (a web site, for example), and from there to additional roles as well.</span></span>

![Déploiement continu pour machines virtuelles IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a><span data-ttu-id="8ad7f-110">À un niveau élevé</span><span class="sxs-lookup"><span data-stu-id="8ad7f-110">At a high level</span></span>
<span data-ttu-id="8ad7f-111">Il y aurait beaucoup à dire sur ce sujet, mais il est heureusement possible de décomposer toutes ces informations en deux grands processus :</span><span class="sxs-lookup"><span data-stu-id="8ad7f-111">There is quite a bit going on here, but fortunately it can be broken into two main processes:</span></span> 

* <span data-ttu-id="8ad7f-112">Écrire du code et le tester, puis créer et publication des packages d’installation pour les versions majeures et mineures du système.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-112">Writing code and testing it, then creating and publishing installation packages for major and minor versions of the system.</span></span> 
* <span data-ttu-id="8ad7f-113">Créer et gérer des machines virtuelles qui installeront et exécuteront le code dans les packages.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-113">Creating and managing VMs that will install and execute the code in the packages.</span></span>  

<span data-ttu-id="8ad7f-114">Une fois ces deux processus en place, vous pouvez mettre automatiquement à jour le package exécuté sur n’importe quelle machine virtuelle au fur et à mesure que de nouvelles versions sont créées et déployées.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-114">Once both of these core processes are in place, it’s a short step to automatically update the package running on any particular VM as new versions are created and deployed.</span></span>

## <a name="component-overview"></a><span data-ttu-id="8ad7f-115">Vue d’ensemble des composants</span><span class="sxs-lookup"><span data-stu-id="8ad7f-115">Component overview</span></span>
<span data-ttu-id="8ad7f-116">S’ils sont communément employés dans l’univers Linux, les gestionnaires de packages tels que [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) demeurent assez méconnus dans le monde de Windows.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-116">Package managers such as [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) are pretty well known in the Linux world, but not so much in the Windows world.</span></span>  <span data-ttu-id="8ad7f-117">[Chocolatey](https://chocolatey.org/) fait partie de ces packages. Pour mieux le découvrir, je vous invite à consulter le [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) de Scott Hanselman qui lui est dédié.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-117">[Chocolatey](https://chocolatey.org/) is such a thing, and Scott Hanselman’s [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) on the topic is a great intro.</span></span>  <span data-ttu-id="8ad7f-118">En résumé, Chocolatey vous permet, à l’aide de la ligne de commande, d’installer des packages à partir d’un référentiel de packages central dans un système Windows.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-118">In a nutshell, Chocolatey allows you to install packages from a central repository of packages into a Windows system using the command line.</span></span>  <span data-ttu-id="8ad7f-119">Vous pouvez créer et gérer votre propre référentiel et Chocolatey peut installer des packages à partir de tous les référentiels que vous désignez, quel qu’en soit le nombre.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-119">You can create and manage your own repository, and Chocolatey can install packages from any number of repositories that you designate.</span></span>

<span data-ttu-id="8ad7f-120">Desired State Configuration (DSC) ([vue d’ensemble](https://technet.microsoft.com/library/dn249912.aspx)) est un outil PowerShell qui vous permet de déclarer la configuration que vous souhaitez affecter à une machine.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-120">Desired State Configuration (DSC) ([overview](https://technet.microsoft.com/library/dn249912.aspx)) is a PowerShell tool that allows you to declare the configuration that you want for a machine.</span></span>  <span data-ttu-id="8ad7f-121">Par exemple, vous pouvez vouloir installer Chocolatey et IIS, ouvrir le port 80 et installer la version 1.0.0 de votre site Web.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-121">For example, you can say, “I want Chocolatey installed, I want IIS installed, I want port 80 opened, I want version 1.0.0 of my website installed.”</span></span>  <span data-ttu-id="8ad7f-122">Le gestionnaire de configuration locale (LCM, Local Configuration Manager) de DSC implémente alors cette configuration.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-122">The DSC Local Configuration Manager (LCM) implements that configuration.</span></span> <span data-ttu-id="8ad7f-123">Un serveur Pull DSC contient un référentiel des configurations de vos machines.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-123">A DSC Pull Server holds a repository of configurations for your machines.</span></span> <span data-ttu-id="8ad7f-124">Le LCM résidant sur chaque ordinateur vérifie régulièrement si sa configuration correspond à la configuration enregistrée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-124">The LCM on each machine checks in periodically to see if its configuration matches the stored configuration.</span></span> <span data-ttu-id="8ad7f-125">Il peut signaler l’état ou tenter de réaligner la configuration de la machine sur la configuration enregistrée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-125">It can either report status or attempt to bring the machine back into alignment with the stored configuration.</span></span> <span data-ttu-id="8ad7f-126">Vous pouvez modifier la configuration enregistrée sur le serveur Pull de manière à aligner la configuration d’une machine ou d’un ensemble de machines sur la configuration modifiée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-126">You can edit the stored configuration on the pull server to cause a machine or set of machines to come into alignment with the changed configuration.</span></span>

<span data-ttu-id="8ad7f-127">Azure Automation est un service géré dans Microsoft Azure qui vous permet d’automatiser différentes tâches à l’aide de runbooks, de nœuds, d’informations d’identification et de ressources comme des planifications et des variables globales.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-127">Azure Automation is a managed service in Microsoft Azure that allows you to automate various tasks using runbooks, nodes, credentials, resources and assets such as schedules and global variables.</span></span> <span data-ttu-id="8ad7f-128">Azure Automation DSC étend cette fonctionnalité d’automatisation pour intégrer les outils PowerShell DSC.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-128">Azure Automation DSC extends this automation capability to include PowerShell DSC tools.</span></span>  <span data-ttu-id="8ad7f-129">En voici une excellente [présentation](automation-dsc-overview.md).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-129">Here’s a great [overview](automation-dsc-overview.md).</span></span>

<span data-ttu-id="8ad7f-130">Une ressource DSC est un module de code qui présente des fonctionnalités spécifiques, telles que la gestion de mise en réseau, Active Directory ou SQL Server.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-130">A DSC Resource is a module of code that has specific capabilities, such as managing networking, Active Directory, or SQL Server.</span></span>  <span data-ttu-id="8ad7f-131">La ressource DSC Chocolatey sait comment accéder à un serveur NuGet (entre autres), télécharger les packages, installer les packages et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-131">The Chocolatey DSC Resource knows how to access a NuGet Server (among others), download packages, install packages, and so on.</span></span>  <span data-ttu-id="8ad7f-132">Il existe de nombreuses autres ressources DSC dans la [PowerShell Gallery](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-132">There are many other DSC Resources in the [PowerShell Gallery](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span></span>  <span data-ttu-id="8ad7f-133">Vous-même devez installer ces modules dans le serveur Pull Azure Automation DSC afin qu’ils puissent être utilisés par vos configurations.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-133">These modules are installed into your Azure Automation DSC Pull Server (by you) so they can be used by your configurations.</span></span>

<span data-ttu-id="8ad7f-134">Les modèles Resource Manager offrent un moyen de générer votre infrastructure par des déclarations (réseaux, sous-réseaux, sécurité du réseau et routage, équilibreurs de charge, NIC, machines virtuelles, etc.).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-134">Resource Manager templates provide a declarative way of generating your infrastructure - things like networks, subnets, network security and routing, load balancers, NICs, VMs, and so on.</span></span>  <span data-ttu-id="8ad7f-135">Voici un [article](../azure-resource-manager/resource-manager-deployment-model.md) qui compare le modèle de déploiement Resource Manager (déclaratif) avec le modèle de déploiement Azure Service Management (ASM, ou Classic) (impératif) et présente les fournisseurs des ressources principales, le calcul, le stockage et le réseau.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-135">Here’s an [article](../azure-resource-manager/resource-manager-deployment-model.md) that compares the Resource Manager deployment model (declarative) with the Azure Service Management (ASM, or classic) deployment model (imperative), and discusses the core resource providers, compute, storage and network.</span></span>

<span data-ttu-id="8ad7f-136">Un modèle Resource Manager se distingue par sa capacité à installer une extension de machine virtuelle dans la machine virtuelle à mesure de son approvisionnement.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-136">One key feature of an Resource Manager template is its ability to install a VM extension into the VM as it’s provisioned.</span></span>  <span data-ttu-id="8ad7f-137">Une extension de machine virtuelle possède des fonctionnalités spécifiques, telles que l’exécution d’un script personnalisé, l’installation d’un logiciel antivirus ou encore l’exécution d’un script de configuration DSC.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-137">A VM extension has specific capabilities such as running a custom script, installing anti-virus software, or running a DSC configuration script.</span></span>  <span data-ttu-id="8ad7f-138">Il existe de nombreux autres types d’extensions de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-138">There are many other types of VM extensions.</span></span>

## <a name="quick-trip-around-the-diagram"></a><span data-ttu-id="8ad7f-139">Tour d’horizon rapide du diagramme</span><span class="sxs-lookup"><span data-stu-id="8ad7f-139">Quick trip around the diagram</span></span>
<span data-ttu-id="8ad7f-140">Commençons par le point de départ : vous écrivez votre code, vous le générez, vous le testez, puis vous créez un package d’installation.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-140">Starting at the top, you write your code, build and test, then create an installation package.</span></span>  <span data-ttu-id="8ad7f-141">Chocolatey peut gérer différents types de packages d’installation, tels que MSI, MSU ou ZIP.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-141">Chocolatey can handle various types of installation packages, such as MSI, MSU, ZIP.</span></span>  <span data-ttu-id="8ad7f-142">Et vous disposez de toute la puissance de PowerShell pour effectuer l’installation si les fonctionnalités natives de Chocolatey ne sont pas tout à fait adaptées.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-142">And you have the full power of PowerShell to do the actual installation if Chocolatey’s native capabilities aren’t quite up to it.</span></span>  <span data-ttu-id="8ad7f-143">Placez le package dans un endroit accessible, par exemple un référentiel de packages.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-143">Put the package into someplace reachable – a package repository.</span></span>  <span data-ttu-id="8ad7f-144">Cet exemple utilise un dossier public dans un compte de stockage d’objets blob Azure, mais vous pouvez utiliser n’importe quel emplacement.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-144">This usage example uses a public folder in an Azure blob storage account, but it can be anywhere.</span></span>  <span data-ttu-id="8ad7f-145">Chocolatey fonctionne en mode natif avec des serveurs NuGet et quelques autres serveurs pour la gestion des métadonnées de packages.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-145">Chocolatey works natively with NuGet servers and a few others for management of package metadata.</span></span>  <span data-ttu-id="8ad7f-146">[Cet article](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) en décrit les options.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-146">[This article](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) describes the options.</span></span>  <span data-ttu-id="8ad7f-147">Cet exemple utilise NuGet.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-147">This usage example uses NuGet.</span></span>  <span data-ttu-id="8ad7f-148">Un Nuspec désigne les métadonnées concernant vos packages.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-148">A Nuspec is metadata about your packages.</span></span>  <span data-ttu-id="8ad7f-149">Les Nuspec sont « compilés » dans NuPkg et stockés sur un serveur NuGet.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-149">The Nuspec’s are “compiled” into NuPkg’s and stored in a NuGet server.</span></span>  <span data-ttu-id="8ad7f-150">Lorsque votre configuration demande un package par son nom et fait référence à un serveur NuGet, la ressource DSC Chocolatey (qui réside désormais sur la machine virtuelle) extrait le package et l’installe à votre place.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-150">When your configuration requests a package by name, and references a NuGet server, the Chocolatey DSC Resource (now on the VM) grabs the package and installs it for you.</span></span>  <span data-ttu-id="8ad7f-151">Vous pouvez également demander une version spécifique d’un package.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-151">You can also request a specific version of a package.</span></span>

<span data-ttu-id="8ad7f-152">Dans la partie inférieure gauche de l’image, vous verrez un modèle Azure Resource Manager (ARM).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-152">In the bottom left portion of the picture, there is an Azure Resource Manager (ARM) template.</span></span>  <span data-ttu-id="8ad7f-153">Dans cet exemple, l’extension de machine virtuelle enregistre la machine virtuelle auprès du serveur Pull Azure Automation DSC (autrement dit, un serveur d’extraction) en tant que nœud.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-153">In this usage example, the VM extension registers the VM with the Azure Automation DSC Pull Server (that is, a pull server) as a Node.</span></span>  <span data-ttu-id="8ad7f-154">La configuration est stockée dans le serveur d’extraction.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-154">The configuration is stored in the pull server.</span></span>  <span data-ttu-id="8ad7f-155">En fait, elle est stockée à deux reprises : une première fois en tant que texte brut et une deuxième fois compilée dans un fichier MOF (pour ceux qui s’y connaissent).  Dans le portail, la structure MOF est une « configuration de nœud » (et non une simple « configuration »).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-155">Actually, it’s stored twice: once as plain text and once compiled as an MOF file (for those that know about such things.)  In the portal, the MOF is a “node configuration” (as opposed to simply “configuration”).</span></span>  <span data-ttu-id="8ad7f-156">Il s’agit de l’artefact qui est associé à un nœud afin que le nœud connaisse sa configuration.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-156">It’s the artifact that’s associated with a Node so the node will know its configuration.</span></span>  <span data-ttu-id="8ad7f-157">Les détails ci-dessous montrent comment affecter la configuration de nœud au nœud.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-157">Details below show how to assign the node configuration to the node.</span></span>

<span data-ttu-id="8ad7f-158">Vraisemblablement, vous le faites déjà au départ, ou du moins la majeure partie.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-158">Presumably you’re already doing the bit at the top, or most of it.</span></span>  <span data-ttu-id="8ad7f-159">Créer un nuspec, le compiler et le stocker dans un serveur NuGet n’a rien de compliqué.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-159">Creating the nuspec, compiling and storing it in a NuGet server is a small thing.</span></span>  <span data-ttu-id="8ad7f-160">Et vous gérez déjà des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-160">And you’re already managing VMs.</span></span>  <span data-ttu-id="8ad7f-161">L’étape suivante du déploiement continu suppose de configurer le serveur d’extraction (une fois), d’y enregistrer vos nœuds (une fois) et d’y créer et stocker la configuration (au début).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-161">Taking the next step to continuous deployment requires setting up the pull server (once), registering your nodes with it (once), and creating and storing the configuration there (initially).</span></span>  <span data-ttu-id="8ad7f-162">Au fur et à mesure que les packages sont mis à niveau et déployés dans le référentiel, vous devez actualiser la configuration et la configuration des nœuds dans le serveur d’extraction (et répéter l’opération si besoin).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-162">Then as packages are upgraded and deployed to the repository, refresh the Configuration and Node Configuration in the pull server (repeat as needed).</span></span>

<span data-ttu-id="8ad7f-163">Si vous ne commencez pas par un modèle ARM, il n’y a aucun problème.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-163">If you’re not starting with an ARM template, that’s also OK.</span></span>  <span data-ttu-id="8ad7f-164">Il existe des applets de commande PowerShell conçues pour vous aider à enregistrer vos machines virtuelles auprès du serveur d’extraction et de tous les autres serveurs.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-164">There are PowerShell cmdlets designed to help you register your VMs with the pull server and all of the rest.</span></span> <span data-ttu-id="8ad7f-165">Pour plus d’informations, consultez cet article : [Gestion de machines avec Azure Automation DSC](automation-dsc-onboarding.md)</span><span class="sxs-lookup"><span data-stu-id="8ad7f-165">For more details, see this article: [Onboarding machines for management by Azure Automation DSC](automation-dsc-onboarding.md)</span></span>

## <a name="step-1-setting-up-the-pull-server-and-automation-account"></a><span data-ttu-id="8ad7f-166">Étape 1 : configuration du serveur Pull et du compte Automation</span><span class="sxs-lookup"><span data-stu-id="8ad7f-166">Step 1: Setting up the pull server and automation account</span></span>
<span data-ttu-id="8ad7f-167">Ouvrez une ligne de commande PowerShell (Add-AzureRmAccount) authentifiée : (le processus peut prendre quelques minutes en attendant que le serveur d’extraction soit configuré)</span><span class="sxs-lookup"><span data-stu-id="8ad7f-167">At an authenticated (Add-AzureRmAccount) PowerShell command line:  (can take a few minutes while the pull server is set up)</span></span>

    New-AzureRmResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureRmAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

<span data-ttu-id="8ad7f-168">Vous pouvez installer votre compte Automation dans l’une des régions suivantes (également appelées « emplacements ») : États-Unis de l’Est 2, Sud du centre des États-Unis, Gouvernement des États-Unis - Virginie, Europe de l’Ouest, Sud-Est asiatique, Japon de l’Est, Centre de l’Inde et Sud-Est de l’Australie, Centre du Canada, Europe du Nord.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-168">You can put your automation account into any of the following regions (aka location):  East US 2, South Central US, US Gov Virginia, West Europe, Southeast Asia, Japan East, Central India and Australia Southeast, Canada Central, North Europe.</span></span>

## <a name="step-2-vm-extension-tweaks-to-the-arm-template"></a><span data-ttu-id="8ad7f-169">Étape 2 : ajustement de l’extension de machine virtuelle au modèle ARM</span><span class="sxs-lookup"><span data-stu-id="8ad7f-169">Step 2: VM extension tweaks to the ARM template</span></span>
<span data-ttu-id="8ad7f-170">Voir les détails de l’enregistrement d’une machine virtuelle (à l’aide de l’extension PowerShell DSC VM) fournis dans ce [modèle de démarrage rapide d’Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-170">Details for VM registration (using the PowerShell DSC VM extension) provided in this [Azure Quickstart Template](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span></span>  <span data-ttu-id="8ad7f-171">Cette étape consiste à enregistrer votre nouvelle machine virtuelle auprès du serveur d’extraction dans la liste des nœuds DSC.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-171">This step registers your new VM with the pull server in the list of DSC Nodes.</span></span>  <span data-ttu-id="8ad7f-172">Une partie de cette inscription consiste à spécifier la configuration du nœud à appliquer au nœud.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-172">Part of this registration is specifying the node configuration to be applied to the node.</span></span>  <span data-ttu-id="8ad7f-173">Comme cette configuration de nœud n’a pas encore besoin d’exister déjà sur le serveur d’extraction, cette opération peut être effectuée pour la première fois à l’étape 4.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-173">This node configuration doesn't have to exist yet in the pull server, so it's OK that Step 4 is where this is done for the first time.</span></span>  <span data-ttu-id="8ad7f-174">Mais ici, à l'étape 2, vous devez avoir choisi le nom du nœud et celui de la configuration.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-174">But here in Step 2 you do need to have decided the name of the node and the name of the configuration.</span></span>  <span data-ttu-id="8ad7f-175">Dans cet exemple d'utilisation, le nœud est ’isvbox’ et la configuration est ’ISVBoxConfig’.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-175">In this usage example, the node is 'isvbox' and the configuration is 'ISVBoxConfig'.</span></span>  <span data-ttu-id="8ad7f-176">Le nom de la configuration de nœud (à préciser dans DeploymentTemplate.json) est donc ’ISVBoxConfig.isvbox’.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-176">So the node configuration name (to be specified in DeploymentTemplate.json) is 'ISVBoxConfig.isvbox'.</span></span>  

## <a name="step-3-adding-required-dsc-resources-to-the-pull-server"></a><span data-ttu-id="8ad7f-177">Étape 3 : ajout des ressources DSC requises au serveur Pull</span><span class="sxs-lookup"><span data-stu-id="8ad7f-177">Step 3: Adding required DSC resources to the pull server</span></span>
<span data-ttu-id="8ad7f-178">La PowerShell Gallery est conçue pour installer les ressources DSC dans votre compte Azure Automation.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-178">The PowerShell Gallery is instrumented to install DSC resources into your Azure Automation account.</span></span>  <span data-ttu-id="8ad7f-179">Accédez à la ressource que vous souhaitez ajouter et cliquez sur le bouton « Deploy to Azure Automation » (Déployer vers Azure Automation).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-179">Navigate to the resource you want and click the “Deploy to Azure Automation” button.</span></span>

![Exemple de la PowerShell Gallery](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

<span data-ttu-id="8ad7f-181">Une autre technique récemment ajoutée au portail Azure vous permet d’extraire de nouveaux modules ou de mettre à jour des modules existants.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-181">Another technique recently added to the Azure Portal allows you to pull in new modules or update existing modules.</span></span> <span data-ttu-id="8ad7f-182">Cliquez sur la ressource Compte Automation, sur la vignette Ressources et enfin sur la vignette Modules.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-182">Click through the Automation Account resource, the Assets tile, and finally the Modules tile.</span></span>  <span data-ttu-id="8ad7f-183">L’icône Parcourir la galerie vous permet de consulter la liste des modules dans la galerie, d’étudier le tout plus en détail et enfin d’importer dans votre compte Automation.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-183">The Browse Gallery icon allows you to see the list of modules in the gallery, drill down into details and ultimately import into your Automation Account.</span></span> <span data-ttu-id="8ad7f-184">Il s’agit là d’un excellent moyen pour mettre à jour vos modules de temps à autre.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-184">This is a great way to keep your modules up to date from time to time.</span></span> <span data-ttu-id="8ad7f-185">De plus, la fonctionnalité d’importation vérifie les dépendances avec d’autres modules pour garantir que rien n’est désynchronisé.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-185">And, the import feature checks dependencies with other modules to ensure nothing gets out of sync.</span></span>

<span data-ttu-id="8ad7f-186">Il existe aussi une approche manuelle.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-186">Or, there’s the manual approach.</span></span>  <span data-ttu-id="8ad7f-187">La structure de dossier d’un module d’intégration PowerShell pour un ordinateur Windows est un peu différente de celle à laquelle s’attend Azure Automation.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-187">The folder structure of a PowerShell Integration Module for a Windows computer is a little different from the folder structure expected by the Azure Automation.</span></span>  <span data-ttu-id="8ad7f-188">Cette différence nécessite une légère modification de votre part.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-188">This requires a little tweaking on your part.</span></span>  <span data-ttu-id="8ad7f-189">Mais il n’y a là rien de compliqué, et vous n’avez à effectuer cette opération qu’une seule fois par ressource (sauf si vous souhaitez effectuer une mise à niveau ultérieurement).  Pour plus d’informations sur la création de modules d’intégration PowerShell, consultez cet article : [Création de modules d’intégration pour Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span><span class="sxs-lookup"><span data-stu-id="8ad7f-189">But it’s not hard, and it’s done only once per resource (unless you want to upgrade it in future.)  For more information on authoring PowerShell Integration Modules, see this article: [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span></span>

* <span data-ttu-id="8ad7f-190">Installez le module dont vous avez besoin sur votre station de travail, comme suit :</span><span class="sxs-lookup"><span data-stu-id="8ad7f-190">Install the module that you need on your workstation, as follows:</span></span>
  * <span data-ttu-id="8ad7f-191">Installez [Windows Management Framework v5](http://aka.ms/wmf5latest) (inutile pour Windows 10)</span><span class="sxs-lookup"><span data-stu-id="8ad7f-191">Install [Windows Management Framework, v5](http://aka.ms/wmf5latest) (not needed for Windows 10)</span></span>
  * <span data-ttu-id="8ad7f-192">`Install-Module –Name MODULE-NAME` < — récupère le module à partir de la PowerShell Gallery</span><span class="sxs-lookup"><span data-stu-id="8ad7f-192">`Install-Module –Name MODULE-NAME`    <—grabs the module from the PowerShell Gallery</span></span> 
* <span data-ttu-id="8ad7f-193">Copiez le dossier de module situé dans le répertoire `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` dans un dossier temporaire</span><span class="sxs-lookup"><span data-stu-id="8ad7f-193">Copy the module folder from `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` to a temp folder</span></span> 
* <span data-ttu-id="8ad7f-194">Supprimez les modèles et la documentation dans le dossier principal</span><span class="sxs-lookup"><span data-stu-id="8ad7f-194">Delete samples and documentation from the main folder</span></span> 
* <span data-ttu-id="8ad7f-195">Compressez le dossier principal en attribuant au fichier ZIP exactement le même nom que celui du dossier</span><span class="sxs-lookup"><span data-stu-id="8ad7f-195">Zip the main folder, naming the ZIP file exactly the same as the folder</span></span> 
* <span data-ttu-id="8ad7f-196">Placez le fichier ZIP dans un emplacement HTTP accessible, par exemple un stockage d’objets blob dans un compte de stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-196">Put the ZIP file into a reachable HTTP location, such as blob storage in an Azure Storage Account.</span></span>
* <span data-ttu-id="8ad7f-197">Exécutez cette commande PowerShell :</span><span class="sxs-lookup"><span data-stu-id="8ad7f-197">Run this PowerShell:</span></span>
  
      New-AzureRmAutomationModule `
          -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
          -Name MODULE-NAME –ContentLink "https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip"

<span data-ttu-id="8ad7f-198">L’exemple fourni exécute ces étapes pour cChoco et xNetworking.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-198">The included example performs these steps for cChoco and xNetworking.</span></span> <span data-ttu-id="8ad7f-199">Consultez les [notes](#notes) relatives au traitement spécial pour cChoco.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-199">See the [Notes](#notes) for special handling for cChoco.</span></span>

## <a name="step-4-adding-the-node-configuration-to-the-pull-server"></a><span data-ttu-id="8ad7f-200">Étape 4 : ajout de la configuration de nœud au serveur Pull</span><span class="sxs-lookup"><span data-stu-id="8ad7f-200">Step 4: Adding the node configuration to the pull server</span></span>
<span data-ttu-id="8ad7f-201">L’importation et la compilation initiales de votre configuration dans le serveur Pull ne présentent aucune difficulté particulière.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-201">There’s nothing special about the first time you import your configuration into the pull server and compile.</span></span>  <span data-ttu-id="8ad7f-202">Toutes les autres opérations d’importation/compilation de la même configuration auront exactement le même aspect.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-202">All subsequent import/compiles of the same configuration look exactly the same.</span></span>  <span data-ttu-id="8ad7f-203">Chaque fois que vous mettez à jour votre package et que vous devez la mettre en production, vous devez effectuer cette étape après avoir vérifié que le fichier de configuration est correct et qu’il comporte la nouvelle version de votre package.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-203">Each time you update your package and need to push it out to production you do this step after ensuring the configuration file is correct – including the new version of your package.</span></span>  <span data-ttu-id="8ad7f-204">Voici le fichier de configuration et la commande PowerShell :</span><span class="sxs-lookup"><span data-stu-id="8ad7f-204">Here’s the configuration file and PowerShell:</span></span>

<span data-ttu-id="8ad7f-205">ISVBoxConfig.ps1:</span><span class="sxs-lookup"><span data-stu-id="8ad7f-205">ISVBoxConfig.ps1:</span></span>

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking

        Node "isvbox" {   

            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }

            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }

            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }

            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-V2-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

<span data-ttu-id="8ad7f-206">New-ConfigurationScript.ps1:</span><span class="sxs-lookup"><span data-stu-id="8ad7f-206">New-ConfigurationScript.ps1:</span></span>

    Import-AzureRmAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force

    $jobData = Start-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 

    $compilationJobId = $jobData.Id

    Get-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

<span data-ttu-id="8ad7f-207">Ces étapes génèrent une nouvelle configuration de nœud nommée « ISVBoxConfig.isvbox » placée sur le serveur d’extraction.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-207">These steps result in a new node configuration named “ISVBoxConfig.isvbox” being placed on the pull server.</span></span>  <span data-ttu-id="8ad7f-208">Le nom de la configuration de nœuds est créé en tant que « configurationName.nodeName ».</span><span class="sxs-lookup"><span data-stu-id="8ad7f-208">The node configuration name is built as “configurationName.nodeName”.</span></span>

## <a name="step-5-creating-and-maintaining-package-metadata"></a><span data-ttu-id="8ad7f-209">Étape 5 : création et gestion des métadonnées de packages</span><span class="sxs-lookup"><span data-stu-id="8ad7f-209">Step 5: Creating and maintaining package metadata</span></span>
<span data-ttu-id="8ad7f-210">Pour chaque package que vous placez dans le référentiel de packages, vous avez besoin d’un nuspec descriptif.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-210">For each package that you put into the package repository, you need a nuspec that describes it.</span></span>  <span data-ttu-id="8ad7f-211">Ce nuspec doit être compilé et stocké sur votre serveur NuGet.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-211">That nuspec must be compiled and stored in your NuGet server.</span></span> <span data-ttu-id="8ad7f-212">Cette opération est décrite [ici](http://docs.nuget.org/create/creating-and-publishing-a-package).</span><span class="sxs-lookup"><span data-stu-id="8ad7f-212">This process is described [here](http://docs.nuget.org/create/creating-and-publishing-a-package).</span></span>  <span data-ttu-id="8ad7f-213">Vous pouvez utiliser MyGet.org comme serveur NuGet.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-213">You can use MyGet.org as a NuGet server.</span></span>  <span data-ttu-id="8ad7f-214">Bien que ce service soit payant, ils proposent gratuitement une référence SKU pour débutants.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-214">They sell this service, but have a starter SKU that’s free.</span></span>  <span data-ttu-id="8ad7f-215">Rendez-vous sur NuGet.org pour obtenir des instructions sur l’installation de votre propre serveur NuGet pour vos packages privés.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-215">At NuGet.org you’ll find instructions on installing your own NuGet server for your private packages.</span></span>

## <a name="step-6-tying-it-all-together"></a><span data-ttu-id="8ad7f-216">Étape 6 : Exemple complet</span><span class="sxs-lookup"><span data-stu-id="8ad7f-216">Step 6: Tying it all together</span></span>
<span data-ttu-id="8ad7f-217">Chaque fois qu'une version passe l'assurance qualité et est approuvée pour le déploiement, le package est créé, nuspec et nupkg sont mis à jour et déployés sur le serveur NuGet.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-217">Each time a version passes QA and is approved for deployment, the package is created, nuspec and nupkg updated and deployed to the NuGet server.</span></span>  <span data-ttu-id="8ad7f-218">En outre, la configuration (étape 4 ci-dessus) doit être mise à jour pour correspondre au nouveau numéro de version.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-218">In addition, the configuration (Step 4 above) must be updated to agree with the new version number.</span></span>  <span data-ttu-id="8ad7f-219">Elle doit être envoyée au serveur d’extraction puis compilée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-219">It must be sent to the pull server and compiled.</span></span>  <span data-ttu-id="8ad7f-220">À ce stade, les machines virtuelles qui dépendent de cette configuration doivent extraire la mise à jour et l'installer.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-220">From that point on, it's up to the VMs that depend on that configuration to pull the update and install it.</span></span>  <span data-ttu-id="8ad7f-221">Chacune de ces mises à jour est simple et ne nécessite qu’une ou deux lignes PowerShell.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-221">Each of these updates are simple - just a line or two of PowerShell.</span></span>  <span data-ttu-id="8ad7f-222">Dans le cas de Visual Studio Team Services, certaines d’entre elles sont encapsulées dans les tâches de génération et peuvent être chaînées dans une build.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-222">In the case of Visual Studio Team Services, some of them are encapsulated in build tasks that can be chained together in a build.</span></span>  <span data-ttu-id="8ad7f-223">Cet [article](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) fournit plus de détails.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-223">This [article](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) provides more details.</span></span>  <span data-ttu-id="8ad7f-224">Ce [référentiel GitHub](https://github.com/Microsoft/vso-agent-tasks) détaille les différentes tâches de génération disponibles.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-224">This [GitHub repo](https://github.com/Microsoft/vso-agent-tasks) details the various available build tasks.</span></span>

## <a name="notes"></a><span data-ttu-id="8ad7f-225">notes</span><span class="sxs-lookup"><span data-stu-id="8ad7f-225">Notes</span></span>
<span data-ttu-id="8ad7f-226">Dans cet exemple d’utilisation, nous partons d’une machine virtuelle provenant d’une image Windows Server 2012 R2 générique de la galerie Azure.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-226">This usage example starts with a VM from a generic Windows Server 2012 R2 image from the Azure gallery.</span></span>  <span data-ttu-id="8ad7f-227">Vous pouvez démarrer à partir de n’importe quelle image stockée, puis la modifier avec la configuration DSC.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-227">You can start from any stored image and then tweak from there with the DSC configuration.</span></span>  <span data-ttu-id="8ad7f-228">Toutefois, la modification d’une configuration intégrée à une image est beaucoup plus difficile que la mise à jour dynamique de la configuration à l’aide de DSC.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-228">However, changing configuration that is baked into an image is much harder than dynamically updating the configuration using DSC.</span></span>

<span data-ttu-id="8ad7f-229">Vous n’êtes pas obligé d’utiliser un modèle ARM ou l’extension de machine virtuelle pour utiliser cette technique avec vos machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-229">You don’t have to use an ARM template and the VM extension to use this technique with your VMs.</span></span>  <span data-ttu-id="8ad7f-230">De même, il n’est pas nécessaire que vos machines virtuelles se trouvent sur Azure au niveau de la gestion des CD.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-230">And your VMs don’t have to be on Azure to be under CD management.</span></span>  <span data-ttu-id="8ad7f-231">Vous devez simplement faire en sorte d’installer Chocolatey et de configurer LCM sur la machine virtuelle afin qu’elle parvienne à localiser le serveur d’extraction.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-231">All that’s necessary is that Chocolatey be installed and the LCM configured on the VM so it knows where the pull server is.</span></span>  

<span data-ttu-id="8ad7f-232">Bien évidemment, lorsque vous mettez à jour un package sur une machine virtuelle en production, vous devez sortir cette machine virtuelle pendant l’installation de la mise à jour.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-232">Of course, when you update a package on a VM that’s in production, you need to take that VM out of rotation while the update is installed.</span></span>  <span data-ttu-id="8ad7f-233">La procédure varie considérablement.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-233">How you do this varies widely.</span></span>  <span data-ttu-id="8ad7f-234">Par exemple, avec une machine virtuelle placée derrière un équilibreur de charge Azure, vous pouvez ajouter une sonde personnalisée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-234">For example, with a VM behind an Azure Load Balancer, you can add a Custom Probe.</span></span>  <span data-ttu-id="8ad7f-235">Lors de la mise à jour de la machine virtuelle, faites en sorte que le point de terminaison de la sonde retourne un code 400.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-235">While updating the VM, have the probe endpoint return a 400.</span></span>  <span data-ttu-id="8ad7f-236">La solution nécessaire pour forcer cette modification peut se trouver à l’intérieur même de votre configuration, tout comme la solution qui lui permettra de retourner un code 200 une fois la mise à jour terminée.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-236">The tweak necessary to cause this change can be inside your configuration, as can the tweak to switch it back to returning a 200 once the update is complete.</span></span>

<span data-ttu-id="8ad7f-237">La source complète de cet exemple se trouve dans ce [projet Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="8ad7f-237">Full source for this usage example is in [this Visual Studio project](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) on GitHub.</span></span>

## <a name="related-articles"></a><span data-ttu-id="8ad7f-238">Articles connexes</span><span class="sxs-lookup"><span data-stu-id="8ad7f-238">Related Articles</span></span>
* [<span data-ttu-id="8ad7f-239">Vue d'ensemble d'Azure Automation DSC</span><span class="sxs-lookup"><span data-stu-id="8ad7f-239">Azure Automation DSC Overview</span></span>](automation-dsc-overview.md)
* [<span data-ttu-id="8ad7f-240">Applets de commande Azure Automation DSC</span><span class="sxs-lookup"><span data-stu-id="8ad7f-240">Azure Automation DSC cmdlets</span></span>](https://msdn.microsoft.com/library/mt244122.aspx)
* [<span data-ttu-id="8ad7f-241">Gestion de machines avec Azure Automation DSC</span><span class="sxs-lookup"><span data-stu-id="8ad7f-241">Onboarding machines for management by Azure Automation DSC</span></span>](automation-dsc-onboarding.md)

