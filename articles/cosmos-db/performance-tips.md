---
title: Conseils sur les performances - Azure Cosmos DB NoSQL | Microsoft Docs
description: "Découvrez les options de configuration clientes pour améliorer les performances de base de données Azure Cosmos DB"
keywords: "comment améliorer les performances de base de données"
services: cosmos-db
author: mimig1
manager: jhubbard
editor: 
documentationcenter: 
ms.assetid: 94ff155e-f9bc-488f-8c7a-5e7037091bb9
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/23/2017
ms.author: mimig
ms.openlocfilehash: a94cda90eca9dca2b93adb8f5091d829e7375aa5
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/03/2017
---
# <a name="performance-tips-for-azure-cosmos-db"></a><span data-ttu-id="d8a6c-104">Conseils sur les performances pour Azure Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="d8a6c-104">Performance tips for Azure Cosmos DB</span></span>
<span data-ttu-id="d8a6c-105">Azure Cosmos DB est une base de données distribuée rapide et flexible qui peut être mise à l’échelle en toute transparence avec une latence et un débit garantis.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-105">Azure Cosmos DB is a fast and flexible distributed database that scales seamlessly with guaranteed latency and throughput.</span></span> <span data-ttu-id="d8a6c-106">Vous n’avez pas à apporter de modifications d’architecture majeures ou écrire de code complexe pour mettre à l’échelle votre base de données avec Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-106">You do not have to make major architecture changes or write complex code to scale your database with Cosmos DB.</span></span> <span data-ttu-id="d8a6c-107">Il suffit d’un simple appel d’API ou de méthode de [kit de développement logiciel (SDK)](set-throughput.md#set-throughput-sdk)pour effectuer une mise à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-107">Scaling up and down is as easy as making a single API call or [SDK method call](set-throughput.md#set-throughput-sdk).</span></span> <span data-ttu-id="d8a6c-108">Toutefois, étant donné que Cosmos DB est accessible via des appels réseau, vous pouvez apporter des optimisations côté client de manière à atteindre des performances de pointe.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-108">However, because Cosmos DB is accessed via network calls there are client-side optimizations you can make to achieve peak performance.</span></span>

<span data-ttu-id="d8a6c-109">Si vous vous demandez comment améliorer les performances de votre base de données,</span><span class="sxs-lookup"><span data-stu-id="d8a6c-109">So if you're asking "How can I improve my database performance?"</span></span> <span data-ttu-id="d8a6c-110">lisez ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="d8a6c-110">consider the following options:</span></span>

## <a name="networking"></a><span data-ttu-id="d8a6c-111">Mise en réseau</span><span class="sxs-lookup"><span data-stu-id="d8a6c-111">Networking</span></span>
<a id="direct-connection"></a>

1. <span data-ttu-id="d8a6c-112">**Stratégie de connexion : utilisation du mode de connexion direct**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-112">**Connection policy: Use direct connection mode**</span></span>

    <span data-ttu-id="d8a6c-113">La façon dont un client se connecte à Cosmos DB a des conséquences importantes sur les performances, notamment en termes de latence côté client.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-113">How a client connects to Cosmos DB has important implications on performance, especially in terms of observed client-side latency.</span></span> <span data-ttu-id="d8a6c-114">Il existe deux paramètres de configuration essentiels pour la stratégie de connexion client : le *mode* de connexion et le [*protocole* de connexion](#connection-protocol).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-114">There are two key configuration settings available for configuring client Connection Policy – the connection *mode* and the [connection *protocol*](#connection-protocol).</span></span>  <span data-ttu-id="d8a6c-115">Les deux modes disponibles sont :</span><span class="sxs-lookup"><span data-stu-id="d8a6c-115">The two available modes are:</span></span>

   1. <span data-ttu-id="d8a6c-116">Mode passerelle (par défaut)</span><span class="sxs-lookup"><span data-stu-id="d8a6c-116">Gateway Mode (default)</span></span>
   2. <span data-ttu-id="d8a6c-117">Mode direct</span><span class="sxs-lookup"><span data-stu-id="d8a6c-117">Direct Mode</span></span>

      <span data-ttu-id="d8a6c-118">Le mode passerelle est pris en charge sur toutes les plateformes de kit de développement logiciel (SDK) et est l’option configurée par défaut.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-118">Gateway Mode is supported on all SDK platforms and is the configured default.</span></span>  <span data-ttu-id="d8a6c-119">Si votre application s’exécute dans un réseau d’entreprise avec des restrictions de pare-feu strictes, le mode passerelle est la meilleure option, car il utilise le port HTTPS standard et un seul point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-119">If your application runs within a corporate network with strict firewall restrictions, Gateway Mode is the best choice since it uses the standard HTTPS port and a single endpoint.</span></span> <span data-ttu-id="d8a6c-120">Toutefois, il existe un compromis en termes de performances : le mode passerelle implique un tronçon réseau supplémentaire chaque fois que les données sont lues ou écrites dans Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-120">The performance tradeoff, however, is that Gateway Mode involves an additional network hop every time data is read or written to Cosmos DB.</span></span> <span data-ttu-id="d8a6c-121">Étant donné que le mode direct implique moins de tronçons réseaux, les performances sont meilleures.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-121">Because of this, Direct Mode offers better performance due to fewer network hops.</span></span>
<a id="use-tcp"></a>
2. <span data-ttu-id="d8a6c-122">**Stratégie de connexion : utilisation du protocole TCP**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-122">**Connection policy: Use the TCP protocol**</span></span>

    <span data-ttu-id="d8a6c-123">Lorsque vous utilisez le mode direct, deux options de protocole sont disponibles :</span><span class="sxs-lookup"><span data-stu-id="d8a6c-123">When using Direct Mode, there are two protocol options available:</span></span>

   * <span data-ttu-id="d8a6c-124">TCP</span><span class="sxs-lookup"><span data-stu-id="d8a6c-124">TCP</span></span>
   * <span data-ttu-id="d8a6c-125">HTTPS</span><span class="sxs-lookup"><span data-stu-id="d8a6c-125">HTTPS</span></span>

     <span data-ttu-id="d8a6c-126">Cosmos DB fournit un modèle de programmation RESTful simple et ouvert sur HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-126">Cosmos DB offers a simple and open RESTful programming model over HTTPS.</span></span> <span data-ttu-id="d8a6c-127">De plus, il fournit un protocole TCP très performant qui utilise aussi un modèle de communication RESTful, disponible via le Kit de développement logiciel (SDK) .NET.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-127">Additionally, it offers an efficient TCP protocol, which is also RESTful in its communication model and is available through the .NET client SDK.</span></span> <span data-ttu-id="d8a6c-128">Direct TCP et HTTPS SSL utilisent tous deux SSL pour l’authentification initiale et le chiffrement du trafic.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-128">Both Direct TCP and HTTPS use SSL for initial authentication and encrypting traffic.</span></span> <span data-ttu-id="d8a6c-129">Pour de meilleures performances, utilisez le protocole TCP lorsque cela est possible.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-129">For best performance, use the TCP protocol when possible.</span></span>

     <span data-ttu-id="d8a6c-130">Lors de l’utilisation de TCP en mode passerelle, le port TCP 443 est le port de Cosmos DB et le port 10255 est le port de l’API de MongoDB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-130">When using TCP in Gateway Mode, TCP Port 443 is the Cosmos DB port, and 10255 is the MongoDB API port.</span></span> <span data-ttu-id="d8a6c-131">Lors de l’utilisation de TCP en mode direct, en plus des ports de passerelle, vous devez vous assurer que la plage de ports comprise entre 10000 et 20000 est ouverte, car Cosmos DB utilise les ports TCP dynamiques.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-131">When using TCP in Direct Mode, in addition to the Gateway ports, you need to ensure the port range between 10000 and 20000 is open because Cosmos DB uses dynamic TCP ports.</span></span> <span data-ttu-id="d8a6c-132">Si ces ports ne sont pas ouverts et que vous essayez d’utiliser le protocole TCP, vous recevez une erreur de type 503 Service indisponible.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-132">If these ports are not open and you attempt to use TCP, you receive a 503 Service Unavailable error.</span></span>

     <span data-ttu-id="d8a6c-133">Le mode connectivité est configuré lors de la construction de l’instance DocumentClient avec le paramètre ConnectionPolicy.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-133">The Connectivity Mode is configured during the construction of the DocumentClient instance with the ConnectionPolicy parameter.</span></span> <span data-ttu-id="d8a6c-134">Si le mode direct est utilisé, le protocole peut également être défini dans le paramètre ConnectionPolicy.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-134">If Direct Mode is used, the Protocol can also be set within the ConnectionPolicy parameter.</span></span>

    ```C#
    var serviceEndpoint = new Uri("https://contoso.documents.net");
    var authKey = new "your authKey from the Azure portal";
    DocumentClient client = new DocumentClient(serviceEndpoint, authKey,
    new ConnectionPolicy
    {
        ConnectionMode = ConnectionMode.Direct,
        ConnectionProtocol = Protocol.Tcp
    });
    ```

    <span data-ttu-id="d8a6c-135">Puisque TCP est uniquement pris en charge en mode direct, si le mode passerelle est activé, c’est le protocole HTTPS qui sera toujours utilisé pour communiquer avec la passerelle, et la valeur de protocole dans le paramètre ConnectionPolicy sera ignorée.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-135">Because TCP is only supported in Direct Mode, if Gateway Mode is used, then the HTTPS protocol is always used to communicate with the Gateway and the Protocol value in the ConnectionPolicy is ignored.</span></span>

    ![Illustration de la stratégie de connexion Azure Cosmos DB](./media/performance-tips/connection-policy.png)

3. <span data-ttu-id="d8a6c-137">**Appel d’OpenAsync pour éviter la latence de démarrage lors de la première requête**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-137">**Call OpenAsync to avoid startup latency on first request**</span></span>

    <span data-ttu-id="d8a6c-138">Par défaut, la première requête a une latence plus élevée, car elle doit extraire la table de routage d’adresses.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-138">By default, the first request has a higher latency because it has to fetch the address routing table.</span></span> <span data-ttu-id="d8a6c-139">Pour éviter cette latence de démarrage lors de la première requête, vous devez appeler OpenAsync() une seule fois lors de l’initialisation, comme indiqué ci-après.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-139">To avoid this startup latency on the first request, you should call OpenAsync() once during initialization as follows.</span></span>

        await client.OpenAsync();
   <a id="same-region"></a>
4. <span data-ttu-id="d8a6c-140">**Colocalisation des clients dans la même région Azure pour les performances**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-140">**Collocate clients in same Azure region for performance**</span></span>

    <span data-ttu-id="d8a6c-141">Lorsque cela est possible, placez toutes les applications appelant Cosmos DB dans la même région que la base de données Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-141">When possible, place any applications calling Cosmos DB in the same region as the Cosmos DB database.</span></span> <span data-ttu-id="d8a6c-142">Pour une comparaison approximative, les appels à Cosmos DB dans la même région s’effectuent en 1 à 2 ms, mais la latence entre les côtes ouest et est des États-Unis est supérieure à 50 ms.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-142">For an approximate comparison, calls to Cosmos DB within the same region complete within 1-2 ms, but the latency between the West and East coast of the US is >50 ms.</span></span> <span data-ttu-id="d8a6c-143">Cette latence peut probablement varier d’une requête à l’autre, en fonction de l’itinéraire utilisé par la requête lorsqu’elle passe du client à la limite du centre de données Azure.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-143">This latency can likely vary from request to request depending on the route taken by the request as it passes from the client to the Azure datacenter boundary.</span></span> <span data-ttu-id="d8a6c-144">Pour obtenir la latence la plus faible possible, l’application appelante doit être située dans la même région Azure que le point de terminaison Cosmos DB configuré.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-144">The lowest possible latency is achieved by ensuring the calling application is located within the same Azure region as the provisioned Cosmos DB endpoint.</span></span> <span data-ttu-id="d8a6c-145">Pour obtenir la liste des régions disponibles, voir [Régions Azure](https://azure.microsoft.com/regions/#services).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-145">For a list of available regions, see [Azure Regions](https://azure.microsoft.com/regions/#services).</span></span>

    <span data-ttu-id="d8a6c-146">![Illustration de la stratégie de connexion Azure Cosmos DB](./media/performance-tips/same-region.png)
   <a id="increase-threads"></a></span><span class="sxs-lookup"><span data-stu-id="d8a6c-146">![Illustration of the Azure Cosmos DB connection policy](./media/performance-tips/same-region.png)
<a id="increase-threads"></a></span></span>
5. <span data-ttu-id="d8a6c-147">**Augmentation du nombre de threads/tâches**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-147">**Increase number of threads/tasks**</span></span>

    <span data-ttu-id="d8a6c-148">Étant donné que les appels à Azure Cosmos DB sont effectués sur le réseau, vous devrez peut-être modifier le degré de parallélisme de vos requêtes, afin que l’application cliente attende très peu de temps entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-148">Since calls to Azure Cosmos DB are made over the network, you may need to vary the degree of parallelism of your requests so that the client application spends very little time waiting between requests.</span></span> <span data-ttu-id="d8a6c-149">Par exemple, si vous utilisez la [bibliothèque parallèle de tâches](https://msdn.microsoft.com//library/dd460717.aspx) .NET, créez plusieurs centaines de tâches de lecture ou d’écriture dans Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-149">For example, if you're using .NET's [Task Parallel Library](https://msdn.microsoft.com//library/dd460717.aspx), create in the order of 100s of Tasks reading or writing to Cosmos DB.</span></span>

## <a name="sdk-usage"></a><span data-ttu-id="d8a6c-150">Utilisation du kit de développement logiciel (SDK)</span><span class="sxs-lookup"><span data-stu-id="d8a6c-150">SDK Usage</span></span>
1. <span data-ttu-id="d8a6c-151">**Installation du kit de développement logiciel (SDK) le plus récent**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-151">**Install the most recent SDK**</span></span>

    <span data-ttu-id="d8a6c-152">Les kits de développement logiciel (SDK) Cosmos DB sont constamment améliorés pour fournir des performances optimales.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-152">The Cosmos DB SDKs are constantly being improved to provide the best performance.</span></span> <span data-ttu-id="d8a6c-153">Consultez les pages du [kit de développement logiciel (SDK)](documentdb-sdk-dotnet.md) pour déterminer quel est le kit de développement logiciel (SDK) le plus récent et passer en revue les améliorations.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-153">See the [Cosmos DB SDK](documentdb-sdk-dotnet.md) pages to determine the most recent SDK and review improvements.</span></span>
2. <span data-ttu-id="d8a6c-154">**Utilisation d’un client Cosmos DB singleton pour la durée de vie de votre application**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-154">**Use a singleton Cosmos DB client for the lifetime of your application**</span></span>

    <span data-ttu-id="d8a6c-155">Notez que chaque instance de DocumentClient est thread-safe et effectue une gestion des connexions efficace et une mise en cache d’adresses lorsque le mode direct est sélectionné.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-155">Note that each DocumentClient instance is thread-safe and performs efficient connection management and address caching when operating in Direct Mode.</span></span> <span data-ttu-id="d8a6c-156">Pour permettre une gestion des connexions efficace et améliorer les performances par DocumentClient, nous vous recommandons d’utiliser une seule instance de DocumentClient par AppDomain pour la durée de vie de l’application.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-156">To allow efficient connection management and better performance by DocumentClient, it is recommended to use a single instance of DocumentClient per AppDomain for the lifetime of the application.</span></span>

   <a id="max-connection"></a>
3. <span data-ttu-id="d8a6c-157">**Augmentation de System.Net MaxConnections par hôte lors de l’utilisation du mode passerelle**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-157">**Increase System.Net MaxConnections per host when using Gateway mode**</span></span>

    <span data-ttu-id="d8a6c-158">Les requêtes Cosmos DB sont effectuées par le biais de HTTPS/REST lors de l’utilisation du mode passerelle et sont soumises aux limites de connexion par défaut par nom d’hôte ou adresse IP.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-158">Cosmos DB requests are made over HTTPS/REST when using Gateway mode, and are subjected to the default connection limit per hostname or IP address.</span></span> <span data-ttu-id="d8a6c-159">Vous devrez peut-être définir MaxConnections sur une valeur plus élevée (100 à 1000) afin que la bibliothèque cliente puisse utiliser plusieurs connexions simultanées à Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-159">You may need to set the MaxConnections to a higher value (100-1000) so that the client library can utilize multiple simultaneous connections to Cosmos DB.</span></span> <span data-ttu-id="d8a6c-160">Dans le kit de développement logiciel (SDK) .NET 1.8.0 et versions ultérieures, la valeur par défaut pour [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) est 50. Pour modifier la valeur, vous pouvez définir [Documents.Client.ConnectionPolicy.MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) sur une valeur plus élevée.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-160">In the .NET SDK 1.8.0 and above, the default value for [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) is 50 and to change the value, you can set the [Documents.Client.ConnectionPolicy.MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) to a higher value.</span></span>   
4. <span data-ttu-id="d8a6c-161">**Paramétrage des requêtes parallèles pour les collections partitionnées**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-161">**Tuning parallel queries for partitioned collections**</span></span>

     <span data-ttu-id="d8a6c-162">La version 1.9.0 et les versions ultérieures du Kit de développement logiciel (SDK) .NET de DocumentDB prennent en charge les requêtes parallèles, qui vous permettent d’interroger une collection partitionnée en parallèle (pour plus d’informations, voir [Utilisation des kits de développement logiciel (SDK)](documentdb-partition-data.md#working-with-the-azure-cosmos-db-sdks) et les [exemples de code](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs) connexes).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-162">DocumentDB .NET SDK version 1.9.0 and above support parallel queries, which enable you to query a partitioned collection in parallel (see [Working with the SDKs](documentdb-partition-data.md#working-with-the-azure-cosmos-db-sdks) and the related [code samples](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs) for more info).</span></span> <span data-ttu-id="d8a6c-163">Les requêtes parallèles sont conçues pour améliorer la latence des requêtes et le débit sur leur équivalent série.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-163">Parallel queries are designed to improve query latency and throughput over their serial counterpart.</span></span> <span data-ttu-id="d8a6c-164">Les requêtes parallèles fournissent deux paramètres que les utilisateurs peuvent paramétrer en fonction de leurs besoins, (a) MaxDegreeOfParallelism, pour contrôler le nombre maximal de partitions qui peuvent être interrogées en parallèle, et (b) MaxBufferedItemCount, pour contrôler le nombre de résultats pré-extraits.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-164">Parallel queries provide two parameters that users can tune to custom-fit their requirements, (a) MaxDegreeOfParallelism: to control the maximum number of partitions then can be queried in parallel, and (b) MaxBufferedItemCount: to control the number of pre-fetched results.</span></span>

    <span data-ttu-id="d8a6c-165">(a) La requête parallèle ***Tuning MaxDegreeOfParallelism\:*** interroge plusieurs partitions en parallèle.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-165">(a) ***Tuning MaxDegreeOfParallelism\:*** Parallel query works by querying multiple partitions in parallel.</span></span> <span data-ttu-id="d8a6c-166">Les données d’une collection partitionnée individuelle sont toutefois extraites en série dans le cadre de la requête.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-166">However, data from an individual partitioned collect is fetched serially with respect to the query.</span></span> <span data-ttu-id="d8a6c-167">La définition du paramètre MaxDegreeOfParallelism sur le nombre de partitions augmente les chances de résultats de la requête, sous réserve que toutes les autres conditions système restent inchangées.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-167">So, setting the MaxDegreeOfParallelism to the number of partitions has the maximum chance of achieving the most performant query, provided all other system conditions remain the same.</span></span> <span data-ttu-id="d8a6c-168">Si vous ne connaissez pas le nombre de partitions, vous pouvez définir le paramètre MaxDegreeOfParallelism sur un nombre élevé, et le système sélectionne le minimum (nombre de partitions, entrée fournie par l’utilisateur) comme paramètre MaxDegreeOfParallelism.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-168">If you don't know the number of partitions, you can set the MaxDegreeOfParallelism to a high number, and the system chooses the minimum (number of partitions, user provided input) as the MaxDegreeOfParallelism.</span></span>

    <span data-ttu-id="d8a6c-169">Il est important de noter que les requêtes parallèles produisent de meilleurs résultats si les données sont réparties de manière homogène entre toutes les partitions.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-169">It is important to note that parallel queries produce the best benefits if the data is evenly distributed across all partitions with respect to the query.</span></span> <span data-ttu-id="d8a6c-170">Si la collection est partitionnée de telle façon que toutes les données retournées par une requête, ou une grande partie d’entre elles, sont concentrées sur quelques partitions (une partition dans le pire des cas), les performances de la requête sont altérées par ces partitions.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-170">If the partitioned collection is partitioned such a way that all or a majority of the data returned by a query is concentrated in a few partitions (one partition in worst case), then the performance of the query would be bottlenecked by those partitions.</span></span>

    <span data-ttu-id="d8a6c-171">(b) La requête parallèle ***Tuning MaxBufferedItemCount\:*** pré-extrait les résultats tandis que le lot de résultats courant est en cours de traitement par le client.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-171">(b) ***Tuning MaxBufferedItemCount\:*** Parallel query is designed to pre-fetch results while the current batch of results is being processed by the client.</span></span> <span data-ttu-id="d8a6c-172">La pré-extraction permet d’améliorer la latence globale d’une requête.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-172">The pre-fetching helps in overall latency improvement of a query.</span></span> <span data-ttu-id="d8a6c-173">MaxBufferedItemCount est le paramètre utilisé pour limiter le nombre de résultats pré-extraits.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-173">MaxBufferedItemCount is the parameter to limit the number of pre-fetched results.</span></span> <span data-ttu-id="d8a6c-174">La définition du paramètre MaxBufferedItemCount sur le nombre de résultats attendu (ou un nombre plus élevé) permet à la requête d’optimiser la pré-extraction.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-174">Setting MaxBufferedItemCount to the expected number of results returned (or a higher number) allows the query to receive maximum benefit from pre-fetching.</span></span>

    <span data-ttu-id="d8a6c-175">Notez que la pré-extraction fonctionne de la même façon, quel que soit le paramètre MaxDegreeOfParallelism, et il existe une seule mémoire tampon pour les données de toutes les partitions.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-175">Note that pre-fetching works the same way irrespective of the MaxDegreeOfParallelism, and there is a single buffer for the data from all partitions.</span></span>  
5. <span data-ttu-id="d8a6c-176">**Activation de GC côté serveur**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-176">**Turn on server-side GC**</span></span>

    <span data-ttu-id="d8a6c-177">Réduire la fréquence de Garbage Collection peut aider dans certains cas.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-177">Reducing the frequency of garbage collection may help in some cases.</span></span> <span data-ttu-id="d8a6c-178">Dans .NET, définissez [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) sur true.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-178">In .NET, set [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) to true.</span></span>
6. <span data-ttu-id="d8a6c-179">**Implémentation d’interruption à des intervalles de RetryAfter**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-179">**Implement backoff at RetryAfter intervals**</span></span>

    <span data-ttu-id="d8a6c-180">Lors du test de performances, vous devez augmenter la charge jusqu’à une limite d’un petit nombre de requêtes.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-180">During performance testing, you should increase load until a small rate of requests get throttled.</span></span> <span data-ttu-id="d8a6c-181">En cas de limitation, l’application cliente doit s’interrompre à la limitation pour l’intervalle de nouvelle tentative spécifié sur le serveur</span><span class="sxs-lookup"><span data-stu-id="d8a6c-181">If throttled, the client application should backoff on throttle for the server-specified retry interval.</span></span> <span data-ttu-id="d8a6c-182">Le respect de l’interruption garantit un temps d’attente minimal entre chaque tentative.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-182">Respecting the backoff ensures that you spend minimal amount of time waiting between retries.</span></span> <span data-ttu-id="d8a6c-183">La prise en charge de la stratégie de nouvelle tentative est incluse dans les versions 1.8.0 et ultérieures de DocumentDB [.NET](documentdb-sdk-dotnet.md) et [Java](documentdb-sdk-java.md), dans les versions 1.9.0 et ultérieures de [Node.js](documentdb-sdk-node.md) et [Python](documentdb-sdk-python.md) et dans toutes les versions prises en charge des Kits de développement logiciel (SDK) [.NET Core](documentdb-sdk-dotnet-core.md).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-183">Retry policy support is included in Version 1.8.0 and above of the DocumentDB [.NET](documentdb-sdk-dotnet.md) and [Java](documentdb-sdk-java.md), version 1.9.0 and above of the [Node.js](documentdb-sdk-node.md) and [Python](documentdb-sdk-python.md), and all supported versions of the [.NET Core](documentdb-sdk-dotnet-core.md) SDKs.</span></span> <span data-ttu-id="d8a6c-184">Pour plus d’informations, consultez la section [Dépassement des limites de débit réservé](request-units.md#RequestRateTooLarge) et [Propriété RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-184">For more information, see [Exceeding reserved throughput limits](request-units.md#RequestRateTooLarge) and [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).</span></span>
7. <span data-ttu-id="d8a6c-185">**Augmentation de la taille des instances de votre charge de travail cliente**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-185">**Scale out your client-workload**</span></span>

    <span data-ttu-id="d8a6c-186">Si vous effectuez des tests à des niveaux de débit élevé (> 50 000 RU/s), l’application cliente peut devenir un goulet d’étranglement en raison du plafonnement sur l’utilisation du processeur ou du réseau.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-186">If you are testing at high throughput levels (>50,000 RU/s), the client application may become the bottleneck due to the machine capping out on CPU or Network utilization.</span></span> <span data-ttu-id="d8a6c-187">Si vous atteignez ce point, vous pouvez continuer à augmenter le compte Cosmos DB en augmentant la taille des instances de vos applications clientes sur plusieurs serveurs.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-187">If you reach this point, you can continue to push the Cosmos DB account further by scaling out your client applications across multiple servers.</span></span>
8. <span data-ttu-id="d8a6c-188">**Mise en cache d’URI de document pour une latence de lecture plus faible**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-188">**Cache document URIs for lower read latency**</span></span>

    <span data-ttu-id="d8a6c-189">Effectuez une mise en cache des URI de document dès que possible pour garantir la meilleure lecture.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-189">Cache document URIs whenever possible for the best read performance.</span></span>
   <a id="tune-page-size"></a>
9. <span data-ttu-id="d8a6c-190">**Réglage de la taille de la page des flux de lecture/requêtes pour de meilleures performances**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-190">**Tune the page size for queries/read feeds for better performance**</span></span>

    <span data-ttu-id="d8a6c-191">Lors d’une lecture groupée de documents à l’aide de la fonctionnalité de flux de lecture (ReadDocumentFeedAsync) ou lors de l’émission d’une requête SQL DocumentDB, les résultats sont retournés de façon segmentée si le jeu de résultats est trop grand.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-191">When performing a bulk read of documents using read feed functionality (for example, ReadDocumentFeedAsync) or when issuing a DocumentDB SQL query, the results are returned in a segmented fashion if the result set is too large.</span></span> <span data-ttu-id="d8a6c-192">Par défaut, les résultats sont retournés dans des segments de 100 éléments ou de 1 Mo, selon la limite atteinte en premier.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-192">By default, results are returned in chunks of 100 items or 1 MB, whichever limit is hit first.</span></span>

    <span data-ttu-id="d8a6c-193">Afin de réduire le nombre de boucles réseau nécessaires pour récupérer tous les résultats applicables, vous pouvez augmenter la taille de la page à 1 000 résultats à l’aide de l’en-tête de requête x-ms-max-item-count.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-193">To reduce the number of network round trips required to retrieve all applicable results, you can increase the page size using x-ms-max-item-count request header to up to 1000.</span></span> <span data-ttu-id="d8a6c-194">Si vous avez besoin d’afficher uniquement quelques résultats, (par exemple, si votre interface utilisateur ou API d’application retourne seulement 10 résultats à la fois), vous pouvez également réduire la taille de la page à 10 résultats, afin de baisser le débit consommé pour les lectures et requêtes.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-194">In cases where you need to display only a few results, for example, if your user interface or application API returns only 10 results a time, you can also decrease the page size to 10 to reduce the throughput consumed for reads and queries.</span></span>

    <span data-ttu-id="d8a6c-195">Vous pouvez également définir la taille de la page à l’aide des kits de développement logiciel (SDK) Cosmos DB disponibles.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-195">You may also set the page size using the available Cosmos DB SDKs.</span></span>  <span data-ttu-id="d8a6c-196">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="d8a6c-196">For example:</span></span>

        IQueryable<dynamic> authorResults = client.CreateDocumentQuery(documentCollection.SelfLink, "SELECT p.Author FROM Pages p WHERE p.Title = 'About Seattle'", new FeedOptions { MaxItemCount = 1000 });
10. <span data-ttu-id="d8a6c-197">**Augmentation du nombre de threads/tâches**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-197">**Increase number of threads/tasks**</span></span>

    <span data-ttu-id="d8a6c-198">Consultez [Augmentation du nombre de threads/tâches](#increase-threads) à la section Mise en réseau.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-198">See [Increase number of threads/tasks](#increase-threads) in the Networking section.</span></span>

11. <span data-ttu-id="d8a6c-199">**Utilisation du processus hôte 64 bits**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-199">**Use 64-bit host processing**</span></span>

    <span data-ttu-id="d8a6c-200">Le kit de développement logiciel (SDK) DocumentDB fonctionne dans un processus hôte 32 bits lorsque vous utilisez le kit de développement logiciel (SDK) DocumentDB .NET version 1.11.4 et ultérieures.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-200">The DocumentDB SDK works in a 32-bit host process when you are using DocumentDB .NET SDK version 1.11.4 and above.</span></span> <span data-ttu-id="d8a6c-201">Toutefois, que si vous utilisez des requêtes entre les partitions, le processus hôte 64 bits est recommandé pour améliorer les performances.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-201">However, if you are using cross partition queries, 64-bit host processing is recommended for improved performance.</span></span> <span data-ttu-id="d8a6c-202">Les types d’applications suivants utilisent des processus hôte 32 bits par défaut. Pour les remplacer par des processus 64 bits, procédez comme suit, selon le type de votre application :</span><span class="sxs-lookup"><span data-stu-id="d8a6c-202">The following types of applications have 32-bit host process as the default, so in order to change that to 64-bit, follow these steps based on the type of your application:</span></span>

    - <span data-ttu-id="d8a6c-203">Pour les applications exécutables, désactivez l’option **Préférer 32 bits** dans la fenêtre **Propriétés du projet**, dans l’onglet **Générer**.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-203">For Executable applications, this can be done by unchecking the **Prefer 32-bit** option in the **Project Properties** window, on the **Build** tab.</span></span>

    - <span data-ttu-id="d8a6c-204">Pour les projets basés sur VSTest, cette opération peut être effectuée en sélectionnant **Test**->**Paramètres de test**->**Default Processor Architecture as X64** (Définir l’architecture de processeur par défaut sur X64), à partir de l’option de menu **Visual Studio Test**.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-204">For VSTest based test projects, this can be done by selecting **Test**->**Test Settings**->**Default Processor Architecture as X64**, from the **Visual Studio Test** menu option.</span></span>

    - <span data-ttu-id="d8a6c-205">Pour les applications web ASP.NET déployées localement, cette opération peut être effectuée en sélectionnant **Utiliser la version 64 bits d’IIS Express pour les sites et les projets Web**, sous **Outils**->**Options**->**Projects and Solutions (Projets et solutions)**->**Projets Web**.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-205">For locally deployed ASP.NET Web applications, this can be done by checking the **Use the 64-bit version of IIS Express for web sites and projects**, under **Tools**->**Options**->**Projects and Solutions**->**Web Projects**.</span></span>

    - <span data-ttu-id="d8a6c-206">Pour les applications web ASP.NET déployées sur Azure, cette opération peut être effectuée en choisissant la **plate-forme 64 bits** dans les **paramètres de l’application** sur le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-206">For ASP.NET Web applications deployed on Azure, this can be done by choosing the **Platform as 64-bit** in the **Application Settings** on the Azure portal.</span></span>

## <a name="indexing-policy"></a><span data-ttu-id="d8a6c-207">Stratégie d'indexation</span><span class="sxs-lookup"><span data-stu-id="d8a6c-207">Indexing Policy</span></span>
1. <span data-ttu-id="d8a6c-208">**Utilisation de l’indexation différée pour des taux d’ingestion plus rapides en période de pointe**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-208">**Use lazy indexing for faster peak time ingestion rates**</span></span>

    <span data-ttu-id="d8a6c-209">Cosmos DB vous permet de spécifier, au niveau de la collection, une stratégie d’indexation qui offre la possibilité de choisir si vous souhaitez que les documents d’une collection soient indexés automatiquement ou non.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-209">Cosmos DB allows you to specify – at the collection level – an indexing policy, which enables you to choose if you want the documents in a collection to be automatically indexed or not.</span></span>  <span data-ttu-id="d8a6c-210">En outre, vous avez le choix entre des mises à jour d’index synchrones (cohérentes) et asynchrones (différées).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-210">In addition, you may also choose between synchronous (Consistent) and asynchronous (Lazy) index updates.</span></span> <span data-ttu-id="d8a6c-211">Par défaut, l'index est mis à jour de manière synchrone lors de chaque insertion, remplacement ou suppression d'un document au niveau de la collection.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-211">By default, the index is updated synchronously on each insert, replace, or delete of a document to the collection.</span></span> <span data-ttu-id="d8a6c-212">Le mode synchrone permet aux requêtes d’honorer le même [niveau de cohérence](consistency-levels.md) que les lectures de document sans que l’index ne soit soumis à un quelconque délai de rattrapage.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-212">Synchronously mode enables the queries to honor the same [consistency level](consistency-levels.md) as that of the document reads without any delay for the index to “catch up".</span></span>

    <span data-ttu-id="d8a6c-213">L’indexation différée peut être envisagée dans des scénarios où les données sont écrites en rafales et que vous souhaitez amortir le travail requis pour indexer le contenu sur une période de temps plus longue.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-213">Lazy indexing may be considered for scenarios in which data is written in bursts, and you want to amortize the work required to index content over a longer period of time.</span></span> <span data-ttu-id="d8a6c-214">L’indexation différée permet également d’utiliser le débit configuré de manière efficace et de répondre aux requêtes d’écriture en période de pointe avec une latence minimale.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-214">Lazy indexing also allows you to use your provisioned throughput effectively and serve write requests at peak times with minimal latency.</span></span> <span data-ttu-id="d8a6c-215">Toutefois, il est important de noter que, si l’indexation différée est activée, les résultats des requêtes sont cohérents, indépendamment du niveau de cohérence configuré pour le compte Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-215">It is important to note, however, that when lazy indexing is enabled, query results are eventually consistent regardless of the consistency level configured for the Cosmos DB account.</span></span>

    <span data-ttu-id="d8a6c-216">Par conséquent, le mode d’indexation cohérent (IndexingPolicy.IndexingMode est défini sur Cohérent) implique les frais d’unité de requête les plus élevés par écriture, tandis que le mode d’indexation différé (IndexingPolicy.IndexingMode est défini sur différé) et le mode sans indexation (IndexingPolicy.Automatic est défini sur False) n’implique aucun coût d’indexation au moment de l’écriture.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-216">Hence, Consistent indexing mode (IndexingPolicy.IndexingMode is set to Consistent) incurs the highest request unit charge per write, while Lazy indexing mode (IndexingPolicy.IndexingMode is set to Lazy) and no indexing (IndexingPolicy.Automatic is set to False) have zero indexing cost at the time of write.</span></span>
2. <span data-ttu-id="d8a6c-217">**Exclusion des chemins d’accès inutilisés de l’indexation pour des écritures plus rapides**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-217">**Exclude unused paths from indexing for faster writes**</span></span>

    <span data-ttu-id="d8a6c-218">La stratégie d’indexation de Cosmos DB vous permet également de spécifier les chemins d’accès de document à inclure ou exclure de l’indexation en tirant parti des chemins d’accès d’indexation (IndexingPolicy.IncludedPaths et IndexingPolicy.ExcludedPaths).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-218">Cosmos DB’s indexing policy also allows you to specify which document paths to include or exclude from indexing by leveraging Indexing Paths (IndexingPolicy.IncludedPaths and IndexingPolicy.ExcludedPaths).</span></span> <span data-ttu-id="d8a6c-219">L’utilisation des chemins d’accès d’indexation peut offrir des performances d’écriture améliorées et réduire le stockage d’index pour les scénarios dans lesquels les modèles de requête sont connus d’avance, puisque les coûts d’indexation sont directement liés au nombre de chemins d’accès uniques indexés.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-219">The use of indexing paths can offer improved write performance and lower index storage for scenarios in which the query patterns are known beforehand, as indexing costs are directly correlated to the number of unique paths indexed.</span></span>  <span data-ttu-id="d8a6c-220">Par exemple, le code suivant montre comment exclure toute une section de documents (également</span><span class="sxs-lookup"><span data-stu-id="d8a6c-220">For example, the following code shows how to exclude an entire section of the documents (a.k.a.</span></span> <span data-ttu-id="d8a6c-221">appelée sous-arborescence) de l’indexation à l’aide du caractère générique « * ».</span><span class="sxs-lookup"><span data-stu-id="d8a6c-221">a subtree) from indexing using the "*" wildcard.</span></span>

    ```C#
    var collection = new DocumentCollection { Id = "excludedPathCollection" };
    collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
    collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
    collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);
    ```

    <span data-ttu-id="d8a6c-222">Pour plus d’informations, consultez [Stratégies d’indexation d’Azure Cosmos DB](indexing-policies.md).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-222">For more information, see [Azure Cosmos DB indexing policies](indexing-policies.md).</span></span>

## <a name="throughput"></a><span data-ttu-id="d8a6c-223">Débit</span><span class="sxs-lookup"><span data-stu-id="d8a6c-223">Throughput</span></span>
<a id="measure-rus"></a>

1. <span data-ttu-id="d8a6c-224">**Mesure et réglage pour réduire l’utilisation d’unités de requête par seconde**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-224">**Measure and tune for lower request units/second usage**</span></span>

    <span data-ttu-id="d8a6c-225">Cosmos DB propose un riche ensemble d’opérations de base de données, dont les requêtes hiérarchiques et relationnelles avec les fonctions définies par l’utilisateur, les procédures stockées et les déclencheurs, qui fonctionnent tous au niveau des documents d’une collection de base de données.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-225">Cosmos DB offers a rich set of database operations including relational and hierarchical queries with UDFs, stored procedures, and triggers – all operating on the documents within a database collection.</span></span> <span data-ttu-id="d8a6c-226">Le coût associé à chacune de ces opérations varie en fonction du processeur, des E/S et de la mémoire nécessaires à l’exécution de l’opération.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-226">The cost associated with each of these operations varies based on the CPU, IO, and memory required to complete the operation.</span></span> <span data-ttu-id="d8a6c-227">Plutôt que de vous soucier de la gestion des ressources matérielles, vous pouvez considérer une unité de demande comme une mesure unique des ressources nécessaires à l'exécution des opérations de base de données et à la réponse à la demande de l'application.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-227">Instead of thinking about and managing hardware resources, you can think of a request unit (RU) as a single measure for the resources required to perform various database operations and service an application request.</span></span>

    <span data-ttu-id="d8a6c-228">[Les unités de requête](request-units.md) sont configurées pour chaque compte de base de données selon le nombre d’unités de capacité achetées.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-228">[Request units](request-units.md) are provisioned for each database account based on the number of capacity units that you purchase.</span></span> <span data-ttu-id="d8a6c-229">La consommation d'unités de demande est évaluée en fonction d'un taux par seconde.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-229">Request unit consumption is evaluated as a rate per second.</span></span> <span data-ttu-id="d8a6c-230">Les applications qui dépassent le taux d’unité de requête configuré pour le compte associé sont limitées jusqu’à ce que le taux soit inférieur au niveau réservé pour le compte.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-230">Applications that exceed the provisioned request unit rate for their account is limited until the rate drops below the reserved level for the account.</span></span> <span data-ttu-id="d8a6c-231">Si votre application a besoin d'un niveau de débit plus élevé, vous pouvez acheter des unités de capacité supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-231">If your application requires a higher level of throughput, you can purchase additional capacity units.</span></span>

    <span data-ttu-id="d8a6c-232">La complexité d’une requête a un impact sur le nombre d’unités de requête consommées pour une opération.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-232">The complexity of a query impacts how many Request Units are consumed for an operation.</span></span> <span data-ttu-id="d8a6c-233">Le nombre de prédicats, la nature des prédicats, le nombre de fonctions définies par l’utilisateur et la taille du jeu de données sources ont tous une influence sur le coût des opérations de requête.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-233">The number of predicates, nature of the predicates, number of UDFs, and the size of the source data set all influence the cost of query operations.</span></span>

    <span data-ttu-id="d8a6c-234">Pour mesurer les frais de l’opération (création, mise à jour ou suppression), inspectez l’en-tête x-ms-request-charge (ou la propriété RequestCharge équivalente dans ResourceResponse<T> ou FeedResponse<T> dans le Kit de développement logiciel (SDK) .NET) afin de déterminer le nombre d’unités de requête consommées par ces opérations.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-234">To measure the overhead of any operation (create, update, or delete), inspect the x-ms-request-charge header (or the equivalent RequestCharge property in ResourceResponse<T> or FeedResponse<T> in the .NET SDK) to measure the number of request units consumed by these operations.</span></span>

    ```C#
    // Measure the performance (request units) of writes
    ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument);
    Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);
    // Measure the performance (request units) of queries
    IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery();
    while (queryable.HasMoreResults)
         {
              FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>();
              Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
         }
    ```             

    <span data-ttu-id="d8a6c-235">Les frais de la requête retournée dans cet en-tête correspondent à une fraction du débit configuré (c’est-à-dire 2 000 RU/seconde).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-235">The request charge returned in this header is a fraction of your provisioned throughput (i.e., 2000 RUs / second).</span></span> <span data-ttu-id="d8a6c-236">Par exemple, si la requête ci-dessus renvoie 1000 documents de 1 Ko, le coût de l’opération est de 1 000.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-236">For example, if the preceding query returns 1000 1KB-documents, the cost of the operation is 1000.</span></span> <span data-ttu-id="d8a6c-237">Par conséquent, en une seconde, le serveur honore uniquement deux requêtes avant de limiter les requêtes suivantes.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-237">As such, within one second, the server honors only two such requests before throttling subsequent requests.</span></span> <span data-ttu-id="d8a6c-238">Pour plus d’informations, consultez [Unités de requête](request-units.md) et la [calculatrice d’unités de requête](https://www.documentdb.com/capacityplanner).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-238">For more information, see [Request units](request-units.md) and the [request unit calculator](https://www.documentdb.com/capacityplanner).</span></span>
<a id="429"></a>
2. <span data-ttu-id="d8a6c-239">**Gestion de la limite de taux/du taux de requête trop importants**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-239">**Handle rate limiting/request rate too large**</span></span>

    <span data-ttu-id="d8a6c-240">Lorsqu’un client tente de dépasser le débit réservé pour un compte, les performances au niveau du serveur ne sont pas affectées et la capacité de débit n’est pas utilisée au-delà du niveau réservé.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-240">When a client attempts to exceed the reserved throughput for an account, there is no performance degradation at the server and no use of throughput capacity beyond the reserved level.</span></span> <span data-ttu-id="d8a6c-241">Le serveur met fin à la requête de manière préventive avec RequestRateTooLarge (code d’état HTTP 429) et il retourne l’en-tête x-ms-retry-after-ms indiquant la durée, en millisecondes, pendant laquelle l’utilisateur doit attendre avant de réessayer.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-241">The server will preemptively end the request with RequestRateTooLarge (HTTP status code 429) and return the x-ms-retry-after-ms header indicating the amount of time, in milliseconds, that the user must wait before reattempting the request.</span></span>

        HTTP Status 429,
        Status Line: RequestRateTooLarge
        x-ms-retry-after-ms :100

    <span data-ttu-id="d8a6c-242">Les kits de développement logiciel (SDK) interceptent tous implicitement cette réponse, respectent l’en-tête retry-after spécifiée par le serveur, puis relancent la requête.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-242">The SDKs all implicitly catch this response, respect the server-specified retry-after header, and retry the request.</span></span> <span data-ttu-id="d8a6c-243">La tentative suivante réussira toujours, sauf si plusieurs clients accèdent simultanément à votre compte.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-243">Unless your account is being accessed concurrently by multiple clients, the next retry will succeed.</span></span>

    <span data-ttu-id="d8a6c-244">Si plusieurs clients opèrent simultanément au-delà du taux de requête, le nombre de nouvelles tentatives par défaut actuellement défini sur 9 en interne par le client peut ne pas suffire. Dans ce cas, le client envoie une exception DocumentClientException avec le code d’état 429 à l’application.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-244">If you have more than one client cumulatively operating consistently above the request rate, the default retry count currently set to 9 internally by the client may not suffice; in this case, the client throws a DocumentClientException with status code 429 to the application.</span></span> <span data-ttu-id="d8a6c-245">Le nombre de nouvelles tentatives par défaut peut être modifié en définissant les RetryOptions sur l’instance ConnectionPolicy.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-245">The default retry count can be changed by setting the RetryOptions on the ConnectionPolicy instance.</span></span> <span data-ttu-id="d8a6c-246">Par défaut, la DocumentClientException avec le code d’état 429 est retournée après un temps d’attente cumulé de 30 secondes si la requête continue à fonctionner au-dessus du taux de requête.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-246">By default, the DocumentClientException with status code 429 is returned after a cumulative wait time of 30 seconds if the request continues to operate above the request rate.</span></span> <span data-ttu-id="d8a6c-247">Cela se produit même lorsque le nombre de nouvelles tentatives actuel est inférieur au nombre maximal de nouvelles tentatives, qu’il s’agisse de la valeur par défaut de 9 ou d’une valeur définie par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-247">This occurs even when the current retry count is less than the max retry count, be it the default of 9 or a user-defined value.</span></span>

    <span data-ttu-id="d8a6c-248">Alors que le comportement de nouvelle tentative automatique permet d’améliorer la résilience et la facilité d’utilisation pour la plupart des applications, il peut se révéler contradictoire lors de l’exécution de tests de performances, en particulier lors de la mesure de la latence.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-248">While the automated retry behavior helps to improve resiliency and usability for the most applications, it might come at odds when doing performance benchmarks, especially when measuring latency.</span></span>  <span data-ttu-id="d8a6c-249">La latence client observée atteindra un pic si l’expérience atteint la limite de serveur et oblige le kit de développement logiciel (SDK) client à effectuer une nouvelle tentative en silence.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-249">The client-observed latency will spike if the experiment hits the server throttle and causes the client SDK to silently retry.</span></span> <span data-ttu-id="d8a6c-250">Pour éviter des pics de latence lors des expériences de performances, mesurez la charge renvoyée par chaque opération et assurez-vous que les requêtes fonctionnent en dessous du taux de requête réservé.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-250">To avoid latency spikes during performance experiments, measure the charge returned by each operation and ensure that requests are operating below the reserved request rate.</span></span> <span data-ttu-id="d8a6c-251">Pour plus d’informations, consultez [Unités de requête](request-units.md).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-251">For more information, see [Request units](request-units.md).</span></span>
3. <span data-ttu-id="d8a6c-252">**Conception de documents plus petits pour un débit plus élevé**</span><span class="sxs-lookup"><span data-stu-id="d8a6c-252">**Design for smaller documents for higher throughput**</span></span>

    <span data-ttu-id="d8a6c-253">Les frais de requête (p. ex. le coût de traitement de requête) d’une opération donnée sont directement liés à la taille du document.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-253">The request charge (i.e. request processing cost) of a given operation is directly correlated to the size of the document.</span></span> <span data-ttu-id="d8a6c-254">Des opérations sur des documents volumineux coûtent plus cher que des opérations sur de petits documents.</span><span class="sxs-lookup"><span data-stu-id="d8a6c-254">Operations on large documents cost more than operations for small documents.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d8a6c-255">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="d8a6c-255">Next steps</span></span>
<span data-ttu-id="d8a6c-256">Pour un exemple d’application permettant d’évaluer Cosmos DB lors de scénarios hautes performances sur quelques ordinateurs clients, consultez [Test des performances et de la mise à l’échelle avec Cosmos DB](performance-testing.md).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-256">For a sample application used to evaluate Cosmos DB for high-performance scenarios on a few client machines, see [Performance and scale testing with Cosmos DB](performance-testing.md).</span></span>

<span data-ttu-id="d8a6c-257">En outre, pour en savoir plus sur la conception de votre application pour une mise à l’échelle et de hautes performances, consultez [Partitionnement, clés de partition et mise à l’échelle dans Cosmos DB](partition-data.md).</span><span class="sxs-lookup"><span data-stu-id="d8a6c-257">Also, to learn more about designing your application for scale and high performance, see [Partitioning and scaling in Azure Cosmos DB](partition-data.md).</span></span>
