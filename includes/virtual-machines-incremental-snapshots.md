# <a name="back-up-azure-unmanaged-vm-disks-with-incremental-snapshots"></a><span data-ttu-id="9c5b4-101">Sauvegarder les disques de machines virtuelles Azure non gérés avec des captures instantanées incrémentielles</span><span class="sxs-lookup"><span data-stu-id="9c5b4-101">Back up Azure unmanaged VM disks with incremental snapshots</span></span>
## <a name="overview"></a><span data-ttu-id="9c5b4-102">Vue d’ensemble</span><span class="sxs-lookup"><span data-stu-id="9c5b4-102">Overview</span></span>
<span data-ttu-id="9c5b4-103">Azure Storage offre la possibilité de prendre des instantanés d’objets blob.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-103">Azure Storage provides the capability to take snapshots of blobs.</span></span> <span data-ttu-id="9c5b4-104">Les instantanés capturent l’état de l’objet blob à un instant précis.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-104">Snapshots capture the blob state at that point in time.</span></span> <span data-ttu-id="9c5b4-105">Dans cet article, nous décrivons un scénario dans lequel vous pouvez gérer des sauvegardes de disques de machine virtuelle à l’aide de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-105">In this article, we describe a scenario in which you can maintain backups of virtual machine disks using snapshots.</span></span> <span data-ttu-id="9c5b4-106">Vous pouvez utiliser cette méthode comme une alternative à Azure Backup et Recovery Service et si vous voulez créer une stratégie de sauvegarde personnalisée pour vos disques de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-106">You can use this methodology when you choose not to use Azure Backup and Recovery Service, and wish to create a custom backup strategy for your virtual machine disks.</span></span>

<span data-ttu-id="9c5b4-107">Les disques de machine virtuelle Azure sont stockés en tant qu’objets blob de pages dans Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-107">Azure virtual machine disks are stored as page blobs in Azure Storage.</span></span> <span data-ttu-id="9c5b4-108">Dans cet article, nous décrivons une stratégie de sauvegarde pour les disques de machine virtuelle. Nous nous référons donc aux captures instantanées dans le contexte d’objets blob de pages.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-108">Since we are describing a backup strategy for virtual machine disks in this article, we refer to snapshots in the context of page blobs.</span></span> <span data-ttu-id="9c5b4-109">Pour plus d’informations sur les instantanés, reportez-vous à [Création d’un instantané d’objet blob](https://docs.microsoft.com/rest/api/storageservices/Creating-a-Snapshot-of-a-Blob).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-109">To learn more about snapshots, refer to [Creating a Snapshot of a Blob](https://docs.microsoft.com/rest/api/storageservices/Creating-a-Snapshot-of-a-Blob).</span></span>

## <a name="what-is-a-snapshot"></a><span data-ttu-id="9c5b4-110">Qu’est-ce qu’un instantané ?</span><span class="sxs-lookup"><span data-stu-id="9c5b4-110">What is a snapshot?</span></span>
<span data-ttu-id="9c5b4-111">Un instantané d’objet blob est une version en lecture seule d’un objet blob capturé à un instant donné.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-111">A blob snapshot is a read-only version of a blob that is captured at a point in time.</span></span> <span data-ttu-id="9c5b4-112">Un instantané peut être lu, copié ou supprimé, mais pas modifié.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-112">Once a snapshot has been created, it can be read, copied, or deleted, but not modified.</span></span> <span data-ttu-id="9c5b4-113">Les instantanés sont une façon de sauvegarder un objet blob à un instant T.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-113">Snapshots provide a way to back up a blob as it appears at a moment in time.</span></span> <span data-ttu-id="9c5b4-114">La copie des captures instantanées complètes était possible jusqu’à la version REST 2015-04-05.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-114">Until REST version 2015-04-05, you had the ability to copy full snapshots.</span></span> <span data-ttu-id="9c5b4-115">À partir de la version REST 2015-07-08, vous pouvez également copier des instantanés incrémentiels.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-115">With the REST version 2015-07-08 and above, you can also copy incremental snapshots.</span></span>

## <a name="full-snapshot-copy"></a><span data-ttu-id="9c5b4-116">Copie d’un instantané complet</span><span class="sxs-lookup"><span data-stu-id="9c5b4-116">Full snapshot copy</span></span>
<span data-ttu-id="9c5b4-117">Les instantanés peuvent être copiés vers un autre compte de stockage en tant qu’objet blob pour conserver des sauvegardes de l’objet blob de base.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-117">Snapshots can be copied to another storage account as a blob to keep backups of the base blob.</span></span> <span data-ttu-id="9c5b4-118">Vous pouvez également copier un instantané sur l’objet blob de base, ce qui revient à restaurer l’objet blob à une version antérieure.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-118">You can also copy a snapshot over its base blob, which is like restoring the blob to an earlier version.</span></span> <span data-ttu-id="9c5b4-119">Lorsqu’une capture instantanée est copiée d’un compte de stockage à un autre, elle occupe le même espace que l’objet blob de pages de base.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-119">When a snapshot is copied from one storage account to another, it occupies the same space as the base page blob.</span></span> <span data-ttu-id="9c5b4-120">Par conséquent, la copie de captures instantanées complètes d’un compte de stockage à un autre est lente et consomme beaucoup d’espace dans le compte de stockage cible.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-120">Therefore, copying whole snapshots from one storage account to another is slow and consumes much space in the target storage account.</span></span>

> [!NOTE]
> <span data-ttu-id="9c5b4-121">Si vous copiez l’objet blob de base vers une autre destination, les instantanés de l’objet blob ne sont pas copiés en même temps.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-121">If you copy the base blob to another destination, the snapshots of the blob are not copied along with it.</span></span> <span data-ttu-id="9c5b4-122">De même, si vous remplacez un blob de base par une copie, les captures instantanées associées au blob de base ne sont pas affectées et restent intactes sous le nom du blob de base.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-122">Similarly, if you overwrite a base blob with a copy, snapshots associated with the base blob are not affected and stay intact under the base blob name.</span></span>
> 
> 

### <a name="back-up-disks-using-snapshots"></a><span data-ttu-id="9c5b4-123">Sauvegarder des disques à l’aide d’instantanés</span><span class="sxs-lookup"><span data-stu-id="9c5b4-123">Back up disks using snapshots</span></span>
<span data-ttu-id="9c5b4-124">Comme stratégie de sauvegarde pour vos disques de machine virtuelle, vous pouvez prendre des instantanés périodiques du disque ou de l’objet blob de pages, et les copier dans un autre compte de stockage à l’aide d’outils tels que l’opération [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) ou [AzCopy](../articles/storage/common/storage-use-azcopy.md).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-124">As a backup strategy for your virtual machine disks, you can take periodic snapshots of the disk or page blob, and copy them to another storage account using tools like [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) operation or [AzCopy](../articles/storage/common/storage-use-azcopy.md).</span></span> <span data-ttu-id="9c5b4-125">Vous pouvez copier un instantané sur un objet blob de pages de destination avec un nom différent.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-125">You can copy a snapshot to a destination page blob with a different name.</span></span> <span data-ttu-id="9c5b4-126">L’objet blob de pages de destination qui en découle est modifiable et n’est pas un instantané.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-126">The resulting destination page blob is a writeable page blob and not a snapshot.</span></span> <span data-ttu-id="9c5b4-127">Plus loin dans cet article, nous décrirons les étapes permettant d’effectuer des sauvegardes de disques de machine virtuelle à l’aide de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-127">Later in this article, we describe steps to take backups of virtual machine disks using snapshots.</span></span>

### <a name="restore-disks-using-snapshots"></a><span data-ttu-id="9c5b4-128">Restaurer des disques à l’aide d’instantanés</span><span class="sxs-lookup"><span data-stu-id="9c5b4-128">Restore disks using snapshots</span></span>
<span data-ttu-id="9c5b4-129">Lorsqu’il est temps de restaurer votre disque vers une version stable ayant été précédemment capturée dans une des captures instantanées de sauvegarde, vous pouvez copier une capture instantanée sur l’objet blob de pages de base.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-129">When it is time to restore your disk to a stable version that was previously captured in one of the backup snapshots, you can copy a snapshot over the base page blob.</span></span> <span data-ttu-id="9c5b4-130">Une fois que l’instantané est copié sur l’objet blob de pages de base, il reste, mais sa source est remplacée par une copie qui peut être lue et modifiée.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-130">After the snapshot is promoted to the base page blob, the snapshot remains, but its source is overwritten with a copy that can be both read and written.</span></span> <span data-ttu-id="9c5b4-131">Plus loin dans cet article, nous allons décrire les étapes permettant de restaurer une version précédente de votre disque à partir de sa capture instantanée.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-131">Later in this article we describe steps to restore a previous version of your disk from its snapshot.</span></span>

### <a name="implementing-full-snapshot-copy"></a><span data-ttu-id="9c5b4-132">Implémentation de la copie d’un instantané complet</span><span class="sxs-lookup"><span data-stu-id="9c5b4-132">Implementing full snapshot copy</span></span>
<span data-ttu-id="9c5b4-133">Vous pouvez implémenter la copie d’un instantané complet de la manière suivante :</span><span class="sxs-lookup"><span data-stu-id="9c5b4-133">You can implement a full snapshot copy by doing the following,</span></span>

* <span data-ttu-id="9c5b4-134">Tout d’abord, prenez un instantané de l’objet blob de base à l’aide de l’opération [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob) .</span><span class="sxs-lookup"><span data-stu-id="9c5b4-134">First, take a snapshot of the base blob using the [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob) operation.</span></span>
* <span data-ttu-id="9c5b4-135">Ensuite, copiez l’instantané vers un compte de stockage cible à l’aide de [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-135">Then, copy the snapshot to a target storage account using [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob).</span></span>
* <span data-ttu-id="9c5b4-136">Répétez cette procédure pour mettre à jour les copies de sauvegarde de votre objet blob de base.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-136">Repeat this process to maintain backup copies of your base blob.</span></span>

## <a name="incremental-snapshot-copy"></a><span data-ttu-id="9c5b4-137">Copie d’un instantané incrémentiel</span><span class="sxs-lookup"><span data-stu-id="9c5b4-137">Incremental snapshot copy</span></span>
<span data-ttu-id="9c5b4-138">La nouvelle fonctionnalité incluse dans l’API [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) offre une bien meilleure méthode de sauvegarde des captures instantanées de vos objets blob de pages ou de vos disques.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-138">The new feature in the [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) API provides a much better way to back up the snapshots of your page blobs or disks.</span></span> <span data-ttu-id="9c5b4-139">L’API retourne la liste des modifications entre le blob de base et les captures instantanées, ce qui réduit la quantité d’espace de stockage utilisée sur le compte de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-139">The API returns the list of changes between the base blob and the snapshots, which reduces the amount of storage space used on the backup account.</span></span> <span data-ttu-id="9c5b4-140">L’API prend en charge les objets blob de pages sur le Stockage Premium et le Stockage Standard.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-140">The API supports page blobs on Premium Storage as well as Standard Storage.</span></span> <span data-ttu-id="9c5b4-141">À l’aide de cette API, vous pouvez créer des solutions de sauvegarde plus rapides et efficaces pour les machines virtuelles Azure.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-141">Using this API, you can build faster and more efficient backup solutions for Azure VMs.</span></span> <span data-ttu-id="9c5b4-142">Cette API sera disponible avec la version REST 2015-07-08 et les versions supérieures.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-142">This API will be available with the REST version 2015-07-08 and higher.</span></span>

<span data-ttu-id="9c5b4-143">La copie d’instantané incrémentiel vous permet de copier d’un compte de stockage à un autre la différence entre</span><span class="sxs-lookup"><span data-stu-id="9c5b4-143">Incremental Snapshot Copy allows you to copy from one storage account to another the difference between,</span></span>

* <span data-ttu-id="9c5b4-144">l’objet blob de base et son instantané OU</span><span class="sxs-lookup"><span data-stu-id="9c5b4-144">Base blob and its Snapshot OR</span></span>
* <span data-ttu-id="9c5b4-145">les deux instantanés de l’objet blob de base</span><span class="sxs-lookup"><span data-stu-id="9c5b4-145">Any two snapshots of the base blob</span></span>

<span data-ttu-id="9c5b4-146">Si les conditions suivantes sont respectées,</span><span class="sxs-lookup"><span data-stu-id="9c5b4-146">Provided the following conditions are met,</span></span>

* <span data-ttu-id="9c5b4-147">L’objet blob a été créé le 1er janvier 2016 ou ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-147">The blob was created on Jan-1-2016 or later.</span></span>
* <span data-ttu-id="9c5b4-148">L’objet blob n’a pas été remplacé avec [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) ou [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) entre deux instantanés.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-148">The blob was not overwritten with [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) or [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) between two snapshots.</span></span>

<span data-ttu-id="9c5b4-149">**Remarque**: cette fonctionnalité est disponible pour les objets blob de pages Azure Standard et Premium.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-149">**Note**: This feature is available for Premium and Standard Azure Page Blobs.</span></span>

<span data-ttu-id="9c5b4-150">Lorsque vous disposez d’une stratégie de sauvegarde personnalisée à l’aide de captures instantanées, la copie des captures instantanées d’un compte de stockage à un autre peut être lente et consommer beaucoup d’espace de stockage.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-150">When you have a custom backup strategy using snapshots, copying the snapshots from one storage account to another can be slow and can consume much storage space.</span></span> <span data-ttu-id="9c5b4-151">Au lieu de copier l’instantané en entier sur un compte de stockage de sauvegarde, vous pouvez écrire la différence entre des instantanés consécutifs dans un objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-151">Instead of copying the entire snapshot to a backup storage account, you can write the difference between consecutive snapshots to a backup page blob.</span></span> <span data-ttu-id="9c5b4-152">De cette façon, le temps de copie et l’espace de stockage des sauvegardes sont sensiblement réduits.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-152">This way, the time to copy and the space to store backups is substantially reduced.</span></span>

### <a name="implementing-incremental-snapshot-copy"></a><span data-ttu-id="9c5b4-153">Implémentation de la copie d’un instantané incrémentiel</span><span class="sxs-lookup"><span data-stu-id="9c5b4-153">Implementing Incremental Snapshot Copy</span></span>
<span data-ttu-id="9c5b4-154">Vous pouvez implémenter la copie d’un instantané incrémentiel de la manière suivante :</span><span class="sxs-lookup"><span data-stu-id="9c5b4-154">You can implement incremental snapshot copy by doing the following,</span></span>

* <span data-ttu-id="9c5b4-155">Prenez un instantané de l’objet blob de base à l’aide de [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-155">Take a snapshot of the base blob using [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob).</span></span>
* <span data-ttu-id="9c5b4-156">Copiez l’instantané vers le compte de stockage de sauvegarde cible à l’aide de [Copie d’un objet blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-156">Copy the snapshot to the target backup storage account using [Copy Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob).</span></span> <span data-ttu-id="9c5b4-157">Il s’agit de l’objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-157">This is the backup page blob.</span></span> <span data-ttu-id="9c5b4-158">Prenez une capture instantanée de l’objet blob de pages de sauvegarde et stockez-la dans le compte de stockage de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-158">Take a snapshot of the backup page blob and store it in the backup account.</span></span>
* <span data-ttu-id="9c5b4-159">Prenez un autre instantané de l’objet blob de base à l’aide de Snapshot Blob.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-159">Take another snapshot of the base blob using Snapshot Blob.</span></span>
* <span data-ttu-id="9c5b4-160">Comparez la première et la deuxième capture instantanée du blob de base à l’aide de [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-160">Get the difference between the first and second snapshots of the base blob using [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges).</span></span> <span data-ttu-id="9c5b4-161">Utilisez le nouveau paramètre **prevsnapshot** pour spécifier la valeur DateTime de la capture instantanée à comparer.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-161">Use the new parameter **prevsnapshot**, to specify the DateTime value of the snapshot you want to get the difference with.</span></span> <span data-ttu-id="9c5b4-162">Quand ce paramètre est présent, la réponse REST n’inclut que les pages ayant été modifié entre la capture instantanée cible et la capture instantanée précédente, y compris les pages effacées.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-162">When this parameter is present, the REST response includes only the pages that were changed between target snapshot and previous snapshot including clear pages.</span></span>
* <span data-ttu-id="9c5b4-163">Utilisez [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) pour appliquer ces modifications à l’objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-163">Use [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) to apply these changes to the backup page blob.</span></span>
* <span data-ttu-id="9c5b4-164">Enfin, prenez un instantané de l’objet blob de pages de sauvegarde et stockez-le dans le compte de stockage de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-164">Finally, take a snapshot of the backup page blob and store it in the backup storage account.</span></span>

<span data-ttu-id="9c5b4-165">Dans la section suivante, nous allons décrire plus en détail comment conserver des sauvegardes de disques à l’aide de la copie d’instantané incrémentiel</span><span class="sxs-lookup"><span data-stu-id="9c5b4-165">In the next section, we will describe in more detail how you can maintain backups of disks using Incremental Snapshot Copy</span></span>

## <a name="scenario"></a><span data-ttu-id="9c5b4-166">Scénario</span><span class="sxs-lookup"><span data-stu-id="9c5b4-166">Scenario</span></span>
<span data-ttu-id="9c5b4-167">Dans cette section, nous décrivons un scénario qui implique une stratégie de sauvegarde personnalisée pour les disques de machine virtuelle à l’aide de captures instantanées.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-167">In this section, we describe a scenario that involves a custom backup strategy for virtual machine disks using snapshots.</span></span>

<span data-ttu-id="9c5b4-168">Prenez une machine virtuelle Azure de série DS avec un disque P30 de stockage Premium attaché.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-168">Consider a DS-series Azure VM with a premium storage P30 disk attached.</span></span> <span data-ttu-id="9c5b4-169">Le disque P30 appelé *mypremiumdisk* est stocké dans un compte de stockage Premium appelé *mypremiumaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-169">The P30 disk called *mypremiumdisk* is stored in a premium storage account called *mypremiumaccount*.</span></span> <span data-ttu-id="9c5b4-170">Un compte de stockage standard appelé *mybackupstdaccount* est utilisé pour stocker la sauvegarde de *mypremiumdisk*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-170">A standard storage account called *mybackupstdaccount* is used for storing the backup of *mypremiumdisk*.</span></span> <span data-ttu-id="9c5b4-171">Nous voulons conserver un instantané de *mypremiumdisk* toutes les 12 heures.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-171">We would like to keep a snapshot of *mypremiumdisk* every 12 hours.</span></span>

<span data-ttu-id="9c5b4-172">Pour en savoir plus sur la création d’un compte de stockage et de disques, consultez [À propos des comptes de stockage Azure](../articles/storage/storage-create-storage-account.md).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-172">To learn about creating storage account and disks, refer to [About Azure storage accounts](../articles/storage/storage-create-storage-account.md).</span></span>

<span data-ttu-id="9c5b4-173">Pour en savoir plus sur la sauvegarde de machines virtuelles Azure, reportez-vous à [Planifier les sauvegardes de machine virtuelle Azure](../articles/backup/backup-azure-vms-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="9c5b4-173">To learn about backing up Azure VMs, refer to [Plan Azure VM backups](../articles/backup/backup-azure-vms-introduction.md).</span></span>

## <a name="steps-to-maintain-backups-of-a-disk-using-incremental-snapshots"></a><span data-ttu-id="9c5b4-174">Étapes pour gérer les sauvegardes d’un disque à l’aide d’instantanés incrémentiels</span><span class="sxs-lookup"><span data-stu-id="9c5b4-174">Steps to maintain backups of a disk using incremental snapshots</span></span>
<span data-ttu-id="9c5b4-175">Les étapes suivantes décrivent comment effectuer des captures instantanées de *mypremiumdisk* et conserver les sauvegardes dans *mybackupstdaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-175">The following steps describe how to take snapshots of *mypremiumdisk* and maintain the backups in *mybackupstdaccount*.</span></span> <span data-ttu-id="9c5b4-176">La sauvegarde est un objet blob de pages standard appelé *mybackupstdpageblob*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-176">The backup is a standard page blob called *mybackupstdpageblob*.</span></span> <span data-ttu-id="9c5b4-177">L’objet blob de pages de sauvegarde reflète toujours le même état en tant que dernière capture instantanée de *mypremiumdisk*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-177">The backup page blob always reflects the same state as the last snapshot of *mypremiumdisk*.</span></span>

1. <span data-ttu-id="9c5b4-178">Créer l’objet blob de pages de sauvegarde pour votre disque de stockage premium, en prenant une capture instantanée de *mypremiumdisk* appelée *mypremiumdisk_ss1*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-178">Create the backup page blob for your premium storage disk, by taking a snapshot of *mypremiumdisk* called *mypremiumdisk_ss1*.</span></span>
2. <span data-ttu-id="9c5b4-179">Copiez cet instantané vers mybackupstdaccount en tant qu’objet blob de pages nommé *mybackupstdpageblob*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-179">Copy this snapshot to mybackupstdaccount as a page blob called *mybackupstdpageblob*.</span></span>
3. <span data-ttu-id="9c5b4-180">Prenez un instantané de *mybackupstdpageblob* nommé *mybackupstdpageblob_ss1*, à l’aide de [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob), et stockez-le dans *mybackupstdaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-180">Take a snapshot of *mybackupstdpageblob* called *mybackupstdpageblob_ss1*, using [Snapshot Blob](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob) and store it in *mybackupstdaccount*.</span></span>
4. <span data-ttu-id="9c5b4-181">Pendant la fenêtre de sauvegarde, créez un autre instantané de *mypremiumdisk*, appelez-le *mypremiumdisk_ss2* et stockez-le dans *mypremiumaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-181">During the backup window, create another snapshot of *mypremiumdisk*, say *mypremiumdisk_ss2*, and store it in *mypremiumaccount*.</span></span>
5. <span data-ttu-id="9c5b4-182">Identifiez les modifications incrémentielles entre les deux captures instantanées, *mypremiumdisk_ss2* et *mypremiumdisk_ss1*, à l’aide de [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) sur *mypremiumdisk_ss2* avec le paramètre **prevsnapshot** défini sur l’horodatage de *mypremiumdisk_ss1*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-182">Get the incremental changes between the two snapshots, *mypremiumdisk_ss2* and *mypremiumdisk_ss1*, using [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) on *mypremiumdisk_ss2* with the **prevsnapshot** parameter set to the timestamp of *mypremiumdisk_ss1*.</span></span> <span data-ttu-id="9c5b4-183">Écrivez ces modifications incrémentielles dans l’objet blob de pages de sauvegarde *mybackupstdpageblob* dans *mybackupstdaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-183">Write these incremental changes to the backup page blob *mybackupstdpageblob* in *mybackupstdaccount*.</span></span> <span data-ttu-id="9c5b4-184">Si des modifications incrémentielles consistent en la suppression de plages, elles doivent être effacées de l’objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-184">If there are deleted ranges in the incremental changes, they must be cleared from the backup page blob.</span></span> <span data-ttu-id="9c5b4-185">Utilisez [Put Page](https://docs.microsoft.com/rest/api/storageservices/Put-Page) pour écrire des modifications incrémentielles dans l’objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-185">Use [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) to write incremental changes to the backup page blob.</span></span>
6. <span data-ttu-id="9c5b4-186">Prenez un instantané de l’objet blob de pages de sauvegarde *mybackupstdpageblob*, appelé *mybackupstdpageblob_ss2*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-186">Take a snapshot of the backup page blob *mybackupstdpageblob*, called *mybackupstdpageblob_ss2*.</span></span> <span data-ttu-id="9c5b4-187">Supprimez l’instantané précédent *mypremiumdisk_ss1* du compte de stockage Premium.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-187">Delete the previous snapshot *mypremiumdisk_ss1* from premium storage account.</span></span>
7. <span data-ttu-id="9c5b4-188">Répétez les étapes 4 à 6 pour chaque fenêtre de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-188">Repeat steps 4-6 every backup window.</span></span> <span data-ttu-id="9c5b4-189">De cette façon, vous pouvez gérer les sauvegardes de *mypremiumdisk* dans un compte de stockage Standard.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-189">In this way, you can maintain backups of *mypremiumdisk* in a standard storage account.</span></span>

![Sauvegarder un disque à l’aide d’instantanés incrémentiels](../articles/virtual-machines/windows/media/incremental-snapshots/storage-incremental-snapshots-1.png)

## <a name="steps-to-restore-a-disk-from-snapshots"></a><span data-ttu-id="9c5b4-191">Procédure de restauration d’un disque à partir d’instantanés</span><span class="sxs-lookup"><span data-stu-id="9c5b4-191">Steps to restore a disk from snapshots</span></span>
<span data-ttu-id="9c5b4-192">Les étapes suivantes décrivent comment restaurer une ancienne capture instantanée du disque premium, *mypremiumdisk* à partir du compte de stockage de sauvegarde *mybackupstdaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-192">The following steps, describe how to restore the premium disk, *mypremiumdisk* to an earlier snapshot from the backup storage account *mybackupstdaccount*.</span></span>

1. <span data-ttu-id="9c5b4-193">Identifiez le point dans le temps que vous souhaitez utiliser afin de restaurer le disque Premium.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-193">Identify the point in time that you wish to restore the premium disk to.</span></span> <span data-ttu-id="9c5b4-194">Supposons qu’il s’agit de la capture instantanée *mybackupstdpageblob_ss2*, qui est stockée dans le compte de stockage de sauvegarde *mybackupstdaccount*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-194">Let's say that it is snapshot *mybackupstdpageblob_ss2*, which is stored in the backup storage account *mybackupstdaccount*.</span></span>
2. <span data-ttu-id="9c5b4-195">Dans mybackupstdaccount, déclarez l’instantané *mybackupstdpageblob_ss2* comme nouvel objet blob de pages de base de sauvegarde *mybackupstdpageblobrestored*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-195">In mybackupstdaccount, promote the snapshot *mybackupstdpageblob_ss2* as the new backup base page blob *mybackupstdpageblobrestored*.</span></span>
3. <span data-ttu-id="9c5b4-196">Prenez un instantané de cet objet blob de pages de sauvegarde restauré appelé *mybackupstdpageblobrestored_ss1*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-196">Take a snapshot of this restored backup page blob, called *mybackupstdpageblobrestored_ss1*.</span></span>
4. <span data-ttu-id="9c5b4-197">Copiez l’objet blob restauré *mybackupstdpageblobrestored* de *mybackupstdaccount* vers *mypremiumaccount* en tant que nouveau disque Premium *mypremiumdiskrestored*.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-197">Copy the restored page blob *mybackupstdpageblobrestored* from *mybackupstdaccount* to *mypremiumaccount* as the new premium disk *mypremiumdiskrestored*.</span></span>
5. <span data-ttu-id="9c5b4-198">Prenez un instantané de *mypremiumdiskrestored*, appelé *mypremiumdiskrestored_ss1* pour les futures sauvegardes incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-198">Take a snapshot of *mypremiumdiskrestored*, called *mypremiumdiskrestored_ss1* for making future incremental backups.</span></span>
6. <span data-ttu-id="9c5b4-199">Pointez la machine virtuelle de série DS sur le disque restauré *mypremiumdiskrestored* et détachez l’ancien *mypremiumdisk* de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-199">Point the DS series VM to the restored disk *mypremiumdiskrestored* and detach the old *mypremiumdisk* from the VM.</span></span>
7. <span data-ttu-id="9c5b4-200">Lancez le processus de sauvegarde décrit dans la section précédente pour le disque restauré *mypremiumdiskrestored*, à l’aide de *mybackupstdpageblobrestored* en tant qu’objet blob de pages de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-200">Begin the Backup process described in previous section for the restored disk *mypremiumdiskrestored*, using the *mybackupstdpageblobrestored* as the backup page blob.</span></span>

![Restaurer un disque à partir d’instantanés](../articles/virtual-machines/windows/media/incremental-snapshots/storage-incremental-snapshots-2.png)

## <a name="next-steps"></a><span data-ttu-id="9c5b4-202">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="9c5b4-202">Next Steps</span></span>
<span data-ttu-id="9c5b4-203">Utilisez les liens suivants pour en savoir plus sur la création de captures instantanées d’un blob et sur la planification de votre infrastructure de sauvegarde de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="9c5b4-203">Use the following links to learn more about creating snapshots of a blob and planning your VM backup infrastructure.</span></span>

* [<span data-ttu-id="9c5b4-204">Création d’un instantané d’objet blob</span><span class="sxs-lookup"><span data-stu-id="9c5b4-204">Creating a Snapshot of a Blob</span></span>](https://docs.microsoft.com/rest/api/storageservices/Creating-a-Snapshot-of-a-Blob)
* [<span data-ttu-id="9c5b4-205">Planification de votre infrastructure de sauvegarde de machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="9c5b4-205">Plan your VM Backup Infrastructure</span></span>](../articles/backup/backup-azure-vms-introduction.md)

